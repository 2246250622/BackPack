{"created_by":"Tampermonkey","version":"1","scripts":[{"name":"backpack","options":{"check_for_updates":true,"user_modified":null,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_powerful_this":null,"sandbox":null,"noframes":null,"unwrap":null,"run_at":null,"tab_types":null,"override":{"use_includes":[],"orig_includes":[],"merge_includes":true,"use_matches":[],"orig_matches":["https://backpack.exchange/trade/*"],"merge_matches":true,"use_excludes":[],"orig_excludes":[],"merge_excludes":true,"use_connects":[],"orig_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-idle","orig_noframes":null}},"storage":{"ts":1712331286502,"data":{}},"enabled":true,"position":1,"file_url":"https://update.greasyfork.org/scripts/491525/backpack-oooooyoung.user.js","uuid":"b0384fd2-0407-4e93-bcb3-fd776a1c239d","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICBiYWNrcGFjawovLyBAbmFtZXNwYWNlICAgIGh0dHA6Ly90YW1wZXJtb25rZXkubmV0LwovLyBAdmVyc2lvbiAgICAgIHYxLjAuMAovLyBAZGVzY3JpcHRpb24gIGJhY2twYWNrIOWIt+aIkOS6pOmHj+iFs+acrCwg5pSv5o+05omL5YuV6ZaL5ZWf6Zec6ZaJLCDoqK3lrprosrflhaXos6Plh7rpu54KLy8gQGF1dGhvciAgICAgICBCYUJ55LuUCi8vIEBtYXRjaCAgICAgICAgaHR0cHM6Ly9iYWNrcGFjay5leGNoYW5nZS90cmFkZS8qCi8vIEBpY29uICAgICAgICAgaHR0cHM6Ly9iYWNrcGFjay5leGNoYW5nZS9mYXZpY29uLTMyeDMyLnBuZwovLyBAZ3JhbnQgICAgICAgIG5vbmUKLy8gQGxpY2Vuc2UgTUlUCi8vIEByZXF1aXJlIGh0dHBzOi8vdXBkYXRlLmdyZWFzeWZvcmsub3JnL3NjcmlwdHMvNDkxNDAxLzEzNTI0NTUvdnVlLmpzCi8vIEByZXF1aXJlIGh0dHBzOi8vdXBkYXRlLmdyZWFzeWZvcmsub3JnL3NjcmlwdHMvNDkxNDE0LzEzNTI2MTMvdGVtcGxhdGVfdnVlLmpzCi8vIEBkb3dubG9hZFVSTCBodHRwczovL3VwZGF0ZS5ncmVhc3lmb3JrLm9yZy9zY3JpcHRzLzQ5MTUyNS9iYWNrcGFjay1vb29vb3lvdW5nLnVzZXIuanMKLy8gQHVwZGF0ZVVSTCBodHRwczovL3VwZGF0ZS5ncmVhc3lmb3JrLm9yZy9zY3JpcHRzLzQ5MTUyNS9iYWNrcGFjay1vb29vb3lvdW5nLm1ldGEuanMKLy8gPT0vVXNlclNjcmlwdD09CiAKLy8g6K+35L2/55So5Zyo5rWP6KeI5Zmo5o6n5Yi25Y+w6YeMCgpjb25zdCBMQU5HX01BUCA9IHsKICBMaW1pdDogJ+mZkOWIticsCiAgTWFya2V0OifluILlnLonLAogIE1heDogJ+acgOWkpycsCiAgQnV5OiAn6LSt5LmwJywKICBTZWxsOiAn5Ye65ZSuJywKICBDYW5jZWw6ICflj5bmtognLAp9Cgpjb25zdCBNSU5fV0FJVF9NUyA9IDMwMDsKY29uc3QgTUFYX1dBSVRfTVMgPSAxMDAwOwpjb25zdCBNSU5fU1dJVENIX01TID0gNTAwOwpjb25zdCBNQVhfU1dJVENIX01TID0gMjAwMDsKCmxldCB0cmFkZUNvdW50ID0gMDsKCmNvbnN0IHNsZWVwID0gKG1zKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoKY29uc3QgZmluZEVsZW1lbnRzQnlUZXh0ID0gKHRleHQsIHRhZywgcGFyZW50ID0gZG9jdW1lbnQpID0+IHsKY29uc3QgZWxlbWVudHMgPSBwYXJlbnQucXVlcnlTZWxlY3RvckFsbChgJHt0YWd9Om5vdCg6ZW1wdHkpOm5vdCg6aGFzKCopKWApOwpyZXR1cm4gQXJyYXkuZnJvbShlbGVtZW50cykuZmlsdGVyKChlbGUpID0+IGVsZS50ZXh0Q29udGVudCA9PT0gdGV4dCB8fCBlbGUudGV4dENvbnRlbnQgPT09IExBTkdfTUFQW3RleHRdKTsKfTsKCmNvbnN0IGdldEVsZW1lbnQgPSAodGV4dCwgdGFnKSA9PiB7CmxldCBlbGVtZW50ID0gZmluZEVsZW1lbnRzQnlUZXh0KHRleHQsIHRhZylbMF07CmlmICghZWxlbWVudCkgewogIGVsZW1lbnQgPSBmaW5kRWxlbWVudHNCeVRleHQoTEFOR19NQVBbdGV4dF0gfHwgdGV4dCwgdGFnKVswXTsKICBpZiAoIWVsZW1lbnQpIHJldHVybgp9CnJldHVybiBlbGVtZW50Owp9Cgpjb25zdCBjbGlja0VsZW1lbnRCeVRleHQgPSBhc3luYyAodGV4dCwgdGFnKSA9PiB7CmNvbnN0IGVsZW1lbnQgPSBnZXRFbGVtZW50KHRleHQsIHRhZyk7CmlmICghZWxlbWVudCB8fCAhd2luZG93LnJ1bm5pbmcpIHJldHVybjsKZWxlbWVudC5jbGljaygpOwphd2FpdCBzbGVlcChnZXRSYW5kb21XYWl0KE1JTl9XQUlUX01TLCBNQVhfV0FJVF9NUykpOwp9OwoKY29uc3QgZ2V0UHJpY2VDbnQgPSAoKSA9PiB7CnJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZmxleC5mbGV4LWNvbC5uby1zY3JvbGxiYXIuaC1mdWxsLmZsZXgtMS5zbmFwLW1hbmRhdG9yeS5vdmVyZmxvdy15LWF1dG8uZm9udC1zYW5zJyk7Cn0KY29uc3QgZ2V0UHJpY2VFbGVtZW50ID0gKHR5cGUsIG51bSkgPT4gewpjb25zdCBpc0J1eSA9IHR5cGUgPT09ICdCdXknOwpjb25zdCBwcmljZUNudCA9IGdldFByaWNlQ250KCk7CmNvbnN0IHByaWNlRWxlbWVudCA9IHByaWNlQ250LnF1ZXJ5U2VsZWN0b3IoYCYgPiBkaXY6JHtpc0J1eSA/ICdsYXN0JyA6ICdmaXJzdCd9LWNoaWxkID4gZGl2ID4gZGl2Om50aC1jaGlsZCgke251bX0pIGJ1dHRvbiBkaXZgKTsKcmV0dXJuIHByaWNlRWxlbWVudDsKfQoKY29uc3Qgc2V0UHJpY2UgPSBhc3luYyAodHlwZSwgbnVtKSA9PiB7CmNvbnN0IHByaWNlID0gZ2V0UHJpY2VFbGVtZW50KHR5cGUsIG51bSk7CnByaWNlLmNsYXNzTGlzdC5hZGQoJ2JvcmRlcicpOwpwcmljZS5jbGljaygpOwphd2FpdCBzbGVlcCgzMDApOwp9CgpsZXQgYnV5Q291bnQgPSAwOwpsZXQgc2VsbENvdW50ID0gMDsKbGV0IGNhbmNlbENvdW50ID0gMDsKY29uc3QgY2xpY2tUcmFkZUJ1dHRvbiA9IGFzeW5jICh0eXBlKSA9PiB7CmNvbnN0IGVsZW1lbnQgPSBnZXRFbGVtZW50KHR5cGUsICdidXR0b24nKTsKaWYgKCFlbGVtZW50KSByZXR1cm47CmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgaWYgKHR5cGUgPT09ICdCdXknKSB7CiAgICBidXlDb3VudCsrOwogICAgY29uc29sZS5sb2coYCVj56ysJHtidXlDb3VudH3mrKHosrflhaVgLCAnY29sb3I6ICNhZmE7Jyk7CiAgfSBlbHNlIHsKICAgIHNlbGxDb3VudCsrOwogICAgY29uc29sZS5sb2coYCVj56ysJHtzZWxsQ291bnR95qyh6LOj5Ye6YCwgJ2NvbG9yOiAjZmFmOycpOwogIH0KfSwge29uY2U6IHRydWV9KTsKZWxlbWVudC5jbGljaygpOwphd2FpdCBzbGVlcChnZXRSYW5kb21XYWl0KE1JTl9XQUlUX01TLCBNQVhfV0FJVF9NUykpOwp9Cgpjb25zdCBleGVjdXRlVHJhZGUgPSBhc3luYyAodHlwZSwgcGFyYW1zKSA9PiB7CmlmICghd2luZG93LnJ1bm5pbmcpIHJldHVybiBjb25zb2xlLmxvZygn5bey5pqr5YGcJyk7CmF3YWl0IGNsaWNrRWxlbWVudEJ5VGV4dCh0eXBlLCAicCIpOwphd2FpdCBjbGlja0VsZW1lbnRCeVRleHQoJ01hcmtldCcsICJkaXYiKTsKYXdhaXQgY2xpY2tFbGVtZW50QnlUZXh0KHBhcmFtcy5tb2RlIHx8ICdMaW1pdCcsICJkaXYiKTsKYXdhaXQgc2V0UHJpY2UodHlwZSwgcGFyYW1zW3R5cGVdKTsKYXdhaXQgY2xpY2tFbGVtZW50QnlUZXh0KCJNYXgiLCAiZGl2Iik7CmF3YWl0IGNsaWNrVHJhZGVCdXR0b24odHlwZSk7Cn07Cgpjb25zdCBnZXRSYW5kb21XYWl0ID0gKG1pbiwgbWF4KSA9PiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBtYXggKyBtaW4pOwoKY29uc3QgcGVyZm9ybVRyYWRlQ3ljbGUgPSBhc3luYyAocGFyYW1zKSA9PiB7CnRyeSB7CiAgdHJhZGVDb3VudCsrOwogIGF3YWl0IGV4ZWN1dGVUcmFkZSgiQnV5IiwgcGFyYW1zKTsKICBhd2FpdCBzbGVlcChnZXRSYW5kb21XYWl0KE1JTl9TV0lUQ0hfTVMsIE1BWF9TV0lUQ0hfTVMpKTsKICBhd2FpdCBleGVjdXRlVHJhZGUoIlNlbGwiLCBwYXJhbXMpOwogIGF3YWl0IHNsZWVwKGdldFJhbmRvbVdhaXQoTUlOX1NXSVRDSF9NUywgTUFYX1NXSVRDSF9NUykpOwp9IGNhdGNoIChlcnJvcikgewogIGNvbnNvbGUuZXJyb3IoIuWPkeeUn+mUmeivrzoiLCBlcnJvcik7Cn0KfTsKCmNvbnN0IG9yZGVyVGltZW91dE1hcCA9IG5ldyBNYXAoKTsKCmNvbnN0IGNoZWNrT3JkZXJUaW1lb3V0ID0gKG9yZGVyTGlzdCkgPT4gewogIG9yZGVyTGlzdC5mb3JFYWNoKG9yZGVyID0+IHsKICAgICAgY29uc3QgdGltZW91dFRpbWUgPSBvcmRlclRpbWVvdXRNYXAuZ2V0KG9yZGVyLm9yZGVyVGV4dCk7CiAgICAgIGlmICghdGltZW91dFRpbWUpIHJldHVybjsKICAgICAgaWYgKERhdGUubm93KCkgPiB0aW1lb3V0VGltZSkgewogICAgICAgICAgb3JkZXIuY2FuY2VsKCk7CiAgICAgICAgICBjYW5jZWxDb3VudCsrOwogICAgICAgICAgY29uc29sZS5sb2coYCVj6K6i5Y2V44CQJHtvcmRlci5vcmRlclRleHR944CR6LaF5pe25pyq5oiQ5Lqk77yM5bey5Y+W5raI77yB6K6i5Y2V5Y+W5raI5qyh5pWw77yaJHtjYW5jZWxDb3VudH1gLCAnY29sb3I6ICNmZmE7JykKICAgICAgfQogIH0pCn0KCmNvbnN0IGdldFRhYnMgPSAoKSA9PiB7CiAgY29uc3QgYW5jaG9yRWxlbWVudCA9IGZpbmRFbGVtZW50c0J5VGV4dCgnTXkgQXNzZXRzJywgJ2RpdicpWzBdOwogIGNvbnN0IHRhYnNFbGVtZW50ID0gYW5jaG9yRWxlbWVudC5wYXJlbnRFbGVtZW50LnBhcmVudEVsZW1lbnQ7CgogIGNvbnN0IG9wZW5PcmRlclRhYiA9IHRhYnNFbGVtZW50LmNoaWxkcmVuWzBdOwogIHJldHVybiB7CiAgICAgIG9wZW5PcmRlclRhYiwKICAgICAgdGFic0VsZW1lbnQsCiAgfTsKfQpjb25zdCBnZXRPcmRlckxpc3RFbGVtZW50ID0gKHRhYnNFbGVtZW50KSA9PiB0YWJzRWxlbWVudC5wYXJlbnRFbGVtZW50Lm5leHRFbGVtZW50U2libGluZy5jaGlsZHJlblswXS5jaGlsZHJlblsxXTsKCmNvbnN0IGdldE9yZGVyTGlzdCA9ICh0cmFkaW5nUGFyYW1zKSA9PiB7CiAgY29uc3QgZWxlbWVudCA9IGdldE9yZGVyTGlzdEVsZW1lbnQoZ2V0VGFicygpLnRhYnNFbGVtZW50KTsKICBjb25zdCB7dGltZW91dCA9IDB9ID0gdHJhZGluZ1BhcmFtczsKCiAgY29uc3Qgb3JkZXJMaXN0ID0gWy4uLihlbGVtZW50Py5jaGlsZHJlbiA/PyBbXSldLnJlZHVjZSgocmVzLCBlbGUsIGkpID0+IHsKICAgICAgY29uc3Qgb3JkZXJUZXh0ID0gZWxlLnRleHRDb250ZW50OwogICAgICBpZiAob3JkZXJUZXh0LmluY2x1ZGVzKCdObyBvcGVuIE9yZGVycycpKSByZXR1cm4gW107CgogICAgICBjb25zdCBvcmRlciA9IHsKICAgICAgICAgIG9yZGVyVGV4dCwgZWxlLAogICAgICAgICAgY2FuY2VsOiAoKSA9PiBmaW5kRWxlbWVudHNCeVRleHQoJ0NhbmNlbCcsICdwJywgZWxlKVswXS5jbGljaygpLAogICAgICAgICAgZGF0YTogZWxlLmlubmVyVGV4dC5zcGxpdCgnXG4nKS5maWx0ZXIoaSA9PiBpKSwKICAgICAgfQoKICAgICAgcmVzLnB1c2gob3JkZXIpCiAgICAgIGNvbnN0IHRpbWVvdXRUaW1lID0gdGltZW91dCA/IG9yZGVyVGltZW91dE1hcC5nZXQob3JkZXJUZXh0KSB8fCAoRGF0ZS5ub3coKSArIHRpbWVvdXQgKiAxMDAwKSA6IDA7CiAgICAgIG9yZGVyVGltZW91dE1hcC5zZXQob3JkZXJUZXh0LCB0aW1lb3V0VGltZSk7CiAgICAgIHJldHVybiByZXMKICB9LCBbXSkKICByZXR1cm4gb3JkZXJMaXN0Owp9Cgpjb25zdCBtYWluID0gKCkgPT4gewogIGNvbnN0IHtyZWYsIG5leHRUaWNrfSA9IHdpbmRvdy5WdWU7CgogIHdpbmRvdy5UQU1QRVJNT05LRVlfVlVFX0FQUC50ZW1wbGF0ZSA9IGAKICA8ZGl2CiAgICBjbGFzcz0nYmFja3BhY2stdG9vbCBncmlkIGdhcC0yIHRleHQtc20gdGV4dC13aGl0ZSBiZy1iYXNlLTcwMCBwLTIgcm91bmRlZCcKICAgIHN0eWxlPSdncmlkLXRlbXBsYXRlLWFyZWFzOiAiYSBhIC4gLiIgImEgYSAuIC4iICJhIGEgLiAuIiAiYSBhIC4gLiIgImIgYiBiIGIiICIuIC4gLiAuIjsnCiAgPgogICAgICA8YnV0dG9uCiAgICAgICAgY2xhc3M9J2JnLWdyZWVuVGV4dCByb3VuZGVkIHAtMiBoLTEyIHNlbGYtY2VudGVyJyBzdHlsZT0nZ3JpZC1hcmVhOiBhOycKICAgICAgICA6Y2xhc3M9J3siYmctcmVkVGV4dCI6IHJ1bm5pbmd9JwogICAgICAgIEBjbGljaz0naGFuZGxlU3RhcnQnCiAgICAgID4KICAgICAgICAgIHt7cnVubmluZyA/ICfohbPmnKzpgYvooYzkuK0s6bue5pOK6Zec6ZaJ5Lqk5piTJyA6ICfllZ/li5XohbPmnKws6bue5pOK6ZaL5aeL5Lqk5piTJ319CiAgICAgIDwvYnV0dG9uPgogICAgICA8bGFiZWw+CiAgICAgICAgICA8c3Bhbj7pmZDlg7nvvJo8L3NwYW4+CiAgICAgICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIHZhbHVlPSJMaW1pdCIgOmRpc2FibGVkPSdydW5uaW5nJyB2LW1vZGVsPSJ0cmFkaW5nUGFyYW1zLm1vZGUiIC8+CiAgICAgIDwvbGFiZWw+CiAgICAgIDxsYWJlbD4KICAgICAgICAgIDxzcGFuPuW4guWgtO+8mjwvc3Bhbj4KICAgICAgICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgdmFsdWU9Ik1hcmtldCIgOmRpc2FibGVkPSdydW5uaW5nJyB2LW1vZGVsPSJ0cmFkaW5nUGFyYW1zLm1vZGUiIC8+CiAgICAgIDwvbGFiZWw+CgogICAgICA8c3BhbiA6Y2xhc3M9J3sib3BhY2l0eS0xMCI6IHRyYWRpbmdQYXJhbXMubW9kZSA9PT0gIk1hcmtldCJ9Jz7nrKzlub7lgIvosrflhaU6PC9zcGFuPgogICAgICA8aW5wdXQKICAgICAgICAgY2xhc3M9J3ctMTIgaC0yIHB5LTIgdGV4dC1jZW50ZXIgYmctYmxhY2sgdGV4dC1ncmVlblRleHQnCiAgICAgICAgIDpjbGFzcz0neyJiZy1ibGFjay8yNSI6IHJ1bm5pbmcsICJvcGFjaXR5LTEwIjogdHJhZGluZ1BhcmFtcy5tb2RlID09PSAiTWFya2V0In0nCiAgICAgICAgIHR5cGU9J251bWJlcicgOm1pbj0nMScgOm1heD0nMjAnIDpzdGVwPScxJyA6ZGlzYWJsZWQ9J3J1bm5pbmcgfHwgdHJhZGluZ1BhcmFtcy5tb2RlID09PSAiTWFya2V0IicKICAgICAgICAgdi1tb2RlbC5udW1iZXI9J3RyYWRpbmdQYXJhbXMuQnV5JwogICAgICAgICBAaW5wdXQ9J2UgPT4gaGFuZGxlTnVtYmVySW5wdXQoZSwgIkJ1eSIpJwogICAgICAgLz4KICAgICAgPHNwYW4gOmNsYXNzPSd7Im9wYWNpdHktMTAiOiB0cmFkaW5nUGFyYW1zLm1vZGUgPT09ICJNYXJrZXQifSc+56ys5bm+5YCL6LOj5Ye6Ojwvc3Bhbj4KICAgICAgPGlucHV0CiAgICAgICAgY2xhc3M9J3ctMTIgaC0yIHB5LTIgdGV4dC1jZW50ZXIgYmctYmxhY2sgdGV4dC1yZWRUZXh0JwogICAgICAgIDpjbGFzcz0neyJiZy1ibGFjay8yNSI6IHJ1bm5pbmcsICJvcGFjaXR5LTEwIjogdHJhZGluZ1BhcmFtcy5tb2RlID09PSAiTWFya2V0In0nCiAgICAgICAgdHlwZT0nbnVtYmVyJyA6bWluPScxJyA6bWF4PScyMCcgOnN0ZXA9JzEnIDpkaXNhYmxlZD0ncnVubmluZyB8fCB0cmFkaW5nUGFyYW1zLm1vZGUgPT09ICJNYXJrZXQiJwogICAgICAgIHYtbW9kZWwubnVtYmVyPSd0cmFkaW5nUGFyYW1zLlNlbGwnCiAgICAgICAgQGlucHV0PSdlID0+IGhhbmRsZU51bWJlcklucHV0KGUsICJTZWxsIiknCiAgICAgIC8+CiAgICAgIDxzcGFuPui2heaXtuaXtumXtCjnp5IpOjwvc3Bhbj4KICAgICAgPGlucHV0CiAgICAgICAgY2xhc3M9J3ctMTIgaC0yIHB5LTIgdGV4dC1jZW50ZXIgYmctYmxhY2sgdGV4dC1hY2NlbnRCbHVlJyA6Y2xhc3M9J3siYmctYmxhY2svMjUiOiBydW5uaW5nfScKICAgICAgICB0eXBlPSdudW1iZXInIDptaW49JzAnIDptYXg9JzYwMCcgOnN0ZXA9JzEnIDpkaXNhYmxlZD0ncnVubmluZycKICAgICAgICB2LW1vZGVsLm51bWJlcj0ndHJhZGluZ1BhcmFtcy50aW1lb3V0JwogICAgICAgIEBpbnB1dD0nZSA9PiBoYW5kbGVOdW1iZXJJbnB1dChlLCAidGltZW91dCIsIHttaW46IDAsIG1heDogNjAwfSknCiAgICAgIC8+CgogICAgICA8cCBjbGFzcz0nbXQtNCBweC0yIHB0LTIgYm9yZGVyLXQnIHN0eWxlPSdncmlkLWFyZWE6IGI7Jz7otoXmmYLmmYLplpPvvJrotoXmmYLoh6rli5Xlj5bmtojoqILllq7vvIw8Y29kZT4wPC9jb2RlPueCuuS4jeWPlua2iO+8gTwvcD4KICAgICAgPGRpdj7nm67liY3oqILllq7mlbjvvJp7e2N1cnJlbnRPcmRlci5sZW5ndGh9fTwvZGl2PgogICAgICA8ZGl2Puiyt+WFpeasoeaVuO+8mjxzcGFuIHN0eWxlPSdjb2xvcjogI2FmYTsnPnt7b3JkZXJDb3VudC5idXl9fTwvc3Bhbj48L2Rpdj4KICAgICAgPGRpdj7os6Plh7rmrKHmlbjvvJo8c3BhbiBzdHlsZT0nY29sb3I6ICNmYWY7Jz57e29yZGVyQ291bnQuc2VsbH19PC9zcGFuPjwvZGl2PgogICAgICA8ZGl2PuWPlua2iOasoeaVuO+8mjxzcGFuIHN0eWxlPSdjb2xvcjogI2ZmYTsnPnt7b3JkZXJDb3VudC5jYW5jZWx9fTwvc3Bhbj48L2Rpdj4KICA8L2Rpdj4KICBgCgogIHdpbmRvdy5UQU1QRVJNT05LRVlfVlVFX0FQUC5zZXR1cCA9ICgpID0+IHsKICAgICAgY29uc3QgcnVubmluZyA9IHJlZihmYWxzZSk7CiAgICAgIGNvbnN0IHRyYWRpbmdQYXJhbXMgPSByZWYoewogICAgICAgICAgQnV5OiAyLAogICAgICAgICAgU2VsbDogMiwKICAgICAgICAgIHRpbWVvdXQ6IDUsCiAgICAgICAgICBtb2RlOiAnTGltaXQnLAogICAgICB9KTsKICAgICAgY29uc3Qgb3JkZXJDb3VudCA9IHJlZih7CiAgICAgICAgYnV5OiAwLAogICAgICAgIHNlbGw6IDAsCiAgICAgICAgY2FuY2VsOiAwLAogICAgICB9KTsKICAgICAgY29uc3QgY3VycmVudE9yZGVyID0gcmVmKFtdKTsKCiAgICAgIGNvbnN0IGhhbmRsZU51bWJlcklucHV0ID0gKGUsIHR5cGUsIG9wdGlvbnMgPSB7bWluOiAxLCBtYXg6IDIwfSkgPT4gewogICAgICAgICAgY29uc3Qge21pbiwgbWF4fSA9IG9wdGlvbnMKICAgICAgICAgIGxldCB2YWx1ZSA9IHBhcnNlSW50KGUudGFyZ2V0LnZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSA+IG1heCkgdmFsdWUgPSBtYXg7CiAgICAgICAgICBpZiAodmFsdWUgPCBtaW4gfHwgaXNOYU4odmFsdWUpKSB2YWx1ZSA9IG1pbjsKICAgICAgICAgIHRyYWRpbmdQYXJhbXMudmFsdWVbdHlwZV0gPSBNYXRoLm1heChtaW4sIE1hdGgubWluKG1heCwgdmFsdWUpKTsKICAgICAgfQoKICAgICAgY29uc3Qgc3RhcnRUcmFkaW5nID0gYXN5bmMgKCkgPT4gewogICAgICAgICAgYXdhaXQgcGVyZm9ybVRyYWRlQ3ljbGUodHJhZGluZ1BhcmFtcy52YWx1ZSk7CiAgICAgICAgICBvcmRlckNvdW50LnZhbHVlLmJ1eSA9IGJ1eUNvdW50OwogICAgICAgICAgb3JkZXJDb3VudC52YWx1ZS5zZWxsID0gc2VsbENvdW50OwogICAgICAgICAgYXdhaXQgc2xlZXAoMzAwMCk7CiAgICAgICAgICBpZiAocnVubmluZy52YWx1ZSkgewogICAgICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gc3RhcnRUcmFkaW5nKCkpOwogICAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBxdWVyeU9yZGVyTGlzdFRhc2sgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICBjb25zdCB7b3Blbk9yZGVyVGFiLCB0YWJzRWxlbWVudH0gPSBnZXRUYWJzKCk7CiAgICAgICAgICBvcGVuT3JkZXJUYWIuY2xpY2soKTsKICAgICAgICAgIGF3YWl0IHNsZWVwKDMwMCk7CiAgICAgICAgICBjb25zdCBvcmRlckxpc3QgPSBnZXRPcmRlckxpc3QodHJhZGluZ1BhcmFtcy52YWx1ZSk7CiAgICAgICAgICBjdXJyZW50T3JkZXIudmFsdWUgPSBvcmRlckxpc3Q7CiAgICAgICAgICBjaGVja09yZGVyVGltZW91dChvcmRlckxpc3QpOwogICAgICAgICAgb3JkZXJDb3VudC52YWx1ZS5jYW5jZWwgPSBjYW5jZWxDb3VudDsKICAgICAgICAgIGF3YWl0IHNsZWVwKDIwMDApOwogICAgICAgICAgaWYgKHJ1bm5pbmcudmFsdWUpIHsKICAgICAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHF1ZXJ5T3JkZXJMaXN0VGFzaygpKTsKICAgICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgaGFuZGxlU3RhcnQgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgICB3aW5kb3cucnVubmluZyA9IHJ1bm5pbmcudmFsdWUgPSAhcnVubmluZy52YWx1ZTsKICAgICAgICAgIGNvbnNvbGUubG9nKHJ1bm5pbmcudmFsdWUgPyAnc3RhcnQnIDogJ3N0b3AnKTsKCiAgICAgICAgICBydW5uaW5nLnZhbHVlICYmIHN0YXJ0VHJhZGluZygpOwoKICAgICAgICAgIHJ1bm5pbmcudmFsdWUgJiYgcXVlcnlPcmRlckxpc3RUYXNrKCk7CgogICAgICAgICAgIXJ1bm5pbmcudmFsdWUgJiYgZ2V0UHJpY2VFbGVtZW50KCdCdXknLCB0cmFkaW5nUGFyYW1zLnZhbHVlLkJ1eSkuY2xhc3NMaXN0LnJlbW92ZSgnYm9yZGVyJyk7CiAgICAgICAgICAhcnVubmluZy52YWx1ZSAmJiBnZXRQcmljZUVsZW1lbnQoJ1NlbGwnLCB0cmFkaW5nUGFyYW1zLnZhbHVlLlNlbGwpLmNsYXNzTGlzdC5yZW1vdmUoJ2JvcmRlcicpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgICAgcnVubmluZywKICAgICAgICAgIGN1cnJlbnRPcmRlciwKICAgICAgICAgIG9yZGVyQ291bnQsCiAgICAgICAgICB0cmFkaW5nUGFyYW1zLAogICAgICAgICAgaGFuZGxlTnVtYmVySW5wdXQsCiAgICAgICAgICBoYW5kbGVTdGFydCwKICAgICAgfQogIH0KfQoKKGZ1bmN0aW9uKCkgewogICd1c2Ugc3RyaWN0JzsKICBtYWluKCk7Cn0pKCk7Cg==","requires":[{"meta":{"name":"vue.js","url":"https://update.greasyfork.org/scripts/491401/1352455/vue.js","ts":1712333128645,"mimetype":"text/javascript"},"source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICB2dWUKLy8gQG5hbWVzcGFjZSAgICBodHRwOi8vdGFtcGVybW9ua2V5Lm5ldC8KLy8gQHZlcnNpb24gICAgICB2My40LjIxCi8vIEBkZXNjcmlwdGlvbiAgdnVlIHYzLjQuMjEKLy8gQGF1dGhvciAgICAgICB6aG93aW55Ci8vIEBtYXRjaCAgICAgICAgKgovLyBAaWNvbiAgICAgICAgIGh0dHBzOi8vdnVlanMub3JnL2xvZ28uc3ZnCi8vIEBncmFudCAgICAgICAgbm9uZQovLyBAbGljZW5zZSBNSVQKLy8gPT0vVXNlclNjcmlwdD09CgovKioKKiB2dWUgdjMuNC4yMQoqIChjKSAyMDE4LXByZXNlbnQgWXV4aSAoRXZhbikgWW91IGFuZCBWdWUgY29udHJpYnV0b3JzCiogQGxpY2Vuc2UgTUlUCioqLwp2YXIgVnVlID0gKGZ1bmN0aW9uIChleHBvcnRzKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBmdW5jdGlvbiBtYWtlTWFwKHN0ciwgZXhwZWN0c0xvd2VyQ2FzZSkgewogICAgY29uc3Qgc2V0ID0gbmV3IFNldChzdHIuc3BsaXQoIiwiKSk7CiAgICByZXR1cm4gZXhwZWN0c0xvd2VyQ2FzZSA/ICh2YWwpID0+IHNldC5oYXModmFsLnRvTG93ZXJDYXNlKCkpIDogKHZhbCkgPT4gc2V0Lmhhcyh2YWwpOwogIH0KCiAgY29uc3QgRU1QVFlfT0JKID0gT2JqZWN0LmZyZWV6ZSh7fSkgOwogIGNvbnN0IEVNUFRZX0FSUiA9IE9iamVjdC5mcmVlemUoW10pIDsKICBjb25zdCBOT09QID0gKCkgPT4gewogIH07CiAgY29uc3QgTk8gPSAoKSA9PiBmYWxzZTsKICBjb25zdCBpc09uID0gKGtleSkgPT4ga2V5LmNoYXJDb2RlQXQoMCkgPT09IDExMSAmJiBrZXkuY2hhckNvZGVBdCgxKSA9PT0gMTEwICYmIC8vIHVwcGVyY2FzZSBsZXR0ZXIKICAoa2V5LmNoYXJDb2RlQXQoMikgPiAxMjIgfHwga2V5LmNoYXJDb2RlQXQoMikgPCA5Nyk7CiAgY29uc3QgaXNNb2RlbExpc3RlbmVyID0gKGtleSkgPT4ga2V5LnN0YXJ0c1dpdGgoIm9uVXBkYXRlOiIpOwogIGNvbnN0IGV4dGVuZCA9IE9iamVjdC5hc3NpZ247CiAgY29uc3QgcmVtb3ZlID0gKGFyciwgZWwpID0+IHsKICAgIGNvbnN0IGkgPSBhcnIuaW5kZXhPZihlbCk7CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIGFyci5zcGxpY2UoaSwgMSk7CiAgICB9CiAgfTsKICBjb25zdCBoYXNPd25Qcm9wZXJ0eSQxID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICBjb25zdCBoYXNPd24gPSAodmFsLCBrZXkpID0+IGhhc093blByb3BlcnR5JDEuY2FsbCh2YWwsIGtleSk7CiAgY29uc3QgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgY29uc3QgaXNNYXAgPSAodmFsKSA9PiB0b1R5cGVTdHJpbmcodmFsKSA9PT0gIltvYmplY3QgTWFwXSI7CiAgY29uc3QgaXNTZXQgPSAodmFsKSA9PiB0b1R5cGVTdHJpbmcodmFsKSA9PT0gIltvYmplY3QgU2V0XSI7CiAgY29uc3QgaXNEYXRlID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICJbb2JqZWN0IERhdGVdIjsKICBjb25zdCBpc1JlZ0V4cCA9ICh2YWwpID0+IHRvVHlwZVN0cmluZyh2YWwpID09PSAiW29iamVjdCBSZWdFeHBdIjsKICBjb25zdCBpc0Z1bmN0aW9uID0gKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gImZ1bmN0aW9uIjsKICBjb25zdCBpc1N0cmluZyA9ICh2YWwpID0+IHR5cGVvZiB2YWwgPT09ICJzdHJpbmciOwogIGNvbnN0IGlzU3ltYm9sID0gKHZhbCkgPT4gdHlwZW9mIHZhbCA9PT0gInN5bWJvbCI7CiAgY29uc3QgaXNPYmplY3QgPSAodmFsKSA9PiB2YWwgIT09IG51bGwgJiYgdHlwZW9mIHZhbCA9PT0gIm9iamVjdCI7CiAgY29uc3QgaXNQcm9taXNlID0gKHZhbCkgPT4gewogICAgcmV0dXJuIChpc09iamVjdCh2YWwpIHx8IGlzRnVuY3Rpb24odmFsKSkgJiYgaXNGdW5jdGlvbih2YWwudGhlbikgJiYgaXNGdW5jdGlvbih2YWwuY2F0Y2gpOwogIH07CiAgY29uc3Qgb2JqZWN0VG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwogIGNvbnN0IHRvVHlwZVN0cmluZyA9ICh2YWx1ZSkgPT4gb2JqZWN0VG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgY29uc3QgdG9SYXdUeXBlID0gKHZhbHVlKSA9PiB7CiAgICByZXR1cm4gdG9UeXBlU3RyaW5nKHZhbHVlKS5zbGljZSg4LCAtMSk7CiAgfTsKICBjb25zdCBpc1BsYWluT2JqZWN0ID0gKHZhbCkgPT4gdG9UeXBlU3RyaW5nKHZhbCkgPT09ICJbb2JqZWN0IE9iamVjdF0iOwogIGNvbnN0IGlzSW50ZWdlcktleSA9IChrZXkpID0+IGlzU3RyaW5nKGtleSkgJiYga2V5ICE9PSAiTmFOIiAmJiBrZXlbMF0gIT09ICItIiAmJiAiIiArIHBhcnNlSW50KGtleSwgMTApID09PSBrZXk7CiAgY29uc3QgaXNSZXNlcnZlZFByb3AgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgKICAgIC8vIHRoZSBsZWFkaW5nIGNvbW1hIGlzIGludGVudGlvbmFsIHNvIGVtcHR5IHN0cmluZyAiIiBpcyBhbHNvIGluY2x1ZGVkCiAgICAiLGtleSxyZWYscmVmX2ZvcixyZWZfa2V5LG9uVm5vZGVCZWZvcmVNb3VudCxvblZub2RlTW91bnRlZCxvblZub2RlQmVmb3JlVXBkYXRlLG9uVm5vZGVVcGRhdGVkLG9uVm5vZGVCZWZvcmVVbm1vdW50LG9uVm5vZGVVbm1vdW50ZWQiCiAgKTsKICBjb25zdCBpc0J1aWx0SW5EaXJlY3RpdmUgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgKICAgICJiaW5kLGNsb2FrLGVsc2UtaWYsZWxzZSxmb3IsaHRtbCxpZixtb2RlbCxvbixvbmNlLHByZSxzaG93LHNsb3QsdGV4dCxtZW1vIgogICk7CiAgY29uc3QgY2FjaGVTdHJpbmdGdW5jdGlvbiA9IChmbikgPT4gewogICAgY29uc3QgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHJldHVybiAoc3RyKSA9PiB7CiAgICAgIGNvbnN0IGhpdCA9IGNhY2hlW3N0cl07CiAgICAgIHJldHVybiBoaXQgfHwgKGNhY2hlW3N0cl0gPSBmbihzdHIpKTsKICAgIH07CiAgfTsKICBjb25zdCBjYW1lbGl6ZVJFID0gLy0oXHcpL2c7CiAgY29uc3QgY2FtZWxpemUgPSBjYWNoZVN0cmluZ0Z1bmN0aW9uKChzdHIpID0+IHsKICAgIHJldHVybiBzdHIucmVwbGFjZShjYW1lbGl6ZVJFLCAoXywgYykgPT4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICIiKTsKICB9KTsKICBjb25zdCBoeXBoZW5hdGVSRSA9IC9cQihbQS1aXSkvZzsKICBjb25zdCBoeXBoZW5hdGUgPSBjYWNoZVN0cmluZ0Z1bmN0aW9uKAogICAgKHN0cikgPT4gc3RyLnJlcGxhY2UoaHlwaGVuYXRlUkUsICItJDEiKS50b0xvd2VyQ2FzZSgpCiAgKTsKICBjb25zdCBjYXBpdGFsaXplID0gY2FjaGVTdHJpbmdGdW5jdGlvbigoc3RyKSA9PiB7CiAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogIH0pOwogIGNvbnN0IHRvSGFuZGxlcktleSA9IGNhY2hlU3RyaW5nRnVuY3Rpb24oKHN0cikgPT4gewogICAgY29uc3QgcyA9IHN0ciA/IGBvbiR7Y2FwaXRhbGl6ZShzdHIpfWAgOiBgYDsKICAgIHJldHVybiBzOwogIH0pOwogIGNvbnN0IGhhc0NoYW5nZWQgPSAodmFsdWUsIG9sZFZhbHVlKSA9PiAhT2JqZWN0LmlzKHZhbHVlLCBvbGRWYWx1ZSk7CiAgY29uc3QgaW52b2tlQXJyYXlGbnMgPSAoZm5zLCBhcmcpID0+IHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGZuc1tpXShhcmcpOwogICAgfQogIH07CiAgY29uc3QgZGVmID0gKG9iaiwga2V5LCB2YWx1ZSkgPT4gewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlCiAgICB9KTsKICB9OwogIGNvbnN0IGxvb3NlVG9OdW1iZXIgPSAodmFsKSA9PiB7CiAgICBjb25zdCBuID0gcGFyc2VGbG9hdCh2YWwpOwogICAgcmV0dXJuIGlzTmFOKG4pID8gdmFsIDogbjsKICB9OwogIGNvbnN0IHRvTnVtYmVyID0gKHZhbCkgPT4gewogICAgY29uc3QgbiA9IGlzU3RyaW5nKHZhbCkgPyBOdW1iZXIodmFsKSA6IE5hTjsKICAgIHJldHVybiBpc05hTihuKSA/IHZhbCA6IG47CiAgfTsKICBsZXQgX2dsb2JhbFRoaXM7CiAgY29uc3QgZ2V0R2xvYmFsVGhpcyA9ICgpID0+IHsKICAgIHJldHVybiBfZ2xvYmFsVGhpcyB8fCAoX2dsb2JhbFRoaXMgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDogdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB7fSk7CiAgfTsKCiAgY29uc3QgUGF0Y2hGbGFnTmFtZXMgPSB7CiAgICBbMV06IGBURVhUYCwKICAgIFsyXTogYENMQVNTYCwKICAgIFs0XTogYFNUWUxFYCwKICAgIFs4XTogYFBST1BTYCwKICAgIFsxNl06IGBGVUxMX1BST1BTYCwKICAgIFszMl06IGBORUVEX0hZRFJBVElPTmAsCiAgICBbNjRdOiBgU1RBQkxFX0ZSQUdNRU5UYCwKICAgIFsxMjhdOiBgS0VZRURfRlJBR01FTlRgLAogICAgWzI1Nl06IGBVTktFWUVEX0ZSQUdNRU5UYCwKICAgIFs1MTJdOiBgTkVFRF9QQVRDSGAsCiAgICBbMTAyNF06IGBEWU5BTUlDX1NMT1RTYCwKICAgIFsyMDQ4XTogYERFVl9ST09UX0ZSQUdNRU5UYCwKICAgIFstMV06IGBIT0lTVEVEYCwKICAgIFstMl06IGBCQUlMYAogIH07CgogIGNvbnN0IHNsb3RGbGFnc1RleHQgPSB7CiAgICBbMV06ICJTVEFCTEUiLAogICAgWzJdOiAiRFlOQU1JQyIsCiAgICBbM106ICJGT1JXQVJERUQiCiAgfTsKCiAgY29uc3QgR0xPQkFMU19BTExPV0VEID0gIkluZmluaXR5LHVuZGVmaW5lZCxOYU4saXNGaW5pdGUsaXNOYU4scGFyc2VGbG9hdCxwYXJzZUludCxkZWNvZGVVUkksZGVjb2RlVVJJQ29tcG9uZW50LGVuY29kZVVSSSxlbmNvZGVVUklDb21wb25lbnQsTWF0aCxOdW1iZXIsRGF0ZSxBcnJheSxPYmplY3QsQm9vbGVhbixTdHJpbmcsUmVnRXhwLE1hcCxTZXQsSlNPTixJbnRsLEJpZ0ludCxjb25zb2xlLEVycm9yIjsKICBjb25zdCBpc0dsb2JhbGx5QWxsb3dlZCA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKEdMT0JBTFNfQUxMT1dFRCk7CgogIGNvbnN0IHJhbmdlID0gMjsKICBmdW5jdGlvbiBnZW5lcmF0ZUNvZGVGcmFtZShzb3VyY2UsIHN0YXJ0ID0gMCwgZW5kID0gc291cmNlLmxlbmd0aCkgewogICAgbGV0IGxpbmVzID0gc291cmNlLnNwbGl0KC8oXHI/XG4pLyk7CiAgICBjb25zdCBuZXdsaW5lU2VxdWVuY2VzID0gbGluZXMuZmlsdGVyKChfLCBpZHgpID0+IGlkeCAlIDIgPT09IDEpOwogICAgbGluZXMgPSBsaW5lcy5maWx0ZXIoKF8sIGlkeCkgPT4gaWR4ICUgMiA9PT0gMCk7CiAgICBsZXQgY291bnQgPSAwOwogICAgY29uc3QgcmVzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvdW50ICs9IGxpbmVzW2ldLmxlbmd0aCArIChuZXdsaW5lU2VxdWVuY2VzW2ldICYmIG5ld2xpbmVTZXF1ZW5jZXNbaV0ubGVuZ3RoIHx8IDApOwogICAgICBpZiAoY291bnQgPj0gc3RhcnQpIHsKICAgICAgICBmb3IgKGxldCBqID0gaSAtIHJhbmdlOyBqIDw9IGkgKyByYW5nZSB8fCBlbmQgPiBjb3VudDsgaisrKSB7CiAgICAgICAgICBpZiAoaiA8IDAgfHwgaiA+PSBsaW5lcy5sZW5ndGgpCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgY29uc3QgbGluZSA9IGogKyAxOwogICAgICAgICAgcmVzLnB1c2goCiAgICAgICAgICAgIGAke2xpbmV9JHsiICIucmVwZWF0KE1hdGgubWF4KDMgLSBTdHJpbmcobGluZSkubGVuZ3RoLCAwKSl9fCAgJHtsaW5lc1tqXX1gCiAgICAgICAgICApOwogICAgICAgICAgY29uc3QgbGluZUxlbmd0aCA9IGxpbmVzW2pdLmxlbmd0aDsKICAgICAgICAgIGNvbnN0IG5ld0xpbmVTZXFMZW5ndGggPSBuZXdsaW5lU2VxdWVuY2VzW2pdICYmIG5ld2xpbmVTZXF1ZW5jZXNbal0ubGVuZ3RoIHx8IDA7CiAgICAgICAgICBpZiAoaiA9PT0gaSkgewogICAgICAgICAgICBjb25zdCBwYWQgPSBzdGFydCAtIChjb3VudCAtIChsaW5lTGVuZ3RoICsgbmV3TGluZVNlcUxlbmd0aCkpOwogICAgICAgICAgICBjb25zdCBsZW5ndGggPSBNYXRoLm1heCgKICAgICAgICAgICAgICAxLAogICAgICAgICAgICAgIGVuZCA+IGNvdW50ID8gbGluZUxlbmd0aCAtIHBhZCA6IGVuZCAtIHN0YXJ0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlcy5wdXNoKGAgICB8ICBgICsgIiAiLnJlcGVhdChwYWQpICsgIl4iLnJlcGVhdChsZW5ndGgpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaiA+IGkpIHsKICAgICAgICAgICAgaWYgKGVuZCA+IGNvdW50KSB7CiAgICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5taW4oZW5kIC0gY291bnQsIGxpbmVMZW5ndGgpLCAxKTsKICAgICAgICAgICAgICByZXMucHVzaChgICAgfCAgYCArICJeIi5yZXBlYXQobGVuZ3RoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY291bnQgKz0gbGluZUxlbmd0aCArIG5ld0xpbmVTZXFMZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzLmpvaW4oIlxuIik7CiAgfQoKICBmdW5jdGlvbiBub3JtYWxpemVTdHlsZSh2YWx1ZSkgewogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGNvbnN0IHJlcyA9IHt9OwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgaXRlbSA9IHZhbHVlW2ldOwogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBpc1N0cmluZyhpdGVtKSA/IHBhcnNlU3RyaW5nU3R5bGUoaXRlbSkgOiBub3JtYWxpemVTdHlsZShpdGVtKTsKICAgICAgICBpZiAobm9ybWFsaXplZCkgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbm9ybWFsaXplZCkgewogICAgICAgICAgICByZXNba2V5XSA9IG5vcm1hbGl6ZWRba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcodmFsdWUpIHx8IGlzT2JqZWN0KHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfQogIGNvbnN0IGxpc3REZWxpbWl0ZXJSRSA9IC87KD8hW14oXSpcKSkvZzsKICBjb25zdCBwcm9wZXJ0eURlbGltaXRlclJFID0gLzooW15dKykvOwogIGNvbnN0IHN0eWxlQ29tbWVudFJFID0gL1wvXCpbXl0qP1wqXC8vZzsKICBmdW5jdGlvbiBwYXJzZVN0cmluZ1N0eWxlKGNzc1RleHQpIHsKICAgIGNvbnN0IHJldCA9IHt9OwogICAgY3NzVGV4dC5yZXBsYWNlKHN0eWxlQ29tbWVudFJFLCAiIikuc3BsaXQobGlzdERlbGltaXRlclJFKS5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgY29uc3QgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlclJFKTsKICAgICAgICB0bXAubGVuZ3RoID4gMSAmJiAocmV0W3RtcFswXS50cmltKCldID0gdG1wWzFdLnRyaW0oKSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJldDsKICB9CiAgZnVuY3Rpb24gc3RyaW5naWZ5U3R5bGUoc3R5bGVzKSB7CiAgICBsZXQgcmV0ID0gIiI7CiAgICBpZiAoIXN0eWxlcyB8fCBpc1N0cmluZyhzdHlsZXMpKSB7CiAgICAgIHJldHVybiByZXQ7CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBpbiBzdHlsZXMpIHsKICAgICAgY29uc3QgdmFsdWUgPSBzdHlsZXNba2V5XTsKICAgICAgY29uc3Qgbm9ybWFsaXplZEtleSA9IGtleS5zdGFydHNXaXRoKGAtLWApID8ga2V5IDogaHlwaGVuYXRlKGtleSk7CiAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgICAgIHJldCArPSBgJHtub3JtYWxpemVkS2V5fToke3ZhbHVlfTtgOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVDbGFzcyh2YWx1ZSkgewogICAgbGV0IHJlcyA9ICIiOwogICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICByZXMgPSB2YWx1ZTsKICAgIH0gZWxzZSBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBub3JtYWxpemVDbGFzcyh2YWx1ZVtpXSk7CiAgICAgICAgaWYgKG5vcm1hbGl6ZWQpIHsKICAgICAgICAgIHJlcyArPSBub3JtYWxpemVkICsgIiAiOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgZm9yIChjb25zdCBuYW1lIGluIHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlW25hbWVdKSB7CiAgICAgICAgICByZXMgKz0gbmFtZSArICIgIjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXMudHJpbSgpOwogIH0KICBmdW5jdGlvbiBub3JtYWxpemVQcm9wcyhwcm9wcykgewogICAgaWYgKCFwcm9wcykKICAgICAgcmV0dXJuIG51bGw7CiAgICBsZXQgeyBjbGFzczoga2xhc3MsIHN0eWxlIH0gPSBwcm9wczsKICAgIGlmIChrbGFzcyAmJiAhaXNTdHJpbmcoa2xhc3MpKSB7CiAgICAgIHByb3BzLmNsYXNzID0gbm9ybWFsaXplQ2xhc3Moa2xhc3MpOwogICAgfQogICAgaWYgKHN0eWxlKSB7CiAgICAgIHByb3BzLnN0eWxlID0gbm9ybWFsaXplU3R5bGUoc3R5bGUpOwogICAgfQogICAgcmV0dXJuIHByb3BzOwogIH0KCiAgY29uc3QgSFRNTF9UQUdTID0gImh0bWwsYm9keSxiYXNlLGhlYWQsbGluayxtZXRhLHN0eWxlLHRpdGxlLGFkZHJlc3MsYXJ0aWNsZSxhc2lkZSxmb290ZXIsaGVhZGVyLGhncm91cCxoMSxoMixoMyxoNCxoNSxoNixuYXYsc2VjdGlvbixkaXYsZGQsZGwsZHQsZmlnY2FwdGlvbixmaWd1cmUscGljdHVyZSxocixpbWcsbGksbWFpbixvbCxwLHByZSx1bCxhLGIsYWJicixiZGksYmRvLGJyLGNpdGUsY29kZSxkYXRhLGRmbixlbSxpLGtiZCxtYXJrLHEscnAscnQscnVieSxzLHNhbXAsc21hbGwsc3BhbixzdHJvbmcsc3ViLHN1cCx0aW1lLHUsdmFyLHdicixhcmVhLGF1ZGlvLG1hcCx0cmFjayx2aWRlbyxlbWJlZCxvYmplY3QscGFyYW0sc291cmNlLGNhbnZhcyxzY3JpcHQsbm9zY3JpcHQsZGVsLGlucyxjYXB0aW9uLGNvbCxjb2xncm91cCx0YWJsZSx0aGVhZCx0Ym9keSx0ZCx0aCx0cixidXR0b24sZGF0YWxpc3QsZmllbGRzZXQsZm9ybSxpbnB1dCxsYWJlbCxsZWdlbmQsbWV0ZXIsb3B0Z3JvdXAsb3B0aW9uLG91dHB1dCxwcm9ncmVzcyxzZWxlY3QsdGV4dGFyZWEsZGV0YWlscyxkaWFsb2csbWVudSxzdW1tYXJ5LHRlbXBsYXRlLGJsb2NrcXVvdGUsaWZyYW1lLHRmb290IjsKICBjb25zdCBTVkdfVEFHUyA9ICJzdmcsYW5pbWF0ZSxhbmltYXRlTW90aW9uLGFuaW1hdGVUcmFuc2Zvcm0sY2lyY2xlLGNsaXBQYXRoLGNvbG9yLXByb2ZpbGUsZGVmcyxkZXNjLGRpc2NhcmQsZWxsaXBzZSxmZUJsZW5kLGZlQ29sb3JNYXRyaXgsZmVDb21wb25lbnRUcmFuc2ZlcixmZUNvbXBvc2l0ZSxmZUNvbnZvbHZlTWF0cml4LGZlRGlmZnVzZUxpZ2h0aW5nLGZlRGlzcGxhY2VtZW50TWFwLGZlRGlzdGFudExpZ2h0LGZlRHJvcFNoYWRvdyxmZUZsb29kLGZlRnVuY0EsZmVGdW5jQixmZUZ1bmNHLGZlRnVuY1IsZmVHYXVzc2lhbkJsdXIsZmVJbWFnZSxmZU1lcmdlLGZlTWVyZ2VOb2RlLGZlTW9ycGhvbG9neSxmZU9mZnNldCxmZVBvaW50TGlnaHQsZmVTcGVjdWxhckxpZ2h0aW5nLGZlU3BvdExpZ2h0LGZlVGlsZSxmZVR1cmJ1bGVuY2UsZmlsdGVyLGZvcmVpZ25PYmplY3QsZyxoYXRjaCxoYXRjaHBhdGgsaW1hZ2UsbGluZSxsaW5lYXJHcmFkaWVudCxtYXJrZXIsbWFzayxtZXNoLG1lc2hncmFkaWVudCxtZXNocGF0Y2gsbWVzaHJvdyxtZXRhZGF0YSxtcGF0aCxwYXRoLHBhdHRlcm4scG9seWdvbixwb2x5bGluZSxyYWRpYWxHcmFkaWVudCxyZWN0LHNldCxzb2xpZGNvbG9yLHN0b3Asc3dpdGNoLHN5bWJvbCx0ZXh0LHRleHRQYXRoLHRpdGxlLHRzcGFuLHVua25vd24sdXNlLHZpZXciOwogIGNvbnN0IE1BVEhfVEFHUyA9ICJhbm5vdGF0aW9uLGFubm90YXRpb24teG1sLG1hY3Rpb24sbWFsaWduZ3JvdXAsbWFsaWdubWFyayxtYXRoLG1lbmNsb3NlLG1lcnJvcixtZmVuY2VkLG1mcmFjLG1mcmFjdGlvbixtZ2x5cGgsbWksbWxhYmVsZWR0cixtbG9uZ2RpdixtbXVsdGlzY3JpcHRzLG1uLG1vLG1vdmVyLG1wYWRkZWQsbXBoYW50b20sbXByZXNjcmlwdHMsbXJvb3QsbXJvdyxtcyxtc2NhcnJpZXMsbXNjYXJyeSxtc2dyb3VwLG1zbGluZSxtc3BhY2UsbXNxcnQsbXNyb3csbXN0YWNrLG1zdHlsZSxtc3ViLG1zdWJzdXAsbXN1cCxtdGFibGUsbXRkLG10ZXh0LG10cixtdW5kZXIsbXVuZGVyb3Zlcixub25lLHNlbWFudGljcyI7CiAgY29uc3QgVk9JRF9UQUdTID0gImFyZWEsYmFzZSxicixjb2wsZW1iZWQsaHIsaW1nLGlucHV0LGxpbmssbWV0YSxwYXJhbSxzb3VyY2UsdHJhY2ssd2JyIjsKICBjb25zdCBpc0hUTUxUYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChIVE1MX1RBR1MpOwogIGNvbnN0IGlzU1ZHVGFnID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoU1ZHX1RBR1MpOwogIGNvbnN0IGlzTWF0aE1MVGFnID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoTUFUSF9UQUdTKTsKICBjb25zdCBpc1ZvaWRUYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChWT0lEX1RBR1MpOwoKICBjb25zdCBzcGVjaWFsQm9vbGVhbkF0dHJzID0gYGl0ZW1zY29wZSxhbGxvd2Z1bGxzY3JlZW4sZm9ybW5vdmFsaWRhdGUsaXNtYXAsbm9tb2R1bGUsbm92YWxpZGF0ZSxyZWFkb25seWA7CiAgY29uc3QgaXNTcGVjaWFsQm9vbGVhbkF0dHIgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChzcGVjaWFsQm9vbGVhbkF0dHJzKTsKICBjb25zdCBpc0Jvb2xlYW5BdHRyID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoCiAgICBzcGVjaWFsQm9vbGVhbkF0dHJzICsgYCxhc3luYyxhdXRvZm9jdXMsYXV0b3BsYXksY29udHJvbHMsZGVmYXVsdCxkZWZlcixkaXNhYmxlZCxoaWRkZW4saW5lcnQsbG9vcCxvcGVuLHJlcXVpcmVkLHJldmVyc2VkLHNjb3BlZCxzZWFtbGVzcyxjaGVja2VkLG11dGVkLG11bHRpcGxlLHNlbGVjdGVkYAogICk7CiAgZnVuY3Rpb24gaW5jbHVkZUJvb2xlYW5BdHRyKHZhbHVlKSB7CiAgICByZXR1cm4gISF2YWx1ZSB8fCB2YWx1ZSA9PT0gIiI7CiAgfQogIGNvbnN0IGlzS25vd25IdG1sQXR0ciA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKAogICAgYGFjY2VwdCxhY2NlcHQtY2hhcnNldCxhY2Nlc3NrZXksYWN0aW9uLGFsaWduLGFsbG93LGFsdCxhc3luYyxhdXRvY2FwaXRhbGl6ZSxhdXRvY29tcGxldGUsYXV0b2ZvY3VzLGF1dG9wbGF5LGJhY2tncm91bmQsYmdjb2xvcixib3JkZXIsYnVmZmVyZWQsY2FwdHVyZSxjaGFsbGVuZ2UsY2hhcnNldCxjaGVja2VkLGNpdGUsY2xhc3MsY29kZSxjb2RlYmFzZSxjb2xvcixjb2xzLGNvbHNwYW4sY29udGVudCxjb250ZW50ZWRpdGFibGUsY29udGV4dG1lbnUsY29udHJvbHMsY29vcmRzLGNyb3Nzb3JpZ2luLGNzcCxkYXRhLGRhdGV0aW1lLGRlY29kaW5nLGRlZmF1bHQsZGVmZXIsZGlyLGRpcm5hbWUsZGlzYWJsZWQsZG93bmxvYWQsZHJhZ2dhYmxlLGRyb3B6b25lLGVuY3R5cGUsZW50ZXJrZXloaW50LGZvcixmb3JtLGZvcm1hY3Rpb24sZm9ybWVuY3R5cGUsZm9ybW1ldGhvZCxmb3Jtbm92YWxpZGF0ZSxmb3JtdGFyZ2V0LGhlYWRlcnMsaGVpZ2h0LGhpZGRlbixoaWdoLGhyZWYsaHJlZmxhbmcsaHR0cC1lcXVpdixpY29uLGlkLGltcG9ydGFuY2UsaW5lcnQsaW50ZWdyaXR5LGlzbWFwLGl0ZW1wcm9wLGtleXR5cGUsa2luZCxsYWJlbCxsYW5nLGxhbmd1YWdlLGxvYWRpbmcsbGlzdCxsb29wLGxvdyxtYW5pZmVzdCxtYXgsbWF4bGVuZ3RoLG1pbmxlbmd0aCxtZWRpYSxtaW4sbXVsdGlwbGUsbXV0ZWQsbmFtZSxub3ZhbGlkYXRlLG9wZW4sb3B0aW11bSxwYXR0ZXJuLHBpbmcscGxhY2Vob2xkZXIscG9zdGVyLHByZWxvYWQscmFkaW9ncm91cCxyZWFkb25seSxyZWZlcnJlcnBvbGljeSxyZWwscmVxdWlyZWQscmV2ZXJzZWQscm93cyxyb3dzcGFuLHNhbmRib3gsc2NvcGUsc2NvcGVkLHNlbGVjdGVkLHNoYXBlLHNpemUsc2l6ZXMsc2xvdCxzcGFuLHNwZWxsY2hlY2ssc3JjLHNyY2RvYyxzcmNsYW5nLHNyY3NldCxzdGFydCxzdGVwLHN0eWxlLHN1bW1hcnksdGFiaW5kZXgsdGFyZ2V0LHRpdGxlLHRyYW5zbGF0ZSx0eXBlLHVzZW1hcCx2YWx1ZSx3aWR0aCx3cmFwYAogICk7CiAgY29uc3QgaXNLbm93blN2Z0F0dHIgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgKICAgIGB4bWxucyxhY2NlbnQtaGVpZ2h0LGFjY3VtdWxhdGUsYWRkaXRpdmUsYWxpZ25tZW50LWJhc2VsaW5lLGFscGhhYmV0aWMsYW1wbGl0dWRlLGFyYWJpYy1mb3JtLGFzY2VudCxhdHRyaWJ1dGVOYW1lLGF0dHJpYnV0ZVR5cGUsYXppbXV0aCxiYXNlRnJlcXVlbmN5LGJhc2VsaW5lLXNoaWZ0LGJhc2VQcm9maWxlLGJib3gsYmVnaW4sYmlhcyxieSxjYWxjTW9kZSxjYXAtaGVpZ2h0LGNsYXNzLGNsaXAsY2xpcFBhdGhVbml0cyxjbGlwLXBhdGgsY2xpcC1ydWxlLGNvbG9yLGNvbG9yLWludGVycG9sYXRpb24sY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzLGNvbG9yLXByb2ZpbGUsY29sb3ItcmVuZGVyaW5nLGNvbnRlbnRTY3JpcHRUeXBlLGNvbnRlbnRTdHlsZVR5cGUsY3Jvc3NvcmlnaW4sY3Vyc29yLGN4LGN5LGQsZGVjZWxlcmF0ZSxkZXNjZW50LGRpZmZ1c2VDb25zdGFudCxkaXJlY3Rpb24sZGlzcGxheSxkaXZpc29yLGRvbWluYW50LWJhc2VsaW5lLGR1cixkeCxkeSxlZGdlTW9kZSxlbGV2YXRpb24sZW5hYmxlLWJhY2tncm91bmQsZW5kLGV4cG9uZW50LGZpbGwsZmlsbC1vcGFjaXR5LGZpbGwtcnVsZSxmaWx0ZXIsZmlsdGVyUmVzLGZpbHRlclVuaXRzLGZsb29kLWNvbG9yLGZsb29kLW9wYWNpdHksZm9udC1mYW1pbHksZm9udC1zaXplLGZvbnQtc2l6ZS1hZGp1c3QsZm9udC1zdHJldGNoLGZvbnQtc3R5bGUsZm9udC12YXJpYW50LGZvbnQtd2VpZ2h0LGZvcm1hdCxmcm9tLGZyLGZ4LGZ5LGcxLGcyLGdseXBoLW5hbWUsZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCxnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCxnbHlwaFJlZixncmFkaWVudFRyYW5zZm9ybSxncmFkaWVudFVuaXRzLGhhbmdpbmcsaGVpZ2h0LGhyZWYsaHJlZmxhbmcsaG9yaXotYWR2LXgsaG9yaXotb3JpZ2luLXgsaWQsaWRlb2dyYXBoaWMsaW1hZ2UtcmVuZGVyaW5nLGluLGluMixpbnRlcmNlcHQsayxrMSxrMixrMyxrNCxrZXJuZWxNYXRyaXgsa2VybmVsVW5pdExlbmd0aCxrZXJuaW5nLGtleVBvaW50cyxrZXlTcGxpbmVzLGtleVRpbWVzLGxhbmcsbGVuZ3RoQWRqdXN0LGxldHRlci1zcGFjaW5nLGxpZ2h0aW5nLWNvbG9yLGxpbWl0aW5nQ29uZUFuZ2xlLGxvY2FsLG1hcmtlci1lbmQsbWFya2VyLW1pZCxtYXJrZXItc3RhcnQsbWFya2VySGVpZ2h0LG1hcmtlclVuaXRzLG1hcmtlcldpZHRoLG1hc2ssbWFza0NvbnRlbnRVbml0cyxtYXNrVW5pdHMsbWF0aGVtYXRpY2FsLG1heCxtZWRpYSxtZXRob2QsbWluLG1vZGUsbmFtZSxudW1PY3RhdmVzLG9mZnNldCxvcGFjaXR5LG9wZXJhdG9yLG9yZGVyLG9yaWVudCxvcmllbnRhdGlvbixvcmlnaW4sb3ZlcmZsb3csb3ZlcmxpbmUtcG9zaXRpb24sb3ZlcmxpbmUtdGhpY2tuZXNzLHBhbm9zZS0xLHBhaW50LW9yZGVyLHBhdGgscGF0aExlbmd0aCxwYXR0ZXJuQ29udGVudFVuaXRzLHBhdHRlcm5UcmFuc2Zvcm0scGF0dGVyblVuaXRzLHBpbmcscG9pbnRlci1ldmVudHMscG9pbnRzLHBvaW50c0F0WCxwb2ludHNBdFkscG9pbnRzQXRaLHByZXNlcnZlQWxwaGEscHJlc2VydmVBc3BlY3RSYXRpbyxwcmltaXRpdmVVbml0cyxyLHJhZGl1cyxyZWZlcnJlclBvbGljeSxyZWZYLHJlZlkscmVsLHJlbmRlcmluZy1pbnRlbnQscmVwZWF0Q291bnQscmVwZWF0RHVyLHJlcXVpcmVkRXh0ZW5zaW9ucyxyZXF1aXJlZEZlYXR1cmVzLHJlc3RhcnQscmVzdWx0LHJvdGF0ZSxyeCxyeSxzY2FsZSxzZWVkLHNoYXBlLXJlbmRlcmluZyxzbG9wZSxzcGFjaW5nLHNwZWN1bGFyQ29uc3RhbnQsc3BlY3VsYXJFeHBvbmVudCxzcGVlZCxzcHJlYWRNZXRob2Qsc3RhcnRPZmZzZXQsc3RkRGV2aWF0aW9uLHN0ZW1oLHN0ZW12LHN0aXRjaFRpbGVzLHN0b3AtY29sb3Isc3RvcC1vcGFjaXR5LHN0cmlrZXRocm91Z2gtcG9zaXRpb24sc3RyaWtldGhyb3VnaC10aGlja25lc3Msc3RyaW5nLHN0cm9rZSxzdHJva2UtZGFzaGFycmF5LHN0cm9rZS1kYXNob2Zmc2V0LHN0cm9rZS1saW5lY2FwLHN0cm9rZS1saW5lam9pbixzdHJva2UtbWl0ZXJsaW1pdCxzdHJva2Utb3BhY2l0eSxzdHJva2Utd2lkdGgsc3R5bGUsc3VyZmFjZVNjYWxlLHN5c3RlbUxhbmd1YWdlLHRhYmluZGV4LHRhYmxlVmFsdWVzLHRhcmdldCx0YXJnZXRYLHRhcmdldFksdGV4dC1hbmNob3IsdGV4dC1kZWNvcmF0aW9uLHRleHQtcmVuZGVyaW5nLHRleHRMZW5ndGgsdG8sdHJhbnNmb3JtLHRyYW5zZm9ybS1vcmlnaW4sdHlwZSx1MSx1Mix1bmRlcmxpbmUtcG9zaXRpb24sdW5kZXJsaW5lLXRoaWNrbmVzcyx1bmljb2RlLHVuaWNvZGUtYmlkaSx1bmljb2RlLXJhbmdlLHVuaXRzLXBlci1lbSx2LWFscGhhYmV0aWMsdi1oYW5naW5nLHYtaWRlb2dyYXBoaWMsdi1tYXRoZW1hdGljYWwsdmFsdWVzLHZlY3Rvci1lZmZlY3QsdmVyc2lvbix2ZXJ0LWFkdi15LHZlcnQtb3JpZ2luLXgsdmVydC1vcmlnaW4teSx2aWV3Qm94LHZpZXdUYXJnZXQsdmlzaWJpbGl0eSx3aWR0aCx3aWR0aHMsd29yZC1zcGFjaW5nLHdyaXRpbmctbW9kZSx4LHgtaGVpZ2h0LHgxLHgyLHhDaGFubmVsU2VsZWN0b3IseGxpbms6YWN0dWF0ZSx4bGluazphcmNyb2xlLHhsaW5rOmhyZWYseGxpbms6cm9sZSx4bGluazpzaG93LHhsaW5rOnRpdGxlLHhsaW5rOnR5cGUseG1sbnM6eGxpbmsseG1sOmJhc2UseG1sOmxhbmcseG1sOnNwYWNlLHkseTEseTIseUNoYW5uZWxTZWxlY3Rvcix6LHpvb21BbmRQYW5gCiAgKTsKICBmdW5jdGlvbiBpc1JlbmRlcmFibGVBdHRyVmFsdWUodmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICByZXR1cm4gdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gIm51bWJlciIgfHwgdHlwZSA9PT0gImJvb2xlYW4iOwogIH0KCiAgZnVuY3Rpb24gbG9vc2VDb21wYXJlQXJyYXlzKGEsIGIpIHsKICAgIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpCiAgICAgIHJldHVybiBmYWxzZTsKICAgIGxldCBlcXVhbCA9IHRydWU7CiAgICBmb3IgKGxldCBpID0gMDsgZXF1YWwgJiYgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgZXF1YWwgPSBsb29zZUVxdWFsKGFbaV0sIGJbaV0pOwogICAgfQogICAgcmV0dXJuIGVxdWFsOwogIH0KICBmdW5jdGlvbiBsb29zZUVxdWFsKGEsIGIpIHsKICAgIGlmIChhID09PSBiKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIGxldCBhVmFsaWRUeXBlID0gaXNEYXRlKGEpOwogICAgbGV0IGJWYWxpZFR5cGUgPSBpc0RhdGUoYik7CiAgICBpZiAoYVZhbGlkVHlwZSB8fCBiVmFsaWRUeXBlKSB7CiAgICAgIHJldHVybiBhVmFsaWRUeXBlICYmIGJWYWxpZFR5cGUgPyBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCkgOiBmYWxzZTsKICAgIH0KICAgIGFWYWxpZFR5cGUgPSBpc1N5bWJvbChhKTsKICAgIGJWYWxpZFR5cGUgPSBpc1N5bWJvbChiKTsKICAgIGlmIChhVmFsaWRUeXBlIHx8IGJWYWxpZFR5cGUpIHsKICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICB9CiAgICBhVmFsaWRUeXBlID0gaXNBcnJheShhKTsKICAgIGJWYWxpZFR5cGUgPSBpc0FycmF5KGIpOwogICAgaWYgKGFWYWxpZFR5cGUgfHwgYlZhbGlkVHlwZSkgewogICAgICByZXR1cm4gYVZhbGlkVHlwZSAmJiBiVmFsaWRUeXBlID8gbG9vc2VDb21wYXJlQXJyYXlzKGEsIGIpIDogZmFsc2U7CiAgICB9CiAgICBhVmFsaWRUeXBlID0gaXNPYmplY3QoYSk7CiAgICBiVmFsaWRUeXBlID0gaXNPYmplY3QoYik7CiAgICBpZiAoYVZhbGlkVHlwZSB8fCBiVmFsaWRUeXBlKSB7CiAgICAgIGlmICghYVZhbGlkVHlwZSB8fCAhYlZhbGlkVHlwZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBjb25zdCBhS2V5c0NvdW50ID0gT2JqZWN0LmtleXMoYSkubGVuZ3RoOwogICAgICBjb25zdCBiS2V5c0NvdW50ID0gT2JqZWN0LmtleXMoYikubGVuZ3RoOwogICAgICBpZiAoYUtleXNDb3VudCAhPT0gYktleXNDb3VudCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IGtleSBpbiBhKSB7CiAgICAgICAgY29uc3QgYUhhc0tleSA9IGEuaGFzT3duUHJvcGVydHkoa2V5KTsKICAgICAgICBjb25zdCBiSGFzS2V5ID0gYi5oYXNPd25Qcm9wZXJ0eShrZXkpOwogICAgICAgIGlmIChhSGFzS2V5ICYmICFiSGFzS2V5IHx8ICFhSGFzS2V5ICYmIGJIYXNLZXkgfHwgIWxvb3NlRXF1YWwoYVtrZXldLCBiW2tleV0pKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gU3RyaW5nKGEpID09PSBTdHJpbmcoYik7CiAgfQogIGZ1bmN0aW9uIGxvb3NlSW5kZXhPZihhcnIsIHZhbCkgewogICAgcmV0dXJuIGFyci5maW5kSW5kZXgoKGl0ZW0pID0+IGxvb3NlRXF1YWwoaXRlbSwgdmFsKSk7CiAgfQoKICBjb25zdCB0b0Rpc3BsYXlTdHJpbmcgPSAodmFsKSA9PiB7CiAgICByZXR1cm4gaXNTdHJpbmcodmFsKSA/IHZhbCA6IHZhbCA9PSBudWxsID8gIiIgOiBpc0FycmF5KHZhbCkgfHwgaXNPYmplY3QodmFsKSAmJiAodmFsLnRvU3RyaW5nID09PSBvYmplY3RUb1N0cmluZyB8fCAhaXNGdW5jdGlvbih2YWwudG9TdHJpbmcpKSA/IEpTT04uc3RyaW5naWZ5KHZhbCwgcmVwbGFjZXIsIDIpIDogU3RyaW5nKHZhbCk7CiAgfTsKICBjb25zdCByZXBsYWNlciA9IChfa2V5LCB2YWwpID0+IHsKICAgIGlmICh2YWwgJiYgdmFsLl9fdl9pc1JlZikgewogICAgICByZXR1cm4gcmVwbGFjZXIoX2tleSwgdmFsLnZhbHVlKTsKICAgIH0gZWxzZSBpZiAoaXNNYXAodmFsKSkgewogICAgICByZXR1cm4gewogICAgICAgIFtgTWFwKCR7dmFsLnNpemV9KWBdOiBbLi4udmFsLmVudHJpZXMoKV0ucmVkdWNlKAogICAgICAgICAgKGVudHJpZXMsIFtrZXksIHZhbDJdLCBpKSA9PiB7CiAgICAgICAgICAgIGVudHJpZXNbc3RyaW5naWZ5U3ltYm9sKGtleSwgaSkgKyAiID0+Il0gPSB2YWwyOwogICAgICAgICAgICByZXR1cm4gZW50cmllczsKICAgICAgICAgIH0sCiAgICAgICAgICB7fQogICAgICAgICkKICAgICAgfTsKICAgIH0gZWxzZSBpZiAoaXNTZXQodmFsKSkgewogICAgICByZXR1cm4gewogICAgICAgIFtgU2V0KCR7dmFsLnNpemV9KWBdOiBbLi4udmFsLnZhbHVlcygpXS5tYXAoKHYpID0+IHN0cmluZ2lmeVN5bWJvbCh2KSkKICAgICAgfTsKICAgIH0gZWxzZSBpZiAoaXNTeW1ib2wodmFsKSkgewogICAgICByZXR1cm4gc3RyaW5naWZ5U3ltYm9sKHZhbCk7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbCkgJiYgIWlzQXJyYXkodmFsKSAmJiAhaXNQbGFpbk9iamVjdCh2YWwpKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsKTsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfTsKICBjb25zdCBzdHJpbmdpZnlTeW1ib2wgPSAodiwgaSA9ICIiKSA9PiB7CiAgICB2YXIgX2E7CiAgICByZXR1cm4gaXNTeW1ib2wodikgPyBgU3ltYm9sKCR7KF9hID0gdi5kZXNjcmlwdGlvbikgIT0gbnVsbCA/IF9hIDogaX0pYCA6IHY7CiAgfTsKCiAgZnVuY3Rpb24gd2FybiQyKG1zZywgLi4uYXJncykgewogICAgY29uc29sZS53YXJuKGBbVnVlIHdhcm5dICR7bXNnfWAsIC4uLmFyZ3MpOwogIH0KCiAgbGV0IGFjdGl2ZUVmZmVjdFNjb3BlOwogIGNsYXNzIEVmZmVjdFNjb3BlIHsKICAgIGNvbnN0cnVjdG9yKGRldGFjaGVkID0gZmFsc2UpIHsKICAgICAgdGhpcy5kZXRhY2hlZCA9IGRldGFjaGVkOwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLl9hY3RpdmUgPSB0cnVlOwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLmVmZmVjdHMgPSBbXTsKICAgICAgLyoqCiAgICAgICAqIEBpbnRlcm5hbAogICAgICAgKi8KICAgICAgdGhpcy5jbGVhbnVwcyA9IFtdOwogICAgICB0aGlzLnBhcmVudCA9IGFjdGl2ZUVmZmVjdFNjb3BlOwogICAgICBpZiAoIWRldGFjaGVkICYmIGFjdGl2ZUVmZmVjdFNjb3BlKSB7CiAgICAgICAgdGhpcy5pbmRleCA9IChhY3RpdmVFZmZlY3RTY29wZS5zY29wZXMgfHwgKGFjdGl2ZUVmZmVjdFNjb3BlLnNjb3BlcyA9IFtdKSkucHVzaCgKICAgICAgICAgIHRoaXMKICAgICAgICApIC0gMTsKICAgICAgfQogICAgfQogICAgZ2V0IGFjdGl2ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2FjdGl2ZTsKICAgIH0KICAgIHJ1bihmbikgewogICAgICBpZiAodGhpcy5fYWN0aXZlKSB7CiAgICAgICAgY29uc3QgY3VycmVudEVmZmVjdFNjb3BlID0gYWN0aXZlRWZmZWN0U2NvcGU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gdGhpczsKICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBhY3RpdmVFZmZlY3RTY29wZSA9IGN1cnJlbnRFZmZlY3RTY29wZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybiQyKGBjYW5ub3QgcnVuIGFuIGluYWN0aXZlIGVmZmVjdCBzY29wZS5gKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBub24tZGV0YWNoZWQgc2NvcGVzCiAgICAgKiBAaW50ZXJuYWwKICAgICAqLwogICAgb24oKSB7CiAgICAgIGFjdGl2ZUVmZmVjdFNjb3BlID0gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gbm9uLWRldGFjaGVkIHNjb3BlcwogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIG9mZigpIHsKICAgICAgYWN0aXZlRWZmZWN0U2NvcGUgPSB0aGlzLnBhcmVudDsKICAgIH0KICAgIHN0b3AoZnJvbVBhcmVudCkgewogICAgICBpZiAodGhpcy5fYWN0aXZlKSB7CiAgICAgICAgbGV0IGksIGw7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMuZWZmZWN0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMuZWZmZWN0c1tpXS5zdG9wKCk7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmNsZWFudXBzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy5jbGVhbnVwc1tpXSgpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5zY29wZXMpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLnNjb3Blcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5zY29wZXNbaV0uc3RvcCh0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLmRldGFjaGVkICYmIHRoaXMucGFyZW50ICYmICFmcm9tUGFyZW50KSB7CiAgICAgICAgICBjb25zdCBsYXN0ID0gdGhpcy5wYXJlbnQuc2NvcGVzLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QgJiYgbGFzdCAhPT0gdGhpcykgewogICAgICAgICAgICB0aGlzLnBhcmVudC5zY29wZXNbdGhpcy5pbmRleF0gPSBsYXN0OwogICAgICAgICAgICBsYXN0LmluZGV4ID0gdGhpcy5pbmRleDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5wYXJlbnQgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fYWN0aXZlID0gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZWZmZWN0U2NvcGUoZGV0YWNoZWQpIHsKICAgIHJldHVybiBuZXcgRWZmZWN0U2NvcGUoZGV0YWNoZWQpOwogIH0KICBmdW5jdGlvbiByZWNvcmRFZmZlY3RTY29wZShlZmZlY3QsIHNjb3BlID0gYWN0aXZlRWZmZWN0U2NvcGUpIHsKICAgIGlmIChzY29wZSAmJiBzY29wZS5hY3RpdmUpIHsKICAgICAgc2NvcGUuZWZmZWN0cy5wdXNoKGVmZmVjdCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEN1cnJlbnRTY29wZSgpIHsKICAgIHJldHVybiBhY3RpdmVFZmZlY3RTY29wZTsKICB9CiAgZnVuY3Rpb24gb25TY29wZURpc3Bvc2UoZm4pIHsKICAgIGlmIChhY3RpdmVFZmZlY3RTY29wZSkgewogICAgICBhY3RpdmVFZmZlY3RTY29wZS5jbGVhbnVwcy5wdXNoKGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIHdhcm4kMigKICAgICAgICBgb25TY29wZURpc3Bvc2UoKSBpcyBjYWxsZWQgd2hlbiB0aGVyZSBpcyBubyBhY3RpdmUgZWZmZWN0IHNjb3BlIHRvIGJlIGFzc29jaWF0ZWQgd2l0aC5gCiAgICAgICk7CiAgICB9CiAgfQoKICBsZXQgYWN0aXZlRWZmZWN0OwogIGNsYXNzIFJlYWN0aXZlRWZmZWN0IHsKICAgIGNvbnN0cnVjdG9yKGZuLCB0cmlnZ2VyLCBzY2hlZHVsZXIsIHNjb3BlKSB7CiAgICAgIHRoaXMuZm4gPSBmbjsKICAgICAgdGhpcy50cmlnZ2VyID0gdHJpZ2dlcjsKICAgICAgdGhpcy5zY2hlZHVsZXIgPSBzY2hlZHVsZXI7CiAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgdGhpcy5kZXBzID0gW107CiAgICAgIC8qKgogICAgICAgKiBAaW50ZXJuYWwKICAgICAgICovCiAgICAgIHRoaXMuX2RpcnR5TGV2ZWwgPSA0OwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLl90cmFja0lkID0gMDsKICAgICAgLyoqCiAgICAgICAqIEBpbnRlcm5hbAogICAgICAgKi8KICAgICAgdGhpcy5fcnVubmluZ3MgPSAwOwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLl9zaG91bGRTY2hlZHVsZSA9IGZhbHNlOwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLl9kZXBzTGVuZ3RoID0gMDsKICAgICAgcmVjb3JkRWZmZWN0U2NvcGUodGhpcywgc2NvcGUpOwogICAgfQogICAgZ2V0IGRpcnR5KCkgewogICAgICBpZiAodGhpcy5fZGlydHlMZXZlbCA9PT0gMiB8fCB0aGlzLl9kaXJ0eUxldmVsID09PSAzKSB7CiAgICAgICAgdGhpcy5fZGlydHlMZXZlbCA9IDE7CiAgICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fZGVwc0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBkZXAgPSB0aGlzLmRlcHNbaV07CiAgICAgICAgICBpZiAoZGVwLmNvbXB1dGVkKSB7CiAgICAgICAgICAgIHRyaWdnZXJDb21wdXRlZChkZXAuY29tcHV0ZWQpOwogICAgICAgICAgICBpZiAodGhpcy5fZGlydHlMZXZlbCA+PSA0KSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2RpcnR5TGV2ZWwgPT09IDEpIHsKICAgICAgICAgIHRoaXMuX2RpcnR5TGV2ZWwgPSAwOwogICAgICAgIH0KICAgICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2RpcnR5TGV2ZWwgPj0gNDsKICAgIH0KICAgIHNldCBkaXJ0eSh2KSB7CiAgICAgIHRoaXMuX2RpcnR5TGV2ZWwgPSB2ID8gNCA6IDA7CiAgICB9CiAgICBydW4oKSB7CiAgICAgIHRoaXMuX2RpcnR5TGV2ZWwgPSAwOwogICAgICBpZiAoIXRoaXMuYWN0aXZlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZm4oKTsKICAgICAgfQogICAgICBsZXQgbGFzdFNob3VsZFRyYWNrID0gc2hvdWxkVHJhY2s7CiAgICAgIGxldCBsYXN0RWZmZWN0ID0gYWN0aXZlRWZmZWN0OwogICAgICB0cnkgewogICAgICAgIHNob3VsZFRyYWNrID0gdHJ1ZTsKICAgICAgICBhY3RpdmVFZmZlY3QgPSB0aGlzOwogICAgICAgIHRoaXMuX3J1bm5pbmdzKys7CiAgICAgICAgcHJlQ2xlYW51cEVmZmVjdCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5mbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHBvc3RDbGVhbnVwRWZmZWN0KHRoaXMpOwogICAgICAgIHRoaXMuX3J1bm5pbmdzLS07CiAgICAgICAgYWN0aXZlRWZmZWN0ID0gbGFzdEVmZmVjdDsKICAgICAgICBzaG91bGRUcmFjayA9IGxhc3RTaG91bGRUcmFjazsKICAgICAgfQogICAgfQogICAgc3RvcCgpIHsKICAgICAgdmFyIF9hOwogICAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgICBwcmVDbGVhbnVwRWZmZWN0KHRoaXMpOwogICAgICAgIHBvc3RDbGVhbnVwRWZmZWN0KHRoaXMpOwogICAgICAgIChfYSA9IHRoaXMub25TdG9wKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyaWdnZXJDb21wdXRlZChjb21wdXRlZCkgewogICAgcmV0dXJuIGNvbXB1dGVkLnZhbHVlOwogIH0KICBmdW5jdGlvbiBwcmVDbGVhbnVwRWZmZWN0KGVmZmVjdDIpIHsKICAgIGVmZmVjdDIuX3RyYWNrSWQrKzsKICAgIGVmZmVjdDIuX2RlcHNMZW5ndGggPSAwOwogIH0KICBmdW5jdGlvbiBwb3N0Q2xlYW51cEVmZmVjdChlZmZlY3QyKSB7CiAgICBpZiAoZWZmZWN0Mi5kZXBzLmxlbmd0aCA+IGVmZmVjdDIuX2RlcHNMZW5ndGgpIHsKICAgICAgZm9yIChsZXQgaSA9IGVmZmVjdDIuX2RlcHNMZW5ndGg7IGkgPCBlZmZlY3QyLmRlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjbGVhbnVwRGVwRWZmZWN0KGVmZmVjdDIuZGVwc1tpXSwgZWZmZWN0Mik7CiAgICAgIH0KICAgICAgZWZmZWN0Mi5kZXBzLmxlbmd0aCA9IGVmZmVjdDIuX2RlcHNMZW5ndGg7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNsZWFudXBEZXBFZmZlY3QoZGVwLCBlZmZlY3QyKSB7CiAgICBjb25zdCB0cmFja0lkID0gZGVwLmdldChlZmZlY3QyKTsKICAgIGlmICh0cmFja0lkICE9PSB2b2lkIDAgJiYgZWZmZWN0Mi5fdHJhY2tJZCAhPT0gdHJhY2tJZCkgewogICAgICBkZXAuZGVsZXRlKGVmZmVjdDIpOwogICAgICBpZiAoZGVwLnNpemUgPT09IDApIHsKICAgICAgICBkZXAuY2xlYW51cCgpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVmZmVjdChmbiwgb3B0aW9ucykgewogICAgaWYgKGZuLmVmZmVjdCBpbnN0YW5jZW9mIFJlYWN0aXZlRWZmZWN0KSB7CiAgICAgIGZuID0gZm4uZWZmZWN0LmZuOwogICAgfQogICAgY29uc3QgX2VmZmVjdCA9IG5ldyBSZWFjdGl2ZUVmZmVjdChmbiwgTk9PUCwgKCkgPT4gewogICAgICBpZiAoX2VmZmVjdC5kaXJ0eSkgewogICAgICAgIF9lZmZlY3QucnVuKCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKG9wdGlvbnMpIHsKICAgICAgZXh0ZW5kKF9lZmZlY3QsIG9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5zY29wZSkKICAgICAgICByZWNvcmRFZmZlY3RTY29wZShfZWZmZWN0LCBvcHRpb25zLnNjb3BlKTsKICAgIH0KICAgIGlmICghb3B0aW9ucyB8fCAhb3B0aW9ucy5sYXp5KSB7CiAgICAgIF9lZmZlY3QucnVuKCk7CiAgICB9CiAgICBjb25zdCBydW5uZXIgPSBfZWZmZWN0LnJ1bi5iaW5kKF9lZmZlY3QpOwogICAgcnVubmVyLmVmZmVjdCA9IF9lZmZlY3Q7CiAgICByZXR1cm4gcnVubmVyOwogIH0KICBmdW5jdGlvbiBzdG9wKHJ1bm5lcikgewogICAgcnVubmVyLmVmZmVjdC5zdG9wKCk7CiAgfQogIGxldCBzaG91bGRUcmFjayA9IHRydWU7CiAgbGV0IHBhdXNlU2NoZWR1bGVTdGFjayA9IDA7CiAgY29uc3QgdHJhY2tTdGFjayA9IFtdOwogIGZ1bmN0aW9uIHBhdXNlVHJhY2tpbmcoKSB7CiAgICB0cmFja1N0YWNrLnB1c2goc2hvdWxkVHJhY2spOwogICAgc2hvdWxkVHJhY2sgPSBmYWxzZTsKICB9CiAgZnVuY3Rpb24gcmVzZXRUcmFja2luZygpIHsKICAgIGNvbnN0IGxhc3QgPSB0cmFja1N0YWNrLnBvcCgpOwogICAgc2hvdWxkVHJhY2sgPSBsYXN0ID09PSB2b2lkIDAgPyB0cnVlIDogbGFzdDsKICB9CiAgZnVuY3Rpb24gcGF1c2VTY2hlZHVsaW5nKCkgewogICAgcGF1c2VTY2hlZHVsZVN0YWNrKys7CiAgfQogIGZ1bmN0aW9uIHJlc2V0U2NoZWR1bGluZygpIHsKICAgIHBhdXNlU2NoZWR1bGVTdGFjay0tOwogICAgd2hpbGUgKCFwYXVzZVNjaGVkdWxlU3RhY2sgJiYgcXVldWVFZmZlY3RTY2hlZHVsZXJzLmxlbmd0aCkgewogICAgICBxdWV1ZUVmZmVjdFNjaGVkdWxlcnMuc2hpZnQoKSgpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cmFja0VmZmVjdChlZmZlY3QyLCBkZXAsIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pIHsKICAgIHZhciBfYTsKICAgIGlmIChkZXAuZ2V0KGVmZmVjdDIpICE9PSBlZmZlY3QyLl90cmFja0lkKSB7CiAgICAgIGRlcC5zZXQoZWZmZWN0MiwgZWZmZWN0Mi5fdHJhY2tJZCk7CiAgICAgIGNvbnN0IG9sZERlcCA9IGVmZmVjdDIuZGVwc1tlZmZlY3QyLl9kZXBzTGVuZ3RoXTsKICAgICAgaWYgKG9sZERlcCAhPT0gZGVwKSB7CiAgICAgICAgaWYgKG9sZERlcCkgewogICAgICAgICAgY2xlYW51cERlcEVmZmVjdChvbGREZXAsIGVmZmVjdDIpOwogICAgICAgIH0KICAgICAgICBlZmZlY3QyLmRlcHNbZWZmZWN0Mi5fZGVwc0xlbmd0aCsrXSA9IGRlcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBlZmZlY3QyLl9kZXBzTGVuZ3RoKys7CiAgICAgIH0KICAgICAgewogICAgICAgIChfYSA9IGVmZmVjdDIub25UcmFjaykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNhbGwoZWZmZWN0MiwgZXh0ZW5kKHsgZWZmZWN0OiBlZmZlY3QyIH0sIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pKTsKICAgICAgfQogICAgfQogIH0KICBjb25zdCBxdWV1ZUVmZmVjdFNjaGVkdWxlcnMgPSBbXTsKICBmdW5jdGlvbiB0cmlnZ2VyRWZmZWN0cyhkZXAsIGRpcnR5TGV2ZWwsIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pIHsKICAgIHZhciBfYTsKICAgIHBhdXNlU2NoZWR1bGluZygpOwogICAgZm9yIChjb25zdCBlZmZlY3QyIG9mIGRlcC5rZXlzKCkpIHsKICAgICAgbGV0IHRyYWNraW5nOwogICAgICBpZiAoZWZmZWN0Mi5fZGlydHlMZXZlbCA8IGRpcnR5TGV2ZWwgJiYgKHRyYWNraW5nICE9IG51bGwgPyB0cmFja2luZyA6IHRyYWNraW5nID0gZGVwLmdldChlZmZlY3QyKSA9PT0gZWZmZWN0Mi5fdHJhY2tJZCkpIHsKICAgICAgICBlZmZlY3QyLl9zaG91bGRTY2hlZHVsZSB8fCAoZWZmZWN0Mi5fc2hvdWxkU2NoZWR1bGUgPSBlZmZlY3QyLl9kaXJ0eUxldmVsID09PSAwKTsKICAgICAgICBlZmZlY3QyLl9kaXJ0eUxldmVsID0gZGlydHlMZXZlbDsKICAgICAgfQogICAgICBpZiAoZWZmZWN0Mi5fc2hvdWxkU2NoZWR1bGUgJiYgKHRyYWNraW5nICE9IG51bGwgPyB0cmFja2luZyA6IHRyYWNraW5nID0gZGVwLmdldChlZmZlY3QyKSA9PT0gZWZmZWN0Mi5fdHJhY2tJZCkpIHsKICAgICAgICB7CiAgICAgICAgICAoX2EgPSBlZmZlY3QyLm9uVHJpZ2dlcikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNhbGwoZWZmZWN0MiwgZXh0ZW5kKHsgZWZmZWN0OiBlZmZlY3QyIH0sIGRlYnVnZ2VyRXZlbnRFeHRyYUluZm8pKTsKICAgICAgICB9CiAgICAgICAgZWZmZWN0Mi50cmlnZ2VyKCk7CiAgICAgICAgaWYgKCghZWZmZWN0Mi5fcnVubmluZ3MgfHwgZWZmZWN0Mi5hbGxvd1JlY3Vyc2UpICYmIGVmZmVjdDIuX2RpcnR5TGV2ZWwgIT09IDIpIHsKICAgICAgICAgIGVmZmVjdDIuX3Nob3VsZFNjaGVkdWxlID0gZmFsc2U7CiAgICAgICAgICBpZiAoZWZmZWN0Mi5zY2hlZHVsZXIpIHsKICAgICAgICAgICAgcXVldWVFZmZlY3RTY2hlZHVsZXJzLnB1c2goZWZmZWN0Mi5zY2hlZHVsZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmVzZXRTY2hlZHVsaW5nKCk7CiAgfQoKICBjb25zdCBjcmVhdGVEZXAgPSAoY2xlYW51cCwgY29tcHV0ZWQpID0+IHsKICAgIGNvbnN0IGRlcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBkZXAuY2xlYW51cCA9IGNsZWFudXA7CiAgICBkZXAuY29tcHV0ZWQgPSBjb21wdXRlZDsKICAgIHJldHVybiBkZXA7CiAgfTsKCiAgY29uc3QgdGFyZ2V0TWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgY29uc3QgSVRFUkFURV9LRVkgPSBTeW1ib2woIml0ZXJhdGUiICk7CiAgY29uc3QgTUFQX0tFWV9JVEVSQVRFX0tFWSA9IFN5bWJvbCgiTWFwIGtleSBpdGVyYXRlIiApOwogIGZ1bmN0aW9uIHRyYWNrKHRhcmdldCwgdHlwZSwga2V5KSB7CiAgICBpZiAoc2hvdWxkVHJhY2sgJiYgYWN0aXZlRWZmZWN0KSB7CiAgICAgIGxldCBkZXBzTWFwID0gdGFyZ2V0TWFwLmdldCh0YXJnZXQpOwogICAgICBpZiAoIWRlcHNNYXApIHsKICAgICAgICB0YXJnZXRNYXAuc2V0KHRhcmdldCwgZGVwc01hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgICB9CiAgICAgIGxldCBkZXAgPSBkZXBzTWFwLmdldChrZXkpOwogICAgICBpZiAoIWRlcCkgewogICAgICAgIGRlcHNNYXAuc2V0KGtleSwgZGVwID0gY3JlYXRlRGVwKCgpID0+IGRlcHNNYXAuZGVsZXRlKGtleSkpKTsKICAgICAgfQogICAgICB0cmFja0VmZmVjdCgKICAgICAgICBhY3RpdmVFZmZlY3QsCiAgICAgICAgZGVwLAogICAgICAgIHsKICAgICAgICAgIHRhcmdldCwKICAgICAgICAgIHR5cGUsCiAgICAgICAgICBrZXkKICAgICAgICB9IAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiB0cmlnZ2VyKHRhcmdldCwgdHlwZSwga2V5LCBuZXdWYWx1ZSwgb2xkVmFsdWUsIG9sZFRhcmdldCkgewogICAgY29uc3QgZGVwc01hcCA9IHRhcmdldE1hcC5nZXQodGFyZ2V0KTsKICAgIGlmICghZGVwc01hcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgZGVwcyA9IFtdOwogICAgaWYgKHR5cGUgPT09ICJjbGVhciIpIHsKICAgICAgZGVwcyA9IFsuLi5kZXBzTWFwLnZhbHVlcygpXTsKICAgIH0gZWxzZSBpZiAoa2V5ID09PSAibGVuZ3RoIiAmJiBpc0FycmF5KHRhcmdldCkpIHsKICAgICAgY29uc3QgbmV3TGVuZ3RoID0gTnVtYmVyKG5ld1ZhbHVlKTsKICAgICAgZGVwc01hcC5mb3JFYWNoKChkZXAsIGtleTIpID0+IHsKICAgICAgICBpZiAoa2V5MiA9PT0gImxlbmd0aCIgfHwgIWlzU3ltYm9sKGtleTIpICYmIGtleTIgPj0gbmV3TGVuZ3RoKSB7CiAgICAgICAgICBkZXBzLnB1c2goZGVwKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGtleSAhPT0gdm9pZCAwKSB7CiAgICAgICAgZGVwcy5wdXNoKGRlcHNNYXAuZ2V0KGtleSkpOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgIGNhc2UgImFkZCI6CiAgICAgICAgICBpZiAoIWlzQXJyYXkodGFyZ2V0KSkgewogICAgICAgICAgICBkZXBzLnB1c2goZGVwc01hcC5nZXQoSVRFUkFURV9LRVkpKTsKICAgICAgICAgICAgaWYgKGlzTWFwKHRhcmdldCkpIHsKICAgICAgICAgICAgICBkZXBzLnB1c2goZGVwc01hcC5nZXQoTUFQX0tFWV9JVEVSQVRFX0tFWSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzSW50ZWdlcktleShrZXkpKSB7CiAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldCgibGVuZ3RoIikpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiZGVsZXRlIjoKICAgICAgICAgIGlmICghaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldChJVEVSQVRFX0tFWSkpOwogICAgICAgICAgICBpZiAoaXNNYXAodGFyZ2V0KSkgewogICAgICAgICAgICAgIGRlcHMucHVzaChkZXBzTWFwLmdldChNQVBfS0VZX0lURVJBVEVfS0VZKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInNldCI6CiAgICAgICAgICBpZiAoaXNNYXAodGFyZ2V0KSkgewogICAgICAgICAgICBkZXBzLnB1c2goZGVwc01hcC5nZXQoSVRFUkFURV9LRVkpKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBwYXVzZVNjaGVkdWxpbmcoKTsKICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcHMpIHsKICAgICAgaWYgKGRlcCkgewogICAgICAgIHRyaWdnZXJFZmZlY3RzKAogICAgICAgICAgZGVwLAogICAgICAgICAgNCwKICAgICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIG5ld1ZhbHVlLAogICAgICAgICAgICBvbGRWYWx1ZSwKICAgICAgICAgICAgb2xkVGFyZ2V0CiAgICAgICAgICB9IAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHJlc2V0U2NoZWR1bGluZygpOwogIH0KICBmdW5jdGlvbiBnZXREZXBGcm9tUmVhY3RpdmUob2JqZWN0LCBrZXkpIHsKICAgIHZhciBfYTsKICAgIHJldHVybiAoX2EgPSB0YXJnZXRNYXAuZ2V0KG9iamVjdCkpID09IG51bGwgPyB2b2lkIDAgOiBfYS5nZXQoa2V5KTsKICB9CgogIGNvbnN0IGlzTm9uVHJhY2thYmxlS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBtYWtlTWFwKGBfX3Byb3RvX18sX192X2lzUmVmLF9faXNWdWVgKTsKICBjb25zdCBidWlsdEluU3ltYm9scyA9IG5ldyBTZXQoCiAgICAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoU3ltYm9sKS5maWx0ZXIoKGtleSkgPT4ga2V5ICE9PSAiYXJndW1lbnRzIiAmJiBrZXkgIT09ICJjYWxsZXIiKS5tYXAoKGtleSkgPT4gU3ltYm9sW2tleV0pLmZpbHRlcihpc1N5bWJvbCkKICApOwogIGNvbnN0IGFycmF5SW5zdHJ1bWVudGF0aW9ucyA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBcnJheUluc3RydW1lbnRhdGlvbnMoKTsKICBmdW5jdGlvbiBjcmVhdGVBcnJheUluc3RydW1lbnRhdGlvbnMoKSB7CiAgICBjb25zdCBpbnN0cnVtZW50YXRpb25zID0ge307CiAgICBbImluY2x1ZGVzIiwgImluZGV4T2YiLCAibGFzdEluZGV4T2YiXS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgaW5zdHJ1bWVudGF0aW9uc1trZXldID0gZnVuY3Rpb24oLi4uYXJncykgewogICAgICAgIGNvbnN0IGFyciA9IHRvUmF3KHRoaXMpOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRyYWNrKGFyciwgImdldCIsIGkgKyAiIik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlcyA9IGFycltrZXldKC4uLmFyZ3MpOwogICAgICAgIGlmIChyZXMgPT09IC0xIHx8IHJlcyA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBhcnJba2V5XSguLi5hcmdzLm1hcCh0b1JhdykpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogICAgWyJwdXNoIiwgInBvcCIsICJzaGlmdCIsICJ1bnNoaWZ0IiwgInNwbGljZSJdLmZvckVhY2goKGtleSkgPT4gewogICAgICBpbnN0cnVtZW50YXRpb25zW2tleV0gPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICAgIHBhdXNlU2NoZWR1bGluZygpOwogICAgICAgIGNvbnN0IHJlcyA9IHRvUmF3KHRoaXMpW2tleV0uYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgcmVzZXRTY2hlZHVsaW5nKCk7CiAgICAgICAgcmVzZXRUcmFja2luZygpOwogICAgICAgIHJldHVybiByZXM7CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiBpbnN0cnVtZW50YXRpb25zOwogIH0KICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShrZXkpIHsKICAgIGNvbnN0IG9iaiA9IHRvUmF3KHRoaXMpOwogICAgdHJhY2sob2JqLCAiaGFzIiwga2V5KTsKICAgIHJldHVybiBvYmouaGFzT3duUHJvcGVydHkoa2V5KTsKICB9CiAgY2xhc3MgQmFzZVJlYWN0aXZlSGFuZGxlciB7CiAgICBjb25zdHJ1Y3RvcihfaXNSZWFkb25seSA9IGZhbHNlLCBfaXNTaGFsbG93ID0gZmFsc2UpIHsKICAgICAgdGhpcy5faXNSZWFkb25seSA9IF9pc1JlYWRvbmx5OwogICAgICB0aGlzLl9pc1NoYWxsb3cgPSBfaXNTaGFsbG93OwogICAgfQogICAgZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcikgewogICAgICBjb25zdCBpc1JlYWRvbmx5MiA9IHRoaXMuX2lzUmVhZG9ubHksIGlzU2hhbGxvdzIgPSB0aGlzLl9pc1NoYWxsb3c7CiAgICAgIGlmIChrZXkgPT09ICJfX3ZfaXNSZWFjdGl2ZSIpIHsKICAgICAgICByZXR1cm4gIWlzUmVhZG9ubHkyOwogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9pc1JlYWRvbmx5IikgewogICAgICAgIHJldHVybiBpc1JlYWRvbmx5MjsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJfX3ZfaXNTaGFsbG93IikgewogICAgICAgIHJldHVybiBpc1NoYWxsb3cyOwogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gIl9fdl9yYXciKSB7CiAgICAgICAgaWYgKHJlY2VpdmVyID09PSAoaXNSZWFkb25seTIgPyBpc1NoYWxsb3cyID8gc2hhbGxvd1JlYWRvbmx5TWFwIDogcmVhZG9ubHlNYXAgOiBpc1NoYWxsb3cyID8gc2hhbGxvd1JlYWN0aXZlTWFwIDogcmVhY3RpdmVNYXApLmdldCh0YXJnZXQpIHx8IC8vIHJlY2VpdmVyIGlzIG5vdCB0aGUgcmVhY3RpdmUgcHJveHksIGJ1dCBoYXMgdGhlIHNhbWUgcHJvdG90eXBlCiAgICAgICAgLy8gdGhpcyBtZWFucyB0aGUgcmVjaWV2ZXIgaXMgYSB1c2VyIHByb3h5IG9mIHRoZSByZWFjdGl2ZSBwcm94eQogICAgICAgIE9iamVjdC5nZXRQcm90b3R5cGVPZih0YXJnZXQpID09PSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocmVjZWl2ZXIpKSB7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgdGFyZ2V0SXNBcnJheSA9IGlzQXJyYXkodGFyZ2V0KTsKICAgICAgaWYgKCFpc1JlYWRvbmx5MikgewogICAgICAgIGlmICh0YXJnZXRJc0FycmF5ICYmIGhhc093bihhcnJheUluc3RydW1lbnRhdGlvbnMsIGtleSkpIHsKICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldChhcnJheUluc3RydW1lbnRhdGlvbnMsIGtleSwgcmVjZWl2ZXIpOwogICAgICAgIH0KICAgICAgICBpZiAoa2V5ID09PSAiaGFzT3duUHJvcGVydHkiKSB7CiAgICAgICAgICByZXR1cm4gaGFzT3duUHJvcGVydHk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHJlcyA9IFJlZmxlY3QuZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcik7CiAgICAgIGlmIChpc1N5bWJvbChrZXkpID8gYnVpbHRJblN5bWJvbHMuaGFzKGtleSkgOiBpc05vblRyYWNrYWJsZUtleXMoa2V5KSkgewogICAgICAgIHJldHVybiByZXM7CiAgICAgIH0KICAgICAgaWYgKCFpc1JlYWRvbmx5MikgewogICAgICAgIHRyYWNrKHRhcmdldCwgImdldCIsIGtleSk7CiAgICAgIH0KICAgICAgaWYgKGlzU2hhbGxvdzIpIHsKICAgICAgICByZXR1cm4gcmVzOwogICAgICB9CiAgICAgIGlmIChpc1JlZihyZXMpKSB7CiAgICAgICAgcmV0dXJuIHRhcmdldElzQXJyYXkgJiYgaXNJbnRlZ2VyS2V5KGtleSkgPyByZXMgOiByZXMudmFsdWU7CiAgICAgIH0KICAgICAgaWYgKGlzT2JqZWN0KHJlcykpIHsKICAgICAgICByZXR1cm4gaXNSZWFkb25seTIgPyByZWFkb25seShyZXMpIDogcmVhY3RpdmUocmVzKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzOwogICAgfQogIH0KICBjbGFzcyBNdXRhYmxlUmVhY3RpdmVIYW5kbGVyIGV4dGVuZHMgQmFzZVJlYWN0aXZlSGFuZGxlciB7CiAgICBjb25zdHJ1Y3Rvcihpc1NoYWxsb3cyID0gZmFsc2UpIHsKICAgICAgc3VwZXIoZmFsc2UsIGlzU2hhbGxvdzIpOwogICAgfQogICAgc2V0KHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpIHsKICAgICAgbGV0IG9sZFZhbHVlID0gdGFyZ2V0W2tleV07CiAgICAgIGlmICghdGhpcy5faXNTaGFsbG93KSB7CiAgICAgICAgY29uc3QgaXNPbGRWYWx1ZVJlYWRvbmx5ID0gaXNSZWFkb25seShvbGRWYWx1ZSk7CiAgICAgICAgaWYgKCFpc1NoYWxsb3codmFsdWUpICYmICFpc1JlYWRvbmx5KHZhbHVlKSkgewogICAgICAgICAgb2xkVmFsdWUgPSB0b1JhdyhvbGRWYWx1ZSk7CiAgICAgICAgICB2YWx1ZSA9IHRvUmF3KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0FycmF5KHRhcmdldCkgJiYgaXNSZWYob2xkVmFsdWUpICYmICFpc1JlZih2YWx1ZSkpIHsKICAgICAgICAgIGlmIChpc09sZFZhbHVlUmVhZG9ubHkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2xkVmFsdWUudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IGhhZEtleSA9IGlzQXJyYXkodGFyZ2V0KSAmJiBpc0ludGVnZXJLZXkoa2V5KSA/IE51bWJlcihrZXkpIDwgdGFyZ2V0Lmxlbmd0aCA6IGhhc093bih0YXJnZXQsIGtleSk7CiAgICAgIGNvbnN0IHJlc3VsdCA9IFJlZmxlY3Quc2V0KHRhcmdldCwga2V5LCB2YWx1ZSwgcmVjZWl2ZXIpOwogICAgICBpZiAodGFyZ2V0ID09PSB0b1JhdyhyZWNlaXZlcikpIHsKICAgICAgICBpZiAoIWhhZEtleSkgewogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJhZGQiLCBrZXksIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKGhhc0NoYW5nZWQodmFsdWUsIG9sZFZhbHVlKSkgewogICAgICAgICAgdHJpZ2dlcih0YXJnZXQsICJzZXQiLCBrZXksIHZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBkZWxldGVQcm9wZXJ0eSh0YXJnZXQsIGtleSkgewogICAgICBjb25zdCBoYWRLZXkgPSBoYXNPd24odGFyZ2V0LCBrZXkpOwogICAgICBjb25zdCBvbGRWYWx1ZSA9IHRhcmdldFtrZXldOwogICAgICBjb25zdCByZXN1bHQgPSBSZWZsZWN0LmRlbGV0ZVByb3BlcnR5KHRhcmdldCwga2V5KTsKICAgICAgaWYgKHJlc3VsdCAmJiBoYWRLZXkpIHsKICAgICAgICB0cmlnZ2VyKHRhcmdldCwgImRlbGV0ZSIsIGtleSwgdm9pZCAwLCBvbGRWYWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGhhcyh0YXJnZXQsIGtleSkgewogICAgICBjb25zdCByZXN1bHQgPSBSZWZsZWN0Lmhhcyh0YXJnZXQsIGtleSk7CiAgICAgIGlmICghaXNTeW1ib2woa2V5KSB8fCAhYnVpbHRJblN5bWJvbHMuaGFzKGtleSkpIHsKICAgICAgICB0cmFjayh0YXJnZXQsICJoYXMiLCBrZXkpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBvd25LZXlzKHRhcmdldCkgewogICAgICB0cmFjaygKICAgICAgICB0YXJnZXQsCiAgICAgICAgIml0ZXJhdGUiLAogICAgICAgIGlzQXJyYXkodGFyZ2V0KSA/ICJsZW5ndGgiIDogSVRFUkFURV9LRVkKICAgICAgKTsKICAgICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpOwogICAgfQogIH0KICBjbGFzcyBSZWFkb25seVJlYWN0aXZlSGFuZGxlciBleHRlbmRzIEJhc2VSZWFjdGl2ZUhhbmRsZXIgewogICAgY29uc3RydWN0b3IoaXNTaGFsbG93MiA9IGZhbHNlKSB7CiAgICAgIHN1cGVyKHRydWUsIGlzU2hhbGxvdzIpOwogICAgfQogICAgc2V0KHRhcmdldCwga2V5KSB7CiAgICAgIHsKICAgICAgICB3YXJuJDIoCiAgICAgICAgICBgU2V0IG9wZXJhdGlvbiBvbiBrZXkgIiR7U3RyaW5nKGtleSl9IiBmYWlsZWQ6IHRhcmdldCBpcyByZWFkb25seS5gLAogICAgICAgICAgdGFyZ2V0CiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGRlbGV0ZVByb3BlcnR5KHRhcmdldCwga2V5KSB7CiAgICAgIHsKICAgICAgICB3YXJuJDIoCiAgICAgICAgICBgRGVsZXRlIG9wZXJhdGlvbiBvbiBrZXkgIiR7U3RyaW5nKGtleSl9IiBmYWlsZWQ6IHRhcmdldCBpcyByZWFkb25seS5gLAogICAgICAgICAgdGFyZ2V0CiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgY29uc3QgbXV0YWJsZUhhbmRsZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNdXRhYmxlUmVhY3RpdmVIYW5kbGVyKCk7CiAgY29uc3QgcmVhZG9ubHlIYW5kbGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgUmVhZG9ubHlSZWFjdGl2ZUhhbmRsZXIoKTsKICBjb25zdCBzaGFsbG93UmVhY3RpdmVIYW5kbGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTXV0YWJsZVJlYWN0aXZlSGFuZGxlcigKICAgIHRydWUKICApOwogIGNvbnN0IHNoYWxsb3dSZWFkb25seUhhbmRsZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBSZWFkb25seVJlYWN0aXZlSGFuZGxlcih0cnVlKTsKCiAgY29uc3QgdG9TaGFsbG93ID0gKHZhbHVlKSA9PiB2YWx1ZTsKICBjb25zdCBnZXRQcm90byA9ICh2KSA9PiBSZWZsZWN0LmdldFByb3RvdHlwZU9mKHYpOwogIGZ1bmN0aW9uIGdldCh0YXJnZXQsIGtleSwgaXNSZWFkb25seSA9IGZhbHNlLCBpc1NoYWxsb3cgPSBmYWxzZSkgewogICAgdGFyZ2V0ID0gdGFyZ2V0WyJfX3ZfcmF3Il07CiAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgY29uc3QgcmF3S2V5ID0gdG9SYXcoa2V5KTsKICAgIGlmICghaXNSZWFkb25seSkgewogICAgICBpZiAoaGFzQ2hhbmdlZChrZXksIHJhd0tleSkpIHsKICAgICAgICB0cmFjayhyYXdUYXJnZXQsICJnZXQiLCBrZXkpOwogICAgICB9CiAgICAgIHRyYWNrKHJhd1RhcmdldCwgImdldCIsIHJhd0tleSk7CiAgICB9CiAgICBjb25zdCB7IGhhczogaGFzMiB9ID0gZ2V0UHJvdG8ocmF3VGFyZ2V0KTsKICAgIGNvbnN0IHdyYXAgPSBpc1NoYWxsb3cgPyB0b1NoYWxsb3cgOiBpc1JlYWRvbmx5ID8gdG9SZWFkb25seSA6IHRvUmVhY3RpdmU7CiAgICBpZiAoaGFzMi5jYWxsKHJhd1RhcmdldCwga2V5KSkgewogICAgICByZXR1cm4gd3JhcCh0YXJnZXQuZ2V0KGtleSkpOwogICAgfSBlbHNlIGlmIChoYXMyLmNhbGwocmF3VGFyZ2V0LCByYXdLZXkpKSB7CiAgICAgIHJldHVybiB3cmFwKHRhcmdldC5nZXQocmF3S2V5KSk7CiAgICB9IGVsc2UgaWYgKHRhcmdldCAhPT0gcmF3VGFyZ2V0KSB7CiAgICAgIHRhcmdldC5nZXQoa2V5KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaGFzKGtleSwgaXNSZWFkb25seSA9IGZhbHNlKSB7CiAgICBjb25zdCB0YXJnZXQgPSB0aGlzWyJfX3ZfcmF3Il07CiAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgY29uc3QgcmF3S2V5ID0gdG9SYXcoa2V5KTsKICAgIGlmICghaXNSZWFkb25seSkgewogICAgICBpZiAoaGFzQ2hhbmdlZChrZXksIHJhd0tleSkpIHsKICAgICAgICB0cmFjayhyYXdUYXJnZXQsICJoYXMiLCBrZXkpOwogICAgICB9CiAgICAgIHRyYWNrKHJhd1RhcmdldCwgImhhcyIsIHJhd0tleSk7CiAgICB9CiAgICByZXR1cm4ga2V5ID09PSByYXdLZXkgPyB0YXJnZXQuaGFzKGtleSkgOiB0YXJnZXQuaGFzKGtleSkgfHwgdGFyZ2V0LmhhcyhyYXdLZXkpOwogIH0KICBmdW5jdGlvbiBzaXplKHRhcmdldCwgaXNSZWFkb25seSA9IGZhbHNlKSB7CiAgICB0YXJnZXQgPSB0YXJnZXRbIl9fdl9yYXciXTsKICAgICFpc1JlYWRvbmx5ICYmIHRyYWNrKHRvUmF3KHRhcmdldCksICJpdGVyYXRlIiwgSVRFUkFURV9LRVkpOwogICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgInNpemUiLCB0YXJnZXQpOwogIH0KICBmdW5jdGlvbiBhZGQodmFsdWUpIHsKICAgIHZhbHVlID0gdG9SYXcodmFsdWUpOwogICAgY29uc3QgdGFyZ2V0ID0gdG9SYXcodGhpcyk7CiAgICBjb25zdCBwcm90byA9IGdldFByb3RvKHRhcmdldCk7CiAgICBjb25zdCBoYWRLZXkgPSBwcm90by5oYXMuY2FsbCh0YXJnZXQsIHZhbHVlKTsKICAgIGlmICghaGFkS2V5KSB7CiAgICAgIHRhcmdldC5hZGQodmFsdWUpOwogICAgICB0cmlnZ2VyKHRhcmdldCwgImFkZCIsIHZhbHVlLCB2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9CiAgZnVuY3Rpb24gc2V0KGtleSwgdmFsdWUpIHsKICAgIHZhbHVlID0gdG9SYXcodmFsdWUpOwogICAgY29uc3QgdGFyZ2V0ID0gdG9SYXcodGhpcyk7CiAgICBjb25zdCB7IGhhczogaGFzMiwgZ2V0OiBnZXQyIH0gPSBnZXRQcm90byh0YXJnZXQpOwogICAgbGV0IGhhZEtleSA9IGhhczIuY2FsbCh0YXJnZXQsIGtleSk7CiAgICBpZiAoIWhhZEtleSkgewogICAgICBrZXkgPSB0b1JhdyhrZXkpOwogICAgICBoYWRLZXkgPSBoYXMyLmNhbGwodGFyZ2V0LCBrZXkpOwogICAgfSBlbHNlIHsKICAgICAgY2hlY2tJZGVudGl0eUtleXModGFyZ2V0LCBoYXMyLCBrZXkpOwogICAgfQogICAgY29uc3Qgb2xkVmFsdWUgPSBnZXQyLmNhbGwodGFyZ2V0LCBrZXkpOwogICAgdGFyZ2V0LnNldChrZXksIHZhbHVlKTsKICAgIGlmICghaGFkS2V5KSB7CiAgICAgIHRyaWdnZXIodGFyZ2V0LCAiYWRkIiwga2V5LCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGhhc0NoYW5nZWQodmFsdWUsIG9sZFZhbHVlKSkgewogICAgICB0cmlnZ2VyKHRhcmdldCwgInNldCIsIGtleSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICBmdW5jdGlvbiBkZWxldGVFbnRyeShrZXkpIHsKICAgIGNvbnN0IHRhcmdldCA9IHRvUmF3KHRoaXMpOwogICAgY29uc3QgeyBoYXM6IGhhczIsIGdldDogZ2V0MiB9ID0gZ2V0UHJvdG8odGFyZ2V0KTsKICAgIGxldCBoYWRLZXkgPSBoYXMyLmNhbGwodGFyZ2V0LCBrZXkpOwogICAgaWYgKCFoYWRLZXkpIHsKICAgICAga2V5ID0gdG9SYXcoa2V5KTsKICAgICAgaGFkS2V5ID0gaGFzMi5jYWxsKHRhcmdldCwga2V5KTsKICAgIH0gZWxzZSB7CiAgICAgIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzMiwga2V5KTsKICAgIH0KICAgIGNvbnN0IG9sZFZhbHVlID0gZ2V0MiA/IGdldDIuY2FsbCh0YXJnZXQsIGtleSkgOiB2b2lkIDA7CiAgICBjb25zdCByZXN1bHQgPSB0YXJnZXQuZGVsZXRlKGtleSk7CiAgICBpZiAoaGFkS2V5KSB7CiAgICAgIHRyaWdnZXIodGFyZ2V0LCAiZGVsZXRlIiwga2V5LCB2b2lkIDAsIG9sZFZhbHVlKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGNsZWFyKCkgewogICAgY29uc3QgdGFyZ2V0ID0gdG9SYXcodGhpcyk7CiAgICBjb25zdCBoYWRJdGVtcyA9IHRhcmdldC5zaXplICE9PSAwOwogICAgY29uc3Qgb2xkVGFyZ2V0ID0gaXNNYXAodGFyZ2V0KSA/IG5ldyBNYXAodGFyZ2V0KSA6IG5ldyBTZXQodGFyZ2V0KSA7CiAgICBjb25zdCByZXN1bHQgPSB0YXJnZXQuY2xlYXIoKTsKICAgIGlmIChoYWRJdGVtcykgewogICAgICB0cmlnZ2VyKHRhcmdldCwgImNsZWFyIiwgdm9pZCAwLCB2b2lkIDAsIG9sZFRhcmdldCk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjcmVhdGVGb3JFYWNoKGlzUmVhZG9ubHksIGlzU2hhbGxvdykgewogICAgcmV0dXJuIGZ1bmN0aW9uIGZvckVhY2goY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgY29uc3Qgb2JzZXJ2ZWQgPSB0aGlzOwogICAgICBjb25zdCB0YXJnZXQgPSBvYnNlcnZlZFsiX192X3JhdyJdOwogICAgICBjb25zdCByYXdUYXJnZXQgPSB0b1Jhdyh0YXJnZXQpOwogICAgICBjb25zdCB3cmFwID0gaXNTaGFsbG93ID8gdG9TaGFsbG93IDogaXNSZWFkb25seSA/IHRvUmVhZG9ubHkgOiB0b1JlYWN0aXZlOwogICAgICAhaXNSZWFkb25seSAmJiB0cmFjayhyYXdUYXJnZXQsICJpdGVyYXRlIiwgSVRFUkFURV9LRVkpOwogICAgICByZXR1cm4gdGFyZ2V0LmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHsKICAgICAgICByZXR1cm4gY2FsbGJhY2suY2FsbCh0aGlzQXJnLCB3cmFwKHZhbHVlKSwgd3JhcChrZXkpLCBvYnNlcnZlZCk7CiAgICAgIH0pOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlSXRlcmFibGVNZXRob2QobWV0aG9kLCBpc1JlYWRvbmx5LCBpc1NoYWxsb3cpIHsKICAgIHJldHVybiBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXNbIl9fdl9yYXciXTsKICAgICAgY29uc3QgcmF3VGFyZ2V0ID0gdG9SYXcodGFyZ2V0KTsKICAgICAgY29uc3QgdGFyZ2V0SXNNYXAgPSBpc01hcChyYXdUYXJnZXQpOwogICAgICBjb25zdCBpc1BhaXIgPSBtZXRob2QgPT09ICJlbnRyaWVzIiB8fCBtZXRob2QgPT09IFN5bWJvbC5pdGVyYXRvciAmJiB0YXJnZXRJc01hcDsKICAgICAgY29uc3QgaXNLZXlPbmx5ID0gbWV0aG9kID09PSAia2V5cyIgJiYgdGFyZ2V0SXNNYXA7CiAgICAgIGNvbnN0IGlubmVySXRlcmF0b3IgPSB0YXJnZXRbbWV0aG9kXSguLi5hcmdzKTsKICAgICAgY29uc3Qgd3JhcCA9IGlzU2hhbGxvdyA/IHRvU2hhbGxvdyA6IGlzUmVhZG9ubHkgPyB0b1JlYWRvbmx5IDogdG9SZWFjdGl2ZTsKICAgICAgIWlzUmVhZG9ubHkgJiYgdHJhY2soCiAgICAgICAgcmF3VGFyZ2V0LAogICAgICAgICJpdGVyYXRlIiwKICAgICAgICBpc0tleU9ubHkgPyBNQVBfS0VZX0lURVJBVEVfS0VZIDogSVRFUkFURV9LRVkKICAgICAgKTsKICAgICAgcmV0dXJuIHsKICAgICAgICAvLyBpdGVyYXRvciBwcm90b2NvbAogICAgICAgIG5leHQoKSB7CiAgICAgICAgICBjb25zdCB7IHZhbHVlLCBkb25lIH0gPSBpbm5lckl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgIHJldHVybiBkb25lID8geyB2YWx1ZSwgZG9uZSB9IDogewogICAgICAgICAgICB2YWx1ZTogaXNQYWlyID8gW3dyYXAodmFsdWVbMF0pLCB3cmFwKHZhbHVlWzFdKV0gOiB3cmFwKHZhbHVlKSwKICAgICAgICAgICAgZG9uZQogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIC8vIGl0ZXJhYmxlIHByb3RvY29sCiAgICAgICAgW1N5bWJvbC5pdGVyYXRvcl0oKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVSZWFkb25seU1ldGhvZCh0eXBlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oLi4uYXJncykgewogICAgICB7CiAgICAgICAgY29uc3Qga2V5ID0gYXJnc1swXSA/IGBvbiBrZXkgIiR7YXJnc1swXX0iIGAgOiBgYDsKICAgICAgICB3YXJuJDIoCiAgICAgICAgICBgJHtjYXBpdGFsaXplKHR5cGUpfSBvcGVyYXRpb24gJHtrZXl9ZmFpbGVkOiB0YXJnZXQgaXMgcmVhZG9ubHkuYCwKICAgICAgICAgIHRvUmF3KHRoaXMpCiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gdHlwZSA9PT0gImRlbGV0ZSIgPyBmYWxzZSA6IHR5cGUgPT09ICJjbGVhciIgPyB2b2lkIDAgOiB0aGlzOwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlSW5zdHJ1bWVudGF0aW9ucygpIHsKICAgIGNvbnN0IG11dGFibGVJbnN0cnVtZW50YXRpb25zMiA9IHsKICAgICAgZ2V0KGtleSkgewogICAgICAgIHJldHVybiBnZXQodGhpcywga2V5KTsKICAgICAgfSwKICAgICAgZ2V0IHNpemUoKSB7CiAgICAgICAgcmV0dXJuIHNpemUodGhpcyk7CiAgICAgIH0sCiAgICAgIGhhcywKICAgICAgYWRkLAogICAgICBzZXQsCiAgICAgIGRlbGV0ZTogZGVsZXRlRW50cnksCiAgICAgIGNsZWFyLAogICAgICBmb3JFYWNoOiBjcmVhdGVGb3JFYWNoKGZhbHNlLCBmYWxzZSkKICAgIH07CiAgICBjb25zdCBzaGFsbG93SW5zdHJ1bWVudGF0aW9uczIgPSB7CiAgICAgIGdldChrZXkpIHsKICAgICAgICByZXR1cm4gZ2V0KHRoaXMsIGtleSwgZmFsc2UsIHRydWUpOwogICAgICB9LAogICAgICBnZXQgc2l6ZSgpIHsKICAgICAgICByZXR1cm4gc2l6ZSh0aGlzKTsKICAgICAgfSwKICAgICAgaGFzLAogICAgICBhZGQsCiAgICAgIHNldCwKICAgICAgZGVsZXRlOiBkZWxldGVFbnRyeSwKICAgICAgY2xlYXIsCiAgICAgIGZvckVhY2g6IGNyZWF0ZUZvckVhY2goZmFsc2UsIHRydWUpCiAgICB9OwogICAgY29uc3QgcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zMiA9IHsKICAgICAgZ2V0KGtleSkgewogICAgICAgIHJldHVybiBnZXQodGhpcywga2V5LCB0cnVlKTsKICAgICAgfSwKICAgICAgZ2V0IHNpemUoKSB7CiAgICAgICAgcmV0dXJuIHNpemUodGhpcywgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGhhcyhrZXkpIHsKICAgICAgICByZXR1cm4gaGFzLmNhbGwodGhpcywga2V5LCB0cnVlKTsKICAgICAgfSwKICAgICAgYWRkOiBjcmVhdGVSZWFkb25seU1ldGhvZCgiYWRkIiksCiAgICAgIHNldDogY3JlYXRlUmVhZG9ubHlNZXRob2QoInNldCIpLAogICAgICBkZWxldGU6IGNyZWF0ZVJlYWRvbmx5TWV0aG9kKCJkZWxldGUiKSwKICAgICAgY2xlYXI6IGNyZWF0ZVJlYWRvbmx5TWV0aG9kKCJjbGVhciIpLAogICAgICBmb3JFYWNoOiBjcmVhdGVGb3JFYWNoKHRydWUsIGZhbHNlKQogICAgfTsKICAgIGNvbnN0IHNoYWxsb3dSZWFkb25seUluc3RydW1lbnRhdGlvbnMyID0gewogICAgICBnZXQoa2V5KSB7CiAgICAgICAgcmV0dXJuIGdldCh0aGlzLCBrZXksIHRydWUsIHRydWUpOwogICAgICB9LAogICAgICBnZXQgc2l6ZSgpIHsKICAgICAgICByZXR1cm4gc2l6ZSh0aGlzLCB0cnVlKTsKICAgICAgfSwKICAgICAgaGFzKGtleSkgewogICAgICAgIHJldHVybiBoYXMuY2FsbCh0aGlzLCBrZXksIHRydWUpOwogICAgICB9LAogICAgICBhZGQ6IGNyZWF0ZVJlYWRvbmx5TWV0aG9kKCJhZGQiKSwKICAgICAgc2V0OiBjcmVhdGVSZWFkb25seU1ldGhvZCgic2V0IiksCiAgICAgIGRlbGV0ZTogY3JlYXRlUmVhZG9ubHlNZXRob2QoImRlbGV0ZSIpLAogICAgICBjbGVhcjogY3JlYXRlUmVhZG9ubHlNZXRob2QoImNsZWFyIiksCiAgICAgIGZvckVhY2g6IGNyZWF0ZUZvckVhY2godHJ1ZSwgdHJ1ZSkKICAgIH07CiAgICBjb25zdCBpdGVyYXRvck1ldGhvZHMgPSBbImtleXMiLCAidmFsdWVzIiwgImVudHJpZXMiLCBTeW1ib2wuaXRlcmF0b3JdOwogICAgaXRlcmF0b3JNZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gewogICAgICBtdXRhYmxlSW5zdHJ1bWVudGF0aW9uczJbbWV0aG9kXSA9IGNyZWF0ZUl0ZXJhYmxlTWV0aG9kKAogICAgICAgIG1ldGhvZCwKICAgICAgICBmYWxzZSwKICAgICAgICBmYWxzZQogICAgICApOwogICAgICByZWFkb25seUluc3RydW1lbnRhdGlvbnMyW21ldGhvZF0gPSBjcmVhdGVJdGVyYWJsZU1ldGhvZCgKICAgICAgICBtZXRob2QsCiAgICAgICAgdHJ1ZSwKICAgICAgICBmYWxzZQogICAgICApOwogICAgICBzaGFsbG93SW5zdHJ1bWVudGF0aW9uczJbbWV0aG9kXSA9IGNyZWF0ZUl0ZXJhYmxlTWV0aG9kKAogICAgICAgIG1ldGhvZCwKICAgICAgICBmYWxzZSwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICAgIHNoYWxsb3dSZWFkb25seUluc3RydW1lbnRhdGlvbnMyW21ldGhvZF0gPSBjcmVhdGVJdGVyYWJsZU1ldGhvZCgKICAgICAgICBtZXRob2QsCiAgICAgICAgdHJ1ZSwKICAgICAgICB0cnVlCiAgICAgICk7CiAgICB9KTsKICAgIHJldHVybiBbCiAgICAgIG11dGFibGVJbnN0cnVtZW50YXRpb25zMiwKICAgICAgcmVhZG9ubHlJbnN0cnVtZW50YXRpb25zMiwKICAgICAgc2hhbGxvd0luc3RydW1lbnRhdGlvbnMyLAogICAgICBzaGFsbG93UmVhZG9ubHlJbnN0cnVtZW50YXRpb25zMgogICAgXTsKICB9CiAgY29uc3QgWwogICAgbXV0YWJsZUluc3RydW1lbnRhdGlvbnMsCiAgICByZWFkb25seUluc3RydW1lbnRhdGlvbnMsCiAgICBzaGFsbG93SW5zdHJ1bWVudGF0aW9ucywKICAgIHNoYWxsb3dSZWFkb25seUluc3RydW1lbnRhdGlvbnMKICBdID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZUluc3RydW1lbnRhdGlvbnMoKTsKICBmdW5jdGlvbiBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIoaXNSZWFkb25seSwgc2hhbGxvdykgewogICAgY29uc3QgaW5zdHJ1bWVudGF0aW9ucyA9IHNoYWxsb3cgPyBpc1JlYWRvbmx5ID8gc2hhbGxvd1JlYWRvbmx5SW5zdHJ1bWVudGF0aW9ucyA6IHNoYWxsb3dJbnN0cnVtZW50YXRpb25zIDogaXNSZWFkb25seSA/IHJlYWRvbmx5SW5zdHJ1bWVudGF0aW9ucyA6IG11dGFibGVJbnN0cnVtZW50YXRpb25zOwogICAgcmV0dXJuICh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpID0+IHsKICAgICAgaWYgKGtleSA9PT0gIl9fdl9pc1JlYWN0aXZlIikgewogICAgICAgIHJldHVybiAhaXNSZWFkb25seTsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJfX3ZfaXNSZWFkb25seSIpIHsKICAgICAgICByZXR1cm4gaXNSZWFkb25seTsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJfX3ZfcmF3IikgewogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KAogICAgICAgIGhhc093bihpbnN0cnVtZW50YXRpb25zLCBrZXkpICYmIGtleSBpbiB0YXJnZXQgPyBpbnN0cnVtZW50YXRpb25zIDogdGFyZ2V0LAogICAgICAgIGtleSwKICAgICAgICByZWNlaXZlcgogICAgICApOwogICAgfTsKICB9CiAgY29uc3QgbXV0YWJsZUNvbGxlY3Rpb25IYW5kbGVycyA9IHsKICAgIGdldDogLyogQF9fUFVSRV9fICovIGNyZWF0ZUluc3RydW1lbnRhdGlvbkdldHRlcihmYWxzZSwgZmFsc2UpCiAgfTsKICBjb25zdCBzaGFsbG93Q29sbGVjdGlvbkhhbmRsZXJzID0gewogICAgZ2V0OiAvKiBAX19QVVJFX18gKi8gY3JlYXRlSW5zdHJ1bWVudGF0aW9uR2V0dGVyKGZhbHNlLCB0cnVlKQogIH07CiAgY29uc3QgcmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7CiAgICBnZXQ6IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIodHJ1ZSwgZmFsc2UpCiAgfTsKICBjb25zdCBzaGFsbG93UmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMgPSB7CiAgICBnZXQ6IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVJbnN0cnVtZW50YXRpb25HZXR0ZXIodHJ1ZSwgdHJ1ZSkKICB9OwogIGZ1bmN0aW9uIGNoZWNrSWRlbnRpdHlLZXlzKHRhcmdldCwgaGFzMiwga2V5KSB7CiAgICBjb25zdCByYXdLZXkgPSB0b1JhdyhrZXkpOwogICAgaWYgKHJhd0tleSAhPT0ga2V5ICYmIGhhczIuY2FsbCh0YXJnZXQsIHJhd0tleSkpIHsKICAgICAgY29uc3QgdHlwZSA9IHRvUmF3VHlwZSh0YXJnZXQpOwogICAgICB3YXJuJDIoCiAgICAgICAgYFJlYWN0aXZlICR7dHlwZX0gY29udGFpbnMgYm90aCB0aGUgcmF3IGFuZCByZWFjdGl2ZSB2ZXJzaW9ucyBvZiB0aGUgc2FtZSBvYmplY3Qke3R5cGUgPT09IGBNYXBgID8gYCBhcyBrZXlzYCA6IGBgfSwgd2hpY2ggY2FuIGxlYWQgdG8gaW5jb25zaXN0ZW5jaWVzLiBBdm9pZCBkaWZmZXJlbnRpYXRpbmcgYmV0d2VlbiB0aGUgcmF3IGFuZCByZWFjdGl2ZSB2ZXJzaW9ucyBvZiBhbiBvYmplY3QgYW5kIG9ubHkgdXNlIHRoZSByZWFjdGl2ZSB2ZXJzaW9uIGlmIHBvc3NpYmxlLmAKICAgICAgKTsKICAgIH0KICB9CgogIGNvbnN0IHJlYWN0aXZlTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgY29uc3Qgc2hhbGxvd1JlYWN0aXZlTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgY29uc3QgcmVhZG9ubHlNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBjb25zdCBzaGFsbG93UmVhZG9ubHlNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiB0YXJnZXRUeXBlTWFwKHJhd1R5cGUpIHsKICAgIHN3aXRjaCAocmF3VHlwZSkgewogICAgICBjYXNlICJPYmplY3QiOgogICAgICBjYXNlICJBcnJheSI6CiAgICAgICAgcmV0dXJuIDEgLyogQ09NTU9OICovOwogICAgICBjYXNlICJNYXAiOgogICAgICBjYXNlICJTZXQiOgogICAgICBjYXNlICJXZWFrTWFwIjoKICAgICAgY2FzZSAiV2Vha1NldCI6CiAgICAgICAgcmV0dXJuIDIgLyogQ09MTEVDVElPTiAqLzsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gMCAvKiBJTlZBTElEICovOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRUYXJnZXRUeXBlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWVbIl9fdl9za2lwIl0gfHwgIU9iamVjdC5pc0V4dGVuc2libGUodmFsdWUpID8gMCAvKiBJTlZBTElEICovIDogdGFyZ2V0VHlwZU1hcCh0b1Jhd1R5cGUodmFsdWUpKTsKICB9CiAgZnVuY3Rpb24gcmVhY3RpdmUodGFyZ2V0KSB7CiAgICBpZiAoaXNSZWFkb25seSh0YXJnZXQpKSB7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoCiAgICAgIHRhcmdldCwKICAgICAgZmFsc2UsCiAgICAgIG11dGFibGVIYW5kbGVycywKICAgICAgbXV0YWJsZUNvbGxlY3Rpb25IYW5kbGVycywKICAgICAgcmVhY3RpdmVNYXAKICAgICk7CiAgfQogIGZ1bmN0aW9uIHNoYWxsb3dSZWFjdGl2ZSh0YXJnZXQpIHsKICAgIHJldHVybiBjcmVhdGVSZWFjdGl2ZU9iamVjdCgKICAgICAgdGFyZ2V0LAogICAgICBmYWxzZSwKICAgICAgc2hhbGxvd1JlYWN0aXZlSGFuZGxlcnMsCiAgICAgIHNoYWxsb3dDb2xsZWN0aW9uSGFuZGxlcnMsCiAgICAgIHNoYWxsb3dSZWFjdGl2ZU1hcAogICAgKTsKICB9CiAgZnVuY3Rpb24gcmVhZG9ubHkodGFyZ2V0KSB7CiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoCiAgICAgIHRhcmdldCwKICAgICAgdHJ1ZSwKICAgICAgcmVhZG9ubHlIYW5kbGVycywKICAgICAgcmVhZG9ubHlDb2xsZWN0aW9uSGFuZGxlcnMsCiAgICAgIHJlYWRvbmx5TWFwCiAgICApOwogIH0KICBmdW5jdGlvbiBzaGFsbG93UmVhZG9ubHkodGFyZ2V0KSB7CiAgICByZXR1cm4gY3JlYXRlUmVhY3RpdmVPYmplY3QoCiAgICAgIHRhcmdldCwKICAgICAgdHJ1ZSwKICAgICAgc2hhbGxvd1JlYWRvbmx5SGFuZGxlcnMsCiAgICAgIHNoYWxsb3dSZWFkb25seUNvbGxlY3Rpb25IYW5kbGVycywKICAgICAgc2hhbGxvd1JlYWRvbmx5TWFwCiAgICApOwogIH0KICBmdW5jdGlvbiBjcmVhdGVSZWFjdGl2ZU9iamVjdCh0YXJnZXQsIGlzUmVhZG9ubHkyLCBiYXNlSGFuZGxlcnMsIGNvbGxlY3Rpb25IYW5kbGVycywgcHJveHlNYXApIHsKICAgIGlmICghaXNPYmplY3QodGFyZ2V0KSkgewogICAgICB7CiAgICAgICAgd2FybiQyKGB2YWx1ZSBjYW5ub3QgYmUgbWFkZSByZWFjdGl2ZTogJHtTdHJpbmcodGFyZ2V0KX1gKTsKICAgICAgfQogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgaWYgKHRhcmdldFsiX192X3JhdyJdICYmICEoaXNSZWFkb25seTIgJiYgdGFyZ2V0WyJfX3ZfaXNSZWFjdGl2ZSJdKSkgewogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgY29uc3QgZXhpc3RpbmdQcm94eSA9IHByb3h5TWFwLmdldCh0YXJnZXQpOwogICAgaWYgKGV4aXN0aW5nUHJveHkpIHsKICAgICAgcmV0dXJuIGV4aXN0aW5nUHJveHk7CiAgICB9CiAgICBjb25zdCB0YXJnZXRUeXBlID0gZ2V0VGFyZ2V0VHlwZSh0YXJnZXQpOwogICAgaWYgKHRhcmdldFR5cGUgPT09IDAgLyogSU5WQUxJRCAqLykgewogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgY29uc3QgcHJveHkgPSBuZXcgUHJveHkoCiAgICAgIHRhcmdldCwKICAgICAgdGFyZ2V0VHlwZSA9PT0gMiAvKiBDT0xMRUNUSU9OICovID8gY29sbGVjdGlvbkhhbmRsZXJzIDogYmFzZUhhbmRsZXJzCiAgICApOwogICAgcHJveHlNYXAuc2V0KHRhcmdldCwgcHJveHkpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmdW5jdGlvbiBpc1JlYWN0aXZlKHZhbHVlKSB7CiAgICBpZiAoaXNSZWFkb25seSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGlzUmVhY3RpdmUodmFsdWVbIl9fdl9yYXciXSk7CiAgICB9CiAgICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWVbIl9fdl9pc1JlYWN0aXZlIl0pOwogIH0KICBmdW5jdGlvbiBpc1JlYWRvbmx5KHZhbHVlKSB7CiAgICByZXR1cm4gISEodmFsdWUgJiYgdmFsdWVbIl9fdl9pc1JlYWRvbmx5Il0pOwogIH0KICBmdW5jdGlvbiBpc1NoYWxsb3codmFsdWUpIHsKICAgIHJldHVybiAhISh2YWx1ZSAmJiB2YWx1ZVsiX192X2lzU2hhbGxvdyJdKTsKICB9CiAgZnVuY3Rpb24gaXNQcm94eSh2YWx1ZSkgewogICAgcmV0dXJuIGlzUmVhY3RpdmUodmFsdWUpIHx8IGlzUmVhZG9ubHkodmFsdWUpOwogIH0KICBmdW5jdGlvbiB0b1JhdyhvYnNlcnZlZCkgewogICAgY29uc3QgcmF3ID0gb2JzZXJ2ZWQgJiYgb2JzZXJ2ZWRbIl9fdl9yYXciXTsKICAgIHJldHVybiByYXcgPyB0b1JhdyhyYXcpIDogb2JzZXJ2ZWQ7CiAgfQogIGZ1bmN0aW9uIG1hcmtSYXcodmFsdWUpIHsKICAgIGlmIChPYmplY3QuaXNFeHRlbnNpYmxlKHZhbHVlKSkgewogICAgICBkZWYodmFsdWUsICJfX3Zfc2tpcCIsIHRydWUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBjb25zdCB0b1JlYWN0aXZlID0gKHZhbHVlKSA9PiBpc09iamVjdCh2YWx1ZSkgPyByZWFjdGl2ZSh2YWx1ZSkgOiB2YWx1ZTsKICBjb25zdCB0b1JlYWRvbmx5ID0gKHZhbHVlKSA9PiBpc09iamVjdCh2YWx1ZSkgPyByZWFkb25seSh2YWx1ZSkgOiB2YWx1ZTsKCiAgY29uc3QgQ09NUFVURURfU0lERV9FRkZFQ1RfV0FSTiA9IGBDb21wdXRlZCBpcyBzdGlsbCBkaXJ0eSBhZnRlciBnZXR0ZXIgZXZhbHVhdGlvbiwgbGlrZWx5IGJlY2F1c2UgYSBjb21wdXRlZCBpcyBtdXRhdGluZyBpdHMgb3duIGRlcGVuZGVuY3kgaW4gaXRzIGdldHRlci4gU3RhdGUgbXV0YXRpb25zIGluIGNvbXB1dGVkIGdldHRlcnMgc2hvdWxkIGJlIGF2b2lkZWQuICBDaGVjayB0aGUgZG9jcyBmb3IgbW9yZSBkZXRhaWxzOiBodHRwczovL3Z1ZWpzLm9yZy9ndWlkZS9lc3NlbnRpYWxzL2NvbXB1dGVkLmh0bWwjZ2V0dGVycy1zaG91bGQtYmUtc2lkZS1lZmZlY3QtZnJlZWA7CiAgY2xhc3MgQ29tcHV0ZWRSZWZJbXBsIHsKICAgIGNvbnN0cnVjdG9yKGdldHRlciwgX3NldHRlciwgaXNSZWFkb25seSwgaXNTU1IpIHsKICAgICAgdGhpcy5nZXR0ZXIgPSBnZXR0ZXI7CiAgICAgIHRoaXMuX3NldHRlciA9IF9zZXR0ZXI7CiAgICAgIHRoaXMuZGVwID0gdm9pZCAwOwogICAgICB0aGlzLl9fdl9pc1JlZiA9IHRydWU7CiAgICAgIHRoaXNbIl9fdl9pc1JlYWRvbmx5Il0gPSBmYWxzZTsKICAgICAgdGhpcy5lZmZlY3QgPSBuZXcgUmVhY3RpdmVFZmZlY3QoCiAgICAgICAgKCkgPT4gZ2V0dGVyKHRoaXMuX3ZhbHVlKSwKICAgICAgICAoKSA9PiB0cmlnZ2VyUmVmVmFsdWUoCiAgICAgICAgICB0aGlzLAogICAgICAgICAgdGhpcy5lZmZlY3QuX2RpcnR5TGV2ZWwgPT09IDIgPyAyIDogMwogICAgICAgICkKICAgICAgKTsKICAgICAgdGhpcy5lZmZlY3QuY29tcHV0ZWQgPSB0aGlzOwogICAgICB0aGlzLmVmZmVjdC5hY3RpdmUgPSB0aGlzLl9jYWNoZWFibGUgPSAhaXNTU1I7CiAgICAgIHRoaXNbIl9fdl9pc1JlYWRvbmx5Il0gPSBpc1JlYWRvbmx5OwogICAgfQogICAgZ2V0IHZhbHVlKCkgewogICAgICBjb25zdCBzZWxmID0gdG9SYXcodGhpcyk7CiAgICAgIGlmICgoIXNlbGYuX2NhY2hlYWJsZSB8fCBzZWxmLmVmZmVjdC5kaXJ0eSkgJiYgaGFzQ2hhbmdlZChzZWxmLl92YWx1ZSwgc2VsZi5fdmFsdWUgPSBzZWxmLmVmZmVjdC5ydW4oKSkpIHsKICAgICAgICB0cmlnZ2VyUmVmVmFsdWUoc2VsZiwgNCk7CiAgICAgIH0KICAgICAgdHJhY2tSZWZWYWx1ZShzZWxmKTsKICAgICAgaWYgKHNlbGYuZWZmZWN0Ll9kaXJ0eUxldmVsID49IDIpIHsKICAgICAgICBpZiAodGhpcy5fd2FyblJlY3Vyc2l2ZSkgewogICAgICAgICAgd2FybiQyKENPTVBVVEVEX1NJREVfRUZGRUNUX1dBUk4sIGAKCmdldHRlcjogYCwgdGhpcy5nZXR0ZXIpOwogICAgICAgIH0KICAgICAgICB0cmlnZ2VyUmVmVmFsdWUoc2VsZiwgMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGYuX3ZhbHVlOwogICAgfQogICAgc2V0IHZhbHVlKG5ld1ZhbHVlKSB7CiAgICAgIHRoaXMuX3NldHRlcihuZXdWYWx1ZSk7CiAgICB9CiAgICAvLyAjcmVnaW9uIHBvbHlmaWxsIF9kaXJ0eSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB0aGlyZCBwYXJ0eSBjb2RlIGZvciBWdWUgPD0gMy4zLngKICAgIGdldCBfZGlydHkoKSB7CiAgICAgIHJldHVybiB0aGlzLmVmZmVjdC5kaXJ0eTsKICAgIH0KICAgIHNldCBfZGlydHkodikgewogICAgICB0aGlzLmVmZmVjdC5kaXJ0eSA9IHY7CiAgICB9CiAgICAvLyAjZW5kcmVnaW9uCiAgfQogIGZ1bmN0aW9uIGNvbXB1dGVkJDEoZ2V0dGVyT3JPcHRpb25zLCBkZWJ1Z09wdGlvbnMsIGlzU1NSID0gZmFsc2UpIHsKICAgIGxldCBnZXR0ZXI7CiAgICBsZXQgc2V0dGVyOwogICAgY29uc3Qgb25seUdldHRlciA9IGlzRnVuY3Rpb24oZ2V0dGVyT3JPcHRpb25zKTsKICAgIGlmIChvbmx5R2V0dGVyKSB7CiAgICAgIGdldHRlciA9IGdldHRlck9yT3B0aW9uczsKICAgICAgc2V0dGVyID0gKCkgPT4gewogICAgICAgIHdhcm4kMigiV3JpdGUgb3BlcmF0aW9uIGZhaWxlZDogY29tcHV0ZWQgdmFsdWUgaXMgcmVhZG9ubHkiKTsKICAgICAgfSA7CiAgICB9IGVsc2UgewogICAgICBnZXR0ZXIgPSBnZXR0ZXJPck9wdGlvbnMuZ2V0OwogICAgICBzZXR0ZXIgPSBnZXR0ZXJPck9wdGlvbnMuc2V0OwogICAgfQogICAgY29uc3QgY1JlZiA9IG5ldyBDb21wdXRlZFJlZkltcGwoZ2V0dGVyLCBzZXR0ZXIsIG9ubHlHZXR0ZXIgfHwgIXNldHRlciwgaXNTU1IpOwogICAgaWYgKGRlYnVnT3B0aW9ucyAmJiAhaXNTU1IpIHsKICAgICAgY1JlZi5lZmZlY3Qub25UcmFjayA9IGRlYnVnT3B0aW9ucy5vblRyYWNrOwogICAgICBjUmVmLmVmZmVjdC5vblRyaWdnZXIgPSBkZWJ1Z09wdGlvbnMub25UcmlnZ2VyOwogICAgfQogICAgcmV0dXJuIGNSZWY7CiAgfQoKICBmdW5jdGlvbiB0cmFja1JlZlZhbHVlKHJlZjIpIHsKICAgIHZhciBfYTsKICAgIGlmIChzaG91bGRUcmFjayAmJiBhY3RpdmVFZmZlY3QpIHsKICAgICAgcmVmMiA9IHRvUmF3KHJlZjIpOwogICAgICB0cmFja0VmZmVjdCgKICAgICAgICBhY3RpdmVFZmZlY3QsCiAgICAgICAgKF9hID0gcmVmMi5kZXApICE9IG51bGwgPyBfYSA6IHJlZjIuZGVwID0gY3JlYXRlRGVwKAogICAgICAgICAgKCkgPT4gcmVmMi5kZXAgPSB2b2lkIDAsCiAgICAgICAgICByZWYyIGluc3RhbmNlb2YgQ29tcHV0ZWRSZWZJbXBsID8gcmVmMiA6IHZvaWQgMAogICAgICAgICksCiAgICAgICAgewogICAgICAgICAgdGFyZ2V0OiByZWYyLAogICAgICAgICAgdHlwZTogImdldCIsCiAgICAgICAgICBrZXk6ICJ2YWx1ZSIKICAgICAgICB9IAogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiB0cmlnZ2VyUmVmVmFsdWUocmVmMiwgZGlydHlMZXZlbCA9IDQsIG5ld1ZhbCkgewogICAgcmVmMiA9IHRvUmF3KHJlZjIpOwogICAgY29uc3QgZGVwID0gcmVmMi5kZXA7CiAgICBpZiAoZGVwKSB7CiAgICAgIHRyaWdnZXJFZmZlY3RzKAogICAgICAgIGRlcCwKICAgICAgICBkaXJ0eUxldmVsLAogICAgICAgIHsKICAgICAgICAgIHRhcmdldDogcmVmMiwKICAgICAgICAgIHR5cGU6ICJzZXQiLAogICAgICAgICAga2V5OiAidmFsdWUiLAogICAgICAgICAgbmV3VmFsdWU6IG5ld1ZhbAogICAgICAgIH0gCiAgICAgICk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzUmVmKHIpIHsKICAgIHJldHVybiAhIShyICYmIHIuX192X2lzUmVmID09PSB0cnVlKTsKICB9CiAgZnVuY3Rpb24gcmVmKHZhbHVlKSB7CiAgICByZXR1cm4gY3JlYXRlUmVmKHZhbHVlLCBmYWxzZSk7CiAgfQogIGZ1bmN0aW9uIHNoYWxsb3dSZWYodmFsdWUpIHsKICAgIHJldHVybiBjcmVhdGVSZWYodmFsdWUsIHRydWUpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVSZWYocmF3VmFsdWUsIHNoYWxsb3cpIHsKICAgIGlmIChpc1JlZihyYXdWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHJhd1ZhbHVlOwogICAgfQogICAgcmV0dXJuIG5ldyBSZWZJbXBsKHJhd1ZhbHVlLCBzaGFsbG93KTsKICB9CiAgY2xhc3MgUmVmSW1wbCB7CiAgICBjb25zdHJ1Y3Rvcih2YWx1ZSwgX192X2lzU2hhbGxvdykgewogICAgICB0aGlzLl9fdl9pc1NoYWxsb3cgPSBfX3ZfaXNTaGFsbG93OwogICAgICB0aGlzLmRlcCA9IHZvaWQgMDsKICAgICAgdGhpcy5fX3ZfaXNSZWYgPSB0cnVlOwogICAgICB0aGlzLl9yYXdWYWx1ZSA9IF9fdl9pc1NoYWxsb3cgPyB2YWx1ZSA6IHRvUmF3KHZhbHVlKTsKICAgICAgdGhpcy5fdmFsdWUgPSBfX3ZfaXNTaGFsbG93ID8gdmFsdWUgOiB0b1JlYWN0aXZlKHZhbHVlKTsKICAgIH0KICAgIGdldCB2YWx1ZSgpIHsKICAgICAgdHJhY2tSZWZWYWx1ZSh0aGlzKTsKICAgICAgcmV0dXJuIHRoaXMuX3ZhbHVlOwogICAgfQogICAgc2V0IHZhbHVlKG5ld1ZhbCkgewogICAgICBjb25zdCB1c2VEaXJlY3RWYWx1ZSA9IHRoaXMuX192X2lzU2hhbGxvdyB8fCBpc1NoYWxsb3cobmV3VmFsKSB8fCBpc1JlYWRvbmx5KG5ld1ZhbCk7CiAgICAgIG5ld1ZhbCA9IHVzZURpcmVjdFZhbHVlID8gbmV3VmFsIDogdG9SYXcobmV3VmFsKTsKICAgICAgaWYgKGhhc0NoYW5nZWQobmV3VmFsLCB0aGlzLl9yYXdWYWx1ZSkpIHsKICAgICAgICB0aGlzLl9yYXdWYWx1ZSA9IG5ld1ZhbDsKICAgICAgICB0aGlzLl92YWx1ZSA9IHVzZURpcmVjdFZhbHVlID8gbmV3VmFsIDogdG9SZWFjdGl2ZShuZXdWYWwpOwogICAgICAgIHRyaWdnZXJSZWZWYWx1ZSh0aGlzLCA0LCBuZXdWYWwpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyaWdnZXJSZWYocmVmMikgewogICAgdHJpZ2dlclJlZlZhbHVlKHJlZjIsIDQsIHJlZjIudmFsdWUgKTsKICB9CiAgZnVuY3Rpb24gdW5yZWYocmVmMikgewogICAgcmV0dXJuIGlzUmVmKHJlZjIpID8gcmVmMi52YWx1ZSA6IHJlZjI7CiAgfQogIGZ1bmN0aW9uIHRvVmFsdWUoc291cmNlKSB7CiAgICByZXR1cm4gaXNGdW5jdGlvbihzb3VyY2UpID8gc291cmNlKCkgOiB1bnJlZihzb3VyY2UpOwogIH0KICBjb25zdCBzaGFsbG93VW53cmFwSGFuZGxlcnMgPSB7CiAgICBnZXQ6ICh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpID0+IHVucmVmKFJlZmxlY3QuZ2V0KHRhcmdldCwga2V5LCByZWNlaXZlcikpLAogICAgc2V0OiAodGFyZ2V0LCBrZXksIHZhbHVlLCByZWNlaXZlcikgPT4gewogICAgICBjb25zdCBvbGRWYWx1ZSA9IHRhcmdldFtrZXldOwogICAgICBpZiAoaXNSZWYob2xkVmFsdWUpICYmICFpc1JlZih2YWx1ZSkpIHsKICAgICAgICBvbGRWYWx1ZS52YWx1ZSA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBSZWZsZWN0LnNldCh0YXJnZXQsIGtleSwgdmFsdWUsIHJlY2VpdmVyKTsKICAgICAgfQogICAgfQogIH07CiAgZnVuY3Rpb24gcHJveHlSZWZzKG9iamVjdFdpdGhSZWZzKSB7CiAgICByZXR1cm4gaXNSZWFjdGl2ZShvYmplY3RXaXRoUmVmcykgPyBvYmplY3RXaXRoUmVmcyA6IG5ldyBQcm94eShvYmplY3RXaXRoUmVmcywgc2hhbGxvd1Vud3JhcEhhbmRsZXJzKTsKICB9CiAgY2xhc3MgQ3VzdG9tUmVmSW1wbCB7CiAgICBjb25zdHJ1Y3RvcihmYWN0b3J5KSB7CiAgICAgIHRoaXMuZGVwID0gdm9pZCAwOwogICAgICB0aGlzLl9fdl9pc1JlZiA9IHRydWU7CiAgICAgIGNvbnN0IHsgZ2V0LCBzZXQgfSA9IGZhY3RvcnkoCiAgICAgICAgKCkgPT4gdHJhY2tSZWZWYWx1ZSh0aGlzKSwKICAgICAgICAoKSA9PiB0cmlnZ2VyUmVmVmFsdWUodGhpcykKICAgICAgKTsKICAgICAgdGhpcy5fZ2V0ID0gZ2V0OwogICAgICB0aGlzLl9zZXQgPSBzZXQ7CiAgICB9CiAgICBnZXQgdmFsdWUoKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXQoKTsKICAgIH0KICAgIHNldCB2YWx1ZShuZXdWYWwpIHsKICAgICAgdGhpcy5fc2V0KG5ld1ZhbCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGN1c3RvbVJlZihmYWN0b3J5KSB7CiAgICByZXR1cm4gbmV3IEN1c3RvbVJlZkltcGwoZmFjdG9yeSk7CiAgfQogIGZ1bmN0aW9uIHRvUmVmcyhvYmplY3QpIHsKICAgIGlmICghaXNQcm94eShvYmplY3QpKSB7CiAgICAgIHdhcm4kMihgdG9SZWZzKCkgZXhwZWN0cyBhIHJlYWN0aXZlIG9iamVjdCBidXQgcmVjZWl2ZWQgYSBwbGFpbiBvbmUuYCk7CiAgICB9CiAgICBjb25zdCByZXQgPSBpc0FycmF5KG9iamVjdCkgPyBuZXcgQXJyYXkob2JqZWN0Lmxlbmd0aCkgOiB7fTsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iamVjdCkgewogICAgICByZXRba2V5XSA9IHByb3BlcnR5VG9SZWYob2JqZWN0LCBrZXkpOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgY2xhc3MgT2JqZWN0UmVmSW1wbCB7CiAgICBjb25zdHJ1Y3Rvcihfb2JqZWN0LCBfa2V5LCBfZGVmYXVsdFZhbHVlKSB7CiAgICAgIHRoaXMuX29iamVjdCA9IF9vYmplY3Q7CiAgICAgIHRoaXMuX2tleSA9IF9rZXk7CiAgICAgIHRoaXMuX2RlZmF1bHRWYWx1ZSA9IF9kZWZhdWx0VmFsdWU7CiAgICAgIHRoaXMuX192X2lzUmVmID0gdHJ1ZTsKICAgIH0KICAgIGdldCB2YWx1ZSgpIHsKICAgICAgY29uc3QgdmFsID0gdGhpcy5fb2JqZWN0W3RoaXMuX2tleV07CiAgICAgIHJldHVybiB2YWwgPT09IHZvaWQgMCA/IHRoaXMuX2RlZmF1bHRWYWx1ZSA6IHZhbDsKICAgIH0KICAgIHNldCB2YWx1ZShuZXdWYWwpIHsKICAgICAgdGhpcy5fb2JqZWN0W3RoaXMuX2tleV0gPSBuZXdWYWw7CiAgICB9CiAgICBnZXQgZGVwKCkgewogICAgICByZXR1cm4gZ2V0RGVwRnJvbVJlYWN0aXZlKHRvUmF3KHRoaXMuX29iamVjdCksIHRoaXMuX2tleSk7CiAgICB9CiAgfQogIGNsYXNzIEdldHRlclJlZkltcGwgewogICAgY29uc3RydWN0b3IoX2dldHRlcikgewogICAgICB0aGlzLl9nZXR0ZXIgPSBfZ2V0dGVyOwogICAgICB0aGlzLl9fdl9pc1JlZiA9IHRydWU7CiAgICAgIHRoaXMuX192X2lzUmVhZG9ubHkgPSB0cnVlOwogICAgfQogICAgZ2V0IHZhbHVlKCkgewogICAgICByZXR1cm4gdGhpcy5fZ2V0dGVyKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRvUmVmKHNvdXJjZSwga2V5LCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmIChpc1JlZihzb3VyY2UpKSB7CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgICByZXR1cm4gbmV3IEdldHRlclJlZkltcGwoc291cmNlKTsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSAmJiBhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICByZXR1cm4gcHJvcGVydHlUb1JlZihzb3VyY2UsIGtleSwgZGVmYXVsdFZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiByZWYoc291cmNlKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gcHJvcGVydHlUb1JlZihzb3VyY2UsIGtleSwgZGVmYXVsdFZhbHVlKSB7CiAgICBjb25zdCB2YWwgPSBzb3VyY2Vba2V5XTsKICAgIHJldHVybiBpc1JlZih2YWwpID8gdmFsIDogbmV3IE9iamVjdFJlZkltcGwoc291cmNlLCBrZXksIGRlZmF1bHRWYWx1ZSk7CiAgfQoKICBjb25zdCBUcmFja09wVHlwZXMgPSB7CiAgICAiR0VUIjogImdldCIsCiAgICAiSEFTIjogImhhcyIsCiAgICAiSVRFUkFURSI6ICJpdGVyYXRlIgogIH07CiAgY29uc3QgVHJpZ2dlck9wVHlwZXMgPSB7CiAgICAiU0VUIjogInNldCIsCiAgICAiQUREIjogImFkZCIsCiAgICAiREVMRVRFIjogImRlbGV0ZSIsCiAgICAiQ0xFQVIiOiAiY2xlYXIiCiAgfTsKCiAgY29uc3Qgc3RhY2skMSA9IFtdOwogIGZ1bmN0aW9uIHB1c2hXYXJuaW5nQ29udGV4dCh2bm9kZSkgewogICAgc3RhY2skMS5wdXNoKHZub2RlKTsKICB9CiAgZnVuY3Rpb24gcG9wV2FybmluZ0NvbnRleHQoKSB7CiAgICBzdGFjayQxLnBvcCgpOwogIH0KICBmdW5jdGlvbiB3YXJuJDEobXNnLCAuLi5hcmdzKSB7CiAgICBwYXVzZVRyYWNraW5nKCk7CiAgICBjb25zdCBpbnN0YW5jZSA9IHN0YWNrJDEubGVuZ3RoID8gc3RhY2skMVtzdGFjayQxLmxlbmd0aCAtIDFdLmNvbXBvbmVudCA6IG51bGw7CiAgICBjb25zdCBhcHBXYXJuSGFuZGxlciA9IGluc3RhbmNlICYmIGluc3RhbmNlLmFwcENvbnRleHQuY29uZmlnLndhcm5IYW5kbGVyOwogICAgY29uc3QgdHJhY2UgPSBnZXRDb21wb25lbnRUcmFjZSgpOwogICAgaWYgKGFwcFdhcm5IYW5kbGVyKSB7CiAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZygKICAgICAgICBhcHBXYXJuSGFuZGxlciwKICAgICAgICBpbnN0YW5jZSwKICAgICAgICAxMSwKICAgICAgICBbCiAgICAgICAgICBtc2cgKyBhcmdzLm1hcCgoYSkgPT4gewogICAgICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgICAgICByZXR1cm4gKF9iID0gKF9hID0gYS50b1N0cmluZykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmNhbGwoYSkpICE9IG51bGwgPyBfYiA6IEpTT04uc3RyaW5naWZ5KGEpOwogICAgICAgICAgfSkuam9pbigiIiksCiAgICAgICAgICBpbnN0YW5jZSAmJiBpbnN0YW5jZS5wcm94eSwKICAgICAgICAgIHRyYWNlLm1hcCgKICAgICAgICAgICAgKHsgdm5vZGUgfSkgPT4gYGF0IDwke2Zvcm1hdENvbXBvbmVudE5hbWUoaW5zdGFuY2UsIHZub2RlLnR5cGUpfT5gCiAgICAgICAgICApLmpvaW4oIlxuIiksCiAgICAgICAgICB0cmFjZQogICAgICAgIF0KICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHdhcm5BcmdzID0gW2BbVnVlIHdhcm5dOiAke21zZ31gLCAuLi5hcmdzXTsKICAgICAgaWYgKHRyYWNlLmxlbmd0aCAmJiAvLyBhdm9pZCBzcGFtbWluZyBjb25zb2xlIGR1cmluZyB0ZXN0cwogICAgICB0cnVlKSB7CiAgICAgICAgd2FybkFyZ3MucHVzaChgCmAsIC4uLmZvcm1hdFRyYWNlKHRyYWNlKSk7CiAgICAgIH0KICAgICAgY29uc29sZS53YXJuKC4uLndhcm5BcmdzKTsKICAgIH0KICAgIHJlc2V0VHJhY2tpbmcoKTsKICB9CiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50VHJhY2UoKSB7CiAgICBsZXQgY3VycmVudFZOb2RlID0gc3RhY2skMVtzdGFjayQxLmxlbmd0aCAtIDFdOwogICAgaWYgKCFjdXJyZW50Vk5vZGUpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQogICAgY29uc3Qgbm9ybWFsaXplZFN0YWNrID0gW107CiAgICB3aGlsZSAoY3VycmVudFZOb2RlKSB7CiAgICAgIGNvbnN0IGxhc3QgPSBub3JtYWxpemVkU3RhY2tbMF07CiAgICAgIGlmIChsYXN0ICYmIGxhc3Qudm5vZGUgPT09IGN1cnJlbnRWTm9kZSkgewogICAgICAgIGxhc3QucmVjdXJzZUNvdW50Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9ybWFsaXplZFN0YWNrLnB1c2goewogICAgICAgICAgdm5vZGU6IGN1cnJlbnRWTm9kZSwKICAgICAgICAgIHJlY3Vyc2VDb3VudDogMAogICAgICAgIH0pOwogICAgICB9CiAgICAgIGNvbnN0IHBhcmVudEluc3RhbmNlID0gY3VycmVudFZOb2RlLmNvbXBvbmVudCAmJiBjdXJyZW50Vk5vZGUuY29tcG9uZW50LnBhcmVudDsKICAgICAgY3VycmVudFZOb2RlID0gcGFyZW50SW5zdGFuY2UgJiYgcGFyZW50SW5zdGFuY2Uudm5vZGU7CiAgICB9CiAgICByZXR1cm4gbm9ybWFsaXplZFN0YWNrOwogIH0KICBmdW5jdGlvbiBmb3JtYXRUcmFjZSh0cmFjZSkgewogICAgY29uc3QgbG9ncyA9IFtdOwogICAgdHJhY2UuZm9yRWFjaCgoZW50cnksIGkpID0+IHsKICAgICAgbG9ncy5wdXNoKC4uLmkgPT09IDAgPyBbXSA6IFtgCmBdLCAuLi5mb3JtYXRUcmFjZUVudHJ5KGVudHJ5KSk7CiAgICB9KTsKICAgIHJldHVybiBsb2dzOwogIH0KICBmdW5jdGlvbiBmb3JtYXRUcmFjZUVudHJ5KHsgdm5vZGUsIHJlY3Vyc2VDb3VudCB9KSB7CiAgICBjb25zdCBwb3N0Zml4ID0gcmVjdXJzZUNvdW50ID4gMCA/IGAuLi4gKCR7cmVjdXJzZUNvdW50fSByZWN1cnNpdmUgY2FsbHMpYCA6IGBgOwogICAgY29uc3QgaXNSb290ID0gdm5vZGUuY29tcG9uZW50ID8gdm5vZGUuY29tcG9uZW50LnBhcmVudCA9PSBudWxsIDogZmFsc2U7CiAgICBjb25zdCBvcGVuID0gYCBhdCA8JHtmb3JtYXRDb21wb25lbnROYW1lKAogICAgdm5vZGUuY29tcG9uZW50LAogICAgdm5vZGUudHlwZSwKICAgIGlzUm9vdAogICl9YDsKICAgIGNvbnN0IGNsb3NlID0gYD5gICsgcG9zdGZpeDsKICAgIHJldHVybiB2bm9kZS5wcm9wcyA/IFtvcGVuLCAuLi5mb3JtYXRQcm9wcyh2bm9kZS5wcm9wcyksIGNsb3NlXSA6IFtvcGVuICsgY2xvc2VdOwogIH0KICBmdW5jdGlvbiBmb3JtYXRQcm9wcyhwcm9wcykgewogICAgY29uc3QgcmVzID0gW107CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpOwogICAga2V5cy5zbGljZSgwLCAzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgcmVzLnB1c2goLi4uZm9ybWF0UHJvcChrZXksIHByb3BzW2tleV0pKTsKICAgIH0pOwogICAgaWYgKGtleXMubGVuZ3RoID4gMykgewogICAgICByZXMucHVzaChgIC4uLmApOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UHJvcChrZXksIHZhbHVlLCByYXcpIHsKICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgIHJldHVybiByYXcgPyB2YWx1ZSA6IFtgJHtrZXl9PSR7dmFsdWV9YF07CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT0gbnVsbCkgewogICAgICByZXR1cm4gcmF3ID8gdmFsdWUgOiBbYCR7a2V5fT0ke3ZhbHVlfWBdOwogICAgfSBlbHNlIGlmIChpc1JlZih2YWx1ZSkpIHsKICAgICAgdmFsdWUgPSBmb3JtYXRQcm9wKGtleSwgdG9SYXcodmFsdWUudmFsdWUpLCB0cnVlKTsKICAgICAgcmV0dXJuIHJhdyA/IHZhbHVlIDogW2Ake2tleX09UmVmPGAsIHZhbHVlLCBgPmBdOwogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICByZXR1cm4gW2Ake2tleX09Zm4ke3ZhbHVlLm5hbWUgPyBgPCR7dmFsdWUubmFtZX0+YCA6IGBgfWBdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSB0b1Jhdyh2YWx1ZSk7CiAgICAgIHJldHVybiByYXcgPyB2YWx1ZSA6IFtgJHtrZXl9PWAsIHZhbHVlXTsKICAgIH0KICB9CiAgZnVuY3Rpb24gYXNzZXJ0TnVtYmVyKHZhbCwgdHlwZSkgewogICAgaWYgKHZhbCA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCAhPT0gIm51bWJlciIpIHsKICAgICAgd2FybiQxKGAke3R5cGV9IGlzIG5vdCBhIHZhbGlkIG51bWJlciAtIGdvdCAke0pTT04uc3RyaW5naWZ5KHZhbCl9LmApOwogICAgfSBlbHNlIGlmIChpc05hTih2YWwpKSB7CiAgICAgIHdhcm4kMShgJHt0eXBlfSBpcyBOYU4gLSB0aGUgZHVyYXRpb24gZXhwcmVzc2lvbiBtaWdodCBiZSBpbmNvcnJlY3QuYCk7CiAgICB9CiAgfQoKICBjb25zdCBFcnJvckNvZGVzID0gewogICAgIlNFVFVQX0ZVTkNUSU9OIjogMCwKICAgICIwIjogIlNFVFVQX0ZVTkNUSU9OIiwKICAgICJSRU5ERVJfRlVOQ1RJT04iOiAxLAogICAgIjEiOiAiUkVOREVSX0ZVTkNUSU9OIiwKICAgICJXQVRDSF9HRVRURVIiOiAyLAogICAgIjIiOiAiV0FUQ0hfR0VUVEVSIiwKICAgICJXQVRDSF9DQUxMQkFDSyI6IDMsCiAgICAiMyI6ICJXQVRDSF9DQUxMQkFDSyIsCiAgICAiV0FUQ0hfQ0xFQU5VUCI6IDQsCiAgICAiNCI6ICJXQVRDSF9DTEVBTlVQIiwKICAgICJOQVRJVkVfRVZFTlRfSEFORExFUiI6IDUsCiAgICAiNSI6ICJOQVRJVkVfRVZFTlRfSEFORExFUiIsCiAgICAiQ09NUE9ORU5UX0VWRU5UX0hBTkRMRVIiOiA2LAogICAgIjYiOiAiQ09NUE9ORU5UX0VWRU5UX0hBTkRMRVIiLAogICAgIlZOT0RFX0hPT0siOiA3LAogICAgIjciOiAiVk5PREVfSE9PSyIsCiAgICAiRElSRUNUSVZFX0hPT0siOiA4LAogICAgIjgiOiAiRElSRUNUSVZFX0hPT0siLAogICAgIlRSQU5TSVRJT05fSE9PSyI6IDksCiAgICAiOSI6ICJUUkFOU0lUSU9OX0hPT0siLAogICAgIkFQUF9FUlJPUl9IQU5ETEVSIjogMTAsCiAgICAiMTAiOiAiQVBQX0VSUk9SX0hBTkRMRVIiLAogICAgIkFQUF9XQVJOX0hBTkRMRVIiOiAxMSwKICAgICIxMSI6ICJBUFBfV0FSTl9IQU5ETEVSIiwKICAgICJGVU5DVElPTl9SRUYiOiAxMiwKICAgICIxMiI6ICJGVU5DVElPTl9SRUYiLAogICAgIkFTWU5DX0NPTVBPTkVOVF9MT0FERVIiOiAxMywKICAgICIxMyI6ICJBU1lOQ19DT01QT05FTlRfTE9BREVSIiwKICAgICJTQ0hFRFVMRVIiOiAxNCwKICAgICIxNCI6ICJTQ0hFRFVMRVIiCiAgfTsKICBjb25zdCBFcnJvclR5cGVTdHJpbmdzJDEgPSB7CiAgICBbInNwIl06ICJzZXJ2ZXJQcmVmZXRjaCBob29rIiwKICAgIFsiYmMiXTogImJlZm9yZUNyZWF0ZSBob29rIiwKICAgIFsiYyJdOiAiY3JlYXRlZCBob29rIiwKICAgIFsiYm0iXTogImJlZm9yZU1vdW50IGhvb2siLAogICAgWyJtIl06ICJtb3VudGVkIGhvb2siLAogICAgWyJidSJdOiAiYmVmb3JlVXBkYXRlIGhvb2siLAogICAgWyJ1Il06ICJ1cGRhdGVkIiwKICAgIFsiYnVtIl06ICJiZWZvcmVVbm1vdW50IGhvb2siLAogICAgWyJ1bSJdOiAidW5tb3VudGVkIGhvb2siLAogICAgWyJhIl06ICJhY3RpdmF0ZWQgaG9vayIsCiAgICBbImRhIl06ICJkZWFjdGl2YXRlZCBob29rIiwKICAgIFsiZWMiXTogImVycm9yQ2FwdHVyZWQgaG9vayIsCiAgICBbInJ0YyJdOiAicmVuZGVyVHJhY2tlZCBob29rIiwKICAgIFsicnRnIl06ICJyZW5kZXJUcmlnZ2VyZWQgaG9vayIsCiAgICBbMF06ICJzZXR1cCBmdW5jdGlvbiIsCiAgICBbMV06ICJyZW5kZXIgZnVuY3Rpb24iLAogICAgWzJdOiAid2F0Y2hlciBnZXR0ZXIiLAogICAgWzNdOiAid2F0Y2hlciBjYWxsYmFjayIsCiAgICBbNF06ICJ3YXRjaGVyIGNsZWFudXAgZnVuY3Rpb24iLAogICAgWzVdOiAibmF0aXZlIGV2ZW50IGhhbmRsZXIiLAogICAgWzZdOiAiY29tcG9uZW50IGV2ZW50IGhhbmRsZXIiLAogICAgWzddOiAidm5vZGUgaG9vayIsCiAgICBbOF06ICJkaXJlY3RpdmUgaG9vayIsCiAgICBbOV06ICJ0cmFuc2l0aW9uIGhvb2siLAogICAgWzEwXTogImFwcCBlcnJvckhhbmRsZXIiLAogICAgWzExXTogImFwcCB3YXJuSGFuZGxlciIsCiAgICBbMTJdOiAicmVmIGZ1bmN0aW9uIiwKICAgIFsxM106ICJhc3luYyBjb21wb25lbnQgbG9hZGVyIiwKICAgIFsxNF06ICJzY2hlZHVsZXIgZmx1c2guIFRoaXMgaXMgbGlrZWx5IGEgVnVlIGludGVybmFscyBidWcuIFBsZWFzZSBvcGVuIGFuIGlzc3VlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy9jb3JlIC4iCiAgfTsKICBmdW5jdGlvbiBjYWxsV2l0aEVycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCB0eXBlLCBhcmdzKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXJncyA/IGZuKC4uLmFyZ3MpIDogZm4oKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICBoYW5kbGVFcnJvcihlcnIsIGluc3RhbmNlLCB0eXBlKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCB0eXBlLCBhcmdzKSB7CiAgICBpZiAoaXNGdW5jdGlvbihmbikpIHsKICAgICAgY29uc3QgcmVzID0gY2FsbFdpdGhFcnJvckhhbmRsaW5nKGZuLCBpbnN0YW5jZSwgdHlwZSwgYXJncyk7CiAgICAgIGlmIChyZXMgJiYgaXNQcm9taXNlKHJlcykpIHsKICAgICAgICByZXMuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgaGFuZGxlRXJyb3IoZXJyLCBpbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0KICAgIGNvbnN0IHZhbHVlcyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmbi5sZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXMucHVzaChjYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyhmbltpXSwgaW5zdGFuY2UsIHR5cGUsIGFyZ3MpKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZXM7CiAgfQogIGZ1bmN0aW9uIGhhbmRsZUVycm9yKGVyciwgaW5zdGFuY2UsIHR5cGUsIHRocm93SW5EZXYgPSB0cnVlKSB7CiAgICBjb25zdCBjb250ZXh0Vk5vZGUgPSBpbnN0YW5jZSA/IGluc3RhbmNlLnZub2RlIDogbnVsbDsKICAgIGlmIChpbnN0YW5jZSkgewogICAgICBsZXQgY3VyID0gaW5zdGFuY2UucGFyZW50OwogICAgICBjb25zdCBleHBvc2VkSW5zdGFuY2UgPSBpbnN0YW5jZS5wcm94eTsKICAgICAgY29uc3QgZXJyb3JJbmZvID0gRXJyb3JUeXBlU3RyaW5ncyQxW3R5cGVdIDsKICAgICAgd2hpbGUgKGN1cikgewogICAgICAgIGNvbnN0IGVycm9yQ2FwdHVyZWRIb29rcyA9IGN1ci5lYzsKICAgICAgICBpZiAoZXJyb3JDYXB0dXJlZEhvb2tzKSB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVycm9yQ2FwdHVyZWRIb29rcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAoZXJyb3JDYXB0dXJlZEhvb2tzW2ldKGVyciwgZXhwb3NlZEluc3RhbmNlLCBlcnJvckluZm8pID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjdXIgPSBjdXIucGFyZW50OwogICAgICB9CiAgICAgIGNvbnN0IGFwcEVycm9ySGFuZGxlciA9IGluc3RhbmNlLmFwcENvbnRleHQuY29uZmlnLmVycm9ySGFuZGxlcjsKICAgICAgaWYgKGFwcEVycm9ySGFuZGxlcikgewogICAgICAgIGNhbGxXaXRoRXJyb3JIYW5kbGluZygKICAgICAgICAgIGFwcEVycm9ySGFuZGxlciwKICAgICAgICAgIG51bGwsCiAgICAgICAgICAxMCwKICAgICAgICAgIFtlcnIsIGV4cG9zZWRJbnN0YW5jZSwgZXJyb3JJbmZvXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgICBsb2dFcnJvcihlcnIsIHR5cGUsIGNvbnRleHRWTm9kZSwgdGhyb3dJbkRldik7CiAgfQogIGZ1bmN0aW9uIGxvZ0Vycm9yKGVyciwgdHlwZSwgY29udGV4dFZOb2RlLCB0aHJvd0luRGV2ID0gdHJ1ZSkgewogICAgewogICAgICBjb25zdCBpbmZvID0gRXJyb3JUeXBlU3RyaW5ncyQxW3R5cGVdOwogICAgICBpZiAoY29udGV4dFZOb2RlKSB7CiAgICAgICAgcHVzaFdhcm5pbmdDb250ZXh0KGNvbnRleHRWTm9kZSk7CiAgICAgIH0KICAgICAgd2FybiQxKGBVbmhhbmRsZWQgZXJyb3Ike2luZm8gPyBgIGR1cmluZyBleGVjdXRpb24gb2YgJHtpbmZvfWAgOiBgYH1gKTsKICAgICAgaWYgKGNvbnRleHRWTm9kZSkgewogICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7CiAgICAgIH0KICAgICAgaWYgKHRocm93SW5EZXYpIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOwogICAgICB9CiAgICB9CiAgfQoKICBsZXQgaXNGbHVzaGluZyA9IGZhbHNlOwogIGxldCBpc0ZsdXNoUGVuZGluZyA9IGZhbHNlOwogIGNvbnN0IHF1ZXVlID0gW107CiAgbGV0IGZsdXNoSW5kZXggPSAwOwogIGNvbnN0IHBlbmRpbmdQb3N0Rmx1c2hDYnMgPSBbXTsKICBsZXQgYWN0aXZlUG9zdEZsdXNoQ2JzID0gbnVsbDsKICBsZXQgcG9zdEZsdXNoSW5kZXggPSAwOwogIGNvbnN0IHJlc29sdmVkUHJvbWlzZSA9IC8qIEBfX1BVUkVfXyAqLyBQcm9taXNlLnJlc29sdmUoKTsKICBsZXQgY3VycmVudEZsdXNoUHJvbWlzZSA9IG51bGw7CiAgY29uc3QgUkVDVVJTSU9OX0xJTUlUID0gMTAwOwogIGZ1bmN0aW9uIG5leHRUaWNrKGZuKSB7CiAgICBjb25zdCBwID0gY3VycmVudEZsdXNoUHJvbWlzZSB8fCByZXNvbHZlZFByb21pc2U7CiAgICByZXR1cm4gZm4gPyBwLnRoZW4odGhpcyA/IGZuLmJpbmQodGhpcykgOiBmbikgOiBwOwogIH0KICBmdW5jdGlvbiBmaW5kSW5zZXJ0aW9uSW5kZXgoaWQpIHsKICAgIGxldCBzdGFydCA9IGZsdXNoSW5kZXggKyAxOwogICAgbGV0IGVuZCA9IHF1ZXVlLmxlbmd0aDsKICAgIHdoaWxlIChzdGFydCA8IGVuZCkgewogICAgICBjb25zdCBtaWRkbGUgPSBzdGFydCArIGVuZCA+Pj4gMTsKICAgICAgY29uc3QgbWlkZGxlSm9iID0gcXVldWVbbWlkZGxlXTsKICAgICAgY29uc3QgbWlkZGxlSm9iSWQgPSBnZXRJZChtaWRkbGVKb2IpOwogICAgICBpZiAobWlkZGxlSm9iSWQgPCBpZCB8fCBtaWRkbGVKb2JJZCA9PT0gaWQgJiYgbWlkZGxlSm9iLnByZSkgewogICAgICAgIHN0YXJ0ID0gbWlkZGxlICsgMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmQgPSBtaWRkbGU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzdGFydDsKICB9CiAgZnVuY3Rpb24gcXVldWVKb2Ioam9iKSB7CiAgICBpZiAoIXF1ZXVlLmxlbmd0aCB8fCAhcXVldWUuaW5jbHVkZXMoCiAgICAgIGpvYiwKICAgICAgaXNGbHVzaGluZyAmJiBqb2IuYWxsb3dSZWN1cnNlID8gZmx1c2hJbmRleCArIDEgOiBmbHVzaEluZGV4CiAgICApKSB7CiAgICAgIGlmIChqb2IuaWQgPT0gbnVsbCkgewogICAgICAgIHF1ZXVlLnB1c2goam9iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWV1ZS5zcGxpY2UoZmluZEluc2VydGlvbkluZGV4KGpvYi5pZCksIDAsIGpvYik7CiAgICAgIH0KICAgICAgcXVldWVGbHVzaCgpOwogICAgfQogIH0KICBmdW5jdGlvbiBxdWV1ZUZsdXNoKCkgewogICAgaWYgKCFpc0ZsdXNoaW5nICYmICFpc0ZsdXNoUGVuZGluZykgewogICAgICBpc0ZsdXNoUGVuZGluZyA9IHRydWU7CiAgICAgIGN1cnJlbnRGbHVzaFByb21pc2UgPSByZXNvbHZlZFByb21pc2UudGhlbihmbHVzaEpvYnMpOwogICAgfQogIH0KICBmdW5jdGlvbiBpbnZhbGlkYXRlSm9iKGpvYikgewogICAgY29uc3QgaSA9IHF1ZXVlLmluZGV4T2Yoam9iKTsKICAgIGlmIChpID4gZmx1c2hJbmRleCkgewogICAgICBxdWV1ZS5zcGxpY2UoaSwgMSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHF1ZXVlUG9zdEZsdXNoQ2IoY2IpIHsKICAgIGlmICghaXNBcnJheShjYikpIHsKICAgICAgaWYgKCFhY3RpdmVQb3N0Rmx1c2hDYnMgfHwgIWFjdGl2ZVBvc3RGbHVzaENicy5pbmNsdWRlcygKICAgICAgICBjYiwKICAgICAgICBjYi5hbGxvd1JlY3Vyc2UgPyBwb3N0Rmx1c2hJbmRleCArIDEgOiBwb3N0Rmx1c2hJbmRleAogICAgICApKSB7CiAgICAgICAgcGVuZGluZ1Bvc3RGbHVzaENicy5wdXNoKGNiKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcGVuZGluZ1Bvc3RGbHVzaENicy5wdXNoKC4uLmNiKTsKICAgIH0KICAgIHF1ZXVlRmx1c2goKTsKICB9CiAgZnVuY3Rpb24gZmx1c2hQcmVGbHVzaENicyhpbnN0YW5jZSwgc2VlbiwgaSA9IGlzRmx1c2hpbmcgPyBmbHVzaEluZGV4ICsgMSA6IDApIHsKICAgIHsKICAgICAgc2VlbiA9IHNlZW4gfHwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIH0KICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY2IgPSBxdWV1ZVtpXTsKICAgICAgaWYgKGNiICYmIGNiLnByZSkgewogICAgICAgIGlmIChpbnN0YW5jZSAmJiBjYi5pZCAhPT0gaW5zdGFuY2UudWlkKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoZWNrUmVjdXJzaXZlVXBkYXRlcyhzZWVuLCBjYikpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5zcGxpY2UoaSwgMSk7CiAgICAgICAgaS0tOwogICAgICAgIGNiKCk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZmx1c2hQb3N0Rmx1c2hDYnMoc2VlbikgewogICAgaWYgKHBlbmRpbmdQb3N0Rmx1c2hDYnMubGVuZ3RoKSB7CiAgICAgIGNvbnN0IGRlZHVwZWQgPSBbLi4ubmV3IFNldChwZW5kaW5nUG9zdEZsdXNoQ2JzKV0uc29ydCgKICAgICAgICAoYSwgYikgPT4gZ2V0SWQoYSkgLSBnZXRJZChiKQogICAgICApOwogICAgICBwZW5kaW5nUG9zdEZsdXNoQ2JzLmxlbmd0aCA9IDA7CiAgICAgIGlmIChhY3RpdmVQb3N0Rmx1c2hDYnMpIHsKICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnMucHVzaCguLi5kZWR1cGVkKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgYWN0aXZlUG9zdEZsdXNoQ2JzID0gZGVkdXBlZDsKICAgICAgewogICAgICAgIHNlZW4gPSBzZWVuIHx8IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIH0KICAgICAgZm9yIChwb3N0Rmx1c2hJbmRleCA9IDA7IHBvc3RGbHVzaEluZGV4IDwgYWN0aXZlUG9zdEZsdXNoQ2JzLmxlbmd0aDsgcG9zdEZsdXNoSW5kZXgrKykgewogICAgICAgIGlmIChjaGVja1JlY3Vyc2l2ZVVwZGF0ZXMoc2VlbiwgYWN0aXZlUG9zdEZsdXNoQ2JzW3Bvc3RGbHVzaEluZGV4XSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBhY3RpdmVQb3N0Rmx1c2hDYnNbcG9zdEZsdXNoSW5kZXhdKCk7CiAgICAgIH0KICAgICAgYWN0aXZlUG9zdEZsdXNoQ2JzID0gbnVsbDsKICAgICAgcG9zdEZsdXNoSW5kZXggPSAwOwogICAgfQogIH0KICBjb25zdCBnZXRJZCA9IChqb2IpID0+IGpvYi5pZCA9PSBudWxsID8gSW5maW5pdHkgOiBqb2IuaWQ7CiAgY29uc3QgY29tcGFyYXRvciA9IChhLCBiKSA9PiB7CiAgICBjb25zdCBkaWZmID0gZ2V0SWQoYSkgLSBnZXRJZChiKTsKICAgIGlmIChkaWZmID09PSAwKSB7CiAgICAgIGlmIChhLnByZSAmJiAhYi5wcmUpCiAgICAgICAgcmV0dXJuIC0xOwogICAgICBpZiAoYi5wcmUgJiYgIWEucHJlKQogICAgICAgIHJldHVybiAxOwogICAgfQogICAgcmV0dXJuIGRpZmY7CiAgfTsKICBmdW5jdGlvbiBmbHVzaEpvYnMoc2VlbikgewogICAgaXNGbHVzaFBlbmRpbmcgPSBmYWxzZTsKICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgewogICAgICBzZWVuID0gc2VlbiB8fCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgfQogICAgcXVldWUuc29ydChjb21wYXJhdG9yKTsKICAgIGNvbnN0IGNoZWNrID0gKGpvYikgPT4gY2hlY2tSZWN1cnNpdmVVcGRhdGVzKHNlZW4sIGpvYikgOwogICAgdHJ5IHsKICAgICAgZm9yIChmbHVzaEluZGV4ID0gMDsgZmx1c2hJbmRleCA8IHF1ZXVlLmxlbmd0aDsgZmx1c2hJbmRleCsrKSB7CiAgICAgICAgY29uc3Qgam9iID0gcXVldWVbZmx1c2hJbmRleF07CiAgICAgICAgaWYgKGpvYiAmJiBqb2IuYWN0aXZlICE9PSBmYWxzZSkgewogICAgICAgICAgaWYgKGNoZWNrKGpvYikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcoam9iLCBudWxsLCAxNCk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBmbHVzaEluZGV4ID0gMDsKICAgICAgcXVldWUubGVuZ3RoID0gMDsKICAgICAgZmx1c2hQb3N0Rmx1c2hDYnMoc2Vlbik7CiAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgY3VycmVudEZsdXNoUHJvbWlzZSA9IG51bGw7CiAgICAgIGlmIChxdWV1ZS5sZW5ndGggfHwgcGVuZGluZ1Bvc3RGbHVzaENicy5sZW5ndGgpIHsKICAgICAgICBmbHVzaEpvYnMoc2Vlbik7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY2hlY2tSZWN1cnNpdmVVcGRhdGVzKHNlZW4sIGZuKSB7CiAgICBpZiAoIXNlZW4uaGFzKGZuKSkgewogICAgICBzZWVuLnNldChmbiwgMSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBjb3VudCA9IHNlZW4uZ2V0KGZuKTsKICAgICAgaWYgKGNvdW50ID4gUkVDVVJTSU9OX0xJTUlUKSB7CiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBmbi5vd25lckluc3RhbmNlOwogICAgICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBpbnN0YW5jZSAmJiBnZXRDb21wb25lbnROYW1lKGluc3RhbmNlLnR5cGUpOwogICAgICAgIGhhbmRsZUVycm9yKAogICAgICAgICAgYE1heGltdW0gcmVjdXJzaXZlIHVwZGF0ZXMgZXhjZWVkZWQke2NvbXBvbmVudE5hbWUgPyBgIGluIGNvbXBvbmVudCA8JHtjb21wb25lbnROYW1lfT5gIDogYGB9LiBUaGlzIG1lYW5zIHlvdSBoYXZlIGEgcmVhY3RpdmUgZWZmZWN0IHRoYXQgaXMgbXV0YXRpbmcgaXRzIG93biBkZXBlbmRlbmNpZXMgYW5kIHRodXMgcmVjdXJzaXZlbHkgdHJpZ2dlcmluZyBpdHNlbGYuIFBvc3NpYmxlIHNvdXJjZXMgaW5jbHVkZSBjb21wb25lbnQgdGVtcGxhdGUsIHJlbmRlciBmdW5jdGlvbiwgdXBkYXRlZCBob29rIG9yIHdhdGNoZXIgc291cmNlIGZ1bmN0aW9uLmAsCiAgICAgICAgICBudWxsLAogICAgICAgICAgMTAKICAgICAgICApOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIHNlZW4uc2V0KGZuLCBjb3VudCArIDEpOwogICAgICB9CiAgICB9CiAgfQoKICBsZXQgaXNIbXJVcGRhdGluZyA9IGZhbHNlOwogIGNvbnN0IGhtckRpcnR5Q29tcG9uZW50cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgewogICAgZ2V0R2xvYmFsVGhpcygpLl9fVlVFX0hNUl9SVU5USU1FX18gPSB7CiAgICAgIGNyZWF0ZVJlY29yZDogdHJ5V3JhcChjcmVhdGVSZWNvcmQpLAogICAgICByZXJlbmRlcjogdHJ5V3JhcChyZXJlbmRlciksCiAgICAgIHJlbG9hZDogdHJ5V3JhcChyZWxvYWQpCiAgICB9OwogIH0KICBjb25zdCBtYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGZ1bmN0aW9uIHJlZ2lzdGVySE1SKGluc3RhbmNlKSB7CiAgICBjb25zdCBpZCA9IGluc3RhbmNlLnR5cGUuX19obXJJZDsKICAgIGxldCByZWNvcmQgPSBtYXAuZ2V0KGlkKTsKICAgIGlmICghcmVjb3JkKSB7CiAgICAgIGNyZWF0ZVJlY29yZChpZCwgaW5zdGFuY2UudHlwZSk7CiAgICAgIHJlY29yZCA9IG1hcC5nZXQoaWQpOwogICAgfQogICAgcmVjb3JkLmluc3RhbmNlcy5hZGQoaW5zdGFuY2UpOwogIH0KICBmdW5jdGlvbiB1bnJlZ2lzdGVySE1SKGluc3RhbmNlKSB7CiAgICBtYXAuZ2V0KGluc3RhbmNlLnR5cGUuX19obXJJZCkuaW5zdGFuY2VzLmRlbGV0ZShpbnN0YW5jZSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVJlY29yZChpZCwgaW5pdGlhbERlZikgewogICAgaWYgKG1hcC5oYXMoaWQpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIG1hcC5zZXQoaWQsIHsKICAgICAgaW5pdGlhbERlZjogbm9ybWFsaXplQ2xhc3NDb21wb25lbnQoaW5pdGlhbERlZiksCiAgICAgIGluc3RhbmNlczogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKQogICAgfSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplQ2xhc3NDb21wb25lbnQoY29tcG9uZW50KSB7CiAgICByZXR1cm4gaXNDbGFzc0NvbXBvbmVudChjb21wb25lbnQpID8gY29tcG9uZW50Ll9fdmNjT3B0cyA6IGNvbXBvbmVudDsKICB9CiAgZnVuY3Rpb24gcmVyZW5kZXIoaWQsIG5ld1JlbmRlcikgewogICAgY29uc3QgcmVjb3JkID0gbWFwLmdldChpZCk7CiAgICBpZiAoIXJlY29yZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZWNvcmQuaW5pdGlhbERlZi5yZW5kZXIgPSBuZXdSZW5kZXI7CiAgICBbLi4ucmVjb3JkLmluc3RhbmNlc10uZm9yRWFjaCgoaW5zdGFuY2UpID0+IHsKICAgICAgaWYgKG5ld1JlbmRlcikgewogICAgICAgIGluc3RhbmNlLnJlbmRlciA9IG5ld1JlbmRlcjsKICAgICAgICBub3JtYWxpemVDbGFzc0NvbXBvbmVudChpbnN0YW5jZS50eXBlKS5yZW5kZXIgPSBuZXdSZW5kZXI7CiAgICAgIH0KICAgICAgaW5zdGFuY2UucmVuZGVyQ2FjaGUgPSBbXTsKICAgICAgaXNIbXJVcGRhdGluZyA9IHRydWU7CiAgICAgIGluc3RhbmNlLmVmZmVjdC5kaXJ0eSA9IHRydWU7CiAgICAgIGluc3RhbmNlLnVwZGF0ZSgpOwogICAgICBpc0htclVwZGF0aW5nID0gZmFsc2U7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gcmVsb2FkKGlkLCBuZXdDb21wKSB7CiAgICBjb25zdCByZWNvcmQgPSBtYXAuZ2V0KGlkKTsKICAgIGlmICghcmVjb3JkKQogICAgICByZXR1cm47CiAgICBuZXdDb21wID0gbm9ybWFsaXplQ2xhc3NDb21wb25lbnQobmV3Q29tcCk7CiAgICB1cGRhdGVDb21wb25lbnREZWYocmVjb3JkLmluaXRpYWxEZWYsIG5ld0NvbXApOwogICAgY29uc3QgaW5zdGFuY2VzID0gWy4uLnJlY29yZC5pbnN0YW5jZXNdOwogICAgZm9yIChjb25zdCBpbnN0YW5jZSBvZiBpbnN0YW5jZXMpIHsKICAgICAgY29uc3Qgb2xkQ29tcCA9IG5vcm1hbGl6ZUNsYXNzQ29tcG9uZW50KGluc3RhbmNlLnR5cGUpOwogICAgICBpZiAoIWhtckRpcnR5Q29tcG9uZW50cy5oYXMob2xkQ29tcCkpIHsKICAgICAgICBpZiAob2xkQ29tcCAhPT0gcmVjb3JkLmluaXRpYWxEZWYpIHsKICAgICAgICAgIHVwZGF0ZUNvbXBvbmVudERlZihvbGRDb21wLCBuZXdDb21wKTsKICAgICAgICB9CiAgICAgICAgaG1yRGlydHlDb21wb25lbnRzLmFkZChvbGRDb21wKTsKICAgICAgfQogICAgICBpbnN0YW5jZS5hcHBDb250ZXh0LnByb3BzQ2FjaGUuZGVsZXRlKGluc3RhbmNlLnR5cGUpOwogICAgICBpbnN0YW5jZS5hcHBDb250ZXh0LmVtaXRzQ2FjaGUuZGVsZXRlKGluc3RhbmNlLnR5cGUpOwogICAgICBpbnN0YW5jZS5hcHBDb250ZXh0Lm9wdGlvbnNDYWNoZS5kZWxldGUoaW5zdGFuY2UudHlwZSk7CiAgICAgIGlmIChpbnN0YW5jZS5jZVJlbG9hZCkgewogICAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5hZGQob2xkQ29tcCk7CiAgICAgICAgaW5zdGFuY2UuY2VSZWxvYWQobmV3Q29tcC5zdHlsZXMpOwogICAgICAgIGhtckRpcnR5Q29tcG9uZW50cy5kZWxldGUob2xkQ29tcCk7CiAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2UucGFyZW50KSB7CiAgICAgICAgaW5zdGFuY2UucGFyZW50LmVmZmVjdC5kaXJ0eSA9IHRydWU7CiAgICAgICAgcXVldWVKb2IoaW5zdGFuY2UucGFyZW50LnVwZGF0ZSk7CiAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2UuYXBwQ29udGV4dC5yZWxvYWQpIHsKICAgICAgICBpbnN0YW5jZS5hcHBDb250ZXh0LnJlbG9hZCgpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAgICJbSE1SXSBSb290IG9yIG1hbnVhbGx5IG1vdW50ZWQgaW5zdGFuY2UgbW9kaWZpZWQuIEZ1bGwgcmVsb2FkIHJlcXVpcmVkLiIKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBxdWV1ZVBvc3RGbHVzaENiKCgpID0+IHsKICAgICAgZm9yIChjb25zdCBpbnN0YW5jZSBvZiBpbnN0YW5jZXMpIHsKICAgICAgICBobXJEaXJ0eUNvbXBvbmVudHMuZGVsZXRlKAogICAgICAgICAgbm9ybWFsaXplQ2xhc3NDb21wb25lbnQoaW5zdGFuY2UudHlwZSkKICAgICAgICApOwogICAgICB9CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50RGVmKG9sZENvbXAsIG5ld0NvbXApIHsKICAgIGV4dGVuZChvbGRDb21wLCBuZXdDb21wKTsKICAgIGZvciAoY29uc3Qga2V5IGluIG9sZENvbXApIHsKICAgICAgaWYgKGtleSAhPT0gIl9fZmlsZSIgJiYgIShrZXkgaW4gbmV3Q29tcCkpIHsKICAgICAgICBkZWxldGUgb2xkQ29tcFtrZXldOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVdyYXAoZm4pIHsKICAgIHJldHVybiAoaWQsIGFyZykgPT4gewogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbihpZCwgYXJnKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgY29uc29sZS53YXJuKAogICAgICAgICAgYFtITVJdIFNvbWV0aGluZyB3ZW50IHdyb25nIGR1cmluZyBWdWUgY29tcG9uZW50IGhvdC1yZWxvYWQuIEZ1bGwgcmVsb2FkIHJlcXVpcmVkLmAKICAgICAgICApOwogICAgICB9CiAgICB9OwogIH0KCiAgbGV0IGRldnRvb2xzJDE7CiAgbGV0IGJ1ZmZlciA9IFtdOwogIGxldCBkZXZ0b29sc05vdEluc3RhbGxlZCA9IGZhbHNlOwogIGZ1bmN0aW9uIGVtaXQkMShldmVudCwgLi4uYXJncykgewogICAgaWYgKGRldnRvb2xzJDEpIHsKICAgICAgZGV2dG9vbHMkMS5lbWl0KGV2ZW50LCAuLi5hcmdzKTsKICAgIH0gZWxzZSBpZiAoIWRldnRvb2xzTm90SW5zdGFsbGVkKSB7CiAgICAgIGJ1ZmZlci5wdXNoKHsgZXZlbnQsIGFyZ3MgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNldERldnRvb2xzSG9vayQxKGhvb2ssIHRhcmdldCkgewogICAgdmFyIF9hLCBfYjsKICAgIGRldnRvb2xzJDEgPSBob29rOwogICAgaWYgKGRldnRvb2xzJDEpIHsKICAgICAgZGV2dG9vbHMkMS5lbmFibGVkID0gdHJ1ZTsKICAgICAgYnVmZmVyLmZvckVhY2goKHsgZXZlbnQsIGFyZ3MgfSkgPT4gZGV2dG9vbHMkMS5lbWl0KGV2ZW50LCAuLi5hcmdzKSk7CiAgICAgIGJ1ZmZlciA9IFtdOwogICAgfSBlbHNlIGlmICgKICAgICAgLy8gaGFuZGxlIGxhdGUgZGV2dG9vbHMgaW5qZWN0aW9uIC0gb25seSBkbyB0aGlzIGlmIHdlIGFyZSBpbiBhbiBhY3R1YWwKICAgICAgLy8gYnJvd3NlciBlbnZpcm9ubWVudCB0byBhdm9pZCB0aGUgdGltZXIgaGFuZGxlIHN0YWxsaW5nIHRlc3QgcnVubmVyIGV4aXQKICAgICAgLy8gKCM0ODE1KQogICAgICB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiAvLyBzb21lIGVudnMgbW9jayB3aW5kb3cgYnV0IG5vdCBmdWxseQogICAgICB3aW5kb3cuSFRNTEVsZW1lbnQgJiYgLy8gYWxzbyBleGNsdWRlIGpzZG9tCiAgICAgICEoKF9iID0gKF9hID0gd2luZG93Lm5hdmlnYXRvcikgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnVzZXJBZ2VudCkgPT0gbnVsbCA/IHZvaWQgMCA6IF9iLmluY2x1ZGVzKCJqc2RvbSIpKQogICAgKSB7CiAgICAgIGNvbnN0IHJlcGxheSA9IHRhcmdldC5fX1ZVRV9ERVZUT09MU19IT09LX1JFUExBWV9fID0gdGFyZ2V0Ll9fVlVFX0RFVlRPT0xTX0hPT0tfUkVQTEFZX18gfHwgW107CiAgICAgIHJlcGxheS5wdXNoKChuZXdIb29rKSA9PiB7CiAgICAgICAgc2V0RGV2dG9vbHNIb29rJDEobmV3SG9vaywgdGFyZ2V0KTsKICAgICAgfSk7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIGlmICghZGV2dG9vbHMkMSkgewogICAgICAgICAgdGFyZ2V0Ll9fVlVFX0RFVlRPT0xTX0hPT0tfUkVQTEFZX18gPSBudWxsOwogICAgICAgICAgZGV2dG9vbHNOb3RJbnN0YWxsZWQgPSB0cnVlOwogICAgICAgICAgYnVmZmVyID0gW107CiAgICAgICAgfQogICAgICB9LCAzZTMpOwogICAgfSBlbHNlIHsKICAgICAgZGV2dG9vbHNOb3RJbnN0YWxsZWQgPSB0cnVlOwogICAgICBidWZmZXIgPSBbXTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZGV2dG9vbHNJbml0QXBwKGFwcCwgdmVyc2lvbikgewogICAgZW1pdCQxKCJhcHA6aW5pdCIgLyogQVBQX0lOSVQgKi8sIGFwcCwgdmVyc2lvbiwgewogICAgICBGcmFnbWVudCwKICAgICAgVGV4dCwKICAgICAgQ29tbWVudCwKICAgICAgU3RhdGljCiAgICB9KTsKICB9CiAgZnVuY3Rpb24gZGV2dG9vbHNVbm1vdW50QXBwKGFwcCkgewogICAgZW1pdCQxKCJhcHA6dW5tb3VudCIgLyogQVBQX1VOTU9VTlQgKi8sIGFwcCk7CiAgfQogIGNvbnN0IGRldnRvb2xzQ29tcG9uZW50QWRkZWQgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKAogICAgImNvbXBvbmVudDphZGRlZCIgLyogQ09NUE9ORU5UX0FEREVEICovCiAgKTsKICBjb25zdCBkZXZ0b29sc0NvbXBvbmVudFVwZGF0ZWQgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKCJjb21wb25lbnQ6dXBkYXRlZCIgLyogQ09NUE9ORU5UX1VQREFURUQgKi8pOwogIGNvbnN0IF9kZXZ0b29sc0NvbXBvbmVudFJlbW92ZWQgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlRGV2dG9vbHNDb21wb25lbnRIb29rKAogICAgImNvbXBvbmVudDpyZW1vdmVkIiAvKiBDT01QT05FTlRfUkVNT1ZFRCAqLwogICk7CiAgY29uc3QgZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkID0gKGNvbXBvbmVudCkgPT4gewogICAgaWYgKGRldnRvb2xzJDEgJiYgdHlwZW9mIGRldnRvb2xzJDEuY2xlYW51cEJ1ZmZlciA9PT0gImZ1bmN0aW9uIiAmJiAvLyByZW1vdmUgdGhlIGNvbXBvbmVudCBpZiBpdCB3YXNuJ3QgYnVmZmVyZWQKICAgICFkZXZ0b29scyQxLmNsZWFudXBCdWZmZXIoY29tcG9uZW50KSkgewogICAgICBfZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkKGNvbXBvbmVudCk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBjcmVhdGVEZXZ0b29sc0NvbXBvbmVudEhvb2soaG9vaykgewogICAgcmV0dXJuIChjb21wb25lbnQpID0+IHsKICAgICAgZW1pdCQxKAogICAgICAgIGhvb2ssCiAgICAgICAgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLAogICAgICAgIGNvbXBvbmVudC51aWQsCiAgICAgICAgY29tcG9uZW50LnBhcmVudCA/IGNvbXBvbmVudC5wYXJlbnQudWlkIDogdm9pZCAwLAogICAgICAgIGNvbXBvbmVudAogICAgICApOwogICAgfTsKICB9CiAgY29uc3QgZGV2dG9vbHNQZXJmU3RhcnQgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlRGV2dG9vbHNQZXJmb3JtYW5jZUhvb2soCiAgICAicGVyZjpzdGFydCIgLyogUEVSRk9STUFOQ0VfU1RBUlQgKi8KICApOwogIGNvbnN0IGRldnRvb2xzUGVyZkVuZCA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVEZXZ0b29sc1BlcmZvcm1hbmNlSG9vaygKICAgICJwZXJmOmVuZCIgLyogUEVSRk9STUFOQ0VfRU5EICovCiAgKTsKICBmdW5jdGlvbiBjcmVhdGVEZXZ0b29sc1BlcmZvcm1hbmNlSG9vayhob29rKSB7CiAgICByZXR1cm4gKGNvbXBvbmVudCwgdHlwZSwgdGltZSkgPT4gewogICAgICBlbWl0JDEoaG9vaywgY29tcG9uZW50LmFwcENvbnRleHQuYXBwLCBjb21wb25lbnQudWlkLCBjb21wb25lbnQsIHR5cGUsIHRpbWUpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGV2dG9vbHNDb21wb25lbnRFbWl0KGNvbXBvbmVudCwgZXZlbnQsIHBhcmFtcykgewogICAgZW1pdCQxKAogICAgICAiY29tcG9uZW50OmVtaXQiIC8qIENPTVBPTkVOVF9FTUlUICovLAogICAgICBjb21wb25lbnQuYXBwQ29udGV4dC5hcHAsCiAgICAgIGNvbXBvbmVudCwKICAgICAgZXZlbnQsCiAgICAgIHBhcmFtcwogICAgKTsKICB9CgogIGZ1bmN0aW9uIGVtaXQoaW5zdGFuY2UsIGV2ZW50LCAuLi5yYXdBcmdzKSB7CiAgICBpZiAoaW5zdGFuY2UuaXNVbm1vdW50ZWQpCiAgICAgIHJldHVybjsKICAgIGNvbnN0IHByb3BzID0gaW5zdGFuY2Uudm5vZGUucHJvcHMgfHwgRU1QVFlfT0JKOwogICAgewogICAgICBjb25zdCB7CiAgICAgICAgZW1pdHNPcHRpb25zLAogICAgICAgIHByb3BzT3B0aW9uczogW3Byb3BzT3B0aW9uc10KICAgICAgfSA9IGluc3RhbmNlOwogICAgICBpZiAoZW1pdHNPcHRpb25zKSB7CiAgICAgICAgaWYgKCEoZXZlbnQgaW4gZW1pdHNPcHRpb25zKSAmJiB0cnVlKSB7CiAgICAgICAgICBpZiAoIXByb3BzT3B0aW9ucyB8fCAhKHRvSGFuZGxlcktleShldmVudCkgaW4gcHJvcHNPcHRpb25zKSkgewogICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgYENvbXBvbmVudCBlbWl0dGVkIGV2ZW50ICIke2V2ZW50fSIgYnV0IGl0IGlzIG5laXRoZXIgZGVjbGFyZWQgaW4gdGhlIGVtaXRzIG9wdGlvbiBub3IgYXMgYW4gIiR7dG9IYW5kbGVyS2V5KGV2ZW50KX0iIHByb3AuYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB2YWxpZGF0b3IgPSBlbWl0c09wdGlvbnNbZXZlbnRdOwogICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmFsaWRhdG9yKSkgewogICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdG9yKC4uLnJhd0FyZ3MpOwogICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgICBgSW52YWxpZCBldmVudCBhcmd1bWVudHM6IGV2ZW50IHZhbGlkYXRpb24gZmFpbGVkIGZvciBldmVudCAiJHtldmVudH0iLmAKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBsZXQgYXJncyA9IHJhd0FyZ3M7CiAgICBjb25zdCBpc01vZGVsTGlzdGVuZXIgPSBldmVudC5zdGFydHNXaXRoKCJ1cGRhdGU6Iik7CiAgICBjb25zdCBtb2RlbEFyZyA9IGlzTW9kZWxMaXN0ZW5lciAmJiBldmVudC5zbGljZSg3KTsKICAgIGlmIChtb2RlbEFyZyAmJiBtb2RlbEFyZyBpbiBwcm9wcykgewogICAgICBjb25zdCBtb2RpZmllcnNLZXkgPSBgJHttb2RlbEFyZyA9PT0gIm1vZGVsVmFsdWUiID8gIm1vZGVsIiA6IG1vZGVsQXJnfU1vZGlmaWVyc2A7CiAgICAgIGNvbnN0IHsgbnVtYmVyLCB0cmltIH0gPSBwcm9wc1ttb2RpZmllcnNLZXldIHx8IEVNUFRZX09CSjsKICAgICAgaWYgKHRyaW0pIHsKICAgICAgICBhcmdzID0gcmF3QXJncy5tYXAoKGEpID0+IGlzU3RyaW5nKGEpID8gYS50cmltKCkgOiBhKTsKICAgICAgfQogICAgICBpZiAobnVtYmVyKSB7CiAgICAgICAgYXJncyA9IHJhd0FyZ3MubWFwKGxvb3NlVG9OdW1iZXIpOwogICAgICB9CiAgICB9CiAgICB7CiAgICAgIGRldnRvb2xzQ29tcG9uZW50RW1pdChpbnN0YW5jZSwgZXZlbnQsIGFyZ3MpOwogICAgfQogICAgewogICAgICBjb25zdCBsb3dlckNhc2VFdmVudCA9IGV2ZW50LnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChsb3dlckNhc2VFdmVudCAhPT0gZXZlbnQgJiYgcHJvcHNbdG9IYW5kbGVyS2V5KGxvd2VyQ2FzZUV2ZW50KV0pIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBgRXZlbnQgIiR7bG93ZXJDYXNlRXZlbnR9IiBpcyBlbWl0dGVkIGluIGNvbXBvbmVudCAke2Zvcm1hdENvbXBvbmVudE5hbWUoCiAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgIGluc3RhbmNlLnR5cGUKICAgICAgICApfSBidXQgdGhlIGhhbmRsZXIgaXMgcmVnaXN0ZXJlZCBmb3IgIiR7ZXZlbnR9Ii4gTm90ZSB0aGF0IEhUTUwgYXR0cmlidXRlcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZSBhbmQgeW91IGNhbm5vdCB1c2Ugdi1vbiB0byBsaXN0ZW4gdG8gY2FtZWxDYXNlIGV2ZW50cyB3aGVuIHVzaW5nIGluLURPTSB0ZW1wbGF0ZXMuIFlvdSBzaG91bGQgcHJvYmFibHkgdXNlICIke2h5cGhlbmF0ZSgKICAgICAgICAgIGV2ZW50CiAgICAgICAgKX0iIGluc3RlYWQgb2YgIiR7ZXZlbnR9Ii5gCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgbGV0IGhhbmRsZXJOYW1lOwogICAgbGV0IGhhbmRsZXIgPSBwcm9wc1toYW5kbGVyTmFtZSA9IHRvSGFuZGxlcktleShldmVudCldIHx8IC8vIGFsc28gdHJ5IGNhbWVsQ2FzZSBldmVudCBoYW5kbGVyICgjMjI0OSkKICAgIHByb3BzW2hhbmRsZXJOYW1lID0gdG9IYW5kbGVyS2V5KGNhbWVsaXplKGV2ZW50KSldOwogICAgaWYgKCFoYW5kbGVyICYmIGlzTW9kZWxMaXN0ZW5lcikgewogICAgICBoYW5kbGVyID0gcHJvcHNbaGFuZGxlck5hbWUgPSB0b0hhbmRsZXJLZXkoaHlwaGVuYXRlKGV2ZW50KSldOwogICAgfQogICAgaWYgKGhhbmRsZXIpIHsKICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoCiAgICAgICAgaGFuZGxlciwKICAgICAgICBpbnN0YW5jZSwKICAgICAgICA2LAogICAgICAgIGFyZ3MKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IG9uY2VIYW5kbGVyID0gcHJvcHNbaGFuZGxlck5hbWUgKyBgT25jZWBdOwogICAgaWYgKG9uY2VIYW5kbGVyKSB7CiAgICAgIGlmICghaW5zdGFuY2UuZW1pdHRlZCkgewogICAgICAgIGluc3RhbmNlLmVtaXR0ZWQgPSB7fTsKICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5lbWl0dGVkW2hhbmRsZXJOYW1lXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpbnN0YW5jZS5lbWl0dGVkW2hhbmRsZXJOYW1lXSA9IHRydWU7CiAgICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKAogICAgICAgIG9uY2VIYW5kbGVyLAogICAgICAgIGluc3RhbmNlLAogICAgICAgIDYsCiAgICAgICAgYXJncwogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBub3JtYWxpemVFbWl0c09wdGlvbnMoY29tcCwgYXBwQ29udGV4dCwgYXNNaXhpbiA9IGZhbHNlKSB7CiAgICBjb25zdCBjYWNoZSA9IGFwcENvbnRleHQuZW1pdHNDYWNoZTsKICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChjb21wKTsKICAgIGlmIChjYWNoZWQgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQogICAgY29uc3QgcmF3ID0gY29tcC5lbWl0czsKICAgIGxldCBub3JtYWxpemVkID0ge307CiAgICBsZXQgaGFzRXh0ZW5kcyA9IGZhbHNlOwogICAgaWYgKCFpc0Z1bmN0aW9uKGNvbXApKSB7CiAgICAgIGNvbnN0IGV4dGVuZEVtaXRzID0gKHJhdzIpID0+IHsKICAgICAgICBjb25zdCBub3JtYWxpemVkRnJvbUV4dGVuZCA9IG5vcm1hbGl6ZUVtaXRzT3B0aW9ucyhyYXcyLCBhcHBDb250ZXh0LCB0cnVlKTsKICAgICAgICBpZiAobm9ybWFsaXplZEZyb21FeHRlbmQpIHsKICAgICAgICAgIGhhc0V4dGVuZHMgPSB0cnVlOwogICAgICAgICAgZXh0ZW5kKG5vcm1hbGl6ZWQsIG5vcm1hbGl6ZWRGcm9tRXh0ZW5kKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGlmICghYXNNaXhpbiAmJiBhcHBDb250ZXh0Lm1peGlucy5sZW5ndGgpIHsKICAgICAgICBhcHBDb250ZXh0Lm1peGlucy5mb3JFYWNoKGV4dGVuZEVtaXRzKTsKICAgICAgfQogICAgICBpZiAoY29tcC5leHRlbmRzKSB7CiAgICAgICAgZXh0ZW5kRW1pdHMoY29tcC5leHRlbmRzKTsKICAgICAgfQogICAgICBpZiAoY29tcC5taXhpbnMpIHsKICAgICAgICBjb21wLm1peGlucy5mb3JFYWNoKGV4dGVuZEVtaXRzKTsKICAgICAgfQogICAgfQogICAgaWYgKCFyYXcgJiYgIWhhc0V4dGVuZHMpIHsKICAgICAgaWYgKGlzT2JqZWN0KGNvbXApKSB7CiAgICAgICAgY2FjaGUuc2V0KGNvbXAsIG51bGwpOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgaWYgKGlzQXJyYXkocmF3KSkgewogICAgICByYXcuZm9yRWFjaCgoa2V5KSA9PiBub3JtYWxpemVkW2tleV0gPSBudWxsKTsKICAgIH0gZWxzZSB7CiAgICAgIGV4dGVuZChub3JtYWxpemVkLCByYXcpOwogICAgfQogICAgaWYgKGlzT2JqZWN0KGNvbXApKSB7CiAgICAgIGNhY2hlLnNldChjb21wLCBub3JtYWxpemVkKTsKICAgIH0KICAgIHJldHVybiBub3JtYWxpemVkOwogIH0KICBmdW5jdGlvbiBpc0VtaXRMaXN0ZW5lcihvcHRpb25zLCBrZXkpIHsKICAgIGlmICghb3B0aW9ucyB8fCAhaXNPbihrZXkpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGtleSA9IGtleS5zbGljZSgyKS5yZXBsYWNlKC9PbmNlJC8sICIiKTsKICAgIHJldHVybiBoYXNPd24ob3B0aW9ucywga2V5WzBdLnRvTG93ZXJDYXNlKCkgKyBrZXkuc2xpY2UoMSkpIHx8IGhhc093bihvcHRpb25zLCBoeXBoZW5hdGUoa2V5KSkgfHwgaGFzT3duKG9wdGlvbnMsIGtleSk7CiAgfQoKICBsZXQgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gbnVsbDsKICBsZXQgY3VycmVudFNjb3BlSWQgPSBudWxsOwogIGZ1bmN0aW9uIHNldEN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZShpbnN0YW5jZSkgewogICAgY29uc3QgcHJldiA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgY3VycmVudFNjb3BlSWQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS50eXBlLl9fc2NvcGVJZCB8fCBudWxsOwogICAgcmV0dXJuIHByZXY7CiAgfQogIGZ1bmN0aW9uIHB1c2hTY29wZUlkKGlkKSB7CiAgICBjdXJyZW50U2NvcGVJZCA9IGlkOwogIH0KICBmdW5jdGlvbiBwb3BTY29wZUlkKCkgewogICAgY3VycmVudFNjb3BlSWQgPSBudWxsOwogIH0KICBjb25zdCB3aXRoU2NvcGVJZCA9IChfaWQpID0+IHdpdGhDdHg7CiAgZnVuY3Rpb24gd2l0aEN0eChmbiwgY3R4ID0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLCBpc05vblNjb3BlZFNsb3QpIHsKICAgIGlmICghY3R4KQogICAgICByZXR1cm4gZm47CiAgICBpZiAoZm4uX24pIHsKICAgICAgcmV0dXJuIGZuOwogICAgfQogICAgY29uc3QgcmVuZGVyRm5XaXRoQ29udGV4dCA9ICguLi5hcmdzKSA9PiB7CiAgICAgIGlmIChyZW5kZXJGbldpdGhDb250ZXh0Ll9kKSB7CiAgICAgICAgc2V0QmxvY2tUcmFja2luZygtMSk7CiAgICAgIH0KICAgICAgY29uc3QgcHJldkluc3RhbmNlID0gc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKGN0eCk7CiAgICAgIGxldCByZXM7CiAgICAgIHRyeSB7CiAgICAgICAgcmVzID0gZm4oLi4uYXJncyk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKHByZXZJbnN0YW5jZSk7CiAgICAgICAgaWYgKHJlbmRlckZuV2l0aENvbnRleHQuX2QpIHsKICAgICAgICAgIHNldEJsb2NrVHJhY2tpbmcoMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHsKICAgICAgICBkZXZ0b29sc0NvbXBvbmVudFVwZGF0ZWQoY3R4KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzOwogICAgfTsKICAgIHJlbmRlckZuV2l0aENvbnRleHQuX24gPSB0cnVlOwogICAgcmVuZGVyRm5XaXRoQ29udGV4dC5fYyA9IHRydWU7CiAgICByZW5kZXJGbldpdGhDb250ZXh0Ll9kID0gdHJ1ZTsKICAgIHJldHVybiByZW5kZXJGbldpdGhDb250ZXh0OwogIH0KCiAgbGV0IGFjY2Vzc2VkQXR0cnMgPSBmYWxzZTsKICBmdW5jdGlvbiBtYXJrQXR0cnNBY2Nlc3NlZCgpIHsKICAgIGFjY2Vzc2VkQXR0cnMgPSB0cnVlOwogIH0KICBmdW5jdGlvbiByZW5kZXJDb21wb25lbnRSb290KGluc3RhbmNlKSB7CiAgICBjb25zdCB7CiAgICAgIHR5cGU6IENvbXBvbmVudCwKICAgICAgdm5vZGUsCiAgICAgIHByb3h5LAogICAgICB3aXRoUHJveHksCiAgICAgIHByb3BzLAogICAgICBwcm9wc09wdGlvbnM6IFtwcm9wc09wdGlvbnNdLAogICAgICBzbG90cywKICAgICAgYXR0cnMsCiAgICAgIGVtaXQsCiAgICAgIHJlbmRlciwKICAgICAgcmVuZGVyQ2FjaGUsCiAgICAgIGRhdGEsCiAgICAgIHNldHVwU3RhdGUsCiAgICAgIGN0eCwKICAgICAgaW5oZXJpdEF0dHJzCiAgICB9ID0gaW5zdGFuY2U7CiAgICBsZXQgcmVzdWx0OwogICAgbGV0IGZhbGx0aHJvdWdoQXR0cnM7CiAgICBjb25zdCBwcmV2ID0gc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKGluc3RhbmNlKTsKICAgIHsKICAgICAgYWNjZXNzZWRBdHRycyA9IGZhbHNlOwogICAgfQogICAgdHJ5IHsKICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDQpIHsKICAgICAgICBjb25zdCBwcm94eVRvVXNlID0gd2l0aFByb3h5IHx8IHByb3h5OwogICAgICAgIGNvbnN0IHRoaXNQcm94eSA9IHNldHVwU3RhdGUuX19pc1NjcmlwdFNldHVwID8gbmV3IFByb3h5KHByb3h5VG9Vc2UsIHsKICAgICAgICAgIGdldCh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBQcm9wZXJ0eSAnJHtTdHJpbmcoCiAgICAgICAgICAgICAga2V5CiAgICAgICAgICAgICl9JyB3YXMgYWNjZXNzZWQgdmlhICd0aGlzJy4gQXZvaWQgdXNpbmcgJ3RoaXMnIGluIHRlbXBsYXRlcy5gCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIGtleSwgcmVjZWl2ZXIpOwogICAgICAgICAgfQogICAgICAgIH0pIDogcHJveHlUb1VzZTsKICAgICAgICByZXN1bHQgPSBub3JtYWxpemVWTm9kZSgKICAgICAgICAgIHJlbmRlci5jYWxsKAogICAgICAgICAgICB0aGlzUHJveHksCiAgICAgICAgICAgIHByb3h5VG9Vc2UsCiAgICAgICAgICAgIHJlbmRlckNhY2hlLAogICAgICAgICAgICBwcm9wcywKICAgICAgICAgICAgc2V0dXBTdGF0ZSwKICAgICAgICAgICAgZGF0YSwKICAgICAgICAgICAgY3R4CiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgICBmYWxsdGhyb3VnaEF0dHJzID0gYXR0cnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgcmVuZGVyMiA9IENvbXBvbmVudDsKICAgICAgICBpZiAoYXR0cnMgPT09IHByb3BzKSB7CiAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSBub3JtYWxpemVWTm9kZSgKICAgICAgICAgIHJlbmRlcjIubGVuZ3RoID4gMSA/IHJlbmRlcjIoCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICB0cnVlID8gewogICAgICAgICAgICAgIGdldCBhdHRycygpIHsKICAgICAgICAgICAgICAgIG1hcmtBdHRyc0FjY2Vzc2VkKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gYXR0cnM7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzbG90cywKICAgICAgICAgICAgICBlbWl0CiAgICAgICAgICAgIH0gOiB7IGF0dHJzLCBzbG90cywgZW1pdCB9CiAgICAgICAgICApIDogcmVuZGVyMigKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgLyogd2Uga25vdyBpdCBkb2Vzbid0IG5lZWQgaXQgKi8KICAgICAgICAgICkKICAgICAgICApOwogICAgICAgIGZhbGx0aHJvdWdoQXR0cnMgPSBDb21wb25lbnQucHJvcHMgPyBhdHRycyA6IGdldEZ1bmN0aW9uYWxGYWxsdGhyb3VnaChhdHRycyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBibG9ja1N0YWNrLmxlbmd0aCA9IDA7CiAgICAgIGhhbmRsZUVycm9yKGVyciwgaW5zdGFuY2UsIDEpOwogICAgICByZXN1bHQgPSBjcmVhdGVWTm9kZShDb21tZW50KTsKICAgIH0KICAgIGxldCByb290ID0gcmVzdWx0OwogICAgbGV0IHNldFJvb3QgPSB2b2lkIDA7CiAgICBpZiAocmVzdWx0LnBhdGNoRmxhZyA+IDAgJiYgcmVzdWx0LnBhdGNoRmxhZyAmIDIwNDgpIHsKICAgICAgW3Jvb3QsIHNldFJvb3RdID0gZ2V0Q2hpbGRSb290KHJlc3VsdCk7CiAgICB9CiAgICBpZiAoZmFsbHRocm91Z2hBdHRycyAmJiBpbmhlcml0QXR0cnMgIT09IGZhbHNlKSB7CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhmYWxsdGhyb3VnaEF0dHJzKTsKICAgICAgY29uc3QgeyBzaGFwZUZsYWcgfSA9IHJvb3Q7CiAgICAgIGlmIChrZXlzLmxlbmd0aCkgewogICAgICAgIGlmIChzaGFwZUZsYWcgJiAoMSB8IDYpKSB7CiAgICAgICAgICBpZiAocHJvcHNPcHRpb25zICYmIGtleXMuc29tZShpc01vZGVsTGlzdGVuZXIpKSB7CiAgICAgICAgICAgIGZhbGx0aHJvdWdoQXR0cnMgPSBmaWx0ZXJNb2RlbExpc3RlbmVycygKICAgICAgICAgICAgICBmYWxsdGhyb3VnaEF0dHJzLAogICAgICAgICAgICAgIHByb3BzT3B0aW9ucwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgcm9vdCA9IGNsb25lVk5vZGUocm9vdCwgZmFsbHRocm91Z2hBdHRycyk7CiAgICAgICAgfSBlbHNlIGlmICghYWNjZXNzZWRBdHRycyAmJiByb290LnR5cGUgIT09IENvbW1lbnQpIHsKICAgICAgICAgIGNvbnN0IGFsbEF0dHJzID0gT2JqZWN0LmtleXMoYXR0cnMpOwogICAgICAgICAgY29uc3QgZXZlbnRBdHRycyA9IFtdOwogICAgICAgICAgY29uc3QgZXh0cmFBdHRycyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhbGxBdHRycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qga2V5ID0gYWxsQXR0cnNbaV07CiAgICAgICAgICAgIGlmIChpc09uKGtleSkpIHsKICAgICAgICAgICAgICBpZiAoIWlzTW9kZWxMaXN0ZW5lcihrZXkpKSB7CiAgICAgICAgICAgICAgICBldmVudEF0dHJzLnB1c2goa2V5WzJdLnRvTG93ZXJDYXNlKCkgKyBrZXkuc2xpY2UoMykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBleHRyYUF0dHJzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4dHJhQXR0cnMubGVuZ3RoKSB7CiAgICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgICBgRXh0cmFuZW91cyBub24tcHJvcHMgYXR0cmlidXRlcyAoJHtleHRyYUF0dHJzLmpvaW4oIiwgIil9KSB3ZXJlIHBhc3NlZCB0byBjb21wb25lbnQgYnV0IGNvdWxkIG5vdCBiZSBhdXRvbWF0aWNhbGx5IGluaGVyaXRlZCBiZWNhdXNlIGNvbXBvbmVudCByZW5kZXJzIGZyYWdtZW50IG9yIHRleHQgcm9vdCBub2Rlcy5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlbnRBdHRycy5sZW5ndGgpIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBFeHRyYW5lb3VzIG5vbi1lbWl0cyBldmVudCBsaXN0ZW5lcnMgKCR7ZXZlbnRBdHRycy5qb2luKCIsICIpfSkgd2VyZSBwYXNzZWQgdG8gY29tcG9uZW50IGJ1dCBjb3VsZCBub3QgYmUgYXV0b21hdGljYWxseSBpbmhlcml0ZWQgYmVjYXVzZSBjb21wb25lbnQgcmVuZGVycyBmcmFnbWVudCBvciB0ZXh0IHJvb3Qgbm9kZXMuIElmIHRoZSBsaXN0ZW5lciBpcyBpbnRlbmRlZCB0byBiZSBhIGNvbXBvbmVudCBjdXN0b20gZXZlbnQgbGlzdGVuZXIgb25seSwgZGVjbGFyZSBpdCB1c2luZyB0aGUgImVtaXRzIiBvcHRpb24uYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHZub2RlLmRpcnMpIHsKICAgICAgaWYgKCFpc0VsZW1lbnRSb290KHJvb3QpKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYFJ1bnRpbWUgZGlyZWN0aXZlIHVzZWQgb24gY29tcG9uZW50IHdpdGggbm9uLWVsZW1lbnQgcm9vdCBub2RlLiBUaGUgZGlyZWN0aXZlcyB3aWxsIG5vdCBmdW5jdGlvbiBhcyBpbnRlbmRlZC5gCiAgICAgICAgKTsKICAgICAgfQogICAgICByb290ID0gY2xvbmVWTm9kZShyb290KTsKICAgICAgcm9vdC5kaXJzID0gcm9vdC5kaXJzID8gcm9vdC5kaXJzLmNvbmNhdCh2bm9kZS5kaXJzKSA6IHZub2RlLmRpcnM7CiAgICB9CiAgICBpZiAodm5vZGUudHJhbnNpdGlvbikgewogICAgICBpZiAoIWlzRWxlbWVudFJvb3Qocm9vdCkpIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBgQ29tcG9uZW50IGluc2lkZSA8VHJhbnNpdGlvbj4gcmVuZGVycyBub24tZWxlbWVudCByb290IG5vZGUgdGhhdCBjYW5ub3QgYmUgYW5pbWF0ZWQuYAogICAgICAgICk7CiAgICAgIH0KICAgICAgcm9vdC50cmFuc2l0aW9uID0gdm5vZGUudHJhbnNpdGlvbjsKICAgIH0KICAgIGlmIChzZXRSb290KSB7CiAgICAgIHNldFJvb3Qocm9vdCk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSByb290OwogICAgfQogICAgc2V0Q3VycmVudFJlbmRlcmluZ0luc3RhbmNlKHByZXYpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgY29uc3QgZ2V0Q2hpbGRSb290ID0gKHZub2RlKSA9PiB7CiAgICBjb25zdCByYXdDaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgY29uc3QgZHluYW1pY0NoaWxkcmVuID0gdm5vZGUuZHluYW1pY0NoaWxkcmVuOwogICAgY29uc3QgY2hpbGRSb290ID0gZmlsdGVyU2luZ2xlUm9vdChyYXdDaGlsZHJlbiwgZmFsc2UpOwogICAgaWYgKCFjaGlsZFJvb3QpIHsKICAgICAgcmV0dXJuIFt2bm9kZSwgdm9pZCAwXTsKICAgIH0gZWxzZSBpZiAoY2hpbGRSb290LnBhdGNoRmxhZyA+IDAgJiYgY2hpbGRSb290LnBhdGNoRmxhZyAmIDIwNDgpIHsKICAgICAgcmV0dXJuIGdldENoaWxkUm9vdChjaGlsZFJvb3QpOwogICAgfQogICAgY29uc3QgaW5kZXggPSByYXdDaGlsZHJlbi5pbmRleE9mKGNoaWxkUm9vdCk7CiAgICBjb25zdCBkeW5hbWljSW5kZXggPSBkeW5hbWljQ2hpbGRyZW4gPyBkeW5hbWljQ2hpbGRyZW4uaW5kZXhPZihjaGlsZFJvb3QpIDogLTE7CiAgICBjb25zdCBzZXRSb290ID0gKHVwZGF0ZWRSb290KSA9PiB7CiAgICAgIHJhd0NoaWxkcmVuW2luZGV4XSA9IHVwZGF0ZWRSb290OwogICAgICBpZiAoZHluYW1pY0NoaWxkcmVuKSB7CiAgICAgICAgaWYgKGR5bmFtaWNJbmRleCA+IC0xKSB7CiAgICAgICAgICBkeW5hbWljQ2hpbGRyZW5bZHluYW1pY0luZGV4XSA9IHVwZGF0ZWRSb290OwogICAgICAgIH0gZWxzZSBpZiAodXBkYXRlZFJvb3QucGF0Y2hGbGFnID4gMCkgewogICAgICAgICAgdm5vZGUuZHluYW1pY0NoaWxkcmVuID0gWy4uLmR5bmFtaWNDaGlsZHJlbiwgdXBkYXRlZFJvb3RdOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIHJldHVybiBbbm9ybWFsaXplVk5vZGUoY2hpbGRSb290KSwgc2V0Um9vdF07CiAgfTsKICBmdW5jdGlvbiBmaWx0ZXJTaW5nbGVSb290KGNoaWxkcmVuLCByZWN1cnNlID0gdHJ1ZSkgewogICAgbGV0IHNpbmdsZVJvb3Q7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgIGlmIChpc1ZOb2RlKGNoaWxkKSkgewogICAgICAgIGlmIChjaGlsZC50eXBlICE9PSBDb21tZW50IHx8IGNoaWxkLmNoaWxkcmVuID09PSAidi1pZiIpIHsKICAgICAgICAgIGlmIChzaW5nbGVSb290KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNpbmdsZVJvb3QgPSBjaGlsZDsKICAgICAgICAgICAgaWYgKHJlY3Vyc2UgJiYgc2luZ2xlUm9vdC5wYXRjaEZsYWcgPiAwICYmIHNpbmdsZVJvb3QucGF0Y2hGbGFnICYgMjA0OCkgewogICAgICAgICAgICAgIHJldHVybiBmaWx0ZXJTaW5nbGVSb290KHNpbmdsZVJvb3QuY2hpbGRyZW4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNpbmdsZVJvb3Q7CiAgfQogIGNvbnN0IGdldEZ1bmN0aW9uYWxGYWxsdGhyb3VnaCA9IChhdHRycykgPT4gewogICAgbGV0IHJlczsKICAgIGZvciAoY29uc3Qga2V5IGluIGF0dHJzKSB7CiAgICAgIGlmIChrZXkgPT09ICJjbGFzcyIgfHwga2V5ID09PSAic3R5bGUiIHx8IGlzT24oa2V5KSkgewogICAgICAgIChyZXMgfHwgKHJlcyA9IHt9KSlba2V5XSA9IGF0dHJzW2tleV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXM7CiAgfTsKICBjb25zdCBmaWx0ZXJNb2RlbExpc3RlbmVycyA9IChhdHRycywgcHJvcHMpID0+IHsKICAgIGNvbnN0IHJlcyA9IHt9OwogICAgZm9yIChjb25zdCBrZXkgaW4gYXR0cnMpIHsKICAgICAgaWYgKCFpc01vZGVsTGlzdGVuZXIoa2V5KSB8fCAhKGtleS5zbGljZSg5KSBpbiBwcm9wcykpIHsKICAgICAgICByZXNba2V5XSA9IGF0dHJzW2tleV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXM7CiAgfTsKICBjb25zdCBpc0VsZW1lbnRSb290ID0gKHZub2RlKSA9PiB7CiAgICByZXR1cm4gdm5vZGUuc2hhcGVGbGFnICYgKDYgfCAxKSB8fCB2bm9kZS50eXBlID09PSBDb21tZW50OwogIH07CiAgZnVuY3Rpb24gc2hvdWxkVXBkYXRlQ29tcG9uZW50KHByZXZWTm9kZSwgbmV4dFZOb2RlLCBvcHRpbWl6ZWQpIHsKICAgIGNvbnN0IHsgcHJvcHM6IHByZXZQcm9wcywgY2hpbGRyZW46IHByZXZDaGlsZHJlbiwgY29tcG9uZW50IH0gPSBwcmV2Vk5vZGU7CiAgICBjb25zdCB7IHByb3BzOiBuZXh0UHJvcHMsIGNoaWxkcmVuOiBuZXh0Q2hpbGRyZW4sIHBhdGNoRmxhZyB9ID0gbmV4dFZOb2RlOwogICAgY29uc3QgZW1pdHMgPSBjb21wb25lbnQuZW1pdHNPcHRpb25zOwogICAgaWYgKChwcmV2Q2hpbGRyZW4gfHwgbmV4dENoaWxkcmVuKSAmJiBpc0htclVwZGF0aW5nKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKG5leHRWTm9kZS5kaXJzIHx8IG5leHRWTm9kZS50cmFuc2l0aW9uKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKG9wdGltaXplZCAmJiBwYXRjaEZsYWcgPj0gMCkgewogICAgICBpZiAocGF0Y2hGbGFnICYgMTAyNCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChwYXRjaEZsYWcgJiAxNikgewogICAgICAgIGlmICghcHJldlByb3BzKSB7CiAgICAgICAgICByZXR1cm4gISFuZXh0UHJvcHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoYXNQcm9wc0NoYW5nZWQocHJldlByb3BzLCBuZXh0UHJvcHMsIGVtaXRzKTsKICAgICAgfSBlbHNlIGlmIChwYXRjaEZsYWcgJiA4KSB7CiAgICAgICAgY29uc3QgZHluYW1pY1Byb3BzID0gbmV4dFZOb2RlLmR5bmFtaWNQcm9wczsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR5bmFtaWNQcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qga2V5ID0gZHluYW1pY1Byb3BzW2ldOwogICAgICAgICAgaWYgKG5leHRQcm9wc1trZXldICE9PSBwcmV2UHJvcHNba2V5XSAmJiAhaXNFbWl0TGlzdGVuZXIoZW1pdHMsIGtleSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAocHJldkNoaWxkcmVuIHx8IG5leHRDaGlsZHJlbikgewogICAgICAgIGlmICghbmV4dENoaWxkcmVuIHx8ICFuZXh0Q2hpbGRyZW4uJHN0YWJsZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoIXByZXZQcm9wcykgewogICAgICAgIHJldHVybiAhIW5leHRQcm9wczsKICAgICAgfQogICAgICBpZiAoIW5leHRQcm9wcykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBoYXNQcm9wc0NoYW5nZWQocHJldlByb3BzLCBuZXh0UHJvcHMsIGVtaXRzKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gaGFzUHJvcHNDaGFuZ2VkKHByZXZQcm9wcywgbmV4dFByb3BzLCBlbWl0c09wdGlvbnMpIHsKICAgIGNvbnN0IG5leHRLZXlzID0gT2JqZWN0LmtleXMobmV4dFByb3BzKTsKICAgIGlmIChuZXh0S2V5cy5sZW5ndGggIT09IE9iamVjdC5rZXlzKHByZXZQcm9wcykubGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXh0S2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrZXkgPSBuZXh0S2V5c1tpXTsKICAgICAgaWYgKG5leHRQcm9wc1trZXldICE9PSBwcmV2UHJvcHNba2V5XSAmJiAhaXNFbWl0TGlzdGVuZXIoZW1pdHNPcHRpb25zLCBrZXkpKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gdXBkYXRlSE9DSG9zdEVsKHsgdm5vZGUsIHBhcmVudCB9LCBlbCkgewogICAgd2hpbGUgKHBhcmVudCkgewogICAgICBjb25zdCByb290ID0gcGFyZW50LnN1YlRyZWU7CiAgICAgIGlmIChyb290LnN1c3BlbnNlICYmIHJvb3Quc3VzcGVuc2UuYWN0aXZlQnJhbmNoID09PSB2bm9kZSkgewogICAgICAgIHJvb3QuZWwgPSB2bm9kZS5lbDsKICAgICAgfQogICAgICBpZiAocm9vdCA9PT0gdm5vZGUpIHsKICAgICAgICAodm5vZGUgPSBwYXJlbnQudm5vZGUpLmVsID0gZWw7CiAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KCiAgY29uc3QgQ09NUE9ORU5UUyA9ICJjb21wb25lbnRzIjsKICBjb25zdCBESVJFQ1RJVkVTID0gImRpcmVjdGl2ZXMiOwogIGZ1bmN0aW9uIHJlc29sdmVDb21wb25lbnQobmFtZSwgbWF5YmVTZWxmUmVmZXJlbmNlKSB7CiAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KENPTVBPTkVOVFMsIG5hbWUsIHRydWUsIG1heWJlU2VsZlJlZmVyZW5jZSkgfHwgbmFtZTsKICB9CiAgY29uc3QgTlVMTF9EWU5BTUlDX0NPTVBPTkVOVCA9IFN5bWJvbC5mb3IoInYtbmRjIik7CiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNDb21wb25lbnQoY29tcG9uZW50KSB7CiAgICBpZiAoaXNTdHJpbmcoY29tcG9uZW50KSkgewogICAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KENPTVBPTkVOVFMsIGNvbXBvbmVudCwgZmFsc2UpIHx8IGNvbXBvbmVudDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjb21wb25lbnQgfHwgTlVMTF9EWU5BTUlDX0NPTVBPTkVOVDsKICAgIH0KICB9CiAgZnVuY3Rpb24gcmVzb2x2ZURpcmVjdGl2ZShuYW1lKSB7CiAgICByZXR1cm4gcmVzb2x2ZUFzc2V0KERJUkVDVElWRVMsIG5hbWUpOwogIH0KICBmdW5jdGlvbiByZXNvbHZlQXNzZXQodHlwZSwgbmFtZSwgd2Fybk1pc3NpbmcgPSB0cnVlLCBtYXliZVNlbGZSZWZlcmVuY2UgPSBmYWxzZSkgewogICAgY29uc3QgaW5zdGFuY2UgPSBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UgfHwgY3VycmVudEluc3RhbmNlOwogICAgaWYgKGluc3RhbmNlKSB7CiAgICAgIGNvbnN0IENvbXBvbmVudCA9IGluc3RhbmNlLnR5cGU7CiAgICAgIGlmICh0eXBlID09PSBDT01QT05FTlRTKSB7CiAgICAgICAgY29uc3Qgc2VsZk5hbWUgPSBnZXRDb21wb25lbnROYW1lKAogICAgICAgICAgQ29tcG9uZW50LAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIGlmIChzZWxmTmFtZSAmJiAoc2VsZk5hbWUgPT09IG5hbWUgfHwgc2VsZk5hbWUgPT09IGNhbWVsaXplKG5hbWUpIHx8IHNlbGZOYW1lID09PSBjYXBpdGFsaXplKGNhbWVsaXplKG5hbWUpKSkpIHsKICAgICAgICAgIHJldHVybiBDb21wb25lbnQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHJlcyA9ICgKICAgICAgICAvLyBsb2NhbCByZWdpc3RyYXRpb24KICAgICAgICAvLyBjaGVjayBpbnN0YW5jZVt0eXBlXSBmaXJzdCB3aGljaCBpcyByZXNvbHZlZCBmb3Igb3B0aW9ucyBBUEkKICAgICAgICByZXNvbHZlKGluc3RhbmNlW3R5cGVdIHx8IENvbXBvbmVudFt0eXBlXSwgbmFtZSkgfHwgLy8gZ2xvYmFsIHJlZ2lzdHJhdGlvbgogICAgICAgIHJlc29sdmUoaW5zdGFuY2UuYXBwQ29udGV4dFt0eXBlXSwgbmFtZSkKICAgICAgKTsKICAgICAgaWYgKCFyZXMgJiYgbWF5YmVTZWxmUmVmZXJlbmNlKSB7CiAgICAgICAgcmV0dXJuIENvbXBvbmVudDsKICAgICAgfQogICAgICBpZiAod2Fybk1pc3NpbmcgJiYgIXJlcykgewogICAgICAgIGNvbnN0IGV4dHJhID0gdHlwZSA9PT0gQ09NUE9ORU5UUyA/IGAKSWYgdGhpcyBpcyBhIG5hdGl2ZSBjdXN0b20gZWxlbWVudCwgbWFrZSBzdXJlIHRvIGV4Y2x1ZGUgaXQgZnJvbSBjb21wb25lbnQgcmVzb2x1dGlvbiB2aWEgY29tcGlsZXJPcHRpb25zLmlzQ3VzdG9tRWxlbWVudC5gIDogYGA7CiAgICAgICAgd2FybiQxKGBGYWlsZWQgdG8gcmVzb2x2ZSAke3R5cGUuc2xpY2UoMCwgLTEpfTogJHtuYW1lfSR7ZXh0cmF9YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0gZWxzZSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgcmVzb2x2ZSR7Y2FwaXRhbGl6ZSh0eXBlLnNsaWNlKDAsIC0xKSl9IGNhbiBvbmx5IGJlIHVzZWQgaW4gcmVuZGVyKCkgb3Igc2V0dXAoKS5gCiAgICAgICk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHJlc29sdmUocmVnaXN0cnksIG5hbWUpIHsKICAgIHJldHVybiByZWdpc3RyeSAmJiAocmVnaXN0cnlbbmFtZV0gfHwgcmVnaXN0cnlbY2FtZWxpemUobmFtZSldIHx8IHJlZ2lzdHJ5W2NhcGl0YWxpemUoY2FtZWxpemUobmFtZSkpXSk7CiAgfQoKICBjb25zdCBpc1N1c3BlbnNlID0gKHR5cGUpID0+IHR5cGUuX19pc1N1c3BlbnNlOwogIGxldCBzdXNwZW5zZUlkID0gMDsKICBjb25zdCBTdXNwZW5zZUltcGwgPSB7CiAgICBuYW1lOiAiU3VzcGVuc2UiLAogICAgLy8gSW4gb3JkZXIgdG8gbWFrZSBTdXNwZW5zZSB0cmVlLXNoYWthYmxlLCB3ZSBuZWVkIHRvIGF2b2lkIGltcG9ydGluZyBpdAogICAgLy8gZGlyZWN0bHkgaW4gdGhlIHJlbmRlcmVyLiBUaGUgcmVuZGVyZXIgY2hlY2tzIGZvciB0aGUgX19pc1N1c3BlbnNlIGZsYWcKICAgIC8vIG9uIGEgdm5vZGUncyB0eXBlIGFuZCBjYWxscyB0aGUgYHByb2Nlc3NgIG1ldGhvZCwgcGFzc2luZyBpbiByZW5kZXJlcgogICAgLy8gaW50ZXJuYWxzLgogICAgX19pc1N1c3BlbnNlOiB0cnVlLAogICAgcHJvY2VzcyhuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscykgewogICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgIG1vdW50U3VzcGVuc2UoCiAgICAgICAgICBuMiwKICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgIGFuY2hvciwKICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgb3B0aW1pemVkLAogICAgICAgICAgcmVuZGVyZXJJbnRlcm5hbHMKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSAmJiBwYXJlbnRTdXNwZW5zZS5kZXBzID4gMCAmJiAhbjEuc3VzcGVuc2UuaXNJbkZhbGxiYWNrKSB7CiAgICAgICAgICBuMi5zdXNwZW5zZSA9IG4xLnN1c3BlbnNlOwogICAgICAgICAgbjIuc3VzcGVuc2Uudm5vZGUgPSBuMjsKICAgICAgICAgIG4yLmVsID0gbjEuZWw7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBhdGNoU3VzcGVuc2UoCiAgICAgICAgICBuMSwKICAgICAgICAgIG4yLAogICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgYW5jaG9yLAogICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgb3B0aW1pemVkLAogICAgICAgICAgcmVuZGVyZXJJbnRlcm5hbHMKICAgICAgICApOwogICAgICB9CiAgICB9LAogICAgaHlkcmF0ZTogaHlkcmF0ZVN1c3BlbnNlLAogICAgY3JlYXRlOiBjcmVhdGVTdXNwZW5zZUJvdW5kYXJ5LAogICAgbm9ybWFsaXplOiBub3JtYWxpemVTdXNwZW5zZUNoaWxkcmVuCiAgfTsKICBjb25zdCBTdXNwZW5zZSA9IFN1c3BlbnNlSW1wbCA7CiAgZnVuY3Rpb24gdHJpZ2dlckV2ZW50KHZub2RlLCBuYW1lKSB7CiAgICBjb25zdCBldmVudExpc3RlbmVyID0gdm5vZGUucHJvcHMgJiYgdm5vZGUucHJvcHNbbmFtZV07CiAgICBpZiAoaXNGdW5jdGlvbihldmVudExpc3RlbmVyKSkgewogICAgICBldmVudExpc3RlbmVyKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2Uodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscykgewogICAgY29uc3QgewogICAgICBwOiBwYXRjaCwKICAgICAgbzogeyBjcmVhdGVFbGVtZW50IH0KICAgIH0gPSByZW5kZXJlckludGVybmFsczsKICAgIGNvbnN0IGhpZGRlbkNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29uc3Qgc3VzcGVuc2UgPSB2bm9kZS5zdXNwZW5zZSA9IGNyZWF0ZVN1c3BlbnNlQm91bmRhcnkoCiAgICAgIHZub2RlLAogICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICBjb250YWluZXIsCiAgICAgIGhpZGRlbkNvbnRhaW5lciwKICAgICAgYW5jaG9yLAogICAgICBuYW1lc3BhY2UsCiAgICAgIHNsb3RTY29wZUlkcywKICAgICAgb3B0aW1pemVkLAogICAgICByZW5kZXJlckludGVybmFscwogICAgKTsKICAgIHBhdGNoKAogICAgICBudWxsLAogICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gdm5vZGUuc3NDb250ZW50LAogICAgICBoaWRkZW5Db250YWluZXIsCiAgICAgIG51bGwsCiAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgc3VzcGVuc2UsCiAgICAgIG5hbWVzcGFjZSwKICAgICAgc2xvdFNjb3BlSWRzCiAgICApOwogICAgaWYgKHN1c3BlbnNlLmRlcHMgPiAwKSB7CiAgICAgIHRyaWdnZXJFdmVudCh2bm9kZSwgIm9uUGVuZGluZyIpOwogICAgICB0cmlnZ2VyRXZlbnQodm5vZGUsICJvbkZhbGxiYWNrIik7CiAgICAgIHBhdGNoKAogICAgICAgIG51bGwsCiAgICAgICAgdm5vZGUuc3NGYWxsYmFjaywKICAgICAgICBjb250YWluZXIsCiAgICAgICAgYW5jaG9yLAogICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICBudWxsLAogICAgICAgIC8vIGZhbGxiYWNrIHRyZWUgd2lsbCBub3QgaGF2ZSBzdXNwZW5zZSBjb250ZXh0CiAgICAgICAgbmFtZXNwYWNlLAogICAgICAgIHNsb3RTY29wZUlkcwogICAgICApOwogICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIHZub2RlLnNzRmFsbGJhY2spOwogICAgfSBlbHNlIHsKICAgICAgc3VzcGVuc2UucmVzb2x2ZShmYWxzZSwgdHJ1ZSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHBhdGNoU3VzcGVuc2UobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCB7IHA6IHBhdGNoLCB1bTogdW5tb3VudCwgbzogeyBjcmVhdGVFbGVtZW50IH0gfSkgewogICAgY29uc3Qgc3VzcGVuc2UgPSBuMi5zdXNwZW5zZSA9IG4xLnN1c3BlbnNlOwogICAgc3VzcGVuc2Uudm5vZGUgPSBuMjsKICAgIG4yLmVsID0gbjEuZWw7CiAgICBjb25zdCBuZXdCcmFuY2ggPSBuMi5zc0NvbnRlbnQ7CiAgICBjb25zdCBuZXdGYWxsYmFjayA9IG4yLnNzRmFsbGJhY2s7CiAgICBjb25zdCB7IGFjdGl2ZUJyYW5jaCwgcGVuZGluZ0JyYW5jaCwgaXNJbkZhbGxiYWNrLCBpc0h5ZHJhdGluZyB9ID0gc3VzcGVuc2U7CiAgICBpZiAocGVuZGluZ0JyYW5jaCkgewogICAgICBzdXNwZW5zZS5wZW5kaW5nQnJhbmNoID0gbmV3QnJhbmNoOwogICAgICBpZiAoaXNTYW1lVk5vZGVUeXBlKG5ld0JyYW5jaCwgcGVuZGluZ0JyYW5jaCkpIHsKICAgICAgICBwYXRjaCgKICAgICAgICAgIHBlbmRpbmdCcmFuY2gsCiAgICAgICAgICBuZXdCcmFuY2gsCiAgICAgICAgICBzdXNwZW5zZS5oaWRkZW5Db250YWluZXIsCiAgICAgICAgICBudWxsLAogICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgc3VzcGVuc2UsCiAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICApOwogICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsKICAgICAgICAgIHN1c3BlbnNlLnJlc29sdmUoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzSW5GYWxsYmFjaykgewogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgICBhY3RpdmVCcmFuY2gsCiAgICAgICAgICAgICAgbmV3RmFsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBmYWxsYmFjayB0cmVlIHdpbGwgbm90IGhhdmUgc3VzcGVuc2UgY29udGV4dAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHNldEFjdGl2ZUJyYW5jaChzdXNwZW5zZSwgbmV3RmFsbGJhY2spOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdXNwZW5zZS5wZW5kaW5nSWQgPSBzdXNwZW5zZUlkKys7CiAgICAgICAgaWYgKGlzSHlkcmF0aW5nKSB7CiAgICAgICAgICBzdXNwZW5zZS5pc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgc3VzcGVuc2UuYWN0aXZlQnJhbmNoID0gcGVuZGluZ0JyYW5jaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdW5tb3VudChwZW5kaW5nQnJhbmNoLCBwYXJlbnRDb21wb25lbnQsIHN1c3BlbnNlKTsKICAgICAgICB9CiAgICAgICAgc3VzcGVuc2UuZGVwcyA9IDA7CiAgICAgICAgc3VzcGVuc2UuZWZmZWN0cy5sZW5ndGggPSAwOwogICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGlmIChpc0luRmFsbGJhY2spIHsKICAgICAgICAgIHBhdGNoKAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICBuZXdCcmFuY2gsCiAgICAgICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBzdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgKTsKICAgICAgICAgIGlmIChzdXNwZW5zZS5kZXBzIDw9IDApIHsKICAgICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGF0Y2goCiAgICAgICAgICAgICAgYWN0aXZlQnJhbmNoLAogICAgICAgICAgICAgIG5ld0ZhbGxiYWNrLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gZmFsbGJhY2sgdHJlZSB3aWxsIG5vdCBoYXZlIHN1c3BlbnNlIGNvbnRleHQKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgICApOwogICAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0ZhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGFjdGl2ZUJyYW5jaCAmJiBpc1NhbWVWTm9kZVR5cGUobmV3QnJhbmNoLCBhY3RpdmVCcmFuY2gpKSB7CiAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgYWN0aXZlQnJhbmNoLAogICAgICAgICAgICBuZXdCcmFuY2gsCiAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgIHN1c3BlbnNlLAogICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICApOwogICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGF0Y2goCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIG5ld0JyYW5jaCwKICAgICAgICAgICAgc3VzcGVuc2UuaGlkZGVuQ29udGFpbmVyLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgIHN1c3BlbnNlLAogICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICApOwogICAgICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPD0gMCkgewogICAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYWN0aXZlQnJhbmNoICYmIGlzU2FtZVZOb2RlVHlwZShuZXdCcmFuY2gsIGFjdGl2ZUJyYW5jaCkpIHsKICAgICAgICBwYXRjaCgKICAgICAgICAgIGFjdGl2ZUJyYW5jaCwKICAgICAgICAgIG5ld0JyYW5jaCwKICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgIGFuY2hvciwKICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgIHN1c3BlbnNlLAogICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgKTsKICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIG5ld0JyYW5jaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJpZ2dlckV2ZW50KG4yLCAib25QZW5kaW5nIik7CiAgICAgICAgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCA9IG5ld0JyYW5jaDsKICAgICAgICBpZiAobmV3QnJhbmNoLnNoYXBlRmxhZyAmIDUxMikgewogICAgICAgICAgc3VzcGVuc2UucGVuZGluZ0lkID0gbmV3QnJhbmNoLmNvbXBvbmVudC5zdXNwZW5zZUlkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdXNwZW5zZS5wZW5kaW5nSWQgPSBzdXNwZW5zZUlkKys7CiAgICAgICAgfQogICAgICAgIHBhdGNoKAogICAgICAgICAgbnVsbCwKICAgICAgICAgIG5ld0JyYW5jaCwKICAgICAgICAgIHN1c3BlbnNlLmhpZGRlbkNvbnRhaW5lciwKICAgICAgICAgIG51bGwsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBzdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgICAgaWYgKHN1c3BlbnNlLmRlcHMgPD0gMCkgewogICAgICAgICAgc3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB7IHRpbWVvdXQsIHBlbmRpbmdJZCB9ID0gc3VzcGVuc2U7CiAgICAgICAgICBpZiAodGltZW91dCA+IDApIHsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlLnBlbmRpbmdJZCA9PT0gcGVuZGluZ0lkKSB7CiAgICAgICAgICAgICAgICBzdXNwZW5zZS5mYWxsYmFjayhuZXdGYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgIH0gZWxzZSBpZiAodGltZW91dCA9PT0gMCkgewogICAgICAgICAgICBzdXNwZW5zZS5mYWxsYmFjayhuZXdGYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGxldCBoYXNXYXJuZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBjcmVhdGVTdXNwZW5zZUJvdW5kYXJ5KHZub2RlLCBwYXJlbnRTdXNwZW5zZSwgcGFyZW50Q29tcG9uZW50LCBjb250YWluZXIsIGhpZGRlbkNvbnRhaW5lciwgYW5jaG9yLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCByZW5kZXJlckludGVybmFscywgaXNIeWRyYXRpbmcgPSBmYWxzZSkgewogICAgaWYgKCFoYXNXYXJuZWQpIHsKICAgICAgaGFzV2FybmVkID0gdHJ1ZTsKICAgICAgY29uc29sZVtjb25zb2xlLmluZm8gPyAiaW5mbyIgOiAibG9nIl0oCiAgICAgICAgYDxTdXNwZW5zZT4gaXMgYW4gZXhwZXJpbWVudGFsIGZlYXR1cmUgYW5kIGl0cyBBUEkgd2lsbCBsaWtlbHkgY2hhbmdlLmAKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgcDogcGF0Y2gsCiAgICAgIG06IG1vdmUsCiAgICAgIHVtOiB1bm1vdW50LAogICAgICBuOiBuZXh0LAogICAgICBvOiB7IHBhcmVudE5vZGUsIHJlbW92ZSB9CiAgICB9ID0gcmVuZGVyZXJJbnRlcm5hbHM7CiAgICBsZXQgcGFyZW50U3VzcGVuc2VJZDsKICAgIGNvbnN0IGlzU3VzcGVuc2libGUgPSBpc1ZOb2RlU3VzcGVuc2libGUodm5vZGUpOwogICAgaWYgKGlzU3VzcGVuc2libGUpIHsKICAgICAgaWYgKHBhcmVudFN1c3BlbnNlID09IG51bGwgPyB2b2lkIDAgOiBwYXJlbnRTdXNwZW5zZS5wZW5kaW5nQnJhbmNoKSB7CiAgICAgICAgcGFyZW50U3VzcGVuc2VJZCA9IHBhcmVudFN1c3BlbnNlLnBlbmRpbmdJZDsKICAgICAgICBwYXJlbnRTdXNwZW5zZS5kZXBzKys7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRpbWVvdXQgPSB2bm9kZS5wcm9wcyA/IHRvTnVtYmVyKHZub2RlLnByb3BzLnRpbWVvdXQpIDogdm9pZCAwOwogICAgewogICAgICBhc3NlcnROdW1iZXIodGltZW91dCwgYFN1c3BlbnNlIHRpbWVvdXRgKTsKICAgIH0KICAgIGNvbnN0IGluaXRpYWxBbmNob3IgPSBhbmNob3I7CiAgICBjb25zdCBzdXNwZW5zZSA9IHsKICAgICAgdm5vZGUsCiAgICAgIHBhcmVudDogcGFyZW50U3VzcGVuc2UsCiAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgbmFtZXNwYWNlLAogICAgICBjb250YWluZXIsCiAgICAgIGhpZGRlbkNvbnRhaW5lciwKICAgICAgZGVwczogMCwKICAgICAgcGVuZGluZ0lkOiBzdXNwZW5zZUlkKyssCiAgICAgIHRpbWVvdXQ6IHR5cGVvZiB0aW1lb3V0ID09PSAibnVtYmVyIiA/IHRpbWVvdXQgOiAtMSwKICAgICAgYWN0aXZlQnJhbmNoOiBudWxsLAogICAgICBwZW5kaW5nQnJhbmNoOiBudWxsLAogICAgICBpc0luRmFsbGJhY2s6ICFpc0h5ZHJhdGluZywKICAgICAgaXNIeWRyYXRpbmcsCiAgICAgIGlzVW5tb3VudGVkOiBmYWxzZSwKICAgICAgZWZmZWN0czogW10sCiAgICAgIHJlc29sdmUocmVzdW1lID0gZmFsc2UsIHN5bmMgPSBmYWxzZSkgewogICAgICAgIHsKICAgICAgICAgIGlmICghcmVzdW1lICYmICFzdXNwZW5zZS5wZW5kaW5nQnJhbmNoKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBgc3VzcGVuc2UucmVzb2x2ZSgpIGlzIGNhbGxlZCB3aXRob3V0IGEgcGVuZGluZyBicmFuY2guYAogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN1c3BlbnNlLmlzVW5tb3VudGVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBgc3VzcGVuc2UucmVzb2x2ZSgpIGlzIGNhbGxlZCBvbiBhbiBhbHJlYWR5IHVubW91bnRlZCBzdXNwZW5zZSBib3VuZGFyeS5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsKICAgICAgICAgIHZub2RlOiB2bm9kZTIsCiAgICAgICAgICBhY3RpdmVCcmFuY2gsCiAgICAgICAgICBwZW5kaW5nQnJhbmNoLAogICAgICAgICAgcGVuZGluZ0lkLAogICAgICAgICAgZWZmZWN0cywKICAgICAgICAgIHBhcmVudENvbXBvbmVudDogcGFyZW50Q29tcG9uZW50MiwKICAgICAgICAgIGNvbnRhaW5lcjogY29udGFpbmVyMgogICAgICAgIH0gPSBzdXNwZW5zZTsKICAgICAgICBsZXQgZGVsYXlFbnRlciA9IGZhbHNlOwogICAgICAgIGlmIChzdXNwZW5zZS5pc0h5ZHJhdGluZykgewogICAgICAgICAgc3VzcGVuc2UuaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKCFyZXN1bWUpIHsKICAgICAgICAgIGRlbGF5RW50ZXIgPSBhY3RpdmVCcmFuY2ggJiYgcGVuZGluZ0JyYW5jaC50cmFuc2l0aW9uICYmIHBlbmRpbmdCcmFuY2gudHJhbnNpdGlvbi5tb2RlID09PSAib3V0LWluIjsKICAgICAgICAgIGlmIChkZWxheUVudGVyKSB7CiAgICAgICAgICAgIGFjdGl2ZUJyYW5jaC50cmFuc2l0aW9uLmFmdGVyTGVhdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgaWYgKHBlbmRpbmdJZCA9PT0gc3VzcGVuc2UucGVuZGluZ0lkKSB7CiAgICAgICAgICAgICAgICBtb3ZlKAogICAgICAgICAgICAgICAgICBwZW5kaW5nQnJhbmNoLAogICAgICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgICAgICBhbmNob3IgPT09IGluaXRpYWxBbmNob3IgPyBuZXh0KGFjdGl2ZUJyYW5jaCkgOiBhbmNob3IsCiAgICAgICAgICAgICAgICAgIDAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBxdWV1ZVBvc3RGbHVzaENiKGVmZmVjdHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhY3RpdmVCcmFuY2gpIHsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUoYWN0aXZlQnJhbmNoLmVsKSAhPT0gc3VzcGVuc2UuaGlkZGVuQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgYW5jaG9yID0gbmV4dChhY3RpdmVCcmFuY2gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVubW91bnQoYWN0aXZlQnJhbmNoLCBwYXJlbnRDb21wb25lbnQyLCBzdXNwZW5zZSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRlbGF5RW50ZXIpIHsKICAgICAgICAgICAgbW92ZShwZW5kaW5nQnJhbmNoLCBjb250YWluZXIyLCBhbmNob3IsIDApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIHBlbmRpbmdCcmFuY2gpOwogICAgICAgIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggPSBudWxsOwogICAgICAgIHN1c3BlbnNlLmlzSW5GYWxsYmFjayA9IGZhbHNlOwogICAgICAgIGxldCBwYXJlbnQgPSBzdXNwZW5zZS5wYXJlbnQ7CiAgICAgICAgbGV0IGhhc1VucmVzb2x2ZWRBbmNlc3RvciA9IGZhbHNlOwogICAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICAgIGlmIChwYXJlbnQucGVuZGluZ0JyYW5jaCkgewogICAgICAgICAgICBwYXJlbnQuZWZmZWN0cy5wdXNoKC4uLmVmZmVjdHMpOwogICAgICAgICAgICBoYXNVbnJlc29sdmVkQW5jZXN0b3IgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGlmICghaGFzVW5yZXNvbHZlZEFuY2VzdG9yICYmICFkZWxheUVudGVyKSB7CiAgICAgICAgICBxdWV1ZVBvc3RGbHVzaENiKGVmZmVjdHMpOwogICAgICAgIH0KICAgICAgICBzdXNwZW5zZS5lZmZlY3RzID0gW107CiAgICAgICAgaWYgKGlzU3VzcGVuc2libGUpIHsKICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZSAmJiBwYXJlbnRTdXNwZW5zZS5wZW5kaW5nQnJhbmNoICYmIHBhcmVudFN1c3BlbnNlSWQgPT09IHBhcmVudFN1c3BlbnNlLnBlbmRpbmdJZCkgewogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZS5kZXBzLS07CiAgICAgICAgICAgIGlmIChwYXJlbnRTdXNwZW5zZS5kZXBzID09PSAwICYmICFzeW5jKSB7CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRyaWdnZXJFdmVudCh2bm9kZTIsICJvblJlc29sdmUiKTsKICAgICAgfSwKICAgICAgZmFsbGJhY2soZmFsbGJhY2tWTm9kZSkgewogICAgICAgIGlmICghc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB7IHZub2RlOiB2bm9kZTIsIGFjdGl2ZUJyYW5jaCwgcGFyZW50Q29tcG9uZW50OiBwYXJlbnRDb21wb25lbnQyLCBjb250YWluZXI6IGNvbnRhaW5lcjIsIG5hbWVzcGFjZTogbmFtZXNwYWNlMiB9ID0gc3VzcGVuc2U7CiAgICAgICAgdHJpZ2dlckV2ZW50KHZub2RlMiwgIm9uRmFsbGJhY2siKTsKICAgICAgICBjb25zdCBhbmNob3IyID0gbmV4dChhY3RpdmVCcmFuY2gpOwogICAgICAgIGNvbnN0IG1vdW50RmFsbGJhY2sgPSAoKSA9PiB7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlLmlzSW5GYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgZmFsbGJhY2tWTm9kZSwKICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgYW5jaG9yMiwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50MiwKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gZmFsbGJhY2sgdHJlZSB3aWxsIG5vdCBoYXZlIHN1c3BlbnNlIGNvbnRleHQKICAgICAgICAgICAgbmFtZXNwYWNlMiwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgICBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIGZhbGxiYWNrVk5vZGUpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgZGVsYXlFbnRlciA9IGZhbGxiYWNrVk5vZGUudHJhbnNpdGlvbiAmJiBmYWxsYmFja1ZOb2RlLnRyYW5zaXRpb24ubW9kZSA9PT0gIm91dC1pbiI7CiAgICAgICAgaWYgKGRlbGF5RW50ZXIpIHsKICAgICAgICAgIGFjdGl2ZUJyYW5jaC50cmFuc2l0aW9uLmFmdGVyTGVhdmUgPSBtb3VudEZhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBzdXNwZW5zZS5pc0luRmFsbGJhY2sgPSB0cnVlOwogICAgICAgIHVubW91bnQoCiAgICAgICAgICBhY3RpdmVCcmFuY2gsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQyLAogICAgICAgICAgbnVsbCwKICAgICAgICAgIC8vIG5vIHN1c3BlbnNlIHNvIHVubW91bnQgaG9va3MgZmlyZSBub3cKICAgICAgICAgIHRydWUKICAgICAgICAgIC8vIHNob3VsZFJlbW92ZQogICAgICAgICk7CiAgICAgICAgaWYgKCFkZWxheUVudGVyKSB7CiAgICAgICAgICBtb3VudEZhbGxiYWNrKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBtb3ZlKGNvbnRhaW5lcjIsIGFuY2hvcjIsIHR5cGUpIHsKICAgICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2ggJiYgbW92ZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIGNvbnRhaW5lcjIsIGFuY2hvcjIsIHR5cGUpOwogICAgICAgIHN1c3BlbnNlLmNvbnRhaW5lciA9IGNvbnRhaW5lcjI7CiAgICAgIH0sCiAgICAgIG5leHQoKSB7CiAgICAgICAgcmV0dXJuIHN1c3BlbnNlLmFjdGl2ZUJyYW5jaCAmJiBuZXh0KHN1c3BlbnNlLmFjdGl2ZUJyYW5jaCk7CiAgICAgIH0sCiAgICAgIHJlZ2lzdGVyRGVwKGluc3RhbmNlLCBzZXR1cFJlbmRlckVmZmVjdCkgewogICAgICAgIGNvbnN0IGlzSW5QZW5kaW5nU3VzcGVuc2UgPSAhIXN1c3BlbnNlLnBlbmRpbmdCcmFuY2g7CiAgICAgICAgaWYgKGlzSW5QZW5kaW5nU3VzcGVuc2UpIHsKICAgICAgICAgIHN1c3BlbnNlLmRlcHMrKzsKICAgICAgICB9CiAgICAgICAgY29uc3QgaHlkcmF0ZWRFbCA9IGluc3RhbmNlLnZub2RlLmVsOwogICAgICAgIGluc3RhbmNlLmFzeW5jRGVwLmNhdGNoKChlcnIpID0+IHsKICAgICAgICAgIGhhbmRsZUVycm9yKGVyciwgaW5zdGFuY2UsIDApOwogICAgICAgIH0pLnRoZW4oKGFzeW5jU2V0dXBSZXN1bHQpID0+IHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5pc1VubW91bnRlZCB8fCBzdXNwZW5zZS5pc1VubW91bnRlZCB8fCBzdXNwZW5zZS5wZW5kaW5nSWQgIT09IGluc3RhbmNlLnN1c3BlbnNlSWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UuYXN5bmNSZXNvbHZlZCA9IHRydWU7CiAgICAgICAgICBjb25zdCB7IHZub2RlOiB2bm9kZTIgfSA9IGluc3RhbmNlOwogICAgICAgICAgewogICAgICAgICAgICBwdXNoV2FybmluZ0NvbnRleHQodm5vZGUyKTsKICAgICAgICAgIH0KICAgICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCBhc3luY1NldHVwUmVzdWx0LCBmYWxzZSk7CiAgICAgICAgICBpZiAoaHlkcmF0ZWRFbCkgewogICAgICAgICAgICB2bm9kZTIuZWwgPSBoeWRyYXRlZEVsOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcGxhY2Vob2xkZXIgPSAhaHlkcmF0ZWRFbCAmJiBpbnN0YW5jZS5zdWJUcmVlLmVsOwogICAgICAgICAgc2V0dXBSZW5kZXJFZmZlY3QoCiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICB2bm9kZTIsCiAgICAgICAgICAgIC8vIGNvbXBvbmVudCBtYXkgaGF2ZSBiZWVuIG1vdmVkIGJlZm9yZSByZXNvbHZlLgogICAgICAgICAgICAvLyBpZiB0aGlzIGlzIG5vdCBhIGh5ZHJhdGlvbiwgaW5zdGFuY2Uuc3ViVHJlZSB3aWxsIGJlIHRoZSBjb21tZW50CiAgICAgICAgICAgIC8vIHBsYWNlaG9sZGVyLgogICAgICAgICAgICBwYXJlbnROb2RlKGh5ZHJhdGVkRWwgfHwgaW5zdGFuY2Uuc3ViVHJlZS5lbCksCiAgICAgICAgICAgIC8vIGFuY2hvciB3aWxsIG5vdCBiZSB1c2VkIGlmIHRoaXMgaXMgaHlkcmF0aW9uLCBzbyBvbmx5IG5lZWQgdG8KICAgICAgICAgICAgLy8gY29uc2lkZXIgdGhlIGNvbW1lbnQgcGxhY2Vob2xkZXIgY2FzZS4KICAgICAgICAgICAgaHlkcmF0ZWRFbCA/IG51bGwgOiBuZXh0KGluc3RhbmNlLnN1YlRyZWUpLAogICAgICAgICAgICBzdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgICBpZiAocGxhY2Vob2xkZXIpIHsKICAgICAgICAgICAgcmVtb3ZlKHBsYWNlaG9sZGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUhPQ0hvc3RFbChpbnN0YW5jZSwgdm5vZGUyLmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wV2FybmluZ0NvbnRleHQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0luUGVuZGluZ1N1c3BlbnNlICYmIC0tc3VzcGVuc2UuZGVwcyA9PT0gMCkgewogICAgICAgICAgICBzdXNwZW5zZS5yZXNvbHZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIHVubW91bnQocGFyZW50U3VzcGVuc2UyLCBkb1JlbW92ZSkgewogICAgICAgIHN1c3BlbnNlLmlzVW5tb3VudGVkID0gdHJ1ZTsKICAgICAgICBpZiAoc3VzcGVuc2UuYWN0aXZlQnJhbmNoKSB7CiAgICAgICAgICB1bm1vdW50KAogICAgICAgICAgICBzdXNwZW5zZS5hY3RpdmVCcmFuY2gsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UyLAogICAgICAgICAgICBkb1JlbW92ZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN1c3BlbnNlLnBlbmRpbmdCcmFuY2gpIHsKICAgICAgICAgIHVubW91bnQoCiAgICAgICAgICAgIHN1c3BlbnNlLnBlbmRpbmdCcmFuY2gsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UyLAogICAgICAgICAgICBkb1JlbW92ZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gc3VzcGVuc2U7CiAgfQogIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZShub2RlLCB2bm9kZSwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCwgcmVuZGVyZXJJbnRlcm5hbHMsIGh5ZHJhdGVOb2RlKSB7CiAgICBjb25zdCBzdXNwZW5zZSA9IHZub2RlLnN1c3BlbnNlID0gY3JlYXRlU3VzcGVuc2VCb3VuZGFyeSgKICAgICAgdm5vZGUsCiAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgIG5vZGUucGFyZW50Tm9kZSwKICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXJlc3RyaWN0ZWQtZ2xvYmFscwogICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgbnVsbCwKICAgICAgbmFtZXNwYWNlLAogICAgICBzbG90U2NvcGVJZHMsCiAgICAgIG9wdGltaXplZCwKICAgICAgcmVuZGVyZXJJbnRlcm5hbHMsCiAgICAgIHRydWUKICAgICk7CiAgICBjb25zdCByZXN1bHQgPSBoeWRyYXRlTm9kZSgKICAgICAgbm9kZSwKICAgICAgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCA9IHZub2RlLnNzQ29udGVudCwKICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICBzdXNwZW5zZSwKICAgICAgc2xvdFNjb3BlSWRzLAogICAgICBvcHRpbWl6ZWQKICAgICk7CiAgICBpZiAoc3VzcGVuc2UuZGVwcyA9PT0gMCkgewogICAgICBzdXNwZW5zZS5yZXNvbHZlKGZhbHNlLCB0cnVlKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVN1c3BlbnNlQ2hpbGRyZW4odm5vZGUpIHsKICAgIGNvbnN0IHsgc2hhcGVGbGFnLCBjaGlsZHJlbiB9ID0gdm5vZGU7CiAgICBjb25zdCBpc1Nsb3RDaGlsZHJlbiA9IHNoYXBlRmxhZyAmIDMyOwogICAgdm5vZGUuc3NDb250ZW50ID0gbm9ybWFsaXplU3VzcGVuc2VTbG90KAogICAgICBpc1Nsb3RDaGlsZHJlbiA/IGNoaWxkcmVuLmRlZmF1bHQgOiBjaGlsZHJlbgogICAgKTsKICAgIHZub2RlLnNzRmFsbGJhY2sgPSBpc1Nsb3RDaGlsZHJlbiA/IG5vcm1hbGl6ZVN1c3BlbnNlU2xvdChjaGlsZHJlbi5mYWxsYmFjaykgOiBjcmVhdGVWTm9kZShDb21tZW50KTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplU3VzcGVuc2VTbG90KHMpIHsKICAgIGxldCBibG9jazsKICAgIGlmIChpc0Z1bmN0aW9uKHMpKSB7CiAgICAgIGNvbnN0IHRyYWNrQmxvY2sgPSBpc0Jsb2NrVHJlZUVuYWJsZWQgJiYgcy5fYzsKICAgICAgaWYgKHRyYWNrQmxvY2spIHsKICAgICAgICBzLl9kID0gZmFsc2U7CiAgICAgICAgb3BlbkJsb2NrKCk7CiAgICAgIH0KICAgICAgcyA9IHMoKTsKICAgICAgaWYgKHRyYWNrQmxvY2spIHsKICAgICAgICBzLl9kID0gdHJ1ZTsKICAgICAgICBibG9jayA9IGN1cnJlbnRCbG9jazsKICAgICAgICBjbG9zZUJsb2NrKCk7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc0FycmF5KHMpKSB7CiAgICAgIGNvbnN0IHNpbmdsZUNoaWxkID0gZmlsdGVyU2luZ2xlUm9vdChzKTsKICAgICAgaWYgKCFzaW5nbGVDaGlsZCAmJiBzLmZpbHRlcigoY2hpbGQpID0+IGNoaWxkICE9PSBOVUxMX0RZTkFNSUNfQ09NUE9ORU5UKS5sZW5ndGggPiAwKSB7CiAgICAgICAgd2FybiQxKGA8U3VzcGVuc2U+IHNsb3RzIGV4cGVjdCBhIHNpbmdsZSByb290IG5vZGUuYCk7CiAgICAgIH0KICAgICAgcyA9IHNpbmdsZUNoaWxkOwogICAgfQogICAgcyA9IG5vcm1hbGl6ZVZOb2RlKHMpOwogICAgaWYgKGJsb2NrICYmICFzLmR5bmFtaWNDaGlsZHJlbikgewogICAgICBzLmR5bmFtaWNDaGlsZHJlbiA9IGJsb2NrLmZpbHRlcigoYykgPT4gYyAhPT0gcyk7CiAgICB9CiAgICByZXR1cm4gczsKICB9CiAgZnVuY3Rpb24gcXVldWVFZmZlY3RXaXRoU3VzcGVuc2UoZm4sIHN1c3BlbnNlKSB7CiAgICBpZiAoc3VzcGVuc2UgJiYgc3VzcGVuc2UucGVuZGluZ0JyYW5jaCkgewogICAgICBpZiAoaXNBcnJheShmbikpIHsKICAgICAgICBzdXNwZW5zZS5lZmZlY3RzLnB1c2goLi4uZm4pOwogICAgICB9IGVsc2UgewogICAgICAgIHN1c3BlbnNlLmVmZmVjdHMucHVzaChmbik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHF1ZXVlUG9zdEZsdXNoQ2IoZm4pOwogICAgfQogIH0KICBmdW5jdGlvbiBzZXRBY3RpdmVCcmFuY2goc3VzcGVuc2UsIGJyYW5jaCkgewogICAgc3VzcGVuc2UuYWN0aXZlQnJhbmNoID0gYnJhbmNoOwogICAgY29uc3QgeyB2bm9kZSwgcGFyZW50Q29tcG9uZW50IH0gPSBzdXNwZW5zZTsKICAgIGxldCBlbCA9IGJyYW5jaC5lbDsKICAgIHdoaWxlICghZWwgJiYgYnJhbmNoLmNvbXBvbmVudCkgewogICAgICBicmFuY2ggPSBicmFuY2guY29tcG9uZW50LnN1YlRyZWU7CiAgICAgIGVsID0gYnJhbmNoLmVsOwogICAgfQogICAgdm5vZGUuZWwgPSBlbDsKICAgIGlmIChwYXJlbnRDb21wb25lbnQgJiYgcGFyZW50Q29tcG9uZW50LnN1YlRyZWUgPT09IHZub2RlKSB7CiAgICAgIHBhcmVudENvbXBvbmVudC52bm9kZS5lbCA9IGVsOwogICAgICB1cGRhdGVIT0NIb3N0RWwocGFyZW50Q29tcG9uZW50LCBlbCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzVk5vZGVTdXNwZW5zaWJsZSh2bm9kZSkgewogICAgdmFyIF9hOwogICAgcmV0dXJuICgoX2EgPSB2bm9kZS5wcm9wcykgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnN1c3BlbnNpYmxlKSAhPSBudWxsICYmIHZub2RlLnByb3BzLnN1c3BlbnNpYmxlICE9PSBmYWxzZTsKICB9CgogIGNvbnN0IHNzckNvbnRleHRLZXkgPSBTeW1ib2wuZm9yKCJ2LXNjeCIpOwogIGNvbnN0IHVzZVNTUkNvbnRleHQgPSAoKSA9PiB7CiAgICB7CiAgICAgIHdhcm4kMShgdXNlU1NSQ29udGV4dCgpIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGdsb2JhbCBidWlsZC5gKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiB3YXRjaEVmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBkb1dhdGNoKGVmZmVjdCwgbnVsbCwgb3B0aW9ucyk7CiAgfQogIGZ1bmN0aW9uIHdhdGNoUG9zdEVmZmVjdChlZmZlY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBkb1dhdGNoKAogICAgICBlZmZlY3QsCiAgICAgIG51bGwsCiAgICAgIGV4dGVuZCh7fSwgb3B0aW9ucywgeyBmbHVzaDogInBvc3QiIH0pIAogICAgKTsKICB9CiAgZnVuY3Rpb24gd2F0Y2hTeW5jRWZmZWN0KGVmZmVjdCwgb3B0aW9ucykgewogICAgcmV0dXJuIGRvV2F0Y2goCiAgICAgIGVmZmVjdCwKICAgICAgbnVsbCwKICAgICAgZXh0ZW5kKHt9LCBvcHRpb25zLCB7IGZsdXNoOiAic3luYyIgfSkgCiAgICApOwogIH0KICBjb25zdCBJTklUSUFMX1dBVENIRVJfVkFMVUUgPSB7fTsKICBmdW5jdGlvbiB3YXRjaChzb3VyY2UsIGNiLCBvcHRpb25zKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24oY2IpKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgXGB3YXRjaChmbiwgb3B0aW9ucz8pXGAgc2lnbmF0dXJlIGhhcyBiZWVuIG1vdmVkIHRvIGEgc2VwYXJhdGUgQVBJLiBVc2UgXGB3YXRjaEVmZmVjdChmbiwgb3B0aW9ucz8pXGAgaW5zdGVhZC4gXGB3YXRjaFxgIG5vdyBvbmx5IHN1cHBvcnRzIFxgd2F0Y2goc291cmNlLCBjYiwgb3B0aW9ucz8pIHNpZ25hdHVyZS5gCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gZG9XYXRjaChzb3VyY2UsIGNiLCBvcHRpb25zKTsKICB9CiAgZnVuY3Rpb24gZG9XYXRjaChzb3VyY2UsIGNiLCB7CiAgICBpbW1lZGlhdGUsCiAgICBkZWVwLAogICAgZmx1c2gsCiAgICBvbmNlLAogICAgb25UcmFjaywKICAgIG9uVHJpZ2dlcgogIH0gPSBFTVBUWV9PQkopIHsKICAgIGlmIChjYiAmJiBvbmNlKSB7CiAgICAgIGNvbnN0IF9jYiA9IGNiOwogICAgICBjYiA9ICguLi5hcmdzKSA9PiB7CiAgICAgICAgX2NiKC4uLmFyZ3MpOwogICAgICAgIHVud2F0Y2goKTsKICAgICAgfTsKICAgIH0KICAgIGlmIChkZWVwICE9PSB2b2lkIDAgJiYgdHlwZW9mIGRlZXAgPT09ICJudW1iZXIiKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgd2F0Y2goKSAiZGVlcCIgb3B0aW9uIHdpdGggbnVtYmVyIHZhbHVlIHdpbGwgYmUgdXNlZCBhcyB3YXRjaCBkZXB0aCBpbiBmdXR1cmUgdmVyc2lvbnMuIFBsZWFzZSB1c2UgYSBib29sZWFuIGluc3RlYWQgdG8gYXZvaWQgcG90ZW50aWFsIGJyZWFrYWdlLmAKICAgICAgKTsKICAgIH0KICAgIGlmICghY2IpIHsKICAgICAgaWYgKGltbWVkaWF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYHdhdGNoKCkgImltbWVkaWF0ZSIgb3B0aW9uIGlzIG9ubHkgcmVzcGVjdGVkIHdoZW4gdXNpbmcgdGhlIHdhdGNoKHNvdXJjZSwgY2FsbGJhY2ssIG9wdGlvbnM/KSBzaWduYXR1cmUuYAogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKGRlZXAgIT09IHZvaWQgMCkgewogICAgICAgIHdhcm4kMSgKICAgICAgICAgIGB3YXRjaCgpICJkZWVwIiBvcHRpb24gaXMgb25seSByZXNwZWN0ZWQgd2hlbiB1c2luZyB0aGUgd2F0Y2goc291cmNlLCBjYWxsYmFjaywgb3B0aW9ucz8pIHNpZ25hdHVyZS5gCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAob25jZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYHdhdGNoKCkgIm9uY2UiIG9wdGlvbiBpcyBvbmx5IHJlc3BlY3RlZCB3aGVuIHVzaW5nIHRoZSB3YXRjaChzb3VyY2UsIGNhbGxiYWNrLCBvcHRpb25zPykgc2lnbmF0dXJlLmAKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBjb25zdCB3YXJuSW52YWxpZFNvdXJjZSA9IChzKSA9PiB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgSW52YWxpZCB3YXRjaCBzb3VyY2U6IGAsCiAgICAgICAgcywKICAgICAgICBgQSB3YXRjaCBzb3VyY2UgY2FuIG9ubHkgYmUgYSBnZXR0ZXIvZWZmZWN0IGZ1bmN0aW9uLCBhIHJlZiwgYSByZWFjdGl2ZSBvYmplY3QsIG9yIGFuIGFycmF5IG9mIHRoZXNlIHR5cGVzLmAKICAgICAgKTsKICAgIH07CiAgICBjb25zdCBpbnN0YW5jZSA9IGN1cnJlbnRJbnN0YW5jZTsKICAgIGNvbnN0IHJlYWN0aXZlR2V0dGVyID0gKHNvdXJjZTIpID0+IGRlZXAgPT09IHRydWUgPyBzb3VyY2UyIDogKAogICAgICAvLyBmb3IgZGVlcDogZmFsc2UsIG9ubHkgdHJhdmVyc2Ugcm9vdC1sZXZlbCBwcm9wZXJ0aWVzCiAgICAgIHRyYXZlcnNlKHNvdXJjZTIsIGRlZXAgPT09IGZhbHNlID8gMSA6IHZvaWQgMCkKICAgICk7CiAgICBsZXQgZ2V0dGVyOwogICAgbGV0IGZvcmNlVHJpZ2dlciA9IGZhbHNlOwogICAgbGV0IGlzTXVsdGlTb3VyY2UgPSBmYWxzZTsKICAgIGlmIChpc1JlZihzb3VyY2UpKSB7CiAgICAgIGdldHRlciA9ICgpID0+IHNvdXJjZS52YWx1ZTsKICAgICAgZm9yY2VUcmlnZ2VyID0gaXNTaGFsbG93KHNvdXJjZSk7CiAgICB9IGVsc2UgaWYgKGlzUmVhY3RpdmUoc291cmNlKSkgewogICAgICBnZXR0ZXIgPSAoKSA9PiByZWFjdGl2ZUdldHRlcihzb3VyY2UpOwogICAgICBmb3JjZVRyaWdnZXIgPSB0cnVlOwogICAgfSBlbHNlIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgaXNNdWx0aVNvdXJjZSA9IHRydWU7CiAgICAgIGZvcmNlVHJpZ2dlciA9IHNvdXJjZS5zb21lKChzKSA9PiBpc1JlYWN0aXZlKHMpIHx8IGlzU2hhbGxvdyhzKSk7CiAgICAgIGdldHRlciA9ICgpID0+IHNvdXJjZS5tYXAoKHMpID0+IHsKICAgICAgICBpZiAoaXNSZWYocykpIHsKICAgICAgICAgIHJldHVybiBzLnZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoaXNSZWFjdGl2ZShzKSkgewogICAgICAgICAgcmV0dXJuIHJlYWN0aXZlR2V0dGVyKHMpOwogICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihzKSkgewogICAgICAgICAgcmV0dXJuIGNhbGxXaXRoRXJyb3JIYW5kbGluZyhzLCBpbnN0YW5jZSwgMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5JbnZhbGlkU291cmNlKHMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc291cmNlKSkgewogICAgICBpZiAoY2IpIHsKICAgICAgICBnZXR0ZXIgPSAoKSA9PiBjYWxsV2l0aEVycm9ySGFuZGxpbmcoc291cmNlLCBpbnN0YW5jZSwgMik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZ2V0dGVyID0gKCkgPT4gewogICAgICAgICAgaWYgKGNsZWFudXApIHsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKAogICAgICAgICAgICBzb3VyY2UsCiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAzLAogICAgICAgICAgICBbb25DbGVhbnVwXQogICAgICAgICAgKTsKICAgICAgICB9OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBnZXR0ZXIgPSBOT09QOwogICAgICB3YXJuSW52YWxpZFNvdXJjZShzb3VyY2UpOwogICAgfQogICAgaWYgKGNiICYmIGRlZXApIHsKICAgICAgY29uc3QgYmFzZUdldHRlciA9IGdldHRlcjsKICAgICAgZ2V0dGVyID0gKCkgPT4gdHJhdmVyc2UoYmFzZUdldHRlcigpKTsKICAgIH0KICAgIGxldCBjbGVhbnVwOwogICAgbGV0IG9uQ2xlYW51cCA9IChmbikgPT4gewogICAgICBjbGVhbnVwID0gZWZmZWN0Lm9uU3RvcCA9ICgpID0+IHsKICAgICAgICBjYWxsV2l0aEVycm9ySGFuZGxpbmcoZm4sIGluc3RhbmNlLCA0KTsKICAgICAgICBjbGVhbnVwID0gZWZmZWN0Lm9uU3RvcCA9IHZvaWQgMDsKICAgICAgfTsKICAgIH07CiAgICBsZXQgb2xkVmFsdWUgPSBpc011bHRpU291cmNlID8gbmV3IEFycmF5KHNvdXJjZS5sZW5ndGgpLmZpbGwoSU5JVElBTF9XQVRDSEVSX1ZBTFVFKSA6IElOSVRJQUxfV0FUQ0hFUl9WQUxVRTsKICAgIGNvbnN0IGpvYiA9ICgpID0+IHsKICAgICAgaWYgKCFlZmZlY3QuYWN0aXZlIHx8ICFlZmZlY3QuZGlydHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGNiKSB7CiAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBlZmZlY3QucnVuKCk7CiAgICAgICAgaWYgKGRlZXAgfHwgZm9yY2VUcmlnZ2VyIHx8IChpc011bHRpU291cmNlID8gbmV3VmFsdWUuc29tZSgodiwgaSkgPT4gaGFzQ2hhbmdlZCh2LCBvbGRWYWx1ZVtpXSkpIDogaGFzQ2hhbmdlZChuZXdWYWx1ZSwgb2xkVmFsdWUpKSB8fCBmYWxzZSkgewogICAgICAgICAgaWYgKGNsZWFudXApIHsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoY2IsIGluc3RhbmNlLCAzLCBbCiAgICAgICAgICAgIG5ld1ZhbHVlLAogICAgICAgICAgICAvLyBwYXNzIHVuZGVmaW5lZCBhcyB0aGUgb2xkIHZhbHVlIHdoZW4gaXQncyBjaGFuZ2VkIGZvciB0aGUgZmlyc3QgdGltZQogICAgICAgICAgICBvbGRWYWx1ZSA9PT0gSU5JVElBTF9XQVRDSEVSX1ZBTFVFID8gdm9pZCAwIDogaXNNdWx0aVNvdXJjZSAmJiBvbGRWYWx1ZVswXSA9PT0gSU5JVElBTF9XQVRDSEVSX1ZBTFVFID8gW10gOiBvbGRWYWx1ZSwKICAgICAgICAgICAgb25DbGVhbnVwCiAgICAgICAgICBdKTsKICAgICAgICAgIG9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGVmZmVjdC5ydW4oKTsKICAgICAgfQogICAgfTsKICAgIGpvYi5hbGxvd1JlY3Vyc2UgPSAhIWNiOwogICAgbGV0IHNjaGVkdWxlcjsKICAgIGlmIChmbHVzaCA9PT0gInN5bmMiKSB7CiAgICAgIHNjaGVkdWxlciA9IGpvYjsKICAgIH0gZWxzZSBpZiAoZmx1c2ggPT09ICJwb3N0IikgewogICAgICBzY2hlZHVsZXIgPSAoKSA9PiBxdWV1ZVBvc3RSZW5kZXJFZmZlY3Qoam9iLCBpbnN0YW5jZSAmJiBpbnN0YW5jZS5zdXNwZW5zZSk7CiAgICB9IGVsc2UgewogICAgICBqb2IucHJlID0gdHJ1ZTsKICAgICAgaWYgKGluc3RhbmNlKQogICAgICAgIGpvYi5pZCA9IGluc3RhbmNlLnVpZDsKICAgICAgc2NoZWR1bGVyID0gKCkgPT4gcXVldWVKb2Ioam9iKTsKICAgIH0KICAgIGNvbnN0IGVmZmVjdCA9IG5ldyBSZWFjdGl2ZUVmZmVjdChnZXR0ZXIsIE5PT1AsIHNjaGVkdWxlcik7CiAgICBjb25zdCBzY29wZSA9IGdldEN1cnJlbnRTY29wZSgpOwogICAgY29uc3QgdW53YXRjaCA9ICgpID0+IHsKICAgICAgZWZmZWN0LnN0b3AoKTsKICAgICAgaWYgKHNjb3BlKSB7CiAgICAgICAgcmVtb3ZlKHNjb3BlLmVmZmVjdHMsIGVmZmVjdCk7CiAgICAgIH0KICAgIH07CiAgICB7CiAgICAgIGVmZmVjdC5vblRyYWNrID0gb25UcmFjazsKICAgICAgZWZmZWN0Lm9uVHJpZ2dlciA9IG9uVHJpZ2dlcjsKICAgIH0KICAgIGlmIChjYikgewogICAgICBpZiAoaW1tZWRpYXRlKSB7CiAgICAgICAgam9iKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2xkVmFsdWUgPSBlZmZlY3QucnVuKCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZmx1c2ggPT09ICJwb3N0IikgewogICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoCiAgICAgICAgZWZmZWN0LnJ1bi5iaW5kKGVmZmVjdCksCiAgICAgICAgaW5zdGFuY2UgJiYgaW5zdGFuY2Uuc3VzcGVuc2UKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIGVmZmVjdC5ydW4oKTsKICAgIH0KICAgIHJldHVybiB1bndhdGNoOwogIH0KICBmdW5jdGlvbiBpbnN0YW5jZVdhdGNoKHNvdXJjZSwgdmFsdWUsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHB1YmxpY1RoaXMgPSB0aGlzLnByb3h5OwogICAgY29uc3QgZ2V0dGVyID0gaXNTdHJpbmcoc291cmNlKSA/IHNvdXJjZS5pbmNsdWRlcygiLiIpID8gY3JlYXRlUGF0aEdldHRlcihwdWJsaWNUaGlzLCBzb3VyY2UpIDogKCkgPT4gcHVibGljVGhpc1tzb3VyY2VdIDogc291cmNlLmJpbmQocHVibGljVGhpcywgcHVibGljVGhpcyk7CiAgICBsZXQgY2I7CiAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgY2IgPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGNiID0gdmFsdWUuaGFuZGxlcjsKICAgICAgb3B0aW9ucyA9IHZhbHVlOwogICAgfQogICAgY29uc3QgcmVzZXQgPSBzZXRDdXJyZW50SW5zdGFuY2UodGhpcyk7CiAgICBjb25zdCByZXMgPSBkb1dhdGNoKGdldHRlciwgY2IuYmluZChwdWJsaWNUaGlzKSwgb3B0aW9ucyk7CiAgICByZXNldCgpOwogICAgcmV0dXJuIHJlczsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUGF0aEdldHRlcihjdHgsIHBhdGgpIHsKICAgIGNvbnN0IHNlZ21lbnRzID0gcGF0aC5zcGxpdCgiLiIpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgbGV0IGN1ciA9IGN0eDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWdtZW50cy5sZW5ndGggJiYgY3VyOyBpKyspIHsKICAgICAgICBjdXIgPSBjdXJbc2VnbWVudHNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiBjdXI7CiAgICB9OwogIH0KICBmdW5jdGlvbiB0cmF2ZXJzZSh2YWx1ZSwgZGVwdGgsIGN1cnJlbnREZXB0aCA9IDAsIHNlZW4pIHsKICAgIGlmICghaXNPYmplY3QodmFsdWUpIHx8IHZhbHVlWyJfX3Zfc2tpcCJdKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmIChkZXB0aCAmJiBkZXB0aCA+IDApIHsKICAgICAgaWYgKGN1cnJlbnREZXB0aCA+PSBkZXB0aCkgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBjdXJyZW50RGVwdGgrKzsKICAgIH0KICAgIHNlZW4gPSBzZWVuIHx8IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBpZiAoc2Vlbi5oYXModmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHNlZW4uYWRkKHZhbHVlKTsKICAgIGlmIChpc1JlZih2YWx1ZSkpIHsKICAgICAgdHJhdmVyc2UodmFsdWUudmFsdWUsIGRlcHRoLCBjdXJyZW50RGVwdGgsIHNlZW4pOwogICAgfSBlbHNlIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdHJhdmVyc2UodmFsdWVbaV0sIGRlcHRoLCBjdXJyZW50RGVwdGgsIHNlZW4pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzU2V0KHZhbHVlKSB8fCBpc01hcCh2YWx1ZSkpIHsKICAgICAgdmFsdWUuZm9yRWFjaCgodikgPT4gewogICAgICAgIHRyYXZlcnNlKHYsIGRlcHRoLCBjdXJyZW50RGVwdGgsIHNlZW4pOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsdWUpIHsKICAgICAgICB0cmF2ZXJzZSh2YWx1ZVtrZXldLCBkZXB0aCwgY3VycmVudERlcHRoLCBzZWVuKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgZnVuY3Rpb24gdmFsaWRhdGVEaXJlY3RpdmVOYW1lKG5hbWUpIHsKICAgIGlmIChpc0J1aWx0SW5EaXJlY3RpdmUobmFtZSkpIHsKICAgICAgd2FybiQxKCJEbyBub3QgdXNlIGJ1aWx0LWluIGRpcmVjdGl2ZSBpZHMgYXMgY3VzdG9tIGRpcmVjdGl2ZSBpZDogIiArIG5hbWUpOwogICAgfQogIH0KICBmdW5jdGlvbiB3aXRoRGlyZWN0aXZlcyh2bm9kZSwgZGlyZWN0aXZlcykgewogICAgaWYgKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICB3YXJuJDEoYHdpdGhEaXJlY3RpdmVzIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHJlbmRlciBmdW5jdGlvbnMuYCk7CiAgICAgIHJldHVybiB2bm9kZTsKICAgIH0KICAgIGNvbnN0IGluc3RhbmNlID0gZ2V0RXhwb3NlUHJveHkoY3VycmVudFJlbmRlcmluZ0luc3RhbmNlKSB8fCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UucHJveHk7CiAgICBjb25zdCBiaW5kaW5ncyA9IHZub2RlLmRpcnMgfHwgKHZub2RlLmRpcnMgPSBbXSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRpcmVjdGl2ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgbGV0IFtkaXIsIHZhbHVlLCBhcmcsIG1vZGlmaWVycyA9IEVNUFRZX09CSl0gPSBkaXJlY3RpdmVzW2ldOwogICAgICBpZiAoZGlyKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyKSkgewogICAgICAgICAgZGlyID0gewogICAgICAgICAgICBtb3VudGVkOiBkaXIsCiAgICAgICAgICAgIHVwZGF0ZWQ6IGRpcgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpci5kZWVwKSB7CiAgICAgICAgICB0cmF2ZXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGJpbmRpbmdzLnB1c2goewogICAgICAgICAgZGlyLAogICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIG9sZFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICBhcmcsCiAgICAgICAgICBtb2RpZmllcnMKICAgICAgICB9KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHZub2RlOwogIH0KICBmdW5jdGlvbiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBwcmV2Vk5vZGUsIGluc3RhbmNlLCBuYW1lKSB7CiAgICBjb25zdCBiaW5kaW5ncyA9IHZub2RlLmRpcnM7CiAgICBjb25zdCBvbGRCaW5kaW5ncyA9IHByZXZWTm9kZSAmJiBwcmV2Vk5vZGUuZGlyczsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgYmluZGluZyA9IGJpbmRpbmdzW2ldOwogICAgICBpZiAob2xkQmluZGluZ3MpIHsKICAgICAgICBiaW5kaW5nLm9sZFZhbHVlID0gb2xkQmluZGluZ3NbaV0udmFsdWU7CiAgICAgIH0KICAgICAgbGV0IGhvb2sgPSBiaW5kaW5nLmRpcltuYW1lXTsKICAgICAgaWYgKGhvb2spIHsKICAgICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoaG9vaywgaW5zdGFuY2UsIDgsIFsKICAgICAgICAgIHZub2RlLmVsLAogICAgICAgICAgYmluZGluZywKICAgICAgICAgIHZub2RlLAogICAgICAgICAgcHJldlZOb2RlCiAgICAgICAgXSk7CiAgICAgICAgcmVzZXRUcmFja2luZygpOwogICAgICB9CiAgICB9CiAgfQoKICBjb25zdCBsZWF2ZUNiS2V5ID0gU3ltYm9sKCJfbGVhdmVDYiIpOwogIGNvbnN0IGVudGVyQ2JLZXkkMSA9IFN5bWJvbCgiX2VudGVyQ2IiKTsKICBmdW5jdGlvbiB1c2VUcmFuc2l0aW9uU3RhdGUoKSB7CiAgICBjb25zdCBzdGF0ZSA9IHsKICAgICAgaXNNb3VudGVkOiBmYWxzZSwKICAgICAgaXNMZWF2aW5nOiBmYWxzZSwKICAgICAgaXNVbm1vdW50aW5nOiBmYWxzZSwKICAgICAgbGVhdmluZ1ZOb2RlczogLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKQogICAgfTsKICAgIG9uTW91bnRlZCgoKSA9PiB7CiAgICAgIHN0YXRlLmlzTW91bnRlZCA9IHRydWU7CiAgICB9KTsKICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7CiAgICAgIHN0YXRlLmlzVW5tb3VudGluZyA9IHRydWU7CiAgICB9KTsKICAgIHJldHVybiBzdGF0ZTsKICB9CiAgY29uc3QgVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IgPSBbRnVuY3Rpb24sIEFycmF5XTsKICBjb25zdCBCYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycyA9IHsKICAgIG1vZGU6IFN0cmluZywKICAgIGFwcGVhcjogQm9vbGVhbiwKICAgIHBlcnNpc3RlZDogQm9vbGVhbiwKICAgIC8vIGVudGVyCiAgICBvbkJlZm9yZUVudGVyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgIG9uRW50ZXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgb25BZnRlckVudGVyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgIG9uRW50ZXJDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgLy8gbGVhdmUKICAgIG9uQmVmb3JlTGVhdmU6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgb25MZWF2ZTogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsCiAgICBvbkFmdGVyTGVhdmU6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgb25MZWF2ZUNhbmNlbGxlZDogVHJhbnNpdGlvbkhvb2tWYWxpZGF0b3IsCiAgICAvLyBhcHBlYXIKICAgIG9uQmVmb3JlQXBwZWFyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgIG9uQXBwZWFyOiBUcmFuc2l0aW9uSG9va1ZhbGlkYXRvciwKICAgIG9uQWZ0ZXJBcHBlYXI6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yLAogICAgb25BcHBlYXJDYW5jZWxsZWQ6IFRyYW5zaXRpb25Ib29rVmFsaWRhdG9yCiAgfTsKICBjb25zdCBCYXNlVHJhbnNpdGlvbkltcGwgPSB7CiAgICBuYW1lOiBgQmFzZVRyYW5zaXRpb25gLAogICAgcHJvcHM6IEJhc2VUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzLAogICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICBjb25zdCBzdGF0ZSA9IHVzZVRyYW5zaXRpb25TdGF0ZSgpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGNvbnN0IGNoaWxkcmVuID0gc2xvdHMuZGVmYXVsdCAmJiBnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4oc2xvdHMuZGVmYXVsdCgpLCB0cnVlKTsKICAgICAgICBpZiAoIWNoaWxkcmVuIHx8ICFjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbGV0IGNoaWxkID0gY2hpbGRyZW5bMF07CiAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIGxldCBoYXNGb3VuZCA9IGZhbHNlOwogICAgICAgICAgZm9yIChjb25zdCBjIG9mIGNoaWxkcmVuKSB7CiAgICAgICAgICAgIGlmIChjLnR5cGUgIT09IENvbW1lbnQpIHsKICAgICAgICAgICAgICBpZiAoaGFzRm91bmQpIHsKICAgICAgICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgICAgICAgIjx0cmFuc2l0aW9uPiBjYW4gb25seSBiZSB1c2VkIG9uIGEgc2luZ2xlIGVsZW1lbnQgb3IgY29tcG9uZW50LiBVc2UgPHRyYW5zaXRpb24tZ3JvdXA+IGZvciBsaXN0cy4iCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gYzsKICAgICAgICAgICAgICBoYXNGb3VuZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcmF3UHJvcHMgPSB0b1Jhdyhwcm9wcyk7CiAgICAgICAgY29uc3QgeyBtb2RlIH0gPSByYXdQcm9wczsKICAgICAgICBpZiAobW9kZSAmJiBtb2RlICE9PSAiaW4tb3V0IiAmJiBtb2RlICE9PSAib3V0LWluIiAmJiBtb2RlICE9PSAiZGVmYXVsdCIpIHsKICAgICAgICAgIHdhcm4kMShgaW52YWxpZCA8dHJhbnNpdGlvbj4gbW9kZTogJHttb2RlfWApOwogICAgICAgIH0KICAgICAgICBpZiAoc3RhdGUuaXNMZWF2aW5nKSB7CiAgICAgICAgICByZXR1cm4gZW1wdHlQbGFjZWhvbGRlcihjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlubmVyQ2hpbGQgPSBnZXRLZWVwQWxpdmVDaGlsZChjaGlsZCk7CiAgICAgICAgaWYgKCFpbm5lckNoaWxkKSB7CiAgICAgICAgICByZXR1cm4gZW1wdHlQbGFjZWhvbGRlcihjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVudGVySG9va3MgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKAogICAgICAgICAgaW5uZXJDaGlsZCwKICAgICAgICAgIHJhd1Byb3BzLAogICAgICAgICAgc3RhdGUsCiAgICAgICAgICBpbnN0YW5jZQogICAgICAgICk7CiAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKGlubmVyQ2hpbGQsIGVudGVySG9va3MpOwogICAgICAgIGNvbnN0IG9sZENoaWxkID0gaW5zdGFuY2Uuc3ViVHJlZTsKICAgICAgICBjb25zdCBvbGRJbm5lckNoaWxkID0gb2xkQ2hpbGQgJiYgZ2V0S2VlcEFsaXZlQ2hpbGQob2xkQ2hpbGQpOwogICAgICAgIGlmIChvbGRJbm5lckNoaWxkICYmIG9sZElubmVyQ2hpbGQudHlwZSAhPT0gQ29tbWVudCAmJiAhaXNTYW1lVk5vZGVUeXBlKGlubmVyQ2hpbGQsIG9sZElubmVyQ2hpbGQpKSB7CiAgICAgICAgICBjb25zdCBsZWF2aW5nSG9va3MgPSByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKAogICAgICAgICAgICBvbGRJbm5lckNoaWxkLAogICAgICAgICAgICByYXdQcm9wcywKICAgICAgICAgICAgc3RhdGUsCiAgICAgICAgICAgIGluc3RhbmNlCiAgICAgICAgICApOwogICAgICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKG9sZElubmVyQ2hpbGQsIGxlYXZpbmdIb29rcyk7CiAgICAgICAgICBpZiAobW9kZSA9PT0gIm91dC1pbiIpIHsKICAgICAgICAgICAgc3RhdGUuaXNMZWF2aW5nID0gdHJ1ZTsKICAgICAgICAgICAgbGVhdmluZ0hvb2tzLmFmdGVyTGVhdmUgPSAoKSA9PiB7CiAgICAgICAgICAgICAgc3RhdGUuaXNMZWF2aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnVwZGF0ZS5hY3RpdmUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5lZmZlY3QuZGlydHkgPSB0cnVlOwogICAgICAgICAgICAgICAgaW5zdGFuY2UudXBkYXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZXR1cm4gZW1wdHlQbGFjZWhvbGRlcihjaGlsZCk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICJpbi1vdXQiICYmIGlubmVyQ2hpbGQudHlwZSAhPT0gQ29tbWVudCkgewogICAgICAgICAgICBsZWF2aW5nSG9va3MuZGVsYXlMZWF2ZSA9IChlbCwgZWFybHlSZW1vdmUsIGRlbGF5ZWRMZWF2ZSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGxlYXZpbmdWTm9kZXNDYWNoZSA9IGdldExlYXZpbmdOb2Rlc0ZvclR5cGUoCiAgICAgICAgICAgICAgICBzdGF0ZSwKICAgICAgICAgICAgICAgIG9sZElubmVyQ2hpbGQKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGxlYXZpbmdWTm9kZXNDYWNoZVtTdHJpbmcob2xkSW5uZXJDaGlsZC5rZXkpXSA9IG9sZElubmVyQ2hpbGQ7CiAgICAgICAgICAgICAgZWxbbGVhdmVDYktleV0gPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBlYXJseVJlbW92ZSgpOwogICAgICAgICAgICAgICAgZWxbbGVhdmVDYktleV0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICBkZWxldGUgZW50ZXJIb29rcy5kZWxheWVkTGVhdmU7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBlbnRlckhvb2tzLmRlbGF5ZWRMZWF2ZSA9IGRlbGF5ZWRMZWF2ZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICB9OwogICAgfQogIH07CiAgY29uc3QgQmFzZVRyYW5zaXRpb24gPSBCYXNlVHJhbnNpdGlvbkltcGw7CiAgZnVuY3Rpb24gZ2V0TGVhdmluZ05vZGVzRm9yVHlwZShzdGF0ZSwgdm5vZGUpIHsKICAgIGNvbnN0IHsgbGVhdmluZ1ZOb2RlcyB9ID0gc3RhdGU7CiAgICBsZXQgbGVhdmluZ1ZOb2Rlc0NhY2hlID0gbGVhdmluZ1ZOb2Rlcy5nZXQodm5vZGUudHlwZSk7CiAgICBpZiAoIWxlYXZpbmdWTm9kZXNDYWNoZSkgewogICAgICBsZWF2aW5nVk5vZGVzQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgbGVhdmluZ1ZOb2Rlcy5zZXQodm5vZGUudHlwZSwgbGVhdmluZ1ZOb2Rlc0NhY2hlKTsKICAgIH0KICAgIHJldHVybiBsZWF2aW5nVk5vZGVzQ2FjaGU7CiAgfQogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uSG9va3Modm5vZGUsIHByb3BzLCBzdGF0ZSwgaW5zdGFuY2UpIHsKICAgIGNvbnN0IHsKICAgICAgYXBwZWFyLAogICAgICBtb2RlLAogICAgICBwZXJzaXN0ZWQgPSBmYWxzZSwKICAgICAgb25CZWZvcmVFbnRlciwKICAgICAgb25FbnRlciwKICAgICAgb25BZnRlckVudGVyLAogICAgICBvbkVudGVyQ2FuY2VsbGVkLAogICAgICBvbkJlZm9yZUxlYXZlLAogICAgICBvbkxlYXZlLAogICAgICBvbkFmdGVyTGVhdmUsCiAgICAgIG9uTGVhdmVDYW5jZWxsZWQsCiAgICAgIG9uQmVmb3JlQXBwZWFyLAogICAgICBvbkFwcGVhciwKICAgICAgb25BZnRlckFwcGVhciwKICAgICAgb25BcHBlYXJDYW5jZWxsZWQKICAgIH0gPSBwcm9wczsKICAgIGNvbnN0IGtleSA9IFN0cmluZyh2bm9kZS5rZXkpOwogICAgY29uc3QgbGVhdmluZ1ZOb2Rlc0NhY2hlID0gZ2V0TGVhdmluZ05vZGVzRm9yVHlwZShzdGF0ZSwgdm5vZGUpOwogICAgY29uc3QgY2FsbEhvb2sgPSAoaG9vaywgYXJncykgPT4gewogICAgICBob29rICYmIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKAogICAgICAgIGhvb2ssCiAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgOSwKICAgICAgICBhcmdzCiAgICAgICk7CiAgICB9OwogICAgY29uc3QgY2FsbEFzeW5jSG9vayA9IChob29rLCBhcmdzKSA9PiB7CiAgICAgIGNvbnN0IGRvbmUgPSBhcmdzWzFdOwogICAgICBjYWxsSG9vayhob29rLCBhcmdzKTsKICAgICAgaWYgKGlzQXJyYXkoaG9vaykpIHsKICAgICAgICBpZiAoaG9vay5ldmVyeSgoaG9vazIpID0+IGhvb2syLmxlbmd0aCA8PSAxKSkKICAgICAgICAgIGRvbmUoKTsKICAgICAgfSBlbHNlIGlmIChob29rLmxlbmd0aCA8PSAxKSB7CiAgICAgICAgZG9uZSgpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgaG9va3MgPSB7CiAgICAgIG1vZGUsCiAgICAgIHBlcnNpc3RlZCwKICAgICAgYmVmb3JlRW50ZXIoZWwpIHsKICAgICAgICBsZXQgaG9vayA9IG9uQmVmb3JlRW50ZXI7CiAgICAgICAgaWYgKCFzdGF0ZS5pc01vdW50ZWQpIHsKICAgICAgICAgIGlmIChhcHBlYXIpIHsKICAgICAgICAgICAgaG9vayA9IG9uQmVmb3JlQXBwZWFyIHx8IG9uQmVmb3JlRW50ZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbFtsZWF2ZUNiS2V5XSkgewogICAgICAgICAgZWxbbGVhdmVDYktleV0oCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgLyogY2FuY2VsbGVkICovCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBsZWF2aW5nVk5vZGUgPSBsZWF2aW5nVk5vZGVzQ2FjaGVba2V5XTsKICAgICAgICBpZiAobGVhdmluZ1ZOb2RlICYmIGlzU2FtZVZOb2RlVHlwZSh2bm9kZSwgbGVhdmluZ1ZOb2RlKSAmJiBsZWF2aW5nVk5vZGUuZWxbbGVhdmVDYktleV0pIHsKICAgICAgICAgIGxlYXZpbmdWTm9kZS5lbFtsZWF2ZUNiS2V5XSgpOwogICAgICAgIH0KICAgICAgICBjYWxsSG9vayhob29rLCBbZWxdKTsKICAgICAgfSwKICAgICAgZW50ZXIoZWwpIHsKICAgICAgICBsZXQgaG9vayA9IG9uRW50ZXI7CiAgICAgICAgbGV0IGFmdGVySG9vayA9IG9uQWZ0ZXJFbnRlcjsKICAgICAgICBsZXQgY2FuY2VsSG9vayA9IG9uRW50ZXJDYW5jZWxsZWQ7CiAgICAgICAgaWYgKCFzdGF0ZS5pc01vdW50ZWQpIHsKICAgICAgICAgIGlmIChhcHBlYXIpIHsKICAgICAgICAgICAgaG9vayA9IG9uQXBwZWFyIHx8IG9uRW50ZXI7CiAgICAgICAgICAgIGFmdGVySG9vayA9IG9uQWZ0ZXJBcHBlYXIgfHwgb25BZnRlckVudGVyOwogICAgICAgICAgICBjYW5jZWxIb29rID0gb25BcHBlYXJDYW5jZWxsZWQgfHwgb25FbnRlckNhbmNlbGxlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGNhbGxlZCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGRvbmUgPSBlbFtlbnRlckNiS2V5JDFdID0gKGNhbmNlbGxlZCkgPT4gewogICAgICAgICAgaWYgKGNhbGxlZCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICAgIGlmIChjYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FsbEhvb2soY2FuY2VsSG9vaywgW2VsXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWxsSG9vayhhZnRlckhvb2ssIFtlbF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGhvb2tzLmRlbGF5ZWRMZWF2ZSkgewogICAgICAgICAgICBob29rcy5kZWxheWVkTGVhdmUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsW2VudGVyQ2JLZXkkMV0gPSB2b2lkIDA7CiAgICAgICAgfTsKICAgICAgICBpZiAoaG9vaykgewogICAgICAgICAgY2FsbEFzeW5jSG9vayhob29rLCBbZWwsIGRvbmVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbGVhdmUoZWwsIHJlbW92ZSkgewogICAgICAgIGNvbnN0IGtleTIgPSBTdHJpbmcodm5vZGUua2V5KTsKICAgICAgICBpZiAoZWxbZW50ZXJDYktleSQxXSkgewogICAgICAgICAgZWxbZW50ZXJDYktleSQxXSgKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICAvKiBjYW5jZWxsZWQgKi8KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChzdGF0ZS5pc1VubW91bnRpbmcpIHsKICAgICAgICAgIHJldHVybiByZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgY2FsbEhvb2sob25CZWZvcmVMZWF2ZSwgW2VsXSk7CiAgICAgICAgbGV0IGNhbGxlZCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGRvbmUgPSBlbFtsZWF2ZUNiS2V5XSA9IChjYW5jZWxsZWQpID0+IHsKICAgICAgICAgIGlmIChjYWxsZWQpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICByZW1vdmUoKTsKICAgICAgICAgIGlmIChjYW5jZWxsZWQpIHsKICAgICAgICAgICAgY2FsbEhvb2sob25MZWF2ZUNhbmNlbGxlZCwgW2VsXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWxsSG9vayhvbkFmdGVyTGVhdmUsIFtlbF0pOwogICAgICAgICAgfQogICAgICAgICAgZWxbbGVhdmVDYktleV0gPSB2b2lkIDA7CiAgICAgICAgICBpZiAobGVhdmluZ1ZOb2Rlc0NhY2hlW2tleTJdID09PSB2bm9kZSkgewogICAgICAgICAgICBkZWxldGUgbGVhdmluZ1ZOb2Rlc0NhY2hlW2tleTJdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgbGVhdmluZ1ZOb2Rlc0NhY2hlW2tleTJdID0gdm5vZGU7CiAgICAgICAgaWYgKG9uTGVhdmUpIHsKICAgICAgICAgIGNhbGxBc3luY0hvb2sob25MZWF2ZSwgW2VsLCBkb25lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNsb25lKHZub2RlMikgewogICAgICAgIHJldHVybiByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKHZub2RlMiwgcHJvcHMsIHN0YXRlLCBpbnN0YW5jZSk7CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gaG9va3M7CiAgfQogIGZ1bmN0aW9uIGVtcHR5UGxhY2Vob2xkZXIodm5vZGUpIHsKICAgIGlmIChpc0tlZXBBbGl2ZSh2bm9kZSkpIHsKICAgICAgdm5vZGUgPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgICAgdm5vZGUuY2hpbGRyZW4gPSBudWxsOwogICAgICByZXR1cm4gdm5vZGU7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldEtlZXBBbGl2ZUNoaWxkKHZub2RlKSB7CiAgICByZXR1cm4gaXNLZWVwQWxpdmUodm5vZGUpID8gKAogICAgICAvLyAjNzEyMSBlbnN1cmUgZ2V0IHRoZSBjaGlsZCBjb21wb25lbnQgc3VidHJlZSBpbiBjYXNlCiAgICAgIC8vIGl0J3MgYmVlbiByZXBsYWNlZCBkdXJpbmcgSE1SCiAgICAgIHZub2RlLmNvbXBvbmVudCA/IHZub2RlLmNvbXBvbmVudC5zdWJUcmVlIDogdm5vZGUuY2hpbGRyZW4gPyB2bm9kZS5jaGlsZHJlblswXSA6IHZvaWQgMAogICAgKSA6IHZub2RlOwogIH0KICBmdW5jdGlvbiBzZXRUcmFuc2l0aW9uSG9va3Modm5vZGUsIGhvb2tzKSB7CiAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgNiAmJiB2bm9kZS5jb21wb25lbnQpIHsKICAgICAgc2V0VHJhbnNpdGlvbkhvb2tzKHZub2RlLmNvbXBvbmVudC5zdWJUcmVlLCBob29rcyk7CiAgICB9IGVsc2UgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEyOCkgewogICAgICB2bm9kZS5zc0NvbnRlbnQudHJhbnNpdGlvbiA9IGhvb2tzLmNsb25lKHZub2RlLnNzQ29udGVudCk7CiAgICAgIHZub2RlLnNzRmFsbGJhY2sudHJhbnNpdGlvbiA9IGhvb2tzLmNsb25lKHZub2RlLnNzRmFsbGJhY2spOwogICAgfSBlbHNlIHsKICAgICAgdm5vZGUudHJhbnNpdGlvbiA9IGhvb2tzOwogICAgfQogIH0KICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uUmF3Q2hpbGRyZW4oY2hpbGRyZW4sIGtlZXBDb21tZW50ID0gZmFsc2UsIHBhcmVudEtleSkgewogICAgbGV0IHJldCA9IFtdOwogICAgbGV0IGtleWVkRnJhZ21lbnRDb3VudCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICBjb25zdCBrZXkgPSBwYXJlbnRLZXkgPT0gbnVsbCA/IGNoaWxkLmtleSA6IFN0cmluZyhwYXJlbnRLZXkpICsgU3RyaW5nKGNoaWxkLmtleSAhPSBudWxsID8gY2hpbGQua2V5IDogaSk7CiAgICAgIGlmIChjaGlsZC50eXBlID09PSBGcmFnbWVudCkgewogICAgICAgIGlmIChjaGlsZC5wYXRjaEZsYWcgJiAxMjgpCiAgICAgICAgICBrZXllZEZyYWdtZW50Q291bnQrKzsKICAgICAgICByZXQgPSByZXQuY29uY2F0KAogICAgICAgICAgZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKGNoaWxkLmNoaWxkcmVuLCBrZWVwQ29tbWVudCwga2V5KQogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAoa2VlcENvbW1lbnQgfHwgY2hpbGQudHlwZSAhPT0gQ29tbWVudCkgewogICAgICAgIHJldC5wdXNoKGtleSAhPSBudWxsID8gY2xvbmVWTm9kZShjaGlsZCwgeyBrZXkgfSkgOiBjaGlsZCk7CiAgICAgIH0KICAgIH0KICAgIGlmIChrZXllZEZyYWdtZW50Q291bnQgPiAxKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmV0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmV0W2ldLnBhdGNoRmxhZyA9IC0yOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgLyohICNfX05PX1NJREVfRUZGRUNUU19fICovCiAgLy8gQF9fTk9fU0lERV9FRkZFQ1RTX18KICBmdW5jdGlvbiBkZWZpbmVDb21wb25lbnQob3B0aW9ucywgZXh0cmFPcHRpb25zKSB7CiAgICByZXR1cm4gaXNGdW5jdGlvbihvcHRpb25zKSA/ICgKICAgICAgLy8gIzgzMjY6IGV4dGVuZCBjYWxsIGFuZCBvcHRpb25zLm5hbWUgYWNjZXNzIGFyZSBjb25zaWRlcmVkIHNpZGUtZWZmZWN0cwogICAgICAvLyBieSBSb2xsdXAsIHNvIHdlIGhhdmUgdG8gd3JhcCBpdCBpbiBhIHB1cmUtYW5ub3RhdGVkIElJRkUuCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gZXh0ZW5kKHsgbmFtZTogb3B0aW9ucy5uYW1lIH0sIGV4dHJhT3B0aW9ucywgeyBzZXR1cDogb3B0aW9ucyB9KSkoKQogICAgKSA6IG9wdGlvbnM7CiAgfQoKICBjb25zdCBpc0FzeW5jV3JhcHBlciA9IChpKSA9PiAhIWkudHlwZS5fX2FzeW5jTG9hZGVyOwogIC8qISAjX19OT19TSURFX0VGRkVDVFNfXyAqLwogIC8vIEBfX05PX1NJREVfRUZGRUNUU19fCiAgZnVuY3Rpb24gZGVmaW5lQXN5bmNDb21wb25lbnQoc291cmNlKSB7CiAgICBpZiAoaXNGdW5jdGlvbihzb3VyY2UpKSB7CiAgICAgIHNvdXJjZSA9IHsgbG9hZGVyOiBzb3VyY2UgfTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgbG9hZGVyLAogICAgICBsb2FkaW5nQ29tcG9uZW50LAogICAgICBlcnJvckNvbXBvbmVudCwKICAgICAgZGVsYXkgPSAyMDAsCiAgICAgIHRpbWVvdXQsCiAgICAgIC8vIHVuZGVmaW5lZCA9IG5ldmVyIHRpbWVzIG91dAogICAgICBzdXNwZW5zaWJsZSA9IHRydWUsCiAgICAgIG9uRXJyb3I6IHVzZXJPbkVycm9yCiAgICB9ID0gc291cmNlOwogICAgbGV0IHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICAgIGxldCByZXNvbHZlZENvbXA7CiAgICBsZXQgcmV0cmllcyA9IDA7CiAgICBjb25zdCByZXRyeSA9ICgpID0+IHsKICAgICAgcmV0cmllcysrOwogICAgICBwZW5kaW5nUmVxdWVzdCA9IG51bGw7CiAgICAgIHJldHVybiBsb2FkKCk7CiAgICB9OwogICAgY29uc3QgbG9hZCA9ICgpID0+IHsKICAgICAgbGV0IHRoaXNSZXF1ZXN0OwogICAgICByZXR1cm4gcGVuZGluZ1JlcXVlc3QgfHwgKHRoaXNSZXF1ZXN0ID0gcGVuZGluZ1JlcXVlc3QgPSBsb2FkZXIoKS5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgZXJyID0gZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpOwogICAgICAgIGlmICh1c2VyT25FcnJvcikgewogICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgY29uc3QgdXNlclJldHJ5ID0gKCkgPT4gcmVzb2x2ZShyZXRyeSgpKTsKICAgICAgICAgICAgY29uc3QgdXNlckZhaWwgPSAoKSA9PiByZWplY3QoZXJyKTsKICAgICAgICAgICAgdXNlck9uRXJyb3IoZXJyLCB1c2VyUmV0cnksIHVzZXJGYWlsLCByZXRyaWVzICsgMSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfSkudGhlbigoY29tcCkgPT4gewogICAgICAgIGlmICh0aGlzUmVxdWVzdCAhPT0gcGVuZGluZ1JlcXVlc3QgJiYgcGVuZGluZ1JlcXVlc3QpIHsKICAgICAgICAgIHJldHVybiBwZW5kaW5nUmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgaWYgKCFjb21wKSB7CiAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgIGBBc3luYyBjb21wb25lbnQgbG9hZGVyIHJlc29sdmVkIHRvIHVuZGVmaW5lZC4gSWYgeW91IGFyZSB1c2luZyByZXRyeSgpLCBtYWtlIHN1cmUgdG8gcmV0dXJuIGl0cyByZXR1cm4gdmFsdWUuYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbXAgJiYgKGNvbXAuX19lc01vZHVsZSB8fCBjb21wW1N5bWJvbC50b1N0cmluZ1RhZ10gPT09ICJNb2R1bGUiKSkgewogICAgICAgICAgY29tcCA9IGNvbXAuZGVmYXVsdDsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbXAgJiYgIWlzT2JqZWN0KGNvbXApICYmICFpc0Z1bmN0aW9uKGNvbXApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXN5bmMgY29tcG9uZW50IGxvYWQgcmVzdWx0OiAke2NvbXB9YCk7CiAgICAgICAgfQogICAgICAgIHJlc29sdmVkQ29tcCA9IGNvbXA7CiAgICAgICAgcmV0dXJuIGNvbXA7CiAgICAgIH0pKTsKICAgIH07CiAgICByZXR1cm4gZGVmaW5lQ29tcG9uZW50KHsKICAgICAgbmFtZTogIkFzeW5jQ29tcG9uZW50V3JhcHBlciIsCiAgICAgIF9fYXN5bmNMb2FkZXI6IGxvYWQsCiAgICAgIGdldCBfX2FzeW5jUmVzb2x2ZWQoKSB7CiAgICAgICAgcmV0dXJuIHJlc29sdmVkQ29tcDsKICAgICAgfSwKICAgICAgc2V0dXAoKSB7CiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2U7CiAgICAgICAgaWYgKHJlc29sdmVkQ29tcCkgewogICAgICAgICAgcmV0dXJuICgpID0+IGNyZWF0ZUlubmVyQ29tcChyZXNvbHZlZENvbXAsIGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb25FcnJvciA9IChlcnIpID0+IHsKICAgICAgICAgIHBlbmRpbmdSZXF1ZXN0ID0gbnVsbDsKICAgICAgICAgIGhhbmRsZUVycm9yKAogICAgICAgICAgICBlcnIsCiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAxMywKICAgICAgICAgICAgIWVycm9yQ29tcG9uZW50CiAgICAgICAgICApOwogICAgICAgIH07CiAgICAgICAgaWYgKHN1c3BlbnNpYmxlICYmIGluc3RhbmNlLnN1c3BlbnNlIHx8IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gbG9hZCgpLnRoZW4oKGNvbXApID0+IHsKICAgICAgICAgICAgcmV0dXJuICgpID0+IGNyZWF0ZUlubmVyQ29tcChjb21wLCBpbnN0YW5jZSk7CiAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7CiAgICAgICAgICAgIG9uRXJyb3IoZXJyKTsKICAgICAgICAgICAgcmV0dXJuICgpID0+IGVycm9yQ29tcG9uZW50ID8gY3JlYXRlVk5vZGUoZXJyb3JDb21wb25lbnQsIHsKICAgICAgICAgICAgICBlcnJvcjogZXJyCiAgICAgICAgICAgIH0pIDogbnVsbDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBsb2FkZWQgPSByZWYoZmFsc2UpOwogICAgICAgIGNvbnN0IGVycm9yID0gcmVmKCk7CiAgICAgICAgY29uc3QgZGVsYXllZCA9IHJlZighIWRlbGF5KTsKICAgICAgICBpZiAoZGVsYXkpIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBkZWxheWVkLnZhbHVlID0gZmFsc2U7CiAgICAgICAgICB9LCBkZWxheSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHsKICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBpZiAoIWxvYWRlZC52YWx1ZSAmJiAhZXJyb3IudmFsdWUpIHsKICAgICAgICAgICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICBgQXN5bmMgY29tcG9uZW50IHRpbWVkIG91dCBhZnRlciAke3RpbWVvdXR9bXMuYAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgb25FcnJvcihlcnIpOwogICAgICAgICAgICAgIGVycm9yLnZhbHVlID0gZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICB9CiAgICAgICAgbG9hZCgpLnRoZW4oKCkgPT4gewogICAgICAgICAgbG9hZGVkLnZhbHVlID0gdHJ1ZTsKICAgICAgICAgIGlmIChpbnN0YW5jZS5wYXJlbnQgJiYgaXNLZWVwQWxpdmUoaW5zdGFuY2UucGFyZW50LnZub2RlKSkgewogICAgICAgICAgICBpbnN0YW5jZS5wYXJlbnQuZWZmZWN0LmRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgcXVldWVKb2IoaW5zdGFuY2UucGFyZW50LnVwZGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4gewogICAgICAgICAgb25FcnJvcihlcnIpOwogICAgICAgICAgZXJyb3IudmFsdWUgPSBlcnI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgIGlmIChsb2FkZWQudmFsdWUgJiYgcmVzb2x2ZWRDb21wKSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVJbm5lckNvbXAocmVzb2x2ZWRDb21wLCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGVycm9yLnZhbHVlICYmIGVycm9yQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVWTm9kZShlcnJvckNvbXBvbmVudCwgewogICAgICAgICAgICAgIGVycm9yOiBlcnJvci52YWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSBpZiAobG9hZGluZ0NvbXBvbmVudCAmJiAhZGVsYXllZC52YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUobG9hZGluZ0NvbXBvbmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUlubmVyQ29tcChjb21wLCBwYXJlbnQpIHsKICAgIGNvbnN0IHsgcmVmOiByZWYyLCBwcm9wcywgY2hpbGRyZW4sIGNlIH0gPSBwYXJlbnQudm5vZGU7CiAgICBjb25zdCB2bm9kZSA9IGNyZWF0ZVZOb2RlKGNvbXAsIHByb3BzLCBjaGlsZHJlbik7CiAgICB2bm9kZS5yZWYgPSByZWYyOwogICAgdm5vZGUuY2UgPSBjZTsKICAgIGRlbGV0ZSBwYXJlbnQudm5vZGUuY2U7CiAgICByZXR1cm4gdm5vZGU7CiAgfQoKICBjb25zdCBpc0tlZXBBbGl2ZSA9ICh2bm9kZSkgPT4gdm5vZGUudHlwZS5fX2lzS2VlcEFsaXZlOwogIGNvbnN0IEtlZXBBbGl2ZUltcGwgPSB7CiAgICBuYW1lOiBgS2VlcEFsaXZlYCwKICAgIC8vIE1hcmtlciBmb3Igc3BlY2lhbCBoYW5kbGluZyBpbnNpZGUgdGhlIHJlbmRlcmVyLiBXZSBhcmUgbm90IHVzaW5nIGEgPT09CiAgICAvLyBjaGVjayBkaXJlY3RseSBvbiBLZWVwQWxpdmUgaW4gdGhlIHJlbmRlcmVyLCBiZWNhdXNlIGltcG9ydGluZyBpdCBkaXJlY3RseQogICAgLy8gd291bGQgcHJldmVudCBpdCBmcm9tIGJlaW5nIHRyZWUtc2hha2VuLgogICAgX19pc0tlZXBBbGl2ZTogdHJ1ZSwKICAgIHByb3BzOiB7CiAgICAgIGluY2x1ZGU6IFtTdHJpbmcsIFJlZ0V4cCwgQXJyYXldLAogICAgICBleGNsdWRlOiBbU3RyaW5nLCBSZWdFeHAsIEFycmF5XSwKICAgICAgbWF4OiBbU3RyaW5nLCBOdW1iZXJdCiAgICB9LAogICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICBjb25zdCBzaGFyZWRDb250ZXh0ID0gaW5zdGFuY2UuY3R4OwogICAgICBjb25zdCBjYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgIGNvbnN0IGtleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICBsZXQgY3VycmVudCA9IG51bGw7CiAgICAgIHsKICAgICAgICBpbnN0YW5jZS5fX3ZfY2FjaGUgPSBjYWNoZTsKICAgICAgfQogICAgICBjb25zdCBwYXJlbnRTdXNwZW5zZSA9IGluc3RhbmNlLnN1c3BlbnNlOwogICAgICBjb25zdCB7CiAgICAgICAgcmVuZGVyZXI6IHsKICAgICAgICAgIHA6IHBhdGNoLAogICAgICAgICAgbTogbW92ZSwKICAgICAgICAgIHVtOiBfdW5tb3VudCwKICAgICAgICAgIG86IHsgY3JlYXRlRWxlbWVudCB9CiAgICAgICAgfQogICAgICB9ID0gc2hhcmVkQ29udGV4dDsKICAgICAgY29uc3Qgc3RvcmFnZUNvbnRhaW5lciA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBzaGFyZWRDb250ZXh0LmFjdGl2YXRlID0gKHZub2RlLCBjb250YWluZXIsIGFuY2hvciwgbmFtZXNwYWNlLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgICBjb25zdCBpbnN0YW5jZTIgPSB2bm9kZS5jb21wb25lbnQ7CiAgICAgICAgbW92ZSh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIDAsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICBwYXRjaCgKICAgICAgICAgIGluc3RhbmNlMi52bm9kZSwKICAgICAgICAgIHZub2RlLAogICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgYW5jaG9yLAogICAgICAgICAgaW5zdGFuY2UyLAogICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICB2bm9kZS5zbG90U2NvcGVJZHMsCiAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICApOwogICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgoKSA9PiB7CiAgICAgICAgICBpbnN0YW5jZTIuaXNEZWFjdGl2YXRlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKGluc3RhbmNlMi5hKSB7CiAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGluc3RhbmNlMi5hKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHZub2RlSG9vayA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLm9uVm5vZGVNb3VudGVkOwogICAgICAgICAgaWYgKHZub2RlSG9vaykgewogICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBpbnN0YW5jZTIucGFyZW50LCB2bm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgIHsKICAgICAgICAgIGRldnRvb2xzQ29tcG9uZW50QWRkZWQoaW5zdGFuY2UyKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHNoYXJlZENvbnRleHQuZGVhY3RpdmF0ZSA9ICh2bm9kZSkgPT4gewogICAgICAgIGNvbnN0IGluc3RhbmNlMiA9IHZub2RlLmNvbXBvbmVudDsKICAgICAgICBtb3ZlKHZub2RlLCBzdG9yYWdlQ29udGFpbmVyLCBudWxsLCAxLCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICAgIGlmIChpbnN0YW5jZTIuZGEpIHsKICAgICAgICAgICAgaW52b2tlQXJyYXlGbnMoaW5zdGFuY2UyLmRhKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHZub2RlSG9vayA9IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLm9uVm5vZGVVbm1vdW50ZWQ7CiAgICAgICAgICBpZiAodm5vZGVIb29rKSB7CiAgICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIGluc3RhbmNlMi5wYXJlbnQsIHZub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlMi5pc0RlYWN0aXZhdGVkID0gdHJ1ZTsKICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgewogICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRBZGRlZChpbnN0YW5jZTIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZnVuY3Rpb24gdW5tb3VudCh2bm9kZSkgewogICAgICAgIHJlc2V0U2hhcGVGbGFnKHZub2RlKTsKICAgICAgICBfdW5tb3VudCh2bm9kZSwgaW5zdGFuY2UsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcnVuZUNhY2hlKGZpbHRlcikgewogICAgICAgIGNhY2hlLmZvckVhY2goKHZub2RlLCBrZXkpID0+IHsKICAgICAgICAgIGNvbnN0IG5hbWUgPSBnZXRDb21wb25lbnROYW1lKHZub2RlLnR5cGUpOwogICAgICAgICAgaWYgKG5hbWUgJiYgKCFmaWx0ZXIgfHwgIWZpbHRlcihuYW1lKSkpIHsKICAgICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHJ1bmVDYWNoZUVudHJ5KGtleSkgewogICAgICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlLmdldChrZXkpOwogICAgICAgIGlmICghY3VycmVudCB8fCAhaXNTYW1lVk5vZGVUeXBlKGNhY2hlZCwgY3VycmVudCkpIHsKICAgICAgICAgIHVubW91bnQoY2FjaGVkKTsKICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnQpIHsKICAgICAgICAgIHJlc2V0U2hhcGVGbGFnKGN1cnJlbnQpOwogICAgICAgIH0KICAgICAgICBjYWNoZS5kZWxldGUoa2V5KTsKICAgICAgICBrZXlzLmRlbGV0ZShrZXkpOwogICAgICB9CiAgICAgIHdhdGNoKAogICAgICAgICgpID0+IFtwcm9wcy5pbmNsdWRlLCBwcm9wcy5leGNsdWRlXSwKICAgICAgICAoW2luY2x1ZGUsIGV4Y2x1ZGVdKSA9PiB7CiAgICAgICAgICBpbmNsdWRlICYmIHBydW5lQ2FjaGUoKG5hbWUpID0+IG1hdGNoZXMoaW5jbHVkZSwgbmFtZSkpOwogICAgICAgICAgZXhjbHVkZSAmJiBwcnVuZUNhY2hlKChuYW1lKSA9PiAhbWF0Y2hlcyhleGNsdWRlLCBuYW1lKSk7CiAgICAgICAgfSwKICAgICAgICAvLyBwcnVuZSBwb3N0LXJlbmRlciBhZnRlciBgY3VycmVudGAgaGFzIGJlZW4gdXBkYXRlZAogICAgICAgIHsgZmx1c2g6ICJwb3N0IiwgZGVlcDogdHJ1ZSB9CiAgICAgICk7CiAgICAgIGxldCBwZW5kaW5nQ2FjaGVLZXkgPSBudWxsOwogICAgICBjb25zdCBjYWNoZVN1YnRyZWUgPSAoKSA9PiB7CiAgICAgICAgaWYgKHBlbmRpbmdDYWNoZUtleSAhPSBudWxsKSB7CiAgICAgICAgICBjYWNoZS5zZXQocGVuZGluZ0NhY2hlS2V5LCBnZXRJbm5lckNoaWxkKGluc3RhbmNlLnN1YlRyZWUpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIG9uTW91bnRlZChjYWNoZVN1YnRyZWUpOwogICAgICBvblVwZGF0ZWQoY2FjaGVTdWJ0cmVlKTsKICAgICAgb25CZWZvcmVVbm1vdW50KCgpID0+IHsKICAgICAgICBjYWNoZS5mb3JFYWNoKChjYWNoZWQpID0+IHsKICAgICAgICAgIGNvbnN0IHsgc3ViVHJlZSwgc3VzcGVuc2UgfSA9IGluc3RhbmNlOwogICAgICAgICAgY29uc3Qgdm5vZGUgPSBnZXRJbm5lckNoaWxkKHN1YlRyZWUpOwogICAgICAgICAgaWYgKGNhY2hlZC50eXBlID09PSB2bm9kZS50eXBlICYmIGNhY2hlZC5rZXkgPT09IHZub2RlLmtleSkgewogICAgICAgICAgICByZXNldFNoYXBlRmxhZyh2bm9kZSk7CiAgICAgICAgICAgIGNvbnN0IGRhID0gdm5vZGUuY29tcG9uZW50LmRhOwogICAgICAgICAgICBkYSAmJiBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoZGEsIHN1c3BlbnNlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdW5tb3VudChjYWNoZWQpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICBwZW5kaW5nQ2FjaGVLZXkgPSBudWxsOwogICAgICAgIGlmICghc2xvdHMuZGVmYXVsdCkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNoaWxkcmVuID0gc2xvdHMuZGVmYXVsdCgpOwogICAgICAgIGNvbnN0IHJhd1ZOb2RlID0gY2hpbGRyZW5bMF07CiAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybiQxKGBLZWVwQWxpdmUgc2hvdWxkIGNvbnRhaW4gZXhhY3RseSBvbmUgY29tcG9uZW50IGNoaWxkLmApOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudCA9IG51bGw7CiAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgfSBlbHNlIGlmICghaXNWTm9kZShyYXdWTm9kZSkgfHwgIShyYXdWTm9kZS5zaGFwZUZsYWcgJiA0KSAmJiAhKHJhd1ZOb2RlLnNoYXBlRmxhZyAmIDEyOCkpIHsKICAgICAgICAgIGN1cnJlbnQgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHJhd1ZOb2RlOwogICAgICAgIH0KICAgICAgICBsZXQgdm5vZGUgPSBnZXRJbm5lckNoaWxkKHJhd1ZOb2RlKTsKICAgICAgICBjb25zdCBjb21wID0gdm5vZGUudHlwZTsKICAgICAgICBjb25zdCBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZSgKICAgICAgICAgIGlzQXN5bmNXcmFwcGVyKHZub2RlKSA/IHZub2RlLnR5cGUuX19hc3luY1Jlc29sdmVkIHx8IHt9IDogY29tcAogICAgICAgICk7CiAgICAgICAgY29uc3QgeyBpbmNsdWRlLCBleGNsdWRlLCBtYXggfSA9IHByb3BzOwogICAgICAgIGlmIChpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkgfHwgZXhjbHVkZSAmJiBuYW1lICYmIG1hdGNoZXMoZXhjbHVkZSwgbmFtZSkpIHsKICAgICAgICAgIGN1cnJlbnQgPSB2bm9kZTsKICAgICAgICAgIHJldHVybiByYXdWTm9kZTsKICAgICAgICB9CiAgICAgICAgY29uc3Qga2V5ID0gdm5vZGUua2V5ID09IG51bGwgPyBjb21wIDogdm5vZGUua2V5OwogICAgICAgIGNvbnN0IGNhY2hlZFZOb2RlID0gY2FjaGUuZ2V0KGtleSk7CiAgICAgICAgaWYgKHZub2RlLmVsKSB7CiAgICAgICAgICB2bm9kZSA9IGNsb25lVk5vZGUodm5vZGUpOwogICAgICAgICAgaWYgKHJhd1ZOb2RlLnNoYXBlRmxhZyAmIDEyOCkgewogICAgICAgICAgICByYXdWTm9kZS5zc0NvbnRlbnQgPSB2bm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcGVuZGluZ0NhY2hlS2V5ID0ga2V5OwogICAgICAgIGlmIChjYWNoZWRWTm9kZSkgewogICAgICAgICAgdm5vZGUuZWwgPSBjYWNoZWRWTm9kZS5lbDsKICAgICAgICAgIHZub2RlLmNvbXBvbmVudCA9IGNhY2hlZFZOb2RlLmNvbXBvbmVudDsKICAgICAgICAgIGlmICh2bm9kZS50cmFuc2l0aW9uKSB7CiAgICAgICAgICAgIHNldFRyYW5zaXRpb25Ib29rcyh2bm9kZSwgdm5vZGUudHJhbnNpdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgICB2bm9kZS5zaGFwZUZsYWcgfD0gNTEyOwogICAgICAgICAga2V5cy5kZWxldGUoa2V5KTsKICAgICAgICAgIGtleXMuYWRkKGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGtleXMuYWRkKGtleSk7CiAgICAgICAgICBpZiAobWF4ICYmIGtleXMuc2l6ZSA+IHBhcnNlSW50KG1heCwgMTApKSB7CiAgICAgICAgICAgIHBydW5lQ2FjaGVFbnRyeShrZXlzLnZhbHVlcygpLm5leHQoKS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZub2RlLnNoYXBlRmxhZyB8PSAyNTY7CiAgICAgICAgY3VycmVudCA9IHZub2RlOwogICAgICAgIHJldHVybiBpc1N1c3BlbnNlKHJhd1ZOb2RlLnR5cGUpID8gcmF3Vk5vZGUgOiB2bm9kZTsKICAgICAgfTsKICAgIH0KICB9OwogIGNvbnN0IEtlZXBBbGl2ZSA9IEtlZXBBbGl2ZUltcGw7CiAgZnVuY3Rpb24gbWF0Y2hlcyhwYXR0ZXJuLCBuYW1lKSB7CiAgICBpZiAoaXNBcnJheShwYXR0ZXJuKSkgewogICAgICByZXR1cm4gcGF0dGVybi5zb21lKChwKSA9PiBtYXRjaGVzKHAsIG5hbWUpKTsKICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcocGF0dGVybikpIHsKICAgICAgcmV0dXJuIHBhdHRlcm4uc3BsaXQoIiwiKS5pbmNsdWRlcyhuYW1lKTsKICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAocGF0dGVybikpIHsKICAgICAgcmV0dXJuIHBhdHRlcm4udGVzdChuYW1lKTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgZnVuY3Rpb24gb25BY3RpdmF0ZWQoaG9vaywgdGFyZ2V0KSB7CiAgICByZWdpc3RlcktlZXBBbGl2ZUhvb2soaG9vaywgImEiLCB0YXJnZXQpOwogIH0KICBmdW5jdGlvbiBvbkRlYWN0aXZhdGVkKGhvb2ssIHRhcmdldCkgewogICAgcmVnaXN0ZXJLZWVwQWxpdmVIb29rKGhvb2ssICJkYSIsIHRhcmdldCk7CiAgfQogIGZ1bmN0aW9uIHJlZ2lzdGVyS2VlcEFsaXZlSG9vayhob29rLCB0eXBlLCB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2UpIHsKICAgIGNvbnN0IHdyYXBwZWRIb29rID0gaG9vay5fX3dkYyB8fCAoaG9vay5fX3dkYyA9ICgpID0+IHsKICAgICAgbGV0IGN1cnJlbnQgPSB0YXJnZXQ7CiAgICAgIHdoaWxlIChjdXJyZW50KSB7CiAgICAgICAgaWYgKGN1cnJlbnQuaXNEZWFjdGl2YXRlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGhvb2soKTsKICAgIH0pOwogICAgaW5qZWN0SG9vayh0eXBlLCB3cmFwcGVkSG9vaywgdGFyZ2V0KTsKICAgIGlmICh0YXJnZXQpIHsKICAgICAgbGV0IGN1cnJlbnQgPSB0YXJnZXQucGFyZW50OwogICAgICB3aGlsZSAoY3VycmVudCAmJiBjdXJyZW50LnBhcmVudCkgewogICAgICAgIGlmIChpc0tlZXBBbGl2ZShjdXJyZW50LnBhcmVudC52bm9kZSkpIHsKICAgICAgICAgIGluamVjdFRvS2VlcEFsaXZlUm9vdCh3cmFwcGVkSG9vaywgdHlwZSwgdGFyZ2V0LCBjdXJyZW50KTsKICAgICAgICB9CiAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50OwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGluamVjdFRvS2VlcEFsaXZlUm9vdChob29rLCB0eXBlLCB0YXJnZXQsIGtlZXBBbGl2ZVJvb3QpIHsKICAgIGNvbnN0IGluamVjdGVkID0gaW5qZWN0SG9vaygKICAgICAgdHlwZSwKICAgICAgaG9vaywKICAgICAga2VlcEFsaXZlUm9vdCwKICAgICAgdHJ1ZQogICAgICAvKiBwcmVwZW5kICovCiAgICApOwogICAgb25Vbm1vdW50ZWQoKCkgPT4gewogICAgICByZW1vdmUoa2VlcEFsaXZlUm9vdFt0eXBlXSwgaW5qZWN0ZWQpOwogICAgfSwgdGFyZ2V0KTsKICB9CiAgZnVuY3Rpb24gcmVzZXRTaGFwZUZsYWcodm5vZGUpIHsKICAgIHZub2RlLnNoYXBlRmxhZyAmPSB+MjU2OwogICAgdm5vZGUuc2hhcGVGbGFnICY9IH41MTI7CiAgfQogIGZ1bmN0aW9uIGdldElubmVyQ2hpbGQodm5vZGUpIHsKICAgIHJldHVybiB2bm9kZS5zaGFwZUZsYWcgJiAxMjggPyB2bm9kZS5zc0NvbnRlbnQgOiB2bm9kZTsKICB9CgogIGZ1bmN0aW9uIGluamVjdEhvb2sodHlwZSwgaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlLCBwcmVwZW5kID0gZmFsc2UpIHsKICAgIGlmICh0YXJnZXQpIHsKICAgICAgY29uc3QgaG9va3MgPSB0YXJnZXRbdHlwZV0gfHwgKHRhcmdldFt0eXBlXSA9IFtdKTsKICAgICAgY29uc3Qgd3JhcHBlZEhvb2sgPSBob29rLl9fd2VoIHx8IChob29rLl9fd2VoID0gKC4uLmFyZ3MpID0+IHsKICAgICAgICBpZiAodGFyZ2V0LmlzVW5tb3VudGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBhdXNlVHJhY2tpbmcoKTsKICAgICAgICBjb25zdCByZXNldCA9IHNldEN1cnJlbnRJbnN0YW5jZSh0YXJnZXQpOwogICAgICAgIGNvbnN0IHJlcyA9IGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIHRhcmdldCwgdHlwZSwgYXJncyk7CiAgICAgICAgcmVzZXQoKTsKICAgICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgICAgcmV0dXJuIHJlczsKICAgICAgfSk7CiAgICAgIGlmIChwcmVwZW5kKSB7CiAgICAgICAgaG9va3MudW5zaGlmdCh3cmFwcGVkSG9vayk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaG9va3MucHVzaCh3cmFwcGVkSG9vayk7CiAgICAgIH0KICAgICAgcmV0dXJuIHdyYXBwZWRIb29rOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgYXBpTmFtZSA9IHRvSGFuZGxlcktleShFcnJvclR5cGVTdHJpbmdzJDFbdHlwZV0ucmVwbGFjZSgvIGhvb2skLywgIiIpKTsKICAgICAgd2FybiQxKAogICAgICAgIGAke2FwaU5hbWV9IGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UgdG8gYmUgYXNzb2NpYXRlZCB3aXRoLiBMaWZlY3ljbGUgaW5qZWN0aW9uIEFQSXMgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgZXhlY3V0aW9uIG9mIHNldHVwKCkuYCArIChgIElmIHlvdSBhcmUgdXNpbmcgYXN5bmMgc2V0dXAoKSwgbWFrZSBzdXJlIHRvIHJlZ2lzdGVyIGxpZmVjeWNsZSBob29rcyBiZWZvcmUgdGhlIGZpcnN0IGF3YWl0IHN0YXRlbWVudC5gICkKICAgICAgKTsKICAgIH0KICB9CiAgY29uc3QgY3JlYXRlSG9vayA9IChsaWZlY3ljbGUpID0+IChob29rLCB0YXJnZXQgPSBjdXJyZW50SW5zdGFuY2UpID0+ICgKICAgIC8vIHBvc3QtY3JlYXRlIGxpZmVjeWNsZSByZWdpc3RyYXRpb25zIGFyZSBub29wcyBkdXJpbmcgU1NSIChleGNlcHQgZm9yIHNlcnZlclByZWZldGNoKQogICAgKCFpc0luU1NSQ29tcG9uZW50U2V0dXAgfHwgbGlmZWN5Y2xlID09PSAic3AiKSAmJiBpbmplY3RIb29rKGxpZmVjeWNsZSwgKC4uLmFyZ3MpID0+IGhvb2soLi4uYXJncyksIHRhcmdldCkKICApOwogIGNvbnN0IG9uQmVmb3JlTW91bnQgPSBjcmVhdGVIb29rKCJibSIpOwogIGNvbnN0IG9uTW91bnRlZCA9IGNyZWF0ZUhvb2soIm0iKTsKICBjb25zdCBvbkJlZm9yZVVwZGF0ZSA9IGNyZWF0ZUhvb2soImJ1Iik7CiAgY29uc3Qgb25VcGRhdGVkID0gY3JlYXRlSG9vaygidSIpOwogIGNvbnN0IG9uQmVmb3JlVW5tb3VudCA9IGNyZWF0ZUhvb2soImJ1bSIpOwogIGNvbnN0IG9uVW5tb3VudGVkID0gY3JlYXRlSG9vaygidW0iKTsKICBjb25zdCBvblNlcnZlclByZWZldGNoID0gY3JlYXRlSG9vaygic3AiKTsKICBjb25zdCBvblJlbmRlclRyaWdnZXJlZCA9IGNyZWF0ZUhvb2soCiAgICAicnRnIgogICk7CiAgY29uc3Qgb25SZW5kZXJUcmFja2VkID0gY3JlYXRlSG9vaygKICAgICJydGMiCiAgKTsKICBmdW5jdGlvbiBvbkVycm9yQ2FwdHVyZWQoaG9vaywgdGFyZ2V0ID0gY3VycmVudEluc3RhbmNlKSB7CiAgICBpbmplY3RIb29rKCJlYyIsIGhvb2ssIHRhcmdldCk7CiAgfQoKICBmdW5jdGlvbiByZW5kZXJMaXN0KHNvdXJjZSwgcmVuZGVySXRlbSwgY2FjaGUsIGluZGV4KSB7CiAgICBsZXQgcmV0OwogICAgY29uc3QgY2FjaGVkID0gY2FjaGUgJiYgY2FjaGVbaW5kZXhdOwogICAgaWYgKGlzQXJyYXkoc291cmNlKSB8fCBpc1N0cmluZyhzb3VyY2UpKSB7CiAgICAgIHJldCA9IG5ldyBBcnJheShzb3VyY2UubGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBzb3VyY2UubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcmV0W2ldID0gcmVuZGVySXRlbShzb3VyY2VbaV0sIGksIHZvaWQgMCwgY2FjaGVkICYmIGNhY2hlZFtpXSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHNvdXJjZSA9PT0gIm51bWJlciIpIHsKICAgICAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKHNvdXJjZSkpIHsKICAgICAgICB3YXJuJDEoYFRoZSB2LWZvciByYW5nZSBleHBlY3QgYW4gaW50ZWdlciB2YWx1ZSBidXQgZ290ICR7c291cmNlfS5gKTsKICAgICAgfQogICAgICByZXQgPSBuZXcgQXJyYXkoc291cmNlKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2U7IGkrKykgewogICAgICAgIHJldFtpXSA9IHJlbmRlckl0ZW0oaSArIDEsIGksIHZvaWQgMCwgY2FjaGVkICYmIGNhY2hlZFtpXSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICBpZiAoc291cmNlW1N5bWJvbC5pdGVyYXRvcl0pIHsKICAgICAgICByZXQgPSBBcnJheS5mcm9tKAogICAgICAgICAgc291cmNlLAogICAgICAgICAgKGl0ZW0sIGkpID0+IHJlbmRlckl0ZW0oaXRlbSwgaSwgdm9pZCAwLCBjYWNoZWQgJiYgY2FjaGVkW2ldKQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CiAgICAgICAgcmV0ID0gbmV3IEFycmF5KGtleXMubGVuZ3RoKTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgcmV0W2ldID0gcmVuZGVySXRlbShzb3VyY2Vba2V5XSwga2V5LCBpLCBjYWNoZWQgJiYgY2FjaGVkW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldCA9IFtdOwogICAgfQogICAgaWYgKGNhY2hlKSB7CiAgICAgIGNhY2hlW2luZGV4XSA9IHJldDsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVTbG90cyhzbG90cywgZHluYW1pY1Nsb3RzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGR5bmFtaWNTbG90cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBzbG90ID0gZHluYW1pY1Nsb3RzW2ldOwogICAgICBpZiAoaXNBcnJheShzbG90KSkgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc2xvdC5sZW5ndGg7IGorKykgewogICAgICAgICAgc2xvdHNbc2xvdFtqXS5uYW1lXSA9IHNsb3Rbal0uZm47CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHNsb3QpIHsKICAgICAgICBzbG90c1tzbG90Lm5hbWVdID0gc2xvdC5rZXkgPyAoLi4uYXJncykgPT4gewogICAgICAgICAgY29uc3QgcmVzID0gc2xvdC5mbiguLi5hcmdzKTsKICAgICAgICAgIGlmIChyZXMpCiAgICAgICAgICAgIHJlcy5rZXkgPSBzbG90LmtleTsKICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfSA6IHNsb3QuZm47CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzbG90czsKICB9CgogIGZ1bmN0aW9uIHJlbmRlclNsb3Qoc2xvdHMsIG5hbWUsIHByb3BzID0ge30sIGZhbGxiYWNrLCBub1Nsb3R0ZWQpIHsKICAgIGlmIChjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UuaXNDRSB8fCBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UucGFyZW50ICYmIGlzQXN5bmNXcmFwcGVyKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5wYXJlbnQpICYmIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5wYXJlbnQuaXNDRSkgewogICAgICBpZiAobmFtZSAhPT0gImRlZmF1bHQiKQogICAgICAgIHByb3BzLm5hbWUgPSBuYW1lOwogICAgICByZXR1cm4gY3JlYXRlVk5vZGUoInNsb3QiLCBwcm9wcywgZmFsbGJhY2sgJiYgZmFsbGJhY2soKSk7CiAgICB9CiAgICBsZXQgc2xvdCA9IHNsb3RzW25hbWVdOwogICAgaWYgKHNsb3QgJiYgc2xvdC5sZW5ndGggPiAxKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgU1NSLW9wdGltaXplZCBzbG90IGZ1bmN0aW9uIGRldGVjdGVkIGluIGEgbm9uLVNTUi1vcHRpbWl6ZWQgcmVuZGVyIGZ1bmN0aW9uLiBZb3UgbmVlZCB0byBtYXJrIHRoaXMgY29tcG9uZW50IHdpdGggJGR5bmFtaWMtc2xvdHMgaW4gdGhlIHBhcmVudCB0ZW1wbGF0ZS5gCiAgICAgICk7CiAgICAgIHNsb3QgPSAoKSA9PiBbXTsKICAgIH0KICAgIGlmIChzbG90ICYmIHNsb3QuX2MpIHsKICAgICAgc2xvdC5fZCA9IGZhbHNlOwogICAgfQogICAgb3BlbkJsb2NrKCk7CiAgICBjb25zdCB2YWxpZFNsb3RDb250ZW50ID0gc2xvdCAmJiBlbnN1cmVWYWxpZFZOb2RlKHNsb3QocHJvcHMpKTsKICAgIGNvbnN0IHJlbmRlcmVkID0gY3JlYXRlQmxvY2soCiAgICAgIEZyYWdtZW50LAogICAgICB7CiAgICAgICAga2V5OiBwcm9wcy5rZXkgfHwgLy8gc2xvdCBjb250ZW50IGFycmF5IG9mIGEgZHluYW1pYyBjb25kaXRpb25hbCBzbG90IG1heSBoYXZlIGEgYnJhbmNoCiAgICAgICAgLy8ga2V5IGF0dGFjaGVkIGluIHRoZSBgY3JlYXRlU2xvdHNgIGhlbHBlciwgcmVzcGVjdCB0aGF0CiAgICAgICAgdmFsaWRTbG90Q29udGVudCAmJiB2YWxpZFNsb3RDb250ZW50LmtleSB8fCBgXyR7bmFtZX1gCiAgICAgIH0sCiAgICAgIHZhbGlkU2xvdENvbnRlbnQgfHwgKGZhbGxiYWNrID8gZmFsbGJhY2soKSA6IFtdKSwKICAgICAgdmFsaWRTbG90Q29udGVudCAmJiBzbG90cy5fID09PSAxID8gNjQgOiAtMgogICAgKTsKICAgIGlmICghbm9TbG90dGVkICYmIHJlbmRlcmVkLnNjb3BlSWQpIHsKICAgICAgcmVuZGVyZWQuc2xvdFNjb3BlSWRzID0gW3JlbmRlcmVkLnNjb3BlSWQgKyAiLXMiXTsKICAgIH0KICAgIGlmIChzbG90ICYmIHNsb3QuX2MpIHsKICAgICAgc2xvdC5fZCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gcmVuZGVyZWQ7CiAgfQogIGZ1bmN0aW9uIGVuc3VyZVZhbGlkVk5vZGUodm5vZGVzKSB7CiAgICByZXR1cm4gdm5vZGVzLnNvbWUoKGNoaWxkKSA9PiB7CiAgICAgIGlmICghaXNWTm9kZShjaGlsZCkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGlmIChjaGlsZC50eXBlID09PSBDb21tZW50KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IEZyYWdtZW50ICYmICFlbnN1cmVWYWxpZFZOb2RlKGNoaWxkLmNoaWxkcmVuKSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSkgPyB2bm9kZXMgOiBudWxsOwogIH0KCiAgZnVuY3Rpb24gdG9IYW5kbGVycyhvYmosIHByZXNlcnZlQ2FzZUlmTmVjZXNzYXJ5KSB7CiAgICBjb25zdCByZXQgPSB7fTsKICAgIGlmICghaXNPYmplY3Qob2JqKSkgewogICAgICB3YXJuJDEoYHYtb24gd2l0aCBubyBhcmd1bWVudCBleHBlY3RzIGFuIG9iamVjdCB2YWx1ZS5gKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH0KICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICByZXRbcHJlc2VydmVDYXNlSWZOZWNlc3NhcnkgJiYgL1tBLVpdLy50ZXN0KGtleSkgPyBgb246JHtrZXl9YCA6IHRvSGFuZGxlcktleShrZXkpXSA9IG9ialtrZXldOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CgogIGNvbnN0IGdldFB1YmxpY0luc3RhbmNlID0gKGkpID0+IHsKICAgIGlmICghaSkKICAgICAgcmV0dXJuIG51bGw7CiAgICBpZiAoaXNTdGF0ZWZ1bENvbXBvbmVudChpKSkKICAgICAgcmV0dXJuIGdldEV4cG9zZVByb3h5KGkpIHx8IGkucHJveHk7CiAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoaS5wYXJlbnQpOwogIH07CiAgY29uc3QgcHVibGljUHJvcGVydGllc01hcCA9ICgKICAgIC8vIE1vdmUgUFVSRSBtYXJrZXIgdG8gbmV3IGxpbmUgdG8gd29ya2Fyb3VuZCBjb21waWxlciBkaXNjYXJkaW5nIGl0CiAgICAvLyBkdWUgdG8gdHlwZSBhbm5vdGF0aW9uCiAgICAvKiBAX19QVVJFX18gKi8gZXh0ZW5kKC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpLCB7CiAgICAgICQ6IChpKSA9PiBpLAogICAgICAkZWw6IChpKSA9PiBpLnZub2RlLmVsLAogICAgICAkZGF0YTogKGkpID0+IGkuZGF0YSwKICAgICAgJHByb3BzOiAoaSkgPT4gc2hhbGxvd1JlYWRvbmx5KGkucHJvcHMpICwKICAgICAgJGF0dHJzOiAoaSkgPT4gc2hhbGxvd1JlYWRvbmx5KGkuYXR0cnMpICwKICAgICAgJHNsb3RzOiAoaSkgPT4gc2hhbGxvd1JlYWRvbmx5KGkuc2xvdHMpICwKICAgICAgJHJlZnM6IChpKSA9PiBzaGFsbG93UmVhZG9ubHkoaS5yZWZzKSAsCiAgICAgICRwYXJlbnQ6IChpKSA9PiBnZXRQdWJsaWNJbnN0YW5jZShpLnBhcmVudCksCiAgICAgICRyb290OiAoaSkgPT4gZ2V0UHVibGljSW5zdGFuY2UoaS5yb290KSwKICAgICAgJGVtaXQ6IChpKSA9PiBpLmVtaXQsCiAgICAgICRvcHRpb25zOiAoaSkgPT4gcmVzb2x2ZU1lcmdlZE9wdGlvbnMoaSkgLAogICAgICAkZm9yY2VVcGRhdGU6IChpKSA9PiBpLmYgfHwgKGkuZiA9ICgpID0+IHsKICAgICAgICBpLmVmZmVjdC5kaXJ0eSA9IHRydWU7CiAgICAgICAgcXVldWVKb2IoaS51cGRhdGUpOwogICAgICB9KSwKICAgICAgJG5leHRUaWNrOiAoaSkgPT4gaS5uIHx8IChpLm4gPSBuZXh0VGljay5iaW5kKGkucHJveHkpKSwKICAgICAgJHdhdGNoOiAoaSkgPT4gaW5zdGFuY2VXYXRjaC5iaW5kKGkpIAogICAgfSkKICApOwogIGNvbnN0IGlzUmVzZXJ2ZWRQcmVmaXggPSAoa2V5KSA9PiBrZXkgPT09ICJfIiB8fCBrZXkgPT09ICIkIjsKICBjb25zdCBoYXNTZXR1cEJpbmRpbmcgPSAoc3RhdGUsIGtleSkgPT4gc3RhdGUgIT09IEVNUFRZX09CSiAmJiAhc3RhdGUuX19pc1NjcmlwdFNldHVwICYmIGhhc093bihzdGF0ZSwga2V5KTsKICBjb25zdCBQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMgPSB7CiAgICBnZXQoeyBfOiBpbnN0YW5jZSB9LCBrZXkpIHsKICAgICAgY29uc3QgeyBjdHgsIHNldHVwU3RhdGUsIGRhdGEsIHByb3BzLCBhY2Nlc3NDYWNoZSwgdHlwZSwgYXBwQ29udGV4dCB9ID0gaW5zdGFuY2U7CiAgICAgIGlmIChrZXkgPT09ICJfX2lzVnVlIikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGxldCBub3JtYWxpemVkUHJvcHM7CiAgICAgIGlmIChrZXlbMF0gIT09ICIkIikgewogICAgICAgIGNvbnN0IG4gPSBhY2Nlc3NDYWNoZVtrZXldOwogICAgICAgIGlmIChuICE9PSB2b2lkIDApIHsKICAgICAgICAgIHN3aXRjaCAobikgewogICAgICAgICAgICBjYXNlIDEgLyogU0VUVVAgKi86CiAgICAgICAgICAgICAgcmV0dXJuIHNldHVwU3RhdGVba2V5XTsKICAgICAgICAgICAgY2FzZSAyIC8qIERBVEEgKi86CiAgICAgICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsKICAgICAgICAgICAgY2FzZSA0IC8qIENPTlRFWFQgKi86CiAgICAgICAgICAgICAgcmV0dXJuIGN0eFtrZXldOwogICAgICAgICAgICBjYXNlIDMgLyogUFJPUFMgKi86CiAgICAgICAgICAgICAgcmV0dXJuIHByb3BzW2tleV07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChoYXNTZXR1cEJpbmRpbmcoc2V0dXBTdGF0ZSwga2V5KSkgewogICAgICAgICAgYWNjZXNzQ2FjaGVba2V5XSA9IDEgLyogU0VUVVAgKi87CiAgICAgICAgICByZXR1cm4gc2V0dXBTdGF0ZVtrZXldOwogICAgICAgIH0gZWxzZSBpZiAoZGF0YSAhPT0gRU1QVFlfT0JKICYmIGhhc093bihkYXRhLCBrZXkpKSB7CiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMiAvKiBEQVRBICovOwogICAgICAgICAgcmV0dXJuIGRhdGFba2V5XTsKICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgLy8gb25seSBjYWNoZSBvdGhlciBwcm9wZXJ0aWVzIHdoZW4gaW5zdGFuY2UgaGFzIGRlY2xhcmVkICh0aHVzIHN0YWJsZSkKICAgICAgICAgIC8vIHByb3BzCiAgICAgICAgICAobm9ybWFsaXplZFByb3BzID0gaW5zdGFuY2UucHJvcHNPcHRpb25zWzBdKSAmJiBoYXNPd24obm9ybWFsaXplZFByb3BzLCBrZXkpCiAgICAgICAgKSB7CiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMyAvKiBQUk9QUyAqLzsKICAgICAgICAgIHJldHVybiBwcm9wc1trZXldOwogICAgICAgIH0gZWxzZSBpZiAoY3R4ICE9PSBFTVBUWV9PQkogJiYgaGFzT3duKGN0eCwga2V5KSkgewogICAgICAgICAgYWNjZXNzQ2FjaGVba2V5XSA9IDQgLyogQ09OVEVYVCAqLzsKICAgICAgICAgIHJldHVybiBjdHhba2V5XTsKICAgICAgICB9IGVsc2UgaWYgKHNob3VsZENhY2hlQWNjZXNzKSB7CiAgICAgICAgICBhY2Nlc3NDYWNoZVtrZXldID0gMCAvKiBPVEhFUiAqLzsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgcHVibGljR2V0dGVyID0gcHVibGljUHJvcGVydGllc01hcFtrZXldOwogICAgICBsZXQgY3NzTW9kdWxlLCBnbG9iYWxQcm9wZXJ0aWVzOwogICAgICBpZiAocHVibGljR2V0dGVyKSB7CiAgICAgICAgaWYgKGtleSA9PT0gIiRhdHRycyIpIHsKICAgICAgICAgIHRyYWNrKGluc3RhbmNlLCAiZ2V0Iiwga2V5KTsKICAgICAgICAgIG1hcmtBdHRyc0FjY2Vzc2VkKCk7CiAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICIkc2xvdHMiKSB7CiAgICAgICAgICB0cmFjayhpbnN0YW5jZSwgImdldCIsIGtleSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwdWJsaWNHZXR0ZXIoaW5zdGFuY2UpOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgIC8vIGNzcyBtb2R1bGUgKGluamVjdGVkIGJ5IHZ1ZS1sb2FkZXIpCiAgICAgICAgKGNzc01vZHVsZSA9IHR5cGUuX19jc3NNb2R1bGVzKSAmJiAoY3NzTW9kdWxlID0gY3NzTW9kdWxlW2tleV0pCiAgICAgICkgewogICAgICAgIHJldHVybiBjc3NNb2R1bGU7CiAgICAgIH0gZWxzZSBpZiAoY3R4ICE9PSBFTVBUWV9PQkogJiYgaGFzT3duKGN0eCwga2V5KSkgewogICAgICAgIGFjY2Vzc0NhY2hlW2tleV0gPSA0IC8qIENPTlRFWFQgKi87CiAgICAgICAgcmV0dXJuIGN0eFtrZXldOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgIC8vIGdsb2JhbCBwcm9wZXJ0aWVzCiAgICAgICAgZ2xvYmFsUHJvcGVydGllcyA9IGFwcENvbnRleHQuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMsIGhhc093bihnbG9iYWxQcm9wZXJ0aWVzLCBrZXkpCiAgICAgICkgewogICAgICAgIHsKICAgICAgICAgIHJldHVybiBnbG9iYWxQcm9wZXJ0aWVzW2tleV07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSAmJiAoIWlzU3RyaW5nKGtleSkgfHwgLy8gIzEwOTEgYXZvaWQgaW50ZXJuYWwgaXNSZWYvaXNWTm9kZSBjaGVja3Mgb24gY29tcG9uZW50IGluc3RhbmNlIGxlYWRpbmcKICAgICAgLy8gdG8gaW5maW5pdGUgd2FybmluZyBsb29wCiAgICAgIGtleS5pbmRleE9mKCJfX3YiKSAhPT0gMCkpIHsKICAgICAgICBpZiAoZGF0YSAhPT0gRU1QVFlfT0JKICYmIGlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSAmJiBoYXNPd24oZGF0YSwga2V5KSkgewogICAgICAgICAgd2FybiQxKAogICAgICAgICAgICBgUHJvcGVydHkgJHtKU09OLnN0cmluZ2lmeSgKICAgICAgICAgICAga2V5CiAgICAgICAgICApfSBtdXN0IGJlIGFjY2Vzc2VkIHZpYSAkZGF0YSBiZWNhdXNlIGl0IHN0YXJ0cyB3aXRoIGEgcmVzZXJ2ZWQgY2hhcmFjdGVyICgiJCIgb3IgIl8iKSBhbmQgaXMgbm90IHByb3hpZWQgb24gdGhlIHJlbmRlciBjb250ZXh0LmAKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZSA9PT0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlKSB7CiAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgIGBQcm9wZXJ0eSAke0pTT04uc3RyaW5naWZ5KGtleSl9IHdhcyBhY2Nlc3NlZCBkdXJpbmcgcmVuZGVyIGJ1dCBpcyBub3QgZGVmaW5lZCBvbiBpbnN0YW5jZS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHNldCh7IF86IGluc3RhbmNlIH0sIGtleSwgdmFsdWUpIHsKICAgICAgY29uc3QgeyBkYXRhLCBzZXR1cFN0YXRlLCBjdHggfSA9IGluc3RhbmNlOwogICAgICBpZiAoaGFzU2V0dXBCaW5kaW5nKHNldHVwU3RhdGUsIGtleSkpIHsKICAgICAgICBzZXR1cFN0YXRlW2tleV0gPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChzZXR1cFN0YXRlLl9faXNTY3JpcHRTZXR1cCAmJiBoYXNPd24oc2V0dXBTdGF0ZSwga2V5KSkgewogICAgICAgIHdhcm4kMShgQ2Fubm90IG11dGF0ZSA8c2NyaXB0IHNldHVwPiBiaW5kaW5nICIke2tleX0iIGZyb20gT3B0aW9ucyBBUEkuYCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IGVsc2UgaWYgKGRhdGEgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oZGF0YSwga2V5KSkgewogICAgICAgIGRhdGFba2V5XSA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGhhc093bihpbnN0YW5jZS5wcm9wcywga2V5KSkgewogICAgICAgIHdhcm4kMShgQXR0ZW1wdGluZyB0byBtdXRhdGUgcHJvcCAiJHtrZXl9Ii4gUHJvcHMgYXJlIHJlYWRvbmx5LmApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoa2V5WzBdID09PSAiJCIgJiYga2V5LnNsaWNlKDEpIGluIGluc3RhbmNlKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYEF0dGVtcHRpbmcgdG8gbXV0YXRlIHB1YmxpYyBwcm9wZXJ0eSAiJHtrZXl9Ii4gUHJvcGVydGllcyBzdGFydGluZyB3aXRoICQgYXJlIHJlc2VydmVkIGFuZCByZWFkb25seS5gCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGtleSBpbiBpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZy5nbG9iYWxQcm9wZXJ0aWVzKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY3R4LCBrZXksIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICB2YWx1ZQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eFtrZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIGhhcyh7CiAgICAgIF86IHsgZGF0YSwgc2V0dXBTdGF0ZSwgYWNjZXNzQ2FjaGUsIGN0eCwgYXBwQ29udGV4dCwgcHJvcHNPcHRpb25zIH0KICAgIH0sIGtleSkgewogICAgICBsZXQgbm9ybWFsaXplZFByb3BzOwogICAgICByZXR1cm4gISFhY2Nlc3NDYWNoZVtrZXldIHx8IGRhdGEgIT09IEVNUFRZX09CSiAmJiBoYXNPd24oZGF0YSwga2V5KSB8fCBoYXNTZXR1cEJpbmRpbmcoc2V0dXBTdGF0ZSwga2V5KSB8fCAobm9ybWFsaXplZFByb3BzID0gcHJvcHNPcHRpb25zWzBdKSAmJiBoYXNPd24obm9ybWFsaXplZFByb3BzLCBrZXkpIHx8IGhhc093bihjdHgsIGtleSkgfHwgaGFzT3duKHB1YmxpY1Byb3BlcnRpZXNNYXAsIGtleSkgfHwgaGFzT3duKGFwcENvbnRleHQuY29uZmlnLmdsb2JhbFByb3BlcnRpZXMsIGtleSk7CiAgICB9LAogICAgZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIGRlc2NyaXB0b3IpIHsKICAgICAgaWYgKGRlc2NyaXB0b3IuZ2V0ICE9IG51bGwpIHsKICAgICAgICB0YXJnZXQuXy5hY2Nlc3NDYWNoZVtrZXldID0gMDsKICAgICAgfSBlbHNlIGlmIChoYXNPd24oZGVzY3JpcHRvciwgInZhbHVlIikpIHsKICAgICAgICB0aGlzLnNldCh0YXJnZXQsIGtleSwgZGVzY3JpcHRvci52YWx1ZSwgbnVsbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIFJlZmxlY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIGRlc2NyaXB0b3IpOwogICAgfQogIH07CiAgewogICAgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLm93bktleXMgPSAodGFyZ2V0KSA9PiB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgQXZvaWQgYXBwIGxvZ2ljIHRoYXQgcmVsaWVzIG9uIGVudW1lcmF0aW5nIGtleXMgb24gYSBjb21wb25lbnQgaW5zdGFuY2UuIFRoZSBrZXlzIHdpbGwgYmUgZW1wdHkgaW4gcHJvZHVjdGlvbiBtb2RlIHRvIGF2b2lkIHBlcmZvcm1hbmNlIG92ZXJoZWFkLmAKICAgICAgKTsKICAgICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyh0YXJnZXQpOwogICAgfTsKICB9CiAgY29uc3QgUnVudGltZUNvbXBpbGVkUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzID0gLyogQF9fUFVSRV9fICovIGV4dGVuZCgKICAgIHt9LAogICAgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzLAogICAgewogICAgICBnZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgICBpZiAoa2V5ID09PSBTeW1ib2wudW5zY29wYWJsZXMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFB1YmxpY0luc3RhbmNlUHJveHlIYW5kbGVycy5nZXQodGFyZ2V0LCBrZXksIHRhcmdldCk7CiAgICAgIH0sCiAgICAgIGhhcyhfLCBrZXkpIHsKICAgICAgICBjb25zdCBoYXMgPSBrZXlbMF0gIT09ICJfIiAmJiAhaXNHbG9iYWxseUFsbG93ZWQoa2V5KTsKICAgICAgICBpZiAoIWhhcyAmJiBQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMuaGFzKF8sIGtleSkpIHsKICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgYFByb3BlcnR5ICR7SlNPTi5zdHJpbmdpZnkoCiAgICAgICAgICAgIGtleQogICAgICAgICAgKX0gc2hvdWxkIG5vdCBzdGFydCB3aXRoIF8gd2hpY2ggaXMgYSByZXNlcnZlZCBwcmVmaXggZm9yIFZ1ZSBpbnRlcm5hbHMuYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhhczsKICAgICAgfQogICAgfQogICk7CiAgZnVuY3Rpb24gY3JlYXRlRGV2UmVuZGVyQ29udGV4dChpbnN0YW5jZSkgewogICAgY29uc3QgdGFyZ2V0ID0ge307CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBgX2AsIHsKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgZ2V0OiAoKSA9PiBpbnN0YW5jZQogICAgfSk7CiAgICBPYmplY3Qua2V5cyhwdWJsaWNQcm9wZXJ0aWVzTWFwKS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIGdldDogKCkgPT4gcHVibGljUHJvcGVydGllc01hcFtrZXldKGluc3RhbmNlKSwKICAgICAgICAvLyBpbnRlcmNlcHRlZCBieSB0aGUgcHJveHkgc28gbm8gbmVlZCBmb3IgaW1wbGVtZW50YXRpb24sCiAgICAgICAgLy8gYnV0IG5lZWRlZCB0byBwcmV2ZW50IHNldCBlcnJvcnMKICAgICAgICBzZXQ6IE5PT1AKICAgICAgfSk7CiAgICB9KTsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGZ1bmN0aW9uIGV4cG9zZVByb3BzT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKSB7CiAgICBjb25zdCB7CiAgICAgIGN0eCwKICAgICAgcHJvcHNPcHRpb25zOiBbcHJvcHNPcHRpb25zXQogICAgfSA9IGluc3RhbmNlOwogICAgaWYgKHByb3BzT3B0aW9ucykgewogICAgICBPYmplY3Qua2V5cyhwcm9wc09wdGlvbnMpLmZvckVhY2goKGtleSkgPT4gewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIGdldDogKCkgPT4gaW5zdGFuY2UucHJvcHNba2V5XSwKICAgICAgICAgIHNldDogTk9PUAogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZXhwb3NlU2V0dXBTdGF0ZU9uUmVuZGVyQ29udGV4dChpbnN0YW5jZSkgewogICAgY29uc3QgeyBjdHgsIHNldHVwU3RhdGUgfSA9IGluc3RhbmNlOwogICAgT2JqZWN0LmtleXModG9SYXcoc2V0dXBTdGF0ZSkpLmZvckVhY2goKGtleSkgPT4gewogICAgICBpZiAoIXNldHVwU3RhdGUuX19pc1NjcmlwdFNldHVwKSB7CiAgICAgICAgaWYgKGlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSkgewogICAgICAgICAgd2FybiQxKAogICAgICAgICAgICBgc2V0dXAoKSByZXR1cm4gcHJvcGVydHkgJHtKU09OLnN0cmluZ2lmeSgKICAgICAgICAgICAga2V5CiAgICAgICAgICApfSBzaG91bGQgbm90IHN0YXJ0IHdpdGggIiQiIG9yICJfIiB3aGljaCBhcmUgcmVzZXJ2ZWQgcHJlZml4ZXMgZm9yIFZ1ZSBpbnRlcm5hbHMuYAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eCwga2V5LCB7CiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiAoKSA9PiBzZXR1cFN0YXRlW2tleV0sCiAgICAgICAgICBzZXQ6IE5PT1AKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBjb25zdCB3YXJuUnVudGltZVVzYWdlID0gKG1ldGhvZCkgPT4gd2FybiQxKAogICAgYCR7bWV0aG9kfSgpIGlzIGEgY29tcGlsZXItaGludCBoZWxwZXIgdGhhdCBpcyBvbmx5IHVzYWJsZSBpbnNpZGUgPHNjcmlwdCBzZXR1cD4gb2YgYSBzaW5nbGUgZmlsZSBjb21wb25lbnQuIEl0cyBhcmd1bWVudHMgc2hvdWxkIGJlIGNvbXBpbGVkIGF3YXkgYW5kIHBhc3NpbmcgaXQgYXQgcnVudGltZSBoYXMgbm8gZWZmZWN0LmAKICApOwogIGZ1bmN0aW9uIGRlZmluZVByb3BzKCkgewogICAgewogICAgICB3YXJuUnVudGltZVVzYWdlKGBkZWZpbmVQcm9wc2ApOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uIGRlZmluZUVtaXRzKCkgewogICAgewogICAgICB3YXJuUnVudGltZVVzYWdlKGBkZWZpbmVFbWl0c2ApOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uIGRlZmluZUV4cG9zZShleHBvc2VkKSB7CiAgICB7CiAgICAgIHdhcm5SdW50aW1lVXNhZ2UoYGRlZmluZUV4cG9zZWApOwogICAgfQogIH0KICBmdW5jdGlvbiBkZWZpbmVPcHRpb25zKG9wdGlvbnMpIHsKICAgIHsKICAgICAgd2FyblJ1bnRpbWVVc2FnZShgZGVmaW5lT3B0aW9uc2ApOwogICAgfQogIH0KICBmdW5jdGlvbiBkZWZpbmVTbG90cygpIHsKICAgIHsKICAgICAgd2FyblJ1bnRpbWVVc2FnZShgZGVmaW5lU2xvdHNgKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiBkZWZpbmVNb2RlbCgpIHsKICAgIHsKICAgICAgd2FyblJ1bnRpbWVVc2FnZSgiZGVmaW5lTW9kZWwiKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gd2l0aERlZmF1bHRzKHByb3BzLCBkZWZhdWx0cykgewogICAgewogICAgICB3YXJuUnVudGltZVVzYWdlKGB3aXRoRGVmYXVsdHNgKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KICBmdW5jdGlvbiB1c2VTbG90cygpIHsKICAgIHJldHVybiBnZXRDb250ZXh0KCkuc2xvdHM7CiAgfQogIGZ1bmN0aW9uIHVzZUF0dHJzKCkgewogICAgcmV0dXJuIGdldENvbnRleHQoKS5hdHRyczsKICB9CiAgZnVuY3Rpb24gZ2V0Q29udGV4dCgpIHsKICAgIGNvbnN0IGkgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgIGlmICghaSkgewogICAgICB3YXJuJDEoYHVzZUNvbnRleHQoKSBjYWxsZWQgd2l0aG91dCBhY3RpdmUgaW5zdGFuY2UuYCk7CiAgICB9CiAgICByZXR1cm4gaS5zZXR1cENvbnRleHQgfHwgKGkuc2V0dXBDb250ZXh0ID0gY3JlYXRlU2V0dXBDb250ZXh0KGkpKTsKICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplUHJvcHNPckVtaXRzKHByb3BzKSB7CiAgICByZXR1cm4gaXNBcnJheShwcm9wcykgPyBwcm9wcy5yZWR1Y2UoCiAgICAgIChub3JtYWxpemVkLCBwKSA9PiAobm9ybWFsaXplZFtwXSA9IG51bGwsIG5vcm1hbGl6ZWQpLAogICAgICB7fQogICAgKSA6IHByb3BzOwogIH0KICBmdW5jdGlvbiBtZXJnZURlZmF1bHRzKHJhdywgZGVmYXVsdHMpIHsKICAgIGNvbnN0IHByb3BzID0gbm9ybWFsaXplUHJvcHNPckVtaXRzKHJhdyk7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBkZWZhdWx0cykgewogICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoIl9fc2tpcCIpKQogICAgICAgIGNvbnRpbnVlOwogICAgICBsZXQgb3B0ID0gcHJvcHNba2V5XTsKICAgICAgaWYgKG9wdCkgewogICAgICAgIGlmIChpc0FycmF5KG9wdCkgfHwgaXNGdW5jdGlvbihvcHQpKSB7CiAgICAgICAgICBvcHQgPSBwcm9wc1trZXldID0geyB0eXBlOiBvcHQsIGRlZmF1bHQ6IGRlZmF1bHRzW2tleV0gfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0LmRlZmF1bHQgPSBkZWZhdWx0c1trZXldOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChvcHQgPT09IG51bGwpIHsKICAgICAgICBvcHQgPSBwcm9wc1trZXldID0geyBkZWZhdWx0OiBkZWZhdWx0c1trZXldIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybiQxKGBwcm9wcyBkZWZhdWx0IGtleSAiJHtrZXl9IiBoYXMgbm8gY29ycmVzcG9uZGluZyBkZWNsYXJhdGlvbi5gKTsKICAgICAgfQogICAgICBpZiAob3B0ICYmIGRlZmF1bHRzW2BfX3NraXBfJHtrZXl9YF0pIHsKICAgICAgICBvcHQuc2tpcEZhY3RvcnkgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcHJvcHM7CiAgfQogIGZ1bmN0aW9uIG1lcmdlTW9kZWxzKGEsIGIpIHsKICAgIGlmICghYSB8fCAhYikKICAgICAgcmV0dXJuIGEgfHwgYjsKICAgIGlmIChpc0FycmF5KGEpICYmIGlzQXJyYXkoYikpCiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIHJldHVybiBleHRlbmQoe30sIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyhhKSwgbm9ybWFsaXplUHJvcHNPckVtaXRzKGIpKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJvcHNSZXN0UHJveHkocHJvcHMsIGV4Y2x1ZGVkS2V5cykgewogICAgY29uc3QgcmV0ID0ge307CiAgICBmb3IgKGNvbnN0IGtleSBpbiBwcm9wcykgewogICAgICBpZiAoIWV4Y2x1ZGVkS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHJldCwga2V5LCB7CiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiAoKSA9PiBwcm9wc1trZXldCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGZ1bmN0aW9uIHdpdGhBc3luY0NvbnRleHQoZ2V0QXdhaXRhYmxlKSB7CiAgICBjb25zdCBjdHggPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgIGlmICghY3R4KSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgd2l0aEFzeW5jQ29udGV4dCBjYWxsZWQgd2l0aG91dCBhY3RpdmUgY3VycmVudCBpbnN0YW5jZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcuYAogICAgICApOwogICAgfQogICAgbGV0IGF3YWl0YWJsZSA9IGdldEF3YWl0YWJsZSgpOwogICAgdW5zZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgIGlmIChpc1Byb21pc2UoYXdhaXRhYmxlKSkgewogICAgICBhd2FpdGFibGUgPSBhd2FpdGFibGUuY2F0Y2goKGUpID0+IHsKICAgICAgICBzZXRDdXJyZW50SW5zdGFuY2UoY3R4KTsKICAgICAgICB0aHJvdyBlOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBbYXdhaXRhYmxlLCAoKSA9PiBzZXRDdXJyZW50SW5zdGFuY2UoY3R4KV07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVEdXBsaWNhdGVDaGVja2VyKCkgewogICAgY29uc3QgY2FjaGUgPSAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHJldHVybiAodHlwZSwga2V5KSA9PiB7CiAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgd2FybiQxKGAke3R5cGV9IHByb3BlcnR5ICIke2tleX0iIGlzIGFscmVhZHkgZGVmaW5lZCBpbiAke2NhY2hlW2tleV19LmApOwogICAgICB9IGVsc2UgewogICAgICAgIGNhY2hlW2tleV0gPSB0eXBlOwogICAgICB9CiAgICB9OwogIH0KICBsZXQgc2hvdWxkQ2FjaGVBY2Nlc3MgPSB0cnVlOwogIGZ1bmN0aW9uIGFwcGx5T3B0aW9ucyhpbnN0YW5jZSkgewogICAgY29uc3Qgb3B0aW9ucyA9IHJlc29sdmVNZXJnZWRPcHRpb25zKGluc3RhbmNlKTsKICAgIGNvbnN0IHB1YmxpY1RoaXMgPSBpbnN0YW5jZS5wcm94eTsKICAgIGNvbnN0IGN0eCA9IGluc3RhbmNlLmN0eDsKICAgIHNob3VsZENhY2hlQWNjZXNzID0gZmFsc2U7CiAgICBpZiAob3B0aW9ucy5iZWZvcmVDcmVhdGUpIHsKICAgICAgY2FsbEhvb2skMShvcHRpb25zLmJlZm9yZUNyZWF0ZSwgaW5zdGFuY2UsICJiYyIpOwogICAgfQogICAgY29uc3QgewogICAgICAvLyBzdGF0ZQogICAgICBkYXRhOiBkYXRhT3B0aW9ucywKICAgICAgY29tcHV0ZWQ6IGNvbXB1dGVkT3B0aW9ucywKICAgICAgbWV0aG9kcywKICAgICAgd2F0Y2g6IHdhdGNoT3B0aW9ucywKICAgICAgcHJvdmlkZTogcHJvdmlkZU9wdGlvbnMsCiAgICAgIGluamVjdDogaW5qZWN0T3B0aW9ucywKICAgICAgLy8gbGlmZWN5Y2xlCiAgICAgIGNyZWF0ZWQsCiAgICAgIGJlZm9yZU1vdW50LAogICAgICBtb3VudGVkLAogICAgICBiZWZvcmVVcGRhdGUsCiAgICAgIHVwZGF0ZWQsCiAgICAgIGFjdGl2YXRlZCwKICAgICAgZGVhY3RpdmF0ZWQsCiAgICAgIGJlZm9yZURlc3Ryb3ksCiAgICAgIGJlZm9yZVVubW91bnQsCiAgICAgIGRlc3Ryb3llZCwKICAgICAgdW5tb3VudGVkLAogICAgICByZW5kZXIsCiAgICAgIHJlbmRlclRyYWNrZWQsCiAgICAgIHJlbmRlclRyaWdnZXJlZCwKICAgICAgZXJyb3JDYXB0dXJlZCwKICAgICAgc2VydmVyUHJlZmV0Y2gsCiAgICAgIC8vIHB1YmxpYyBBUEkKICAgICAgZXhwb3NlLAogICAgICBpbmhlcml0QXR0cnMsCiAgICAgIC8vIGFzc2V0cwogICAgICBjb21wb25lbnRzLAogICAgICBkaXJlY3RpdmVzLAogICAgICBmaWx0ZXJzCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IGNoZWNrRHVwbGljYXRlUHJvcGVydGllcyA9IGNyZWF0ZUR1cGxpY2F0ZUNoZWNrZXIoKSA7CiAgICB7CiAgICAgIGNvbnN0IFtwcm9wc09wdGlvbnNdID0gaW5zdGFuY2UucHJvcHNPcHRpb25zOwogICAgICBpZiAocHJvcHNPcHRpb25zKSB7CiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHNPcHRpb25zKSB7CiAgICAgICAgICBjaGVja0R1cGxpY2F0ZVByb3BlcnRpZXMoIlByb3BzIiAvKiBQUk9QUyAqLywga2V5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChpbmplY3RPcHRpb25zKSB7CiAgICAgIHJlc29sdmVJbmplY3Rpb25zKGluamVjdE9wdGlvbnMsIGN0eCwgY2hlY2tEdXBsaWNhdGVQcm9wZXJ0aWVzKTsKICAgIH0KICAgIGlmIChtZXRob2RzKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG1ldGhvZHMpIHsKICAgICAgICBjb25zdCBtZXRob2RIYW5kbGVyID0gbWV0aG9kc1trZXldOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKG1ldGhvZEhhbmRsZXIpKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgICAgIHZhbHVlOiBtZXRob2RIYW5kbGVyLmJpbmQocHVibGljVGhpcyksCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiTWV0aG9kcyIgLyogTUVUSE9EUyAqLywga2V5KTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2FybiQxKAogICAgICAgICAgICBgTWV0aG9kICIke2tleX0iIGhhcyB0eXBlICIke3R5cGVvZiBtZXRob2RIYW5kbGVyfSIgaW4gdGhlIGNvbXBvbmVudCBkZWZpbml0aW9uLiBEaWQgeW91IHJlZmVyZW5jZSB0aGUgZnVuY3Rpb24gY29ycmVjdGx5P2AKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoZGF0YU9wdGlvbnMpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGRhdGFPcHRpb25zKSkgewogICAgICAgIHdhcm4kMSgKICAgICAgICAgIGBUaGUgZGF0YSBvcHRpb24gbXVzdCBiZSBhIGZ1bmN0aW9uLiBQbGFpbiBvYmplY3QgdXNhZ2UgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZC5gCiAgICAgICAgKTsKICAgICAgfQogICAgICBjb25zdCBkYXRhID0gZGF0YU9wdGlvbnMuY2FsbChwdWJsaWNUaGlzLCBwdWJsaWNUaGlzKTsKICAgICAgaWYgKGlzUHJvbWlzZShkYXRhKSkgewogICAgICAgIHdhcm4kMSgKICAgICAgICAgIGBkYXRhKCkgcmV0dXJuZWQgYSBQcm9taXNlIC0gbm90ZSBkYXRhKCkgY2Fubm90IGJlIGFzeW5jOyBJZiB5b3UgaW50ZW5kIHRvIHBlcmZvcm0gZGF0YSBmZXRjaGluZyBiZWZvcmUgY29tcG9uZW50IHJlbmRlcnMsIHVzZSBhc3luYyBzZXR1cCgpICsgPFN1c3BlbnNlPi5gCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAoIWlzT2JqZWN0KGRhdGEpKSB7CiAgICAgICAgd2FybiQxKGBkYXRhKCkgc2hvdWxkIHJldHVybiBhbiBvYmplY3QuYCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5zdGFuY2UuZGF0YSA9IHJlYWN0aXZlKGRhdGEpOwogICAgICAgIHsKICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGRhdGEpIHsKICAgICAgICAgICAgY2hlY2tEdXBsaWNhdGVQcm9wZXJ0aWVzKCJEYXRhIiAvKiBEQVRBICovLCBrZXkpOwogICAgICAgICAgICBpZiAoIWlzUmVzZXJ2ZWRQcmVmaXgoa2V5WzBdKSkgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogKCkgPT4gZGF0YVtrZXldLAogICAgICAgICAgICAgICAgc2V0OiBOT09QCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHNob3VsZENhY2hlQWNjZXNzID0gdHJ1ZTsKICAgIGlmIChjb21wdXRlZE9wdGlvbnMpIHsKICAgICAgZm9yIChjb25zdCBrZXkgaW4gY29tcHV0ZWRPcHRpb25zKSB7CiAgICAgICAgY29uc3Qgb3B0ID0gY29tcHV0ZWRPcHRpb25zW2tleV07CiAgICAgICAgY29uc3QgZ2V0ID0gaXNGdW5jdGlvbihvcHQpID8gb3B0LmJpbmQocHVibGljVGhpcywgcHVibGljVGhpcykgOiBpc0Z1bmN0aW9uKG9wdC5nZXQpID8gb3B0LmdldC5iaW5kKHB1YmxpY1RoaXMsIHB1YmxpY1RoaXMpIDogTk9PUDsKICAgICAgICBpZiAoZ2V0ID09PSBOT09QKSB7CiAgICAgICAgICB3YXJuJDEoYENvbXB1dGVkIHByb3BlcnR5ICIke2tleX0iIGhhcyBubyBnZXR0ZXIuYCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNldCA9ICFpc0Z1bmN0aW9uKG9wdCkgJiYgaXNGdW5jdGlvbihvcHQuc2V0KSA/IG9wdC5zZXQuYmluZChwdWJsaWNUaGlzKSA6ICgpID0+IHsKICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgYFdyaXRlIG9wZXJhdGlvbiBmYWlsZWQ6IGNvbXB1dGVkIHByb3BlcnR5ICIke2tleX0iIGlzIHJlYWRvbmx5LmAKICAgICAgICAgICk7CiAgICAgICAgfSA7CiAgICAgICAgY29uc3QgYyA9IGNvbXB1dGVkKHsKICAgICAgICAgIGdldCwKICAgICAgICAgIHNldAogICAgICAgIH0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjdHgsIGtleSwgewogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIGdldDogKCkgPT4gYy52YWx1ZSwKICAgICAgICAgIHNldDogKHYpID0+IGMudmFsdWUgPSB2CiAgICAgICAgfSk7CiAgICAgICAgewogICAgICAgICAgY2hlY2tEdXBsaWNhdGVQcm9wZXJ0aWVzKCJDb21wdXRlZCIgLyogQ09NUFVURUQgKi8sIGtleSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAod2F0Y2hPcHRpb25zKSB7CiAgICAgIGZvciAoY29uc3Qga2V5IGluIHdhdGNoT3B0aW9ucykgewogICAgICAgIGNyZWF0ZVdhdGNoZXIod2F0Y2hPcHRpb25zW2tleV0sIGN0eCwgcHVibGljVGhpcywga2V5KTsKICAgICAgfQogICAgfQogICAgaWYgKHByb3ZpZGVPcHRpb25zKSB7CiAgICAgIGNvbnN0IHByb3ZpZGVzID0gaXNGdW5jdGlvbihwcm92aWRlT3B0aW9ucykgPyBwcm92aWRlT3B0aW9ucy5jYWxsKHB1YmxpY1RoaXMpIDogcHJvdmlkZU9wdGlvbnM7CiAgICAgIFJlZmxlY3Qub3duS2V5cyhwcm92aWRlcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgICAgcHJvdmlkZShrZXksIHByb3ZpZGVzW2tleV0pOwogICAgICB9KTsKICAgIH0KICAgIGlmIChjcmVhdGVkKSB7CiAgICAgIGNhbGxIb29rJDEoY3JlYXRlZCwgaW5zdGFuY2UsICJjIik7CiAgICB9CiAgICBmdW5jdGlvbiByZWdpc3RlckxpZmVjeWNsZUhvb2socmVnaXN0ZXIsIGhvb2spIHsKICAgICAgaWYgKGlzQXJyYXkoaG9vaykpIHsKICAgICAgICBob29rLmZvckVhY2goKF9ob29rKSA9PiByZWdpc3RlcihfaG9vay5iaW5kKHB1YmxpY1RoaXMpKSk7CiAgICAgIH0gZWxzZSBpZiAoaG9vaykgewogICAgICAgIHJlZ2lzdGVyKGhvb2suYmluZChwdWJsaWNUaGlzKSk7CiAgICAgIH0KICAgIH0KICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkJlZm9yZU1vdW50LCBiZWZvcmVNb3VudCk7CiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25Nb3VudGVkLCBtb3VudGVkKTsKICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkJlZm9yZVVwZGF0ZSwgYmVmb3JlVXBkYXRlKTsKICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblVwZGF0ZWQsIHVwZGF0ZWQpOwogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uQWN0aXZhdGVkLCBhY3RpdmF0ZWQpOwogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uRGVhY3RpdmF0ZWQsIGRlYWN0aXZhdGVkKTsKICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvbkVycm9yQ2FwdHVyZWQsIGVycm9yQ2FwdHVyZWQpOwogICAgcmVnaXN0ZXJMaWZlY3ljbGVIb29rKG9uUmVuZGVyVHJhY2tlZCwgcmVuZGVyVHJhY2tlZCk7CiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25SZW5kZXJUcmlnZ2VyZWQsIHJlbmRlclRyaWdnZXJlZCk7CiAgICByZWdpc3RlckxpZmVjeWNsZUhvb2sob25CZWZvcmVVbm1vdW50LCBiZWZvcmVVbm1vdW50KTsKICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblVubW91bnRlZCwgdW5tb3VudGVkKTsKICAgIHJlZ2lzdGVyTGlmZWN5Y2xlSG9vayhvblNlcnZlclByZWZldGNoLCBzZXJ2ZXJQcmVmZXRjaCk7CiAgICBpZiAoaXNBcnJheShleHBvc2UpKSB7CiAgICAgIGlmIChleHBvc2UubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgZXhwb3NlZCA9IGluc3RhbmNlLmV4cG9zZWQgfHwgKGluc3RhbmNlLmV4cG9zZWQgPSB7fSk7CiAgICAgICAgZXhwb3NlLmZvckVhY2goKGtleSkgPT4gewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9zZWQsIGtleSwgewogICAgICAgICAgICBnZXQ6ICgpID0+IHB1YmxpY1RoaXNba2V5XSwKICAgICAgICAgICAgc2V0OiAodmFsKSA9PiBwdWJsaWNUaGlzW2tleV0gPSB2YWwKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKCFpbnN0YW5jZS5leHBvc2VkKSB7CiAgICAgICAgaW5zdGFuY2UuZXhwb3NlZCA9IHt9OwogICAgICB9CiAgICB9CiAgICBpZiAocmVuZGVyICYmIGluc3RhbmNlLnJlbmRlciA9PT0gTk9PUCkgewogICAgICBpbnN0YW5jZS5yZW5kZXIgPSByZW5kZXI7CiAgICB9CiAgICBpZiAoaW5oZXJpdEF0dHJzICE9IG51bGwpIHsKICAgICAgaW5zdGFuY2UuaW5oZXJpdEF0dHJzID0gaW5oZXJpdEF0dHJzOwogICAgfQogICAgaWYgKGNvbXBvbmVudHMpCiAgICAgIGluc3RhbmNlLmNvbXBvbmVudHMgPSBjb21wb25lbnRzOwogICAgaWYgKGRpcmVjdGl2ZXMpCiAgICAgIGluc3RhbmNlLmRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzOwogIH0KICBmdW5jdGlvbiByZXNvbHZlSW5qZWN0aW9ucyhpbmplY3RPcHRpb25zLCBjdHgsIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcyA9IE5PT1ApIHsKICAgIGlmIChpc0FycmF5KGluamVjdE9wdGlvbnMpKSB7CiAgICAgIGluamVjdE9wdGlvbnMgPSBub3JtYWxpemVJbmplY3QoaW5qZWN0T3B0aW9ucyk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBpbiBpbmplY3RPcHRpb25zKSB7CiAgICAgIGNvbnN0IG9wdCA9IGluamVjdE9wdGlvbnNba2V5XTsKICAgICAgbGV0IGluamVjdGVkOwogICAgICBpZiAoaXNPYmplY3Qob3B0KSkgewogICAgICAgIGlmICgiZGVmYXVsdCIgaW4gb3B0KSB7CiAgICAgICAgICBpbmplY3RlZCA9IGluamVjdCgKICAgICAgICAgICAgb3B0LmZyb20gfHwga2V5LAogICAgICAgICAgICBvcHQuZGVmYXVsdCwKICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaW5qZWN0ZWQgPSBpbmplY3Qob3B0LmZyb20gfHwga2V5KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5qZWN0ZWQgPSBpbmplY3Qob3B0KTsKICAgICAgfQogICAgICBpZiAoaXNSZWYoaW5qZWN0ZWQpKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eCwga2V5LCB7CiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgZ2V0OiAoKSA9PiBpbmplY3RlZC52YWx1ZSwKICAgICAgICAgIHNldDogKHYpID0+IGluamVjdGVkLnZhbHVlID0gdgogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGN0eFtrZXldID0gaW5qZWN0ZWQ7CiAgICAgIH0KICAgICAgewogICAgICAgIGNoZWNrRHVwbGljYXRlUHJvcGVydGllcygiSW5qZWN0IiAvKiBJTkpFQ1QgKi8sIGtleSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY2FsbEhvb2skMShob29rLCBpbnN0YW5jZSwgdHlwZSkgewogICAgY2FsbFdpdGhBc3luY0Vycm9ySGFuZGxpbmcoCiAgICAgIGlzQXJyYXkoaG9vaykgPyBob29rLm1hcCgoaCkgPT4gaC5iaW5kKGluc3RhbmNlLnByb3h5KSkgOiBob29rLmJpbmQoaW5zdGFuY2UucHJveHkpLAogICAgICBpbnN0YW5jZSwKICAgICAgdHlwZQogICAgKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlV2F0Y2hlcihyYXcsIGN0eCwgcHVibGljVGhpcywga2V5KSB7CiAgICBjb25zdCBnZXR0ZXIgPSBrZXkuaW5jbHVkZXMoIi4iKSA/IGNyZWF0ZVBhdGhHZXR0ZXIocHVibGljVGhpcywga2V5KSA6ICgpID0+IHB1YmxpY1RoaXNba2V5XTsKICAgIGlmIChpc1N0cmluZyhyYXcpKSB7CiAgICAgIGNvbnN0IGhhbmRsZXIgPSBjdHhbcmF3XTsKICAgICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICB3YXRjaChnZXR0ZXIsIGhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4kMShgSW52YWxpZCB3YXRjaCBoYW5kbGVyIHNwZWNpZmllZCBieSBrZXkgIiR7cmF3fSJgLCBoYW5kbGVyKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHJhdykpIHsKICAgICAgd2F0Y2goZ2V0dGVyLCByYXcuYmluZChwdWJsaWNUaGlzKSk7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHJhdykpIHsKICAgICAgaWYgKGlzQXJyYXkocmF3KSkgewogICAgICAgIHJhdy5mb3JFYWNoKChyKSA9PiBjcmVhdGVXYXRjaGVyKHIsIGN0eCwgcHVibGljVGhpcywga2V5KSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaGFuZGxlciA9IGlzRnVuY3Rpb24ocmF3LmhhbmRsZXIpID8gcmF3LmhhbmRsZXIuYmluZChwdWJsaWNUaGlzKSA6IGN0eFtyYXcuaGFuZGxlcl07CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICAgIHdhdGNoKGdldHRlciwgaGFuZGxlciwgcmF3KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2FybiQxKGBJbnZhbGlkIHdhdGNoIGhhbmRsZXIgc3BlY2lmaWVkIGJ5IGtleSAiJHtyYXcuaGFuZGxlcn0iYCwgaGFuZGxlcik7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICB3YXJuJDEoYEludmFsaWQgd2F0Y2ggb3B0aW9uOiAiJHtrZXl9ImAsIHJhdyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHJlc29sdmVNZXJnZWRPcHRpb25zKGluc3RhbmNlKSB7CiAgICBjb25zdCBiYXNlID0gaW5zdGFuY2UudHlwZTsKICAgIGNvbnN0IHsgbWl4aW5zLCBleHRlbmRzOiBleHRlbmRzT3B0aW9ucyB9ID0gYmFzZTsKICAgIGNvbnN0IHsKICAgICAgbWl4aW5zOiBnbG9iYWxNaXhpbnMsCiAgICAgIG9wdGlvbnNDYWNoZTogY2FjaGUsCiAgICAgIGNvbmZpZzogeyBvcHRpb25NZXJnZVN0cmF0ZWdpZXMgfQogICAgfSA9IGluc3RhbmNlLmFwcENvbnRleHQ7CiAgICBjb25zdCBjYWNoZWQgPSBjYWNoZS5nZXQoYmFzZSk7CiAgICBsZXQgcmVzb2x2ZWQ7CiAgICBpZiAoY2FjaGVkKSB7CiAgICAgIHJlc29sdmVkID0gY2FjaGVkOwogICAgfSBlbHNlIGlmICghZ2xvYmFsTWl4aW5zLmxlbmd0aCAmJiAhbWl4aW5zICYmICFleHRlbmRzT3B0aW9ucykgewogICAgICB7CiAgICAgICAgcmVzb2x2ZWQgPSBiYXNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXNvbHZlZCA9IHt9OwogICAgICBpZiAoZ2xvYmFsTWl4aW5zLmxlbmd0aCkgewogICAgICAgIGdsb2JhbE1peGlucy5mb3JFYWNoKAogICAgICAgICAgKG0pID0+IG1lcmdlT3B0aW9ucyhyZXNvbHZlZCwgbSwgb3B0aW9uTWVyZ2VTdHJhdGVnaWVzLCB0cnVlKQogICAgICAgICk7CiAgICAgIH0KICAgICAgbWVyZ2VPcHRpb25zKHJlc29sdmVkLCBiYXNlLCBvcHRpb25NZXJnZVN0cmF0ZWdpZXMpOwogICAgfQogICAgaWYgKGlzT2JqZWN0KGJhc2UpKSB7CiAgICAgIGNhY2hlLnNldChiYXNlLCByZXNvbHZlZCk7CiAgICB9CiAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgfQogIGZ1bmN0aW9uIG1lcmdlT3B0aW9ucyh0bywgZnJvbSwgc3RyYXRzLCBhc01peGluID0gZmFsc2UpIHsKICAgIGNvbnN0IHsgbWl4aW5zLCBleHRlbmRzOiBleHRlbmRzT3B0aW9ucyB9ID0gZnJvbTsKICAgIGlmIChleHRlbmRzT3B0aW9ucykgewogICAgICBtZXJnZU9wdGlvbnModG8sIGV4dGVuZHNPcHRpb25zLCBzdHJhdHMsIHRydWUpOwogICAgfQogICAgaWYgKG1peGlucykgewogICAgICBtaXhpbnMuZm9yRWFjaCgKICAgICAgICAobSkgPT4gbWVyZ2VPcHRpb25zKHRvLCBtLCBzdHJhdHMsIHRydWUpCiAgICAgICk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBpbiBmcm9tKSB7CiAgICAgIGlmIChhc01peGluICYmIGtleSA9PT0gImV4cG9zZSIpIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBgImV4cG9zZSIgb3B0aW9uIGlzIGlnbm9yZWQgd2hlbiBkZWNsYXJlZCBpbiBtaXhpbnMgb3IgZXh0ZW5kcy4gSXQgc2hvdWxkIG9ubHkgYmUgZGVjbGFyZWQgaW4gdGhlIGJhc2UgY29tcG9uZW50IGl0c2VsZi5gCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzdHJhdCA9IGludGVybmFsT3B0aW9uTWVyZ2VTdHJhdHNba2V5XSB8fCBzdHJhdHMgJiYgc3RyYXRzW2tleV07CiAgICAgICAgdG9ba2V5XSA9IHN0cmF0ID8gc3RyYXQodG9ba2V5XSwgZnJvbVtrZXldKSA6IGZyb21ba2V5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRvOwogIH0KICBjb25zdCBpbnRlcm5hbE9wdGlvbk1lcmdlU3RyYXRzID0gewogICAgZGF0YTogbWVyZ2VEYXRhRm4sCiAgICBwcm9wczogbWVyZ2VFbWl0c09yUHJvcHNPcHRpb25zLAogICAgZW1pdHM6IG1lcmdlRW1pdHNPclByb3BzT3B0aW9ucywKICAgIC8vIG9iamVjdHMKICAgIG1ldGhvZHM6IG1lcmdlT2JqZWN0T3B0aW9ucywKICAgIGNvbXB1dGVkOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICAvLyBsaWZlY3ljbGUKICAgIGJlZm9yZUNyZWF0ZTogbWVyZ2VBc0FycmF5JDEsCiAgICBjcmVhdGVkOiBtZXJnZUFzQXJyYXkkMSwKICAgIGJlZm9yZU1vdW50OiBtZXJnZUFzQXJyYXkkMSwKICAgIG1vdW50ZWQ6IG1lcmdlQXNBcnJheSQxLAogICAgYmVmb3JlVXBkYXRlOiBtZXJnZUFzQXJyYXkkMSwKICAgIHVwZGF0ZWQ6IG1lcmdlQXNBcnJheSQxLAogICAgYmVmb3JlRGVzdHJveTogbWVyZ2VBc0FycmF5JDEsCiAgICBiZWZvcmVVbm1vdW50OiBtZXJnZUFzQXJyYXkkMSwKICAgIGRlc3Ryb3llZDogbWVyZ2VBc0FycmF5JDEsCiAgICB1bm1vdW50ZWQ6IG1lcmdlQXNBcnJheSQxLAogICAgYWN0aXZhdGVkOiBtZXJnZUFzQXJyYXkkMSwKICAgIGRlYWN0aXZhdGVkOiBtZXJnZUFzQXJyYXkkMSwKICAgIGVycm9yQ2FwdHVyZWQ6IG1lcmdlQXNBcnJheSQxLAogICAgc2VydmVyUHJlZmV0Y2g6IG1lcmdlQXNBcnJheSQxLAogICAgLy8gYXNzZXRzCiAgICBjb21wb25lbnRzOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICBkaXJlY3RpdmVzOiBtZXJnZU9iamVjdE9wdGlvbnMsCiAgICAvLyB3YXRjaAogICAgd2F0Y2g6IG1lcmdlV2F0Y2hPcHRpb25zLAogICAgLy8gcHJvdmlkZSAvIGluamVjdAogICAgcHJvdmlkZTogbWVyZ2VEYXRhRm4sCiAgICBpbmplY3Q6IG1lcmdlSW5qZWN0CiAgfTsKICBmdW5jdGlvbiBtZXJnZURhdGFGbih0bywgZnJvbSkgewogICAgaWYgKCFmcm9tKSB7CiAgICAgIHJldHVybiB0bzsKICAgIH0KICAgIGlmICghdG8pIHsKICAgICAgcmV0dXJuIGZyb207CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkRGF0YUZuKCkgewogICAgICByZXR1cm4gKGV4dGVuZCkoCiAgICAgICAgaXNGdW5jdGlvbih0bykgPyB0by5jYWxsKHRoaXMsIHRoaXMpIDogdG8sCiAgICAgICAgaXNGdW5jdGlvbihmcm9tKSA/IGZyb20uY2FsbCh0aGlzLCB0aGlzKSA6IGZyb20KICAgICAgKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG1lcmdlSW5qZWN0KHRvLCBmcm9tKSB7CiAgICByZXR1cm4gbWVyZ2VPYmplY3RPcHRpb25zKG5vcm1hbGl6ZUluamVjdCh0byksIG5vcm1hbGl6ZUluamVjdChmcm9tKSk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUluamVjdChyYXcpIHsKICAgIGlmIChpc0FycmF5KHJhdykpIHsKICAgICAgY29uc3QgcmVzID0ge307CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmVzW3Jhd1tpXV0gPSByYXdbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0KICAgIHJldHVybiByYXc7CiAgfQogIGZ1bmN0aW9uIG1lcmdlQXNBcnJheSQxKHRvLCBmcm9tKSB7CiAgICByZXR1cm4gdG8gPyBbLi4ubmV3IFNldChbXS5jb25jYXQodG8sIGZyb20pKV0gOiBmcm9tOwogIH0KICBmdW5jdGlvbiBtZXJnZU9iamVjdE9wdGlvbnModG8sIGZyb20pIHsKICAgIHJldHVybiB0byA/IGV4dGVuZCgvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwgdG8sIGZyb20pIDogZnJvbTsKICB9CiAgZnVuY3Rpb24gbWVyZ2VFbWl0c09yUHJvcHNPcHRpb25zKHRvLCBmcm9tKSB7CiAgICBpZiAodG8pIHsKICAgICAgaWYgKGlzQXJyYXkodG8pICYmIGlzQXJyYXkoZnJvbSkpIHsKICAgICAgICByZXR1cm4gWy4uLi8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsuLi50bywgLi4uZnJvbV0pXTsKICAgICAgfQogICAgICByZXR1cm4gZXh0ZW5kKAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgICAgIG5vcm1hbGl6ZVByb3BzT3JFbWl0cyh0byksCiAgICAgICAgbm9ybWFsaXplUHJvcHNPckVtaXRzKGZyb20gIT0gbnVsbCA/IGZyb20gOiB7fSkKICAgICAgKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmcm9tOwogICAgfQogIH0KICBmdW5jdGlvbiBtZXJnZVdhdGNoT3B0aW9ucyh0bywgZnJvbSkgewogICAgaWYgKCF0bykKICAgICAgcmV0dXJuIGZyb207CiAgICBpZiAoIWZyb20pCiAgICAgIHJldHVybiB0bzsKICAgIGNvbnN0IG1lcmdlZCA9IGV4dGVuZCgvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwgdG8pOwogICAgZm9yIChjb25zdCBrZXkgaW4gZnJvbSkgewogICAgICBtZXJnZWRba2V5XSA9IG1lcmdlQXNBcnJheSQxKHRvW2tleV0sIGZyb21ba2V5XSk7CiAgICB9CiAgICByZXR1cm4gbWVyZ2VkOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlQXBwQ29udGV4dCgpIHsKICAgIHJldHVybiB7CiAgICAgIGFwcDogbnVsbCwKICAgICAgY29uZmlnOiB7CiAgICAgICAgaXNOYXRpdmVUYWc6IE5PLAogICAgICAgIHBlcmZvcm1hbmNlOiBmYWxzZSwKICAgICAgICBnbG9iYWxQcm9wZXJ0aWVzOiB7fSwKICAgICAgICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IHt9LAogICAgICAgIGVycm9ySGFuZGxlcjogdm9pZCAwLAogICAgICAgIHdhcm5IYW5kbGVyOiB2b2lkIDAsCiAgICAgICAgY29tcGlsZXJPcHRpb25zOiB7fQogICAgICB9LAogICAgICBtaXhpbnM6IFtdLAogICAgICBjb21wb25lbnRzOiB7fSwKICAgICAgZGlyZWN0aXZlczoge30sCiAgICAgIHByb3ZpZGVzOiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmNyZWF0ZShudWxsKSwKICAgICAgb3B0aW9uc0NhY2hlOiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwKICAgICAgcHJvcHNDYWNoZTogLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCksCiAgICAgIGVtaXRzQ2FjaGU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpCiAgICB9OwogIH0KICBsZXQgdWlkJDEgPSAwOwogIGZ1bmN0aW9uIGNyZWF0ZUFwcEFQSShyZW5kZXIsIGh5ZHJhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiBjcmVhdGVBcHAocm9vdENvbXBvbmVudCwgcm9vdFByb3BzID0gbnVsbCkgewogICAgICBpZiAoIWlzRnVuY3Rpb24ocm9vdENvbXBvbmVudCkpIHsKICAgICAgICByb290Q29tcG9uZW50ID0gZXh0ZW5kKHt9LCByb290Q29tcG9uZW50KTsKICAgICAgfQogICAgICBpZiAocm9vdFByb3BzICE9IG51bGwgJiYgIWlzT2JqZWN0KHJvb3RQcm9wcykpIHsKICAgICAgICB3YXJuJDEoYHJvb3QgcHJvcHMgcGFzc2VkIHRvIGFwcC5tb3VudCgpIG11c3QgYmUgYW4gb2JqZWN0LmApOwogICAgICAgIHJvb3RQcm9wcyA9IG51bGw7CiAgICAgIH0KICAgICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZUFwcENvbnRleHQoKTsKICAgICAgY29uc3QgaW5zdGFsbGVkUGx1Z2lucyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha1NldCgpOwogICAgICBsZXQgaXNNb3VudGVkID0gZmFsc2U7CiAgICAgIGNvbnN0IGFwcCA9IGNvbnRleHQuYXBwID0gewogICAgICAgIF91aWQ6IHVpZCQxKyssCiAgICAgICAgX2NvbXBvbmVudDogcm9vdENvbXBvbmVudCwKICAgICAgICBfcHJvcHM6IHJvb3RQcm9wcywKICAgICAgICBfY29udGFpbmVyOiBudWxsLAogICAgICAgIF9jb250ZXh0OiBjb250ZXh0LAogICAgICAgIF9pbnN0YW5jZTogbnVsbCwKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGdldCBjb25maWcoKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5jb25maWc7CiAgICAgICAgfSwKICAgICAgICBzZXQgY29uZmlnKHYpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBhcHAuY29uZmlnIGNhbm5vdCBiZSByZXBsYWNlZC4gTW9kaWZ5IGluZGl2aWR1YWwgb3B0aW9ucyBpbnN0ZWFkLmAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVzZShwbHVnaW4sIC4uLm9wdGlvbnMpIHsKICAgICAgICAgIGlmIChpbnN0YWxsZWRQbHVnaW5zLmhhcyhwbHVnaW4pKSB7CiAgICAgICAgICAgIHdhcm4kMShgUGx1Z2luIGhhcyBhbHJlYWR5IGJlZW4gYXBwbGllZCB0byB0YXJnZXQgYXBwLmApOwogICAgICAgICAgfSBlbHNlIGlmIChwbHVnaW4gJiYgaXNGdW5jdGlvbihwbHVnaW4uaW5zdGFsbCkpIHsKICAgICAgICAgICAgaW5zdGFsbGVkUGx1Z2lucy5hZGQocGx1Z2luKTsKICAgICAgICAgICAgcGx1Z2luLmluc3RhbGwoYXBwLCAuLi5vcHRpb25zKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNGdW5jdGlvbihwbHVnaW4pKSB7CiAgICAgICAgICAgIGluc3RhbGxlZFBsdWdpbnMuYWRkKHBsdWdpbik7CiAgICAgICAgICAgIHBsdWdpbihhcHAsIC4uLm9wdGlvbnMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBBIHBsdWdpbiBtdXN0IGVpdGhlciBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdCB3aXRoIGFuICJpbnN0YWxsIiBmdW5jdGlvbi5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYXBwOwogICAgICAgIH0sCiAgICAgICAgbWl4aW4obWl4aW4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFjb250ZXh0Lm1peGlucy5pbmNsdWRlcyhtaXhpbikpIHsKICAgICAgICAgICAgICBjb250ZXh0Lm1peGlucy5wdXNoKG1peGluKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgICAiTWl4aW4gaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkIHRvIHRhcmdldCBhcHAiICsgKG1peGluLm5hbWUgPyBgOiAke21peGluLm5hbWV9YCA6ICIiKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhcHA7CiAgICAgICAgfSwKICAgICAgICBjb21wb25lbnQobmFtZSwgY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lLCBjb250ZXh0LmNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gY29udGV4dC5jb21wb25lbnRzW25hbWVdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRleHQuY29tcG9uZW50c1tuYW1lXSkgewogICAgICAgICAgICB3YXJuJDEoYENvbXBvbmVudCAiJHtuYW1lfSIgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGluIHRhcmdldCBhcHAuYCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0LmNvbXBvbmVudHNbbmFtZV0gPSBjb21wb25lbnQ7CiAgICAgICAgICByZXR1cm4gYXBwOwogICAgICAgIH0sCiAgICAgICAgZGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZURpcmVjdGl2ZU5hbWUobmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWRpcmVjdGl2ZSkgewogICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXJlY3RpdmVzW25hbWVdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRleHQuZGlyZWN0aXZlc1tuYW1lXSkgewogICAgICAgICAgICB3YXJuJDEoYERpcmVjdGl2ZSAiJHtuYW1lfSIgaGFzIGFscmVhZHkgYmVlbiByZWdpc3RlcmVkIGluIHRhcmdldCBhcHAuYCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0LmRpcmVjdGl2ZXNbbmFtZV0gPSBkaXJlY3RpdmU7CiAgICAgICAgICByZXR1cm4gYXBwOwogICAgICAgIH0sCiAgICAgICAgbW91bnQocm9vdENvbnRhaW5lciwgaXNIeWRyYXRlLCBuYW1lc3BhY2UpIHsKICAgICAgICAgIGlmICghaXNNb3VudGVkKSB7CiAgICAgICAgICAgIGlmIChyb290Q29udGFpbmVyLl9fdnVlX2FwcF9fKSB7CiAgICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgICAgYFRoZXJlIGlzIGFscmVhZHkgYW4gYXBwIGluc3RhbmNlIG1vdW50ZWQgb24gdGhlIGhvc3QgY29udGFpbmVyLgogSWYgeW91IHdhbnQgdG8gbW91bnQgYW5vdGhlciBhcHAgb24gdGhlIHNhbWUgaG9zdCBjb250YWluZXIsIHlvdSBuZWVkIHRvIHVubW91bnQgdGhlIHByZXZpb3VzIGFwcCBieSBjYWxsaW5nIFxgYXBwLnVubW91bnQoKVxgIGZpcnN0LmAKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUocm9vdENvbXBvbmVudCwgcm9vdFByb3BzKTsKICAgICAgICAgICAgdm5vZGUuYXBwQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICAgIGlmIChuYW1lc3BhY2UgPT09IHRydWUpIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSAic3ZnIjsKICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lc3BhY2UgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlID0gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZXh0LnJlbG9hZCA9ICgpID0+IHsKICAgICAgICAgICAgICAgIHJlbmRlcigKICAgICAgICAgICAgICAgICAgY2xvbmVWTm9kZSh2bm9kZSksCiAgICAgICAgICAgICAgICAgIHJvb3RDb250YWluZXIsCiAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGUgJiYgaHlkcmF0ZSkgewogICAgICAgICAgICAgIGh5ZHJhdGUodm5vZGUsIHJvb3RDb250YWluZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlbmRlcih2bm9kZSwgcm9vdENvbnRhaW5lciwgbmFtZXNwYWNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc01vdW50ZWQgPSB0cnVlOwogICAgICAgICAgICBhcHAuX2NvbnRhaW5lciA9IHJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHJvb3RDb250YWluZXIuX192dWVfYXBwX18gPSBhcHA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhcHAuX2luc3RhbmNlID0gdm5vZGUuY29tcG9uZW50OwogICAgICAgICAgICAgIGRldnRvb2xzSW5pdEFwcChhcHAsIHZlcnNpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRFeHBvc2VQcm94eSh2bm9kZS5jb21wb25lbnQpIHx8IHZub2RlLmNvbXBvbmVudC5wcm94eTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgICBgQXBwIGhhcyBhbHJlYWR5IGJlZW4gbW91bnRlZC4KSWYgeW91IHdhbnQgdG8gcmVtb3VudCB0aGUgc2FtZSBhcHAsIG1vdmUgeW91ciBhcHAgY3JlYXRpb24gbG9naWMgaW50byBhIGZhY3RvcnkgZnVuY3Rpb24gYW5kIGNyZWF0ZSBmcmVzaCBhcHAgaW5zdGFuY2VzIGZvciBlYWNoIG1vdW50IC0gZS5nLiBcYGNvbnN0IGNyZWF0ZU15QXBwID0gKCkgPT4gY3JlYXRlQXBwKEFwcClcYGAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVubW91bnQoKSB7CiAgICAgICAgICBpZiAoaXNNb3VudGVkKSB7CiAgICAgICAgICAgIHJlbmRlcihudWxsLCBhcHAuX2NvbnRhaW5lcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBhcHAuX2luc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICBkZXZ0b29sc1VubW91bnRBcHAoYXBwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUgYXBwLl9jb250YWluZXIuX192dWVfYXBwX187CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YXJuJDEoYENhbm5vdCB1bm1vdW50IGFuIGFwcCB0aGF0IGlzIG5vdCBtb3VudGVkLmApOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvdmlkZShrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAoa2V5IGluIGNvbnRleHQucHJvdmlkZXMpIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBBcHAgYWxyZWFkeSBwcm92aWRlcyBwcm9wZXJ0eSB3aXRoIGtleSAiJHtTdHJpbmcoa2V5KX0iLiBJdCB3aWxsIGJlIG92ZXJ3cml0dGVuIHdpdGggdGhlIG5ldyB2YWx1ZS5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0LnByb3ZpZGVzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiBhcHA7CiAgICAgICAgfSwKICAgICAgICBydW5XaXRoQ29udGV4dChmbikgewogICAgICAgICAgY29uc3QgbGFzdEFwcCA9IGN1cnJlbnRBcHA7CiAgICAgICAgICBjdXJyZW50QXBwID0gYXBwOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50QXBwID0gbGFzdEFwcDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBhcHA7CiAgICB9OwogIH0KICBsZXQgY3VycmVudEFwcCA9IG51bGw7CgogIGZ1bmN0aW9uIHByb3ZpZGUoa2V5LCB2YWx1ZSkgewogICAgaWYgKCFjdXJyZW50SW5zdGFuY2UpIHsKICAgICAgewogICAgICAgIHdhcm4kMShgcHJvdmlkZSgpIGNhbiBvbmx5IGJlIHVzZWQgaW5zaWRlIHNldHVwKCkuYCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGxldCBwcm92aWRlcyA9IGN1cnJlbnRJbnN0YW5jZS5wcm92aWRlczsKICAgICAgY29uc3QgcGFyZW50UHJvdmlkZXMgPSBjdXJyZW50SW5zdGFuY2UucGFyZW50ICYmIGN1cnJlbnRJbnN0YW5jZS5wYXJlbnQucHJvdmlkZXM7CiAgICAgIGlmIChwYXJlbnRQcm92aWRlcyA9PT0gcHJvdmlkZXMpIHsKICAgICAgICBwcm92aWRlcyA9IGN1cnJlbnRJbnN0YW5jZS5wcm92aWRlcyA9IE9iamVjdC5jcmVhdGUocGFyZW50UHJvdmlkZXMpOwogICAgICB9CiAgICAgIHByb3ZpZGVzW2tleV0gPSB2YWx1ZTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaW5qZWN0KGtleSwgZGVmYXVsdFZhbHVlLCB0cmVhdERlZmF1bHRBc0ZhY3RvcnkgPSBmYWxzZSkgewogICAgY29uc3QgaW5zdGFuY2UgPSBjdXJyZW50SW5zdGFuY2UgfHwgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlOwogICAgaWYgKGluc3RhbmNlIHx8IGN1cnJlbnRBcHApIHsKICAgICAgY29uc3QgcHJvdmlkZXMgPSBpbnN0YW5jZSA/IGluc3RhbmNlLnBhcmVudCA9PSBudWxsID8gaW5zdGFuY2Uudm5vZGUuYXBwQ29udGV4dCAmJiBpbnN0YW5jZS52bm9kZS5hcHBDb250ZXh0LnByb3ZpZGVzIDogaW5zdGFuY2UucGFyZW50LnByb3ZpZGVzIDogY3VycmVudEFwcC5fY29udGV4dC5wcm92aWRlczsKICAgICAgaWYgKHByb3ZpZGVzICYmIGtleSBpbiBwcm92aWRlcykgewogICAgICAgIHJldHVybiBwcm92aWRlc1trZXldOwogICAgICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgcmV0dXJuIHRyZWF0RGVmYXVsdEFzRmFjdG9yeSAmJiBpc0Z1bmN0aW9uKGRlZmF1bHRWYWx1ZSkgPyBkZWZhdWx0VmFsdWUuY2FsbChpbnN0YW5jZSAmJiBpbnN0YW5jZS5wcm94eSkgOiBkZWZhdWx0VmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybiQxKGBpbmplY3Rpb24gIiR7U3RyaW5nKGtleSl9IiBub3QgZm91bmQuYCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdhcm4kMShgaW5qZWN0KCkgY2FuIG9ubHkgYmUgdXNlZCBpbnNpZGUgc2V0dXAoKSBvciBmdW5jdGlvbmFsIGNvbXBvbmVudHMuYCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGhhc0luamVjdGlvbkNvbnRleHQoKSB7CiAgICByZXR1cm4gISEoY3VycmVudEluc3RhbmNlIHx8IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSB8fCBjdXJyZW50QXBwKTsKICB9CgogIGZ1bmN0aW9uIGluaXRQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIGlzU3RhdGVmdWwsIGlzU1NSID0gZmFsc2UpIHsKICAgIGNvbnN0IHByb3BzID0ge307CiAgICBjb25zdCBhdHRycyA9IHt9OwogICAgZGVmKGF0dHJzLCBJbnRlcm5hbE9iamVjdEtleSwgMSk7CiAgICBpbnN0YW5jZS5wcm9wc0RlZmF1bHRzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBzZXRGdWxsUHJvcHMoaW5zdGFuY2UsIHJhd1Byb3BzLCBwcm9wcywgYXR0cnMpOwogICAgZm9yIChjb25zdCBrZXkgaW4gaW5zdGFuY2UucHJvcHNPcHRpb25zWzBdKSB7CiAgICAgIGlmICghKGtleSBpbiBwcm9wcykpIHsKICAgICAgICBwcm9wc1trZXldID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICB7CiAgICAgIHZhbGlkYXRlUHJvcHMocmF3UHJvcHMgfHwge30sIHByb3BzLCBpbnN0YW5jZSk7CiAgICB9CiAgICBpZiAoaXNTdGF0ZWZ1bCkgewogICAgICBpbnN0YW5jZS5wcm9wcyA9IGlzU1NSID8gcHJvcHMgOiBzaGFsbG93UmVhY3RpdmUocHJvcHMpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKCFpbnN0YW5jZS50eXBlLnByb3BzKSB7CiAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBhdHRyczsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IHByb3BzOwogICAgICB9CiAgICB9CiAgICBpbnN0YW5jZS5hdHRycyA9IGF0dHJzOwogIH0KICBmdW5jdGlvbiBpc0luSG1yQ29udGV4dChpbnN0YW5jZSkgewogICAgd2hpbGUgKGluc3RhbmNlKSB7CiAgICAgIGlmIChpbnN0YW5jZS50eXBlLl9faG1ySWQpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucGFyZW50OwogICAgfQogIH0KICBmdW5jdGlvbiB1cGRhdGVQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIHJhd1ByZXZQcm9wcywgb3B0aW1pemVkKSB7CiAgICBjb25zdCB7CiAgICAgIHByb3BzLAogICAgICBhdHRycywKICAgICAgdm5vZGU6IHsgcGF0Y2hGbGFnIH0KICAgIH0gPSBpbnN0YW5jZTsKICAgIGNvbnN0IHJhd0N1cnJlbnRQcm9wcyA9IHRvUmF3KHByb3BzKTsKICAgIGNvbnN0IFtvcHRpb25zXSA9IGluc3RhbmNlLnByb3BzT3B0aW9uczsKICAgIGxldCBoYXNBdHRyc0NoYW5nZWQgPSBmYWxzZTsKICAgIGlmICgKICAgICAgLy8gYWx3YXlzIGZvcmNlIGZ1bGwgZGlmZiBpbiBkZXYKICAgICAgLy8gLSAjMTk0MiBpZiBobXIgaXMgZW5hYmxlZCB3aXRoIHNmYyBjb21wb25lbnQKICAgICAgLy8gLSB2aXRlIzg3MiBub24tc2ZjIGNvbXBvbmVudCB1c2VkIGJ5IHNmYyBjb21wb25lbnQKICAgICAgIWlzSW5IbXJDb250ZXh0KGluc3RhbmNlKSAmJiAob3B0aW1pemVkIHx8IHBhdGNoRmxhZyA+IDApICYmICEocGF0Y2hGbGFnICYgMTYpCiAgICApIHsKICAgICAgaWYgKHBhdGNoRmxhZyAmIDgpIHsKICAgICAgICBjb25zdCBwcm9wc1RvVXBkYXRlID0gaW5zdGFuY2Uudm5vZGUuZHluYW1pY1Byb3BzOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHNUb1VwZGF0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgbGV0IGtleSA9IHByb3BzVG9VcGRhdGVbaV07CiAgICAgICAgICBpZiAoaXNFbWl0TGlzdGVuZXIoaW5zdGFuY2UuZW1pdHNPcHRpb25zLCBrZXkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgdmFsdWUgPSByYXdQcm9wc1trZXldOwogICAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKGhhc093bihhdHRycywga2V5KSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gYXR0cnNba2V5XSkgewogICAgICAgICAgICAgICAgYXR0cnNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29uc3QgY2FtZWxpemVkS2V5ID0gY2FtZWxpemUoa2V5KTsKICAgICAgICAgICAgICBwcm9wc1tjYW1lbGl6ZWRLZXldID0gcmVzb2x2ZVByb3BWYWx1ZSgKICAgICAgICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICAgICAgICByYXdDdXJyZW50UHJvcHMsCiAgICAgICAgICAgICAgICBjYW1lbGl6ZWRLZXksCiAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodmFsdWUgIT09IGF0dHJzW2tleV0pIHsKICAgICAgICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgaGFzQXR0cnNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHNldEZ1bGxQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIHByb3BzLCBhdHRycykpIHsKICAgICAgICBoYXNBdHRyc0NoYW5nZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGxldCBrZWJhYktleTsKICAgICAgZm9yIChjb25zdCBrZXkgaW4gcmF3Q3VycmVudFByb3BzKSB7CiAgICAgICAgaWYgKCFyYXdQcm9wcyB8fCAvLyBmb3IgY2FtZWxDYXNlCiAgICAgICAgIWhhc093bihyYXdQcm9wcywga2V5KSAmJiAvLyBpdCdzIHBvc3NpYmxlIHRoZSBvcmlnaW5hbCBwcm9wcyB3YXMgcGFzc2VkIGluIGFzIGtlYmFiLWNhc2UKICAgICAgICAvLyBhbmQgY29udmVydGVkIHRvIGNhbWVsQ2FzZSAoIzk1NSkKICAgICAgICAoKGtlYmFiS2V5ID0gaHlwaGVuYXRlKGtleSkpID09PSBrZXkgfHwgIWhhc093bihyYXdQcm9wcywga2ViYWJLZXkpKSkgewogICAgICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAgICAgaWYgKHJhd1ByZXZQcm9wcyAmJiAvLyBmb3IgY2FtZWxDYXNlCiAgICAgICAgICAgIChyYXdQcmV2UHJvcHNba2V5XSAhPT0gdm9pZCAwIHx8IC8vIGZvciBrZWJhYi1jYXNlCiAgICAgICAgICAgIHJhd1ByZXZQcm9wc1trZWJhYktleV0gIT09IHZvaWQgMCkpIHsKICAgICAgICAgICAgICBwcm9wc1trZXldID0gcmVzb2x2ZVByb3BWYWx1ZSgKICAgICAgICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICAgICAgICByYXdDdXJyZW50UHJvcHMsCiAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWxldGUgcHJvcHNba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGF0dHJzICE9PSByYXdDdXJyZW50UHJvcHMpIHsKICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKCFyYXdQcm9wcyB8fCAhaGFzT3duKHJhd1Byb3BzLCBrZXkpICYmIHRydWUpIHsKICAgICAgICAgICAgZGVsZXRlIGF0dHJzW2tleV07CiAgICAgICAgICAgIGhhc0F0dHJzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAoaGFzQXR0cnNDaGFuZ2VkKSB7CiAgICAgIHRyaWdnZXIoaW5zdGFuY2UsICJzZXQiLCAiJGF0dHJzIik7CiAgICB9CiAgICB7CiAgICAgIHZhbGlkYXRlUHJvcHMocmF3UHJvcHMgfHwge30sIHByb3BzLCBpbnN0YW5jZSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHNldEZ1bGxQcm9wcyhpbnN0YW5jZSwgcmF3UHJvcHMsIHByb3BzLCBhdHRycykgewogICAgY29uc3QgW29wdGlvbnMsIG5lZWRDYXN0S2V5c10gPSBpbnN0YW5jZS5wcm9wc09wdGlvbnM7CiAgICBsZXQgaGFzQXR0cnNDaGFuZ2VkID0gZmFsc2U7CiAgICBsZXQgcmF3Q2FzdFZhbHVlczsKICAgIGlmIChyYXdQcm9wcykgewogICAgICBmb3IgKGxldCBrZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICBpZiAoaXNSZXNlcnZlZFByb3Aoa2V5KSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gcmF3UHJvcHNba2V5XTsKICAgICAgICBsZXQgY2FtZWxLZXk7CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgaGFzT3duKG9wdGlvbnMsIGNhbWVsS2V5ID0gY2FtZWxpemUoa2V5KSkpIHsKICAgICAgICAgIGlmICghbmVlZENhc3RLZXlzIHx8ICFuZWVkQ2FzdEtleXMuaW5jbHVkZXMoY2FtZWxLZXkpKSB7CiAgICAgICAgICAgIHByb3BzW2NhbWVsS2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgKHJhd0Nhc3RWYWx1ZXMgfHwgKHJhd0Nhc3RWYWx1ZXMgPSB7fSkpW2NhbWVsS2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIWlzRW1pdExpc3RlbmVyKGluc3RhbmNlLmVtaXRzT3B0aW9ucywga2V5KSkgewogICAgICAgICAgaWYgKCEoa2V5IGluIGF0dHJzKSB8fCB2YWx1ZSAhPT0gYXR0cnNba2V5XSkgewogICAgICAgICAgICBhdHRyc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgIGhhc0F0dHJzQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAobmVlZENhc3RLZXlzKSB7CiAgICAgIGNvbnN0IHJhd0N1cnJlbnRQcm9wcyA9IHRvUmF3KHByb3BzKTsKICAgICAgY29uc3QgY2FzdFZhbHVlcyA9IHJhd0Nhc3RWYWx1ZXMgfHwgRU1QVFlfT0JKOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5lZWRDYXN0S2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IG5lZWRDYXN0S2V5c1tpXTsKICAgICAgICBwcm9wc1trZXldID0gcmVzb2x2ZVByb3BWYWx1ZSgKICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICByYXdDdXJyZW50UHJvcHMsCiAgICAgICAgICBrZXksCiAgICAgICAgICBjYXN0VmFsdWVzW2tleV0sCiAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICFoYXNPd24oY2FzdFZhbHVlcywga2V5KQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBoYXNBdHRyc0NoYW5nZWQ7CiAgfQogIGZ1bmN0aW9uIHJlc29sdmVQcm9wVmFsdWUob3B0aW9ucywgcHJvcHMsIGtleSwgdmFsdWUsIGluc3RhbmNlLCBpc0Fic2VudCkgewogICAgY29uc3Qgb3B0ID0gb3B0aW9uc1trZXldOwogICAgaWYgKG9wdCAhPSBudWxsKSB7CiAgICAgIGNvbnN0IGhhc0RlZmF1bHQgPSBoYXNPd24ob3B0LCAiZGVmYXVsdCIpOwogICAgICBpZiAoaGFzRGVmYXVsdCAmJiB2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0gb3B0LmRlZmF1bHQ7CiAgICAgICAgaWYgKG9wdC50eXBlICE9PSBGdW5jdGlvbiAmJiAhb3B0LnNraXBGYWN0b3J5ICYmIGlzRnVuY3Rpb24oZGVmYXVsdFZhbHVlKSkgewogICAgICAgICAgY29uc3QgeyBwcm9wc0RlZmF1bHRzIH0gPSBpbnN0YW5jZTsKICAgICAgICAgIGlmIChrZXkgaW4gcHJvcHNEZWZhdWx0cykgewogICAgICAgICAgICB2YWx1ZSA9IHByb3BzRGVmYXVsdHNba2V5XTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHJlc2V0ID0gc2V0Q3VycmVudEluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgdmFsdWUgPSBwcm9wc0RlZmF1bHRzW2tleV0gPSBkZWZhdWx0VmFsdWUuY2FsbCgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIHByb3BzCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAob3B0WzAgLyogc2hvdWxkQ2FzdCAqL10pIHsKICAgICAgICBpZiAoaXNBYnNlbnQgJiYgIWhhc0RlZmF1bHQpIHsKICAgICAgICAgIHZhbHVlID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChvcHRbMSAvKiBzaG91bGRDYXN0VHJ1ZSAqL10gJiYgKHZhbHVlID09PSAiIiB8fCB2YWx1ZSA9PT0gaHlwaGVuYXRlKGtleSkpKSB7CiAgICAgICAgICB2YWx1ZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BzT3B0aW9ucyhjb21wLCBhcHBDb250ZXh0LCBhc01peGluID0gZmFsc2UpIHsKICAgIGNvbnN0IGNhY2hlID0gYXBwQ29udGV4dC5wcm9wc0NhY2hlOwogICAgY29uc3QgY2FjaGVkID0gY2FjaGUuZ2V0KGNvbXApOwogICAgaWYgKGNhY2hlZCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQogICAgY29uc3QgcmF3ID0gY29tcC5wcm9wczsKICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSB7fTsKICAgIGNvbnN0IG5lZWRDYXN0S2V5cyA9IFtdOwogICAgbGV0IGhhc0V4dGVuZHMgPSBmYWxzZTsKICAgIGlmICghaXNGdW5jdGlvbihjb21wKSkgewogICAgICBjb25zdCBleHRlbmRQcm9wcyA9IChyYXcyKSA9PiB7CiAgICAgICAgaGFzRXh0ZW5kcyA9IHRydWU7CiAgICAgICAgY29uc3QgW3Byb3BzLCBrZXlzXSA9IG5vcm1hbGl6ZVByb3BzT3B0aW9ucyhyYXcyLCBhcHBDb250ZXh0LCB0cnVlKTsKICAgICAgICBleHRlbmQobm9ybWFsaXplZCwgcHJvcHMpOwogICAgICAgIGlmIChrZXlzKQogICAgICAgICAgbmVlZENhc3RLZXlzLnB1c2goLi4ua2V5cyk7CiAgICAgIH07CiAgICAgIGlmICghYXNNaXhpbiAmJiBhcHBDb250ZXh0Lm1peGlucy5sZW5ndGgpIHsKICAgICAgICBhcHBDb250ZXh0Lm1peGlucy5mb3JFYWNoKGV4dGVuZFByb3BzKTsKICAgICAgfQogICAgICBpZiAoY29tcC5leHRlbmRzKSB7CiAgICAgICAgZXh0ZW5kUHJvcHMoY29tcC5leHRlbmRzKTsKICAgICAgfQogICAgICBpZiAoY29tcC5taXhpbnMpIHsKICAgICAgICBjb21wLm1peGlucy5mb3JFYWNoKGV4dGVuZFByb3BzKTsKICAgICAgfQogICAgfQogICAgaWYgKCFyYXcgJiYgIWhhc0V4dGVuZHMpIHsKICAgICAgaWYgKGlzT2JqZWN0KGNvbXApKSB7CiAgICAgICAgY2FjaGUuc2V0KGNvbXAsIEVNUFRZX0FSUik7CiAgICAgIH0KICAgICAgcmV0dXJuIEVNUFRZX0FSUjsKICAgIH0KICAgIGlmIChpc0FycmF5KHJhdykpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByYXcubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoIWlzU3RyaW5nKHJhd1tpXSkpIHsKICAgICAgICAgIHdhcm4kMShgcHJvcHMgbXVzdCBiZSBzdHJpbmdzIHdoZW4gdXNpbmcgYXJyYXkgc3ludGF4LmAsIHJhd1tpXSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRLZXkgPSBjYW1lbGl6ZShyYXdbaV0pOwogICAgICAgIGlmICh2YWxpZGF0ZVByb3BOYW1lKG5vcm1hbGl6ZWRLZXkpKSB7CiAgICAgICAgICBub3JtYWxpemVkW25vcm1hbGl6ZWRLZXldID0gRU1QVFlfT0JKOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChyYXcpIHsKICAgICAgaWYgKCFpc09iamVjdChyYXcpKSB7CiAgICAgICAgd2FybiQxKGBpbnZhbGlkIHByb3BzIG9wdGlvbnNgLCByYXcpOwogICAgICB9CiAgICAgIGZvciAoY29uc3Qga2V5IGluIHJhdykgewogICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRLZXkgPSBjYW1lbGl6ZShrZXkpOwogICAgICAgIGlmICh2YWxpZGF0ZVByb3BOYW1lKG5vcm1hbGl6ZWRLZXkpKSB7CiAgICAgICAgICBjb25zdCBvcHQgPSByYXdba2V5XTsKICAgICAgICAgIGNvbnN0IHByb3AgPSBub3JtYWxpemVkW25vcm1hbGl6ZWRLZXldID0gaXNBcnJheShvcHQpIHx8IGlzRnVuY3Rpb24ob3B0KSA/IHsgdHlwZTogb3B0IH0gOiBleHRlbmQoe30sIG9wdCk7CiAgICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBjb25zdCBib29sZWFuSW5kZXggPSBnZXRUeXBlSW5kZXgoQm9vbGVhbiwgcHJvcC50eXBlKTsKICAgICAgICAgICAgY29uc3Qgc3RyaW5nSW5kZXggPSBnZXRUeXBlSW5kZXgoU3RyaW5nLCBwcm9wLnR5cGUpOwogICAgICAgICAgICBwcm9wWzAgLyogc2hvdWxkQ2FzdCAqL10gPSBib29sZWFuSW5kZXggPiAtMTsKICAgICAgICAgICAgcHJvcFsxIC8qIHNob3VsZENhc3RUcnVlICovXSA9IHN0cmluZ0luZGV4IDwgMCB8fCBib29sZWFuSW5kZXggPCBzdHJpbmdJbmRleDsKICAgICAgICAgICAgaWYgKGJvb2xlYW5JbmRleCA+IC0xIHx8IGhhc093bihwcm9wLCAiZGVmYXVsdCIpKSB7CiAgICAgICAgICAgICAgbmVlZENhc3RLZXlzLnB1c2gobm9ybWFsaXplZEtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlcyA9IFtub3JtYWxpemVkLCBuZWVkQ2FzdEtleXNdOwogICAgaWYgKGlzT2JqZWN0KGNvbXApKSB7CiAgICAgIGNhY2hlLnNldChjb21wLCByZXMpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9CiAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wTmFtZShrZXkpIHsKICAgIGlmIChrZXlbMF0gIT09ICIkIiAmJiAhaXNSZXNlcnZlZFByb3Aoa2V5KSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHdhcm4kMShgSW52YWxpZCBwcm9wIG5hbWU6ICIke2tleX0iIGlzIGEgcmVzZXJ2ZWQgcHJvcGVydHkuYCk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGdldFR5cGUoY3RvcikgewogICAgaWYgKGN0b3IgPT09IG51bGwpIHsKICAgICAgcmV0dXJuICJudWxsIjsKICAgIH0KICAgIGlmICh0eXBlb2YgY3RvciA9PT0gImZ1bmN0aW9uIikgewogICAgICByZXR1cm4gY3Rvci5uYW1lIHx8ICIiOwogICAgfSBlbHNlIGlmICh0eXBlb2YgY3RvciA9PT0gIm9iamVjdCIpIHsKICAgICAgY29uc3QgbmFtZSA9IGN0b3IuY29uc3RydWN0b3IgJiYgY3Rvci5jb25zdHJ1Y3Rvci5uYW1lOwogICAgICByZXR1cm4gbmFtZSB8fCAiIjsKICAgIH0KICAgIHJldHVybiAiIjsKICB9CiAgZnVuY3Rpb24gaXNTYW1lVHlwZShhLCBiKSB7CiAgICByZXR1cm4gZ2V0VHlwZShhKSA9PT0gZ2V0VHlwZShiKTsKICB9CiAgZnVuY3Rpb24gZ2V0VHlwZUluZGV4KHR5cGUsIGV4cGVjdGVkVHlwZXMpIHsKICAgIGlmIChpc0FycmF5KGV4cGVjdGVkVHlwZXMpKSB7CiAgICAgIHJldHVybiBleHBlY3RlZFR5cGVzLmZpbmRJbmRleCgodCkgPT4gaXNTYW1lVHlwZSh0LCB0eXBlKSk7CiAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oZXhwZWN0ZWRUeXBlcykpIHsKICAgICAgcmV0dXJuIGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlcywgdHlwZSkgPyAwIDogLTE7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQogIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMocmF3UHJvcHMsIHByb3BzLCBpbnN0YW5jZSkgewogICAgY29uc3QgcmVzb2x2ZWRWYWx1ZXMgPSB0b1Jhdyhwcm9wcyk7CiAgICBjb25zdCBvcHRpb25zID0gaW5zdGFuY2UucHJvcHNPcHRpb25zWzBdOwogICAgZm9yIChjb25zdCBrZXkgaW4gb3B0aW9ucykgewogICAgICBsZXQgb3B0ID0gb3B0aW9uc1trZXldOwogICAgICBpZiAob3B0ID09IG51bGwpCiAgICAgICAgY29udGludWU7CiAgICAgIHZhbGlkYXRlUHJvcCgKICAgICAgICBrZXksCiAgICAgICAgcmVzb2x2ZWRWYWx1ZXNba2V5XSwKICAgICAgICBvcHQsCiAgICAgICAgc2hhbGxvd1JlYWRvbmx5KHJlc29sdmVkVmFsdWVzKSAsCiAgICAgICAgIWhhc093bihyYXdQcm9wcywga2V5KSAmJiAhaGFzT3duKHJhd1Byb3BzLCBoeXBoZW5hdGUoa2V5KSkKICAgICAgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wKG5hbWUsIHZhbHVlLCBwcm9wLCBwcm9wcywgaXNBYnNlbnQpIHsKICAgIGNvbnN0IHsgdHlwZSwgcmVxdWlyZWQsIHZhbGlkYXRvciwgc2tpcENoZWNrIH0gPSBwcm9wOwogICAgaWYgKHJlcXVpcmVkICYmIGlzQWJzZW50KSB7CiAgICAgIHdhcm4kMSgnTWlzc2luZyByZXF1aXJlZCBwcm9wOiAiJyArIG5hbWUgKyAnIicpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodmFsdWUgPT0gbnVsbCAmJiAhcmVxdWlyZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGUgIT0gbnVsbCAmJiB0eXBlICE9PSB0cnVlICYmICFza2lwQ2hlY2spIHsKICAgICAgbGV0IGlzVmFsaWQgPSBmYWxzZTsKICAgICAgY29uc3QgdHlwZXMgPSBpc0FycmF5KHR5cGUpID8gdHlwZSA6IFt0eXBlXTsKICAgICAgY29uc3QgZXhwZWN0ZWRUeXBlcyA9IFtdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHR5cGVzLmxlbmd0aCAmJiAhaXNWYWxpZDsgaSsrKSB7CiAgICAgICAgY29uc3QgeyB2YWxpZCwgZXhwZWN0ZWRUeXBlIH0gPSBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlc1tpXSk7CiAgICAgICAgZXhwZWN0ZWRUeXBlcy5wdXNoKGV4cGVjdGVkVHlwZSB8fCAiIik7CiAgICAgICAgaXNWYWxpZCA9IHZhbGlkOwogICAgICB9CiAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgIHdhcm4kMShnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh2YWxpZGF0b3IgJiYgIXZhbGlkYXRvcih2YWx1ZSwgcHJvcHMpKSB7CiAgICAgIHdhcm4kMSgnSW52YWxpZCBwcm9wOiBjdXN0b20gdmFsaWRhdG9yIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCAiJyArIG5hbWUgKyAnIi4nKTsKICAgIH0KICB9CiAgY29uc3QgaXNTaW1wbGVUeXBlID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoCiAgICAiU3RyaW5nLE51bWJlcixCb29sZWFuLEZ1bmN0aW9uLFN5bWJvbCxCaWdJbnQiCiAgKTsKICBmdW5jdGlvbiBhc3NlcnRUeXBlKHZhbHVlLCB0eXBlKSB7CiAgICBsZXQgdmFsaWQ7CiAgICBjb25zdCBleHBlY3RlZFR5cGUgPSBnZXRUeXBlKHR5cGUpOwogICAgaWYgKGlzU2ltcGxlVHlwZShleHBlY3RlZFR5cGUpKSB7CiAgICAgIGNvbnN0IHQgPSB0eXBlb2YgdmFsdWU7CiAgICAgIHZhbGlkID0gdCA9PT0gZXhwZWN0ZWRUeXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmICghdmFsaWQgJiYgdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICJPYmplY3QiKSB7CiAgICAgIHZhbGlkID0gaXNPYmplY3QodmFsdWUpOwogICAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICJBcnJheSIpIHsKICAgICAgdmFsaWQgPSBpc0FycmF5KHZhbHVlKTsKICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAibnVsbCIpIHsKICAgICAgdmFsaWQgPSB2YWx1ZSA9PT0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhbGlkID0gdmFsdWUgaW5zdGFuY2VvZiB0eXBlOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgdmFsaWQsCiAgICAgIGV4cGVjdGVkVHlwZQogICAgfTsKICB9CiAgZnVuY3Rpb24gZ2V0SW52YWxpZFR5cGVNZXNzYWdlKG5hbWUsIHZhbHVlLCBleHBlY3RlZFR5cGVzKSB7CiAgICBpZiAoZXhwZWN0ZWRUeXBlcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIGBQcm9wIHR5cGUgW10gZm9yIHByb3AgIiR7bmFtZX0iIHdvbid0IG1hdGNoIGFueXRoaW5nLiBEaWQgeW91IG1lYW4gdG8gdXNlIHR5cGUgQXJyYXkgaW5zdGVhZD9gOwogICAgfQogICAgbGV0IG1lc3NhZ2UgPSBgSW52YWxpZCBwcm9wOiB0eXBlIGNoZWNrIGZhaWxlZCBmb3IgcHJvcCAiJHtuYW1lfSIuIEV4cGVjdGVkICR7ZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbigiIHwgIil9YDsKICAgIGNvbnN0IGV4cGVjdGVkVHlwZSA9IGV4cGVjdGVkVHlwZXNbMF07CiAgICBjb25zdCByZWNlaXZlZFR5cGUgPSB0b1Jhd1R5cGUodmFsdWUpOwogICAgY29uc3QgZXhwZWN0ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgICBjb25zdCByZWNlaXZlZFZhbHVlID0gc3R5bGVWYWx1ZSh2YWx1ZSwgcmVjZWl2ZWRUeXBlKTsKICAgIGlmIChleHBlY3RlZFR5cGVzLmxlbmd0aCA9PT0gMSAmJiBpc0V4cGxpY2FibGUoZXhwZWN0ZWRUeXBlKSAmJiAhaXNCb29sZWFuKGV4cGVjdGVkVHlwZSwgcmVjZWl2ZWRUeXBlKSkgewogICAgICBtZXNzYWdlICs9IGAgd2l0aCB2YWx1ZSAke2V4cGVjdGVkVmFsdWV9YDsKICAgIH0KICAgIG1lc3NhZ2UgKz0gYCwgZ290ICR7cmVjZWl2ZWRUeXBlfSBgOwogICAgaWYgKGlzRXhwbGljYWJsZShyZWNlaXZlZFR5cGUpKSB7CiAgICAgIG1lc3NhZ2UgKz0gYHdpdGggdmFsdWUgJHtyZWNlaXZlZFZhbHVlfS5gOwogICAgfQogICAgcmV0dXJuIG1lc3NhZ2U7CiAgfQogIGZ1bmN0aW9uIHN0eWxlVmFsdWUodmFsdWUsIHR5cGUpIHsKICAgIGlmICh0eXBlID09PSAiU3RyaW5nIikgewogICAgICByZXR1cm4gYCIke3ZhbHVlfSJgOwogICAgfSBlbHNlIGlmICh0eXBlID09PSAiTnVtYmVyIikgewogICAgICByZXR1cm4gYCR7TnVtYmVyKHZhbHVlKX1gOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGAke3ZhbHVlfWA7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzRXhwbGljYWJsZSh0eXBlKSB7CiAgICBjb25zdCBleHBsaWNpdFR5cGVzID0gWyJzdHJpbmciLCAibnVtYmVyIiwgImJvb2xlYW4iXTsKICAgIHJldHVybiBleHBsaWNpdFR5cGVzLnNvbWUoKGVsZW0pID0+IHR5cGUudG9Mb3dlckNhc2UoKSA9PT0gZWxlbSk7CiAgfQogIGZ1bmN0aW9uIGlzQm9vbGVhbiguLi5hcmdzKSB7CiAgICByZXR1cm4gYXJncy5zb21lKChlbGVtKSA9PiBlbGVtLnRvTG93ZXJDYXNlKCkgPT09ICJib29sZWFuIik7CiAgfQoKICBjb25zdCBpc0ludGVybmFsS2V5ID0gKGtleSkgPT4ga2V5WzBdID09PSAiXyIgfHwga2V5ID09PSAiJHN0YWJsZSI7CiAgY29uc3Qgbm9ybWFsaXplU2xvdFZhbHVlID0gKHZhbHVlKSA9PiBpc0FycmF5KHZhbHVlKSA/IHZhbHVlLm1hcChub3JtYWxpemVWTm9kZSkgOiBbbm9ybWFsaXplVk5vZGUodmFsdWUpXTsKICBjb25zdCBub3JtYWxpemVTbG90ID0gKGtleSwgcmF3U2xvdCwgY3R4KSA9PiB7CiAgICBpZiAocmF3U2xvdC5fbikgewogICAgICByZXR1cm4gcmF3U2xvdDsKICAgIH0KICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSB3aXRoQ3R4KCguLi5hcmdzKSA9PiB7CiAgICAgIGlmIChjdXJyZW50SW5zdGFuY2UgJiYgKCFjdHggfHwgY3R4LnJvb3QgPT09IGN1cnJlbnRJbnN0YW5jZS5yb290KSkgewogICAgICAgIHdhcm4kMSgKICAgICAgICAgIGBTbG90ICIke2tleX0iIGludm9rZWQgb3V0c2lkZSBvZiB0aGUgcmVuZGVyIGZ1bmN0aW9uOiB0aGlzIHdpbGwgbm90IHRyYWNrIGRlcGVuZGVuY2llcyB1c2VkIGluIHRoZSBzbG90LiBJbnZva2UgdGhlIHNsb3QgZnVuY3Rpb24gaW5zaWRlIHRoZSByZW5kZXIgZnVuY3Rpb24gaW5zdGVhZC5gCiAgICAgICAgKTsKICAgICAgfQogICAgICByZXR1cm4gbm9ybWFsaXplU2xvdFZhbHVlKHJhd1Nsb3QoLi4uYXJncykpOwogICAgfSwgY3R4KTsKICAgIG5vcm1hbGl6ZWQuX2MgPSBmYWxzZTsKICAgIHJldHVybiBub3JtYWxpemVkOwogIH07CiAgY29uc3Qgbm9ybWFsaXplT2JqZWN0U2xvdHMgPSAocmF3U2xvdHMsIHNsb3RzLCBpbnN0YW5jZSkgPT4gewogICAgY29uc3QgY3R4ID0gcmF3U2xvdHMuX2N0eDsKICAgIGZvciAoY29uc3Qga2V5IGluIHJhd1Nsb3RzKSB7CiAgICAgIGlmIChpc0ludGVybmFsS2V5KGtleSkpCiAgICAgICAgY29udGludWU7CiAgICAgIGNvbnN0IHZhbHVlID0gcmF3U2xvdHNba2V5XTsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgc2xvdHNba2V5XSA9IG5vcm1hbGl6ZVNsb3Qoa2V5LCB2YWx1ZSwgY3R4KTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgewogICAgICAgICAgd2FybiQxKAogICAgICAgICAgICBgTm9uLWZ1bmN0aW9uIHZhbHVlIGVuY291bnRlcmVkIGZvciBzbG90ICIke2tleX0iLiBQcmVmZXIgZnVuY3Rpb24gc2xvdHMgZm9yIGJldHRlciBwZXJmb3JtYW5jZS5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBjb25zdCBub3JtYWxpemVkID0gbm9ybWFsaXplU2xvdFZhbHVlKHZhbHVlKTsKICAgICAgICBzbG90c1trZXldID0gKCkgPT4gbm9ybWFsaXplZDsKICAgICAgfQogICAgfQogIH07CiAgY29uc3Qgbm9ybWFsaXplVk5vZGVTbG90cyA9IChpbnN0YW5jZSwgY2hpbGRyZW4pID0+IHsKICAgIGlmICghaXNLZWVwQWxpdmUoaW5zdGFuY2Uudm5vZGUpICYmIHRydWUpIHsKICAgICAgd2FybiQxKAogICAgICAgIGBOb24tZnVuY3Rpb24gdmFsdWUgZW5jb3VudGVyZWQgZm9yIGRlZmF1bHQgc2xvdC4gUHJlZmVyIGZ1bmN0aW9uIHNsb3RzIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2UuYAogICAgICApOwogICAgfQogICAgY29uc3Qgbm9ybWFsaXplZCA9IG5vcm1hbGl6ZVNsb3RWYWx1ZShjaGlsZHJlbik7CiAgICBpbnN0YW5jZS5zbG90cy5kZWZhdWx0ID0gKCkgPT4gbm9ybWFsaXplZDsKICB9OwogIGNvbnN0IGluaXRTbG90cyA9IChpbnN0YW5jZSwgY2hpbGRyZW4pID0+IHsKICAgIGlmIChpbnN0YW5jZS52bm9kZS5zaGFwZUZsYWcgJiAzMikgewogICAgICBjb25zdCB0eXBlID0gY2hpbGRyZW4uXzsKICAgICAgaWYgKHR5cGUpIHsKICAgICAgICBpbnN0YW5jZS5zbG90cyA9IHRvUmF3KGNoaWxkcmVuKTsKICAgICAgICBkZWYoY2hpbGRyZW4sICJfIiwgdHlwZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9ybWFsaXplT2JqZWN0U2xvdHMoCiAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgIGluc3RhbmNlLnNsb3RzID0ge30pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpbnN0YW5jZS5zbG90cyA9IHt9OwogICAgICBpZiAoY2hpbGRyZW4pIHsKICAgICAgICBub3JtYWxpemVWTm9kZVNsb3RzKGluc3RhbmNlLCBjaGlsZHJlbik7CiAgICAgIH0KICAgIH0KICAgIGRlZihpbnN0YW5jZS5zbG90cywgSW50ZXJuYWxPYmplY3RLZXksIDEpOwogIH07CiAgY29uc3QgdXBkYXRlU2xvdHMgPSAoaW5zdGFuY2UsIGNoaWxkcmVuLCBvcHRpbWl6ZWQpID0+IHsKICAgIGNvbnN0IHsgdm5vZGUsIHNsb3RzIH0gPSBpbnN0YW5jZTsKICAgIGxldCBuZWVkRGVsZXRpb25DaGVjayA9IHRydWU7CiAgICBsZXQgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0gRU1QVFlfT0JKOwogICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDMyKSB7CiAgICAgIGNvbnN0IHR5cGUgPSBjaGlsZHJlbi5fOwogICAgICBpZiAodHlwZSkgewogICAgICAgIGlmIChpc0htclVwZGF0aW5nKSB7CiAgICAgICAgICBleHRlbmQoc2xvdHMsIGNoaWxkcmVuKTsKICAgICAgICAgIHRyaWdnZXIoaW5zdGFuY2UsICJzZXQiLCAiJHNsb3RzIik7CiAgICAgICAgfSBlbHNlIGlmIChvcHRpbWl6ZWQgJiYgdHlwZSA9PT0gMSkgewogICAgICAgICAgbmVlZERlbGV0aW9uQ2hlY2sgPSBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXh0ZW5kKHNsb3RzLCBjaGlsZHJlbik7CiAgICAgICAgICBpZiAoIW9wdGltaXplZCAmJiB0eXBlID09PSAxKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzbG90cy5fOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuZWVkRGVsZXRpb25DaGVjayA9ICFjaGlsZHJlbi4kc3RhYmxlOwogICAgICAgIG5vcm1hbGl6ZU9iamVjdFNsb3RzKGNoaWxkcmVuLCBzbG90cyk7CiAgICAgIH0KICAgICAgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0gY2hpbGRyZW47CiAgICB9IGVsc2UgaWYgKGNoaWxkcmVuKSB7CiAgICAgIG5vcm1hbGl6ZVZOb2RlU2xvdHMoaW5zdGFuY2UsIGNoaWxkcmVuKTsKICAgICAgZGVsZXRpb25Db21wYXJpc29uVGFyZ2V0ID0geyBkZWZhdWx0OiAxIH07CiAgICB9CiAgICBpZiAobmVlZERlbGV0aW9uQ2hlY2spIHsKICAgICAgZm9yIChjb25zdCBrZXkgaW4gc2xvdHMpIHsKICAgICAgICBpZiAoIWlzSW50ZXJuYWxLZXkoa2V5KSAmJiBkZWxldGlvbkNvbXBhcmlzb25UYXJnZXRba2V5XSA9PSBudWxsKSB7CiAgICAgICAgICBkZWxldGUgc2xvdHNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICBmdW5jdGlvbiBzZXRSZWYocmF3UmVmLCBvbGRSYXdSZWYsIHBhcmVudFN1c3BlbnNlLCB2bm9kZSwgaXNVbm1vdW50ID0gZmFsc2UpIHsKICAgIGlmIChpc0FycmF5KHJhd1JlZikpIHsKICAgICAgcmF3UmVmLmZvckVhY2goCiAgICAgICAgKHIsIGkpID0+IHNldFJlZigKICAgICAgICAgIHIsCiAgICAgICAgICBvbGRSYXdSZWYgJiYgKGlzQXJyYXkob2xkUmF3UmVmKSA/IG9sZFJhd1JlZltpXSA6IG9sZFJhd1JlZiksCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIHZub2RlLAogICAgICAgICAgaXNVbm1vdW50CiAgICAgICAgKQogICAgICApOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoaXNBc3luY1dyYXBwZXIodm5vZGUpICYmICFpc1VubW91bnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcmVmVmFsdWUgPSB2bm9kZS5zaGFwZUZsYWcgJiA0ID8gZ2V0RXhwb3NlUHJveHkodm5vZGUuY29tcG9uZW50KSB8fCB2bm9kZS5jb21wb25lbnQucHJveHkgOiB2bm9kZS5lbDsKICAgIGNvbnN0IHZhbHVlID0gaXNVbm1vdW50ID8gbnVsbCA6IHJlZlZhbHVlOwogICAgY29uc3QgeyBpOiBvd25lciwgcjogcmVmIH0gPSByYXdSZWY7CiAgICBpZiAoIW93bmVyKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgTWlzc2luZyByZWYgb3duZXIgY29udGV4dC4gcmVmIGNhbm5vdCBiZSB1c2VkIG9uIGhvaXN0ZWQgdm5vZGVzLiBBIHZub2RlIHdpdGggcmVmIG11c3QgYmUgY3JlYXRlZCBpbnNpZGUgdGhlIHJlbmRlciBmdW5jdGlvbi5gCiAgICAgICk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IG9sZFJlZiA9IG9sZFJhd1JlZiAmJiBvbGRSYXdSZWYucjsKICAgIGNvbnN0IHJlZnMgPSBvd25lci5yZWZzID09PSBFTVBUWV9PQkogPyBvd25lci5yZWZzID0ge30gOiBvd25lci5yZWZzOwogICAgY29uc3Qgc2V0dXBTdGF0ZSA9IG93bmVyLnNldHVwU3RhdGU7CiAgICBpZiAob2xkUmVmICE9IG51bGwgJiYgb2xkUmVmICE9PSByZWYpIHsKICAgICAgaWYgKGlzU3RyaW5nKG9sZFJlZikpIHsKICAgICAgICByZWZzW29sZFJlZl0gPSBudWxsOwogICAgICAgIGlmIChoYXNPd24oc2V0dXBTdGF0ZSwgb2xkUmVmKSkgewogICAgICAgICAgc2V0dXBTdGF0ZVtvbGRSZWZdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNSZWYob2xkUmVmKSkgewogICAgICAgIG9sZFJlZi52YWx1ZSA9IG51bGw7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc0Z1bmN0aW9uKHJlZikpIHsKICAgICAgY2FsbFdpdGhFcnJvckhhbmRsaW5nKHJlZiwgb3duZXIsIDEyLCBbdmFsdWUsIHJlZnNdKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IF9pc1N0cmluZyA9IGlzU3RyaW5nKHJlZik7CiAgICAgIGNvbnN0IF9pc1JlZiA9IGlzUmVmKHJlZik7CiAgICAgIGlmIChfaXNTdHJpbmcgfHwgX2lzUmVmKSB7CiAgICAgICAgY29uc3QgZG9TZXQgPSAoKSA9PiB7CiAgICAgICAgICBpZiAocmF3UmVmLmYpIHsKICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBfaXNTdHJpbmcgPyBoYXNPd24oc2V0dXBTdGF0ZSwgcmVmKSA/IHNldHVwU3RhdGVbcmVmXSA6IHJlZnNbcmVmXSA6IHJlZi52YWx1ZTsKICAgICAgICAgICAgaWYgKGlzVW5tb3VudCkgewogICAgICAgICAgICAgIGlzQXJyYXkoZXhpc3RpbmcpICYmIHJlbW92ZShleGlzdGluZywgcmVmVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNBcnJheShleGlzdGluZykpIHsKICAgICAgICAgICAgICAgIGlmIChfaXNTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgcmVmc1tyZWZdID0gW3JlZlZhbHVlXTsKICAgICAgICAgICAgICAgICAgaWYgKGhhc093bihzZXR1cFN0YXRlLCByZWYpKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dXBTdGF0ZVtyZWZdID0gcmVmc1tyZWZdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWYudmFsdWUgPSBbcmVmVmFsdWVdOwogICAgICAgICAgICAgICAgICBpZiAocmF3UmVmLmspCiAgICAgICAgICAgICAgICAgICAgcmVmc1tyYXdSZWYua10gPSByZWYudmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghZXhpc3RpbmcuaW5jbHVkZXMocmVmVmFsdWUpKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZy5wdXNoKHJlZlZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoX2lzU3RyaW5nKSB7CiAgICAgICAgICAgIHJlZnNbcmVmXSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoaGFzT3duKHNldHVwU3RhdGUsIHJlZikpIHsKICAgICAgICAgICAgICBzZXR1cFN0YXRlW3JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChfaXNSZWYpIHsKICAgICAgICAgICAgcmVmLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmIChyYXdSZWYuaykKICAgICAgICAgICAgICByZWZzW3Jhd1JlZi5rXSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2FybiQxKCJJbnZhbGlkIHRlbXBsYXRlIHJlZiB0eXBlOiIsIHJlZiwgYCgke3R5cGVvZiByZWZ9KWApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICBkb1NldC5pZCA9IC0xOwogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KGRvU2V0LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvU2V0KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4kMSgiSW52YWxpZCB0ZW1wbGF0ZSByZWYgdHlwZToiLCByZWYsIGAoJHt0eXBlb2YgcmVmfSlgKTsKICAgICAgfQogICAgfQogIH0KCiAgbGV0IGhhc01pc21hdGNoID0gZmFsc2U7CiAgY29uc3QgaXNTVkdDb250YWluZXIgPSAoY29udGFpbmVyKSA9PiBjb250YWluZXIubmFtZXNwYWNlVVJJLmluY2x1ZGVzKCJzdmciKSAmJiBjb250YWluZXIudGFnTmFtZSAhPT0gImZvcmVpZ25PYmplY3QiOwogIGNvbnN0IGlzTWF0aE1MQ29udGFpbmVyID0gKGNvbnRhaW5lcikgPT4gY29udGFpbmVyLm5hbWVzcGFjZVVSSS5pbmNsdWRlcygiTWF0aE1MIik7CiAgY29uc3QgZ2V0Q29udGFpbmVyVHlwZSA9IChjb250YWluZXIpID0+IHsKICAgIGlmIChpc1NWR0NvbnRhaW5lcihjb250YWluZXIpKQogICAgICByZXR1cm4gInN2ZyI7CiAgICBpZiAoaXNNYXRoTUxDb250YWluZXIoY29udGFpbmVyKSkKICAgICAgcmV0dXJuICJtYXRobWwiOwogICAgcmV0dXJuIHZvaWQgMDsKICB9OwogIGNvbnN0IGlzQ29tbWVudCA9IChub2RlKSA9PiBub2RlLm5vZGVUeXBlID09PSA4IC8qIENPTU1FTlQgKi87CiAgZnVuY3Rpb24gY3JlYXRlSHlkcmF0aW9uRnVuY3Rpb25zKHJlbmRlcmVySW50ZXJuYWxzKSB7CiAgICBjb25zdCB7CiAgICAgIG10OiBtb3VudENvbXBvbmVudCwKICAgICAgcDogcGF0Y2gsCiAgICAgIG86IHsKICAgICAgICBwYXRjaFByb3AsCiAgICAgICAgY3JlYXRlVGV4dCwKICAgICAgICBuZXh0U2libGluZywKICAgICAgICBwYXJlbnROb2RlLAogICAgICAgIHJlbW92ZSwKICAgICAgICBpbnNlcnQsCiAgICAgICAgY3JlYXRlQ29tbWVudAogICAgICB9CiAgICB9ID0gcmVuZGVyZXJJbnRlcm5hbHM7CiAgICBjb25zdCBoeWRyYXRlID0gKHZub2RlLCBjb250YWluZXIpID0+IHsKICAgICAgaWYgKCFjb250YWluZXIuaGFzQ2hpbGROb2RlcygpKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYEF0dGVtcHRpbmcgdG8gaHlkcmF0ZSBleGlzdGluZyBtYXJrdXAgYnV0IGNvbnRhaW5lciBpcyBlbXB0eS4gUGVyZm9ybWluZyBmdWxsIG1vdW50IGluc3RlYWQuYAogICAgICAgICk7CiAgICAgICAgcGF0Y2gobnVsbCwgdm5vZGUsIGNvbnRhaW5lcik7CiAgICAgICAgZmx1c2hQb3N0Rmx1c2hDYnMoKTsKICAgICAgICBjb250YWluZXIuX3Zub2RlID0gdm5vZGU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGhhc01pc21hdGNoID0gZmFsc2U7CiAgICAgIGh5ZHJhdGVOb2RlKGNvbnRhaW5lci5maXJzdENoaWxkLCB2bm9kZSwgbnVsbCwgbnVsbCwgbnVsbCk7CiAgICAgIGZsdXNoUG9zdEZsdXNoQ2JzKCk7CiAgICAgIGNvbnRhaW5lci5fdm5vZGUgPSB2bm9kZTsKICAgICAgaWYgKGhhc01pc21hdGNoICYmIHRydWUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBIeWRyYXRpb24gY29tcGxldGVkIGJ1dCBjb250YWlucyBtaXNtYXRjaGVzLmApOwogICAgICB9CiAgICB9OwogICAgY29uc3QgaHlkcmF0ZU5vZGUgPSAobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkID0gZmFsc2UpID0+IHsKICAgICAgY29uc3QgaXNGcmFnbWVudFN0YXJ0ID0gaXNDb21tZW50KG5vZGUpICYmIG5vZGUuZGF0YSA9PT0gIlsiOwogICAgICBjb25zdCBvbk1pc21hdGNoID0gKCkgPT4gaGFuZGxlTWlzbWF0Y2goCiAgICAgICAgbm9kZSwKICAgICAgICB2bm9kZSwKICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgIGlzRnJhZ21lbnRTdGFydAogICAgICApOwogICAgICBjb25zdCB7IHR5cGUsIHJlZiwgc2hhcGVGbGFnLCBwYXRjaEZsYWcgfSA9IHZub2RlOwogICAgICBsZXQgZG9tVHlwZSA9IG5vZGUubm9kZVR5cGU7CiAgICAgIHZub2RlLmVsID0gbm9kZTsKICAgICAgewogICAgICAgIGlmICghKCJfX3Zub2RlIiBpbiBub2RlKSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vZGUsICJfX3Zub2RlIiwgewogICAgICAgICAgICB2YWx1ZTogdm5vZGUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCEoIl9fdnVlUGFyZW50Q29tcG9uZW50IiBpbiBub2RlKSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vZGUsICJfX3Z1ZVBhcmVudENvbXBvbmVudCIsIHsKICAgICAgICAgICAgdmFsdWU6IHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocGF0Y2hGbGFnID09PSAtMikgewogICAgICAgIG9wdGltaXplZCA9IGZhbHNlOwogICAgICAgIHZub2RlLmR5bmFtaWNDaGlsZHJlbiA9IG51bGw7CiAgICAgIH0KICAgICAgbGV0IG5leHROb2RlID0gbnVsbDsKICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgY2FzZSBUZXh0OgogICAgICAgICAgaWYgKGRvbVR5cGUgIT09IDMgLyogVEVYVCAqLykgewogICAgICAgICAgICBpZiAodm5vZGUuY2hpbGRyZW4gPT09ICIiKSB7CiAgICAgICAgICAgICAgaW5zZXJ0KHZub2RlLmVsID0gY3JlYXRlVGV4dCgiIiksIHBhcmVudE5vZGUobm9kZSksIG5vZGUpOwogICAgICAgICAgICAgIG5leHROb2RlID0gbm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSAhPT0gdm5vZGUuY2hpbGRyZW4pIHsKICAgICAgICAgICAgICBoYXNNaXNtYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgICAgYEh5ZHJhdGlvbiB0ZXh0IG1pc21hdGNoIGluYCwKICAgICAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZSwKICAgICAgICAgICAgICAgIGAKICAtIHJlbmRlcmVkIG9uIHNlcnZlcjogJHtKU09OLnN0cmluZ2lmeSgKICAgICAgICAgICAgICAgIG5vZGUuZGF0YQogICAgICAgICAgICAgICl9CiAgLSBleHBlY3RlZCBvbiBjbGllbnQ6ICR7SlNPTi5zdHJpbmdpZnkodm5vZGUuY2hpbGRyZW4pfWAKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZub2RlLmNoaWxkcmVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHROb2RlID0gbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIENvbW1lbnQ6CiAgICAgICAgICBpZiAoaXNUZW1wbGF0ZU5vZGUobm9kZSkpIHsKICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgICAgcmVwbGFjZU5vZGUoCiAgICAgICAgICAgICAgdm5vZGUuZWwgPSBub2RlLmNvbnRlbnQuZmlyc3RDaGlsZCwKICAgICAgICAgICAgICBub2RlLAogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudAogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIGlmIChkb21UeXBlICE9PSA4IC8qIENPTU1FTlQgKi8gfHwgaXNGcmFnbWVudFN0YXJ0KSB7CiAgICAgICAgICAgIG5leHROb2RlID0gb25NaXNtYXRjaCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgU3RhdGljOgogICAgICAgICAgaWYgKGlzRnJhZ21lbnRTdGFydCkgewogICAgICAgICAgICBub2RlID0gbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgIGRvbVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRvbVR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyB8fCBkb21UeXBlID09PSAzIC8qIFRFWFQgKi8pIHsKICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBjb25zdCBuZWVkVG9BZG9wdENvbnRlbnQgPSAhdm5vZGUuY2hpbGRyZW4ubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZub2RlLnN0YXRpY0NvdW50OyBpKyspIHsKICAgICAgICAgICAgICBpZiAobmVlZFRvQWRvcHRDb250ZW50KQogICAgICAgICAgICAgICAgdm5vZGUuY2hpbGRyZW4gKz0gbmV4dE5vZGUubm9kZVR5cGUgPT09IDEgLyogRUxFTUVOVCAqLyA/IG5leHROb2RlLm91dGVySFRNTCA6IG5leHROb2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGkgPT09IHZub2RlLnN0YXRpY0NvdW50IC0gMSkgewogICAgICAgICAgICAgICAgdm5vZGUuYW5jaG9yID0gbmV4dE5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dFNpYmxpbmcobmV4dE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0ZyYWdtZW50U3RhcnQgPyBuZXh0U2libGluZyhuZXh0Tm9kZSkgOiBuZXh0Tm9kZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9uTWlzbWF0Y2goKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgRnJhZ21lbnQ6CiAgICAgICAgICBpZiAoIWlzRnJhZ21lbnRTdGFydCkgewogICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHROb2RlID0gaHlkcmF0ZUZyYWdtZW50KAogICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgdm5vZGUsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMSkgewogICAgICAgICAgICBpZiAoKGRvbVR5cGUgIT09IDEgLyogRUxFTUVOVCAqLyB8fCB2bm9kZS50eXBlLnRvTG93ZXJDYXNlKCkgIT09IG5vZGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSAmJiAhaXNUZW1wbGF0ZU5vZGUobm9kZSkpIHsKICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Tm9kZSA9IGh5ZHJhdGVFbGVtZW50KAogICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgIHZub2RlLAogICAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHNoYXBlRmxhZyAmIDYpIHsKICAgICAgICAgICAgdm5vZGUuc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzOwogICAgICAgICAgICBjb25zdCBjb250YWluZXIgPSBwYXJlbnROb2RlKG5vZGUpOwogICAgICAgICAgICBpZiAoaXNGcmFnbWVudFN0YXJ0KSB7CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBsb2NhdGVDbG9zaW5nQW5jaG9yKG5vZGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ29tbWVudChub2RlKSAmJiBub2RlLmRhdGEgPT09ICJ0ZWxlcG9ydCBzdGFydCIpIHsKICAgICAgICAgICAgICBuZXh0Tm9kZSA9IGxvY2F0ZUNsb3NpbmdBbmNob3Iobm9kZSwgbm9kZS5kYXRhLCAidGVsZXBvcnQgZW5kIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtb3VudENvbXBvbmVudCgKICAgICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgZ2V0Q29udGFpbmVyVHlwZShjb250YWluZXIpLAogICAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoaXNBc3luY1dyYXBwZXIodm5vZGUpKSB7CiAgICAgICAgICAgICAgbGV0IHN1YlRyZWU7CiAgICAgICAgICAgICAgaWYgKGlzRnJhZ21lbnRTdGFydCkgewogICAgICAgICAgICAgICAgc3ViVHJlZSA9IGNyZWF0ZVZOb2RlKEZyYWdtZW50KTsKICAgICAgICAgICAgICAgIHN1YlRyZWUuYW5jaG9yID0gbmV4dE5vZGUgPyBuZXh0Tm9kZS5wcmV2aW91c1NpYmxpbmcgOiBjb250YWluZXIubGFzdENoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdWJUcmVlID0gbm9kZS5ub2RlVHlwZSA9PT0gMyA/IGNyZWF0ZVRleHRWTm9kZSgiIikgOiBjcmVhdGVWTm9kZSgiZGl2Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN1YlRyZWUuZWwgPSBub2RlOwogICAgICAgICAgICAgIHZub2RlLmNvbXBvbmVudC5zdWJUcmVlID0gc3ViVHJlZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaGFwZUZsYWcgJiA2NCkgewogICAgICAgICAgICBpZiAoZG9tVHlwZSAhPT0gOCAvKiBDT01NRU5UICovKSB7CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSB2bm9kZS50eXBlLmh5ZHJhdGUoCiAgICAgICAgICAgICAgICBub2RlLAogICAgICAgICAgICAgICAgdm5vZGUsCiAgICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgICAgIG9wdGltaXplZCwKICAgICAgICAgICAgICAgIHJlbmRlcmVySW50ZXJuYWxzLAogICAgICAgICAgICAgICAgaHlkcmF0ZUNoaWxkcmVuCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaGFwZUZsYWcgJiAxMjgpIHsKICAgICAgICAgICAgbmV4dE5vZGUgPSB2bm9kZS50eXBlLmh5ZHJhdGUoCiAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgZ2V0Q29udGFpbmVyVHlwZShwYXJlbnROb2RlKG5vZGUpKSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkLAogICAgICAgICAgICAgIHJlbmRlcmVySW50ZXJuYWxzLAogICAgICAgICAgICAgIGh5ZHJhdGVOb2RlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YXJuJDEoIkludmFsaWQgSG9zdFZOb2RlIHR5cGU6IiwgdHlwZSwgYCgke3R5cGVvZiB0eXBlfSlgKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBpZiAocmVmICE9IG51bGwpIHsKICAgICAgICBzZXRSZWYocmVmLCBudWxsLCBwYXJlbnRTdXNwZW5zZSwgdm5vZGUpOwogICAgICB9CiAgICAgIHJldHVybiBuZXh0Tm9kZTsKICAgIH07CiAgICBjb25zdCBoeWRyYXRlRWxlbWVudCA9IChlbCwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgIG9wdGltaXplZCA9IG9wdGltaXplZCB8fCAhIXZub2RlLmR5bmFtaWNDaGlsZHJlbjsKICAgICAgY29uc3QgeyB0eXBlLCBwcm9wcywgcGF0Y2hGbGFnLCBzaGFwZUZsYWcsIGRpcnMsIHRyYW5zaXRpb24gfSA9IHZub2RlOwogICAgICBjb25zdCBmb3JjZVBhdGNoID0gdHlwZSA9PT0gImlucHV0IiB8fCB0eXBlID09PSAib3B0aW9uIjsKICAgICAgewogICAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgICBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJjcmVhdGVkIik7CiAgICAgICAgfQogICAgICAgIGxldCBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyA9IGZhbHNlOwogICAgICAgIGlmIChpc1RlbXBsYXRlTm9kZShlbCkpIHsKICAgICAgICAgIG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzID0gbmVlZFRyYW5zaXRpb24ocGFyZW50U3VzcGVuc2UsIHRyYW5zaXRpb24pICYmIHBhcmVudENvbXBvbmVudCAmJiBwYXJlbnRDb21wb25lbnQudm5vZGUucHJvcHMgJiYgcGFyZW50Q29tcG9uZW50LnZub2RlLnByb3BzLmFwcGVhcjsKICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBlbC5jb250ZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICBpZiAobmVlZENhbGxUcmFuc2l0aW9uSG9va3MpIHsKICAgICAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihjb250ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJlcGxhY2VOb2RlKGNvbnRlbnQsIGVsLCBwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdm5vZGUuZWwgPSBlbCA9IGNvbnRlbnQ7CiAgICAgICAgfQogICAgICAgIGlmIChzaGFwZUZsYWcgJiAxNiAmJiAvLyBza2lwIGlmIGVsZW1lbnQgaGFzIGlubmVySFRNTCAvIHRleHRDb250ZW50CiAgICAgICAgIShwcm9wcyAmJiAocHJvcHMuaW5uZXJIVE1MIHx8IHByb3BzLnRleHRDb250ZW50KSkpIHsKICAgICAgICAgIGxldCBuZXh0ID0gaHlkcmF0ZUNoaWxkcmVuKAogICAgICAgICAgICBlbC5maXJzdENoaWxkLAogICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgZWwsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICApOwogICAgICAgICAgbGV0IGhhc1dhcm5lZCA9IGZhbHNlOwogICAgICAgICAgd2hpbGUgKG5leHQpIHsKICAgICAgICAgICAgaGFzTWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICBpZiAoIWhhc1dhcm5lZCkgewogICAgICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgICAgIGBIeWRyYXRpb24gY2hpbGRyZW4gbWlzbWF0Y2ggb25gLAogICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICBgClNlcnZlciByZW5kZXJlZCBlbGVtZW50IGNvbnRhaW5zIG1vcmUgY2hpbGQgbm9kZXMgdGhhbiBjbGllbnQgdmRvbS5gCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBoYXNXYXJuZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGN1ciA9IG5leHQ7CiAgICAgICAgICAgIG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nOwogICAgICAgICAgICByZW1vdmUoY3VyKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHNoYXBlRmxhZyAmIDgpIHsKICAgICAgICAgIGlmIChlbC50ZXh0Q29udGVudCAhPT0gdm5vZGUuY2hpbGRyZW4pIHsKICAgICAgICAgICAgaGFzTWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgYEh5ZHJhdGlvbiB0ZXh0IGNvbnRlbnQgbWlzbWF0Y2ggb25gLAogICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgIGAKICAtIHJlbmRlcmVkIG9uIHNlcnZlcjogJHtlbC50ZXh0Q29udGVudH0KICAtIGV4cGVjdGVkIG9uIGNsaWVudDogJHt2bm9kZS5jaGlsZHJlbn1gCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gdm5vZGUuY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBwcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wSGFzTWlzbWF0Y2goZWwsIGtleSwgcHJvcHNba2V5XSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZvcmNlUGF0Y2ggJiYgKGtleS5lbmRzV2l0aCgidmFsdWUiKSB8fCBrZXkgPT09ICJpbmRldGVybWluYXRlIikgfHwgaXNPbihrZXkpICYmICFpc1Jlc2VydmVkUHJvcChrZXkpIHx8IC8vIGZvcmNlIGh5ZHJhdGUgdi1iaW5kIHdpdGggLnByb3AgbW9kaWZpZXJzCiAgICAgICAgICAgICAga2V5WzBdID09PSAiLiIpIHsKICAgICAgICAgICAgICAgIHBhdGNoUHJvcCgKICAgICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgcHJvcHNba2V5XSwKICAgICAgICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IHZub2RlSG9va3M7CiAgICAgICAgaWYgKHZub2RlSG9va3MgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlQmVmb3JlTW91bnQpIHsKICAgICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2tzLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpcnMpIHsKICAgICAgICAgIGludm9rZURpcmVjdGl2ZUhvb2sodm5vZGUsIG51bGwsIHBhcmVudENvbXBvbmVudCwgImJlZm9yZU1vdW50Iik7CiAgICAgICAgfQogICAgICAgIGlmICgodm5vZGVIb29rcyA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVNb3VudGVkKSB8fCBkaXJzIHx8IG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzKSB7CiAgICAgICAgICBxdWV1ZUVmZmVjdFdpdGhTdXNwZW5zZSgoKSA9PiB7CiAgICAgICAgICAgIHZub2RlSG9va3MgJiYgaW52b2tlVk5vZGVIb29rKHZub2RlSG9va3MsIHBhcmVudENvbXBvbmVudCwgdm5vZGUpOwogICAgICAgICAgICBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyAmJiB0cmFuc2l0aW9uLmVudGVyKGVsKTsKICAgICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJtb3VudGVkIik7CiAgICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBlbC5uZXh0U2libGluZzsKICAgIH07CiAgICBjb25zdCBoeWRyYXRlQ2hpbGRyZW4gPSAobm9kZSwgcGFyZW50Vk5vZGUsIGNvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgb3B0aW1pemVkID0gb3B0aW1pemVkIHx8ICEhcGFyZW50Vk5vZGUuZHluYW1pY0NoaWxkcmVuOwogICAgICBjb25zdCBjaGlsZHJlbiA9IHBhcmVudFZOb2RlLmNoaWxkcmVuOwogICAgICBjb25zdCBsID0gY2hpbGRyZW4ubGVuZ3RoOwogICAgICBsZXQgaGFzV2FybmVkID0gZmFsc2U7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgY29uc3Qgdm5vZGUgPSBvcHRpbWl6ZWQgPyBjaGlsZHJlbltpXSA6IGNoaWxkcmVuW2ldID0gbm9ybWFsaXplVk5vZGUoY2hpbGRyZW5baV0pOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICBub2RlID0gaHlkcmF0ZU5vZGUoCiAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgIHZub2RlLAogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgaWYgKHZub2RlLnR5cGUgPT09IFRleHQgJiYgIXZub2RlLmNoaWxkcmVuKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGFzTWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgaWYgKCFoYXNXYXJuZWQpIHsKICAgICAgICAgICAgd2FybiQxKAogICAgICAgICAgICAgIGBIeWRyYXRpb24gY2hpbGRyZW4gbWlzbWF0Y2ggb25gLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBgClNlcnZlciByZW5kZXJlZCBlbGVtZW50IGNvbnRhaW5zIGZld2VyIGNoaWxkIG5vZGVzIHRoYW4gY2xpZW50IHZkb20uYAogICAgICAgICAgICApOwogICAgICAgICAgICBoYXNXYXJuZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcGF0Y2goCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHZub2RlLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIGdldENvbnRhaW5lclR5cGUoY29udGFpbmVyKSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbm9kZTsKICAgIH07CiAgICBjb25zdCBoeWRyYXRlRnJhZ21lbnQgPSAobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgIGNvbnN0IHsgc2xvdFNjb3BlSWRzOiBmcmFnbWVudFNsb3RTY29wZUlkcyB9ID0gdm5vZGU7CiAgICAgIGlmIChmcmFnbWVudFNsb3RTY29wZUlkcykgewogICAgICAgIHNsb3RTY29wZUlkcyA9IHNsb3RTY29wZUlkcyA/IHNsb3RTY29wZUlkcy5jb25jYXQoZnJhZ21lbnRTbG90U2NvcGVJZHMpIDogZnJhZ21lbnRTbG90U2NvcGVJZHM7CiAgICAgIH0KICAgICAgY29uc3QgY29udGFpbmVyID0gcGFyZW50Tm9kZShub2RlKTsKICAgICAgY29uc3QgbmV4dCA9IGh5ZHJhdGVDaGlsZHJlbigKICAgICAgICBuZXh0U2libGluZyhub2RlKSwKICAgICAgICB2bm9kZSwKICAgICAgICBjb250YWluZXIsCiAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICBvcHRpbWl6ZWQKICAgICAgKTsKICAgICAgaWYgKG5leHQgJiYgaXNDb21tZW50KG5leHQpICYmIG5leHQuZGF0YSA9PT0gIl0iKSB7CiAgICAgICAgcmV0dXJuIG5leHRTaWJsaW5nKHZub2RlLmFuY2hvciA9IG5leHQpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhc01pc21hdGNoID0gdHJ1ZTsKICAgICAgICBpbnNlcnQodm5vZGUuYW5jaG9yID0gY3JlYXRlQ29tbWVudChgXWApLCBjb250YWluZXIsIG5leHQpOwogICAgICAgIHJldHVybiBuZXh0OwogICAgICB9CiAgICB9OwogICAgY29uc3QgaGFuZGxlTWlzbWF0Y2ggPSAobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgaXNGcmFnbWVudCkgPT4gewogICAgICBoYXNNaXNtYXRjaCA9IHRydWU7CiAgICAgIHdhcm4kMSgKICAgICAgICBgSHlkcmF0aW9uIG5vZGUgbWlzbWF0Y2g6Ci0gcmVuZGVyZWQgb24gc2VydmVyOmAsCiAgICAgICAgbm9kZSwKICAgICAgICBub2RlLm5vZGVUeXBlID09PSAzIC8qIFRFWFQgKi8gPyBgKHRleHQpYCA6IGlzQ29tbWVudChub2RlKSAmJiBub2RlLmRhdGEgPT09ICJbIiA/IGAoc3RhcnQgb2YgZnJhZ21lbnQpYCA6IGBgLAogICAgICAgIGAKLSBleHBlY3RlZCBvbiBjbGllbnQ6YCwKICAgICAgICB2bm9kZS50eXBlCiAgICAgICk7CiAgICAgIHZub2RlLmVsID0gbnVsbDsKICAgICAgaWYgKGlzRnJhZ21lbnQpIHsKICAgICAgICBjb25zdCBlbmQgPSBsb2NhdGVDbG9zaW5nQW5jaG9yKG5vZGUpOwogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBjb25zdCBuZXh0MiA9IG5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgICAgaWYgKG5leHQyICYmIG5leHQyICE9PSBlbmQpIHsKICAgICAgICAgICAgcmVtb3ZlKG5leHQyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBuZXh0ID0gbmV4dFNpYmxpbmcobm9kZSk7CiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHBhcmVudE5vZGUobm9kZSk7CiAgICAgIHJlbW92ZShub2RlKTsKICAgICAgcGF0Y2goCiAgICAgICAgbnVsbCwKICAgICAgICB2bm9kZSwKICAgICAgICBjb250YWluZXIsCiAgICAgICAgbmV4dCwKICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgZ2V0Q29udGFpbmVyVHlwZShjb250YWluZXIpLAogICAgICAgIHNsb3RTY29wZUlkcwogICAgICApOwogICAgICByZXR1cm4gbmV4dDsKICAgIH07CiAgICBjb25zdCBsb2NhdGVDbG9zaW5nQW5jaG9yID0gKG5vZGUsIG9wZW4gPSAiWyIsIGNsb3NlID0gIl0iKSA9PiB7CiAgICAgIGxldCBtYXRjaCA9IDA7CiAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgbm9kZSA9IG5leHRTaWJsaW5nKG5vZGUpOwogICAgICAgIGlmIChub2RlICYmIGlzQ29tbWVudChub2RlKSkgewogICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gb3BlbikKICAgICAgICAgICAgbWF0Y2grKzsKICAgICAgICAgIGlmIChub2RlLmRhdGEgPT09IGNsb3NlKSB7CiAgICAgICAgICAgIGlmIChtYXRjaCA9PT0gMCkgewogICAgICAgICAgICAgIHJldHVybiBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBtYXRjaC0tOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBub2RlOwogICAgfTsKICAgIGNvbnN0IHJlcGxhY2VOb2RlID0gKG5ld05vZGUsIG9sZE5vZGUsIHBhcmVudENvbXBvbmVudCkgPT4gewogICAgICBjb25zdCBwYXJlbnROb2RlMiA9IG9sZE5vZGUucGFyZW50Tm9kZTsKICAgICAgaWYgKHBhcmVudE5vZGUyKSB7CiAgICAgICAgcGFyZW50Tm9kZTIucmVwbGFjZUNoaWxkKG5ld05vZGUsIG9sZE5vZGUpOwogICAgICB9CiAgICAgIGxldCBwYXJlbnQgPSBwYXJlbnRDb21wb25lbnQ7CiAgICAgIHdoaWxlIChwYXJlbnQpIHsKICAgICAgICBpZiAocGFyZW50LnZub2RlLmVsID09PSBvbGROb2RlKSB7CiAgICAgICAgICBwYXJlbnQudm5vZGUuZWwgPSBwYXJlbnQuc3ViVHJlZS5lbCA9IG5ld05vZGU7CiAgICAgICAgfQogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBpc1RlbXBsYXRlTm9kZSA9IChub2RlKSA9PiB7CiAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAxIC8qIEVMRU1FTlQgKi8gJiYgbm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0ZW1wbGF0ZSI7CiAgICB9OwogICAgcmV0dXJuIFtoeWRyYXRlLCBoeWRyYXRlTm9kZV07CiAgfQogIGZ1bmN0aW9uIHByb3BIYXNNaXNtYXRjaChlbCwga2V5LCBjbGllbnRWYWx1ZSwgdm5vZGUsIGluc3RhbmNlKSB7CiAgICB2YXIgX2E7CiAgICBsZXQgbWlzbWF0Y2hUeXBlOwogICAgbGV0IG1pc21hdGNoS2V5OwogICAgbGV0IGFjdHVhbDsKICAgIGxldCBleHBlY3RlZDsKICAgIGlmIChrZXkgPT09ICJjbGFzcyIpIHsKICAgICAgYWN0dWFsID0gZWwuZ2V0QXR0cmlidXRlKCJjbGFzcyIpOwogICAgICBleHBlY3RlZCA9IG5vcm1hbGl6ZUNsYXNzKGNsaWVudFZhbHVlKTsKICAgICAgaWYgKCFpc1NldEVxdWFsKHRvQ2xhc3NTZXQoYWN0dWFsIHx8ICIiKSwgdG9DbGFzc1NldChleHBlY3RlZCkpKSB7CiAgICAgICAgbWlzbWF0Y2hUeXBlID0gbWlzbWF0Y2hLZXkgPSBgY2xhc3NgOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleSA9PT0gInN0eWxlIikgewogICAgICBhY3R1YWwgPSBlbC5nZXRBdHRyaWJ1dGUoInN0eWxlIik7CiAgICAgIGV4cGVjdGVkID0gaXNTdHJpbmcoY2xpZW50VmFsdWUpID8gY2xpZW50VmFsdWUgOiBzdHJpbmdpZnlTdHlsZShub3JtYWxpemVTdHlsZShjbGllbnRWYWx1ZSkpOwogICAgICBjb25zdCBhY3R1YWxNYXAgPSB0b1N0eWxlTWFwKGFjdHVhbCk7CiAgICAgIGNvbnN0IGV4cGVjdGVkTWFwID0gdG9TdHlsZU1hcChleHBlY3RlZCk7CiAgICAgIGlmICh2bm9kZS5kaXJzKSB7CiAgICAgICAgZm9yIChjb25zdCB7IGRpciwgdmFsdWUgfSBvZiB2bm9kZS5kaXJzKSB7CiAgICAgICAgICBpZiAoZGlyLm5hbWUgPT09ICJzaG93IiAmJiAhdmFsdWUpIHsKICAgICAgICAgICAgZXhwZWN0ZWRNYXAuc2V0KCJkaXNwbGF5IiwgIm5vbmUiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3Qgcm9vdCA9IGluc3RhbmNlID09IG51bGwgPyB2b2lkIDAgOiBpbnN0YW5jZS5zdWJUcmVlOwogICAgICBpZiAodm5vZGUgPT09IHJvb3QgfHwgKHJvb3QgPT0gbnVsbCA/IHZvaWQgMCA6IHJvb3QudHlwZSkgPT09IEZyYWdtZW50ICYmIHJvb3QuY2hpbGRyZW4uaW5jbHVkZXModm5vZGUpKSB7CiAgICAgICAgY29uc3QgY3NzVmFycyA9IChfYSA9IGluc3RhbmNlID09IG51bGwgPyB2b2lkIDAgOiBpbnN0YW5jZS5nZXRDc3NWYXJzKSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChpbnN0YW5jZSk7CiAgICAgICAgZm9yIChjb25zdCBrZXkyIGluIGNzc1ZhcnMpIHsKICAgICAgICAgIGV4cGVjdGVkTWFwLnNldChgLS0ke2tleTJ9YCwgU3RyaW5nKGNzc1ZhcnNba2V5Ml0pKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFpc01hcEVxdWFsKGFjdHVhbE1hcCwgZXhwZWN0ZWRNYXApKSB7CiAgICAgICAgbWlzbWF0Y2hUeXBlID0gbWlzbWF0Y2hLZXkgPSAic3R5bGUiOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGVsIGluc3RhbmNlb2YgU1ZHRWxlbWVudCAmJiBpc0tub3duU3ZnQXR0cihrZXkpIHx8IGVsIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiYgKGlzQm9vbGVhbkF0dHIoa2V5KSB8fCBpc0tub3duSHRtbEF0dHIoa2V5KSkpIHsKICAgICAgaWYgKGlzQm9vbGVhbkF0dHIoa2V5KSkgewogICAgICAgIGFjdHVhbCA9IGVsLmhhc0F0dHJpYnV0ZShrZXkpOwogICAgICAgIGV4cGVjdGVkID0gaW5jbHVkZUJvb2xlYW5BdHRyKGNsaWVudFZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChjbGllbnRWYWx1ZSA9PSBudWxsKSB7CiAgICAgICAgYWN0dWFsID0gZWwuaGFzQXR0cmlidXRlKGtleSk7CiAgICAgICAgZXhwZWN0ZWQgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZWwuaGFzQXR0cmlidXRlKGtleSkpIHsKICAgICAgICAgIGFjdHVhbCA9IGVsLmdldEF0dHJpYnV0ZShrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAidmFsdWUiICYmIGVsLnRhZ05hbWUgPT09ICJURVhUQVJFQSIpIHsKICAgICAgICAgIGFjdHVhbCA9IGVsLnZhbHVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhY3R1YWwgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZXhwZWN0ZWQgPSBpc1JlbmRlcmFibGVBdHRyVmFsdWUoY2xpZW50VmFsdWUpID8gU3RyaW5nKGNsaWVudFZhbHVlKSA6IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChhY3R1YWwgIT09IGV4cGVjdGVkKSB7CiAgICAgICAgbWlzbWF0Y2hUeXBlID0gYGF0dHJpYnV0ZWA7CiAgICAgICAgbWlzbWF0Y2hLZXkgPSBrZXk7CiAgICAgIH0KICAgIH0KICAgIGlmIChtaXNtYXRjaFR5cGUpIHsKICAgICAgY29uc3QgZm9ybWF0ID0gKHYpID0+IHYgPT09IGZhbHNlID8gYChub3QgcmVuZGVyZWQpYCA6IGAke21pc21hdGNoS2V5fT0iJHt2fSJgOwogICAgICBjb25zdCBwcmVTZWdtZW50ID0gYEh5ZHJhdGlvbiAke21pc21hdGNoVHlwZX0gbWlzbWF0Y2ggb25gOwogICAgICBjb25zdCBwb3N0U2VnbWVudCA9IGAKICAtIHJlbmRlcmVkIG9uIHNlcnZlcjogJHtmb3JtYXQoYWN0dWFsKX0KICAtIGV4cGVjdGVkIG9uIGNsaWVudDogJHtmb3JtYXQoZXhwZWN0ZWQpfQogIE5vdGU6IHRoaXMgbWlzbWF0Y2ggaXMgY2hlY2stb25seS4gVGhlIERPTSB3aWxsIG5vdCBiZSByZWN0aWZpZWQgaW4gcHJvZHVjdGlvbiBkdWUgdG8gcGVyZm9ybWFuY2Ugb3ZlcmhlYWQuCiAgWW91IHNob3VsZCBmaXggdGhlIHNvdXJjZSBvZiB0aGUgbWlzbWF0Y2guYDsKICAgICAgewogICAgICAgIHdhcm4kMShwcmVTZWdtZW50LCBlbCwgcG9zdFNlZ21lbnQpOwogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiB0b0NsYXNzU2V0KHN0cikgewogICAgcmV0dXJuIG5ldyBTZXQoc3RyLnRyaW0oKS5zcGxpdCgvXHMrLykpOwogIH0KICBmdW5jdGlvbiBpc1NldEVxdWFsKGEsIGIpIHsKICAgIGlmIChhLnNpemUgIT09IGIuc2l6ZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBmb3IgKGNvbnN0IHMgb2YgYSkgewogICAgICBpZiAoIWIuaGFzKHMpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gdG9TdHlsZU1hcChzdHIpIHsKICAgIGNvbnN0IHN0eWxlTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBzdHIuc3BsaXQoIjsiKSkgewogICAgICBsZXQgW2tleSwgdmFsdWVdID0gaXRlbS5zcGxpdCgiOiIpOwogICAgICBrZXkgPSBrZXkgPT0gbnVsbCA/IHZvaWQgMCA6IGtleS50cmltKCk7CiAgICAgIHZhbHVlID0gdmFsdWUgPT0gbnVsbCA/IHZvaWQgMCA6IHZhbHVlLnRyaW0oKTsKICAgICAgaWYgKGtleSAmJiB2YWx1ZSkgewogICAgICAgIHN0eWxlTWFwLnNldChrZXksIHZhbHVlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHN0eWxlTWFwOwogIH0KICBmdW5jdGlvbiBpc01hcEVxdWFsKGEsIGIpIHsKICAgIGlmIChhLnNpemUgIT09IGIuc2l6ZSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBhKSB7CiAgICAgIGlmICh2YWx1ZSAhPT0gYi5nZXQoa2V5KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBsZXQgc3VwcG9ydGVkOwogIGxldCBwZXJmOwogIGZ1bmN0aW9uIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgdHlwZSkgewogICAgaWYgKGluc3RhbmNlLmFwcENvbnRleHQuY29uZmlnLnBlcmZvcm1hbmNlICYmIGlzU3VwcG9ydGVkKCkpIHsKICAgICAgcGVyZi5tYXJrKGB2dWUtJHt0eXBlfS0ke2luc3RhbmNlLnVpZH1gKTsKICAgIH0KICAgIHsKICAgICAgZGV2dG9vbHNQZXJmU3RhcnQoaW5zdGFuY2UsIHR5cGUsIGlzU3VwcG9ydGVkKCkgPyBwZXJmLm5vdygpIDogRGF0ZS5ub3coKSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGVuZE1lYXN1cmUoaW5zdGFuY2UsIHR5cGUpIHsKICAgIGlmIChpbnN0YW5jZS5hcHBDb250ZXh0LmNvbmZpZy5wZXJmb3JtYW5jZSAmJiBpc1N1cHBvcnRlZCgpKSB7CiAgICAgIGNvbnN0IHN0YXJ0VGFnID0gYHZ1ZS0ke3R5cGV9LSR7aW5zdGFuY2UudWlkfWA7CiAgICAgIGNvbnN0IGVuZFRhZyA9IHN0YXJ0VGFnICsgYDplbmRgOwogICAgICBwZXJmLm1hcmsoZW5kVGFnKTsKICAgICAgcGVyZi5tZWFzdXJlKAogICAgICAgIGA8JHtmb3JtYXRDb21wb25lbnROYW1lKGluc3RhbmNlLCBpbnN0YW5jZS50eXBlKX0+ICR7dHlwZX1gLAogICAgICAgIHN0YXJ0VGFnLAogICAgICAgIGVuZFRhZwogICAgICApOwogICAgICBwZXJmLmNsZWFyTWFya3Moc3RhcnRUYWcpOwogICAgICBwZXJmLmNsZWFyTWFya3MoZW5kVGFnKTsKICAgIH0KICAgIHsKICAgICAgZGV2dG9vbHNQZXJmRW5kKGluc3RhbmNlLCB0eXBlLCBpc1N1cHBvcnRlZCgpID8gcGVyZi5ub3coKSA6IERhdGUubm93KCkpOwogICAgfQogIH0KICBmdW5jdGlvbiBpc1N1cHBvcnRlZCgpIHsKICAgIGlmIChzdXBwb3J0ZWQgIT09IHZvaWQgMCkgewogICAgICByZXR1cm4gc3VwcG9ydGVkOwogICAgfQogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5wZXJmb3JtYW5jZSkgewogICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICBwZXJmID0gd2luZG93LnBlcmZvcm1hbmNlOwogICAgfSBlbHNlIHsKICAgICAgc3VwcG9ydGVkID0gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gc3VwcG9ydGVkOwogIH0KCiAgY29uc3QgcXVldWVQb3N0UmVuZGVyRWZmZWN0ID0gcXVldWVFZmZlY3RXaXRoU3VzcGVuc2UgOwogIGZ1bmN0aW9uIGNyZWF0ZVJlbmRlcmVyKG9wdGlvbnMpIHsKICAgIHJldHVybiBiYXNlQ3JlYXRlUmVuZGVyZXIob3B0aW9ucyk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyKG9wdGlvbnMpIHsKICAgIHJldHVybiBiYXNlQ3JlYXRlUmVuZGVyZXIob3B0aW9ucywgY3JlYXRlSHlkcmF0aW9uRnVuY3Rpb25zKTsKICB9CiAgZnVuY3Rpb24gYmFzZUNyZWF0ZVJlbmRlcmVyKG9wdGlvbnMsIGNyZWF0ZUh5ZHJhdGlvbkZucykgewogICAgY29uc3QgdGFyZ2V0ID0gZ2V0R2xvYmFsVGhpcygpOwogICAgdGFyZ2V0Ll9fVlVFX18gPSB0cnVlOwogICAgewogICAgICBzZXREZXZ0b29sc0hvb2skMSh0YXJnZXQuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXywgdGFyZ2V0KTsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgaW5zZXJ0OiBob3N0SW5zZXJ0LAogICAgICByZW1vdmU6IGhvc3RSZW1vdmUsCiAgICAgIHBhdGNoUHJvcDogaG9zdFBhdGNoUHJvcCwKICAgICAgY3JlYXRlRWxlbWVudDogaG9zdENyZWF0ZUVsZW1lbnQsCiAgICAgIGNyZWF0ZVRleHQ6IGhvc3RDcmVhdGVUZXh0LAogICAgICBjcmVhdGVDb21tZW50OiBob3N0Q3JlYXRlQ29tbWVudCwKICAgICAgc2V0VGV4dDogaG9zdFNldFRleHQsCiAgICAgIHNldEVsZW1lbnRUZXh0OiBob3N0U2V0RWxlbWVudFRleHQsCiAgICAgIHBhcmVudE5vZGU6IGhvc3RQYXJlbnROb2RlLAogICAgICBuZXh0U2libGluZzogaG9zdE5leHRTaWJsaW5nLAogICAgICBzZXRTY29wZUlkOiBob3N0U2V0U2NvcGVJZCA9IE5PT1AsCiAgICAgIGluc2VydFN0YXRpY0NvbnRlbnQ6IGhvc3RJbnNlcnRTdGF0aWNDb250ZW50CiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IHBhdGNoID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IgPSBudWxsLCBwYXJlbnRDb21wb25lbnQgPSBudWxsLCBwYXJlbnRTdXNwZW5zZSA9IG51bGwsIG5hbWVzcGFjZSA9IHZvaWQgMCwgc2xvdFNjb3BlSWRzID0gbnVsbCwgb3B0aW1pemVkID0gaXNIbXJVcGRhdGluZyA/IGZhbHNlIDogISFuMi5keW5hbWljQ2hpbGRyZW4pID0+IHsKICAgICAgaWYgKG4xID09PSBuMikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobjEgJiYgIWlzU2FtZVZOb2RlVHlwZShuMSwgbjIpKSB7CiAgICAgICAgYW5jaG9yID0gZ2V0TmV4dEhvc3ROb2RlKG4xKTsKICAgICAgICB1bm1vdW50KG4xLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsKICAgICAgICBuMSA9IG51bGw7CiAgICAgIH0KICAgICAgaWYgKG4yLnBhdGNoRmxhZyA9PT0gLTIpIHsKICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICBuMi5keW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IHsgdHlwZSwgcmVmLCBzaGFwZUZsYWcgfSA9IG4yOwogICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICBjYXNlIFRleHQ6CiAgICAgICAgICBwcm9jZXNzVGV4dChuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgQ29tbWVudDoKICAgICAgICAgIHByb2Nlc3NDb21tZW50Tm9kZShuMSwgbjIsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgU3RhdGljOgogICAgICAgICAgaWYgKG4xID09IG51bGwpIHsKICAgICAgICAgICAgbW91bnRTdGF0aWNOb2RlKG4yLCBjb250YWluZXIsIGFuY2hvciwgbmFtZXNwYWNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhdGNoU3RhdGljTm9kZShuMSwgbjIsIGNvbnRhaW5lciwgbmFtZXNwYWNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgRnJhZ21lbnQ6CiAgICAgICAgICBwcm9jZXNzRnJhZ21lbnQoCiAgICAgICAgICAgIG4xLAogICAgICAgICAgICBuMiwKICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEpIHsKICAgICAgICAgICAgcHJvY2Vzc0VsZW1lbnQoCiAgICAgICAgICAgICAgbjEsCiAgICAgICAgICAgICAgbjIsCiAgICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgNikgewogICAgICAgICAgICBwcm9jZXNzQ29tcG9uZW50KAogICAgICAgICAgICAgIG4xLAogICAgICAgICAgICAgIG4yLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgaWYgKHNoYXBlRmxhZyAmIDY0KSB7CiAgICAgICAgICAgIHR5cGUucHJvY2VzcygKICAgICAgICAgICAgICBuMSwKICAgICAgICAgICAgICBuMiwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICAgIG9wdGltaXplZCwKICAgICAgICAgICAgICBpbnRlcm5hbHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgMTI4KSB7CiAgICAgICAgICAgIHR5cGUucHJvY2VzcygKICAgICAgICAgICAgICBuMSwKICAgICAgICAgICAgICBuMiwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICAgIG9wdGltaXplZCwKICAgICAgICAgICAgICBpbnRlcm5hbHMKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhcm4kMSgiSW52YWxpZCBWTm9kZSB0eXBlOiIsIHR5cGUsIGAoJHt0eXBlb2YgdHlwZX0pYCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHJlZiAhPSBudWxsICYmIHBhcmVudENvbXBvbmVudCkgewogICAgICAgIHNldFJlZihyZWYsIG4xICYmIG4xLnJlZiwgcGFyZW50U3VzcGVuc2UsIG4yIHx8IG4xLCAhbjIpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgcHJvY2Vzc1RleHQgPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvcikgPT4gewogICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgIGhvc3RJbnNlcnQoCiAgICAgICAgICBuMi5lbCA9IGhvc3RDcmVhdGVUZXh0KG4yLmNoaWxkcmVuKSwKICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgIGFuY2hvcgogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgZWwgPSBuMi5lbCA9IG4xLmVsOwogICAgICAgIGlmIChuMi5jaGlsZHJlbiAhPT0gbjEuY2hpbGRyZW4pIHsKICAgICAgICAgIGhvc3RTZXRUZXh0KGVsLCBuMi5jaGlsZHJlbik7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgY29uc3QgcHJvY2Vzc0NvbW1lbnROb2RlID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IpID0+IHsKICAgICAgaWYgKG4xID09IG51bGwpIHsKICAgICAgICBob3N0SW5zZXJ0KAogICAgICAgICAgbjIuZWwgPSBob3N0Q3JlYXRlQ29tbWVudChuMi5jaGlsZHJlbiB8fCAiIiksCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBhbmNob3IKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIG4yLmVsID0gbjEuZWw7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBtb3VudFN0YXRpY05vZGUgPSAobjIsIGNvbnRhaW5lciwgYW5jaG9yLCBuYW1lc3BhY2UpID0+IHsKICAgICAgW24yLmVsLCBuMi5hbmNob3JdID0gaG9zdEluc2VydFN0YXRpY0NvbnRlbnQoCiAgICAgICAgbjIuY2hpbGRyZW4sCiAgICAgICAgY29udGFpbmVyLAogICAgICAgIGFuY2hvciwKICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgbjIuZWwsCiAgICAgICAgbjIuYW5jaG9yCiAgICAgICk7CiAgICB9OwogICAgY29uc3QgcGF0Y2hTdGF0aWNOb2RlID0gKG4xLCBuMiwgY29udGFpbmVyLCBuYW1lc3BhY2UpID0+IHsKICAgICAgaWYgKG4yLmNoaWxkcmVuICE9PSBuMS5jaGlsZHJlbikgewogICAgICAgIGNvbnN0IGFuY2hvciA9IGhvc3ROZXh0U2libGluZyhuMS5hbmNob3IpOwogICAgICAgIHJlbW92ZVN0YXRpY05vZGUobjEpOwogICAgICAgIFtuMi5lbCwgbjIuYW5jaG9yXSA9IGhvc3RJbnNlcnRTdGF0aWNDb250ZW50KAogICAgICAgICAgbjIuY2hpbGRyZW4sCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBhbmNob3IsCiAgICAgICAgICBuYW1lc3BhY2UKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIG4yLmVsID0gbjEuZWw7CiAgICAgICAgbjIuYW5jaG9yID0gbjEuYW5jaG9yOwogICAgICB9CiAgICB9OwogICAgY29uc3QgbW92ZVN0YXRpY05vZGUgPSAoeyBlbCwgYW5jaG9yIH0sIGNvbnRhaW5lciwgbmV4dFNpYmxpbmcpID0+IHsKICAgICAgbGV0IG5leHQ7CiAgICAgIHdoaWxlIChlbCAmJiBlbCAhPT0gYW5jaG9yKSB7CiAgICAgICAgbmV4dCA9IGhvc3ROZXh0U2libGluZyhlbCk7CiAgICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBuZXh0U2libGluZyk7CiAgICAgICAgZWwgPSBuZXh0OwogICAgICB9CiAgICAgIGhvc3RJbnNlcnQoYW5jaG9yLCBjb250YWluZXIsIG5leHRTaWJsaW5nKTsKICAgIH07CiAgICBjb25zdCByZW1vdmVTdGF0aWNOb2RlID0gKHsgZWwsIGFuY2hvciB9KSA9PiB7CiAgICAgIGxldCBuZXh0OwogICAgICB3aGlsZSAoZWwgJiYgZWwgIT09IGFuY2hvcikgewogICAgICAgIG5leHQgPSBob3N0TmV4dFNpYmxpbmcoZWwpOwogICAgICAgIGhvc3RSZW1vdmUoZWwpOwogICAgICAgIGVsID0gbmV4dDsKICAgICAgfQogICAgICBob3N0UmVtb3ZlKGFuY2hvcik7CiAgICB9OwogICAgY29uc3QgcHJvY2Vzc0VsZW1lbnQgPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gewogICAgICBpZiAobjIudHlwZSA9PT0gInN2ZyIpIHsKICAgICAgICBuYW1lc3BhY2UgPSAic3ZnIjsKICAgICAgfSBlbHNlIGlmIChuMi50eXBlID09PSAibWF0aCIpIHsKICAgICAgICBuYW1lc3BhY2UgPSAibWF0aG1sIjsKICAgICAgfQogICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgIG1vdW50RWxlbWVudCgKICAgICAgICAgIG4yLAogICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgYW5jaG9yLAogICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHBhdGNoRWxlbWVudCgKICAgICAgICAgIG4xLAogICAgICAgICAgbjIsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBtb3VudEVsZW1lbnQgPSAodm5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgIGxldCBlbDsKICAgICAgbGV0IHZub2RlSG9vazsKICAgICAgY29uc3QgeyBwcm9wcywgc2hhcGVGbGFnLCB0cmFuc2l0aW9uLCBkaXJzIH0gPSB2bm9kZTsKICAgICAgZWwgPSB2bm9kZS5lbCA9IGhvc3RDcmVhdGVFbGVtZW50KAogICAgICAgIHZub2RlLnR5cGUsCiAgICAgICAgbmFtZXNwYWNlLAogICAgICAgIHByb3BzICYmIHByb3BzLmlzLAogICAgICAgIHByb3BzCiAgICAgICk7CiAgICAgIGlmIChzaGFwZUZsYWcgJiA4KSB7CiAgICAgICAgaG9zdFNldEVsZW1lbnRUZXh0KGVsLCB2bm9kZS5jaGlsZHJlbik7CiAgICAgIH0gZWxzZSBpZiAoc2hhcGVGbGFnICYgMTYpIHsKICAgICAgICBtb3VudENoaWxkcmVuKAogICAgICAgICAgdm5vZGUuY2hpbGRyZW4sCiAgICAgICAgICBlbCwKICAgICAgICAgIG51bGwsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIHJlc29sdmVDaGlsZHJlbk5hbWVzcGFjZSh2bm9kZSwgbmFtZXNwYWNlKSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKGRpcnMpIHsKICAgICAgICBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJjcmVhdGVkIik7CiAgICAgIH0KICAgICAgc2V0U2NvcGVJZChlbCwgdm5vZGUsIHZub2RlLnNjb3BlSWQsIHNsb3RTY29wZUlkcywgcGFyZW50Q29tcG9uZW50KTsKICAgICAgaWYgKHByb3BzKSB7CiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgIGlmIChrZXkgIT09ICJ2YWx1ZSIgJiYgIWlzUmVzZXJ2ZWRQcm9wKGtleSkpIHsKICAgICAgICAgICAgaG9zdFBhdGNoUHJvcCgKICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBwcm9wc1trZXldLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICB2bm9kZS5jaGlsZHJlbiwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgdW5tb3VudENoaWxkcmVuCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgidmFsdWUiIGluIHByb3BzKSB7CiAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCAidmFsdWUiLCBudWxsLCBwcm9wcy52YWx1ZSwgbmFtZXNwYWNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZub2RlSG9vayA9IHByb3BzLm9uVm5vZGVCZWZvcmVNb3VudCkgewogICAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCB2bm9kZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWwsICJfX3Zub2RlIiwgewogICAgICAgICAgdmFsdWU6IHZub2RlLAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWwsICJfX3Z1ZVBhcmVudENvbXBvbmVudCIsIHsKICAgICAgICAgIHZhbHVlOiBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAiYmVmb3JlTW91bnQiKTsKICAgICAgfQogICAgICBjb25zdCBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyA9IG5lZWRUcmFuc2l0aW9uKHBhcmVudFN1c3BlbnNlLCB0cmFuc2l0aW9uKTsKICAgICAgaWYgKG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzKSB7CiAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihlbCk7CiAgICAgIH0KICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICBpZiAoKHZub2RlSG9vayA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVNb3VudGVkKSB8fCBuZWVkQ2FsbFRyYW5zaXRpb25Ib29rcyB8fCBkaXJzKSB7CiAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICAgIHZub2RlSG9vayAmJiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsKICAgICAgICAgIG5lZWRDYWxsVHJhbnNpdGlvbkhvb2tzICYmIHRyYW5zaXRpb24uZW50ZXIoZWwpOwogICAgICAgICAgZGlycyAmJiBpbnZva2VEaXJlY3RpdmVIb29rKHZub2RlLCBudWxsLCBwYXJlbnRDb21wb25lbnQsICJtb3VudGVkIik7CiAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOwogICAgICB9CiAgICB9OwogICAgY29uc3Qgc2V0U2NvcGVJZCA9IChlbCwgdm5vZGUsIHNjb3BlSWQsIHNsb3RTY29wZUlkcywgcGFyZW50Q29tcG9uZW50KSA9PiB7CiAgICAgIGlmIChzY29wZUlkKSB7CiAgICAgICAgaG9zdFNldFNjb3BlSWQoZWwsIHNjb3BlSWQpOwogICAgICB9CiAgICAgIGlmIChzbG90U2NvcGVJZHMpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNsb3RTY29wZUlkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaG9zdFNldFNjb3BlSWQoZWwsIHNsb3RTY29wZUlkc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICBsZXQgc3ViVHJlZSA9IHBhcmVudENvbXBvbmVudC5zdWJUcmVlOwogICAgICAgIGlmIChzdWJUcmVlLnBhdGNoRmxhZyA+IDAgJiYgc3ViVHJlZS5wYXRjaEZsYWcgJiAyMDQ4KSB7CiAgICAgICAgICBzdWJUcmVlID0gZmlsdGVyU2luZ2xlUm9vdChzdWJUcmVlLmNoaWxkcmVuKSB8fCBzdWJUcmVlOwogICAgICAgIH0KICAgICAgICBpZiAodm5vZGUgPT09IHN1YlRyZWUpIHsKICAgICAgICAgIGNvbnN0IHBhcmVudFZOb2RlID0gcGFyZW50Q29tcG9uZW50LnZub2RlOwogICAgICAgICAgc2V0U2NvcGVJZCgKICAgICAgICAgICAgZWwsCiAgICAgICAgICAgIHBhcmVudFZOb2RlLAogICAgICAgICAgICBwYXJlbnRWTm9kZS5zY29wZUlkLAogICAgICAgICAgICBwYXJlbnRWTm9kZS5zbG90U2NvcGVJZHMsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudC5wYXJlbnQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgY29uc3QgbW91bnRDaGlsZHJlbiA9IChjaGlsZHJlbiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQsIHN0YXJ0ID0gMCkgPT4gewogICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV0gPSBvcHRpbWl6ZWQgPyBjbG9uZUlmTW91bnRlZChjaGlsZHJlbltpXSkgOiBub3JtYWxpemVWTm9kZShjaGlsZHJlbltpXSk7CiAgICAgICAgcGF0Y2goCiAgICAgICAgICBudWxsLAogICAgICAgICAgY2hpbGQsCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBhbmNob3IsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwYXRjaEVsZW1lbnQgPSAobjEsIG4yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgIGNvbnN0IGVsID0gbjIuZWwgPSBuMS5lbDsKICAgICAgbGV0IHsgcGF0Y2hGbGFnLCBkeW5hbWljQ2hpbGRyZW4sIGRpcnMgfSA9IG4yOwogICAgICBwYXRjaEZsYWcgfD0gbjEucGF0Y2hGbGFnICYgMTY7CiAgICAgIGNvbnN0IG9sZFByb3BzID0gbjEucHJvcHMgfHwgRU1QVFlfT0JKOwogICAgICBjb25zdCBuZXdQcm9wcyA9IG4yLnByb3BzIHx8IEVNUFRZX09CSjsKICAgICAgbGV0IHZub2RlSG9vazsKICAgICAgcGFyZW50Q29tcG9uZW50ICYmIHRvZ2dsZVJlY3Vyc2UocGFyZW50Q29tcG9uZW50LCBmYWxzZSk7CiAgICAgIGlmICh2bm9kZUhvb2sgPSBuZXdQcm9wcy5vblZub2RlQmVmb3JlVXBkYXRlKSB7CiAgICAgICAgaW52b2tlVk5vZGVIb29rKHZub2RlSG9vaywgcGFyZW50Q29tcG9uZW50LCBuMiwgbjEpOwogICAgICB9CiAgICAgIGlmIChkaXJzKSB7CiAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayhuMiwgbjEsIHBhcmVudENvbXBvbmVudCwgImJlZm9yZVVwZGF0ZSIpOwogICAgICB9CiAgICAgIHBhcmVudENvbXBvbmVudCAmJiB0b2dnbGVSZWN1cnNlKHBhcmVudENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgIGlmIChpc0htclVwZGF0aW5nKSB7CiAgICAgICAgcGF0Y2hGbGFnID0gMDsKICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICBkeW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICB9CiAgICAgIGlmIChkeW5hbWljQ2hpbGRyZW4pIHsKICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4oCiAgICAgICAgICBuMS5keW5hbWljQ2hpbGRyZW4sCiAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4sCiAgICAgICAgICBlbCwKICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgcmVzb2x2ZUNoaWxkcmVuTmFtZXNwYWNlKG4yLCBuYW1lc3BhY2UpLAogICAgICAgICAgc2xvdFNjb3BlSWRzCiAgICAgICAgKTsKICAgICAgICB7CiAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMik7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCFvcHRpbWl6ZWQpIHsKICAgICAgICBwYXRjaENoaWxkcmVuKAogICAgICAgICAgbjEsCiAgICAgICAgICBuMiwKICAgICAgICAgIGVsLAogICAgICAgICAgbnVsbCwKICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgcmVzb2x2ZUNoaWxkcmVuTmFtZXNwYWNlKG4yLCBuYW1lc3BhY2UpLAogICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChwYXRjaEZsYWcgPiAwKSB7CiAgICAgICAgaWYgKHBhdGNoRmxhZyAmIDE2KSB7CiAgICAgICAgICBwYXRjaFByb3BzKAogICAgICAgICAgICBlbCwKICAgICAgICAgICAgbjIsCiAgICAgICAgICAgIG9sZFByb3BzLAogICAgICAgICAgICBuZXdQcm9wcywKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAocGF0Y2hGbGFnICYgMikgewogICAgICAgICAgICBpZiAob2xkUHJvcHMuY2xhc3MgIT09IG5ld1Byb3BzLmNsYXNzKSB7CiAgICAgICAgICAgICAgaG9zdFBhdGNoUHJvcChlbCwgImNsYXNzIiwgbnVsbCwgbmV3UHJvcHMuY2xhc3MsIG5hbWVzcGFjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXRjaEZsYWcgJiA0KSB7CiAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoZWwsICJzdHlsZSIsIG9sZFByb3BzLnN0eWxlLCBuZXdQcm9wcy5zdHlsZSwgbmFtZXNwYWNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXRjaEZsYWcgJiA4KSB7CiAgICAgICAgICAgIGNvbnN0IHByb3BzVG9VcGRhdGUgPSBuMi5keW5hbWljUHJvcHM7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHNUb1VwZGF0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGtleSA9IHByb3BzVG9VcGRhdGVbaV07CiAgICAgICAgICAgICAgY29uc3QgcHJldiA9IG9sZFByb3BzW2tleV07CiAgICAgICAgICAgICAgY29uc3QgbmV4dCA9IG5ld1Byb3BzW2tleV07CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IHByZXYgfHwga2V5ID09PSAidmFsdWUiKSB7CiAgICAgICAgICAgICAgICBob3N0UGF0Y2hQcm9wKAogICAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgICAgICBwcmV2LAogICAgICAgICAgICAgICAgICBuZXh0LAogICAgICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgICAgIG4xLmNoaWxkcmVuLAogICAgICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4KICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwYXRjaEZsYWcgJiAxKSB7CiAgICAgICAgICBpZiAobjEuY2hpbGRyZW4gIT09IG4yLmNoaWxkcmVuKSB7CiAgICAgICAgICAgIGhvc3RTZXRFbGVtZW50VGV4dChlbCwgbjIuY2hpbGRyZW4pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICghb3B0aW1pemVkICYmIGR5bmFtaWNDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgcGF0Y2hQcm9wcygKICAgICAgICAgIGVsLAogICAgICAgICAgbjIsCiAgICAgICAgICBvbGRQcm9wcywKICAgICAgICAgIG5ld1Byb3BzLAogICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICBuYW1lc3BhY2UKICAgICAgICApOwogICAgICB9CiAgICAgIGlmICgodm5vZGVIb29rID0gbmV3UHJvcHMub25Wbm9kZVVwZGF0ZWQpIHx8IGRpcnMpIHsKICAgICAgICBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoKCkgPT4gewogICAgICAgICAgdm5vZGVIb29rICYmIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIHBhcmVudENvbXBvbmVudCwgbjIsIG4xKTsKICAgICAgICAgIGRpcnMgJiYgaW52b2tlRGlyZWN0aXZlSG9vayhuMiwgbjEsIHBhcmVudENvbXBvbmVudCwgInVwZGF0ZWQiKTsKICAgICAgICB9LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwYXRjaEJsb2NrQ2hpbGRyZW4gPSAob2xkQ2hpbGRyZW4sIG5ld0NoaWxkcmVuLCBmYWxsYmFja0NvbnRhaW5lciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMpID0+IHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG9sZFZOb2RlID0gb2xkQ2hpbGRyZW5baV07CiAgICAgICAgY29uc3QgbmV3Vk5vZGUgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICBjb25zdCBjb250YWluZXIgPSAoCiAgICAgICAgICAvLyBvbGRWTm9kZSBtYXkgYmUgYW4gZXJyb3JlZCBhc3luYyBzZXR1cCgpIGNvbXBvbmVudCBpbnNpZGUgU3VzcGVuc2UKICAgICAgICAgIC8vIHdoaWNoIHdpbGwgbm90IGhhdmUgYSBtb3VudGVkIGVsZW1lbnQKICAgICAgICAgIG9sZFZOb2RlLmVsICYmIC8vIC0gSW4gdGhlIGNhc2Ugb2YgYSBGcmFnbWVudCwgd2UgbmVlZCB0byBwcm92aWRlIHRoZSBhY3R1YWwgcGFyZW50CiAgICAgICAgICAvLyBvZiB0aGUgRnJhZ21lbnQgaXRzZWxmIHNvIGl0IGNhbiBtb3ZlIGl0cyBjaGlsZHJlbi4KICAgICAgICAgIChvbGRWTm9kZS50eXBlID09PSBGcmFnbWVudCB8fCAvLyAtIEluIHRoZSBjYXNlIG9mIGRpZmZlcmVudCBub2RlcywgdGhlcmUgaXMgZ29pbmcgdG8gYmUgYSByZXBsYWNlbWVudAogICAgICAgICAgLy8gd2hpY2ggYWxzbyByZXF1aXJlcyB0aGUgY29ycmVjdCBwYXJlbnQgY29udGFpbmVyCiAgICAgICAgICAhaXNTYW1lVk5vZGVUeXBlKG9sZFZOb2RlLCBuZXdWTm9kZSkgfHwgLy8gLSBJbiB0aGUgY2FzZSBvZiBhIGNvbXBvbmVudCwgaXQgY291bGQgY29udGFpbiBhbnl0aGluZy4KICAgICAgICAgIG9sZFZOb2RlLnNoYXBlRmxhZyAmICg2IHwgNjQpKSA/IGhvc3RQYXJlbnROb2RlKG9sZFZOb2RlLmVsKSA6ICgKICAgICAgICAgICAgLy8gSW4gb3RoZXIgY2FzZXMsIHRoZSBwYXJlbnQgY29udGFpbmVyIGlzIG5vdCBhY3R1YWxseSB1c2VkIHNvIHdlCiAgICAgICAgICAgIC8vIGp1c3QgcGFzcyB0aGUgYmxvY2sgZWxlbWVudCBoZXJlIHRvIGF2b2lkIGEgRE9NIHBhcmVudE5vZGUgY2FsbC4KICAgICAgICAgICAgZmFsbGJhY2tDb250YWluZXIKICAgICAgICAgICkKICAgICAgICApOwogICAgICAgIHBhdGNoKAogICAgICAgICAgb2xkVk5vZGUsCiAgICAgICAgICBuZXdWTm9kZSwKICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgIG51bGwsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIHRydWUKICAgICAgICApOwogICAgICB9CiAgICB9OwogICAgY29uc3QgcGF0Y2hQcm9wcyA9IChlbCwgdm5vZGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlKSA9PiB7CiAgICAgIGlmIChvbGRQcm9wcyAhPT0gbmV3UHJvcHMpIHsKICAgICAgICBpZiAob2xkUHJvcHMgIT09IEVNUFRZX09CSikgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gb2xkUHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFpc1Jlc2VydmVkUHJvcChrZXkpICYmICEoa2V5IGluIG5ld1Byb3BzKSkgewogICAgICAgICAgICAgIGhvc3RQYXRjaFByb3AoCiAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgICAgIG9sZFByb3BzW2tleV0sCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgICAgdm5vZGUuY2hpbGRyZW4sCiAgICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgICAgIHVubW91bnRDaGlsZHJlbgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gbmV3UHJvcHMpIHsKICAgICAgICAgIGlmIChpc1Jlc2VydmVkUHJvcChrZXkpKQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIGNvbnN0IG5leHQgPSBuZXdQcm9wc1trZXldOwogICAgICAgICAgY29uc3QgcHJldiA9IG9sZFByb3BzW2tleV07CiAgICAgICAgICBpZiAobmV4dCAhPT0gcHJldiAmJiBrZXkgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgaG9zdFBhdGNoUHJvcCgKICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgcHJldiwKICAgICAgICAgICAgICBuZXh0LAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICB2bm9kZS5jaGlsZHJlbiwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgdW5tb3VudENoaWxkcmVuCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgidmFsdWUiIGluIG5ld1Byb3BzKSB7CiAgICAgICAgICBob3N0UGF0Y2hQcm9wKGVsLCAidmFsdWUiLCBvbGRQcm9wcy52YWx1ZSwgbmV3UHJvcHMudmFsdWUsIG5hbWVzcGFjZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgY29uc3QgcHJvY2Vzc0ZyYWdtZW50ID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgY29uc3QgZnJhZ21lbnRTdGFydEFuY2hvciA9IG4yLmVsID0gbjEgPyBuMS5lbCA6IGhvc3RDcmVhdGVUZXh0KCIiKTsKICAgICAgY29uc3QgZnJhZ21lbnRFbmRBbmNob3IgPSBuMi5hbmNob3IgPSBuMSA/IG4xLmFuY2hvciA6IGhvc3RDcmVhdGVUZXh0KCIiKTsKICAgICAgbGV0IHsgcGF0Y2hGbGFnLCBkeW5hbWljQ2hpbGRyZW4sIHNsb3RTY29wZUlkczogZnJhZ21lbnRTbG90U2NvcGVJZHMgfSA9IG4yOwogICAgICBpZiAoCiAgICAgICAgLy8gIzU1MjMgZGV2IHJvb3QgZnJhZ21lbnQgbWF5IGluaGVyaXQgZGlyZWN0aXZlcwogICAgICAgIGlzSG1yVXBkYXRpbmcgfHwgcGF0Y2hGbGFnICYgMjA0OAogICAgICApIHsKICAgICAgICBwYXRjaEZsYWcgPSAwOwogICAgICAgIG9wdGltaXplZCA9IGZhbHNlOwogICAgICAgIGR5bmFtaWNDaGlsZHJlbiA9IG51bGw7CiAgICAgIH0KICAgICAgaWYgKGZyYWdtZW50U2xvdFNjb3BlSWRzKSB7CiAgICAgICAgc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzID8gc2xvdFNjb3BlSWRzLmNvbmNhdChmcmFnbWVudFNsb3RTY29wZUlkcykgOiBmcmFnbWVudFNsb3RTY29wZUlkczsKICAgICAgfQogICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgIGhvc3RJbnNlcnQoZnJhZ21lbnRTdGFydEFuY2hvciwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgIGhvc3RJbnNlcnQoZnJhZ21lbnRFbmRBbmNob3IsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICBtb3VudENoaWxkcmVuKAogICAgICAgICAgLy8gIzEwMDA3CiAgICAgICAgICAvLyBzdWNoIGZyYWdtZW50IGxpa2UgYDw+PC8+YCB3aWxsIGJlIGNvbXBpbGVkIGludG8KICAgICAgICAgIC8vIGEgZnJhZ21lbnQgd2hpY2ggZG9lc24ndCBoYXZlIGEgY2hpbGRyZW4uCiAgICAgICAgICAvLyBJbiB0aGlzIGNhc2UgZmFsbGJhY2sgdG8gYW4gZW1wdHkgYXJyYXkKICAgICAgICAgIG4yLmNoaWxkcmVuIHx8IFtdLAogICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgZnJhZ21lbnRFbmRBbmNob3IsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHBhdGNoRmxhZyA+IDAgJiYgcGF0Y2hGbGFnICYgNjQgJiYgZHluYW1pY0NoaWxkcmVuICYmIC8vICMyNzE1IHRoZSBwcmV2aW91cyBmcmFnbWVudCBjb3VsZCd2ZSBiZWVuIGEgQkFJTGVkIG9uZSBhcyBhIHJlc3VsdAogICAgICAgIC8vIG9mIHJlbmRlclNsb3QoKSB3aXRoIG5vIHZhbGlkIGNoaWxkcmVuCiAgICAgICAgbjEuZHluYW1pY0NoaWxkcmVuKSB7CiAgICAgICAgICBwYXRjaEJsb2NrQ2hpbGRyZW4oCiAgICAgICAgICAgIG4xLmR5bmFtaWNDaGlsZHJlbiwKICAgICAgICAgICAgZHluYW1pY0NoaWxkcmVuLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzCiAgICAgICAgICApOwogICAgICAgICAgewogICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhdGNoQ2hpbGRyZW4oCiAgICAgICAgICAgIG4xLAogICAgICAgICAgICBuMiwKICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICBmcmFnbWVudEVuZEFuY2hvciwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwcm9jZXNzQ29tcG9uZW50ID0gKG4xLCBuMiwgY29udGFpbmVyLCBhbmNob3IsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIG5hbWVzcGFjZSwgc2xvdFNjb3BlSWRzLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgbjIuc2xvdFNjb3BlSWRzID0gc2xvdFNjb3BlSWRzOwogICAgICBpZiAobjEgPT0gbnVsbCkgewogICAgICAgIGlmIChuMi5zaGFwZUZsYWcgJiA1MTIpIHsKICAgICAgICAgIHBhcmVudENvbXBvbmVudC5jdHguYWN0aXZhdGUoCiAgICAgICAgICAgIG4yLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1vdW50Q29tcG9uZW50KAogICAgICAgICAgICBuMiwKICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB1cGRhdGVDb21wb25lbnQobjEsIG4yLCBvcHRpbWl6ZWQpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgbW91bnRDb21wb25lbnQgPSAoaW5pdGlhbFZOb2RlLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgY29uc3QgaW5zdGFuY2UgPSAoaW5pdGlhbFZOb2RlLmNvbXBvbmVudCA9IGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlKAogICAgICAgIGluaXRpYWxWTm9kZSwKICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgcGFyZW50U3VzcGVuc2UKICAgICAgKSk7CiAgICAgIGlmIChpbnN0YW5jZS50eXBlLl9faG1ySWQpIHsKICAgICAgICByZWdpc3RlckhNUihpbnN0YW5jZSk7CiAgICAgIH0KICAgICAgewogICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChpbml0aWFsVk5vZGUpOwogICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYG1vdW50YCk7CiAgICAgIH0KICAgICAgaWYgKGlzS2VlcEFsaXZlKGluaXRpYWxWTm9kZSkpIHsKICAgICAgICBpbnN0YW5jZS5jdHgucmVuZGVyZXIgPSBpbnRlcm5hbHM7CiAgICAgIH0KICAgICAgewogICAgICAgIHsKICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYGluaXRgKTsKICAgICAgICB9CiAgICAgICAgc2V0dXBDb21wb25lbnQoaW5zdGFuY2UpOwogICAgICAgIHsKICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGBpbml0YCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpbnN0YW5jZS5hc3luY0RlcCkgewogICAgICAgIHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnJlZ2lzdGVyRGVwKGluc3RhbmNlLCBzZXR1cFJlbmRlckVmZmVjdCk7CiAgICAgICAgaWYgKCFpbml0aWFsVk5vZGUuZWwpIHsKICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gaW5zdGFuY2Uuc3ViVHJlZSA9IGNyZWF0ZVZOb2RlKENvbW1lbnQpOwogICAgICAgICAgcHJvY2Vzc0NvbW1lbnROb2RlKG51bGwsIHBsYWNlaG9sZGVyLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNldHVwUmVuZGVyRWZmZWN0KAogICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICBpbml0aWFsVk5vZGUsCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBhbmNob3IsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIG9wdGltaXplZAogICAgICAgICk7CiAgICAgIH0KICAgICAgewogICAgICAgIHBvcFdhcm5pbmdDb250ZXh0KCk7CiAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYG1vdW50YCk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCB1cGRhdGVDb21wb25lbnQgPSAobjEsIG4yLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgY29uc3QgaW5zdGFuY2UgPSBuMi5jb21wb25lbnQgPSBuMS5jb21wb25lbnQ7CiAgICAgIGlmIChzaG91bGRVcGRhdGVDb21wb25lbnQobjEsIG4yLCBvcHRpbWl6ZWQpKSB7CiAgICAgICAgaWYgKGluc3RhbmNlLmFzeW5jRGVwICYmICFpbnN0YW5jZS5hc3luY1Jlc29sdmVkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChuMik7CiAgICAgICAgICB9CiAgICAgICAgICB1cGRhdGVDb21wb25lbnRQcmVSZW5kZXIoaW5zdGFuY2UsIG4yLCBvcHRpbWl6ZWQpOwogICAgICAgICAgewogICAgICAgICAgICBwb3BXYXJuaW5nQ29udGV4dCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpbnN0YW5jZS5uZXh0ID0gbjI7CiAgICAgICAgICBpbnZhbGlkYXRlSm9iKGluc3RhbmNlLnVwZGF0ZSk7CiAgICAgICAgICBpbnN0YW5jZS5lZmZlY3QuZGlydHkgPSB0cnVlOwogICAgICAgICAgaW5zdGFuY2UudXBkYXRlKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4yLmVsID0gbjEuZWw7CiAgICAgICAgaW5zdGFuY2Uudm5vZGUgPSBuMjsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHNldHVwUmVuZGVyRWZmZWN0ID0gKGluc3RhbmNlLCBpbml0aWFsVk5vZGUsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBvcHRpbWl6ZWQpID0+IHsKICAgICAgY29uc3QgY29tcG9uZW50VXBkYXRlRm4gPSAoKSA9PiB7CiAgICAgICAgaWYgKCFpbnN0YW5jZS5pc01vdW50ZWQpIHsKICAgICAgICAgIGxldCB2bm9kZUhvb2s7CiAgICAgICAgICBjb25zdCB7IGVsLCBwcm9wcyB9ID0gaW5pdGlhbFZOb2RlOwogICAgICAgICAgY29uc3QgeyBibSwgbSwgcGFyZW50IH0gPSBpbnN0YW5jZTsKICAgICAgICAgIGNvbnN0IGlzQXN5bmNXcmFwcGVyVk5vZGUgPSBpc0FzeW5jV3JhcHBlcihpbml0aWFsVk5vZGUpOwogICAgICAgICAgdG9nZ2xlUmVjdXJzZShpbnN0YW5jZSwgZmFsc2UpOwogICAgICAgICAgaWYgKGJtKSB7CiAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGJtKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNBc3luY1dyYXBwZXJWTm9kZSAmJiAodm5vZGVIb29rID0gcHJvcHMgJiYgcHJvcHMub25Wbm9kZUJlZm9yZU1vdW50KSkgewogICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIGluaXRpYWxWTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0b2dnbGVSZWN1cnNlKGluc3RhbmNlLCB0cnVlKTsKICAgICAgICAgIGlmIChlbCAmJiBoeWRyYXRlTm9kZSkgewogICAgICAgICAgICBjb25zdCBoeWRyYXRlU3ViVHJlZSA9ICgpID0+IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW5zdGFuY2Uuc3ViVHJlZSA9IHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgaHlkcmF0ZWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoeWRyYXRlTm9kZSgKICAgICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgICAgaW5zdGFuY2Uuc3ViVHJlZSwKICAgICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgICBudWxsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgaHlkcmF0ZWApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGlzQXN5bmNXcmFwcGVyVk5vZGUpIHsKICAgICAgICAgICAgICBpbml0aWFsVk5vZGUudHlwZS5fX2FzeW5jTG9hZGVyKCkudGhlbigKICAgICAgICAgICAgICAgIC8vIG5vdGU6IHdlIGFyZSBtb3ZpbmcgdGhlIHJlbmRlciBjYWxsIGludG8gYW4gYXN5bmMgY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAvLyB3aGljaCBtZWFucyBpdCB3b24ndCB0cmFjayBkZXBlbmRlbmNpZXMgLSBidXQgaXQncyBvayBiZWNhdXNlCiAgICAgICAgICAgICAgICAvLyBhIHNlcnZlci1yZW5kZXJlZCBhc3luYyB3cmFwcGVyIGlzIGFscmVhZHkgaW4gcmVzb2x2ZWQgc3RhdGUKICAgICAgICAgICAgICAgIC8vIGFuZCBpdCB3aWxsIG5ldmVyIG5lZWQgdG8gY2hhbmdlLgogICAgICAgICAgICAgICAgKCkgPT4gIWluc3RhbmNlLmlzVW5tb3VudGVkICYmIGh5ZHJhdGVTdWJUcmVlKCkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGh5ZHJhdGVTdWJUcmVlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBzdWJUcmVlID0gaW5zdGFuY2Uuc3ViVHJlZSA9IHJlbmRlckNvbXBvbmVudFJvb3QoaW5zdGFuY2UpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHJlbmRlcmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGBwYXRjaGApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhdGNoKAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgc3ViVHJlZSwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgYW5jaG9yLAogICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZQogICAgICAgICAgICApOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHBhdGNoYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5pdGlhbFZOb2RlLmVsID0gc3ViVHJlZS5lbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdChtLCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzQXN5bmNXcmFwcGVyVk5vZGUgJiYgKHZub2RlSG9vayA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVNb3VudGVkKSkgewogICAgICAgICAgICBjb25zdCBzY29wZWRJbml0aWFsVk5vZGUgPSBpbml0aWFsVk5vZGU7CiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgKICAgICAgICAgICAgICAoKSA9PiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIHNjb3BlZEluaXRpYWxWTm9kZSksCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbml0aWFsVk5vZGUuc2hhcGVGbGFnICYgMjU2IHx8IHBhcmVudCAmJiBpc0FzeW5jV3JhcHBlcihwYXJlbnQudm5vZGUpICYmIHBhcmVudC52bm9kZS5zaGFwZUZsYWcgJiAyNTYpIHsKICAgICAgICAgICAgaW5zdGFuY2UuYSAmJiBxdWV1ZVBvc3RSZW5kZXJFZmZlY3QoaW5zdGFuY2UuYSwgcGFyZW50U3VzcGVuc2UpOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UuaXNNb3VudGVkID0gdHJ1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZGV2dG9vbHNDb21wb25lbnRBZGRlZChpbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpbml0aWFsVk5vZGUgPSBjb250YWluZXIgPSBhbmNob3IgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsZXQgeyBuZXh0LCBidSwgdSwgcGFyZW50LCB2bm9kZSB9ID0gaW5zdGFuY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IG5vbkh5ZHJhdGVkQXN5bmNSb290ID0gbG9jYXRlTm9uSHlkcmF0ZWRBc3luY1Jvb3QoaW5zdGFuY2UpOwogICAgICAgICAgICBpZiAobm9uSHlkcmF0ZWRBc3luY1Jvb3QpIHsKICAgICAgICAgICAgICBpZiAobmV4dCkgewogICAgICAgICAgICAgICAgbmV4dC5lbCA9IHZub2RlLmVsOwogICAgICAgICAgICAgICAgdXBkYXRlQ29tcG9uZW50UHJlUmVuZGVyKGluc3RhbmNlLCBuZXh0LCBvcHRpbWl6ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub25IeWRyYXRlZEFzeW5jUm9vdC5hc3luY0RlcC50aGVuKCgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghaW5zdGFuY2UuaXNVbm1vdW50ZWQpIHsKICAgICAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlRm4oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGxldCBvcmlnaW5OZXh0ID0gbmV4dDsKICAgICAgICAgIGxldCB2bm9kZUhvb2s7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2hXYXJuaW5nQ29udGV4dChuZXh0IHx8IGluc3RhbmNlLnZub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIGZhbHNlKTsKICAgICAgICAgIGlmIChuZXh0KSB7CiAgICAgICAgICAgIG5leHQuZWwgPSB2bm9kZS5lbDsKICAgICAgICAgICAgdXBkYXRlQ29tcG9uZW50UHJlUmVuZGVyKGluc3RhbmNlLCBuZXh0LCBvcHRpbWl6ZWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IHZub2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ1KSB7CiAgICAgICAgICAgIGludm9rZUFycmF5Rm5zKGJ1KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2bm9kZUhvb2sgPSBuZXh0LnByb3BzICYmIG5leHQucHJvcHMub25Wbm9kZUJlZm9yZVVwZGF0ZSkgewogICAgICAgICAgICBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIG5leHQsIHZub2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRvZ2dsZVJlY3Vyc2UoaW5zdGFuY2UsIHRydWUpOwogICAgICAgICAgewogICAgICAgICAgICBzdGFydE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IG5leHRUcmVlID0gcmVuZGVyQ29tcG9uZW50Um9vdChpbnN0YW5jZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVuZE1lYXN1cmUoaW5zdGFuY2UsIGByZW5kZXJgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHByZXZUcmVlID0gaW5zdGFuY2Uuc3ViVHJlZTsKICAgICAgICAgIGluc3RhbmNlLnN1YlRyZWUgPSBuZXh0VHJlZTsKICAgICAgICAgIHsKICAgICAgICAgICAgc3RhcnRNZWFzdXJlKGluc3RhbmNlLCBgcGF0Y2hgKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhdGNoKAogICAgICAgICAgICBwcmV2VHJlZSwKICAgICAgICAgICAgbmV4dFRyZWUsCiAgICAgICAgICAgIC8vIHBhcmVudCBtYXkgaGF2ZSBjaGFuZ2VkIGlmIGl0J3MgaW4gYSB0ZWxlcG9ydAogICAgICAgICAgICBob3N0UGFyZW50Tm9kZShwcmV2VHJlZS5lbCksCiAgICAgICAgICAgIC8vIGFuY2hvciBtYXkgaGF2ZSBjaGFuZ2VkIGlmIGl0J3MgaW4gYSBmcmFnbWVudAogICAgICAgICAgICBnZXROZXh0SG9zdE5vZGUocHJldlRyZWUpLAogICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZQogICAgICAgICAgKTsKICAgICAgICAgIHsKICAgICAgICAgICAgZW5kTWVhc3VyZShpbnN0YW5jZSwgYHBhdGNoYCk7CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0LmVsID0gbmV4dFRyZWUuZWw7CiAgICAgICAgICBpZiAob3JpZ2luTmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVIT0NIb3N0RWwoaW5zdGFuY2UsIG5leHRUcmVlLmVsKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1KSB7CiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCh1LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm5vZGVIb29rID0gbmV4dC5wcm9wcyAmJiBuZXh0LnByb3BzLm9uVm5vZGVVcGRhdGVkKSB7CiAgICAgICAgICAgIHF1ZXVlUG9zdFJlbmRlckVmZmVjdCgKICAgICAgICAgICAgICAoKSA9PiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnQsIG5leHQsIHZub2RlKSwKICAgICAgICAgICAgICBwYXJlbnRTdXNwZW5zZQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBkZXZ0b29sc0NvbXBvbmVudFVwZGF0ZWQoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBwb3BXYXJuaW5nQ29udGV4dCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgY29uc3QgZWZmZWN0ID0gaW5zdGFuY2UuZWZmZWN0ID0gbmV3IFJlYWN0aXZlRWZmZWN0KAogICAgICAgIGNvbXBvbmVudFVwZGF0ZUZuLAogICAgICAgIE5PT1AsCiAgICAgICAgKCkgPT4gcXVldWVKb2IodXBkYXRlKSwKICAgICAgICBpbnN0YW5jZS5zY29wZQogICAgICAgIC8vIHRyYWNrIGl0IGluIGNvbXBvbmVudCdzIGVmZmVjdCBzY29wZQogICAgICApOwogICAgICBjb25zdCB1cGRhdGUgPSBpbnN0YW5jZS51cGRhdGUgPSAoKSA9PiB7CiAgICAgICAgaWYgKGVmZmVjdC5kaXJ0eSkgewogICAgICAgICAgZWZmZWN0LnJ1bigpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgdXBkYXRlLmlkID0gaW5zdGFuY2UudWlkOwogICAgICB0b2dnbGVSZWN1cnNlKGluc3RhbmNlLCB0cnVlKTsKICAgICAgewogICAgICAgIGVmZmVjdC5vblRyYWNrID0gaW5zdGFuY2UucnRjID8gKGUpID0+IGludm9rZUFycmF5Rm5zKGluc3RhbmNlLnJ0YywgZSkgOiB2b2lkIDA7CiAgICAgICAgZWZmZWN0Lm9uVHJpZ2dlciA9IGluc3RhbmNlLnJ0ZyA/IChlKSA9PiBpbnZva2VBcnJheUZucyhpbnN0YW5jZS5ydGcsIGUpIDogdm9pZCAwOwogICAgICAgIHVwZGF0ZS5vd25lckluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgIH0KICAgICAgdXBkYXRlKCk7CiAgICB9OwogICAgY29uc3QgdXBkYXRlQ29tcG9uZW50UHJlUmVuZGVyID0gKGluc3RhbmNlLCBuZXh0Vk5vZGUsIG9wdGltaXplZCkgPT4gewogICAgICBuZXh0Vk5vZGUuY29tcG9uZW50ID0gaW5zdGFuY2U7CiAgICAgIGNvbnN0IHByZXZQcm9wcyA9IGluc3RhbmNlLnZub2RlLnByb3BzOwogICAgICBpbnN0YW5jZS52bm9kZSA9IG5leHRWTm9kZTsKICAgICAgaW5zdGFuY2UubmV4dCA9IG51bGw7CiAgICAgIHVwZGF0ZVByb3BzKGluc3RhbmNlLCBuZXh0Vk5vZGUucHJvcHMsIHByZXZQcm9wcywgb3B0aW1pemVkKTsKICAgICAgdXBkYXRlU2xvdHMoaW5zdGFuY2UsIG5leHRWTm9kZS5jaGlsZHJlbiwgb3B0aW1pemVkKTsKICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICBmbHVzaFByZUZsdXNoQ2JzKGluc3RhbmNlKTsKICAgICAgcmVzZXRUcmFja2luZygpOwogICAgfTsKICAgIGNvbnN0IHBhdGNoQ2hpbGRyZW4gPSAobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCA9IGZhbHNlKSA9PiB7CiAgICAgIGNvbnN0IGMxID0gbjEgJiYgbjEuY2hpbGRyZW47CiAgICAgIGNvbnN0IHByZXZTaGFwZUZsYWcgPSBuMSA/IG4xLnNoYXBlRmxhZyA6IDA7CiAgICAgIGNvbnN0IGMyID0gbjIuY2hpbGRyZW47CiAgICAgIGNvbnN0IHsgcGF0Y2hGbGFnLCBzaGFwZUZsYWcgfSA9IG4yOwogICAgICBpZiAocGF0Y2hGbGFnID4gMCkgewogICAgICAgIGlmIChwYXRjaEZsYWcgJiAxMjgpIHsKICAgICAgICAgIHBhdGNoS2V5ZWRDaGlsZHJlbigKICAgICAgICAgICAgYzEsCiAgICAgICAgICAgIGMyLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgaWYgKHBhdGNoRmxhZyAmIDI1NikgewogICAgICAgICAgcGF0Y2hVbmtleWVkQ2hpbGRyZW4oCiAgICAgICAgICAgIGMxLAogICAgICAgICAgICBjMiwKICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChzaGFwZUZsYWcgJiA4KSB7CiAgICAgICAgaWYgKHByZXZTaGFwZUZsYWcgJiAxNikgewogICAgICAgICAgdW5tb3VudENoaWxkcmVuKGMxLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGMyICE9PSBjMSkgewogICAgICAgICAgaG9zdFNldEVsZW1lbnRUZXh0KGNvbnRhaW5lciwgYzIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocHJldlNoYXBlRmxhZyAmIDE2KSB7CiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTYpIHsKICAgICAgICAgICAgcGF0Y2hLZXllZENoaWxkcmVuKAogICAgICAgICAgICAgIGMxLAogICAgICAgICAgICAgIGMyLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1bm1vdW50Q2hpbGRyZW4oYzEsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAocHJldlNoYXBlRmxhZyAmIDgpIHsKICAgICAgICAgICAgaG9zdFNldEVsZW1lbnRUZXh0KGNvbnRhaW5lciwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDE2KSB7CiAgICAgICAgICAgIG1vdW50Q2hpbGRyZW4oCiAgICAgICAgICAgICAgYzIsCiAgICAgICAgICAgICAgY29udGFpbmVyLAogICAgICAgICAgICAgIGFuY2hvciwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwYXRjaFVua2V5ZWRDaGlsZHJlbiA9IChjMSwgYzIsIGNvbnRhaW5lciwgYW5jaG9yLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBuYW1lc3BhY2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkKSA9PiB7CiAgICAgIGMxID0gYzEgfHwgRU1QVFlfQVJSOwogICAgICBjMiA9IGMyIHx8IEVNUFRZX0FSUjsKICAgICAgY29uc3Qgb2xkTGVuZ3RoID0gYzEubGVuZ3RoOwogICAgICBjb25zdCBuZXdMZW5ndGggPSBjMi5sZW5ndGg7CiAgICAgIGNvbnN0IGNvbW1vbkxlbmd0aCA9IE1hdGgubWluKG9sZExlbmd0aCwgbmV3TGVuZ3RoKTsKICAgICAgbGV0IGk7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBjb21tb25MZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pOwogICAgICAgIHBhdGNoKAogICAgICAgICAgYzFbaV0sCiAgICAgICAgICBuZXh0Q2hpbGQsCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBudWxsLAogICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICApOwogICAgICB9CiAgICAgIGlmIChvbGRMZW5ndGggPiBuZXdMZW5ndGgpIHsKICAgICAgICB1bm1vdW50Q2hpbGRyZW4oCiAgICAgICAgICBjMSwKICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgdHJ1ZSwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgY29tbW9uTGVuZ3RoCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtb3VudENoaWxkcmVuKAogICAgICAgICAgYzIsCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBhbmNob3IsCiAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgIG9wdGltaXplZCwKICAgICAgICAgIGNvbW1vbkxlbmd0aAogICAgICAgICk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBwYXRjaEtleWVkQ2hpbGRyZW4gPSAoYzEsIGMyLCBjb250YWluZXIsIHBhcmVudEFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCkgPT4gewogICAgICBsZXQgaSA9IDA7CiAgICAgIGNvbnN0IGwyID0gYzIubGVuZ3RoOwogICAgICBsZXQgZTEgPSBjMS5sZW5ndGggLSAxOwogICAgICBsZXQgZTIgPSBsMiAtIDE7CiAgICAgIHdoaWxlIChpIDw9IGUxICYmIGkgPD0gZTIpIHsKICAgICAgICBjb25zdCBuMSA9IGMxW2ldOwogICAgICAgIGNvbnN0IG4yID0gYzJbaV0gPSBvcHRpbWl6ZWQgPyBjbG9uZUlmTW91bnRlZChjMltpXSkgOiBub3JtYWxpemVWTm9kZShjMltpXSk7CiAgICAgICAgaWYgKGlzU2FtZVZOb2RlVHlwZShuMSwgbjIpKSB7CiAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgbjEsCiAgICAgICAgICAgIG4yLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpKys7CiAgICAgIH0KICAgICAgd2hpbGUgKGkgPD0gZTEgJiYgaSA8PSBlMikgewogICAgICAgIGNvbnN0IG4xID0gYzFbZTFdOwogICAgICAgIGNvbnN0IG4yID0gYzJbZTJdID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbZTJdKSA6IG5vcm1hbGl6ZVZOb2RlKGMyW2UyXSk7CiAgICAgICAgaWYgKGlzU2FtZVZOb2RlVHlwZShuMSwgbjIpKSB7CiAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgbjEsCiAgICAgICAgICAgIG4yLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBlMS0tOwogICAgICAgIGUyLS07CiAgICAgIH0KICAgICAgaWYgKGkgPiBlMSkgewogICAgICAgIGlmIChpIDw9IGUyKSB7CiAgICAgICAgICBjb25zdCBuZXh0UG9zID0gZTIgKyAxOwogICAgICAgICAgY29uc3QgYW5jaG9yID0gbmV4dFBvcyA8IGwyID8gYzJbbmV4dFBvc10uZWwgOiBwYXJlbnRBbmNob3I7CiAgICAgICAgICB3aGlsZSAoaSA8PSBlMikgewogICAgICAgICAgICBwYXRjaCgKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaSA+IGUyKSB7CiAgICAgICAgd2hpbGUgKGkgPD0gZTEpIHsKICAgICAgICAgIHVubW91bnQoYzFbaV0sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzMSA9IGk7CiAgICAgICAgY29uc3QgczIgPSBpOwogICAgICAgIGNvbnN0IGtleVRvTmV3SW5kZXhNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIGZvciAoaSA9IHMyOyBpIDw9IGUyOyBpKyspIHsKICAgICAgICAgIGNvbnN0IG5leHRDaGlsZCA9IGMyW2ldID0gb3B0aW1pemVkID8gY2xvbmVJZk1vdW50ZWQoYzJbaV0pIDogbm9ybWFsaXplVk5vZGUoYzJbaV0pOwogICAgICAgICAgaWYgKG5leHRDaGlsZC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoa2V5VG9OZXdJbmRleE1hcC5oYXMobmV4dENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgICBgRHVwbGljYXRlIGtleXMgZm91bmQgZHVyaW5nIHVwZGF0ZTpgLAogICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkobmV4dENoaWxkLmtleSksCiAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIGtleXMgYXJlIHVuaXF1ZS5gCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBrZXlUb05ld0luZGV4TWFwLnNldChuZXh0Q2hpbGQua2V5LCBpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGo7CiAgICAgICAgbGV0IHBhdGNoZWQgPSAwOwogICAgICAgIGNvbnN0IHRvQmVQYXRjaGVkID0gZTIgLSBzMiArIDE7CiAgICAgICAgbGV0IG1vdmVkID0gZmFsc2U7CiAgICAgICAgbGV0IG1heE5ld0luZGV4U29GYXIgPSAwOwogICAgICAgIGNvbnN0IG5ld0luZGV4VG9PbGRJbmRleE1hcCA9IG5ldyBBcnJheSh0b0JlUGF0Y2hlZCk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvQmVQYXRjaGVkOyBpKyspCiAgICAgICAgICBuZXdJbmRleFRvT2xkSW5kZXhNYXBbaV0gPSAwOwogICAgICAgIGZvciAoaSA9IHMxOyBpIDw9IGUxOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHByZXZDaGlsZCA9IGMxW2ldOwogICAgICAgICAgaWYgKHBhdGNoZWQgPj0gdG9CZVBhdGNoZWQpIHsKICAgICAgICAgICAgdW5tb3VudChwcmV2Q2hpbGQsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHRydWUpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBuZXdJbmRleDsKICAgICAgICAgIGlmIChwcmV2Q2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgbmV3SW5kZXggPSBrZXlUb05ld0luZGV4TWFwLmdldChwcmV2Q2hpbGQua2V5KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAoaiA9IHMyOyBqIDw9IGUyOyBqKyspIHsKICAgICAgICAgICAgICBpZiAobmV3SW5kZXhUb09sZEluZGV4TWFwW2ogLSBzMl0gPT09IDAgJiYgaXNTYW1lVk5vZGVUeXBlKHByZXZDaGlsZCwgYzJbal0pKSB7CiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IGo7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdJbmRleCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHVubW91bnQocHJldkNoaWxkLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB0cnVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5ld0luZGV4VG9PbGRJbmRleE1hcFtuZXdJbmRleCAtIHMyXSA9IGkgKyAxOwogICAgICAgICAgICBpZiAobmV3SW5kZXggPj0gbWF4TmV3SW5kZXhTb0ZhcikgewogICAgICAgICAgICAgIG1heE5ld0luZGV4U29GYXIgPSBuZXdJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGF0Y2goCiAgICAgICAgICAgICAgcHJldkNoaWxkLAogICAgICAgICAgICAgIGMyW25ld0luZGV4XSwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIHNsb3RTY29wZUlkcywKICAgICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcGF0Y2hlZCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBpbmNyZWFzaW5nTmV3SW5kZXhTZXF1ZW5jZSA9IG1vdmVkID8gZ2V0U2VxdWVuY2UobmV3SW5kZXhUb09sZEluZGV4TWFwKSA6IEVNUFRZX0FSUjsKICAgICAgICBqID0gaW5jcmVhc2luZ05ld0luZGV4U2VxdWVuY2UubGVuZ3RoIC0gMTsKICAgICAgICBmb3IgKGkgPSB0b0JlUGF0Y2hlZCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICBjb25zdCBuZXh0SW5kZXggPSBzMiArIGk7CiAgICAgICAgICBjb25zdCBuZXh0Q2hpbGQgPSBjMltuZXh0SW5kZXhdOwogICAgICAgICAgY29uc3QgYW5jaG9yID0gbmV4dEluZGV4ICsgMSA8IGwyID8gYzJbbmV4dEluZGV4ICsgMV0uZWwgOiBwYXJlbnRBbmNob3I7CiAgICAgICAgICBpZiAobmV3SW5kZXhUb09sZEluZGV4TWFwW2ldID09PSAwKSB7CiAgICAgICAgICAgIHBhdGNoKAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgbmV4dENoaWxkLAogICAgICAgICAgICAgIGNvbnRhaW5lciwKICAgICAgICAgICAgICBhbmNob3IsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1vdmVkKSB7CiAgICAgICAgICAgIGlmIChqIDwgMCB8fCBpICE9PSBpbmNyZWFzaW5nTmV3SW5kZXhTZXF1ZW5jZVtqXSkgewogICAgICAgICAgICAgIG1vdmUobmV4dENoaWxkLCBjb250YWluZXIsIGFuY2hvciwgMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgai0tOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgY29uc3QgbW92ZSA9ICh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IsIG1vdmVUeXBlLCBwYXJlbnRTdXNwZW5zZSA9IG51bGwpID0+IHsKICAgICAgY29uc3QgeyBlbCwgdHlwZSwgdHJhbnNpdGlvbiwgY2hpbGRyZW4sIHNoYXBlRmxhZyB9ID0gdm5vZGU7CiAgICAgIGlmIChzaGFwZUZsYWcgJiA2KSB7CiAgICAgICAgbW92ZSh2bm9kZS5jb21wb25lbnQuc3ViVHJlZSwgY29udGFpbmVyLCBhbmNob3IsIG1vdmVUeXBlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDEyOCkgewogICAgICAgIHZub2RlLnN1c3BlbnNlLm1vdmUoY29udGFpbmVyLCBhbmNob3IsIG1vdmVUeXBlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDY0KSB7CiAgICAgICAgdHlwZS5tb3ZlKHZub2RlLCBjb250YWluZXIsIGFuY2hvciwgaW50ZXJuYWxzKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHR5cGUgPT09IEZyYWdtZW50KSB7CiAgICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG1vdmUoY2hpbGRyZW5baV0sIGNvbnRhaW5lciwgYW5jaG9yLCBtb3ZlVHlwZSk7CiAgICAgICAgfQogICAgICAgIGhvc3RJbnNlcnQodm5vZGUuYW5jaG9yLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0eXBlID09PSBTdGF0aWMpIHsKICAgICAgICBtb3ZlU3RhdGljTm9kZSh2bm9kZSwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBuZWVkVHJhbnNpdGlvbjIgPSBtb3ZlVHlwZSAhPT0gMiAmJiBzaGFwZUZsYWcgJiAxICYmIHRyYW5zaXRpb247CiAgICAgIGlmIChuZWVkVHJhbnNpdGlvbjIpIHsKICAgICAgICBpZiAobW92ZVR5cGUgPT09IDApIHsKICAgICAgICAgIHRyYW5zaXRpb24uYmVmb3JlRW50ZXIoZWwpOwogICAgICAgICAgaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHRyYW5zaXRpb24uZW50ZXIoZWwpLCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IHsgbGVhdmUsIGRlbGF5TGVhdmUsIGFmdGVyTGVhdmUgfSA9IHRyYW5zaXRpb247CiAgICAgICAgICBjb25zdCByZW1vdmUyID0gKCkgPT4gaG9zdEluc2VydChlbCwgY29udGFpbmVyLCBhbmNob3IpOwogICAgICAgICAgY29uc3QgcGVyZm9ybUxlYXZlID0gKCkgPT4gewogICAgICAgICAgICBsZWF2ZShlbCwgKCkgPT4gewogICAgICAgICAgICAgIHJlbW92ZTIoKTsKICAgICAgICAgICAgICBhZnRlckxlYXZlICYmIGFmdGVyTGVhdmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGRlbGF5TGVhdmUpIHsKICAgICAgICAgICAgZGVsYXlMZWF2ZShlbCwgcmVtb3ZlMiwgcGVyZm9ybUxlYXZlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBlcmZvcm1MZWF2ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBob3N0SW5zZXJ0KGVsLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCB1bm1vdW50ID0gKHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSA9IGZhbHNlLCBvcHRpbWl6ZWQgPSBmYWxzZSkgPT4gewogICAgICBjb25zdCB7CiAgICAgICAgdHlwZSwKICAgICAgICBwcm9wcywKICAgICAgICByZWYsCiAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgZHluYW1pY0NoaWxkcmVuLAogICAgICAgIHNoYXBlRmxhZywKICAgICAgICBwYXRjaEZsYWcsCiAgICAgICAgZGlycwogICAgICB9ID0gdm5vZGU7CiAgICAgIGlmIChyZWYgIT0gbnVsbCkgewogICAgICAgIHNldFJlZihyZWYsIG51bGwsIHBhcmVudFN1c3BlbnNlLCB2bm9kZSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgaWYgKHNoYXBlRmxhZyAmIDI1NikgewogICAgICAgIHBhcmVudENvbXBvbmVudC5jdHguZGVhY3RpdmF0ZSh2bm9kZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHNob3VsZEludm9rZURpcnMgPSBzaGFwZUZsYWcgJiAxICYmIGRpcnM7CiAgICAgIGNvbnN0IHNob3VsZEludm9rZVZub2RlSG9vayA9ICFpc0FzeW5jV3JhcHBlcih2bm9kZSk7CiAgICAgIGxldCB2bm9kZUhvb2s7CiAgICAgIGlmIChzaG91bGRJbnZva2VWbm9kZUhvb2sgJiYgKHZub2RlSG9vayA9IHByb3BzICYmIHByb3BzLm9uVm5vZGVCZWZvcmVVbm1vdW50KSkgewogICAgICAgIGludm9rZVZOb2RlSG9vayh2bm9kZUhvb2ssIHBhcmVudENvbXBvbmVudCwgdm5vZGUpOwogICAgICB9CiAgICAgIGlmIChzaGFwZUZsYWcgJiA2KSB7CiAgICAgICAgdW5tb3VudENvbXBvbmVudCh2bm9kZS5jb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHNoYXBlRmxhZyAmIDEyOCkgewogICAgICAgICAgdm5vZGUuc3VzcGVuc2UudW5tb3VudChwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkSW52b2tlRGlycykgewogICAgICAgICAgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAiYmVmb3JlVW5tb3VudCIpOwogICAgICAgIH0KICAgICAgICBpZiAoc2hhcGVGbGFnICYgNjQpIHsKICAgICAgICAgIHZub2RlLnR5cGUucmVtb3ZlKAogICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgb3B0aW1pemVkLAogICAgICAgICAgICBpbnRlcm5hbHMsCiAgICAgICAgICAgIGRvUmVtb3ZlCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAoZHluYW1pY0NoaWxkcmVuICYmIC8vICMxMTUzOiBmYXN0IHBhdGggc2hvdWxkIG5vdCBiZSB0YWtlbiBmb3Igbm9uLXN0YWJsZSAodi1mb3IpIGZyYWdtZW50cwogICAgICAgICh0eXBlICE9PSBGcmFnbWVudCB8fCBwYXRjaEZsYWcgPiAwICYmIHBhdGNoRmxhZyAmIDY0KSkgewogICAgICAgICAgdW5tb3VudENoaWxkcmVuKAogICAgICAgICAgICBkeW5hbWljQ2hpbGRyZW4sCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gRnJhZ21lbnQgJiYgcGF0Y2hGbGFnICYgKDEyOCB8IDI1NikgfHwgIW9wdGltaXplZCAmJiBzaGFwZUZsYWcgJiAxNikgewogICAgICAgICAgdW5tb3VudENoaWxkcmVuKGNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRvUmVtb3ZlKSB7CiAgICAgICAgICByZW1vdmUodm5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc2hvdWxkSW52b2tlVm5vZGVIb29rICYmICh2bm9kZUhvb2sgPSBwcm9wcyAmJiBwcm9wcy5vblZub2RlVW5tb3VudGVkKSB8fCBzaG91bGRJbnZva2VEaXJzKSB7CiAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICAgIHZub2RlSG9vayAmJiBpbnZva2VWTm9kZUhvb2sodm5vZGVIb29rLCBwYXJlbnRDb21wb25lbnQsIHZub2RlKTsKICAgICAgICAgIHNob3VsZEludm9rZURpcnMgJiYgaW52b2tlRGlyZWN0aXZlSG9vayh2bm9kZSwgbnVsbCwgcGFyZW50Q29tcG9uZW50LCAidW5tb3VudGVkIik7CiAgICAgICAgfSwgcGFyZW50U3VzcGVuc2UpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgcmVtb3ZlID0gKHZub2RlKSA9PiB7CiAgICAgIGNvbnN0IHsgdHlwZSwgZWwsIGFuY2hvciwgdHJhbnNpdGlvbiB9ID0gdm5vZGU7CiAgICAgIGlmICh0eXBlID09PSBGcmFnbWVudCkgewogICAgICAgIGlmICh2bm9kZS5wYXRjaEZsYWcgPiAwICYmIHZub2RlLnBhdGNoRmxhZyAmIDIwNDggJiYgdHJhbnNpdGlvbiAmJiAhdHJhbnNpdGlvbi5wZXJzaXN0ZWQpIHsKICAgICAgICAgIHZub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkKSA9PiB7CiAgICAgICAgICAgIGlmIChjaGlsZC50eXBlID09PSBDb21tZW50KSB7CiAgICAgICAgICAgICAgaG9zdFJlbW92ZShjaGlsZC5lbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVtb3ZlKGNoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbW92ZUZyYWdtZW50KGVsLCBhbmNob3IpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHR5cGUgPT09IFN0YXRpYykgewogICAgICAgIHJlbW92ZVN0YXRpY05vZGUodm5vZGUpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBwZXJmb3JtUmVtb3ZlID0gKCkgPT4gewogICAgICAgIGhvc3RSZW1vdmUoZWwpOwogICAgICAgIGlmICh0cmFuc2l0aW9uICYmICF0cmFuc2l0aW9uLnBlcnNpc3RlZCAmJiB0cmFuc2l0aW9uLmFmdGVyTGVhdmUpIHsKICAgICAgICAgIHRyYW5zaXRpb24uYWZ0ZXJMZWF2ZSgpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEgJiYgdHJhbnNpdGlvbiAmJiAhdHJhbnNpdGlvbi5wZXJzaXN0ZWQpIHsKICAgICAgICBjb25zdCB7IGxlYXZlLCBkZWxheUxlYXZlIH0gPSB0cmFuc2l0aW9uOwogICAgICAgIGNvbnN0IHBlcmZvcm1MZWF2ZSA9ICgpID0+IGxlYXZlKGVsLCBwZXJmb3JtUmVtb3ZlKTsKICAgICAgICBpZiAoZGVsYXlMZWF2ZSkgewogICAgICAgICAgZGVsYXlMZWF2ZSh2bm9kZS5lbCwgcGVyZm9ybVJlbW92ZSwgcGVyZm9ybUxlYXZlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGVyZm9ybUxlYXZlKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHBlcmZvcm1SZW1vdmUoKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHJlbW92ZUZyYWdtZW50ID0gKGN1ciwgZW5kKSA9PiB7CiAgICAgIGxldCBuZXh0OwogICAgICB3aGlsZSAoY3VyICE9PSBlbmQpIHsKICAgICAgICBuZXh0ID0gaG9zdE5leHRTaWJsaW5nKGN1cik7CiAgICAgICAgaG9zdFJlbW92ZShjdXIpOwogICAgICAgIGN1ciA9IG5leHQ7CiAgICAgIH0KICAgICAgaG9zdFJlbW92ZShlbmQpOwogICAgfTsKICAgIGNvbnN0IHVubW91bnRDb21wb25lbnQgPSAoaW5zdGFuY2UsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSkgPT4gewogICAgICBpZiAoaW5zdGFuY2UudHlwZS5fX2htcklkKSB7CiAgICAgICAgdW5yZWdpc3RlckhNUihpbnN0YW5jZSk7CiAgICAgIH0KICAgICAgY29uc3QgeyBidW0sIHNjb3BlLCB1cGRhdGUsIHN1YlRyZWUsIHVtIH0gPSBpbnN0YW5jZTsKICAgICAgaWYgKGJ1bSkgewogICAgICAgIGludm9rZUFycmF5Rm5zKGJ1bSk7CiAgICAgIH0KICAgICAgc2NvcGUuc3RvcCgpOwogICAgICBpZiAodXBkYXRlKSB7CiAgICAgICAgdXBkYXRlLmFjdGl2ZSA9IGZhbHNlOwogICAgICAgIHVubW91bnQoc3ViVHJlZSwgaW5zdGFuY2UsIHBhcmVudFN1c3BlbnNlLCBkb1JlbW92ZSk7CiAgICAgIH0KICAgICAgaWYgKHVtKSB7CiAgICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KHVtLCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgIH0KICAgICAgcXVldWVQb3N0UmVuZGVyRWZmZWN0KCgpID0+IHsKICAgICAgICBpbnN0YW5jZS5pc1VubW91bnRlZCA9IHRydWU7CiAgICAgIH0sIHBhcmVudFN1c3BlbnNlKTsKICAgICAgaWYgKHBhcmVudFN1c3BlbnNlICYmIHBhcmVudFN1c3BlbnNlLnBlbmRpbmdCcmFuY2ggJiYgIXBhcmVudFN1c3BlbnNlLmlzVW5tb3VudGVkICYmIGluc3RhbmNlLmFzeW5jRGVwICYmICFpbnN0YW5jZS5hc3luY1Jlc29sdmVkICYmIGluc3RhbmNlLnN1c3BlbnNlSWQgPT09IHBhcmVudFN1c3BlbnNlLnBlbmRpbmdJZCkgewogICAgICAgIHBhcmVudFN1c3BlbnNlLmRlcHMtLTsKICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UuZGVwcyA9PT0gMCkgewogICAgICAgICAgcGFyZW50U3VzcGVuc2UucmVzb2x2ZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICB7CiAgICAgICAgZGV2dG9vbHNDb21wb25lbnRSZW1vdmVkKGluc3RhbmNlKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHVubW91bnRDaGlsZHJlbiA9IChjaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgZG9SZW1vdmUgPSBmYWxzZSwgb3B0aW1pemVkID0gZmFsc2UsIHN0YXJ0ID0gMCkgPT4gewogICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgIHVubW91bnQoY2hpbGRyZW5baV0sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIGRvUmVtb3ZlLCBvcHRpbWl6ZWQpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgZ2V0TmV4dEhvc3ROb2RlID0gKHZub2RlKSA9PiB7CiAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiA2KSB7CiAgICAgICAgcmV0dXJuIGdldE5leHRIb3N0Tm9kZSh2bm9kZS5jb21wb25lbnQuc3ViVHJlZSk7CiAgICAgIH0KICAgICAgaWYgKHZub2RlLnNoYXBlRmxhZyAmIDEyOCkgewogICAgICAgIHJldHVybiB2bm9kZS5zdXNwZW5zZS5uZXh0KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGhvc3ROZXh0U2libGluZyh2bm9kZS5hbmNob3IgfHwgdm5vZGUuZWwpOwogICAgfTsKICAgIGxldCBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICBjb25zdCByZW5kZXIgPSAodm5vZGUsIGNvbnRhaW5lciwgbmFtZXNwYWNlKSA9PiB7CiAgICAgIGlmICh2bm9kZSA9PSBudWxsKSB7CiAgICAgICAgaWYgKGNvbnRhaW5lci5fdm5vZGUpIHsKICAgICAgICAgIHVubW91bnQoY29udGFpbmVyLl92bm9kZSwgbnVsbCwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHBhdGNoKAogICAgICAgICAgY29udGFpbmVyLl92bm9kZSB8fCBudWxsLAogICAgICAgICAgdm5vZGUsCiAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICBudWxsLAogICAgICAgICAgbnVsbCwKICAgICAgICAgIG51bGwsCiAgICAgICAgICBuYW1lc3BhY2UKICAgICAgICApOwogICAgICB9CiAgICAgIGlmICghaXNGbHVzaGluZykgewogICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgICAgIGZsdXNoUHJlRmx1c2hDYnMoKTsKICAgICAgICBmbHVzaFBvc3RGbHVzaENicygpOwogICAgICAgIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgfQogICAgICBjb250YWluZXIuX3Zub2RlID0gdm5vZGU7CiAgICB9OwogICAgY29uc3QgaW50ZXJuYWxzID0gewogICAgICBwOiBwYXRjaCwKICAgICAgdW06IHVubW91bnQsCiAgICAgIG06IG1vdmUsCiAgICAgIHI6IHJlbW92ZSwKICAgICAgbXQ6IG1vdW50Q29tcG9uZW50LAogICAgICBtYzogbW91bnRDaGlsZHJlbiwKICAgICAgcGM6IHBhdGNoQ2hpbGRyZW4sCiAgICAgIHBiYzogcGF0Y2hCbG9ja0NoaWxkcmVuLAogICAgICBuOiBnZXROZXh0SG9zdE5vZGUsCiAgICAgIG86IG9wdGlvbnMKICAgIH07CiAgICBsZXQgaHlkcmF0ZTsKICAgIGxldCBoeWRyYXRlTm9kZTsKICAgIGlmIChjcmVhdGVIeWRyYXRpb25GbnMpIHsKICAgICAgW2h5ZHJhdGUsIGh5ZHJhdGVOb2RlXSA9IGNyZWF0ZUh5ZHJhdGlvbkZucygKICAgICAgICBpbnRlcm5hbHMKICAgICAgKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHJlbmRlciwKICAgICAgaHlkcmF0ZSwKICAgICAgY3JlYXRlQXBwOiBjcmVhdGVBcHBBUEkocmVuZGVyLCBoeWRyYXRlKQogICAgfTsKICB9CiAgZnVuY3Rpb24gcmVzb2x2ZUNoaWxkcmVuTmFtZXNwYWNlKHsgdHlwZSwgcHJvcHMgfSwgY3VycmVudE5hbWVzcGFjZSkgewogICAgcmV0dXJuIGN1cnJlbnROYW1lc3BhY2UgPT09ICJzdmciICYmIHR5cGUgPT09ICJmb3JlaWduT2JqZWN0IiB8fCBjdXJyZW50TmFtZXNwYWNlID09PSAibWF0aG1sIiAmJiB0eXBlID09PSAiYW5ub3RhdGlvbi14bWwiICYmIHByb3BzICYmIHByb3BzLmVuY29kaW5nICYmIHByb3BzLmVuY29kaW5nLmluY2x1ZGVzKCJodG1sIikgPyB2b2lkIDAgOiBjdXJyZW50TmFtZXNwYWNlOwogIH0KICBmdW5jdGlvbiB0b2dnbGVSZWN1cnNlKHsgZWZmZWN0LCB1cGRhdGUgfSwgYWxsb3dlZCkgewogICAgZWZmZWN0LmFsbG93UmVjdXJzZSA9IHVwZGF0ZS5hbGxvd1JlY3Vyc2UgPSBhbGxvd2VkOwogIH0KICBmdW5jdGlvbiBuZWVkVHJhbnNpdGlvbihwYXJlbnRTdXNwZW5zZSwgdHJhbnNpdGlvbikgewogICAgcmV0dXJuICghcGFyZW50U3VzcGVuc2UgfHwgcGFyZW50U3VzcGVuc2UgJiYgIXBhcmVudFN1c3BlbnNlLnBlbmRpbmdCcmFuY2gpICYmIHRyYW5zaXRpb24gJiYgIXRyYW5zaXRpb24ucGVyc2lzdGVkOwogIH0KICBmdW5jdGlvbiB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMiwgc2hhbGxvdyA9IGZhbHNlKSB7CiAgICBjb25zdCBjaDEgPSBuMS5jaGlsZHJlbjsKICAgIGNvbnN0IGNoMiA9IG4yLmNoaWxkcmVuOwogICAgaWYgKGlzQXJyYXkoY2gxKSAmJiBpc0FycmF5KGNoMikpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaDEubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjMSA9IGNoMVtpXTsKICAgICAgICBsZXQgYzIgPSBjaDJbaV07CiAgICAgICAgaWYgKGMyLnNoYXBlRmxhZyAmIDEgJiYgIWMyLmR5bmFtaWNDaGlsZHJlbikgewogICAgICAgICAgaWYgKGMyLnBhdGNoRmxhZyA8PSAwIHx8IGMyLnBhdGNoRmxhZyA9PT0gMzIpIHsKICAgICAgICAgICAgYzIgPSBjaDJbaV0gPSBjbG9uZUlmTW91bnRlZChjaDJbaV0pOwogICAgICAgICAgICBjMi5lbCA9IGMxLmVsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzaGFsbG93KQogICAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKGMxLCBjMik7CiAgICAgICAgfQogICAgICAgIGlmIChjMi50eXBlID09PSBUZXh0KSB7CiAgICAgICAgICBjMi5lbCA9IGMxLmVsOwogICAgICAgIH0KICAgICAgICBpZiAoYzIudHlwZSA9PT0gQ29tbWVudCAmJiAhYzIuZWwpIHsKICAgICAgICAgIGMyLmVsID0gYzEuZWw7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFNlcXVlbmNlKGFycikgewogICAgY29uc3QgcCA9IGFyci5zbGljZSgpOwogICAgY29uc3QgcmVzdWx0ID0gWzBdOwogICAgbGV0IGksIGosIHUsIHYsIGM7CiAgICBjb25zdCBsZW4gPSBhcnIubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIGNvbnN0IGFyckkgPSBhcnJbaV07CiAgICAgIGlmIChhcnJJICE9PSAwKSB7CiAgICAgICAgaiA9IHJlc3VsdFtyZXN1bHQubGVuZ3RoIC0gMV07CiAgICAgICAgaWYgKGFycltqXSA8IGFyckkpIHsKICAgICAgICAgIHBbaV0gPSBqOwogICAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgdSA9IDA7CiAgICAgICAgdiA9IHJlc3VsdC5sZW5ndGggLSAxOwogICAgICAgIHdoaWxlICh1IDwgdikgewogICAgICAgICAgYyA9IHUgKyB2ID4+IDE7CiAgICAgICAgICBpZiAoYXJyW3Jlc3VsdFtjXV0gPCBhcnJJKSB7CiAgICAgICAgICAgIHUgPSBjICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHYgPSBjOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYXJySSA8IGFycltyZXN1bHRbdV1dKSB7CiAgICAgICAgICBpZiAodSA+IDApIHsKICAgICAgICAgICAgcFtpXSA9IHJlc3VsdFt1IC0gMV07CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRbdV0gPSBpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdSA9IHJlc3VsdC5sZW5ndGg7CiAgICB2ID0gcmVzdWx0W3UgLSAxXTsKICAgIHdoaWxlICh1LS0gPiAwKSB7CiAgICAgIHJlc3VsdFt1XSA9IHY7CiAgICAgIHYgPSBwW3ZdOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gbG9jYXRlTm9uSHlkcmF0ZWRBc3luY1Jvb3QoaW5zdGFuY2UpIHsKICAgIGNvbnN0IHN1YkNvbXBvbmVudCA9IGluc3RhbmNlLnN1YlRyZWUuY29tcG9uZW50OwogICAgaWYgKHN1YkNvbXBvbmVudCkgewogICAgICBpZiAoc3ViQ29tcG9uZW50LmFzeW5jRGVwICYmICFzdWJDb21wb25lbnQuYXN5bmNSZXNvbHZlZCkgewogICAgICAgIHJldHVybiBzdWJDb21wb25lbnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxvY2F0ZU5vbkh5ZHJhdGVkQXN5bmNSb290KHN1YkNvbXBvbmVudCk7CiAgICAgIH0KICAgIH0KICB9CgogIGNvbnN0IGlzVGVsZXBvcnQgPSAodHlwZSkgPT4gdHlwZS5fX2lzVGVsZXBvcnQ7CiAgY29uc3QgaXNUZWxlcG9ydERpc2FibGVkID0gKHByb3BzKSA9PiBwcm9wcyAmJiAocHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMuZGlzYWJsZWQgPT09ICIiKTsKICBjb25zdCBpc1RhcmdldFNWRyA9ICh0YXJnZXQpID0+IHR5cGVvZiBTVkdFbGVtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0YXJnZXQgaW5zdGFuY2VvZiBTVkdFbGVtZW50OwogIGNvbnN0IGlzVGFyZ2V0TWF0aE1MID0gKHRhcmdldCkgPT4gdHlwZW9mIE1hdGhNTEVsZW1lbnQgPT09ICJmdW5jdGlvbiIgJiYgdGFyZ2V0IGluc3RhbmNlb2YgTWF0aE1MRWxlbWVudDsKICBjb25zdCByZXNvbHZlVGFyZ2V0ID0gKHByb3BzLCBzZWxlY3QpID0+IHsKICAgIGNvbnN0IHRhcmdldFNlbGVjdG9yID0gcHJvcHMgJiYgcHJvcHMudG87CiAgICBpZiAoaXNTdHJpbmcodGFyZ2V0U2VsZWN0b3IpKSB7CiAgICAgIGlmICghc2VsZWN0KSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYEN1cnJlbnQgcmVuZGVyZXIgZG9lcyBub3Qgc3VwcG9ydCBzdHJpbmcgdGFyZ2V0IGZvciBUZWxlcG9ydHMuIChtaXNzaW5nIHF1ZXJ5U2VsZWN0b3IgcmVuZGVyZXIgb3B0aW9uKWAKICAgICAgICApOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHRhcmdldCA9IHNlbGVjdCh0YXJnZXRTZWxlY3Rvcik7CiAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgYEZhaWxlZCB0byBsb2NhdGUgVGVsZXBvcnQgdGFyZ2V0IHdpdGggc2VsZWN0b3IgIiR7dGFyZ2V0U2VsZWN0b3J9Ii4gTm90ZSB0aGUgdGFyZ2V0IGVsZW1lbnQgbXVzdCBleGlzdCBiZWZvcmUgdGhlIGNvbXBvbmVudCBpcyBtb3VudGVkIC0gaS5lLiB0aGUgdGFyZ2V0IGNhbm5vdCBiZSByZW5kZXJlZCBieSB0aGUgY29tcG9uZW50IGl0c2VsZiwgYW5kIGlkZWFsbHkgc2hvdWxkIGJlIG91dHNpZGUgb2YgdGhlIGVudGlyZSBWdWUgY29tcG9uZW50IHRyZWUuYAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKCF0YXJnZXRTZWxlY3RvciAmJiAhaXNUZWxlcG9ydERpc2FibGVkKHByb3BzKSkgewogICAgICAgIHdhcm4kMShgSW52YWxpZCBUZWxlcG9ydCB0YXJnZXQ6ICR7dGFyZ2V0U2VsZWN0b3J9YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldFNlbGVjdG9yOwogICAgfQogIH07CiAgY29uc3QgVGVsZXBvcnRJbXBsID0gewogICAgbmFtZTogIlRlbGVwb3J0IiwKICAgIF9faXNUZWxlcG9ydDogdHJ1ZSwKICAgIHByb2Nlc3MobjEsIG4yLCBjb250YWluZXIsIGFuY2hvciwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSwgbmFtZXNwYWNlLCBzbG90U2NvcGVJZHMsIG9wdGltaXplZCwgaW50ZXJuYWxzKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBtYzogbW91bnRDaGlsZHJlbiwKICAgICAgICBwYzogcGF0Y2hDaGlsZHJlbiwKICAgICAgICBwYmM6IHBhdGNoQmxvY2tDaGlsZHJlbiwKICAgICAgICBvOiB7IGluc2VydCwgcXVlcnlTZWxlY3RvciwgY3JlYXRlVGV4dCwgY3JlYXRlQ29tbWVudCB9CiAgICAgIH0gPSBpbnRlcm5hbHM7CiAgICAgIGNvbnN0IGRpc2FibGVkID0gaXNUZWxlcG9ydERpc2FibGVkKG4yLnByb3BzKTsKICAgICAgbGV0IHsgc2hhcGVGbGFnLCBjaGlsZHJlbiwgZHluYW1pY0NoaWxkcmVuIH0gPSBuMjsKICAgICAgaWYgKGlzSG1yVXBkYXRpbmcpIHsKICAgICAgICBvcHRpbWl6ZWQgPSBmYWxzZTsKICAgICAgICBkeW5hbWljQ2hpbGRyZW4gPSBudWxsOwogICAgICB9CiAgICAgIGlmIChuMSA9PSBudWxsKSB7CiAgICAgICAgY29uc3QgcGxhY2Vob2xkZXIgPSBuMi5lbCA9IGNyZWF0ZUNvbW1lbnQoInRlbGVwb3J0IHN0YXJ0IikgOwogICAgICAgIGNvbnN0IG1haW5BbmNob3IgPSBuMi5hbmNob3IgPSBjcmVhdGVDb21tZW50KCJ0ZWxlcG9ydCBlbmQiKSA7CiAgICAgICAgaW5zZXJ0KHBsYWNlaG9sZGVyLCBjb250YWluZXIsIGFuY2hvcik7CiAgICAgICAgaW5zZXJ0KG1haW5BbmNob3IsIGNvbnRhaW5lciwgYW5jaG9yKTsKICAgICAgICBjb25zdCB0YXJnZXQgPSBuMi50YXJnZXQgPSByZXNvbHZlVGFyZ2V0KG4yLnByb3BzLCBxdWVyeVNlbGVjdG9yKTsKICAgICAgICBjb25zdCB0YXJnZXRBbmNob3IgPSBuMi50YXJnZXRBbmNob3IgPSBjcmVhdGVUZXh0KCIiKTsKICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICBpbnNlcnQodGFyZ2V0QW5jaG9yLCB0YXJnZXQpOwogICAgICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gInN2ZyIgfHwgaXNUYXJnZXRTVkcodGFyZ2V0KSkgewogICAgICAgICAgICBuYW1lc3BhY2UgPSAic3ZnIjsKICAgICAgICAgIH0gZWxzZSBpZiAobmFtZXNwYWNlID09PSAibWF0aG1sIiB8fCBpc1RhcmdldE1hdGhNTCh0YXJnZXQpKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZSA9ICJtYXRobWwiOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIWRpc2FibGVkKSB7CiAgICAgICAgICB3YXJuJDEoIkludmFsaWQgVGVsZXBvcnQgdGFyZ2V0IG9uIG1vdW50OiIsIHRhcmdldCwgYCgke3R5cGVvZiB0YXJnZXR9KWApOwogICAgICAgIH0KICAgICAgICBjb25zdCBtb3VudCA9IChjb250YWluZXIyLCBhbmNob3IyKSA9PiB7CiAgICAgICAgICBpZiAoc2hhcGVGbGFnICYgMTYpIHsKICAgICAgICAgICAgbW91bnRDaGlsZHJlbigKICAgICAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgIGFuY2hvcjIsCiAgICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgICAgb3B0aW1pemVkCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBpZiAoZGlzYWJsZWQpIHsKICAgICAgICAgIG1vdW50KGNvbnRhaW5lciwgbWFpbkFuY2hvcik7CiAgICAgICAgfSBlbHNlIGlmICh0YXJnZXQpIHsKICAgICAgICAgIG1vdW50KHRhcmdldCwgdGFyZ2V0QW5jaG9yKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbjIuZWwgPSBuMS5lbDsKICAgICAgICBjb25zdCBtYWluQW5jaG9yID0gbjIuYW5jaG9yID0gbjEuYW5jaG9yOwogICAgICAgIGNvbnN0IHRhcmdldCA9IG4yLnRhcmdldCA9IG4xLnRhcmdldDsKICAgICAgICBjb25zdCB0YXJnZXRBbmNob3IgPSBuMi50YXJnZXRBbmNob3IgPSBuMS50YXJnZXRBbmNob3I7CiAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSBpc1RlbGVwb3J0RGlzYWJsZWQobjEucHJvcHMpOwogICAgICAgIGNvbnN0IGN1cnJlbnRDb250YWluZXIgPSB3YXNEaXNhYmxlZCA/IGNvbnRhaW5lciA6IHRhcmdldDsKICAgICAgICBjb25zdCBjdXJyZW50QW5jaG9yID0gd2FzRGlzYWJsZWQgPyBtYWluQW5jaG9yIDogdGFyZ2V0QW5jaG9yOwogICAgICAgIGlmIChuYW1lc3BhY2UgPT09ICJzdmciIHx8IGlzVGFyZ2V0U1ZHKHRhcmdldCkpIHsKICAgICAgICAgIG5hbWVzcGFjZSA9ICJzdmciOwogICAgICAgIH0gZWxzZSBpZiAobmFtZXNwYWNlID09PSAibWF0aG1sIiB8fCBpc1RhcmdldE1hdGhNTCh0YXJnZXQpKSB7CiAgICAgICAgICBuYW1lc3BhY2UgPSAibWF0aG1sIjsKICAgICAgICB9CiAgICAgICAgaWYgKGR5bmFtaWNDaGlsZHJlbikgewogICAgICAgICAgcGF0Y2hCbG9ja0NoaWxkcmVuKAogICAgICAgICAgICBuMS5keW5hbWljQ2hpbGRyZW4sCiAgICAgICAgICAgIGR5bmFtaWNDaGlsZHJlbiwKICAgICAgICAgICAgY3VycmVudENvbnRhaW5lciwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMKICAgICAgICAgICk7CiAgICAgICAgICB0cmF2ZXJzZVN0YXRpY0NoaWxkcmVuKG4xLCBuMiwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIGlmICghb3B0aW1pemVkKSB7CiAgICAgICAgICBwYXRjaENoaWxkcmVuKAogICAgICAgICAgICBuMSwKICAgICAgICAgICAgbjIsCiAgICAgICAgICAgIGN1cnJlbnRDb250YWluZXIsCiAgICAgICAgICAgIGN1cnJlbnRBbmNob3IsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRpc2FibGVkKSB7CiAgICAgICAgICBpZiAoIXdhc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIG1vdmVUZWxlcG9ydCgKICAgICAgICAgICAgICBuMiwKICAgICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgICAgbWFpbkFuY2hvciwKICAgICAgICAgICAgICBpbnRlcm5hbHMsCiAgICAgICAgICAgICAgMQogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG4yLnByb3BzICYmIG4xLnByb3BzICYmIG4yLnByb3BzLnRvICE9PSBuMS5wcm9wcy50bykgewogICAgICAgICAgICAgIG4yLnByb3BzLnRvID0gbjEucHJvcHMudG87CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKChuMi5wcm9wcyAmJiBuMi5wcm9wcy50bykgIT09IChuMS5wcm9wcyAmJiBuMS5wcm9wcy50bykpIHsKICAgICAgICAgICAgY29uc3QgbmV4dFRhcmdldCA9IG4yLnRhcmdldCA9IHJlc29sdmVUYXJnZXQoCiAgICAgICAgICAgICAgbjIucHJvcHMsCiAgICAgICAgICAgICAgcXVlcnlTZWxlY3RvcgogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAobmV4dFRhcmdldCkgewogICAgICAgICAgICAgIG1vdmVUZWxlcG9ydCgKICAgICAgICAgICAgICAgIG4yLAogICAgICAgICAgICAgICAgbmV4dFRhcmdldCwKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICBpbnRlcm5hbHMsCiAgICAgICAgICAgICAgICAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgICAiSW52YWxpZCBUZWxlcG9ydCB0YXJnZXQgb24gdXBkYXRlOiIsCiAgICAgICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgICAgICBgKCR7dHlwZW9mIHRhcmdldH0pYAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAod2FzRGlzYWJsZWQpIHsKICAgICAgICAgICAgbW92ZVRlbGVwb3J0KAogICAgICAgICAgICAgIG4yLAogICAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgICB0YXJnZXRBbmNob3IsCiAgICAgICAgICAgICAgaW50ZXJuYWxzLAogICAgICAgICAgICAgIDEKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgdXBkYXRlQ3NzVmFycyhuMik7CiAgICB9LAogICAgcmVtb3ZlKHZub2RlLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCBvcHRpbWl6ZWQsIHsgdW06IHVubW91bnQsIG86IHsgcmVtb3ZlOiBob3N0UmVtb3ZlIH0gfSwgZG9SZW1vdmUpIHsKICAgICAgY29uc3QgeyBzaGFwZUZsYWcsIGNoaWxkcmVuLCBhbmNob3IsIHRhcmdldEFuY2hvciwgdGFyZ2V0LCBwcm9wcyB9ID0gdm5vZGU7CiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICBob3N0UmVtb3ZlKHRhcmdldEFuY2hvcik7CiAgICAgIH0KICAgICAgZG9SZW1vdmUgJiYgaG9zdFJlbW92ZShhbmNob3IpOwogICAgICBpZiAoc2hhcGVGbGFnICYgMTYpIHsKICAgICAgICBjb25zdCBzaG91bGRSZW1vdmUgPSBkb1JlbW92ZSB8fCAhaXNUZWxlcG9ydERpc2FibGVkKHByb3BzKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgdW5tb3VudCgKICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgIHBhcmVudENvbXBvbmVudCwKICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UsCiAgICAgICAgICAgIHNob3VsZFJlbW92ZSwKICAgICAgICAgICAgISFjaGlsZC5keW5hbWljQ2hpbGRyZW4KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgbW92ZTogbW92ZVRlbGVwb3J0LAogICAgaHlkcmF0ZTogaHlkcmF0ZVRlbGVwb3J0CiAgfTsKICBmdW5jdGlvbiBtb3ZlVGVsZXBvcnQodm5vZGUsIGNvbnRhaW5lciwgcGFyZW50QW5jaG9yLCB7IG86IHsgaW5zZXJ0IH0sIG06IG1vdmUgfSwgbW92ZVR5cGUgPSAyKSB7CiAgICBpZiAobW92ZVR5cGUgPT09IDApIHsKICAgICAgaW5zZXJ0KHZub2RlLnRhcmdldEFuY2hvciwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IpOwogICAgfQogICAgY29uc3QgeyBlbCwgYW5jaG9yLCBzaGFwZUZsYWcsIGNoaWxkcmVuLCBwcm9wcyB9ID0gdm5vZGU7CiAgICBjb25zdCBpc1Jlb3JkZXIgPSBtb3ZlVHlwZSA9PT0gMjsKICAgIGlmIChpc1Jlb3JkZXIpIHsKICAgICAgaW5zZXJ0KGVsLCBjb250YWluZXIsIHBhcmVudEFuY2hvcik7CiAgICB9CiAgICBpZiAoIWlzUmVvcmRlciB8fCBpc1RlbGVwb3J0RGlzYWJsZWQocHJvcHMpKSB7CiAgICAgIGlmIChzaGFwZUZsYWcgJiAxNikgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG1vdmUoCiAgICAgICAgICAgIGNoaWxkcmVuW2ldLAogICAgICAgICAgICBjb250YWluZXIsCiAgICAgICAgICAgIHBhcmVudEFuY2hvciwKICAgICAgICAgICAgMgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChpc1Jlb3JkZXIpIHsKICAgICAgaW5zZXJ0KGFuY2hvciwgY29udGFpbmVyLCBwYXJlbnRBbmNob3IpOwogICAgfQogIH0KICBmdW5jdGlvbiBoeWRyYXRlVGVsZXBvcnQobm9kZSwgdm5vZGUsIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHNsb3RTY29wZUlkcywgb3B0aW1pemVkLCB7CiAgICBvOiB7IG5leHRTaWJsaW5nLCBwYXJlbnROb2RlLCBxdWVyeVNlbGVjdG9yIH0KICB9LCBoeWRyYXRlQ2hpbGRyZW4pIHsKICAgIGNvbnN0IHRhcmdldCA9IHZub2RlLnRhcmdldCA9IHJlc29sdmVUYXJnZXQoCiAgICAgIHZub2RlLnByb3BzLAogICAgICBxdWVyeVNlbGVjdG9yCiAgICApOwogICAgaWYgKHRhcmdldCkgewogICAgICBjb25zdCB0YXJnZXROb2RlID0gdGFyZ2V0Ll9scGEgfHwgdGFyZ2V0LmZpcnN0Q2hpbGQ7CiAgICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxNikgewogICAgICAgIGlmIChpc1RlbGVwb3J0RGlzYWJsZWQodm5vZGUucHJvcHMpKSB7CiAgICAgICAgICB2bm9kZS5hbmNob3IgPSBoeWRyYXRlQ2hpbGRyZW4oCiAgICAgICAgICAgIG5leHRTaWJsaW5nKG5vZGUpLAogICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgcGFyZW50Tm9kZShub2RlKSwKICAgICAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgICAgICBwYXJlbnRTdXNwZW5zZSwKICAgICAgICAgICAgc2xvdFNjb3BlSWRzLAogICAgICAgICAgICBvcHRpbWl6ZWQKICAgICAgICAgICk7CiAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgPSB0YXJnZXROb2RlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bm9kZS5hbmNob3IgPSBuZXh0U2libGluZyhub2RlKTsKICAgICAgICAgIGxldCB0YXJnZXRBbmNob3IgPSB0YXJnZXROb2RlOwogICAgICAgICAgd2hpbGUgKHRhcmdldEFuY2hvcikgewogICAgICAgICAgICB0YXJnZXRBbmNob3IgPSBuZXh0U2libGluZyh0YXJnZXRBbmNob3IpOwogICAgICAgICAgICBpZiAodGFyZ2V0QW5jaG9yICYmIHRhcmdldEFuY2hvci5ub2RlVHlwZSA9PT0gOCAmJiB0YXJnZXRBbmNob3IuZGF0YSA9PT0gInRlbGVwb3J0IGFuY2hvciIpIHsKICAgICAgICAgICAgICB2bm9kZS50YXJnZXRBbmNob3IgPSB0YXJnZXRBbmNob3I7CiAgICAgICAgICAgICAgdGFyZ2V0Ll9scGEgPSB2bm9kZS50YXJnZXRBbmNob3IgJiYgbmV4dFNpYmxpbmcodm5vZGUudGFyZ2V0QW5jaG9yKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaHlkcmF0ZUNoaWxkcmVuKAogICAgICAgICAgICB0YXJnZXROb2RlLAogICAgICAgICAgICB2bm9kZSwKICAgICAgICAgICAgdGFyZ2V0LAogICAgICAgICAgICBwYXJlbnRDb21wb25lbnQsCiAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgICAgICBzbG90U2NvcGVJZHMsCiAgICAgICAgICAgIG9wdGltaXplZAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdXBkYXRlQ3NzVmFycyh2bm9kZSk7CiAgICB9CiAgICByZXR1cm4gdm5vZGUuYW5jaG9yICYmIG5leHRTaWJsaW5nKHZub2RlLmFuY2hvcik7CiAgfQogIGNvbnN0IFRlbGVwb3J0ID0gVGVsZXBvcnRJbXBsOwogIGZ1bmN0aW9uIHVwZGF0ZUNzc1ZhcnModm5vZGUpIHsKICAgIGNvbnN0IGN0eCA9IHZub2RlLmN0eDsKICAgIGlmIChjdHggJiYgY3R4LnV0KSB7CiAgICAgIGxldCBub2RlID0gdm5vZGUuY2hpbGRyZW5bMF0uZWw7CiAgICAgIHdoaWxlIChub2RlICYmIG5vZGUgIT09IHZub2RlLnRhcmdldEFuY2hvcikgewogICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKQogICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoImRhdGEtdi1vd25lciIsIGN0eC51aWQpOwogICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICB9CiAgICAgIGN0eC51dCgpOwogICAgfQogIH0KCiAgY29uc3QgRnJhZ21lbnQgPSBTeW1ib2wuZm9yKCJ2LWZndCIpOwogIGNvbnN0IFRleHQgPSBTeW1ib2wuZm9yKCJ2LXR4dCIpOwogIGNvbnN0IENvbW1lbnQgPSBTeW1ib2wuZm9yKCJ2LWNtdCIpOwogIGNvbnN0IFN0YXRpYyA9IFN5bWJvbC5mb3IoInYtc3RjIik7CiAgY29uc3QgYmxvY2tTdGFjayA9IFtdOwogIGxldCBjdXJyZW50QmxvY2sgPSBudWxsOwogIGZ1bmN0aW9uIG9wZW5CbG9jayhkaXNhYmxlVHJhY2tpbmcgPSBmYWxzZSkgewogICAgYmxvY2tTdGFjay5wdXNoKGN1cnJlbnRCbG9jayA9IGRpc2FibGVUcmFja2luZyA/IG51bGwgOiBbXSk7CiAgfQogIGZ1bmN0aW9uIGNsb3NlQmxvY2soKSB7CiAgICBibG9ja1N0YWNrLnBvcCgpOwogICAgY3VycmVudEJsb2NrID0gYmxvY2tTdGFja1tibG9ja1N0YWNrLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgfQogIGxldCBpc0Jsb2NrVHJlZUVuYWJsZWQgPSAxOwogIGZ1bmN0aW9uIHNldEJsb2NrVHJhY2tpbmcodmFsdWUpIHsKICAgIGlzQmxvY2tUcmVlRW5hYmxlZCArPSB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gc2V0dXBCbG9jayh2bm9kZSkgewogICAgdm5vZGUuZHluYW1pY0NoaWxkcmVuID0gaXNCbG9ja1RyZWVFbmFibGVkID4gMCA/IGN1cnJlbnRCbG9jayB8fCBFTVBUWV9BUlIgOiBudWxsOwogICAgY2xvc2VCbG9jaygpOwogICAgaWYgKGlzQmxvY2tUcmVlRW5hYmxlZCA+IDAgJiYgY3VycmVudEJsb2NrKSB7CiAgICAgIGN1cnJlbnRCbG9jay5wdXNoKHZub2RlKTsKICAgIH0KICAgIHJldHVybiB2bm9kZTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudEJsb2NrKHR5cGUsIHByb3BzLCBjaGlsZHJlbiwgcGF0Y2hGbGFnLCBkeW5hbWljUHJvcHMsIHNoYXBlRmxhZykgewogICAgcmV0dXJuIHNldHVwQmxvY2soCiAgICAgIGNyZWF0ZUJhc2VWTm9kZSgKICAgICAgICB0eXBlLAogICAgICAgIHByb3BzLAogICAgICAgIGNoaWxkcmVuLAogICAgICAgIHBhdGNoRmxhZywKICAgICAgICBkeW5hbWljUHJvcHMsCiAgICAgICAgc2hhcGVGbGFnLAogICAgICAgIHRydWUKICAgICAgKQogICAgKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQmxvY2sodHlwZSwgcHJvcHMsIGNoaWxkcmVuLCBwYXRjaEZsYWcsIGR5bmFtaWNQcm9wcykgewogICAgcmV0dXJuIHNldHVwQmxvY2soCiAgICAgIGNyZWF0ZVZOb2RlKAogICAgICAgIHR5cGUsCiAgICAgICAgcHJvcHMsCiAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgcGF0Y2hGbGFnLAogICAgICAgIGR5bmFtaWNQcm9wcywKICAgICAgICB0cnVlCiAgICAgICkKICAgICk7CiAgfQogIGZ1bmN0aW9uIGlzVk5vZGUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA/IHZhbHVlLl9fdl9pc1ZOb2RlID09PSB0cnVlIDogZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGlzU2FtZVZOb2RlVHlwZShuMSwgbjIpIHsKICAgIGlmIChuMi5zaGFwZUZsYWcgJiA2ICYmIGhtckRpcnR5Q29tcG9uZW50cy5oYXMobjIudHlwZSkpIHsKICAgICAgbjEuc2hhcGVGbGFnICY9IH4yNTY7CiAgICAgIG4yLnNoYXBlRmxhZyAmPSB+NTEyOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gbjEudHlwZSA9PT0gbjIudHlwZSAmJiBuMS5rZXkgPT09IG4yLmtleTsKICB9CiAgbGV0IHZub2RlQXJnc1RyYW5zZm9ybWVyOwogIGZ1bmN0aW9uIHRyYW5zZm9ybVZOb2RlQXJncyh0cmFuc2Zvcm1lcikgewogICAgdm5vZGVBcmdzVHJhbnNmb3JtZXIgPSB0cmFuc2Zvcm1lcjsKICB9CiAgY29uc3QgY3JlYXRlVk5vZGVXaXRoQXJnc1RyYW5zZm9ybSA9ICguLi5hcmdzKSA9PiB7CiAgICByZXR1cm4gX2NyZWF0ZVZOb2RlKAogICAgICAuLi52bm9kZUFyZ3NUcmFuc2Zvcm1lciA/IHZub2RlQXJnc1RyYW5zZm9ybWVyKGFyZ3MsIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSkgOiBhcmdzCiAgICApOwogIH07CiAgY29uc3QgSW50ZXJuYWxPYmplY3RLZXkgPSBgX192SW50ZXJuYWxgOwogIGNvbnN0IG5vcm1hbGl6ZUtleSA9ICh7IGtleSB9KSA9PiBrZXkgIT0gbnVsbCA/IGtleSA6IG51bGw7CiAgY29uc3Qgbm9ybWFsaXplUmVmID0gKHsKICAgIHJlZiwKICAgIHJlZl9rZXksCiAgICByZWZfZm9yCiAgfSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJudW1iZXIiKSB7CiAgICAgIHJlZiA9ICIiICsgcmVmOwogICAgfQogICAgcmV0dXJuIHJlZiAhPSBudWxsID8gaXNTdHJpbmcocmVmKSB8fCBpc1JlZihyZWYpIHx8IGlzRnVuY3Rpb24ocmVmKSA/IHsgaTogY3VycmVudFJlbmRlcmluZ0luc3RhbmNlLCByOiByZWYsIGs6IHJlZl9rZXksIGY6ICEhcmVmX2ZvciB9IDogcmVmIDogbnVsbDsKICB9OwogIGZ1bmN0aW9uIGNyZWF0ZUJhc2VWTm9kZSh0eXBlLCBwcm9wcyA9IG51bGwsIGNoaWxkcmVuID0gbnVsbCwgcGF0Y2hGbGFnID0gMCwgZHluYW1pY1Byb3BzID0gbnVsbCwgc2hhcGVGbGFnID0gdHlwZSA9PT0gRnJhZ21lbnQgPyAwIDogMSwgaXNCbG9ja05vZGUgPSBmYWxzZSwgbmVlZEZ1bGxDaGlsZHJlbk5vcm1hbGl6YXRpb24gPSBmYWxzZSkgewogICAgY29uc3Qgdm5vZGUgPSB7CiAgICAgIF9fdl9pc1ZOb2RlOiB0cnVlLAogICAgICBfX3Zfc2tpcDogdHJ1ZSwKICAgICAgdHlwZSwKICAgICAgcHJvcHMsCiAgICAgIGtleTogcHJvcHMgJiYgbm9ybWFsaXplS2V5KHByb3BzKSwKICAgICAgcmVmOiBwcm9wcyAmJiBub3JtYWxpemVSZWYocHJvcHMpLAogICAgICBzY29wZUlkOiBjdXJyZW50U2NvcGVJZCwKICAgICAgc2xvdFNjb3BlSWRzOiBudWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgY29tcG9uZW50OiBudWxsLAogICAgICBzdXNwZW5zZTogbnVsbCwKICAgICAgc3NDb250ZW50OiBudWxsLAogICAgICBzc0ZhbGxiYWNrOiBudWxsLAogICAgICBkaXJzOiBudWxsLAogICAgICB0cmFuc2l0aW9uOiBudWxsLAogICAgICBlbDogbnVsbCwKICAgICAgYW5jaG9yOiBudWxsLAogICAgICB0YXJnZXQ6IG51bGwsCiAgICAgIHRhcmdldEFuY2hvcjogbnVsbCwKICAgICAgc3RhdGljQ291bnQ6IDAsCiAgICAgIHNoYXBlRmxhZywKICAgICAgcGF0Y2hGbGFnLAogICAgICBkeW5hbWljUHJvcHMsCiAgICAgIGR5bmFtaWNDaGlsZHJlbjogbnVsbCwKICAgICAgYXBwQ29udGV4dDogbnVsbCwKICAgICAgY3R4OiBjdXJyZW50UmVuZGVyaW5nSW5zdGFuY2UKICAgIH07CiAgICBpZiAobmVlZEZ1bGxDaGlsZHJlbk5vcm1hbGl6YXRpb24pIHsKICAgICAgbm9ybWFsaXplQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuKTsKICAgICAgaWYgKHNoYXBlRmxhZyAmIDEyOCkgewogICAgICAgIHR5cGUubm9ybWFsaXplKHZub2RlKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChjaGlsZHJlbikgewogICAgICB2bm9kZS5zaGFwZUZsYWcgfD0gaXNTdHJpbmcoY2hpbGRyZW4pID8gOCA6IDE2OwogICAgfQogICAgaWYgKHZub2RlLmtleSAhPT0gdm5vZGUua2V5KSB7CiAgICAgIHdhcm4kMShgVk5vZGUgY3JlYXRlZCB3aXRoIGludmFsaWQga2V5IChOYU4pLiBWTm9kZSB0eXBlOmAsIHZub2RlLnR5cGUpOwogICAgfQogICAgaWYgKGlzQmxvY2tUcmVlRW5hYmxlZCA+IDAgJiYgLy8gYXZvaWQgYSBibG9jayBub2RlIGZyb20gdHJhY2tpbmcgaXRzZWxmCiAgICAhaXNCbG9ja05vZGUgJiYgLy8gaGFzIGN1cnJlbnQgcGFyZW50IGJsb2NrCiAgICBjdXJyZW50QmxvY2sgJiYgLy8gcHJlc2VuY2Ugb2YgYSBwYXRjaCBmbGFnIGluZGljYXRlcyB0aGlzIG5vZGUgbmVlZHMgcGF0Y2hpbmcgb24gdXBkYXRlcy4KICAgIC8vIGNvbXBvbmVudCBub2RlcyBhbHNvIHNob3VsZCBhbHdheXMgYmUgcGF0Y2hlZCwgYmVjYXVzZSBldmVuIGlmIHRoZQogICAgLy8gY29tcG9uZW50IGRvZXNuJ3QgbmVlZCB0byB1cGRhdGUsIGl0IG5lZWRzIHRvIHBlcnNpc3QgdGhlIGluc3RhbmNlIG9uIHRvCiAgICAvLyB0aGUgbmV4dCB2bm9kZSBzbyB0aGF0IGl0IGNhbiBiZSBwcm9wZXJseSB1bm1vdW50ZWQgbGF0ZXIuCiAgICAodm5vZGUucGF0Y2hGbGFnID4gMCB8fCBzaGFwZUZsYWcgJiA2KSAmJiAvLyB0aGUgRVZFTlRTIGZsYWcgaXMgb25seSBmb3IgaHlkcmF0aW9uIGFuZCBpZiBpdCBpcyB0aGUgb25seSBmbGFnLCB0aGUKICAgIC8vIHZub2RlIHNob3VsZCBub3QgYmUgY29uc2lkZXJlZCBkeW5hbWljIGR1ZSB0byBoYW5kbGVyIGNhY2hpbmcuCiAgICB2bm9kZS5wYXRjaEZsYWcgIT09IDMyKSB7CiAgICAgIGN1cnJlbnRCbG9jay5wdXNoKHZub2RlKTsKICAgIH0KICAgIHJldHVybiB2bm9kZTsKICB9CiAgY29uc3QgY3JlYXRlVk5vZGUgPSBjcmVhdGVWTm9kZVdpdGhBcmdzVHJhbnNmb3JtIDsKICBmdW5jdGlvbiBfY3JlYXRlVk5vZGUodHlwZSwgcHJvcHMgPSBudWxsLCBjaGlsZHJlbiA9IG51bGwsIHBhdGNoRmxhZyA9IDAsIGR5bmFtaWNQcm9wcyA9IG51bGwsIGlzQmxvY2tOb2RlID0gZmFsc2UpIHsKICAgIGlmICghdHlwZSB8fCB0eXBlID09PSBOVUxMX0RZTkFNSUNfQ09NUE9ORU5UKSB7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgIHdhcm4kMShgSW52YWxpZCB2bm9kZSB0eXBlIHdoZW4gY3JlYXRpbmcgdm5vZGU6ICR7dHlwZX0uYCk7CiAgICAgIH0KICAgICAgdHlwZSA9IENvbW1lbnQ7CiAgICB9CiAgICBpZiAoaXNWTm9kZSh0eXBlKSkgewogICAgICBjb25zdCBjbG9uZWQgPSBjbG9uZVZOb2RlKAogICAgICAgIHR5cGUsCiAgICAgICAgcHJvcHMsCiAgICAgICAgdHJ1ZQogICAgICAgIC8qIG1lcmdlUmVmOiB0cnVlICovCiAgICAgICk7CiAgICAgIGlmIChjaGlsZHJlbikgewogICAgICAgIG5vcm1hbGl6ZUNoaWxkcmVuKGNsb25lZCwgY2hpbGRyZW4pOwogICAgICB9CiAgICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmICFpc0Jsb2NrTm9kZSAmJiBjdXJyZW50QmxvY2spIHsKICAgICAgICBpZiAoY2xvbmVkLnNoYXBlRmxhZyAmIDYpIHsKICAgICAgICAgIGN1cnJlbnRCbG9ja1tjdXJyZW50QmxvY2suaW5kZXhPZih0eXBlKV0gPSBjbG9uZWQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN1cnJlbnRCbG9jay5wdXNoKGNsb25lZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNsb25lZC5wYXRjaEZsYWcgfD0gLTI7CiAgICAgIHJldHVybiBjbG9uZWQ7CiAgICB9CiAgICBpZiAoaXNDbGFzc0NvbXBvbmVudCh0eXBlKSkgewogICAgICB0eXBlID0gdHlwZS5fX3ZjY09wdHM7CiAgICB9CiAgICBpZiAocHJvcHMpIHsKICAgICAgcHJvcHMgPSBndWFyZFJlYWN0aXZlUHJvcHMocHJvcHMpOwogICAgICBsZXQgeyBjbGFzczoga2xhc3MsIHN0eWxlIH0gPSBwcm9wczsKICAgICAgaWYgKGtsYXNzICYmICFpc1N0cmluZyhrbGFzcykpIHsKICAgICAgICBwcm9wcy5jbGFzcyA9IG5vcm1hbGl6ZUNsYXNzKGtsYXNzKTsKICAgICAgfQogICAgICBpZiAoaXNPYmplY3Qoc3R5bGUpKSB7CiAgICAgICAgaWYgKGlzUHJveHkoc3R5bGUpICYmICFpc0FycmF5KHN0eWxlKSkgewogICAgICAgICAgc3R5bGUgPSBleHRlbmQoe30sIHN0eWxlKTsKICAgICAgICB9CiAgICAgICAgcHJvcHMuc3R5bGUgPSBub3JtYWxpemVTdHlsZShzdHlsZSk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHNoYXBlRmxhZyA9IGlzU3RyaW5nKHR5cGUpID8gMSA6IGlzU3VzcGVuc2UodHlwZSkgPyAxMjggOiBpc1RlbGVwb3J0KHR5cGUpID8gNjQgOiBpc09iamVjdCh0eXBlKSA/IDQgOiBpc0Z1bmN0aW9uKHR5cGUpID8gMiA6IDA7CiAgICBpZiAoc2hhcGVGbGFnICYgNCAmJiBpc1Byb3h5KHR5cGUpKSB7CiAgICAgIHR5cGUgPSB0b1Jhdyh0eXBlKTsKICAgICAgd2FybiQxKAogICAgICAgIGBWdWUgcmVjZWl2ZWQgYSBDb21wb25lbnQgdGhhdCB3YXMgbWFkZSBhIHJlYWN0aXZlIG9iamVjdC4gVGhpcyBjYW4gbGVhZCB0byB1bm5lY2Vzc2FyeSBwZXJmb3JtYW5jZSBvdmVyaGVhZCBhbmQgc2hvdWxkIGJlIGF2b2lkZWQgYnkgbWFya2luZyB0aGUgY29tcG9uZW50IHdpdGggXGBtYXJrUmF3XGAgb3IgdXNpbmcgXGBzaGFsbG93UmVmXGAgaW5zdGVhZCBvZiBcYHJlZlxgLmAsCiAgICAgICAgYApDb21wb25lbnQgdGhhdCB3YXMgbWFkZSByZWFjdGl2ZTogYCwKICAgICAgICB0eXBlCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gY3JlYXRlQmFzZVZOb2RlKAogICAgICB0eXBlLAogICAgICBwcm9wcywKICAgICAgY2hpbGRyZW4sCiAgICAgIHBhdGNoRmxhZywKICAgICAgZHluYW1pY1Byb3BzLAogICAgICBzaGFwZUZsYWcsCiAgICAgIGlzQmxvY2tOb2RlLAogICAgICB0cnVlCiAgICApOwogIH0KICBmdW5jdGlvbiBndWFyZFJlYWN0aXZlUHJvcHMocHJvcHMpIHsKICAgIGlmICghcHJvcHMpCiAgICAgIHJldHVybiBudWxsOwogICAgcmV0dXJuIGlzUHJveHkocHJvcHMpIHx8IEludGVybmFsT2JqZWN0S2V5IGluIHByb3BzID8gZXh0ZW5kKHt9LCBwcm9wcykgOiBwcm9wczsKICB9CiAgZnVuY3Rpb24gY2xvbmVWTm9kZSh2bm9kZSwgZXh0cmFQcm9wcywgbWVyZ2VSZWYgPSBmYWxzZSkgewogICAgY29uc3QgeyBwcm9wcywgcmVmLCBwYXRjaEZsYWcsIGNoaWxkcmVuIH0gPSB2bm9kZTsKICAgIGNvbnN0IG1lcmdlZFByb3BzID0gZXh0cmFQcm9wcyA/IG1lcmdlUHJvcHMocHJvcHMgfHwge30sIGV4dHJhUHJvcHMpIDogcHJvcHM7CiAgICBjb25zdCBjbG9uZWQgPSB7CiAgICAgIF9fdl9pc1ZOb2RlOiB0cnVlLAogICAgICBfX3Zfc2tpcDogdHJ1ZSwKICAgICAgdHlwZTogdm5vZGUudHlwZSwKICAgICAgcHJvcHM6IG1lcmdlZFByb3BzLAogICAgICBrZXk6IG1lcmdlZFByb3BzICYmIG5vcm1hbGl6ZUtleShtZXJnZWRQcm9wcyksCiAgICAgIHJlZjogZXh0cmFQcm9wcyAmJiBleHRyYVByb3BzLnJlZiA/ICgKICAgICAgICAvLyAjMjA3OCBpbiB0aGUgY2FzZSBvZiA8Y29tcG9uZW50IDppcz0idm5vZGUiIHJlZj0iZXh0cmEiLz4KICAgICAgICAvLyBpZiB0aGUgdm5vZGUgaXRzZWxmIGFscmVhZHkgaGFzIGEgcmVmLCBjbG9uZVZOb2RlIHdpbGwgbmVlZCB0byBtZXJnZQogICAgICAgIC8vIHRoZSByZWZzIHNvIHRoZSBzaW5nbGUgdm5vZGUgY2FuIGJlIHNldCBvbiBtdWx0aXBsZSByZWZzCiAgICAgICAgbWVyZ2VSZWYgJiYgcmVmID8gaXNBcnJheShyZWYpID8gcmVmLmNvbmNhdChub3JtYWxpemVSZWYoZXh0cmFQcm9wcykpIDogW3JlZiwgbm9ybWFsaXplUmVmKGV4dHJhUHJvcHMpXSA6IG5vcm1hbGl6ZVJlZihleHRyYVByb3BzKQogICAgICApIDogcmVmLAogICAgICBzY29wZUlkOiB2bm9kZS5zY29wZUlkLAogICAgICBzbG90U2NvcGVJZHM6IHZub2RlLnNsb3RTY29wZUlkcywKICAgICAgY2hpbGRyZW46IHBhdGNoRmxhZyA9PT0gLTEgJiYgaXNBcnJheShjaGlsZHJlbikgPyBjaGlsZHJlbi5tYXAoZGVlcENsb25lVk5vZGUpIDogY2hpbGRyZW4sCiAgICAgIHRhcmdldDogdm5vZGUudGFyZ2V0LAogICAgICB0YXJnZXRBbmNob3I6IHZub2RlLnRhcmdldEFuY2hvciwKICAgICAgc3RhdGljQ291bnQ6IHZub2RlLnN0YXRpY0NvdW50LAogICAgICBzaGFwZUZsYWc6IHZub2RlLnNoYXBlRmxhZywKICAgICAgLy8gaWYgdGhlIHZub2RlIGlzIGNsb25lZCB3aXRoIGV4dHJhIHByb3BzLCB3ZSBjYW4gbm8gbG9uZ2VyIGFzc3VtZSBpdHMKICAgICAgLy8gZXhpc3RpbmcgcGF0Y2ggZmxhZyB0byBiZSByZWxpYWJsZSBhbmQgbmVlZCB0byBhZGQgdGhlIEZVTExfUFJPUFMgZmxhZy4KICAgICAgLy8gbm90ZTogcHJlc2VydmUgZmxhZyBmb3IgZnJhZ21lbnRzIHNpbmNlIHRoZXkgdXNlIHRoZSBmbGFnIGZvciBjaGlsZHJlbgogICAgICAvLyBmYXN0IHBhdGhzIG9ubHkuCiAgICAgIHBhdGNoRmxhZzogZXh0cmFQcm9wcyAmJiB2bm9kZS50eXBlICE9PSBGcmFnbWVudCA/IHBhdGNoRmxhZyA9PT0gLTEgPyAxNiA6IHBhdGNoRmxhZyB8IDE2IDogcGF0Y2hGbGFnLAogICAgICBkeW5hbWljUHJvcHM6IHZub2RlLmR5bmFtaWNQcm9wcywKICAgICAgZHluYW1pY0NoaWxkcmVuOiB2bm9kZS5keW5hbWljQ2hpbGRyZW4sCiAgICAgIGFwcENvbnRleHQ6IHZub2RlLmFwcENvbnRleHQsCiAgICAgIGRpcnM6IHZub2RlLmRpcnMsCiAgICAgIHRyYW5zaXRpb246IHZub2RlLnRyYW5zaXRpb24sCiAgICAgIC8vIFRoZXNlIHNob3VsZCB0ZWNobmljYWxseSBvbmx5IGJlIG5vbi1udWxsIG9uIG1vdW50ZWQgVk5vZGVzLiBIb3dldmVyLAogICAgICAvLyB0aGV5ICpzaG91bGQqIGJlIGNvcGllZCBmb3Iga2VwdC1hbGl2ZSB2bm9kZXMuIFNvIHdlIGp1c3QgYWx3YXlzIGNvcHkKICAgICAgLy8gdGhlbSBzaW5jZSB0aGVtIGJlaW5nIG5vbi1udWxsIGR1cmluZyBhIG1vdW50IGRvZXNuJ3QgYWZmZWN0IHRoZSBsb2dpYyBhcwogICAgICAvLyB0aGV5IHdpbGwgc2ltcGx5IGJlIG92ZXJ3cml0dGVuLgogICAgICBjb21wb25lbnQ6IHZub2RlLmNvbXBvbmVudCwKICAgICAgc3VzcGVuc2U6IHZub2RlLnN1c3BlbnNlLAogICAgICBzc0NvbnRlbnQ6IHZub2RlLnNzQ29udGVudCAmJiBjbG9uZVZOb2RlKHZub2RlLnNzQ29udGVudCksCiAgICAgIHNzRmFsbGJhY2s6IHZub2RlLnNzRmFsbGJhY2sgJiYgY2xvbmVWTm9kZSh2bm9kZS5zc0ZhbGxiYWNrKSwKICAgICAgZWw6IHZub2RlLmVsLAogICAgICBhbmNob3I6IHZub2RlLmFuY2hvciwKICAgICAgY3R4OiB2bm9kZS5jdHgsCiAgICAgIGNlOiB2bm9kZS5jZQogICAgfTsKICAgIHJldHVybiBjbG9uZWQ7CiAgfQogIGZ1bmN0aW9uIGRlZXBDbG9uZVZOb2RlKHZub2RlKSB7CiAgICBjb25zdCBjbG9uZWQgPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgIGlmIChpc0FycmF5KHZub2RlLmNoaWxkcmVuKSkgewogICAgICBjbG9uZWQuY2hpbGRyZW4gPSB2bm9kZS5jaGlsZHJlbi5tYXAoZGVlcENsb25lVk5vZGUpOwogICAgfQogICAgcmV0dXJuIGNsb25lZDsKICB9CiAgZnVuY3Rpb24gY3JlYXRlVGV4dFZOb2RlKHRleHQgPSAiICIsIGZsYWcgPSAwKSB7CiAgICByZXR1cm4gY3JlYXRlVk5vZGUoVGV4dCwgbnVsbCwgdGV4dCwgZmxhZyk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVN0YXRpY1ZOb2RlKGNvbnRlbnQsIG51bWJlck9mTm9kZXMpIHsKICAgIGNvbnN0IHZub2RlID0gY3JlYXRlVk5vZGUoU3RhdGljLCBudWxsLCBjb250ZW50KTsKICAgIHZub2RlLnN0YXRpY0NvdW50ID0gbnVtYmVyT2ZOb2RlczsKICAgIHJldHVybiB2bm9kZTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ29tbWVudFZOb2RlKHRleHQgPSAiIiwgYXNCbG9jayA9IGZhbHNlKSB7CiAgICByZXR1cm4gYXNCbG9jayA/IChvcGVuQmxvY2soKSwgY3JlYXRlQmxvY2soQ29tbWVudCwgbnVsbCwgdGV4dCkpIDogY3JlYXRlVk5vZGUoQ29tbWVudCwgbnVsbCwgdGV4dCk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZVZOb2RlKGNoaWxkKSB7CiAgICBpZiAoY2hpbGQgPT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgPT09ICJib29sZWFuIikgewogICAgICByZXR1cm4gY3JlYXRlVk5vZGUoQ29tbWVudCk7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkoY2hpbGQpKSB7CiAgICAgIHJldHVybiBjcmVhdGVWTm9kZSgKICAgICAgICBGcmFnbWVudCwKICAgICAgICBudWxsLAogICAgICAgIC8vICMzNjY2LCBhdm9pZCByZWZlcmVuY2UgcG9sbHV0aW9uIHdoZW4gcmV1c2luZyB2bm9kZQogICAgICAgIGNoaWxkLnNsaWNlKCkKICAgICAgKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGNoaWxkID09PSAib2JqZWN0IikgewogICAgICByZXR1cm4gY2xvbmVJZk1vdW50ZWQoY2hpbGQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKFRleHQsIG51bGwsIFN0cmluZyhjaGlsZCkpOwogICAgfQogIH0KICBmdW5jdGlvbiBjbG9uZUlmTW91bnRlZChjaGlsZCkgewogICAgcmV0dXJuIGNoaWxkLmVsID09PSBudWxsICYmIGNoaWxkLnBhdGNoRmxhZyAhPT0gLTEgfHwgY2hpbGQubWVtbyA/IGNoaWxkIDogY2xvbmVWTm9kZShjaGlsZCk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbikgewogICAgbGV0IHR5cGUgPSAwOwogICAgY29uc3QgeyBzaGFwZUZsYWcgfSA9IHZub2RlOwogICAgaWYgKGNoaWxkcmVuID09IG51bGwpIHsKICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgfSBlbHNlIGlmIChpc0FycmF5KGNoaWxkcmVuKSkgewogICAgICB0eXBlID0gMTY7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjaGlsZHJlbiA9PT0gIm9iamVjdCIpIHsKICAgICAgaWYgKHNoYXBlRmxhZyAmICgxIHwgNjQpKSB7CiAgICAgICAgY29uc3Qgc2xvdCA9IGNoaWxkcmVuLmRlZmF1bHQ7CiAgICAgICAgaWYgKHNsb3QpIHsKICAgICAgICAgIHNsb3QuX2MgJiYgKHNsb3QuX2QgPSBmYWxzZSk7CiAgICAgICAgICBub3JtYWxpemVDaGlsZHJlbih2bm9kZSwgc2xvdCgpKTsKICAgICAgICAgIHNsb3QuX2MgJiYgKHNsb3QuX2QgPSB0cnVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIHR5cGUgPSAzMjsKICAgICAgICBjb25zdCBzbG90RmxhZyA9IGNoaWxkcmVuLl87CiAgICAgICAgaWYgKCFzbG90RmxhZyAmJiAhKEludGVybmFsT2JqZWN0S2V5IGluIGNoaWxkcmVuKSkgewogICAgICAgICAgY2hpbGRyZW4uX2N0eCA9IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICAgICAgICB9IGVsc2UgaWYgKHNsb3RGbGFnID09PSAzICYmIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZS5zbG90cy5fID09PSAxKSB7CiAgICAgICAgICAgIGNoaWxkcmVuLl8gPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hpbGRyZW4uXyA9IDI7CiAgICAgICAgICAgIHZub2RlLnBhdGNoRmxhZyB8PSAxMDI0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKGNoaWxkcmVuKSkgewogICAgICBjaGlsZHJlbiA9IHsgZGVmYXVsdDogY2hpbGRyZW4sIF9jdHg6IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSB9OwogICAgICB0eXBlID0gMzI7CiAgICB9IGVsc2UgewogICAgICBjaGlsZHJlbiA9IFN0cmluZyhjaGlsZHJlbik7CiAgICAgIGlmIChzaGFwZUZsYWcgJiA2NCkgewogICAgICAgIHR5cGUgPSAxNjsKICAgICAgICBjaGlsZHJlbiA9IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlID0gODsKICAgICAgfQogICAgfQogICAgdm5vZGUuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHZub2RlLnNoYXBlRmxhZyB8PSB0eXBlOwogIH0KICBmdW5jdGlvbiBtZXJnZVByb3BzKC4uLmFyZ3MpIHsKICAgIGNvbnN0IHJldCA9IHt9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHRvTWVyZ2UgPSBhcmdzW2ldOwogICAgICBmb3IgKGNvbnN0IGtleSBpbiB0b01lcmdlKSB7CiAgICAgICAgaWYgKGtleSA9PT0gImNsYXNzIikgewogICAgICAgICAgaWYgKHJldC5jbGFzcyAhPT0gdG9NZXJnZS5jbGFzcykgewogICAgICAgICAgICByZXQuY2xhc3MgPSBub3JtYWxpemVDbGFzcyhbcmV0LmNsYXNzLCB0b01lcmdlLmNsYXNzXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJzdHlsZSIpIHsKICAgICAgICAgIHJldC5zdHlsZSA9IG5vcm1hbGl6ZVN0eWxlKFtyZXQuc3R5bGUsIHRvTWVyZ2Uuc3R5bGVdKTsKICAgICAgICB9IGVsc2UgaWYgKGlzT24oa2V5KSkgewogICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSByZXRba2V5XTsKICAgICAgICAgIGNvbnN0IGluY29taW5nID0gdG9NZXJnZVtrZXldOwogICAgICAgICAgaWYgKGluY29taW5nICYmIGV4aXN0aW5nICE9PSBpbmNvbWluZyAmJiAhKGlzQXJyYXkoZXhpc3RpbmcpICYmIGV4aXN0aW5nLmluY2x1ZGVzKGluY29taW5nKSkpIHsKICAgICAgICAgICAgcmV0W2tleV0gPSBleGlzdGluZyA/IFtdLmNvbmNhdChleGlzdGluZywgaW5jb21pbmcpIDogaW5jb21pbmc7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChrZXkgIT09ICIiKSB7CiAgICAgICAgICByZXRba2V5XSA9IHRvTWVyZ2Vba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGZ1bmN0aW9uIGludm9rZVZOb2RlSG9vayhob29rLCBpbnN0YW5jZSwgdm5vZGUsIHByZXZWTm9kZSA9IG51bGwpIHsKICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKGhvb2ssIGluc3RhbmNlLCA3LCBbCiAgICAgIHZub2RlLAogICAgICBwcmV2Vk5vZGUKICAgIF0pOwogIH0KCiAgY29uc3QgZW1wdHlBcHBDb250ZXh0ID0gY3JlYXRlQXBwQ29udGV4dCgpOwogIGxldCB1aWQgPSAwOwogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlKHZub2RlLCBwYXJlbnQsIHN1c3BlbnNlKSB7CiAgICBjb25zdCB0eXBlID0gdm5vZGUudHlwZTsKICAgIGNvbnN0IGFwcENvbnRleHQgPSAocGFyZW50ID8gcGFyZW50LmFwcENvbnRleHQgOiB2bm9kZS5hcHBDb250ZXh0KSB8fCBlbXB0eUFwcENvbnRleHQ7CiAgICBjb25zdCBpbnN0YW5jZSA9IHsKICAgICAgdWlkOiB1aWQrKywKICAgICAgdm5vZGUsCiAgICAgIHR5cGUsCiAgICAgIHBhcmVudCwKICAgICAgYXBwQ29udGV4dCwKICAgICAgcm9vdDogbnVsbCwKICAgICAgLy8gdG8gYmUgaW1tZWRpYXRlbHkgc2V0CiAgICAgIG5leHQ6IG51bGwsCiAgICAgIHN1YlRyZWU6IG51bGwsCiAgICAgIC8vIHdpbGwgYmUgc2V0IHN5bmNocm9ub3VzbHkgcmlnaHQgYWZ0ZXIgY3JlYXRpb24KICAgICAgZWZmZWN0OiBudWxsLAogICAgICB1cGRhdGU6IG51bGwsCiAgICAgIC8vIHdpbGwgYmUgc2V0IHN5bmNocm9ub3VzbHkgcmlnaHQgYWZ0ZXIgY3JlYXRpb24KICAgICAgc2NvcGU6IG5ldyBFZmZlY3RTY29wZSgKICAgICAgICB0cnVlCiAgICAgICAgLyogZGV0YWNoZWQgKi8KICAgICAgKSwKICAgICAgcmVuZGVyOiBudWxsLAogICAgICBwcm94eTogbnVsbCwKICAgICAgZXhwb3NlZDogbnVsbCwKICAgICAgZXhwb3NlUHJveHk6IG51bGwsCiAgICAgIHdpdGhQcm94eTogbnVsbCwKICAgICAgcHJvdmlkZXM6IHBhcmVudCA/IHBhcmVudC5wcm92aWRlcyA6IE9iamVjdC5jcmVhdGUoYXBwQ29udGV4dC5wcm92aWRlcyksCiAgICAgIGFjY2Vzc0NhY2hlOiBudWxsLAogICAgICByZW5kZXJDYWNoZTogW10sCiAgICAgIC8vIGxvY2FsIHJlc29sdmVkIGFzc2V0cwogICAgICBjb21wb25lbnRzOiBudWxsLAogICAgICBkaXJlY3RpdmVzOiBudWxsLAogICAgICAvLyByZXNvbHZlZCBwcm9wcyBhbmQgZW1pdHMgb3B0aW9ucwogICAgICBwcm9wc09wdGlvbnM6IG5vcm1hbGl6ZVByb3BzT3B0aW9ucyh0eXBlLCBhcHBDb250ZXh0KSwKICAgICAgZW1pdHNPcHRpb25zOiBub3JtYWxpemVFbWl0c09wdGlvbnModHlwZSwgYXBwQ29udGV4dCksCiAgICAgIC8vIGVtaXQKICAgICAgZW1pdDogbnVsbCwKICAgICAgLy8gdG8gYmUgc2V0IGltbWVkaWF0ZWx5CiAgICAgIGVtaXR0ZWQ6IG51bGwsCiAgICAgIC8vIHByb3BzIGRlZmF1bHQgdmFsdWUKICAgICAgcHJvcHNEZWZhdWx0czogRU1QVFlfT0JKLAogICAgICAvLyBpbmhlcml0QXR0cnMKICAgICAgaW5oZXJpdEF0dHJzOiB0eXBlLmluaGVyaXRBdHRycywKICAgICAgLy8gc3RhdGUKICAgICAgY3R4OiBFTVBUWV9PQkosCiAgICAgIGRhdGE6IEVNUFRZX09CSiwKICAgICAgcHJvcHM6IEVNUFRZX09CSiwKICAgICAgYXR0cnM6IEVNUFRZX09CSiwKICAgICAgc2xvdHM6IEVNUFRZX09CSiwKICAgICAgcmVmczogRU1QVFlfT0JKLAogICAgICBzZXR1cFN0YXRlOiBFTVBUWV9PQkosCiAgICAgIHNldHVwQ29udGV4dDogbnVsbCwKICAgICAgYXR0cnNQcm94eTogbnVsbCwKICAgICAgc2xvdHNQcm94eTogbnVsbCwKICAgICAgLy8gc3VzcGVuc2UgcmVsYXRlZAogICAgICBzdXNwZW5zZSwKICAgICAgc3VzcGVuc2VJZDogc3VzcGVuc2UgPyBzdXNwZW5zZS5wZW5kaW5nSWQgOiAwLAogICAgICBhc3luY0RlcDogbnVsbCwKICAgICAgYXN5bmNSZXNvbHZlZDogZmFsc2UsCiAgICAgIC8vIGxpZmVjeWNsZSBob29rcwogICAgICAvLyBub3QgdXNpbmcgZW51bXMgaGVyZSBiZWNhdXNlIGl0IHJlc3VsdHMgaW4gY29tcHV0ZWQgcHJvcGVydGllcwogICAgICBpc01vdW50ZWQ6IGZhbHNlLAogICAgICBpc1VubW91bnRlZDogZmFsc2UsCiAgICAgIGlzRGVhY3RpdmF0ZWQ6IGZhbHNlLAogICAgICBiYzogbnVsbCwKICAgICAgYzogbnVsbCwKICAgICAgYm06IG51bGwsCiAgICAgIG06IG51bGwsCiAgICAgIGJ1OiBudWxsLAogICAgICB1OiBudWxsLAogICAgICB1bTogbnVsbCwKICAgICAgYnVtOiBudWxsLAogICAgICBkYTogbnVsbCwKICAgICAgYTogbnVsbCwKICAgICAgcnRnOiBudWxsLAogICAgICBydGM6IG51bGwsCiAgICAgIGVjOiBudWxsLAogICAgICBzcDogbnVsbAogICAgfTsKICAgIHsKICAgICAgaW5zdGFuY2UuY3R4ID0gY3JlYXRlRGV2UmVuZGVyQ29udGV4dChpbnN0YW5jZSk7CiAgICB9CiAgICBpbnN0YW5jZS5yb290ID0gcGFyZW50ID8gcGFyZW50LnJvb3QgOiBpbnN0YW5jZTsKICAgIGluc3RhbmNlLmVtaXQgPSBlbWl0LmJpbmQobnVsbCwgaW5zdGFuY2UpOwogICAgaWYgKHZub2RlLmNlKSB7CiAgICAgIHZub2RlLmNlKGluc3RhbmNlKTsKICAgIH0KICAgIHJldHVybiBpbnN0YW5jZTsKICB9CiAgbGV0IGN1cnJlbnRJbnN0YW5jZSA9IG51bGw7CiAgY29uc3QgZ2V0Q3VycmVudEluc3RhbmNlID0gKCkgPT4gY3VycmVudEluc3RhbmNlIHx8IGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZTsKICBsZXQgaW50ZXJuYWxTZXRDdXJyZW50SW5zdGFuY2U7CiAgbGV0IHNldEluU1NSU2V0dXBTdGF0ZTsKICB7CiAgICBpbnRlcm5hbFNldEN1cnJlbnRJbnN0YW5jZSA9IChpKSA9PiB7CiAgICAgIGN1cnJlbnRJbnN0YW5jZSA9IGk7CiAgICB9OwogICAgc2V0SW5TU1JTZXR1cFN0YXRlID0gKHYpID0+IHsKICAgICAgaXNJblNTUkNvbXBvbmVudFNldHVwID0gdjsKICAgIH07CiAgfQogIGNvbnN0IHNldEN1cnJlbnRJbnN0YW5jZSA9IChpbnN0YW5jZSkgPT4gewogICAgY29uc3QgcHJldiA9IGN1cnJlbnRJbnN0YW5jZTsKICAgIGludGVybmFsU2V0Q3VycmVudEluc3RhbmNlKGluc3RhbmNlKTsKICAgIGluc3RhbmNlLnNjb3BlLm9uKCk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpbnN0YW5jZS5zY29wZS5vZmYoKTsKICAgICAgaW50ZXJuYWxTZXRDdXJyZW50SW5zdGFuY2UocHJldik7CiAgICB9OwogIH07CiAgY29uc3QgdW5zZXRDdXJyZW50SW5zdGFuY2UgPSAoKSA9PiB7CiAgICBjdXJyZW50SW5zdGFuY2UgJiYgY3VycmVudEluc3RhbmNlLnNjb3BlLm9mZigpOwogICAgaW50ZXJuYWxTZXRDdXJyZW50SW5zdGFuY2UobnVsbCk7CiAgfTsKICBjb25zdCBpc0J1aWx0SW5UYWcgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgic2xvdCxjb21wb25lbnQiKTsKICBmdW5jdGlvbiB2YWxpZGF0ZUNvbXBvbmVudE5hbWUobmFtZSwgeyBpc05hdGl2ZVRhZyB9KSB7CiAgICBpZiAoaXNCdWlsdEluVGFnKG5hbWUpIHx8IGlzTmF0aXZlVGFnKG5hbWUpKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICAiRG8gbm90IHVzZSBidWlsdC1pbiBvciByZXNlcnZlZCBIVE1MIGVsZW1lbnRzIGFzIGNvbXBvbmVudCBpZDogIiArIG5hbWUKICAgICAgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gaXNTdGF0ZWZ1bENvbXBvbmVudChpbnN0YW5jZSkgewogICAgcmV0dXJuIGluc3RhbmNlLnZub2RlLnNoYXBlRmxhZyAmIDQ7CiAgfQogIGxldCBpc0luU1NSQ29tcG9uZW50U2V0dXAgPSBmYWxzZTsKICBmdW5jdGlvbiBzZXR1cENvbXBvbmVudChpbnN0YW5jZSwgaXNTU1IgPSBmYWxzZSkgewogICAgaXNTU1IgJiYgc2V0SW5TU1JTZXR1cFN0YXRlKGlzU1NSKTsKICAgIGNvbnN0IHsgcHJvcHMsIGNoaWxkcmVuIH0gPSBpbnN0YW5jZS52bm9kZTsKICAgIGNvbnN0IGlzU3RhdGVmdWwgPSBpc1N0YXRlZnVsQ29tcG9uZW50KGluc3RhbmNlKTsKICAgIGluaXRQcm9wcyhpbnN0YW5jZSwgcHJvcHMsIGlzU3RhdGVmdWwsIGlzU1NSKTsKICAgIGluaXRTbG90cyhpbnN0YW5jZSwgY2hpbGRyZW4pOwogICAgY29uc3Qgc2V0dXBSZXN1bHQgPSBpc1N0YXRlZnVsID8gc2V0dXBTdGF0ZWZ1bENvbXBvbmVudChpbnN0YW5jZSwgaXNTU1IpIDogdm9pZCAwOwogICAgaXNTU1IgJiYgc2V0SW5TU1JTZXR1cFN0YXRlKGZhbHNlKTsKICAgIHJldHVybiBzZXR1cFJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc2V0dXBTdGF0ZWZ1bENvbXBvbmVudChpbnN0YW5jZSwgaXNTU1IpIHsKICAgIHZhciBfYTsKICAgIGNvbnN0IENvbXBvbmVudCA9IGluc3RhbmNlLnR5cGU7CiAgICB7CiAgICAgIGlmIChDb21wb25lbnQubmFtZSkgewogICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShDb21wb25lbnQubmFtZSwgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcpOwogICAgICB9CiAgICAgIGlmIChDb21wb25lbnQuY29tcG9uZW50cykgewogICAgICAgIGNvbnN0IG5hbWVzID0gT2JqZWN0LmtleXMoQ29tcG9uZW50LmNvbXBvbmVudHMpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lc1tpXSwgaW5zdGFuY2UuYXBwQ29udGV4dC5jb25maWcpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoQ29tcG9uZW50LmRpcmVjdGl2ZXMpIHsKICAgICAgICBjb25zdCBuYW1lcyA9IE9iamVjdC5rZXlzKENvbXBvbmVudC5kaXJlY3RpdmVzKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YWxpZGF0ZURpcmVjdGl2ZU5hbWUobmFtZXNbaV0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoQ29tcG9uZW50LmNvbXBpbGVyT3B0aW9ucyAmJiBpc1J1bnRpbWVPbmx5KCkpIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBgImNvbXBpbGVyT3B0aW9ucyIgaXMgb25seSBzdXBwb3J0ZWQgd2hlbiB1c2luZyBhIGJ1aWxkIG9mIFZ1ZSB0aGF0IGluY2x1ZGVzIHRoZSBydW50aW1lIGNvbXBpbGVyLiBTaW5jZSB5b3UgYXJlIHVzaW5nIGEgcnVudGltZS1vbmx5IGJ1aWxkLCB0aGUgb3B0aW9ucyBzaG91bGQgYmUgcGFzc2VkIHZpYSB5b3VyIGJ1aWxkIHRvb2wgY29uZmlnIGluc3RlYWQuYAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIGluc3RhbmNlLmFjY2Vzc0NhY2hlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICBpbnN0YW5jZS5wcm94eSA9IG1hcmtSYXcobmV3IFByb3h5KGluc3RhbmNlLmN0eCwgUHVibGljSW5zdGFuY2VQcm94eUhhbmRsZXJzKSk7CiAgICB7CiAgICAgIGV4cG9zZVByb3BzT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKTsKICAgIH0KICAgIGNvbnN0IHsgc2V0dXAgfSA9IENvbXBvbmVudDsKICAgIGlmIChzZXR1cCkgewogICAgICBjb25zdCBzZXR1cENvbnRleHQgPSBpbnN0YW5jZS5zZXR1cENvbnRleHQgPSBzZXR1cC5sZW5ndGggPiAxID8gY3JlYXRlU2V0dXBDb250ZXh0KGluc3RhbmNlKSA6IG51bGw7CiAgICAgIGNvbnN0IHJlc2V0ID0gc2V0Q3VycmVudEluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgcGF1c2VUcmFja2luZygpOwogICAgICBjb25zdCBzZXR1cFJlc3VsdCA9IGNhbGxXaXRoRXJyb3JIYW5kbGluZygKICAgICAgICBzZXR1cCwKICAgICAgICBpbnN0YW5jZSwKICAgICAgICAwLAogICAgICAgIFsKICAgICAgICAgIHNoYWxsb3dSZWFkb25seShpbnN0YW5jZS5wcm9wcykgLAogICAgICAgICAgc2V0dXBDb250ZXh0CiAgICAgICAgXQogICAgICApOwogICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgIHJlc2V0KCk7CiAgICAgIGlmIChpc1Byb21pc2Uoc2V0dXBSZXN1bHQpKSB7CiAgICAgICAgc2V0dXBSZXN1bHQudGhlbih1bnNldEN1cnJlbnRJbnN0YW5jZSwgdW5zZXRDdXJyZW50SW5zdGFuY2UpOwogICAgICAgIGlmIChpc1NTUikgewogICAgICAgICAgcmV0dXJuIHNldHVwUmVzdWx0LnRoZW4oKHJlc29sdmVkUmVzdWx0KSA9PiB7CiAgICAgICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCByZXNvbHZlZFJlc3VsdCwgaXNTU1IpOwogICAgICAgICAgfSkuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgaGFuZGxlRXJyb3IoZSwgaW5zdGFuY2UsIDApOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluc3RhbmNlLmFzeW5jRGVwID0gc2V0dXBSZXN1bHQ7CiAgICAgICAgICBpZiAoIWluc3RhbmNlLnN1c3BlbnNlKSB7CiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSAoX2EgPSBDb21wb25lbnQubmFtZSkgIT0gbnVsbCA/IF9hIDogIkFub255bW91cyI7CiAgICAgICAgICAgIHdhcm4kMSgKICAgICAgICAgICAgICBgQ29tcG9uZW50IDwke25hbWV9Pjogc2V0dXAgZnVuY3Rpb24gcmV0dXJuZWQgYSBwcm9taXNlLCBidXQgbm8gPFN1c3BlbnNlPiBib3VuZGFyeSB3YXMgZm91bmQgaW4gdGhlIHBhcmVudCBjb21wb25lbnQgdHJlZS4gQSBjb21wb25lbnQgd2l0aCBhc3luYyBzZXR1cCgpIG11c3QgYmUgbmVzdGVkIGluIGEgPFN1c3BlbnNlPiBpbiBvcmRlciB0byBiZSByZW5kZXJlZC5gCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGhhbmRsZVNldHVwUmVzdWx0KGluc3RhbmNlLCBzZXR1cFJlc3VsdCwgaXNTU1IpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmaW5pc2hDb21wb25lbnRTZXR1cChpbnN0YW5jZSwgaXNTU1IpOwogICAgfQogIH0KICBmdW5jdGlvbiBoYW5kbGVTZXR1cFJlc3VsdChpbnN0YW5jZSwgc2V0dXBSZXN1bHQsIGlzU1NSKSB7CiAgICBpZiAoaXNGdW5jdGlvbihzZXR1cFJlc3VsdCkpIHsKICAgICAgewogICAgICAgIGluc3RhbmNlLnJlbmRlciA9IHNldHVwUmVzdWx0OwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNldHVwUmVzdWx0KSkgewogICAgICBpZiAoaXNWTm9kZShzZXR1cFJlc3VsdCkpIHsKICAgICAgICB3YXJuJDEoCiAgICAgICAgICBgc2V0dXAoKSBzaG91bGQgbm90IHJldHVybiBWTm9kZXMgZGlyZWN0bHkgLSByZXR1cm4gYSByZW5kZXIgZnVuY3Rpb24gaW5zdGVhZC5gCiAgICAgICAgKTsKICAgICAgfQogICAgICB7CiAgICAgICAgaW5zdGFuY2UuZGV2dG9vbHNSYXdTZXR1cFN0YXRlID0gc2V0dXBSZXN1bHQ7CiAgICAgIH0KICAgICAgaW5zdGFuY2Uuc2V0dXBTdGF0ZSA9IHByb3h5UmVmcyhzZXR1cFJlc3VsdCk7CiAgICAgIHsKICAgICAgICBleHBvc2VTZXR1cFN0YXRlT25SZW5kZXJDb250ZXh0KGluc3RhbmNlKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChzZXR1cFJlc3VsdCAhPT0gdm9pZCAwKSB7CiAgICAgIHdhcm4kMSgKICAgICAgICBgc2V0dXAoKSBzaG91bGQgcmV0dXJuIGFuIG9iamVjdC4gUmVjZWl2ZWQ6ICR7c2V0dXBSZXN1bHQgPT09IG51bGwgPyAibnVsbCIgOiB0eXBlb2Ygc2V0dXBSZXN1bHR9YAogICAgICApOwogICAgfQogICAgZmluaXNoQ29tcG9uZW50U2V0dXAoaW5zdGFuY2UsIGlzU1NSKTsKICB9CiAgbGV0IGNvbXBpbGUkMTsKICBsZXQgaW5zdGFsbFdpdGhQcm94eTsKICBmdW5jdGlvbiByZWdpc3RlclJ1bnRpbWVDb21waWxlcihfY29tcGlsZSkgewogICAgY29tcGlsZSQxID0gX2NvbXBpbGU7CiAgICBpbnN0YWxsV2l0aFByb3h5ID0gKGkpID0+IHsKICAgICAgaWYgKGkucmVuZGVyLl9yYykgewogICAgICAgIGkud2l0aFByb3h5ID0gbmV3IFByb3h5KGkuY3R4LCBSdW50aW1lQ29tcGlsZWRQdWJsaWNJbnN0YW5jZVByb3h5SGFuZGxlcnMpOwogICAgICB9CiAgICB9OwogIH0KICBjb25zdCBpc1J1bnRpbWVPbmx5ID0gKCkgPT4gIWNvbXBpbGUkMTsKICBmdW5jdGlvbiBmaW5pc2hDb21wb25lbnRTZXR1cChpbnN0YW5jZSwgaXNTU1IsIHNraXBPcHRpb25zKSB7CiAgICBjb25zdCBDb21wb25lbnQgPSBpbnN0YW5jZS50eXBlOwogICAgaWYgKCFpbnN0YW5jZS5yZW5kZXIpIHsKICAgICAgaWYgKCFpc1NTUiAmJiBjb21waWxlJDEgJiYgIUNvbXBvbmVudC5yZW5kZXIpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IENvbXBvbmVudC50ZW1wbGF0ZSB8fCByZXNvbHZlTWVyZ2VkT3B0aW9ucyhpbnN0YW5jZSkudGVtcGxhdGU7CiAgICAgICAgaWYgKHRlbXBsYXRlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN0YXJ0TWVhc3VyZShpbnN0YW5jZSwgYGNvbXBpbGVgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHsgaXNDdXN0b21FbGVtZW50LCBjb21waWxlck9wdGlvbnMgfSA9IGluc3RhbmNlLmFwcENvbnRleHQuY29uZmlnOwogICAgICAgICAgY29uc3QgeyBkZWxpbWl0ZXJzLCBjb21waWxlck9wdGlvbnM6IGNvbXBvbmVudENvbXBpbGVyT3B0aW9ucyB9ID0gQ29tcG9uZW50OwogICAgICAgICAgY29uc3QgZmluYWxDb21waWxlck9wdGlvbnMgPSBleHRlbmQoCiAgICAgICAgICAgIGV4dGVuZCgKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpc0N1c3RvbUVsZW1lbnQsCiAgICAgICAgICAgICAgICBkZWxpbWl0ZXJzCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjb21waWxlck9wdGlvbnMKICAgICAgICAgICAgKSwKICAgICAgICAgICAgY29tcG9uZW50Q29tcGlsZXJPcHRpb25zCiAgICAgICAgICApOwogICAgICAgICAgQ29tcG9uZW50LnJlbmRlciA9IGNvbXBpbGUkMSh0ZW1wbGF0ZSwgZmluYWxDb21waWxlck9wdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICBlbmRNZWFzdXJlKGluc3RhbmNlLCBgY29tcGlsZWApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpbnN0YW5jZS5yZW5kZXIgPSBDb21wb25lbnQucmVuZGVyIHx8IE5PT1A7CiAgICAgIGlmIChpbnN0YWxsV2l0aFByb3h5KSB7CiAgICAgICAgaW5zdGFsbFdpdGhQcm94eShpbnN0YW5jZSk7CiAgICAgIH0KICAgIH0KICAgIHsKICAgICAgY29uc3QgcmVzZXQgPSBzZXRDdXJyZW50SW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICBwYXVzZVRyYWNraW5nKCk7CiAgICAgIHRyeSB7CiAgICAgICAgYXBwbHlPcHRpb25zKGluc3RhbmNlKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICByZXNldFRyYWNraW5nKCk7CiAgICAgICAgcmVzZXQoKTsKICAgICAgfQogICAgfQogICAgaWYgKCFDb21wb25lbnQucmVuZGVyICYmIGluc3RhbmNlLnJlbmRlciA9PT0gTk9PUCAmJiAhaXNTU1IpIHsKICAgICAgaWYgKCFjb21waWxlJDEgJiYgQ29tcG9uZW50LnRlbXBsYXRlKSB7CiAgICAgICAgd2FybiQxKAogICAgICAgICAgYENvbXBvbmVudCBwcm92aWRlZCB0ZW1wbGF0ZSBvcHRpb24gYnV0IHJ1bnRpbWUgY29tcGlsYXRpb24gaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJ1aWxkIG9mIFZ1ZS5gICsgKGAgVXNlICJ2dWUuZ2xvYmFsLmpzIiBpbnN0ZWFkLmAgKQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2FybiQxKGBDb21wb25lbnQgaXMgbWlzc2luZyB0ZW1wbGF0ZSBvciByZW5kZXIgZnVuY3Rpb24uYCk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0QXR0cnNQcm94eShpbnN0YW5jZSkgewogICAgcmV0dXJuIGluc3RhbmNlLmF0dHJzUHJveHkgfHwgKGluc3RhbmNlLmF0dHJzUHJveHkgPSBuZXcgUHJveHkoCiAgICAgIGluc3RhbmNlLmF0dHJzLAogICAgICB7CiAgICAgICAgZ2V0KHRhcmdldCwga2V5KSB7CiAgICAgICAgICBtYXJrQXR0cnNBY2Nlc3NlZCgpOwogICAgICAgICAgdHJhY2soaW5zdGFuY2UsICJnZXQiLCAiJGF0dHJzIik7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0W2tleV07CiAgICAgICAgfSwKICAgICAgICBzZXQoKSB7CiAgICAgICAgICB3YXJuJDEoYHNldHVwQ29udGV4dC5hdHRycyBpcyByZWFkb25seS5gKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAogICAgICAgIGRlbGV0ZVByb3BlcnR5KCkgewogICAgICAgICAgd2FybiQxKGBzZXR1cENvbnRleHQuYXR0cnMgaXMgcmVhZG9ubHkuYCk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9IAogICAgKSk7CiAgfQogIGZ1bmN0aW9uIGdldFNsb3RzUHJveHkoaW5zdGFuY2UpIHsKICAgIHJldHVybiBpbnN0YW5jZS5zbG90c1Byb3h5IHx8IChpbnN0YW5jZS5zbG90c1Byb3h5ID0gbmV3IFByb3h5KGluc3RhbmNlLnNsb3RzLCB7CiAgICAgIGdldCh0YXJnZXQsIGtleSkgewogICAgICAgIHRyYWNrKGluc3RhbmNlLCAiZ2V0IiwgIiRzbG90cyIpOwogICAgICAgIHJldHVybiB0YXJnZXRba2V5XTsKICAgICAgfQogICAgfSkpOwogIH0KICBmdW5jdGlvbiBjcmVhdGVTZXR1cENvbnRleHQoaW5zdGFuY2UpIHsKICAgIGNvbnN0IGV4cG9zZSA9IChleHBvc2VkKSA9PiB7CiAgICAgIHsKICAgICAgICBpZiAoaW5zdGFuY2UuZXhwb3NlZCkgewogICAgICAgICAgd2FybiQxKGBleHBvc2UoKSBzaG91bGQgYmUgY2FsbGVkIG9ubHkgb25jZSBwZXIgc2V0dXAoKS5gKTsKICAgICAgICB9CiAgICAgICAgaWYgKGV4cG9zZWQgIT0gbnVsbCkgewogICAgICAgICAgbGV0IGV4cG9zZWRUeXBlID0gdHlwZW9mIGV4cG9zZWQ7CiAgICAgICAgICBpZiAoZXhwb3NlZFR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGlmIChpc0FycmF5KGV4cG9zZWQpKSB7CiAgICAgICAgICAgICAgZXhwb3NlZFR5cGUgPSAiYXJyYXkiOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzUmVmKGV4cG9zZWQpKSB7CiAgICAgICAgICAgICAgZXhwb3NlZFR5cGUgPSAicmVmIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cG9zZWRUeXBlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB3YXJuJDEoCiAgICAgICAgICAgICAgYGV4cG9zZSgpIHNob3VsZCBiZSBwYXNzZWQgYSBwbGFpbiBvYmplY3QsIHJlY2VpdmVkICR7ZXhwb3NlZFR5cGV9LmAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaW5zdGFuY2UuZXhwb3NlZCA9IGV4cG9zZWQgfHwge307CiAgICB9OwogICAgewogICAgICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7CiAgICAgICAgZ2V0IGF0dHJzKCkgewogICAgICAgICAgcmV0dXJuIGdldEF0dHJzUHJveHkoaW5zdGFuY2UpOwogICAgICAgIH0sCiAgICAgICAgZ2V0IHNsb3RzKCkgewogICAgICAgICAgcmV0dXJuIGdldFNsb3RzUHJveHkoaW5zdGFuY2UpOwogICAgICAgIH0sCiAgICAgICAgZ2V0IGVtaXQoKSB7CiAgICAgICAgICByZXR1cm4gKGV2ZW50LCAuLi5hcmdzKSA9PiBpbnN0YW5jZS5lbWl0KGV2ZW50LCAuLi5hcmdzKTsKICAgICAgICB9LAogICAgICAgIGV4cG9zZQogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0RXhwb3NlUHJveHkoaW5zdGFuY2UpIHsKICAgIGlmIChpbnN0YW5jZS5leHBvc2VkKSB7CiAgICAgIHJldHVybiBpbnN0YW5jZS5leHBvc2VQcm94eSB8fCAoaW5zdGFuY2UuZXhwb3NlUHJveHkgPSBuZXcgUHJveHkocHJveHlSZWZzKG1hcmtSYXcoaW5zdGFuY2UuZXhwb3NlZCkpLCB7CiAgICAgICAgZ2V0KHRhcmdldCwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5IGluIHRhcmdldCkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0W2tleV07CiAgICAgICAgICB9IGVsc2UgaWYgKGtleSBpbiBwdWJsaWNQcm9wZXJ0aWVzTWFwKSB7CiAgICAgICAgICAgIHJldHVybiBwdWJsaWNQcm9wZXJ0aWVzTWFwW2tleV0oaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgaGFzKHRhcmdldCwga2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5IGluIHRhcmdldCB8fCBrZXkgaW4gcHVibGljUHJvcGVydGllc01hcDsKICAgICAgICB9CiAgICAgIH0pKTsKICAgIH0KICB9CiAgY29uc3QgY2xhc3NpZnlSRSA9IC8oPzpefFstX10pKFx3KS9nOwogIGNvbnN0IGNsYXNzaWZ5ID0gKHN0cikgPT4gc3RyLnJlcGxhY2UoY2xhc3NpZnlSRSwgKGMpID0+IGMudG9VcHBlckNhc2UoKSkucmVwbGFjZSgvWy1fXS9nLCAiIik7CiAgZnVuY3Rpb24gZ2V0Q29tcG9uZW50TmFtZShDb21wb25lbnQsIGluY2x1ZGVJbmZlcnJlZCA9IHRydWUpIHsKICAgIHJldHVybiBpc0Z1bmN0aW9uKENvbXBvbmVudCkgPyBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgOiBDb21wb25lbnQubmFtZSB8fCBpbmNsdWRlSW5mZXJyZWQgJiYgQ29tcG9uZW50Ll9fbmFtZTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0Q29tcG9uZW50TmFtZShpbnN0YW5jZSwgQ29tcG9uZW50LCBpc1Jvb3QgPSBmYWxzZSkgewogICAgbGV0IG5hbWUgPSBnZXRDb21wb25lbnROYW1lKENvbXBvbmVudCk7CiAgICBpZiAoIW5hbWUgJiYgQ29tcG9uZW50Ll9fZmlsZSkgewogICAgICBjb25zdCBtYXRjaCA9IENvbXBvbmVudC5fX2ZpbGUubWF0Y2goLyhbXi9cXF0rKVwuXHcrJC8pOwogICAgICBpZiAobWF0Y2gpIHsKICAgICAgICBuYW1lID0gbWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIGlmICghbmFtZSAmJiBpbnN0YW5jZSAmJiBpbnN0YW5jZS5wYXJlbnQpIHsKICAgICAgY29uc3QgaW5mZXJGcm9tUmVnaXN0cnkgPSAocmVnaXN0cnkpID0+IHsKICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiByZWdpc3RyeSkgewogICAgICAgICAgaWYgKHJlZ2lzdHJ5W2tleV0gPT09IENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgbmFtZSA9IGluZmVyRnJvbVJlZ2lzdHJ5KAogICAgICAgIGluc3RhbmNlLmNvbXBvbmVudHMgfHwgaW5zdGFuY2UucGFyZW50LnR5cGUuY29tcG9uZW50cwogICAgICApIHx8IGluZmVyRnJvbVJlZ2lzdHJ5KGluc3RhbmNlLmFwcENvbnRleHQuY29tcG9uZW50cyk7CiAgICB9CiAgICByZXR1cm4gbmFtZSA/IGNsYXNzaWZ5KG5hbWUpIDogaXNSb290ID8gYEFwcGAgOiBgQW5vbnltb3VzYDsKICB9CiAgZnVuY3Rpb24gaXNDbGFzc0NvbXBvbmVudCh2YWx1ZSkgewogICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpICYmICJfX3ZjY09wdHMiIGluIHZhbHVlOwogIH0KCiAgY29uc3QgY29tcHV0ZWQgPSAoZ2V0dGVyT3JPcHRpb25zLCBkZWJ1Z09wdGlvbnMpID0+IHsKICAgIGNvbnN0IGMgPSBjb21wdXRlZCQxKGdldHRlck9yT3B0aW9ucywgZGVidWdPcHRpb25zLCBpc0luU1NSQ29tcG9uZW50U2V0dXApOwogICAgewogICAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICAgIGlmIChpICYmIGkuYXBwQ29udGV4dC5jb25maWcud2FyblJlY3Vyc2l2ZUNvbXB1dGVkKSB7CiAgICAgICAgYy5fd2FyblJlY3Vyc2l2ZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjOwogIH07CgogIGZ1bmN0aW9uIHVzZU1vZGVsKHByb3BzLCBuYW1lLCBvcHRpb25zID0gRU1QVFlfT0JKKSB7CiAgICBjb25zdCBpID0gZ2V0Q3VycmVudEluc3RhbmNlKCk7CiAgICBpZiAoIWkpIHsKICAgICAgd2FybiQxKGB1c2VNb2RlbCgpIGNhbGxlZCB3aXRob3V0IGFjdGl2ZSBpbnN0YW5jZS5gKTsKICAgICAgcmV0dXJuIHJlZigpOwogICAgfQogICAgaWYgKCFpLnByb3BzT3B0aW9uc1swXVtuYW1lXSkgewogICAgICB3YXJuJDEoYHVzZU1vZGVsKCkgY2FsbGVkIHdpdGggcHJvcCAiJHtuYW1lfSIgd2hpY2ggaXMgbm90IGRlY2xhcmVkLmApOwogICAgICByZXR1cm4gcmVmKCk7CiAgICB9CiAgICBjb25zdCBjYW1lbGl6ZWROYW1lID0gY2FtZWxpemUobmFtZSk7CiAgICBjb25zdCBoeXBoZW5hdGVkTmFtZSA9IGh5cGhlbmF0ZShuYW1lKTsKICAgIGNvbnN0IHJlcyA9IGN1c3RvbVJlZigodHJhY2ssIHRyaWdnZXIpID0+IHsKICAgICAgbGV0IGxvY2FsVmFsdWU7CiAgICAgIHdhdGNoU3luY0VmZmVjdCgoKSA9PiB7CiAgICAgICAgY29uc3QgcHJvcFZhbHVlID0gcHJvcHNbbmFtZV07CiAgICAgICAgaWYgKGhhc0NoYW5nZWQobG9jYWxWYWx1ZSwgcHJvcFZhbHVlKSkgewogICAgICAgICAgbG9jYWxWYWx1ZSA9IHByb3BWYWx1ZTsKICAgICAgICAgIHRyaWdnZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gewogICAgICAgIGdldCgpIHsKICAgICAgICAgIHRyYWNrKCk7CiAgICAgICAgICByZXR1cm4gb3B0aW9ucy5nZXQgPyBvcHRpb25zLmdldChsb2NhbFZhbHVlKSA6IGxvY2FsVmFsdWU7CiAgICAgICAgfSwKICAgICAgICBzZXQodmFsdWUpIHsKICAgICAgICAgIGNvbnN0IHJhd1Byb3BzID0gaS52bm9kZS5wcm9wczsKICAgICAgICAgIGlmICghKHJhd1Byb3BzICYmIC8vIGNoZWNrIGlmIHBhcmVudCBoYXMgcGFzc2VkIHYtbW9kZWwKICAgICAgICAgIChuYW1lIGluIHJhd1Byb3BzIHx8IGNhbWVsaXplZE5hbWUgaW4gcmF3UHJvcHMgfHwgaHlwaGVuYXRlZE5hbWUgaW4gcmF3UHJvcHMpICYmIChgb25VcGRhdGU6JHtuYW1lfWAgaW4gcmF3UHJvcHMgfHwgYG9uVXBkYXRlOiR7Y2FtZWxpemVkTmFtZX1gIGluIHJhd1Byb3BzIHx8IGBvblVwZGF0ZToke2h5cGhlbmF0ZWROYW1lfWAgaW4gcmF3UHJvcHMpKSAmJiBoYXNDaGFuZ2VkKHZhbHVlLCBsb2NhbFZhbHVlKSkgewogICAgICAgICAgICBsb2NhbFZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIHRyaWdnZXIoKTsKICAgICAgICAgIH0KICAgICAgICAgIGkuZW1pdChgdXBkYXRlOiR7bmFtZX1gLCBvcHRpb25zLnNldCA/IG9wdGlvbnMuc2V0KHZhbHVlKSA6IHZhbHVlKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIGNvbnN0IG1vZGlmaWVyS2V5ID0gbmFtZSA9PT0gIm1vZGVsVmFsdWUiID8gIm1vZGVsTW9kaWZpZXJzIiA6IGAke25hbWV9TW9kaWZpZXJzYDsKICAgIHJlc1tTeW1ib2wuaXRlcmF0b3JdID0gKCkgPT4gewogICAgICBsZXQgaTIgPSAwOwogICAgICByZXR1cm4gewogICAgICAgIG5leHQoKSB7CiAgICAgICAgICBpZiAoaTIgPCAyKSB7CiAgICAgICAgICAgIHJldHVybiB7IHZhbHVlOiBpMisrID8gcHJvcHNbbW9kaWZpZXJLZXldIHx8IHt9IDogcmVzLCBkb25lOiBmYWxzZSB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHsgZG9uZTogdHJ1ZSB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgICByZXR1cm4gcmVzOwogIH0KCiAgZnVuY3Rpb24gaCh0eXBlLCBwcm9wc09yQ2hpbGRyZW4sIGNoaWxkcmVuKSB7CiAgICBjb25zdCBsID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIGlmIChsID09PSAyKSB7CiAgICAgIGlmIChpc09iamVjdChwcm9wc09yQ2hpbGRyZW4pICYmICFpc0FycmF5KHByb3BzT3JDaGlsZHJlbikpIHsKICAgICAgICBpZiAoaXNWTm9kZShwcm9wc09yQ2hpbGRyZW4pKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUodHlwZSwgbnVsbCwgW3Byb3BzT3JDaGlsZHJlbl0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUodHlwZSwgcHJvcHNPckNoaWxkcmVuKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUodHlwZSwgbnVsbCwgcHJvcHNPckNoaWxkcmVuKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGwgPiAzKSB7CiAgICAgICAgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICB9IGVsc2UgaWYgKGwgPT09IDMgJiYgaXNWTm9kZShjaGlsZHJlbikpIHsKICAgICAgICBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CiAgICAgIH0KICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlKHR5cGUsIHByb3BzT3JDaGlsZHJlbiwgY2hpbGRyZW4pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdEN1c3RvbUZvcm1hdHRlcigpIHsKICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB2dWVTdHlsZSA9IHsgc3R5bGU6ICJjb2xvcjojM2JhNzc2IiB9OwogICAgY29uc3QgbnVtYmVyU3R5bGUgPSB7IHN0eWxlOiAiY29sb3I6IzE2NzdmZiIgfTsKICAgIGNvbnN0IHN0cmluZ1N0eWxlID0geyBzdHlsZTogImNvbG9yOiNmNTIyMmQiIH07CiAgICBjb25zdCBrZXl3b3JkU3R5bGUgPSB7IHN0eWxlOiAiY29sb3I6I2ViMmY5NiIgfTsKICAgIGNvbnN0IGZvcm1hdHRlciA9IHsKICAgICAgaGVhZGVyKG9iaikgewogICAgICAgIGlmICghaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGlmIChvYmouX19pc1Z1ZSkgewogICAgICAgICAgcmV0dXJuIFsiZGl2IiwgdnVlU3R5bGUsIGBWdWVJbnN0YW5jZWBdOwogICAgICAgIH0gZWxzZSBpZiAoaXNSZWYob2JqKSkgewogICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgIHt9LAogICAgICAgICAgICBbInNwYW4iLCB2dWVTdHlsZSwgZ2VuUmVmRmxhZyhvYmopXSwKICAgICAgICAgICAgIjwiLAogICAgICAgICAgICBmb3JtYXRWYWx1ZShvYmoudmFsdWUpLAogICAgICAgICAgICBgPmAKICAgICAgICAgIF07CiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWN0aXZlKG9iaikpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICB7fSwKICAgICAgICAgICAgWyJzcGFuIiwgdnVlU3R5bGUsIGlzU2hhbGxvdyhvYmopID8gIlNoYWxsb3dSZWFjdGl2ZSIgOiAiUmVhY3RpdmUiXSwKICAgICAgICAgICAgIjwiLAogICAgICAgICAgICBmb3JtYXRWYWx1ZShvYmopLAogICAgICAgICAgICBgPiR7aXNSZWFkb25seShvYmopID8gYCAocmVhZG9ubHkpYCA6IGBgfWAKICAgICAgICAgIF07CiAgICAgICAgfSBlbHNlIGlmIChpc1JlYWRvbmx5KG9iaikpIHsKICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICB7fSwKICAgICAgICAgICAgWyJzcGFuIiwgdnVlU3R5bGUsIGlzU2hhbGxvdyhvYmopID8gIlNoYWxsb3dSZWFkb25seSIgOiAiUmVhZG9ubHkiXSwKICAgICAgICAgICAgIjwiLAogICAgICAgICAgICBmb3JtYXRWYWx1ZShvYmopLAogICAgICAgICAgICAiPiIKICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICBoYXNCb2R5KG9iaikgewogICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9faXNWdWU7CiAgICAgIH0sCiAgICAgIGJvZHkob2JqKSB7CiAgICAgICAgaWYgKG9iaiAmJiBvYmouX19pc1Z1ZSkgewogICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgImRpdiIsCiAgICAgICAgICAgIHt9LAogICAgICAgICAgICAuLi5mb3JtYXRJbnN0YW5jZShvYmouJCkKICAgICAgICAgIF07CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gZm9ybWF0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgY29uc3QgYmxvY2tzID0gW107CiAgICAgIGlmIChpbnN0YW5jZS50eXBlLnByb3BzICYmIGluc3RhbmNlLnByb3BzKSB7CiAgICAgICAgYmxvY2tzLnB1c2goY3JlYXRlSW5zdGFuY2VCbG9jaygicHJvcHMiLCB0b1JhdyhpbnN0YW5jZS5wcm9wcykpKTsKICAgICAgfQogICAgICBpZiAoaW5zdGFuY2Uuc2V0dXBTdGF0ZSAhPT0gRU1QVFlfT0JKKSB7CiAgICAgICAgYmxvY2tzLnB1c2goY3JlYXRlSW5zdGFuY2VCbG9jaygic2V0dXAiLCBpbnN0YW5jZS5zZXR1cFN0YXRlKSk7CiAgICAgIH0KICAgICAgaWYgKGluc3RhbmNlLmRhdGEgIT09IEVNUFRZX09CSikgewogICAgICAgIGJsb2Nrcy5wdXNoKGNyZWF0ZUluc3RhbmNlQmxvY2soImRhdGEiLCB0b1JhdyhpbnN0YW5jZS5kYXRhKSkpOwogICAgICB9CiAgICAgIGNvbnN0IGNvbXB1dGVkID0gZXh0cmFjdEtleXMoaW5zdGFuY2UsICJjb21wdXRlZCIpOwogICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCJjb21wdXRlZCIsIGNvbXB1dGVkKSk7CiAgICAgIH0KICAgICAgY29uc3QgaW5qZWN0ZWQgPSBleHRyYWN0S2V5cyhpbnN0YW5jZSwgImluamVjdCIpOwogICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICBibG9ja3MucHVzaChjcmVhdGVJbnN0YW5jZUJsb2NrKCJpbmplY3RlZCIsIGluamVjdGVkKSk7CiAgICAgIH0KICAgICAgYmxvY2tzLnB1c2goWwogICAgICAgICJkaXYiLAogICAgICAgIHt9LAogICAgICAgIFsKICAgICAgICAgICJzcGFuIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IGtleXdvcmRTdHlsZS5zdHlsZSArICI7b3BhY2l0eTowLjY2IgogICAgICAgICAgfSwKICAgICAgICAgICIkIChpbnRlcm5hbCk6ICIKICAgICAgICBdLAogICAgICAgIFsib2JqZWN0IiwgeyBvYmplY3Q6IGluc3RhbmNlIH1dCiAgICAgIF0pOwogICAgICByZXR1cm4gYmxvY2tzOwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2VCbG9jayh0eXBlLCB0YXJnZXQpIHsKICAgICAgdGFyZ2V0ID0gZXh0ZW5kKHt9LCB0YXJnZXQpOwogICAgICBpZiAoIU9iamVjdC5rZXlzKHRhcmdldCkubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIFsic3BhbiIsIHt9XTsKICAgICAgfQogICAgICByZXR1cm4gWwogICAgICAgICJkaXYiLAogICAgICAgIHsgc3R5bGU6ICJsaW5lLWhlaWdodDoxLjI1ZW07bWFyZ2luLWJvdHRvbTowLjZlbSIgfSwKICAgICAgICBbCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6ICJjb2xvcjojNDc2NTgyIgogICAgICAgICAgfSwKICAgICAgICAgIHR5cGUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICJkaXYiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogInBhZGRpbmctbGVmdDoxLjI1ZW0iCiAgICAgICAgICB9LAogICAgICAgICAgLi4uT2JqZWN0LmtleXModGFyZ2V0KS5tYXAoKGtleSkgPT4gewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICJkaXYiLAogICAgICAgICAgICAgIHt9LAogICAgICAgICAgICAgIFsic3BhbiIsIGtleXdvcmRTdHlsZSwga2V5ICsgIjogIl0sCiAgICAgICAgICAgICAgZm9ybWF0VmFsdWUodGFyZ2V0W2tleV0sIGZhbHNlKQogICAgICAgICAgICBdOwogICAgICAgICAgfSkKICAgICAgICBdCiAgICAgIF07CiAgICB9CiAgICBmdW5jdGlvbiBmb3JtYXRWYWx1ZSh2LCBhc1JhdyA9IHRydWUpIHsKICAgICAgaWYgKHR5cGVvZiB2ID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiBbInNwYW4iLCBudW1iZXJTdHlsZSwgdl07CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIFsic3BhbiIsIHN0cmluZ1N0eWxlLCBKU09OLnN0cmluZ2lmeSh2KV07CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHYgPT09ICJib29sZWFuIikgewogICAgICAgIHJldHVybiBbInNwYW4iLCBrZXl3b3JkU3R5bGUsIHZdOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHYpKSB7CiAgICAgICAgcmV0dXJuIFsib2JqZWN0IiwgeyBvYmplY3Q6IGFzUmF3ID8gdG9SYXcodikgOiB2IH1dOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbInNwYW4iLCBzdHJpbmdTdHlsZSwgU3RyaW5nKHYpXTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZXh0cmFjdEtleXMoaW5zdGFuY2UsIHR5cGUpIHsKICAgICAgY29uc3QgQ29tcCA9IGluc3RhbmNlLnR5cGU7CiAgICAgIGlmIChpc0Z1bmN0aW9uKENvbXApKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IGV4dHJhY3RlZCA9IHt9OwogICAgICBmb3IgKGNvbnN0IGtleSBpbiBpbnN0YW5jZS5jdHgpIHsKICAgICAgICBpZiAoaXNLZXlPZlR5cGUoQ29tcCwga2V5LCB0eXBlKSkgewogICAgICAgICAgZXh0cmFjdGVkW2tleV0gPSBpbnN0YW5jZS5jdHhba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGV4dHJhY3RlZDsKICAgIH0KICAgIGZ1bmN0aW9uIGlzS2V5T2ZUeXBlKENvbXAsIGtleSwgdHlwZSkgewogICAgICBjb25zdCBvcHRzID0gQ29tcFt0eXBlXTsKICAgICAgaWYgKGlzQXJyYXkob3B0cykgJiYgb3B0cy5pbmNsdWRlcyhrZXkpIHx8IGlzT2JqZWN0KG9wdHMpICYmIGtleSBpbiBvcHRzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKENvbXAuZXh0ZW5kcyAmJiBpc0tleU9mVHlwZShDb21wLmV4dGVuZHMsIGtleSwgdHlwZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoQ29tcC5taXhpbnMgJiYgQ29tcC5taXhpbnMuc29tZSgobSkgPT4gaXNLZXlPZlR5cGUobSwga2V5LCB0eXBlKSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2VuUmVmRmxhZyh2KSB7CiAgICAgIGlmIChpc1NoYWxsb3codikpIHsKICAgICAgICByZXR1cm4gYFNoYWxsb3dSZWZgOwogICAgICB9CiAgICAgIGlmICh2LmVmZmVjdCkgewogICAgICAgIHJldHVybiBgQ29tcHV0ZWRSZWZgOwogICAgICB9CiAgICAgIHJldHVybiBgUmVmYDsKICAgIH0KICAgIGlmICh3aW5kb3cuZGV2dG9vbHNGb3JtYXR0ZXJzKSB7CiAgICAgIHdpbmRvdy5kZXZ0b29sc0Zvcm1hdHRlcnMucHVzaChmb3JtYXR0ZXIpOwogICAgfSBlbHNlIHsKICAgICAgd2luZG93LmRldnRvb2xzRm9ybWF0dGVycyA9IFtmb3JtYXR0ZXJdOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd2l0aE1lbW8obWVtbywgcmVuZGVyLCBjYWNoZSwgaW5kZXgpIHsKICAgIGNvbnN0IGNhY2hlZCA9IGNhY2hlW2luZGV4XTsKICAgIGlmIChjYWNoZWQgJiYgaXNNZW1vU2FtZShjYWNoZWQsIG1lbW8pKSB7CiAgICAgIHJldHVybiBjYWNoZWQ7CiAgICB9CiAgICBjb25zdCByZXQgPSByZW5kZXIoKTsKICAgIHJldC5tZW1vID0gbWVtby5zbGljZSgpOwogICAgcmV0dXJuIGNhY2hlW2luZGV4XSA9IHJldDsKICB9CiAgZnVuY3Rpb24gaXNNZW1vU2FtZShjYWNoZWQsIG1lbW8pIHsKICAgIGNvbnN0IHByZXYgPSBjYWNoZWQubWVtbzsKICAgIGlmIChwcmV2Lmxlbmd0aCAhPSBtZW1vLmxlbmd0aCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZXYubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGhhc0NoYW5nZWQocHJldltpXSwgbWVtb1tpXSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc0Jsb2NrVHJlZUVuYWJsZWQgPiAwICYmIGN1cnJlbnRCbG9jaykgewogICAgICBjdXJyZW50QmxvY2sucHVzaChjYWNoZWQpOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBjb25zdCB2ZXJzaW9uID0gIjMuNC4yMSI7CiAgY29uc3Qgd2FybiA9IHdhcm4kMSA7CiAgY29uc3QgRXJyb3JUeXBlU3RyaW5ncyA9IEVycm9yVHlwZVN0cmluZ3MkMSA7CiAgY29uc3QgZGV2dG9vbHMgPSBkZXZ0b29scyQxIDsKICBjb25zdCBzZXREZXZ0b29sc0hvb2sgPSBzZXREZXZ0b29sc0hvb2skMSA7CiAgY29uc3Qgc3NyVXRpbHMgPSBudWxsOwogIGNvbnN0IHJlc29sdmVGaWx0ZXIgPSBudWxsOwogIGNvbnN0IGNvbXBhdFV0aWxzID0gbnVsbDsKICBjb25zdCBEZXByZWNhdGlvblR5cGVzID0gbnVsbDsKCiAgY29uc3Qgc3ZnTlMgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogIGNvbnN0IG1hdGhtbE5TID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTgvTWF0aC9NYXRoTUwiOwogIGNvbnN0IGRvYyA9IHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IG51bGw7CiAgY29uc3QgdGVtcGxhdGVDb250YWluZXIgPSBkb2MgJiYgLyogQF9fUFVSRV9fICovIGRvYy5jcmVhdGVFbGVtZW50KCJ0ZW1wbGF0ZSIpOwogIGNvbnN0IG5vZGVPcHMgPSB7CiAgICBpbnNlcnQ6IChjaGlsZCwgcGFyZW50LCBhbmNob3IpID0+IHsKICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjaGlsZCwgYW5jaG9yIHx8IG51bGwpOwogICAgfSwKICAgIHJlbW92ZTogKGNoaWxkKSA9PiB7CiAgICAgIGNvbnN0IHBhcmVudCA9IGNoaWxkLnBhcmVudE5vZGU7CiAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICB9CiAgICB9LAogICAgY3JlYXRlRWxlbWVudDogKHRhZywgbmFtZXNwYWNlLCBpcywgcHJvcHMpID0+IHsKICAgICAgY29uc3QgZWwgPSBuYW1lc3BhY2UgPT09ICJzdmciID8gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgdGFnKSA6IG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIgPyBkb2MuY3JlYXRlRWxlbWVudE5TKG1hdGhtbE5TLCB0YWcpIDogZG9jLmNyZWF0ZUVsZW1lbnQodGFnLCBpcyA/IHsgaXMgfSA6IHZvaWQgMCk7CiAgICAgIGlmICh0YWcgPT09ICJzZWxlY3QiICYmIHByb3BzICYmIHByb3BzLm11bHRpcGxlICE9IG51bGwpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoIm11bHRpcGxlIiwgcHJvcHMubXVsdGlwbGUpOwogICAgICB9CiAgICAgIHJldHVybiBlbDsKICAgIH0sCiAgICBjcmVhdGVUZXh0OiAodGV4dCkgPT4gZG9jLmNyZWF0ZVRleHROb2RlKHRleHQpLAogICAgY3JlYXRlQ29tbWVudDogKHRleHQpID0+IGRvYy5jcmVhdGVDb21tZW50KHRleHQpLAogICAgc2V0VGV4dDogKG5vZGUsIHRleHQpID0+IHsKICAgICAgbm9kZS5ub2RlVmFsdWUgPSB0ZXh0OwogICAgfSwKICAgIHNldEVsZW1lbnRUZXh0OiAoZWwsIHRleHQpID0+IHsKICAgICAgZWwudGV4dENvbnRlbnQgPSB0ZXh0OwogICAgfSwKICAgIHBhcmVudE5vZGU6IChub2RlKSA9PiBub2RlLnBhcmVudE5vZGUsCiAgICBuZXh0U2libGluZzogKG5vZGUpID0+IG5vZGUubmV4dFNpYmxpbmcsCiAgICBxdWVyeVNlbGVjdG9yOiAoc2VsZWN0b3IpID0+IGRvYy5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKSwKICAgIHNldFNjb3BlSWQoZWwsIGlkKSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZShpZCwgIiIpOwogICAgfSwKICAgIC8vIF9fVU5TQUZFX18KICAgIC8vIFJlYXNvbjogaW5uZXJIVE1MLgogICAgLy8gU3RhdGljIGNvbnRlbnQgaGVyZSBjYW4gb25seSBjb21lIGZyb20gY29tcGlsZWQgdGVtcGxhdGVzLgogICAgLy8gQXMgbG9uZyBhcyB0aGUgdXNlciBvbmx5IHVzZXMgdHJ1c3RlZCB0ZW1wbGF0ZXMsIHRoaXMgaXMgc2FmZS4KICAgIGluc2VydFN0YXRpY0NvbnRlbnQoY29udGVudCwgcGFyZW50LCBhbmNob3IsIG5hbWVzcGFjZSwgc3RhcnQsIGVuZCkgewogICAgICBjb25zdCBiZWZvcmUgPSBhbmNob3IgPyBhbmNob3IucHJldmlvdXNTaWJsaW5nIDogcGFyZW50Lmxhc3RDaGlsZDsKICAgICAgaWYgKHN0YXJ0ICYmIChzdGFydCA9PT0gZW5kIHx8IHN0YXJ0Lm5leHRTaWJsaW5nKSkgewogICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKHN0YXJ0LmNsb25lTm9kZSh0cnVlKSwgYW5jaG9yKTsKICAgICAgICAgIGlmIChzdGFydCA9PT0gZW5kIHx8ICEoc3RhcnQgPSBzdGFydC5uZXh0U2libGluZykpCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0ZW1wbGF0ZUNvbnRhaW5lci5pbm5lckhUTUwgPSBuYW1lc3BhY2UgPT09ICJzdmciID8gYDxzdmc+JHtjb250ZW50fTwvc3ZnPmAgOiBuYW1lc3BhY2UgPT09ICJtYXRobWwiID8gYDxtYXRoPiR7Y29udGVudH08L21hdGg+YCA6IGNvbnRlbnQ7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNvbnRhaW5lci5jb250ZW50OwogICAgICAgIGlmIChuYW1lc3BhY2UgPT09ICJzdmciIHx8IG5hbWVzcGFjZSA9PT0gIm1hdGhtbCIpIHsKICAgICAgICAgIGNvbnN0IHdyYXBwZXIgPSB0ZW1wbGF0ZS5maXJzdENoaWxkOwogICAgICAgICAgd2hpbGUgKHdyYXBwZXIuZmlyc3RDaGlsZCkgewogICAgICAgICAgICB0ZW1wbGF0ZS5hcHBlbmRDaGlsZCh3cmFwcGVyLmZpcnN0Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdGVtcGxhdGUucmVtb3ZlQ2hpbGQod3JhcHBlcik7CiAgICAgICAgfQogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUodGVtcGxhdGUsIGFuY2hvcik7CiAgICAgIH0KICAgICAgcmV0dXJuIFsKICAgICAgICAvLyBmaXJzdAogICAgICAgIGJlZm9yZSA/IGJlZm9yZS5uZXh0U2libGluZyA6IHBhcmVudC5maXJzdENoaWxkLAogICAgICAgIC8vIGxhc3QKICAgICAgICBhbmNob3IgPyBhbmNob3IucHJldmlvdXNTaWJsaW5nIDogcGFyZW50Lmxhc3RDaGlsZAogICAgICBdOwogICAgfQogIH07CgogIGNvbnN0IFRSQU5TSVRJT04kMSA9ICJ0cmFuc2l0aW9uIjsKICBjb25zdCBBTklNQVRJT04gPSAiYW5pbWF0aW9uIjsKICBjb25zdCB2dGNLZXkgPSBTeW1ib2woIl92dGMiKTsKICBjb25zdCBUcmFuc2l0aW9uID0gKHByb3BzLCB7IHNsb3RzIH0pID0+IGgoQmFzZVRyYW5zaXRpb24sIHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocHJvcHMpLCBzbG90cyk7CiAgVHJhbnNpdGlvbi5kaXNwbGF5TmFtZSA9ICJUcmFuc2l0aW9uIjsKICBjb25zdCBET01UcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gewogICAgbmFtZTogU3RyaW5nLAogICAgdHlwZTogU3RyaW5nLAogICAgY3NzOiB7CiAgICAgIHR5cGU6IEJvb2xlYW4sCiAgICAgIGRlZmF1bHQ6IHRydWUKICAgIH0sCiAgICBkdXJhdGlvbjogW1N0cmluZywgTnVtYmVyLCBPYmplY3RdLAogICAgZW50ZXJGcm9tQ2xhc3M6IFN0cmluZywKICAgIGVudGVyQWN0aXZlQ2xhc3M6IFN0cmluZywKICAgIGVudGVyVG9DbGFzczogU3RyaW5nLAogICAgYXBwZWFyRnJvbUNsYXNzOiBTdHJpbmcsCiAgICBhcHBlYXJBY3RpdmVDbGFzczogU3RyaW5nLAogICAgYXBwZWFyVG9DbGFzczogU3RyaW5nLAogICAgbGVhdmVGcm9tQ2xhc3M6IFN0cmluZywKICAgIGxlYXZlQWN0aXZlQ2xhc3M6IFN0cmluZywKICAgIGxlYXZlVG9DbGFzczogU3RyaW5nCiAgfTsKICBjb25zdCBUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzID0gVHJhbnNpdGlvbi5wcm9wcyA9IC8qIEBfX1BVUkVfXyAqLyBleHRlbmQoCiAgICB7fSwKICAgIEJhc2VUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzLAogICAgRE9NVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycwogICk7CiAgY29uc3QgY2FsbEhvb2sgPSAoaG9vaywgYXJncyA9IFtdKSA9PiB7CiAgICBpZiAoaXNBcnJheShob29rKSkgewogICAgICBob29rLmZvckVhY2goKGgyKSA9PiBoMiguLi5hcmdzKSk7CiAgICB9IGVsc2UgaWYgKGhvb2spIHsKICAgICAgaG9vayguLi5hcmdzKTsKICAgIH0KICB9OwogIGNvbnN0IGhhc0V4cGxpY2l0Q2FsbGJhY2sgPSAoaG9vaykgPT4gewogICAgcmV0dXJuIGhvb2sgPyBpc0FycmF5KGhvb2spID8gaG9vay5zb21lKChoMikgPT4gaDIubGVuZ3RoID4gMSkgOiBob29rLmxlbmd0aCA+IDEgOiBmYWxzZTsKICB9OwogIGZ1bmN0aW9uIHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpIHsKICAgIGNvbnN0IGJhc2VQcm9wcyA9IHt9OwogICAgZm9yIChjb25zdCBrZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgaWYgKCEoa2V5IGluIERPTVRyYW5zaXRpb25Qcm9wc1ZhbGlkYXRvcnMpKSB7CiAgICAgICAgYmFzZVByb3BzW2tleV0gPSByYXdQcm9wc1trZXldOwogICAgICB9CiAgICB9CiAgICBpZiAocmF3UHJvcHMuY3NzID09PSBmYWxzZSkgewogICAgICByZXR1cm4gYmFzZVByb3BzOwogICAgfQogICAgY29uc3QgewogICAgICBuYW1lID0gInYiLAogICAgICB0eXBlLAogICAgICBkdXJhdGlvbiwKICAgICAgZW50ZXJGcm9tQ2xhc3MgPSBgJHtuYW1lfS1lbnRlci1mcm9tYCwKICAgICAgZW50ZXJBY3RpdmVDbGFzcyA9IGAke25hbWV9LWVudGVyLWFjdGl2ZWAsCiAgICAgIGVudGVyVG9DbGFzcyA9IGAke25hbWV9LWVudGVyLXRvYCwKICAgICAgYXBwZWFyRnJvbUNsYXNzID0gZW50ZXJGcm9tQ2xhc3MsCiAgICAgIGFwcGVhckFjdGl2ZUNsYXNzID0gZW50ZXJBY3RpdmVDbGFzcywKICAgICAgYXBwZWFyVG9DbGFzcyA9IGVudGVyVG9DbGFzcywKICAgICAgbGVhdmVGcm9tQ2xhc3MgPSBgJHtuYW1lfS1sZWF2ZS1mcm9tYCwKICAgICAgbGVhdmVBY3RpdmVDbGFzcyA9IGAke25hbWV9LWxlYXZlLWFjdGl2ZWAsCiAgICAgIGxlYXZlVG9DbGFzcyA9IGAke25hbWV9LWxlYXZlLXRvYAogICAgfSA9IHJhd1Byb3BzOwogICAgY29uc3QgZHVyYXRpb25zID0gbm9ybWFsaXplRHVyYXRpb24oZHVyYXRpb24pOwogICAgY29uc3QgZW50ZXJEdXJhdGlvbiA9IGR1cmF0aW9ucyAmJiBkdXJhdGlvbnNbMF07CiAgICBjb25zdCBsZWF2ZUR1cmF0aW9uID0gZHVyYXRpb25zICYmIGR1cmF0aW9uc1sxXTsKICAgIGNvbnN0IHsKICAgICAgb25CZWZvcmVFbnRlciwKICAgICAgb25FbnRlciwKICAgICAgb25FbnRlckNhbmNlbGxlZCwKICAgICAgb25MZWF2ZSwKICAgICAgb25MZWF2ZUNhbmNlbGxlZCwKICAgICAgb25CZWZvcmVBcHBlYXIgPSBvbkJlZm9yZUVudGVyLAogICAgICBvbkFwcGVhciA9IG9uRW50ZXIsCiAgICAgIG9uQXBwZWFyQ2FuY2VsbGVkID0gb25FbnRlckNhbmNlbGxlZAogICAgfSA9IGJhc2VQcm9wczsKICAgIGNvbnN0IGZpbmlzaEVudGVyID0gKGVsLCBpc0FwcGVhciwgZG9uZSkgPT4gewogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGlzQXBwZWFyID8gYXBwZWFyVG9DbGFzcyA6IGVudGVyVG9DbGFzcyk7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgaXNBcHBlYXIgPyBhcHBlYXJBY3RpdmVDbGFzcyA6IGVudGVyQWN0aXZlQ2xhc3MpOwogICAgICBkb25lICYmIGRvbmUoKTsKICAgIH07CiAgICBjb25zdCBmaW5pc2hMZWF2ZSA9IChlbCwgZG9uZSkgPT4gewogICAgICBlbC5faXNMZWF2aW5nID0gZmFsc2U7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVGcm9tQ2xhc3MpOwogICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVBY3RpdmVDbGFzcyk7CiAgICAgIGRvbmUgJiYgZG9uZSgpOwogICAgfTsKICAgIGNvbnN0IG1ha2VFbnRlckhvb2sgPSAoaXNBcHBlYXIpID0+IHsKICAgICAgcmV0dXJuIChlbCwgZG9uZSkgPT4gewogICAgICAgIGNvbnN0IGhvb2sgPSBpc0FwcGVhciA/IG9uQXBwZWFyIDogb25FbnRlcjsKICAgICAgICBjb25zdCByZXNvbHZlID0gKCkgPT4gZmluaXNoRW50ZXIoZWwsIGlzQXBwZWFyLCBkb25lKTsKICAgICAgICBjYWxsSG9vayhob29rLCBbZWwsIHJlc29sdmVdKTsKICAgICAgICBuZXh0RnJhbWUoKCkgPT4gewogICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBpc0FwcGVhciA/IGFwcGVhckZyb21DbGFzcyA6IGVudGVyRnJvbUNsYXNzKTsKICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgaXNBcHBlYXIgPyBhcHBlYXJUb0NsYXNzIDogZW50ZXJUb0NsYXNzKTsKICAgICAgICAgIGlmICghaGFzRXhwbGljaXRDYWxsYmFjayhob29rKSkgewogICAgICAgICAgICB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIHR5cGUsIGVudGVyRHVyYXRpb24sIHJlc29sdmUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfTsKICAgIHJldHVybiBleHRlbmQoYmFzZVByb3BzLCB7CiAgICAgIG9uQmVmb3JlRW50ZXIoZWwpIHsKICAgICAgICBjYWxsSG9vayhvbkJlZm9yZUVudGVyLCBbZWxdKTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGVudGVyRnJvbUNsYXNzKTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGVudGVyQWN0aXZlQ2xhc3MpOwogICAgICB9LAogICAgICBvbkJlZm9yZUFwcGVhcihlbCkgewogICAgICAgIGNhbGxIb29rKG9uQmVmb3JlQXBwZWFyLCBbZWxdKTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGFwcGVhckZyb21DbGFzcyk7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBhcHBlYXJBY3RpdmVDbGFzcyk7CiAgICAgIH0sCiAgICAgIG9uRW50ZXI6IG1ha2VFbnRlckhvb2soZmFsc2UpLAogICAgICBvbkFwcGVhcjogbWFrZUVudGVySG9vayh0cnVlKSwKICAgICAgb25MZWF2ZShlbCwgZG9uZSkgewogICAgICAgIGVsLl9pc0xlYXZpbmcgPSB0cnVlOwogICAgICAgIGNvbnN0IHJlc29sdmUgPSAoKSA9PiBmaW5pc2hMZWF2ZShlbCwgZG9uZSk7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7CiAgICAgICAgZm9yY2VSZWZsb3coKTsKICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgICAgIG5leHRGcmFtZSgoKSA9PiB7CiAgICAgICAgICBpZiAoIWVsLl9pc0xlYXZpbmcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUZyb21DbGFzcyk7CiAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CiAgICAgICAgICBpZiAoIWhhc0V4cGxpY2l0Q2FsbGJhY2sob25MZWF2ZSkpIHsKICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBsZWF2ZUR1cmF0aW9uLCByZXNvbHZlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjYWxsSG9vayhvbkxlYXZlLCBbZWwsIHJlc29sdmVdKTsKICAgICAgfSwKICAgICAgb25FbnRlckNhbmNlbGxlZChlbCkgewogICAgICAgIGZpbmlzaEVudGVyKGVsLCBmYWxzZSk7CiAgICAgICAgY2FsbEhvb2sob25FbnRlckNhbmNlbGxlZCwgW2VsXSk7CiAgICAgIH0sCiAgICAgIG9uQXBwZWFyQ2FuY2VsbGVkKGVsKSB7CiAgICAgICAgZmluaXNoRW50ZXIoZWwsIHRydWUpOwogICAgICAgIGNhbGxIb29rKG9uQXBwZWFyQ2FuY2VsbGVkLCBbZWxdKTsKICAgICAgfSwKICAgICAgb25MZWF2ZUNhbmNlbGxlZChlbCkgewogICAgICAgIGZpbmlzaExlYXZlKGVsKTsKICAgICAgICBjYWxsSG9vayhvbkxlYXZlQ2FuY2VsbGVkLCBbZWxdKTsKICAgICAgfQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG5vcm1hbGl6ZUR1cmF0aW9uKGR1cmF0aW9uKSB7CiAgICBpZiAoZHVyYXRpb24gPT0gbnVsbCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoZHVyYXRpb24pKSB7CiAgICAgIHJldHVybiBbTnVtYmVyT2YoZHVyYXRpb24uZW50ZXIpLCBOdW1iZXJPZihkdXJhdGlvbi5sZWF2ZSldOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgbiA9IE51bWJlck9mKGR1cmF0aW9uKTsKICAgICAgcmV0dXJuIFtuLCBuXTsKICAgIH0KICB9CiAgZnVuY3Rpb24gTnVtYmVyT2YodmFsKSB7CiAgICBjb25zdCByZXMgPSB0b051bWJlcih2YWwpOwogICAgewogICAgICBhc3NlcnROdW1iZXIocmVzLCAiPHRyYW5zaXRpb24+IGV4cGxpY2l0IGR1cmF0aW9uIik7CiAgICB9CiAgICByZXR1cm4gcmVzOwogIH0KICBmdW5jdGlvbiBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGNscykgewogICAgY2xzLnNwbGl0KC9ccysvKS5mb3JFYWNoKChjKSA9PiBjICYmIGVsLmNsYXNzTGlzdC5hZGQoYykpOwogICAgKGVsW3Z0Y0tleV0gfHwgKGVsW3Z0Y0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKSkuYWRkKGNscyk7CiAgfQogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgY2xzKSB7CiAgICBjbHMuc3BsaXQoL1xzKy8pLmZvckVhY2goKGMpID0+IGMgJiYgZWwuY2xhc3NMaXN0LnJlbW92ZShjKSk7CiAgICBjb25zdCBfdnRjID0gZWxbdnRjS2V5XTsKICAgIGlmIChfdnRjKSB7CiAgICAgIF92dGMuZGVsZXRlKGNscyk7CiAgICAgIGlmICghX3Z0Yy5zaXplKSB7CiAgICAgICAgZWxbdnRjS2V5XSA9IHZvaWQgMDsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBuZXh0RnJhbWUoY2IpIHsKICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShjYik7CiAgICB9KTsKICB9CiAgbGV0IGVuZElkID0gMDsKICBmdW5jdGlvbiB3aGVuVHJhbnNpdGlvbkVuZHMoZWwsIGV4cGVjdGVkVHlwZSwgZXhwbGljaXRUaW1lb3V0LCByZXNvbHZlKSB7CiAgICBjb25zdCBpZCA9IGVsLl9lbmRJZCA9ICsrZW5kSWQ7CiAgICBjb25zdCByZXNvbHZlSWZOb3RTdGFsZSA9ICgpID0+IHsKICAgICAgaWYgKGlkID09PSBlbC5fZW5kSWQpIHsKICAgICAgICByZXNvbHZlKCk7CiAgICAgIH0KICAgIH07CiAgICBpZiAoZXhwbGljaXRUaW1lb3V0KSB7CiAgICAgIHJldHVybiBzZXRUaW1lb3V0KHJlc29sdmVJZk5vdFN0YWxlLCBleHBsaWNpdFRpbWVvdXQpOwogICAgfQogICAgY29uc3QgeyB0eXBlLCB0aW1lb3V0LCBwcm9wQ291bnQgfSA9IGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpOwogICAgaWYgKCF0eXBlKSB7CiAgICAgIHJldHVybiByZXNvbHZlKCk7CiAgICB9CiAgICBjb25zdCBlbmRFdmVudCA9IHR5cGUgKyAiZW5kIjsKICAgIGxldCBlbmRlZCA9IDA7CiAgICBjb25zdCBlbmQgPSAoKSA9PiB7CiAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZW5kRXZlbnQsIG9uRW5kKTsKICAgICAgcmVzb2x2ZUlmTm90U3RhbGUoKTsKICAgIH07CiAgICBjb25zdCBvbkVuZCA9IChlKSA9PiB7CiAgICAgIGlmIChlLnRhcmdldCA9PT0gZWwgJiYgKytlbmRlZCA+PSBwcm9wQ291bnQpIHsKICAgICAgICBlbmQoKTsKICAgICAgfQogICAgfTsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICBpZiAoZW5kZWQgPCBwcm9wQ291bnQpIHsKICAgICAgICBlbmQoKTsKICAgICAgfQogICAgfSwgdGltZW91dCArIDEpOwogICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihlbmRFdmVudCwgb25FbmQpOwogIH0KICBmdW5jdGlvbiBnZXRUcmFuc2l0aW9uSW5mbyhlbCwgZXhwZWN0ZWRUeXBlKSB7CiAgICBjb25zdCBzdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCk7CiAgICBjb25zdCBnZXRTdHlsZVByb3BlcnRpZXMgPSAoa2V5KSA9PiAoc3R5bGVzW2tleV0gfHwgIiIpLnNwbGl0KCIsICIpOwogICAgY29uc3QgdHJhbnNpdGlvbkRlbGF5cyA9IGdldFN0eWxlUHJvcGVydGllcyhgJHtUUkFOU0lUSU9OJDF9RGVsYXlgKTsKICAgIGNvbnN0IHRyYW5zaXRpb25EdXJhdGlvbnMgPSBnZXRTdHlsZVByb3BlcnRpZXMoYCR7VFJBTlNJVElPTiQxfUR1cmF0aW9uYCk7CiAgICBjb25zdCB0cmFuc2l0aW9uVGltZW91dCA9IGdldFRpbWVvdXQodHJhbnNpdGlvbkRlbGF5cywgdHJhbnNpdGlvbkR1cmF0aW9ucyk7CiAgICBjb25zdCBhbmltYXRpb25EZWxheXMgPSBnZXRTdHlsZVByb3BlcnRpZXMoYCR7QU5JTUFUSU9OfURlbGF5YCk7CiAgICBjb25zdCBhbmltYXRpb25EdXJhdGlvbnMgPSBnZXRTdHlsZVByb3BlcnRpZXMoYCR7QU5JTUFUSU9OfUR1cmF0aW9uYCk7CiAgICBjb25zdCBhbmltYXRpb25UaW1lb3V0ID0gZ2V0VGltZW91dChhbmltYXRpb25EZWxheXMsIGFuaW1hdGlvbkR1cmF0aW9ucyk7CiAgICBsZXQgdHlwZSA9IG51bGw7CiAgICBsZXQgdGltZW91dCA9IDA7CiAgICBsZXQgcHJvcENvdW50ID0gMDsKICAgIGlmIChleHBlY3RlZFR5cGUgPT09IFRSQU5TSVRJT04kMSkgewogICAgICBpZiAodHJhbnNpdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgICAgdHlwZSA9IFRSQU5TSVRJT04kMTsKICAgICAgICB0aW1lb3V0ID0gdHJhbnNpdGlvblRpbWVvdXQ7CiAgICAgICAgcHJvcENvdW50ID0gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGg7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSBBTklNQVRJT04pIHsKICAgICAgaWYgKGFuaW1hdGlvblRpbWVvdXQgPiAwKSB7CiAgICAgICAgdHlwZSA9IEFOSU1BVElPTjsKICAgICAgICB0aW1lb3V0ID0gYW5pbWF0aW9uVGltZW91dDsKICAgICAgICBwcm9wQ291bnQgPSBhbmltYXRpb25EdXJhdGlvbnMubGVuZ3RoOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aW1lb3V0ID0gTWF0aC5tYXgodHJhbnNpdGlvblRpbWVvdXQsIGFuaW1hdGlvblRpbWVvdXQpOwogICAgICB0eXBlID0gdGltZW91dCA+IDAgPyB0cmFuc2l0aW9uVGltZW91dCA+IGFuaW1hdGlvblRpbWVvdXQgPyBUUkFOU0lUSU9OJDEgOiBBTklNQVRJT04gOiBudWxsOwogICAgICBwcm9wQ291bnQgPSB0eXBlID8gdHlwZSA9PT0gVFJBTlNJVElPTiQxID8gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGggOiBhbmltYXRpb25EdXJhdGlvbnMubGVuZ3RoIDogMDsKICAgIH0KICAgIGNvbnN0IGhhc1RyYW5zZm9ybSA9IHR5cGUgPT09IFRSQU5TSVRJT04kMSAmJiAvXGIodHJhbnNmb3JtfGFsbCkoLHwkKS8udGVzdCgKICAgICAgZ2V0U3R5bGVQcm9wZXJ0aWVzKGAke1RSQU5TSVRJT04kMX1Qcm9wZXJ0eWApLnRvU3RyaW5nKCkKICAgICk7CiAgICByZXR1cm4gewogICAgICB0eXBlLAogICAgICB0aW1lb3V0LAogICAgICBwcm9wQ291bnQsCiAgICAgIGhhc1RyYW5zZm9ybQogICAgfTsKICB9CiAgZnVuY3Rpb24gZ2V0VGltZW91dChkZWxheXMsIGR1cmF0aW9ucykgewogICAgd2hpbGUgKGRlbGF5cy5sZW5ndGggPCBkdXJhdGlvbnMubGVuZ3RoKSB7CiAgICAgIGRlbGF5cyA9IGRlbGF5cy5jb25jYXQoZGVsYXlzKTsKICAgIH0KICAgIHJldHVybiBNYXRoLm1heCguLi5kdXJhdGlvbnMubWFwKChkLCBpKSA9PiB0b01zKGQpICsgdG9NcyhkZWxheXNbaV0pKSk7CiAgfQogIGZ1bmN0aW9uIHRvTXMocykgewogICAgaWYgKHMgPT09ICJhdXRvIikKICAgICAgcmV0dXJuIDA7CiAgICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoIiwiLCAiLiIpKSAqIDFlMzsKICB9CiAgZnVuY3Rpb24gZm9yY2VSZWZsb3coKSB7CiAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQ7CiAgfQoKICBmdW5jdGlvbiBwYXRjaENsYXNzKGVsLCB2YWx1ZSwgaXNTVkcpIHsKICAgIGNvbnN0IHRyYW5zaXRpb25DbGFzc2VzID0gZWxbdnRjS2V5XTsKICAgIGlmICh0cmFuc2l0aW9uQ2xhc3NlcykgewogICAgICB2YWx1ZSA9ICh2YWx1ZSA/IFt2YWx1ZSwgLi4udHJhbnNpdGlvbkNsYXNzZXNdIDogWy4uLnRyYW5zaXRpb25DbGFzc2VzXSkuam9pbigiICIpOwogICAgfQogICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCJjbGFzcyIpOwogICAgfSBlbHNlIGlmIChpc1NWRykgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgdmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgZWwuY2xhc3NOYW1lID0gdmFsdWU7CiAgICB9CiAgfQoKICBjb25zdCB2U2hvd09yaWdpbmFsRGlzcGxheSA9IFN5bWJvbCgiX3ZvZCIpOwogIGNvbnN0IHZTaG93SGlkZGVuID0gU3ltYm9sKCJfdnNoIik7CiAgY29uc3QgdlNob3cgPSB7CiAgICBiZWZvcmVNb3VudChlbCwgeyB2YWx1ZSB9LCB7IHRyYW5zaXRpb24gfSkgewogICAgICBlbFt2U2hvd09yaWdpbmFsRGlzcGxheV0gPSBlbC5zdHlsZS5kaXNwbGF5ID09PSAibm9uZSIgPyAiIiA6IGVsLnN0eWxlLmRpc3BsYXk7CiAgICAgIGlmICh0cmFuc2l0aW9uICYmIHZhbHVlKSB7CiAgICAgICAgdHJhbnNpdGlvbi5iZWZvcmVFbnRlcihlbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RGlzcGxheShlbCwgdmFsdWUpOwogICAgICB9CiAgICB9LAogICAgbW91bnRlZChlbCwgeyB2YWx1ZSB9LCB7IHRyYW5zaXRpb24gfSkgewogICAgICBpZiAodHJhbnNpdGlvbiAmJiB2YWx1ZSkgewogICAgICAgIHRyYW5zaXRpb24uZW50ZXIoZWwpOwogICAgICB9CiAgICB9LAogICAgdXBkYXRlZChlbCwgeyB2YWx1ZSwgb2xkVmFsdWUgfSwgeyB0cmFuc2l0aW9uIH0pIHsKICAgICAgaWYgKCF2YWx1ZSA9PT0gIW9sZFZhbHVlKQogICAgICAgIHJldHVybjsKICAgICAgaWYgKHRyYW5zaXRpb24pIHsKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgIHRyYW5zaXRpb24uYmVmb3JlRW50ZXIoZWwpOwogICAgICAgICAgc2V0RGlzcGxheShlbCwgdHJ1ZSk7CiAgICAgICAgICB0cmFuc2l0aW9uLmVudGVyKGVsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJhbnNpdGlvbi5sZWF2ZShlbCwgKCkgPT4gewogICAgICAgICAgICBzZXREaXNwbGF5KGVsLCBmYWxzZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RGlzcGxheShlbCwgdmFsdWUpOwogICAgICB9CiAgICB9LAogICAgYmVmb3JlVW5tb3VudChlbCwgeyB2YWx1ZSB9KSB7CiAgICAgIHNldERpc3BsYXkoZWwsIHZhbHVlKTsKICAgIH0KICB9OwogIHsKICAgIHZTaG93Lm5hbWUgPSAic2hvdyI7CiAgfQogIGZ1bmN0aW9uIHNldERpc3BsYXkoZWwsIHZhbHVlKSB7CiAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBlbFt2U2hvd09yaWdpbmFsRGlzcGxheV0gOiAibm9uZSI7CiAgICBlbFt2U2hvd0hpZGRlbl0gPSAhdmFsdWU7CiAgfQoKICBjb25zdCBDU1NfVkFSX1RFWFQgPSBTeW1ib2woIkNTU19WQVJfVEVYVCIgKTsKICBmdW5jdGlvbiB1c2VDc3NWYXJzKGdldHRlcikgewogICAgY29uc3QgaW5zdGFuY2UgPSBnZXRDdXJyZW50SW5zdGFuY2UoKTsKICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgd2FybihgdXNlQ3NzVmFycyBpcyBjYWxsZWQgd2l0aG91dCBjdXJyZW50IGFjdGl2ZSBjb21wb25lbnQgaW5zdGFuY2UuYCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnN0IHVwZGF0ZVRlbGVwb3J0cyA9IGluc3RhbmNlLnV0ID0gKHZhcnMgPSBnZXR0ZXIoaW5zdGFuY2UucHJveHkpKSA9PiB7CiAgICAgIEFycmF5LmZyb20oCiAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChgW2RhdGEtdi1vd25lcj0iJHtpbnN0YW5jZS51aWR9Il1gKQogICAgICApLmZvckVhY2goKG5vZGUpID0+IHNldFZhcnNPbk5vZGUobm9kZSwgdmFycykpOwogICAgfTsKICAgIHsKICAgICAgaW5zdGFuY2UuZ2V0Q3NzVmFycyA9ICgpID0+IGdldHRlcihpbnN0YW5jZS5wcm94eSk7CiAgICB9CiAgICBjb25zdCBzZXRWYXJzID0gKCkgPT4gewogICAgICBjb25zdCB2YXJzID0gZ2V0dGVyKGluc3RhbmNlLnByb3h5KTsKICAgICAgc2V0VmFyc09uVk5vZGUoaW5zdGFuY2Uuc3ViVHJlZSwgdmFycyk7CiAgICAgIHVwZGF0ZVRlbGVwb3J0cyh2YXJzKTsKICAgIH07CiAgICB3YXRjaFBvc3RFZmZlY3Qoc2V0VmFycyk7CiAgICBvbk1vdW50ZWQoKCkgPT4gewogICAgICBjb25zdCBvYiA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKHNldFZhcnMpOwogICAgICBvYi5vYnNlcnZlKGluc3RhbmNlLnN1YlRyZWUuZWwucGFyZW50Tm9kZSwgeyBjaGlsZExpc3Q6IHRydWUgfSk7CiAgICAgIG9uVW5tb3VudGVkKCgpID0+IG9iLmRpc2Nvbm5lY3QoKSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gc2V0VmFyc09uVk5vZGUodm5vZGUsIHZhcnMpIHsKICAgIGlmICh2bm9kZS5zaGFwZUZsYWcgJiAxMjgpIHsKICAgICAgY29uc3Qgc3VzcGVuc2UgPSB2bm9kZS5zdXNwZW5zZTsKICAgICAgdm5vZGUgPSBzdXNwZW5zZS5hY3RpdmVCcmFuY2g7CiAgICAgIGlmIChzdXNwZW5zZS5wZW5kaW5nQnJhbmNoICYmICFzdXNwZW5zZS5pc0h5ZHJhdGluZykgewogICAgICAgIHN1c3BlbnNlLmVmZmVjdHMucHVzaCgoKSA9PiB7CiAgICAgICAgICBzZXRWYXJzT25WTm9kZShzdXNwZW5zZS5hY3RpdmVCcmFuY2gsIHZhcnMpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICB3aGlsZSAodm5vZGUuY29tcG9uZW50KSB7CiAgICAgIHZub2RlID0gdm5vZGUuY29tcG9uZW50LnN1YlRyZWU7CiAgICB9CiAgICBpZiAodm5vZGUuc2hhcGVGbGFnICYgMSAmJiB2bm9kZS5lbCkgewogICAgICBzZXRWYXJzT25Ob2RlKHZub2RlLmVsLCB2YXJzKTsKICAgIH0gZWxzZSBpZiAodm5vZGUudHlwZSA9PT0gRnJhZ21lbnQpIHsKICAgICAgdm5vZGUuY2hpbGRyZW4uZm9yRWFjaCgoYykgPT4gc2V0VmFyc09uVk5vZGUoYywgdmFycykpOwogICAgfSBlbHNlIGlmICh2bm9kZS50eXBlID09PSBTdGF0aWMpIHsKICAgICAgbGV0IHsgZWwsIGFuY2hvciB9ID0gdm5vZGU7CiAgICAgIHdoaWxlIChlbCkgewogICAgICAgIHNldFZhcnNPbk5vZGUoZWwsIHZhcnMpOwogICAgICAgIGlmIChlbCA9PT0gYW5jaG9yKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgZWwgPSBlbC5uZXh0U2libGluZzsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBzZXRWYXJzT25Ob2RlKGVsLCB2YXJzKSB7CiAgICBpZiAoZWwubm9kZVR5cGUgPT09IDEpIHsKICAgICAgY29uc3Qgc3R5bGUgPSBlbC5zdHlsZTsKICAgICAgbGV0IGNzc1RleHQgPSAiIjsKICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFycykgewogICAgICAgIHN0eWxlLnNldFByb3BlcnR5KGAtLSR7a2V5fWAsIHZhcnNba2V5XSk7CiAgICAgICAgY3NzVGV4dCArPSBgLS0ke2tleX06ICR7dmFyc1trZXldfTtgOwogICAgICB9CiAgICAgIHN0eWxlW0NTU19WQVJfVEVYVF0gPSBjc3NUZXh0OwogICAgfQogIH0KCiAgY29uc3QgZGlzcGxheVJFID0gLyhefDspXHMqZGlzcGxheVxzKjovOwogIGZ1bmN0aW9uIHBhdGNoU3R5bGUoZWwsIHByZXYsIG5leHQpIHsKICAgIGNvbnN0IHN0eWxlID0gZWwuc3R5bGU7CiAgICBjb25zdCBpc0Nzc1N0cmluZyA9IGlzU3RyaW5nKG5leHQpOwogICAgbGV0IGhhc0NvbnRyb2xsZWREaXNwbGF5ID0gZmFsc2U7CiAgICBpZiAobmV4dCAmJiAhaXNDc3NTdHJpbmcpIHsKICAgICAgaWYgKHByZXYpIHsKICAgICAgICBpZiAoIWlzU3RyaW5nKHByZXYpKSB7CiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBwcmV2KSB7CiAgICAgICAgICAgIGlmIChuZXh0W2tleV0gPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldFN0eWxlKHN0eWxlLCBrZXksICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKGNvbnN0IHByZXZTdHlsZSBvZiBwcmV2LnNwbGl0KCI7IikpIHsKICAgICAgICAgICAgY29uc3Qga2V5ID0gcHJldlN0eWxlLnNsaWNlKDAsIHByZXZTdHlsZS5pbmRleE9mKCI6IikpLnRyaW0oKTsKICAgICAgICAgICAgaWYgKG5leHRba2V5XSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3Qga2V5IGluIG5leHQpIHsKICAgICAgICBpZiAoa2V5ID09PSAiZGlzcGxheSIpIHsKICAgICAgICAgIGhhc0NvbnRyb2xsZWREaXNwbGF5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgc2V0U3R5bGUoc3R5bGUsIGtleSwgbmV4dFtrZXldKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGlzQ3NzU3RyaW5nKSB7CiAgICAgICAgaWYgKHByZXYgIT09IG5leHQpIHsKICAgICAgICAgIGNvbnN0IGNzc1ZhclRleHQgPSBzdHlsZVtDU1NfVkFSX1RFWFRdOwogICAgICAgICAgaWYgKGNzc1ZhclRleHQpIHsKICAgICAgICAgICAgbmV4dCArPSAiOyIgKyBjc3NWYXJUZXh0OwogICAgICAgICAgfQogICAgICAgICAgc3R5bGUuY3NzVGV4dCA9IG5leHQ7CiAgICAgICAgICBoYXNDb250cm9sbGVkRGlzcGxheSA9IGRpc3BsYXlSRS50ZXN0KG5leHQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwcmV2KSB7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCJzdHlsZSIpOwogICAgICB9CiAgICB9CiAgICBpZiAodlNob3dPcmlnaW5hbERpc3BsYXkgaW4gZWwpIHsKICAgICAgZWxbdlNob3dPcmlnaW5hbERpc3BsYXldID0gaGFzQ29udHJvbGxlZERpc3BsYXkgPyBzdHlsZS5kaXNwbGF5IDogIiI7CiAgICAgIGlmIChlbFt2U2hvd0hpZGRlbl0pIHsKICAgICAgICBzdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CiAgICB9CiAgfQogIGNvbnN0IHNlbWljb2xvblJFID0gL1teXFxdO1xzKiQvOwogIGNvbnN0IGltcG9ydGFudFJFID0gL1xzKiFpbXBvcnRhbnQkLzsKICBmdW5jdGlvbiBzZXRTdHlsZShzdHlsZSwgbmFtZSwgdmFsKSB7CiAgICBpZiAoaXNBcnJheSh2YWwpKSB7CiAgICAgIHZhbC5mb3JFYWNoKCh2KSA9PiBzZXRTdHlsZShzdHlsZSwgbmFtZSwgdikpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHZhbCA9PSBudWxsKQogICAgICAgIHZhbCA9ICIiOwogICAgICB7CiAgICAgICAgaWYgKHNlbWljb2xvblJFLnRlc3QodmFsKSkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgYFVuZXhwZWN0ZWQgc2VtaWNvbG9uIGF0IHRoZSBlbmQgb2YgJyR7bmFtZX0nIHN0eWxlIHZhbHVlOiAnJHt2YWx9J2AKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChuYW1lLnN0YXJ0c1dpdGgoIi0tIikpIHsKICAgICAgICBzdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWwpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHByZWZpeGVkID0gYXV0b1ByZWZpeChzdHlsZSwgbmFtZSk7CiAgICAgICAgaWYgKGltcG9ydGFudFJFLnRlc3QodmFsKSkgewogICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkoCiAgICAgICAgICAgIGh5cGhlbmF0ZShwcmVmaXhlZCksCiAgICAgICAgICAgIHZhbC5yZXBsYWNlKGltcG9ydGFudFJFLCAiIiksCiAgICAgICAgICAgICJpbXBvcnRhbnQiCiAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHlsZVtwcmVmaXhlZF0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGNvbnN0IHByZWZpeGVzID0gWyJXZWJraXQiLCAiTW96IiwgIm1zIl07CiAgY29uc3QgcHJlZml4Q2FjaGUgPSB7fTsKICBmdW5jdGlvbiBhdXRvUHJlZml4KHN0eWxlLCByYXdOYW1lKSB7CiAgICBjb25zdCBjYWNoZWQgPSBwcmVmaXhDYWNoZVtyYXdOYW1lXTsKICAgIGlmIChjYWNoZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlZDsKICAgIH0KICAgIGxldCBuYW1lID0gY2FtZWxpemUocmF3TmFtZSk7CiAgICBpZiAobmFtZSAhPT0gImZpbHRlciIgJiYgbmFtZSBpbiBzdHlsZSkgewogICAgICByZXR1cm4gcHJlZml4Q2FjaGVbcmF3TmFtZV0gPSBuYW1lOwogICAgfQogICAgbmFtZSA9IGNhcGl0YWxpemUobmFtZSk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZWZpeGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHByZWZpeGVkID0gcHJlZml4ZXNbaV0gKyBuYW1lOwogICAgICBpZiAocHJlZml4ZWQgaW4gc3R5bGUpIHsKICAgICAgICByZXR1cm4gcHJlZml4Q2FjaGVbcmF3TmFtZV0gPSBwcmVmaXhlZDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJhd05hbWU7CiAgfQoKICBjb25zdCB4bGlua05TID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiOwogIGZ1bmN0aW9uIHBhdGNoQXR0cihlbCwga2V5LCB2YWx1ZSwgaXNTVkcsIGluc3RhbmNlKSB7CiAgICBpZiAoaXNTVkcgJiYga2V5LnN0YXJ0c1dpdGgoInhsaW5rOiIpKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMoeGxpbmtOUywga2V5LnNsaWNlKDYsIGtleS5sZW5ndGgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGVOUyh4bGlua05TLCBrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29uc3QgaXNCb29sZWFuID0gaXNTcGVjaWFsQm9vbGVhbkF0dHIoa2V5KTsKICAgICAgaWYgKHZhbHVlID09IG51bGwgfHwgaXNCb29sZWFuICYmICFpbmNsdWRlQm9vbGVhbkF0dHIodmFsdWUpKSB7CiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZWwuc2V0QXR0cmlidXRlKGtleSwgaXNCb29sZWFuID8gIiIgOiB2YWx1ZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHBhdGNoRE9NUHJvcChlbCwga2V5LCB2YWx1ZSwgcHJldkNoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIHBhcmVudFN1c3BlbnNlLCB1bm1vdW50Q2hpbGRyZW4pIHsKICAgIGlmIChrZXkgPT09ICJpbm5lckhUTUwiIHx8IGtleSA9PT0gInRleHRDb250ZW50IikgewogICAgICBpZiAocHJldkNoaWxkcmVuKSB7CiAgICAgICAgdW5tb3VudENoaWxkcmVuKHByZXZDaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBwYXJlbnRTdXNwZW5zZSk7CiAgICAgIH0KICAgICAgZWxba2V5XSA9IHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCB0YWcgPSBlbC50YWdOYW1lOwogICAgaWYgKGtleSA9PT0gInZhbHVlIiAmJiB0YWcgIT09ICJQUk9HUkVTUyIgJiYgLy8gY3VzdG9tIGVsZW1lbnRzIG1heSB1c2UgX3ZhbHVlIGludGVybmFsbHkKICAgICF0YWcuaW5jbHVkZXMoIi0iKSkgewogICAgICBjb25zdCBvbGRWYWx1ZSA9IHRhZyA9PT0gIk9QVElPTiIgPyBlbC5nZXRBdHRyaWJ1dGUoInZhbHVlIikgfHwgIiIgOiBlbC52YWx1ZTsKICAgICAgY29uc3QgbmV3VmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSB8fCAhKCJfdmFsdWUiIGluIGVsKSkgewogICAgICAgIGVsLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoa2V5KTsKICAgICAgfQogICAgICBlbC5fdmFsdWUgPSB2YWx1ZTsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IG5lZWRSZW1vdmUgPSBmYWxzZTsKICAgIGlmICh2YWx1ZSA9PT0gIiIgfHwgdmFsdWUgPT0gbnVsbCkgewogICAgICBjb25zdCB0eXBlID0gdHlwZW9mIGVsW2tleV07CiAgICAgIGlmICh0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICB2YWx1ZSA9IGluY2x1ZGVCb29sZWFuQXR0cih2YWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT0gbnVsbCAmJiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgIHZhbHVlID0gIiI7CiAgICAgICAgbmVlZFJlbW92ZSA9IHRydWU7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICB2YWx1ZSA9IDA7CiAgICAgICAgbmVlZFJlbW92ZSA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIHRyeSB7CiAgICAgIGVsW2tleV0gPSB2YWx1ZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKCFuZWVkUmVtb3ZlKSB7CiAgICAgICAgd2FybigKICAgICAgICAgIGBGYWlsZWQgc2V0dGluZyBwcm9wICIke2tleX0iIG9uIDwke3RhZy50b0xvd2VyQ2FzZSgpfT46IHZhbHVlICR7dmFsdWV9IGlzIGludmFsaWQuYCwKICAgICAgICAgIGUKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICBuZWVkUmVtb3ZlICYmIGVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogIH0KCiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpIHsKICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGhhbmRsZXIsIG9wdGlvbnMpOwogIH0KICBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKGVsLCBldmVudCwgaGFuZGxlciwgb3B0aW9ucykgewogICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgaGFuZGxlciwgb3B0aW9ucyk7CiAgfQogIGNvbnN0IHZlaUtleSA9IFN5bWJvbCgiX3ZlaSIpOwogIGZ1bmN0aW9uIHBhdGNoRXZlbnQoZWwsIHJhd05hbWUsIHByZXZWYWx1ZSwgbmV4dFZhbHVlLCBpbnN0YW5jZSA9IG51bGwpIHsKICAgIGNvbnN0IGludm9rZXJzID0gZWxbdmVpS2V5XSB8fCAoZWxbdmVpS2V5XSA9IHt9KTsKICAgIGNvbnN0IGV4aXN0aW5nSW52b2tlciA9IGludm9rZXJzW3Jhd05hbWVdOwogICAgaWYgKG5leHRWYWx1ZSAmJiBleGlzdGluZ0ludm9rZXIpIHsKICAgICAgZXhpc3RpbmdJbnZva2VyLnZhbHVlID0gbmV4dFZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgW25hbWUsIG9wdGlvbnNdID0gcGFyc2VOYW1lKHJhd05hbWUpOwogICAgICBpZiAobmV4dFZhbHVlKSB7CiAgICAgICAgY29uc3QgaW52b2tlciA9IGludm9rZXJzW3Jhd05hbWVdID0gY3JlYXRlSW52b2tlcihuZXh0VmFsdWUsIGluc3RhbmNlKTsKICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCBuYW1lLCBpbnZva2VyLCBvcHRpb25zKTsKICAgICAgfSBlbHNlIGlmIChleGlzdGluZ0ludm9rZXIpIHsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyKGVsLCBuYW1lLCBleGlzdGluZ0ludm9rZXIsIG9wdGlvbnMpOwogICAgICAgIGludm9rZXJzW3Jhd05hbWVdID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgfQogIGNvbnN0IG9wdGlvbnNNb2RpZmllclJFID0gLyg/Ok9uY2V8UGFzc2l2ZXxDYXB0dXJlKSQvOwogIGZ1bmN0aW9uIHBhcnNlTmFtZShuYW1lKSB7CiAgICBsZXQgb3B0aW9uczsKICAgIGlmIChvcHRpb25zTW9kaWZpZXJSRS50ZXN0KG5hbWUpKSB7CiAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgbGV0IG07CiAgICAgIHdoaWxlIChtID0gbmFtZS5tYXRjaChvcHRpb25zTW9kaWZpZXJSRSkpIHsKICAgICAgICBuYW1lID0gbmFtZS5zbGljZSgwLCBuYW1lLmxlbmd0aCAtIG1bMF0ubGVuZ3RoKTsKICAgICAgICBvcHRpb25zW21bMF0udG9Mb3dlckNhc2UoKV0gPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBjb25zdCBldmVudCA9IG5hbWVbMl0gPT09ICI6IiA/IG5hbWUuc2xpY2UoMykgOiBoeXBoZW5hdGUobmFtZS5zbGljZSgyKSk7CiAgICByZXR1cm4gW2V2ZW50LCBvcHRpb25zXTsKICB9CiAgbGV0IGNhY2hlZE5vdyA9IDA7CiAgY29uc3QgcCA9IC8qIEBfX1BVUkVfXyAqLyBQcm9taXNlLnJlc29sdmUoKTsKICBjb25zdCBnZXROb3cgPSAoKSA9PiBjYWNoZWROb3cgfHwgKHAudGhlbigoKSA9PiBjYWNoZWROb3cgPSAwKSwgY2FjaGVkTm93ID0gRGF0ZS5ub3coKSk7CiAgZnVuY3Rpb24gY3JlYXRlSW52b2tlcihpbml0aWFsVmFsdWUsIGluc3RhbmNlKSB7CiAgICBjb25zdCBpbnZva2VyID0gKGUpID0+IHsKICAgICAgaWYgKCFlLl92dHMpIHsKICAgICAgICBlLl92dHMgPSBEYXRlLm5vdygpOwogICAgICB9IGVsc2UgaWYgKGUuX3Z0cyA8PSBpbnZva2VyLmF0dGFjaGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nKAogICAgICAgIHBhdGNoU3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKGUsIGludm9rZXIudmFsdWUpLAogICAgICAgIGluc3RhbmNlLAogICAgICAgIDUsCiAgICAgICAgW2VdCiAgICAgICk7CiAgICB9OwogICAgaW52b2tlci52YWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgIGludm9rZXIuYXR0YWNoZWQgPSBnZXROb3coKTsKICAgIHJldHVybiBpbnZva2VyOwogIH0KICBmdW5jdGlvbiBwYXRjaFN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbihlLCB2YWx1ZSkgewogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGNvbnN0IG9yaWdpbmFsU3RvcCA9IGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOwogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiA9ICgpID0+IHsKICAgICAgICBvcmlnaW5hbFN0b3AuY2FsbChlKTsKICAgICAgICBlLl9zdG9wcGVkID0gdHJ1ZTsKICAgICAgfTsKICAgICAgcmV0dXJuIHZhbHVlLm1hcCgoZm4pID0+IChlMikgPT4gIWUyLl9zdG9wcGVkICYmIGZuICYmIGZuKGUyKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfQoKICBjb25zdCBpc05hdGl2ZU9uID0gKGtleSkgPT4ga2V5LmNoYXJDb2RlQXQoMCkgPT09IDExMSAmJiBrZXkuY2hhckNvZGVBdCgxKSA9PT0gMTEwICYmIC8vIGxvd2VyY2FzZSBsZXR0ZXIKICBrZXkuY2hhckNvZGVBdCgyKSA+IDk2ICYmIGtleS5jaGFyQ29kZUF0KDIpIDwgMTIzOwogIGNvbnN0IHBhdGNoUHJvcCA9IChlbCwga2V5LCBwcmV2VmFsdWUsIG5leHRWYWx1ZSwgbmFtZXNwYWNlLCBwcmV2Q2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgcGFyZW50U3VzcGVuc2UsIHVubW91bnRDaGlsZHJlbikgPT4gewogICAgY29uc3QgaXNTVkcgPSBuYW1lc3BhY2UgPT09ICJzdmciOwogICAgaWYgKGtleSA9PT0gImNsYXNzIikgewogICAgICBwYXRjaENsYXNzKGVsLCBuZXh0VmFsdWUsIGlzU1ZHKTsKICAgIH0gZWxzZSBpZiAoa2V5ID09PSAic3R5bGUiKSB7CiAgICAgIHBhdGNoU3R5bGUoZWwsIHByZXZWYWx1ZSwgbmV4dFZhbHVlKTsKICAgIH0gZWxzZSBpZiAoaXNPbihrZXkpKSB7CiAgICAgIGlmICghaXNNb2RlbExpc3RlbmVyKGtleSkpIHsKICAgICAgICBwYXRjaEV2ZW50KGVsLCBrZXksIHByZXZWYWx1ZSwgbmV4dFZhbHVlLCBwYXJlbnRDb21wb25lbnQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGtleVswXSA9PT0gIi4iID8gKGtleSA9IGtleS5zbGljZSgxKSwgdHJ1ZSkgOiBrZXlbMF0gPT09ICJeIiA/IChrZXkgPSBrZXkuc2xpY2UoMSksIGZhbHNlKSA6IHNob3VsZFNldEFzUHJvcChlbCwga2V5LCBuZXh0VmFsdWUsIGlzU1ZHKSkgewogICAgICBwYXRjaERPTVByb3AoCiAgICAgICAgZWwsCiAgICAgICAga2V5LAogICAgICAgIG5leHRWYWx1ZSwKICAgICAgICBwcmV2Q2hpbGRyZW4sCiAgICAgICAgcGFyZW50Q29tcG9uZW50LAogICAgICAgIHBhcmVudFN1c3BlbnNlLAogICAgICAgIHVubW91bnRDaGlsZHJlbgogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGtleSA9PT0gInRydWUtdmFsdWUiKSB7CiAgICAgICAgZWwuX3RydWVWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJmYWxzZS12YWx1ZSIpIHsKICAgICAgICBlbC5fZmFsc2VWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgfQogICAgICBwYXRjaEF0dHIoZWwsIGtleSwgbmV4dFZhbHVlLCBpc1NWRyk7CiAgICB9CiAgfTsKICBmdW5jdGlvbiBzaG91bGRTZXRBc1Byb3AoZWwsIGtleSwgdmFsdWUsIGlzU1ZHKSB7CiAgICBpZiAoaXNTVkcpIHsKICAgICAgaWYgKGtleSA9PT0gImlubmVySFRNTCIgfHwga2V5ID09PSAidGV4dENvbnRlbnQiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGtleSBpbiBlbCAmJiBpc05hdGl2ZU9uKGtleSkgJiYgaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoa2V5ID09PSAic3BlbGxjaGVjayIgfHwga2V5ID09PSAiZHJhZ2dhYmxlIiB8fCBrZXkgPT09ICJ0cmFuc2xhdGUiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChrZXkgPT09ICJmb3JtIikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoa2V5ID09PSAibGlzdCIgJiYgZWwudGFnTmFtZSA9PT0gIklOUFVUIikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoa2V5ID09PSAidHlwZSIgJiYgZWwudGFnTmFtZSA9PT0gIlRFWFRBUkVBIikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpZiAoa2V5ID09PSAid2lkdGgiIHx8IGtleSA9PT0gImhlaWdodCIpIHsKICAgICAgY29uc3QgdGFnID0gZWwudGFnTmFtZTsKICAgICAgaWYgKHRhZyA9PT0gIklNRyIgfHwgdGFnID09PSAiVklERU8iIHx8IHRhZyA9PT0gIkNBTlZBUyIgfHwgdGFnID09PSAiU09VUkNFIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgaWYgKGlzTmF0aXZlT24oa2V5KSAmJiBpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIGtleSBpbiBlbDsKICB9CgogIC8qISAjX19OT19TSURFX0VGRkVDVFNfXyAqLwogIC8vIEBfX05PX1NJREVfRUZGRUNUU19fCiAgZnVuY3Rpb24gZGVmaW5lQ3VzdG9tRWxlbWVudChvcHRpb25zLCBoeWRyYXRlMikgewogICAgY29uc3QgQ29tcCA9IGRlZmluZUNvbXBvbmVudChvcHRpb25zKTsKICAgIGNsYXNzIFZ1ZUN1c3RvbUVsZW1lbnQgZXh0ZW5kcyBWdWVFbGVtZW50IHsKICAgICAgY29uc3RydWN0b3IoaW5pdGlhbFByb3BzKSB7CiAgICAgICAgc3VwZXIoQ29tcCwgaW5pdGlhbFByb3BzLCBoeWRyYXRlMik7CiAgICAgIH0KICAgIH0KICAgIFZ1ZUN1c3RvbUVsZW1lbnQuZGVmID0gQ29tcDsKICAgIHJldHVybiBWdWVDdXN0b21FbGVtZW50OwogIH0KICAvKiEgI19fTk9fU0lERV9FRkZFQ1RTX18gKi8KICBjb25zdCBkZWZpbmVTU1JDdXN0b21FbGVtZW50ID0gLyogQF9fTk9fU0lERV9FRkZFQ1RTX18gKi8gKG9wdGlvbnMpID0+IHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gZGVmaW5lQ3VzdG9tRWxlbWVudChvcHRpb25zLCBoeWRyYXRlKTsKICB9OwogIGNvbnN0IEJhc2VDbGFzcyA9IHR5cGVvZiBIVE1MRWxlbWVudCAhPT0gInVuZGVmaW5lZCIgPyBIVE1MRWxlbWVudCA6IGNsYXNzIHsKICB9OwogIGNsYXNzIFZ1ZUVsZW1lbnQgZXh0ZW5kcyBCYXNlQ2xhc3MgewogICAgY29uc3RydWN0b3IoX2RlZiwgX3Byb3BzID0ge30sIGh5ZHJhdGUyKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuX2RlZiA9IF9kZWY7CiAgICAgIHRoaXMuX3Byb3BzID0gX3Byb3BzOwogICAgICAvKioKICAgICAgICogQGludGVybmFsCiAgICAgICAqLwogICAgICB0aGlzLl9pbnN0YW5jZSA9IG51bGw7CiAgICAgIHRoaXMuX2Nvbm5lY3RlZCA9IGZhbHNlOwogICAgICB0aGlzLl9yZXNvbHZlZCA9IGZhbHNlOwogICAgICB0aGlzLl9udW1iZXJQcm9wcyA9IG51bGw7CiAgICAgIHRoaXMuX29iID0gbnVsbDsKICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCAmJiBoeWRyYXRlMikgewogICAgICAgIGh5ZHJhdGUyKHRoaXMuX2NyZWF0ZVZOb2RlKCksIHRoaXMuc2hhZG93Um9vdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRoaXMuc2hhZG93Um9vdCkgewogICAgICAgICAgd2FybigKICAgICAgICAgICAgYEN1c3RvbSBlbGVtZW50IGhhcyBwcmUtcmVuZGVyZWQgZGVjbGFyYXRpdmUgc2hhZG93IHJvb3QgYnV0IGlzIG5vdCBkZWZpbmVkIGFzIGh5ZHJhdGFibGUuIFVzZSBcYGRlZmluZVNTUkN1c3RvbUVsZW1lbnRcYC5gCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICB0aGlzLmF0dGFjaFNoYWRvdyh7IG1vZGU6ICJvcGVuIiB9KTsKICAgICAgICBpZiAoIXRoaXMuX2RlZi5fX2FzeW5jTG9hZGVyKSB7CiAgICAgICAgICB0aGlzLl9yZXNvbHZlUHJvcHModGhpcy5fZGVmKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbm5lY3RlZENhbGxiYWNrKCkgewogICAgICB0aGlzLl9jb25uZWN0ZWQgPSB0cnVlOwogICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7CiAgICAgICAgaWYgKHRoaXMuX3Jlc29sdmVkKSB7CiAgICAgICAgICB0aGlzLl91cGRhdGUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fcmVzb2x2ZURlZigpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgIHRoaXMuX2Nvbm5lY3RlZCA9IGZhbHNlOwogICAgICBpZiAodGhpcy5fb2IpIHsKICAgICAgICB0aGlzLl9vYi5kaXNjb25uZWN0KCk7CiAgICAgICAgdGhpcy5fb2IgPSBudWxsOwogICAgICB9CiAgICAgIG5leHRUaWNrKCgpID0+IHsKICAgICAgICBpZiAoIXRoaXMuX2Nvbm5lY3RlZCkgewogICAgICAgICAgcmVuZGVyKG51bGwsIHRoaXMuc2hhZG93Um9vdCk7CiAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIC8qKgogICAgICogcmVzb2x2ZSBpbm5lciBjb21wb25lbnQgZGVmaW5pdGlvbiAoaGFuZGxlIHBvc3NpYmxlIGFzeW5jIGNvbXBvbmVudCkKICAgICAqLwogICAgX3Jlc29sdmVEZWYoKSB7CiAgICAgIHRoaXMuX3Jlc29sdmVkID0gdHJ1ZTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9zZXRBdHRyKHRoaXMuYXR0cmlidXRlc1tpXS5uYW1lKTsKICAgICAgfQogICAgICB0aGlzLl9vYiA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChtdXRhdGlvbnMpID0+IHsKICAgICAgICBmb3IgKGNvbnN0IG0gb2YgbXV0YXRpb25zKSB7CiAgICAgICAgICB0aGlzLl9zZXRBdHRyKG0uYXR0cmlidXRlTmFtZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5fb2Iub2JzZXJ2ZSh0aGlzLCB7IGF0dHJpYnV0ZXM6IHRydWUgfSk7CiAgICAgIGNvbnN0IHJlc29sdmUgPSAoZGVmLCBpc0FzeW5jID0gZmFsc2UpID0+IHsKICAgICAgICBjb25zdCB7IHByb3BzLCBzdHlsZXMgfSA9IGRlZjsKICAgICAgICBsZXQgbnVtYmVyUHJvcHM7CiAgICAgICAgaWYgKHByb3BzICYmICFpc0FycmF5KHByb3BzKSkgewogICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgY29uc3Qgb3B0ID0gcHJvcHNba2V5XTsKICAgICAgICAgICAgaWYgKG9wdCA9PT0gTnVtYmVyIHx8IG9wdCAmJiBvcHQudHlwZSA9PT0gTnVtYmVyKSB7CiAgICAgICAgICAgICAgaWYgKGtleSBpbiB0aGlzLl9wcm9wcykgewogICAgICAgICAgICAgICAgdGhpcy5fcHJvcHNba2V5XSA9IHRvTnVtYmVyKHRoaXMuX3Byb3BzW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAobnVtYmVyUHJvcHMgfHwgKG51bWJlclByb3BzID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCkpKVtjYW1lbGl6ZShrZXkpXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5fbnVtYmVyUHJvcHMgPSBudW1iZXJQcm9wczsKICAgICAgICBpZiAoaXNBc3luYykgewogICAgICAgICAgdGhpcy5fcmVzb2x2ZVByb3BzKGRlZik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2FwcGx5U3R5bGVzKHN0eWxlcyk7CiAgICAgICAgdGhpcy5fdXBkYXRlKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IGFzeW5jRGVmID0gdGhpcy5fZGVmLl9fYXN5bmNMb2FkZXI7CiAgICAgIGlmIChhc3luY0RlZikgewogICAgICAgIGFzeW5jRGVmKCkudGhlbigoZGVmKSA9PiByZXNvbHZlKGRlZiwgdHJ1ZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmUodGhpcy5fZGVmKTsKICAgICAgfQogICAgfQogICAgX3Jlc29sdmVQcm9wcyhkZWYpIHsKICAgICAgY29uc3QgeyBwcm9wcyB9ID0gZGVmOwogICAgICBjb25zdCBkZWNsYXJlZFByb3BLZXlzID0gaXNBcnJheShwcm9wcykgPyBwcm9wcyA6IE9iamVjdC5rZXlzKHByb3BzIHx8IHt9KTsKICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXModGhpcykpIHsKICAgICAgICBpZiAoa2V5WzBdICE9PSAiXyIgJiYgZGVjbGFyZWRQcm9wS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICB0aGlzLl9zZXRQcm9wKGtleSwgdGhpc1trZXldLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAoY29uc3Qga2V5IG9mIGRlY2xhcmVkUHJvcEtleXMubWFwKGNhbWVsaXplKSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBrZXksIHsKICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2dldFByb3Aoa2V5KTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQodmFsKSB7CiAgICAgICAgICAgIHRoaXMuX3NldFByb3Aoa2V5LCB2YWwpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgICBfc2V0QXR0cihrZXkpIHsKICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRBdHRyaWJ1dGUoa2V5KTsKICAgICAgY29uc3QgY2FtZWxLZXkgPSBjYW1lbGl6ZShrZXkpOwogICAgICBpZiAodGhpcy5fbnVtYmVyUHJvcHMgJiYgdGhpcy5fbnVtYmVyUHJvcHNbY2FtZWxLZXldKSB7CiAgICAgICAgdmFsdWUgPSB0b051bWJlcih2YWx1ZSk7CiAgICAgIH0KICAgICAgdGhpcy5fc2V0UHJvcChjYW1lbEtleSwgdmFsdWUsIGZhbHNlKTsKICAgIH0KICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIF9nZXRQcm9wKGtleSkgewogICAgICByZXR1cm4gdGhpcy5fcHJvcHNba2V5XTsKICAgIH0KICAgIC8qKgogICAgICogQGludGVybmFsCiAgICAgKi8KICAgIF9zZXRQcm9wKGtleSwgdmFsLCBzaG91bGRSZWZsZWN0ID0gdHJ1ZSwgc2hvdWxkVXBkYXRlID0gdHJ1ZSkgewogICAgICBpZiAodmFsICE9PSB0aGlzLl9wcm9wc1trZXldKSB7CiAgICAgICAgdGhpcy5fcHJvcHNba2V5XSA9IHZhbDsKICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIHRoaXMuX2luc3RhbmNlKSB7CiAgICAgICAgICB0aGlzLl91cGRhdGUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZFJlZmxlY3QpIHsKICAgICAgICAgIGlmICh2YWwgPT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoaHlwaGVuYXRlKGtleSksICIiKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoaHlwaGVuYXRlKGtleSksIHZhbCArICIiKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIXZhbCkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUF0dHJpYnV0ZShoeXBoZW5hdGUoa2V5KSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBfdXBkYXRlKCkgewogICAgICByZW5kZXIodGhpcy5fY3JlYXRlVk5vZGUoKSwgdGhpcy5zaGFkb3dSb290KTsKICAgIH0KICAgIF9jcmVhdGVWTm9kZSgpIHsKICAgICAgY29uc3Qgdm5vZGUgPSBjcmVhdGVWTm9kZSh0aGlzLl9kZWYsIGV4dGVuZCh7fSwgdGhpcy5fcHJvcHMpKTsKICAgICAgaWYgKCF0aGlzLl9pbnN0YW5jZSkgewogICAgICAgIHZub2RlLmNlID0gKGluc3RhbmNlKSA9PiB7CiAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgaW5zdGFuY2UuaXNDRSA9IHRydWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGluc3RhbmNlLmNlUmVsb2FkID0gKG5ld1N0eWxlcykgPT4gewogICAgICAgICAgICAgIGlmICh0aGlzLl9zdHlsZXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlcy5mb3JFYWNoKChzKSA9PiB0aGlzLnNoYWRvd1Jvb3QucmVtb3ZlQ2hpbGQocykpOwogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX2FwcGx5U3R5bGVzKG5ld1N0eWxlcyk7CiAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZSgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgZGlzcGF0Y2ggPSAoZXZlbnQsIGFyZ3MpID0+IHsKICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KAogICAgICAgICAgICAgIG5ldyBDdXN0b21FdmVudChldmVudCwgewogICAgICAgICAgICAgICAgZGV0YWlsOiBhcmdzCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICBpbnN0YW5jZS5lbWl0ID0gKGV2ZW50LCAuLi5hcmdzKSA9PiB7CiAgICAgICAgICAgIGRpc3BhdGNoKGV2ZW50LCBhcmdzKTsKICAgICAgICAgICAgaWYgKGh5cGhlbmF0ZShldmVudCkgIT09IGV2ZW50KSB7CiAgICAgICAgICAgICAgZGlzcGF0Y2goaHlwaGVuYXRlKGV2ZW50KSwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBsZXQgcGFyZW50ID0gdGhpczsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgPSBwYXJlbnQgJiYgKHBhcmVudC5wYXJlbnROb2RlIHx8IHBhcmVudC5ob3N0KSkgewogICAgICAgICAgICBpZiAocGFyZW50IGluc3RhbmNlb2YgVnVlRWxlbWVudCkgewogICAgICAgICAgICAgIGluc3RhbmNlLnBhcmVudCA9IHBhcmVudC5faW5zdGFuY2U7CiAgICAgICAgICAgICAgaW5zdGFuY2UucHJvdmlkZXMgPSBwYXJlbnQuX2luc3RhbmNlLnByb3ZpZGVzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gdm5vZGU7CiAgICB9CiAgICBfYXBwbHlTdHlsZXMoc3R5bGVzKSB7CiAgICAgIGlmIChzdHlsZXMpIHsKICAgICAgICBzdHlsZXMuZm9yRWFjaCgoY3NzKSA9PiB7CiAgICAgICAgICBjb25zdCBzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgIHMudGV4dENvbnRlbnQgPSBjc3M7CiAgICAgICAgICB0aGlzLnNoYWRvd1Jvb3QuYXBwZW5kQ2hpbGQocyk7CiAgICAgICAgICB7CiAgICAgICAgICAgICh0aGlzLl9zdHlsZXMgfHwgKHRoaXMuX3N0eWxlcyA9IFtdKSkucHVzaChzKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gdXNlQ3NzTW9kdWxlKG5hbWUgPSAiJHN0eWxlIikgewogICAgewogICAgICB7CiAgICAgICAgd2FybihgdXNlQ3NzTW9kdWxlKCkgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgZ2xvYmFsIGJ1aWxkLmApOwogICAgICB9CiAgICAgIHJldHVybiBFTVBUWV9PQko7CiAgICB9CiAgfQoKICBjb25zdCBwb3NpdGlvbk1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogIGNvbnN0IG5ld1Bvc2l0aW9uTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgY29uc3QgbW92ZUNiS2V5ID0gU3ltYm9sKCJfbW92ZUNiIik7CiAgY29uc3QgZW50ZXJDYktleSA9IFN5bWJvbCgiX2VudGVyQ2IiKTsKICBjb25zdCBUcmFuc2l0aW9uR3JvdXBJbXBsID0gewogICAgbmFtZTogIlRyYW5zaXRpb25Hcm91cCIsCiAgICBwcm9wczogLyogQF9fUFVSRV9fICovIGV4dGVuZCh7fSwgVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycywgewogICAgICB0YWc6IFN0cmluZywKICAgICAgbW92ZUNsYXNzOiBTdHJpbmcKICAgIH0pLAogICAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkgewogICAgICBjb25zdCBpbnN0YW5jZSA9IGdldEN1cnJlbnRJbnN0YW5jZSgpOwogICAgICBjb25zdCBzdGF0ZSA9IHVzZVRyYW5zaXRpb25TdGF0ZSgpOwogICAgICBsZXQgcHJldkNoaWxkcmVuOwogICAgICBsZXQgY2hpbGRyZW47CiAgICAgIG9uVXBkYXRlZCgoKSA9PiB7CiAgICAgICAgaWYgKCFwcmV2Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG1vdmVDbGFzcyA9IHByb3BzLm1vdmVDbGFzcyB8fCBgJHtwcm9wcy5uYW1lIHx8ICJ2In0tbW92ZWA7CiAgICAgICAgaWYgKCFoYXNDU1NUcmFuc2Zvcm0oCiAgICAgICAgICBwcmV2Q2hpbGRyZW5bMF0uZWwsCiAgICAgICAgICBpbnN0YW5jZS52bm9kZS5lbCwKICAgICAgICAgIG1vdmVDbGFzcwogICAgICAgICkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcHJldkNoaWxkcmVuLmZvckVhY2goY2FsbFBlbmRpbmdDYnMpOwogICAgICAgIHByZXZDaGlsZHJlbi5mb3JFYWNoKHJlY29yZFBvc2l0aW9uKTsKICAgICAgICBjb25zdCBtb3ZlZENoaWxkcmVuID0gcHJldkNoaWxkcmVuLmZpbHRlcihhcHBseVRyYW5zbGF0aW9uKTsKICAgICAgICBmb3JjZVJlZmxvdygpOwogICAgICAgIG1vdmVkQ2hpbGRyZW4uZm9yRWFjaCgoYykgPT4gewogICAgICAgICAgY29uc3QgZWwgPSBjLmVsOwogICAgICAgICAgY29uc3Qgc3R5bGUgPSBlbC5zdHlsZTsKICAgICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsKICAgICAgICAgIHN0eWxlLnRyYW5zZm9ybSA9IHN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IHN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9ICIiOwogICAgICAgICAgY29uc3QgY2IgPSBlbFttb3ZlQ2JLZXldID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUgJiYgZS50YXJnZXQgIT09IGVsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghZSB8fCAvdHJhbnNmb3JtJC8udGVzdChlLnByb3BlcnR5TmFtZSkpIHsKICAgICAgICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCJ0cmFuc2l0aW9uZW5kIiwgY2IpOwogICAgICAgICAgICAgIGVsW21vdmVDYktleV0gPSBudWxsOwogICAgICAgICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoInRyYW5zaXRpb25lbmQiLCBjYik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGNvbnN0IHJhd1Byb3BzID0gdG9SYXcocHJvcHMpOwogICAgICAgIGNvbnN0IGNzc1RyYW5zaXRpb25Qcm9wcyA9IHJlc29sdmVUcmFuc2l0aW9uUHJvcHMocmF3UHJvcHMpOwogICAgICAgIGxldCB0YWcgPSByYXdQcm9wcy50YWcgfHwgRnJhZ21lbnQ7CiAgICAgICAgcHJldkNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgY2hpbGRyZW4gPSBzbG90cy5kZWZhdWx0ID8gZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuKHNsb3RzLmRlZmF1bHQoKSkgOiBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgaWYgKGNoaWxkLmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFRyYW5zaXRpb25Ib29rcygKICAgICAgICAgICAgICBjaGlsZCwKICAgICAgICAgICAgICByZXNvbHZlVHJhbnNpdGlvbkhvb2tzKGNoaWxkLCBjc3NUcmFuc2l0aW9uUHJvcHMsIHN0YXRlLCBpbnN0YW5jZSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdhcm4oYDxUcmFuc2l0aW9uR3JvdXA+IGNoaWxkcmVuIG11c3QgYmUga2V5ZWQuYCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJldkNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGNoaWxkID0gcHJldkNoaWxkcmVuW2ldOwogICAgICAgICAgICBzZXRUcmFuc2l0aW9uSG9va3MoCiAgICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgICAgcmVzb2x2ZVRyYW5zaXRpb25Ib29rcyhjaGlsZCwgY3NzVHJhbnNpdGlvblByb3BzLCBzdGF0ZSwgaW5zdGFuY2UpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHBvc2l0aW9uTWFwLnNldChjaGlsZCwgY2hpbGQuZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY3JlYXRlVk5vZGUodGFnLCBudWxsLCBjaGlsZHJlbik7CiAgICAgIH07CiAgICB9CiAgfTsKICBjb25zdCByZW1vdmVNb2RlID0gKHByb3BzKSA9PiBkZWxldGUgcHJvcHMubW9kZTsKICAvKiBAX19QVVJFX18gKi8gcmVtb3ZlTW9kZShUcmFuc2l0aW9uR3JvdXBJbXBsLnByb3BzKTsKICBjb25zdCBUcmFuc2l0aW9uR3JvdXAgPSBUcmFuc2l0aW9uR3JvdXBJbXBsOwogIGZ1bmN0aW9uIGNhbGxQZW5kaW5nQ2JzKGMpIHsKICAgIGNvbnN0IGVsID0gYy5lbDsKICAgIGlmIChlbFttb3ZlQ2JLZXldKSB7CiAgICAgIGVsW21vdmVDYktleV0oKTsKICAgIH0KICAgIGlmIChlbFtlbnRlckNiS2V5XSkgewogICAgICBlbFtlbnRlckNiS2V5XSgpOwogICAgfQogIH0KICBmdW5jdGlvbiByZWNvcmRQb3NpdGlvbihjKSB7CiAgICBuZXdQb3NpdGlvbk1hcC5zZXQoYywgYy5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSk7CiAgfQogIGZ1bmN0aW9uIGFwcGx5VHJhbnNsYXRpb24oYykgewogICAgY29uc3Qgb2xkUG9zID0gcG9zaXRpb25NYXAuZ2V0KGMpOwogICAgY29uc3QgbmV3UG9zID0gbmV3UG9zaXRpb25NYXAuZ2V0KGMpOwogICAgY29uc3QgZHggPSBvbGRQb3MubGVmdCAtIG5ld1Bvcy5sZWZ0OwogICAgY29uc3QgZHkgPSBvbGRQb3MudG9wIC0gbmV3UG9zLnRvcDsKICAgIGlmIChkeCB8fCBkeSkgewogICAgICBjb25zdCBzID0gYy5lbC5zdHlsZTsKICAgICAgcy50cmFuc2Zvcm0gPSBzLndlYmtpdFRyYW5zZm9ybSA9IGB0cmFuc2xhdGUoJHtkeH1weCwke2R5fXB4KWA7CiAgICAgIHMudHJhbnNpdGlvbkR1cmF0aW9uID0gIjBzIjsKICAgICAgcmV0dXJuIGM7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGhhc0NTU1RyYW5zZm9ybShlbCwgcm9vdCwgbW92ZUNsYXNzKSB7CiAgICBjb25zdCBjbG9uZSA9IGVsLmNsb25lTm9kZSgpOwogICAgY29uc3QgX3Z0YyA9IGVsW3Z0Y0tleV07CiAgICBpZiAoX3Z0YykgewogICAgICBfdnRjLmZvckVhY2goKGNscykgPT4gewogICAgICAgIGNscy5zcGxpdCgvXHMrLykuZm9yRWFjaCgoYykgPT4gYyAmJiBjbG9uZS5jbGFzc0xpc3QucmVtb3ZlKGMpKTsKICAgICAgfSk7CiAgICB9CiAgICBtb3ZlQ2xhc3Muc3BsaXQoL1xzKy8pLmZvckVhY2goKGMpID0+IGMgJiYgY2xvbmUuY2xhc3NMaXN0LmFkZChjKSk7CiAgICBjbG9uZS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgY29uc3QgY29udGFpbmVyID0gcm9vdC5ub2RlVHlwZSA9PT0gMSA/IHJvb3QgOiByb290LnBhcmVudE5vZGU7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoY2xvbmUpOwogICAgY29uc3QgeyBoYXNUcmFuc2Zvcm0gfSA9IGdldFRyYW5zaXRpb25JbmZvKGNsb25lKTsKICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChjbG9uZSk7CiAgICByZXR1cm4gaGFzVHJhbnNmb3JtOwogIH0KCiAgY29uc3QgZ2V0TW9kZWxBc3NpZ25lciA9ICh2bm9kZSkgPT4gewogICAgY29uc3QgZm4gPSB2bm9kZS5wcm9wc1sib25VcGRhdGU6bW9kZWxWYWx1ZSJdIHx8IGZhbHNlOwogICAgcmV0dXJuIGlzQXJyYXkoZm4pID8gKHZhbHVlKSA9PiBpbnZva2VBcnJheUZucyhmbiwgdmFsdWUpIDogZm47CiAgfTsKICBmdW5jdGlvbiBvbkNvbXBvc2l0aW9uU3RhcnQoZSkgewogICAgZS50YXJnZXQuY29tcG9zaW5nID0gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gb25Db21wb3NpdGlvbkVuZChlKSB7CiAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldDsKICAgIGlmICh0YXJnZXQuY29tcG9zaW5nKSB7CiAgICAgIHRhcmdldC5jb21wb3NpbmcgPSBmYWxzZTsKICAgICAgdGFyZ2V0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCJpbnB1dCIpKTsKICAgIH0KICB9CiAgY29uc3QgYXNzaWduS2V5ID0gU3ltYm9sKCJfYXNzaWduIik7CiAgY29uc3Qgdk1vZGVsVGV4dCA9IHsKICAgIGNyZWF0ZWQoZWwsIHsgbW9kaWZpZXJzOiB7IGxhenksIHRyaW0sIG51bWJlciB9IH0sIHZub2RlKSB7CiAgICAgIGVsW2Fzc2lnbktleV0gPSBnZXRNb2RlbEFzc2lnbmVyKHZub2RlKTsKICAgICAgY29uc3QgY2FzdFRvTnVtYmVyID0gbnVtYmVyIHx8IHZub2RlLnByb3BzICYmIHZub2RlLnByb3BzLnR5cGUgPT09ICJudW1iZXIiOwogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCBsYXp5ID8gImNoYW5nZSIgOiAiaW5wdXQiLCAoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5jb21wb3NpbmcpCiAgICAgICAgICByZXR1cm47CiAgICAgICAgbGV0IGRvbVZhbHVlID0gZWwudmFsdWU7CiAgICAgICAgaWYgKHRyaW0pIHsKICAgICAgICAgIGRvbVZhbHVlID0gZG9tVmFsdWUudHJpbSgpOwogICAgICAgIH0KICAgICAgICBpZiAoY2FzdFRvTnVtYmVyKSB7CiAgICAgICAgICBkb21WYWx1ZSA9IGxvb3NlVG9OdW1iZXIoZG9tVmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbFthc3NpZ25LZXldKGRvbVZhbHVlKTsKICAgICAgfSk7CiAgICAgIGlmICh0cmltKSB7CiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihlbCwgImNoYW5nZSIsICgpID0+IHsKICAgICAgICAgIGVsLnZhbHVlID0gZWwudmFsdWUudHJpbSgpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghbGF6eSkgewogICAgICAgIGFkZEV2ZW50TGlzdGVuZXIoZWwsICJjb21wb3NpdGlvbnN0YXJ0Iiwgb25Db21wb3NpdGlvblN0YXJ0KTsKICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY29tcG9zaXRpb25lbmQiLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgb25Db21wb3NpdGlvbkVuZCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBzZXQgdmFsdWUgb24gbW91bnRlZCBzbyBpdCdzIGFmdGVyIG1pbi9tYXggZm9yIHR5cGU9InJhbmdlIgogICAgbW91bnRlZChlbCwgeyB2YWx1ZSB9KSB7CiAgICAgIGVsLnZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7CiAgICB9LAogICAgYmVmb3JlVXBkYXRlKGVsLCB7IHZhbHVlLCBtb2RpZmllcnM6IHsgbGF6eSwgdHJpbSwgbnVtYmVyIH0gfSwgdm5vZGUpIHsKICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICBpZiAoZWwuY29tcG9zaW5nKQogICAgICAgIHJldHVybjsKICAgICAgY29uc3QgZWxWYWx1ZSA9IG51bWJlciB8fCBlbC50eXBlID09PSAibnVtYmVyIiA/IGxvb3NlVG9OdW1iZXIoZWwudmFsdWUpIDogZWwudmFsdWU7CiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7CiAgICAgIGlmIChlbFZhbHVlID09PSBuZXdWYWx1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gZWwgJiYgZWwudHlwZSAhPT0gInJhbmdlIikgewogICAgICAgIGlmIChsYXp5KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0cmltICYmIGVsLnZhbHVlLnRyaW0oKSA9PT0gbmV3VmFsdWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWwudmFsdWUgPSBuZXdWYWx1ZTsKICAgIH0KICB9OwogIGNvbnN0IHZNb2RlbENoZWNrYm94ID0gewogICAgLy8gIzQwOTYgYXJyYXkgY2hlY2tib3hlcyBuZWVkIHRvIGJlIGRlZXAgdHJhdmVyc2VkCiAgICBkZWVwOiB0cnVlLAogICAgY3JlYXRlZChlbCwgXywgdm5vZGUpIHsKICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgKCkgPT4gewogICAgICAgIGNvbnN0IG1vZGVsVmFsdWUgPSBlbC5fbW9kZWxWYWx1ZTsKICAgICAgICBjb25zdCBlbGVtZW50VmFsdWUgPSBnZXRWYWx1ZShlbCk7CiAgICAgICAgY29uc3QgY2hlY2tlZCA9IGVsLmNoZWNrZWQ7CiAgICAgICAgY29uc3QgYXNzaWduID0gZWxbYXNzaWduS2V5XTsKICAgICAgICBpZiAoaXNBcnJheShtb2RlbFZhbHVlKSkgewogICAgICAgICAgY29uc3QgaW5kZXggPSBsb29zZUluZGV4T2YobW9kZWxWYWx1ZSwgZWxlbWVudFZhbHVlKTsKICAgICAgICAgIGNvbnN0IGZvdW5kID0gaW5kZXggIT09IC0xOwogICAgICAgICAgaWYgKGNoZWNrZWQgJiYgIWZvdW5kKSB7CiAgICAgICAgICAgIGFzc2lnbihtb2RlbFZhbHVlLmNvbmNhdChlbGVtZW50VmFsdWUpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoIWNoZWNrZWQgJiYgZm91bmQpIHsKICAgICAgICAgICAgY29uc3QgZmlsdGVyZWQgPSBbLi4ubW9kZWxWYWx1ZV07CiAgICAgICAgICAgIGZpbHRlcmVkLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIGFzc2lnbihmaWx0ZXJlZCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc1NldChtb2RlbFZhbHVlKSkgewogICAgICAgICAgY29uc3QgY2xvbmVkID0gbmV3IFNldChtb2RlbFZhbHVlKTsKICAgICAgICAgIGlmIChjaGVja2VkKSB7CiAgICAgICAgICAgIGNsb25lZC5hZGQoZWxlbWVudFZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNsb25lZC5kZWxldGUoZWxlbWVudFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2lnbihjbG9uZWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhc3NpZ24oZ2V0Q2hlY2tib3hWYWx1ZShlbCwgY2hlY2tlZCkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgLy8gc2V0IGluaXRpYWwgY2hlY2tlZCBvbiBtb3VudCB0byB3YWl0IGZvciB0cnVlLXZhbHVlL2ZhbHNlLXZhbHVlCiAgICBtb3VudGVkOiBzZXRDaGVja2VkLAogICAgYmVmb3JlVXBkYXRlKGVsLCBiaW5kaW5nLCB2bm9kZSkgewogICAgICBlbFthc3NpZ25LZXldID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICAgIHNldENoZWNrZWQoZWwsIGJpbmRpbmcsIHZub2RlKTsKICAgIH0KICB9OwogIGZ1bmN0aW9uIHNldENoZWNrZWQoZWwsIHsgdmFsdWUsIG9sZFZhbHVlIH0sIHZub2RlKSB7CiAgICBlbC5fbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgIGVsLmNoZWNrZWQgPSBsb29zZUluZGV4T2YodmFsdWUsIHZub2RlLnByb3BzLnZhbHVlKSA+IC0xOwogICAgfSBlbHNlIGlmIChpc1NldCh2YWx1ZSkpIHsKICAgICAgZWwuY2hlY2tlZCA9IHZhbHVlLmhhcyh2bm9kZS5wcm9wcy52YWx1ZSk7CiAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSBvbGRWYWx1ZSkgewogICAgICBlbC5jaGVja2VkID0gbG9vc2VFcXVhbCh2YWx1ZSwgZ2V0Q2hlY2tib3hWYWx1ZShlbCwgdHJ1ZSkpOwogICAgfQogIH0KICBjb25zdCB2TW9kZWxSYWRpbyA9IHsKICAgIGNyZWF0ZWQoZWwsIHsgdmFsdWUgfSwgdm5vZGUpIHsKICAgICAgZWwuY2hlY2tlZCA9IGxvb3NlRXF1YWwodmFsdWUsIHZub2RlLnByb3BzLnZhbHVlKTsKICAgICAgZWxbYXNzaWduS2V5XSA9IGdldE1vZGVsQXNzaWduZXIodm5vZGUpOwogICAgICBhZGRFdmVudExpc3RlbmVyKGVsLCAiY2hhbmdlIiwgKCkgPT4gewogICAgICAgIGVsW2Fzc2lnbktleV0oZ2V0VmFsdWUoZWwpKTsKICAgICAgfSk7CiAgICB9LAogICAgYmVmb3JlVXBkYXRlKGVsLCB7IHZhbHVlLCBvbGRWYWx1ZSB9LCB2bm9kZSkgewogICAgICBlbFthc3NpZ25LZXldID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICAgIGlmICh2YWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICBlbC5jaGVja2VkID0gbG9vc2VFcXVhbCh2YWx1ZSwgdm5vZGUucHJvcHMudmFsdWUpOwogICAgICB9CiAgICB9CiAgfTsKICBjb25zdCB2TW9kZWxTZWxlY3QgPSB7CiAgICAvLyA8c2VsZWN0IG11bHRpcGxlPiB2YWx1ZSBuZWVkIHRvIGJlIGRlZXAgdHJhdmVyc2VkCiAgICBkZWVwOiB0cnVlLAogICAgY3JlYXRlZChlbCwgeyB2YWx1ZSwgbW9kaWZpZXJzOiB7IG51bWJlciB9IH0sIHZub2RlKSB7CiAgICAgIGNvbnN0IGlzU2V0TW9kZWwgPSBpc1NldCh2YWx1ZSk7CiAgICAgIGFkZEV2ZW50TGlzdGVuZXIoZWwsICJjaGFuZ2UiLCAoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRWYWwgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwoZWwub3B0aW9ucywgKG8pID0+IG8uc2VsZWN0ZWQpLm1hcCgKICAgICAgICAgIChvKSA9PiBudW1iZXIgPyBsb29zZVRvTnVtYmVyKGdldFZhbHVlKG8pKSA6IGdldFZhbHVlKG8pCiAgICAgICAgKTsKICAgICAgICBlbFthc3NpZ25LZXldKAogICAgICAgICAgZWwubXVsdGlwbGUgPyBpc1NldE1vZGVsID8gbmV3IFNldChzZWxlY3RlZFZhbCkgOiBzZWxlY3RlZFZhbCA6IHNlbGVjdGVkVmFsWzBdCiAgICAgICAgKTsKICAgICAgICBlbC5fYXNzaWduaW5nID0gdHJ1ZTsKICAgICAgICBuZXh0VGljaygoKSA9PiB7CiAgICAgICAgICBlbC5fYXNzaWduaW5nID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBlbFthc3NpZ25LZXldID0gZ2V0TW9kZWxBc3NpZ25lcih2bm9kZSk7CiAgICB9LAogICAgLy8gc2V0IHZhbHVlIGluIG1vdW50ZWQgJiB1cGRhdGVkIGJlY2F1c2UgPHNlbGVjdD4gcmVsaWVzIG9uIGl0cyBjaGlsZHJlbgogICAgLy8gPG9wdGlvbj5zLgogICAgbW91bnRlZChlbCwgeyB2YWx1ZSwgbW9kaWZpZXJzOiB7IG51bWJlciB9IH0pIHsKICAgICAgc2V0U2VsZWN0ZWQoZWwsIHZhbHVlLCBudW1iZXIpOwogICAgfSwKICAgIGJlZm9yZVVwZGF0ZShlbCwgX2JpbmRpbmcsIHZub2RlKSB7CiAgICAgIGVsW2Fzc2lnbktleV0gPSBnZXRNb2RlbEFzc2lnbmVyKHZub2RlKTsKICAgIH0sCiAgICB1cGRhdGVkKGVsLCB7IHZhbHVlLCBtb2RpZmllcnM6IHsgbnVtYmVyIH0gfSkgewogICAgICBpZiAoIWVsLl9hc3NpZ25pbmcpIHsKICAgICAgICBzZXRTZWxlY3RlZChlbCwgdmFsdWUsIG51bWJlcik7CiAgICAgIH0KICAgIH0KICB9OwogIGZ1bmN0aW9uIHNldFNlbGVjdGVkKGVsLCB2YWx1ZSwgbnVtYmVyKSB7CiAgICBjb25zdCBpc011bHRpcGxlID0gZWwubXVsdGlwbGU7CiAgICBjb25zdCBpc0FycmF5VmFsdWUgPSBpc0FycmF5KHZhbHVlKTsKICAgIGlmIChpc011bHRpcGxlICYmICFpc0FycmF5VmFsdWUgJiYgIWlzU2V0KHZhbHVlKSkgewogICAgICB3YXJuKAogICAgICAgIGA8c2VsZWN0IG11bHRpcGxlIHYtbW9kZWw+IGV4cGVjdHMgYW4gQXJyYXkgb3IgU2V0IHZhbHVlIGZvciBpdHMgYmluZGluZywgYnV0IGdvdCAke09iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpfS5gCiAgICAgICk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwLCBsID0gZWwub3B0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3Qgb3B0aW9uID0gZWwub3B0aW9uc1tpXTsKICAgICAgY29uc3Qgb3B0aW9uVmFsdWUgPSBnZXRWYWx1ZShvcHRpb24pOwogICAgICBpZiAoaXNNdWx0aXBsZSkgewogICAgICAgIGlmIChpc0FycmF5VmFsdWUpIHsKICAgICAgICAgIGNvbnN0IG9wdGlvblR5cGUgPSB0eXBlb2Ygb3B0aW9uVmFsdWU7CiAgICAgICAgICBpZiAob3B0aW9uVHlwZSA9PT0gInN0cmluZyIgfHwgb3B0aW9uVHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdmFsdWUuaW5jbHVkZXMoCiAgICAgICAgICAgICAgbnVtYmVyID8gbG9vc2VUb051bWJlcihvcHRpb25WYWx1ZSkgOiBvcHRpb25WYWx1ZQogICAgICAgICAgICApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gbG9vc2VJbmRleE9mKHZhbHVlLCBvcHRpb25WYWx1ZSkgPiAtMTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdmFsdWUuaGFzKG9wdGlvblZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobG9vc2VFcXVhbChnZXRWYWx1ZShvcHRpb24pLCB2YWx1ZSkpIHsKICAgICAgICBpZiAoZWwuc2VsZWN0ZWRJbmRleCAhPT0gaSkKICAgICAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSBpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQogICAgaWYgKCFpc011bHRpcGxlICYmIGVsLnNlbGVjdGVkSW5kZXggIT09IC0xKSB7CiAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0VmFsdWUoZWwpIHsKICAgIHJldHVybiAiX3ZhbHVlIiBpbiBlbCA/IGVsLl92YWx1ZSA6IGVsLnZhbHVlOwogIH0KICBmdW5jdGlvbiBnZXRDaGVja2JveFZhbHVlKGVsLCBjaGVja2VkKSB7CiAgICBjb25zdCBrZXkgPSBjaGVja2VkID8gIl90cnVlVmFsdWUiIDogIl9mYWxzZVZhbHVlIjsKICAgIHJldHVybiBrZXkgaW4gZWwgPyBlbFtrZXldIDogY2hlY2tlZDsKICB9CiAgY29uc3Qgdk1vZGVsRHluYW1pYyA9IHsKICAgIGNyZWF0ZWQoZWwsIGJpbmRpbmcsIHZub2RlKSB7CiAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBudWxsLCAiY3JlYXRlZCIpOwogICAgfSwKICAgIG1vdW50ZWQoZWwsIGJpbmRpbmcsIHZub2RlKSB7CiAgICAgIGNhbGxNb2RlbEhvb2soZWwsIGJpbmRpbmcsIHZub2RlLCBudWxsLCAibW91bnRlZCIpOwogICAgfSwKICAgIGJlZm9yZVVwZGF0ZShlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSkgewogICAgICBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlLCAiYmVmb3JlVXBkYXRlIik7CiAgICB9LAogICAgdXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUsIHByZXZWTm9kZSkgewogICAgICBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlLCAidXBkYXRlZCIpOwogICAgfQogIH07CiAgZnVuY3Rpb24gcmVzb2x2ZUR5bmFtaWNNb2RlbCh0YWdOYW1lLCB0eXBlKSB7CiAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgY2FzZSAiU0VMRUNUIjoKICAgICAgICByZXR1cm4gdk1vZGVsU2VsZWN0OwogICAgICBjYXNlICJURVhUQVJFQSI6CiAgICAgICAgcmV0dXJuIHZNb2RlbFRleHQ7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICJjaGVja2JveCI6CiAgICAgICAgICAgIHJldHVybiB2TW9kZWxDaGVja2JveDsKICAgICAgICAgIGNhc2UgInJhZGlvIjoKICAgICAgICAgICAgcmV0dXJuIHZNb2RlbFJhZGlvOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIHZNb2RlbFRleHQ7CiAgICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBjYWxsTW9kZWxIb29rKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlLCBob29rKSB7CiAgICBjb25zdCBtb2RlbFRvVXNlID0gcmVzb2x2ZUR5bmFtaWNNb2RlbCgKICAgICAgZWwudGFnTmFtZSwKICAgICAgdm5vZGUucHJvcHMgJiYgdm5vZGUucHJvcHMudHlwZQogICAgKTsKICAgIGNvbnN0IGZuID0gbW9kZWxUb1VzZVtob29rXTsKICAgIGZuICYmIGZuKGVsLCBiaW5kaW5nLCB2bm9kZSwgcHJldlZOb2RlKTsKICB9CgogIGNvbnN0IHN5c3RlbU1vZGlmaWVycyA9IFsiY3RybCIsICJzaGlmdCIsICJhbHQiLCAibWV0YSJdOwogIGNvbnN0IG1vZGlmaWVyR3VhcmRzID0gewogICAgc3RvcDogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICBwcmV2ZW50OiAoZSkgPT4gZS5wcmV2ZW50RGVmYXVsdCgpLAogICAgc2VsZjogKGUpID0+IGUudGFyZ2V0ICE9PSBlLmN1cnJlbnRUYXJnZXQsCiAgICBjdHJsOiAoZSkgPT4gIWUuY3RybEtleSwKICAgIHNoaWZ0OiAoZSkgPT4gIWUuc2hpZnRLZXksCiAgICBhbHQ6IChlKSA9PiAhZS5hbHRLZXksCiAgICBtZXRhOiAoZSkgPT4gIWUubWV0YUtleSwKICAgIGxlZnQ6IChlKSA9PiAiYnV0dG9uIiBpbiBlICYmIGUuYnV0dG9uICE9PSAwLAogICAgbWlkZGxlOiAoZSkgPT4gImJ1dHRvbiIgaW4gZSAmJiBlLmJ1dHRvbiAhPT0gMSwKICAgIHJpZ2h0OiAoZSkgPT4gImJ1dHRvbiIgaW4gZSAmJiBlLmJ1dHRvbiAhPT0gMiwKICAgIGV4YWN0OiAoZSwgbW9kaWZpZXJzKSA9PiBzeXN0ZW1Nb2RpZmllcnMuc29tZSgobSkgPT4gZVtgJHttfUtleWBdICYmICFtb2RpZmllcnMuaW5jbHVkZXMobSkpCiAgfTsKICBjb25zdCB3aXRoTW9kaWZpZXJzID0gKGZuLCBtb2RpZmllcnMpID0+IHsKICAgIGNvbnN0IGNhY2hlID0gZm4uX3dpdGhNb2RzIHx8IChmbi5fd2l0aE1vZHMgPSB7fSk7CiAgICBjb25zdCBjYWNoZUtleSA9IG1vZGlmaWVycy5qb2luKCIuIik7CiAgICByZXR1cm4gY2FjaGVbY2FjaGVLZXldIHx8IChjYWNoZVtjYWNoZUtleV0gPSAoZXZlbnQsIC4uLmFyZ3MpID0+IHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2RpZmllcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBndWFyZCA9IG1vZGlmaWVyR3VhcmRzW21vZGlmaWVyc1tpXV07CiAgICAgICAgaWYgKGd1YXJkICYmIGd1YXJkKGV2ZW50LCBtb2RpZmllcnMpKQogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHJldHVybiBmbihldmVudCwgLi4uYXJncyk7CiAgICB9KTsKICB9OwogIGNvbnN0IGtleU5hbWVzID0gewogICAgZXNjOiAiZXNjYXBlIiwKICAgIHNwYWNlOiAiICIsCiAgICB1cDogImFycm93LXVwIiwKICAgIGxlZnQ6ICJhcnJvdy1sZWZ0IiwKICAgIHJpZ2h0OiAiYXJyb3ctcmlnaHQiLAogICAgZG93bjogImFycm93LWRvd24iLAogICAgZGVsZXRlOiAiYmFja3NwYWNlIgogIH07CiAgY29uc3Qgd2l0aEtleXMgPSAoZm4sIG1vZGlmaWVycykgPT4gewogICAgY29uc3QgY2FjaGUgPSBmbi5fd2l0aEtleXMgfHwgKGZuLl93aXRoS2V5cyA9IHt9KTsKICAgIGNvbnN0IGNhY2hlS2V5ID0gbW9kaWZpZXJzLmpvaW4oIi4iKTsKICAgIHJldHVybiBjYWNoZVtjYWNoZUtleV0gfHwgKGNhY2hlW2NhY2hlS2V5XSA9IChldmVudCkgPT4gewogICAgICBpZiAoISgia2V5IiBpbiBldmVudCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZXZlbnRLZXkgPSBoeXBoZW5hdGUoZXZlbnQua2V5KTsKICAgICAgaWYgKG1vZGlmaWVycy5zb21lKChrKSA9PiBrID09PSBldmVudEtleSB8fCBrZXlOYW1lc1trXSA9PT0gZXZlbnRLZXkpKSB7CiAgICAgICAgcmV0dXJuIGZuKGV2ZW50KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgY29uc3QgcmVuZGVyZXJPcHRpb25zID0gLyogQF9fUFVSRV9fICovIGV4dGVuZCh7IHBhdGNoUHJvcCB9LCBub2RlT3BzKTsKICBsZXQgcmVuZGVyZXI7CiAgbGV0IGVuYWJsZWRIeWRyYXRpb24gPSBmYWxzZTsKICBmdW5jdGlvbiBlbnN1cmVSZW5kZXJlcigpIHsKICAgIHJldHVybiByZW5kZXJlciB8fCAocmVuZGVyZXIgPSBjcmVhdGVSZW5kZXJlcihyZW5kZXJlck9wdGlvbnMpKTsKICB9CiAgZnVuY3Rpb24gZW5zdXJlSHlkcmF0aW9uUmVuZGVyZXIoKSB7CiAgICByZW5kZXJlciA9IGVuYWJsZWRIeWRyYXRpb24gPyByZW5kZXJlciA6IGNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyKHJlbmRlcmVyT3B0aW9ucyk7CiAgICBlbmFibGVkSHlkcmF0aW9uID0gdHJ1ZTsKICAgIHJldHVybiByZW5kZXJlcjsKICB9CiAgY29uc3QgcmVuZGVyID0gKC4uLmFyZ3MpID0+IHsKICAgIGVuc3VyZVJlbmRlcmVyKCkucmVuZGVyKC4uLmFyZ3MpOwogIH07CiAgY29uc3QgaHlkcmF0ZSA9ICguLi5hcmdzKSA9PiB7CiAgICBlbnN1cmVIeWRyYXRpb25SZW5kZXJlcigpLmh5ZHJhdGUoLi4uYXJncyk7CiAgfTsKICBjb25zdCBjcmVhdGVBcHAgPSAoLi4uYXJncykgPT4gewogICAgY29uc3QgYXBwID0gZW5zdXJlUmVuZGVyZXIoKS5jcmVhdGVBcHAoLi4uYXJncyk7CiAgICB7CiAgICAgIGluamVjdE5hdGl2ZVRhZ0NoZWNrKGFwcCk7CiAgICAgIGluamVjdENvbXBpbGVyT3B0aW9uc0NoZWNrKGFwcCk7CiAgICB9CiAgICBjb25zdCB7IG1vdW50IH0gPSBhcHA7CiAgICBhcHAubW91bnQgPSAoY29udGFpbmVyT3JTZWxlY3RvcikgPT4gewogICAgICBjb25zdCBjb250YWluZXIgPSBub3JtYWxpemVDb250YWluZXIoY29udGFpbmVyT3JTZWxlY3Rvcik7CiAgICAgIGlmICghY29udGFpbmVyKQogICAgICAgIHJldHVybjsKICAgICAgY29uc3QgY29tcG9uZW50ID0gYXBwLl9jb21wb25lbnQ7CiAgICAgIGlmICghaXNGdW5jdGlvbihjb21wb25lbnQpICYmICFjb21wb25lbnQucmVuZGVyICYmICFjb21wb25lbnQudGVtcGxhdGUpIHsKICAgICAgICBjb21wb25lbnQudGVtcGxhdGUgPSBjb250YWluZXIuaW5uZXJIVE1MOwogICAgICB9CiAgICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAiIjsKICAgICAgY29uc3QgcHJveHkgPSBtb3VudChjb250YWluZXIsIGZhbHNlLCByZXNvbHZlUm9vdE5hbWVzcGFjZShjb250YWluZXIpKTsKICAgICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIEVsZW1lbnQpIHsKICAgICAgICBjb250YWluZXIucmVtb3ZlQXR0cmlidXRlKCJ2LWNsb2FrIik7CiAgICAgICAgY29udGFpbmVyLnNldEF0dHJpYnV0ZSgiZGF0YS12LWFwcCIsICIiKTsKICAgICAgfQogICAgICByZXR1cm4gcHJveHk7CiAgICB9OwogICAgcmV0dXJuIGFwcDsKICB9OwogIGNvbnN0IGNyZWF0ZVNTUkFwcCA9ICguLi5hcmdzKSA9PiB7CiAgICBjb25zdCBhcHAgPSBlbnN1cmVIeWRyYXRpb25SZW5kZXJlcigpLmNyZWF0ZUFwcCguLi5hcmdzKTsKICAgIHsKICAgICAgaW5qZWN0TmF0aXZlVGFnQ2hlY2soYXBwKTsKICAgICAgaW5qZWN0Q29tcGlsZXJPcHRpb25zQ2hlY2soYXBwKTsKICAgIH0KICAgIGNvbnN0IHsgbW91bnQgfSA9IGFwcDsKICAgIGFwcC5tb3VudCA9IChjb250YWluZXJPclNlbGVjdG9yKSA9PiB7CiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IG5vcm1hbGl6ZUNvbnRhaW5lcihjb250YWluZXJPclNlbGVjdG9yKTsKICAgICAgaWYgKGNvbnRhaW5lcikgewogICAgICAgIHJldHVybiBtb3VudChjb250YWluZXIsIHRydWUsIHJlc29sdmVSb290TmFtZXNwYWNlKGNvbnRhaW5lcikpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIGFwcDsKICB9OwogIGZ1bmN0aW9uIHJlc29sdmVSb290TmFtZXNwYWNlKGNvbnRhaW5lcikgewogICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIFNWR0VsZW1lbnQpIHsKICAgICAgcmV0dXJuICJzdmciOwogICAgfQogICAgaWYgKHR5cGVvZiBNYXRoTUxFbGVtZW50ID09PSAiZnVuY3Rpb24iICYmIGNvbnRhaW5lciBpbnN0YW5jZW9mIE1hdGhNTEVsZW1lbnQpIHsKICAgICAgcmV0dXJuICJtYXRobWwiOwogICAgfQogIH0KICBmdW5jdGlvbiBpbmplY3ROYXRpdmVUYWdDaGVjayhhcHApIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHAuY29uZmlnLCAiaXNOYXRpdmVUYWciLCB7CiAgICAgIHZhbHVlOiAodGFnKSA9PiBpc0hUTUxUYWcodGFnKSB8fCBpc1NWR1RhZyh0YWcpIHx8IGlzTWF0aE1MVGFnKHRhZyksCiAgICAgIHdyaXRhYmxlOiBmYWxzZQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIGluamVjdENvbXBpbGVyT3B0aW9uc0NoZWNrKGFwcCkgewogICAgaWYgKGlzUnVudGltZU9ubHkoKSkgewogICAgICBjb25zdCBpc0N1c3RvbUVsZW1lbnQgPSBhcHAuY29uZmlnLmlzQ3VzdG9tRWxlbWVudDsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwcC5jb25maWcsICJpc0N1c3RvbUVsZW1lbnQiLCB7CiAgICAgICAgZ2V0KCkgewogICAgICAgICAgcmV0dXJuIGlzQ3VzdG9tRWxlbWVudDsKICAgICAgICB9LAogICAgICAgIHNldCgpIHsKICAgICAgICAgIHdhcm4oCiAgICAgICAgICAgIGBUaGUgXGBpc0N1c3RvbUVsZW1lbnRcYCBjb25maWcgb3B0aW9uIGlzIGRlcHJlY2F0ZWQuIFVzZSBcYGNvbXBpbGVyT3B0aW9ucy5pc0N1c3RvbUVsZW1lbnRcYCBpbnN0ZWFkLmAKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3QgY29tcGlsZXJPcHRpb25zID0gYXBwLmNvbmZpZy5jb21waWxlck9wdGlvbnM7CiAgICAgIGNvbnN0IG1zZyA9IGBUaGUgXGBjb21waWxlck9wdGlvbnNcYCBjb25maWcgb3B0aW9uIGlzIG9ubHkgcmVzcGVjdGVkIHdoZW4gdXNpbmcgYSBidWlsZCBvZiBWdWUuanMgdGhhdCBpbmNsdWRlcyB0aGUgcnVudGltZSBjb21waWxlciAoYWthICJmdWxsIGJ1aWxkIikuIFNpbmNlIHlvdSBhcmUgdXNpbmcgdGhlIHJ1bnRpbWUtb25seSBidWlsZCwgXGBjb21waWxlck9wdGlvbnNcYCBtdXN0IGJlIHBhc3NlZCB0byBcYEB2dWUvY29tcGlsZXItZG9tXGAgaW4gdGhlIGJ1aWxkIHNldHVwIGluc3RlYWQuCi0gRm9yIHZ1ZS1sb2FkZXI6IHBhc3MgaXQgdmlhIHZ1ZS1sb2FkZXIncyBcYGNvbXBpbGVyT3B0aW9uc1xgIGxvYWRlciBvcHRpb24uCi0gRm9yIHZ1ZS1jbGk6IHNlZSBodHRwczovL2NsaS52dWVqcy5vcmcvZ3VpZGUvd2VicGFjay5odG1sI21vZGlmeWluZy1vcHRpb25zLW9mLWEtbG9hZGVyCi0gRm9yIHZpdGU6IHBhc3MgaXQgdmlhIEB2aXRlanMvcGx1Z2luLXZ1ZSBvcHRpb25zLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3ZpdGVqcy92aXRlLXBsdWdpbi12dWUvdHJlZS9tYWluL3BhY2thZ2VzL3BsdWdpbi12dWUjZXhhbXBsZS1mb3ItcGFzc2luZy1vcHRpb25zLXRvLXZ1ZWNvbXBpbGVyLXNmY2A7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcHAuY29uZmlnLCAiY29tcGlsZXJPcHRpb25zIiwgewogICAgICAgIGdldCgpIHsKICAgICAgICAgIHdhcm4obXNnKTsKICAgICAgICAgIHJldHVybiBjb21waWxlck9wdGlvbnM7CiAgICAgICAgfSwKICAgICAgICBzZXQoKSB7CiAgICAgICAgICB3YXJuKG1zZyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gbm9ybWFsaXplQ29udGFpbmVyKGNvbnRhaW5lcikgewogICAgaWYgKGlzU3RyaW5nKGNvbnRhaW5lcikpIHsKICAgICAgY29uc3QgcmVzID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihjb250YWluZXIpOwogICAgICBpZiAoIXJlcykgewogICAgICAgIHdhcm4oCiAgICAgICAgICBgRmFpbGVkIHRvIG1vdW50IGFwcDogbW91bnQgdGFyZ2V0IHNlbGVjdG9yICIke2NvbnRhaW5lcn0iIHJldHVybmVkIG51bGwuYAogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlczsKICAgIH0KICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiBjb250YWluZXIgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCAmJiBjb250YWluZXIubW9kZSA9PT0gImNsb3NlZCIpIHsKICAgICAgd2FybigKICAgICAgICBgbW91bnRpbmcgb24gYSBTaGFkb3dSb290IHdpdGggXGB7bW9kZTogImNsb3NlZCJ9XGAgbWF5IGxlYWQgdG8gdW5wcmVkaWN0YWJsZSBidWdzYAogICAgICApOwogICAgfQogICAgcmV0dXJuIGNvbnRhaW5lcjsKICB9CiAgY29uc3QgaW5pdERpcmVjdGl2ZXNGb3JTU1IgPSBOT09QOwoKICBmdW5jdGlvbiBpbml0RGV2KCkgewogICAgewogICAgICB7CiAgICAgICAgY29uc29sZS5pbmZvKAogICAgICAgICAgYFlvdSBhcmUgcnVubmluZyBhIGRldmVsb3BtZW50IGJ1aWxkIG9mIFZ1ZS4KTWFrZSBzdXJlIHRvIHVzZSB0aGUgcHJvZHVjdGlvbiBidWlsZCAoKi5wcm9kLmpzKSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5gCiAgICAgICAgKTsKICAgICAgfQogICAgICBpbml0Q3VzdG9tRm9ybWF0dGVyKCk7CiAgICB9CiAgfQoKICBjb25zdCBGUkFHTUVOVCA9IFN5bWJvbChgRnJhZ21lbnRgICk7CiAgY29uc3QgVEVMRVBPUlQgPSBTeW1ib2woYFRlbGVwb3J0YCApOwogIGNvbnN0IFNVU1BFTlNFID0gU3ltYm9sKGBTdXNwZW5zZWAgKTsKICBjb25zdCBLRUVQX0FMSVZFID0gU3ltYm9sKGBLZWVwQWxpdmVgICk7CiAgY29uc3QgQkFTRV9UUkFOU0lUSU9OID0gU3ltYm9sKGBCYXNlVHJhbnNpdGlvbmAgKTsKICBjb25zdCBPUEVOX0JMT0NLID0gU3ltYm9sKGBvcGVuQmxvY2tgICk7CiAgY29uc3QgQ1JFQVRFX0JMT0NLID0gU3ltYm9sKGBjcmVhdGVCbG9ja2AgKTsKICBjb25zdCBDUkVBVEVfRUxFTUVOVF9CTE9DSyA9IFN5bWJvbChgY3JlYXRlRWxlbWVudEJsb2NrYCApOwogIGNvbnN0IENSRUFURV9WTk9ERSA9IFN5bWJvbChgY3JlYXRlVk5vZGVgICk7CiAgY29uc3QgQ1JFQVRFX0VMRU1FTlRfVk5PREUgPSBTeW1ib2woYGNyZWF0ZUVsZW1lbnRWTm9kZWAgKTsKICBjb25zdCBDUkVBVEVfQ09NTUVOVCA9IFN5bWJvbChgY3JlYXRlQ29tbWVudFZOb2RlYCApOwogIGNvbnN0IENSRUFURV9URVhUID0gU3ltYm9sKGBjcmVhdGVUZXh0Vk5vZGVgICk7CiAgY29uc3QgQ1JFQVRFX1NUQVRJQyA9IFN5bWJvbChgY3JlYXRlU3RhdGljVk5vZGVgICk7CiAgY29uc3QgUkVTT0xWRV9DT01QT05FTlQgPSBTeW1ib2woYHJlc29sdmVDb21wb25lbnRgICk7CiAgY29uc3QgUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVCA9IFN5bWJvbCgKICAgIGByZXNvbHZlRHluYW1pY0NvbXBvbmVudGAgCiAgKTsKICBjb25zdCBSRVNPTFZFX0RJUkVDVElWRSA9IFN5bWJvbChgcmVzb2x2ZURpcmVjdGl2ZWAgKTsKICBjb25zdCBSRVNPTFZFX0ZJTFRFUiA9IFN5bWJvbChgcmVzb2x2ZUZpbHRlcmAgKTsKICBjb25zdCBXSVRIX0RJUkVDVElWRVMgPSBTeW1ib2woYHdpdGhEaXJlY3RpdmVzYCApOwogIGNvbnN0IFJFTkRFUl9MSVNUID0gU3ltYm9sKGByZW5kZXJMaXN0YCApOwogIGNvbnN0IFJFTkRFUl9TTE9UID0gU3ltYm9sKGByZW5kZXJTbG90YCApOwogIGNvbnN0IENSRUFURV9TTE9UUyA9IFN5bWJvbChgY3JlYXRlU2xvdHNgICk7CiAgY29uc3QgVE9fRElTUExBWV9TVFJJTkcgPSBTeW1ib2woYHRvRGlzcGxheVN0cmluZ2AgKTsKICBjb25zdCBNRVJHRV9QUk9QUyA9IFN5bWJvbChgbWVyZ2VQcm9wc2AgKTsKICBjb25zdCBOT1JNQUxJWkVfQ0xBU1MgPSBTeW1ib2woYG5vcm1hbGl6ZUNsYXNzYCApOwogIGNvbnN0IE5PUk1BTElaRV9TVFlMRSA9IFN5bWJvbChgbm9ybWFsaXplU3R5bGVgICk7CiAgY29uc3QgTk9STUFMSVpFX1BST1BTID0gU3ltYm9sKGBub3JtYWxpemVQcm9wc2AgKTsKICBjb25zdCBHVUFSRF9SRUFDVElWRV9QUk9QUyA9IFN5bWJvbChgZ3VhcmRSZWFjdGl2ZVByb3BzYCApOwogIGNvbnN0IFRPX0hBTkRMRVJTID0gU3ltYm9sKGB0b0hhbmRsZXJzYCApOwogIGNvbnN0IENBTUVMSVpFID0gU3ltYm9sKGBjYW1lbGl6ZWAgKTsKICBjb25zdCBDQVBJVEFMSVpFID0gU3ltYm9sKGBjYXBpdGFsaXplYCApOwogIGNvbnN0IFRPX0hBTkRMRVJfS0VZID0gU3ltYm9sKGB0b0hhbmRsZXJLZXlgICk7CiAgY29uc3QgU0VUX0JMT0NLX1RSQUNLSU5HID0gU3ltYm9sKGBzZXRCbG9ja1RyYWNraW5nYCApOwogIGNvbnN0IFBVU0hfU0NPUEVfSUQgPSBTeW1ib2woYHB1c2hTY29wZUlkYCApOwogIGNvbnN0IFBPUF9TQ09QRV9JRCA9IFN5bWJvbChgcG9wU2NvcGVJZGAgKTsKICBjb25zdCBXSVRIX0NUWCA9IFN5bWJvbChgd2l0aEN0eGAgKTsKICBjb25zdCBVTlJFRiA9IFN5bWJvbChgdW5yZWZgICk7CiAgY29uc3QgSVNfUkVGID0gU3ltYm9sKGBpc1JlZmAgKTsKICBjb25zdCBXSVRIX01FTU8gPSBTeW1ib2woYHdpdGhNZW1vYCApOwogIGNvbnN0IElTX01FTU9fU0FNRSA9IFN5bWJvbChgaXNNZW1vU2FtZWAgKTsKICBjb25zdCBoZWxwZXJOYW1lTWFwID0gewogICAgW0ZSQUdNRU5UXTogYEZyYWdtZW50YCwKICAgIFtURUxFUE9SVF06IGBUZWxlcG9ydGAsCiAgICBbU1VTUEVOU0VdOiBgU3VzcGVuc2VgLAogICAgW0tFRVBfQUxJVkVdOiBgS2VlcEFsaXZlYCwKICAgIFtCQVNFX1RSQU5TSVRJT05dOiBgQmFzZVRyYW5zaXRpb25gLAogICAgW09QRU5fQkxPQ0tdOiBgb3BlbkJsb2NrYCwKICAgIFtDUkVBVEVfQkxPQ0tdOiBgY3JlYXRlQmxvY2tgLAogICAgW0NSRUFURV9FTEVNRU5UX0JMT0NLXTogYGNyZWF0ZUVsZW1lbnRCbG9ja2AsCiAgICBbQ1JFQVRFX1ZOT0RFXTogYGNyZWF0ZVZOb2RlYCwKICAgIFtDUkVBVEVfRUxFTUVOVF9WTk9ERV06IGBjcmVhdGVFbGVtZW50Vk5vZGVgLAogICAgW0NSRUFURV9DT01NRU5UXTogYGNyZWF0ZUNvbW1lbnRWTm9kZWAsCiAgICBbQ1JFQVRFX1RFWFRdOiBgY3JlYXRlVGV4dFZOb2RlYCwKICAgIFtDUkVBVEVfU1RBVElDXTogYGNyZWF0ZVN0YXRpY1ZOb2RlYCwKICAgIFtSRVNPTFZFX0NPTVBPTkVOVF06IGByZXNvbHZlQ29tcG9uZW50YCwKICAgIFtSRVNPTFZFX0RZTkFNSUNfQ09NUE9ORU5UXTogYHJlc29sdmVEeW5hbWljQ29tcG9uZW50YCwKICAgIFtSRVNPTFZFX0RJUkVDVElWRV06IGByZXNvbHZlRGlyZWN0aXZlYCwKICAgIFtSRVNPTFZFX0ZJTFRFUl06IGByZXNvbHZlRmlsdGVyYCwKICAgIFtXSVRIX0RJUkVDVElWRVNdOiBgd2l0aERpcmVjdGl2ZXNgLAogICAgW1JFTkRFUl9MSVNUXTogYHJlbmRlckxpc3RgLAogICAgW1JFTkRFUl9TTE9UXTogYHJlbmRlclNsb3RgLAogICAgW0NSRUFURV9TTE9UU106IGBjcmVhdGVTbG90c2AsCiAgICBbVE9fRElTUExBWV9TVFJJTkddOiBgdG9EaXNwbGF5U3RyaW5nYCwKICAgIFtNRVJHRV9QUk9QU106IGBtZXJnZVByb3BzYCwKICAgIFtOT1JNQUxJWkVfQ0xBU1NdOiBgbm9ybWFsaXplQ2xhc3NgLAogICAgW05PUk1BTElaRV9TVFlMRV06IGBub3JtYWxpemVTdHlsZWAsCiAgICBbTk9STUFMSVpFX1BST1BTXTogYG5vcm1hbGl6ZVByb3BzYCwKICAgIFtHVUFSRF9SRUFDVElWRV9QUk9QU106IGBndWFyZFJlYWN0aXZlUHJvcHNgLAogICAgW1RPX0hBTkRMRVJTXTogYHRvSGFuZGxlcnNgLAogICAgW0NBTUVMSVpFXTogYGNhbWVsaXplYCwKICAgIFtDQVBJVEFMSVpFXTogYGNhcGl0YWxpemVgLAogICAgW1RPX0hBTkRMRVJfS0VZXTogYHRvSGFuZGxlcktleWAsCiAgICBbU0VUX0JMT0NLX1RSQUNLSU5HXTogYHNldEJsb2NrVHJhY2tpbmdgLAogICAgW1BVU0hfU0NPUEVfSURdOiBgcHVzaFNjb3BlSWRgLAogICAgW1BPUF9TQ09QRV9JRF06IGBwb3BTY29wZUlkYCwKICAgIFtXSVRIX0NUWF06IGB3aXRoQ3R4YCwKICAgIFtVTlJFRl06IGB1bnJlZmAsCiAgICBbSVNfUkVGXTogYGlzUmVmYCwKICAgIFtXSVRIX01FTU9dOiBgd2l0aE1lbW9gLAogICAgW0lTX01FTU9fU0FNRV06IGBpc01lbW9TYW1lYAogIH07CiAgZnVuY3Rpb24gcmVnaXN0ZXJSdW50aW1lSGVscGVycyhoZWxwZXJzKSB7CiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGhlbHBlcnMpLmZvckVhY2goKHMpID0+IHsKICAgICAgaGVscGVyTmFtZU1hcFtzXSA9IGhlbHBlcnNbc107CiAgICB9KTsKICB9CgogIGNvbnN0IGxvY1N0dWIgPSB7CiAgICBzdGFydDogeyBsaW5lOiAxLCBjb2x1bW46IDEsIG9mZnNldDogMCB9LAogICAgZW5kOiB7IGxpbmU6IDEsIGNvbHVtbjogMSwgb2Zmc2V0OiAwIH0sCiAgICBzb3VyY2U6ICIiCiAgfTsKICBmdW5jdGlvbiBjcmVhdGVSb290KGNoaWxkcmVuLCBzb3VyY2UgPSAiIikgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogMCwKICAgICAgc291cmNlLAogICAgICBjaGlsZHJlbiwKICAgICAgaGVscGVyczogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgICAgY29tcG9uZW50czogW10sCiAgICAgIGRpcmVjdGl2ZXM6IFtdLAogICAgICBob2lzdHM6IFtdLAogICAgICBpbXBvcnRzOiBbXSwKICAgICAgY2FjaGVkOiAwLAogICAgICB0ZW1wczogMCwKICAgICAgY29kZWdlbk5vZGU6IHZvaWQgMCwKICAgICAgbG9jOiBsb2NTdHViCiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVWTm9kZUNhbGwoY29udGV4dCwgdGFnLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzLCBkaXJlY3RpdmVzLCBpc0Jsb2NrID0gZmFsc2UsIGRpc2FibGVUcmFja2luZyA9IGZhbHNlLCBpc0NvbXBvbmVudCA9IGZhbHNlLCBsb2MgPSBsb2NTdHViKSB7CiAgICBpZiAoY29udGV4dCkgewogICAgICBpZiAoaXNCbG9jaykgewogICAgICAgIGNvbnRleHQuaGVscGVyKE9QRU5fQkxPQ0spOwogICAgICAgIGNvbnRleHQuaGVscGVyKGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250ZXh0LmhlbHBlcihnZXRWTm9kZUhlbHBlcihjb250ZXh0LmluU1NSLCBpc0NvbXBvbmVudCkpOwogICAgICB9CiAgICAgIGlmIChkaXJlY3RpdmVzKSB7CiAgICAgICAgY29udGV4dC5oZWxwZXIoV0lUSF9ESVJFQ1RJVkVTKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgdHlwZTogMTMsCiAgICAgIHRhZywKICAgICAgcHJvcHMsCiAgICAgIGNoaWxkcmVuLAogICAgICBwYXRjaEZsYWcsCiAgICAgIGR5bmFtaWNQcm9wcywKICAgICAgZGlyZWN0aXZlcywKICAgICAgaXNCbG9jaywKICAgICAgZGlzYWJsZVRyYWNraW5nLAogICAgICBpc0NvbXBvbmVudCwKICAgICAgbG9jCiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVBcnJheUV4cHJlc3Npb24oZWxlbWVudHMsIGxvYyA9IGxvY1N0dWIpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDE3LAogICAgICBsb2MsCiAgICAgIGVsZW1lbnRzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVPYmplY3RFeHByZXNzaW9uKHByb3BlcnRpZXMsIGxvYyA9IGxvY1N0dWIpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDE1LAogICAgICBsb2MsCiAgICAgIHByb3BlcnRpZXMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZU9iamVjdFByb3BlcnR5KGtleSwgdmFsdWUpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDE2LAogICAgICBsb2M6IGxvY1N0dWIsCiAgICAgIGtleTogaXNTdHJpbmcoa2V5KSA/IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oa2V5LCB0cnVlKSA6IGtleSwKICAgICAgdmFsdWUKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oY29udGVudCwgaXNTdGF0aWMgPSBmYWxzZSwgbG9jID0gbG9jU3R1YiwgY29uc3RUeXBlID0gMCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogNCwKICAgICAgbG9jLAogICAgICBjb250ZW50LAogICAgICBpc1N0YXRpYywKICAgICAgY29uc3RUeXBlOiBpc1N0YXRpYyA/IDMgOiBjb25zdFR5cGUKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihjaGlsZHJlbiwgbG9jID0gbG9jU3R1YikgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogOCwKICAgICAgbG9jLAogICAgICBjaGlsZHJlbgogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY2FsbGVlLCBhcmdzID0gW10sIGxvYyA9IGxvY1N0dWIpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDE0LAogICAgICBsb2MsCiAgICAgIGNhbGxlZSwKICAgICAgYXJndW1lbnRzOiBhcmdzCiAgICB9OwogIH0KICBmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24ocGFyYW1zLCByZXR1cm5zID0gdm9pZCAwLCBuZXdsaW5lID0gZmFsc2UsIGlzU2xvdCA9IGZhbHNlLCBsb2MgPSBsb2NTdHViKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAxOCwKICAgICAgcGFyYW1zLAogICAgICByZXR1cm5zLAogICAgICBuZXdsaW5lLAogICAgICBpc1Nsb3QsCiAgICAgIGxvYwogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ29uZGl0aW9uYWxFeHByZXNzaW9uKHRlc3QsIGNvbnNlcXVlbnQsIGFsdGVybmF0ZSwgbmV3bGluZSA9IHRydWUpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDE5LAogICAgICB0ZXN0LAogICAgICBjb25zZXF1ZW50LAogICAgICBhbHRlcm5hdGUsCiAgICAgIG5ld2xpbmUsCiAgICAgIGxvYzogbG9jU3R1YgogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGVFeHByZXNzaW9uKGluZGV4LCB2YWx1ZSwgaXNWTm9kZSA9IGZhbHNlKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAyMCwKICAgICAgaW5kZXgsCiAgICAgIHZhbHVlLAogICAgICBpc1ZOb2RlLAogICAgICBsb2M6IGxvY1N0dWIKICAgIH07CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUJsb2NrU3RhdGVtZW50KGJvZHkpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IDIxLAogICAgICBib2R5LAogICAgICBsb2M6IGxvY1N0dWIKICAgIH07CiAgfQogIGZ1bmN0aW9uIGdldFZOb2RlSGVscGVyKHNzciwgaXNDb21wb25lbnQpIHsKICAgIHJldHVybiBzc3IgfHwgaXNDb21wb25lbnQgPyBDUkVBVEVfVk5PREUgOiBDUkVBVEVfRUxFTUVOVF9WTk9ERTsKICB9CiAgZnVuY3Rpb24gZ2V0Vk5vZGVCbG9ja0hlbHBlcihzc3IsIGlzQ29tcG9uZW50KSB7CiAgICByZXR1cm4gc3NyIHx8IGlzQ29tcG9uZW50ID8gQ1JFQVRFX0JMT0NLIDogQ1JFQVRFX0VMRU1FTlRfQkxPQ0s7CiAgfQogIGZ1bmN0aW9uIGNvbnZlcnRUb0Jsb2NrKG5vZGUsIHsgaGVscGVyLCByZW1vdmVIZWxwZXIsIGluU1NSIH0pIHsKICAgIGlmICghbm9kZS5pc0Jsb2NrKSB7CiAgICAgIG5vZGUuaXNCbG9jayA9IHRydWU7CiAgICAgIHJlbW92ZUhlbHBlcihnZXRWTm9kZUhlbHBlcihpblNTUiwgbm9kZS5pc0NvbXBvbmVudCkpOwogICAgICBoZWxwZXIoT1BFTl9CTE9DSyk7CiAgICAgIGhlbHBlcihnZXRWTm9kZUJsb2NrSGVscGVyKGluU1NSLCBub2RlLmlzQ29tcG9uZW50KSk7CiAgICB9CiAgfQoKICBjb25zdCBkZWZhdWx0RGVsaW1pdGVyc09wZW4gPSBuZXcgVWludDhBcnJheShbMTIzLCAxMjNdKTsKICBjb25zdCBkZWZhdWx0RGVsaW1pdGVyc0Nsb3NlID0gbmV3IFVpbnQ4QXJyYXkoWzEyNSwgMTI1XSk7CiAgZnVuY3Rpb24gaXNUYWdTdGFydENoYXIoYykgewogICAgcmV0dXJuIGMgPj0gOTcgJiYgYyA8PSAxMjIgfHwgYyA+PSA2NSAmJiBjIDw9IDkwOwogIH0KICBmdW5jdGlvbiBpc1doaXRlc3BhY2UoYykgewogICAgcmV0dXJuIGMgPT09IDMyIHx8IGMgPT09IDEwIHx8IGMgPT09IDkgfHwgYyA9PT0gMTIgfHwgYyA9PT0gMTM7CiAgfQogIGZ1bmN0aW9uIGlzRW5kT2ZUYWdTZWN0aW9uKGMpIHsKICAgIHJldHVybiBjID09PSA0NyB8fCBjID09PSA2MiB8fCBpc1doaXRlc3BhY2UoYyk7CiAgfQogIGZ1bmN0aW9uIHRvQ2hhckNvZGVzKHN0cikgewogICAgY29uc3QgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoc3RyLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICByZXRbaV0gPSBzdHIuY2hhckNvZGVBdChpKTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQogIGNvbnN0IFNlcXVlbmNlcyA9IHsKICAgIENkYXRhOiBuZXcgVWludDhBcnJheShbNjcsIDY4LCA2NSwgODQsIDY1LCA5MV0pLAogICAgLy8gQ0RBVEFbCiAgICBDZGF0YUVuZDogbmV3IFVpbnQ4QXJyYXkoWzkzLCA5MywgNjJdKSwKICAgIC8vIF1dPgogICAgQ29tbWVudEVuZDogbmV3IFVpbnQ4QXJyYXkoWzQ1LCA0NSwgNjJdKSwKICAgIC8vIGAtLT5gCiAgICBTY3JpcHRFbmQ6IG5ldyBVaW50OEFycmF5KFs2MCwgNDcsIDExNSwgOTksIDExNCwgMTA1LCAxMTIsIDExNl0pLAogICAgLy8gYDxcL3NjcmlwdGAKICAgIFN0eWxlRW5kOiBuZXcgVWludDhBcnJheShbNjAsIDQ3LCAxMTUsIDExNiwgMTIxLCAxMDgsIDEwMV0pLAogICAgLy8gYDwvc3R5bGVgCiAgICBUaXRsZUVuZDogbmV3IFVpbnQ4QXJyYXkoWzYwLCA0NywgMTE2LCAxMDUsIDExNiwgMTA4LCAxMDFdKSwKICAgIC8vIGA8L3RpdGxlYAogICAgVGV4dGFyZWFFbmQ6IG5ldyBVaW50OEFycmF5KFsKICAgICAgNjAsCiAgICAgIDQ3LAogICAgICAxMTYsCiAgICAgIDEwMSwKICAgICAgMTIwLAogICAgICAxMTYsCiAgICAgIDk3LAogICAgICAxMTQsCiAgICAgIDEwMSwKICAgICAgOTcKICAgIF0pCiAgICAvLyBgPC90ZXh0YXJlYQogIH07CiAgY2xhc3MgVG9rZW5pemVyIHsKICAgIGNvbnN0cnVjdG9yKHN0YWNrLCBjYnMpIHsKICAgICAgdGhpcy5zdGFjayA9IHN0YWNrOwogICAgICB0aGlzLmNicyA9IGNiczsKICAgICAgLyoqIFRoZSBjdXJyZW50IHN0YXRlIHRoZSB0b2tlbml6ZXIgaXMgaW4uICovCiAgICAgIHRoaXMuc3RhdGUgPSAxOwogICAgICAvKiogVGhlIHJlYWQgYnVmZmVyLiAqLwogICAgICB0aGlzLmJ1ZmZlciA9ICIiOwogICAgICAvKiogVGhlIGJlZ2lubmluZyBvZiB0aGUgc2VjdGlvbiB0aGF0IGlzIGN1cnJlbnRseSBiZWluZyByZWFkLiAqLwogICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IDA7CiAgICAgIC8qKiBUaGUgaW5kZXggd2l0aGluIHRoZSBidWZmZXIgdGhhdCB3ZSBhcmUgY3VycmVudGx5IGxvb2tpbmcgYXQuICovCiAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAvKiogVGhlIHN0YXJ0IG9mIHRoZSBsYXN0IGVudGl0eS4gKi8KICAgICAgdGhpcy5lbnRpdHlTdGFydCA9IDA7CiAgICAgIC8qKiBTb21lIGJlaGF2aW9yLCBlZy4gd2hlbiBkZWNvZGluZyBlbnRpdGllcywgaXMgZG9uZSB3aGlsZSB3ZSBhcmUgaW4gYW5vdGhlciBzdGF0ZS4gVGhpcyBrZWVwcyB0cmFjayBvZiB0aGUgb3RoZXIgc3RhdGUgdHlwZS4gKi8KICAgICAgdGhpcy5iYXNlU3RhdGUgPSAxOwogICAgICAvKiogRm9yIHNwZWNpYWwgcGFyc2luZyBiZWhhdmlvciBpbnNpZGUgb2Ygc2NyaXB0IGFuZCBzdHlsZSB0YWdzLiAqLwogICAgICB0aGlzLmluUkNEQVRBID0gZmFsc2U7CiAgICAgIC8qKiBGb3IgZGlzYWJsaW5nIFJDREFUQSB0YWdzIGhhbmRsaW5nICovCiAgICAgIHRoaXMuaW5YTUwgPSBmYWxzZTsKICAgICAgLyoqIEZvciBkaXNhYmxpbmcgaW50ZXJwb2xhdGlvbiBwYXJzaW5nIGluIHYtcHJlICovCiAgICAgIHRoaXMuaW5WUHJlID0gZmFsc2U7CiAgICAgIC8qKiBSZWNvcmQgbmV3bGluZSBwb3NpdGlvbnMgZm9yIGZhc3QgbGluZSAvIGNvbHVtbiBjYWxjdWxhdGlvbiAqLwogICAgICB0aGlzLm5ld2xpbmVzID0gW107CiAgICAgIHRoaXMubW9kZSA9IDA7CiAgICAgIHRoaXMuZGVsaW1pdGVyT3BlbiA9IGRlZmF1bHREZWxpbWl0ZXJzT3BlbjsKICAgICAgdGhpcy5kZWxpbWl0ZXJDbG9zZSA9IGRlZmF1bHREZWxpbWl0ZXJzQ2xvc2U7CiAgICAgIHRoaXMuZGVsaW1pdGVySW5kZXggPSAtMTsKICAgICAgdGhpcy5jdXJyZW50U2VxdWVuY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDA7CiAgICB9CiAgICBnZXQgaW5TRkNSb290KCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlID09PSAyICYmIHRoaXMuc3RhY2subGVuZ3RoID09PSAwOwogICAgfQogICAgcmVzZXQoKSB7CiAgICAgIHRoaXMuc3RhdGUgPSAxOwogICAgICB0aGlzLm1vZGUgPSAwOwogICAgICB0aGlzLmJ1ZmZlciA9ICIiOwogICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IDA7CiAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICB0aGlzLmJhc2VTdGF0ZSA9IDE7CiAgICAgIHRoaXMuaW5SQ0RBVEEgPSBmYWxzZTsKICAgICAgdGhpcy5jdXJyZW50U2VxdWVuY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMubmV3bGluZXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5kZWxpbWl0ZXJPcGVuID0gZGVmYXVsdERlbGltaXRlcnNPcGVuOwogICAgICB0aGlzLmRlbGltaXRlckNsb3NlID0gZGVmYXVsdERlbGltaXRlcnNDbG9zZTsKICAgIH0KICAgIC8qKgogICAgICogR2VuZXJhdGUgUG9zaXRpb24gb2JqZWN0IHdpdGggbGluZSAvIGNvbHVtbiBpbmZvcm1hdGlvbiB1c2luZyByZWNvcmRlZAogICAgICogbmV3bGluZSBwb3NpdGlvbnMuIFdlIGtub3cgdGhlIGluZGV4IGlzIGFsd2F5cyBnb2luZyB0byBiZSBhbiBhbHJlYWR5CiAgICAgKiBwcm9jZXNzZWQgaW5kZXgsIHNvIGFsbCB0aGUgbmV3bGluZXMgdXAgdG8gdGhpcyBpbmRleCBzaG91bGQgaGF2ZSBiZWVuCiAgICAgKiByZWNvcmRlZC4KICAgICAqLwogICAgZ2V0UG9zKGluZGV4KSB7CiAgICAgIGxldCBsaW5lID0gMTsKICAgICAgbGV0IGNvbHVtbiA9IGluZGV4ICsgMTsKICAgICAgZm9yIChsZXQgaSA9IHRoaXMubmV3bGluZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBjb25zdCBuZXdsaW5lSW5kZXggPSB0aGlzLm5ld2xpbmVzW2ldOwogICAgICAgIGlmIChpbmRleCA+IG5ld2xpbmVJbmRleCkgewogICAgICAgICAgbGluZSA9IGkgKyAyOwogICAgICAgICAgY29sdW1uID0gaW5kZXggLSBuZXdsaW5lSW5kZXg7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb2x1bW4sCiAgICAgICAgbGluZSwKICAgICAgICBvZmZzZXQ6IGluZGV4CiAgICAgIH07CiAgICB9CiAgICBwZWVrKCkgewogICAgICByZXR1cm4gdGhpcy5idWZmZXIuY2hhckNvZGVBdCh0aGlzLmluZGV4ICsgMSk7CiAgICB9CiAgICBzdGF0ZVRleHQoYykgewogICAgICBpZiAoYyA9PT0gNjApIHsKICAgICAgICBpZiAodGhpcy5pbmRleCA+IHRoaXMuc2VjdGlvblN0YXJ0KSB7CiAgICAgICAgICB0aGlzLmNicy5vbnRleHQodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0YXRlID0gNTsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuaW5WUHJlICYmIGMgPT09IHRoaXMuZGVsaW1pdGVyT3BlblswXSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAyOwogICAgICAgIHRoaXMuZGVsaW1pdGVySW5kZXggPSAwOwogICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uT3BlbihjKTsKICAgICAgfQogICAgfQogICAgc3RhdGVJbnRlcnBvbGF0aW9uT3BlbihjKSB7CiAgICAgIGlmIChjID09PSB0aGlzLmRlbGltaXRlck9wZW5bdGhpcy5kZWxpbWl0ZXJJbmRleF0pIHsKICAgICAgICBpZiAodGhpcy5kZWxpbWl0ZXJJbmRleCA9PT0gdGhpcy5kZWxpbWl0ZXJPcGVuLmxlbmd0aCAtIDEpIHsKICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gdGhpcy5pbmRleCArIDEgLSB0aGlzLmRlbGltaXRlck9wZW4ubGVuZ3RoOwogICAgICAgICAgaWYgKHN0YXJ0ID4gdGhpcy5zZWN0aW9uU3RhcnQpIHsKICAgICAgICAgICAgdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LCBzdGFydCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnN0YXRlID0gMzsKICAgICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gc3RhcnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuZGVsaW1pdGVySW5kZXgrKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodGhpcy5pblJDREFUQSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAzMjsKICAgICAgICB0aGlzLnN0YXRlSW5SQ0RBVEEoYyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgdGhpcy5zdGF0ZVRleHQoYyk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW50ZXJwb2xhdGlvbihjKSB7CiAgICAgIGlmIChjID09PSB0aGlzLmRlbGltaXRlckNsb3NlWzBdKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDQ7CiAgICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCA9IDA7CiAgICAgICAgdGhpcy5zdGF0ZUludGVycG9sYXRpb25DbG9zZShjKTsKICAgICAgfQogICAgfQogICAgc3RhdGVJbnRlcnBvbGF0aW9uQ2xvc2UoYykgewogICAgICBpZiAoYyA9PT0gdGhpcy5kZWxpbWl0ZXJDbG9zZVt0aGlzLmRlbGltaXRlckluZGV4XSkgewogICAgICAgIGlmICh0aGlzLmRlbGltaXRlckluZGV4ID09PSB0aGlzLmRlbGltaXRlckNsb3NlLmxlbmd0aCAtIDEpIHsKICAgICAgICAgIHRoaXMuY2JzLm9uaW50ZXJwb2xhdGlvbih0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCArIDEpOwogICAgICAgICAgaWYgKHRoaXMuaW5SQ0RBVEEpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IDMyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmRlbGltaXRlckluZGV4Kys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSAzOwogICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uKGMpOwogICAgICB9CiAgICB9CiAgICBzdGF0ZVNwZWNpYWxTdGFydFNlcXVlbmNlKGMpIHsKICAgICAgY29uc3QgaXNFbmQgPSB0aGlzLnNlcXVlbmNlSW5kZXggPT09IHRoaXMuY3VycmVudFNlcXVlbmNlLmxlbmd0aDsKICAgICAgY29uc3QgaXNNYXRjaCA9IGlzRW5kID8gKAogICAgICAgIC8vIElmIHdlIGFyZSBhdCB0aGUgZW5kIG9mIHRoZSBzZXF1ZW5jZSwgbWFrZSBzdXJlIHRoZSB0YWcgbmFtZSBoYXMgZW5kZWQKICAgICAgICBpc0VuZE9mVGFnU2VjdGlvbihjKQogICAgICApIDogKAogICAgICAgIC8vIE90aGVyd2lzZSwgZG8gYSBjYXNlLWluc2Vuc2l0aXZlIGNvbXBhcmlzb24KICAgICAgICAoYyB8IDMyKSA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2VbdGhpcy5zZXF1ZW5jZUluZGV4XQogICAgICApOwogICAgICBpZiAoIWlzTWF0Y2gpIHsKICAgICAgICB0aGlzLmluUkNEQVRBID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoIWlzRW5kKSB7CiAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4Kys7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDA7CiAgICAgIHRoaXMuc3RhdGUgPSA2OwogICAgICB0aGlzLnN0YXRlSW5UYWdOYW1lKGMpOwogICAgfQogICAgLyoqIExvb2sgZm9yIGFuIGVuZCB0YWcuIEZvciA8dGl0bGU+IGFuZCA8dGV4dGFyZWE+LCBhbHNvIGRlY29kZSBlbnRpdGllcy4gKi8KICAgIHN0YXRlSW5SQ0RBVEEoYykgewogICAgICBpZiAodGhpcy5zZXF1ZW5jZUluZGV4ID09PSB0aGlzLmN1cnJlbnRTZXF1ZW5jZS5sZW5ndGgpIHsKICAgICAgICBpZiAoYyA9PT0gNjIgfHwgaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgICBjb25zdCBlbmRPZlRleHQgPSB0aGlzLmluZGV4IC0gdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoOwogICAgICAgICAgaWYgKHRoaXMuc2VjdGlvblN0YXJ0IDwgZW5kT2ZUZXh0KSB7CiAgICAgICAgICAgIGNvbnN0IGFjdHVhbEluZGV4ID0gdGhpcy5pbmRleDsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IGVuZE9mVGV4dDsKICAgICAgICAgICAgdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LCBlbmRPZlRleHQpOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gYWN0dWFsSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IGVuZE9mVGV4dCArIDI7CiAgICAgICAgICB0aGlzLnN0YXRlSW5DbG9zaW5nVGFnTmFtZShjKTsKICAgICAgICAgIHRoaXMuaW5SQ0RBVEEgPSBmYWxzZTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4ID0gMDsKICAgICAgfQogICAgICBpZiAoKGMgfCAzMikgPT09IHRoaXMuY3VycmVudFNlcXVlbmNlW3RoaXMuc2VxdWVuY2VJbmRleF0pIHsKICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggKz0gMTsKICAgICAgfSBlbHNlIGlmICh0aGlzLnNlcXVlbmNlSW5kZXggPT09IDApIHsKICAgICAgICBpZiAodGhpcy5jdXJyZW50U2VxdWVuY2UgPT09IFNlcXVlbmNlcy5UaXRsZUVuZCB8fCB0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9PT0gU2VxdWVuY2VzLlRleHRhcmVhRW5kICYmICF0aGlzLmluU0ZDUm9vdCkgewogICAgICAgICAgaWYgKGMgPT09IHRoaXMuZGVsaW1pdGVyT3BlblswXSkgewogICAgICAgICAgICB0aGlzLnN0YXRlID0gMjsKICAgICAgICAgICAgdGhpcy5kZWxpbWl0ZXJJbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uT3BlbihjKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZmFzdEZvcndhcmRUbyg2MCkpIHsKICAgICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDE7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IE51bWJlcihjID09PSA2MCk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlQ0RBVEFTZXF1ZW5jZShjKSB7CiAgICAgIGlmIChjID09PSBTZXF1ZW5jZXMuQ2RhdGFbdGhpcy5zZXF1ZW5jZUluZGV4XSkgewogICAgICAgIGlmICgrK3RoaXMuc2VxdWVuY2VJbmRleCA9PT0gU2VxdWVuY2VzLkNkYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5zdGF0ZSA9IDI4OwogICAgICAgICAgdGhpcy5jdXJyZW50U2VxdWVuY2UgPSBTZXF1ZW5jZXMuQ2RhdGFFbmQ7CiAgICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOwogICAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXF1ZW5jZUluZGV4ID0gMDsKICAgICAgICB0aGlzLnN0YXRlID0gMjM7CiAgICAgICAgdGhpcy5zdGF0ZUluRGVjbGFyYXRpb24oYyk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogV2hlbiB3ZSB3YWl0IGZvciBvbmUgc3BlY2lmaWMgY2hhcmFjdGVyLCB3ZSBjYW4gc3BlZWQgdGhpbmdzIHVwCiAgICAgKiBieSBza2lwcGluZyB0aHJvdWdoIHRoZSBidWZmZXIgdW50aWwgd2UgZmluZCBpdC4KICAgICAqCiAgICAgKiBAcmV0dXJucyBXaGV0aGVyIHRoZSBjaGFyYWN0ZXIgd2FzIGZvdW5kLgogICAgICovCiAgICBmYXN0Rm9yd2FyZFRvKGMpIHsKICAgICAgd2hpbGUgKCsrdGhpcy5pbmRleCA8IHRoaXMuYnVmZmVyLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNjID0gdGhpcy5idWZmZXIuY2hhckNvZGVBdCh0aGlzLmluZGV4KTsKICAgICAgICBpZiAoY2MgPT09IDEwKSB7CiAgICAgICAgICB0aGlzLm5ld2xpbmVzLnB1c2godGhpcy5pbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmIChjYyA9PT0gYykgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuaW5kZXggPSB0aGlzLmJ1ZmZlci5sZW5ndGggLSAxOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIENvbW1lbnRzIGFuZCBDREFUQSBlbmQgd2l0aCBgLS0+YCBhbmQgYF1dPmAuCiAgICAgKgogICAgICogVGhlaXIgY29tbW9uIHF1YWxpdGllcyBhcmU6CiAgICAgKiAtIFRoZWlyIGVuZCBzZXF1ZW5jZXMgaGF2ZSBhIGRpc3RpbmN0IGNoYXJhY3RlciB0aGV5IHN0YXJ0IHdpdGguCiAgICAgKiAtIFRoYXQgY2hhcmFjdGVyIGlzIHRoZW4gcmVwZWF0ZWQsIHNvIHdlIGhhdmUgdG8gY2hlY2sgbXVsdGlwbGUgcmVwZWF0cy4KICAgICAqIC0gQWxsIGNoYXJhY3RlcnMgYnV0IHRoZSBzdGFydCBjaGFyYWN0ZXIgb2YgdGhlIHNlcXVlbmNlIGNhbiBiZSBza2lwcGVkLgogICAgICovCiAgICBzdGF0ZUluQ29tbWVudExpa2UoYykgewogICAgICBpZiAoYyA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2VbdGhpcy5zZXF1ZW5jZUluZGV4XSkgewogICAgICAgIGlmICgrK3RoaXMuc2VxdWVuY2VJbmRleCA9PT0gdGhpcy5jdXJyZW50U2VxdWVuY2UubGVuZ3RoKSB7CiAgICAgICAgICBpZiAodGhpcy5jdXJyZW50U2VxdWVuY2UgPT09IFNlcXVlbmNlcy5DZGF0YUVuZCkgewogICAgICAgICAgICB0aGlzLmNicy5vbmNkYXRhKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4IC0gMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNicy5vbmNvbW1lbnQodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXggLSAyKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDA7CiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHRoaXMuc2VxdWVuY2VJbmRleCA9PT0gMCkgewogICAgICAgIGlmICh0aGlzLmZhc3RGb3J3YXJkVG8odGhpcy5jdXJyZW50U2VxdWVuY2VbMF0pKSB7CiAgICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAxOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjICE9PSB0aGlzLmN1cnJlbnRTZXF1ZW5jZVt0aGlzLnNlcXVlbmNlSW5kZXggLSAxXSkgewogICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDA7CiAgICAgIH0KICAgIH0KICAgIHN0YXJ0U3BlY2lhbChzZXF1ZW5jZSwgb2Zmc2V0KSB7CiAgICAgIHRoaXMuZW50ZXJSQ0RBVEEoc2VxdWVuY2UsIG9mZnNldCk7CiAgICAgIHRoaXMuc3RhdGUgPSAzMTsKICAgIH0KICAgIGVudGVyUkNEQVRBKHNlcXVlbmNlLCBvZmZzZXQpIHsKICAgICAgdGhpcy5pblJDREFUQSA9IHRydWU7CiAgICAgIHRoaXMuY3VycmVudFNlcXVlbmNlID0gc2VxdWVuY2U7CiAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IG9mZnNldDsKICAgIH0KICAgIHN0YXRlQmVmb3JlVGFnTmFtZShjKSB7CiAgICAgIGlmIChjID09PSAzMykgewogICAgICAgIHRoaXMuc3RhdGUgPSAyMjsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9IGVsc2UgaWYgKGMgPT09IDYzKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDI0OwogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7CiAgICAgIH0gZWxzZSBpZiAoaXNUYWdTdGFydENoYXIoYykpIHsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgICAgaWYgKHRoaXMubW9kZSA9PT0gMCkgewogICAgICAgICAgdGhpcy5zdGF0ZSA9IDY7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmluU0ZDUm9vdCkgewogICAgICAgICAgdGhpcy5zdGF0ZSA9IDM0OwogICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuaW5YTUwpIHsKICAgICAgICAgIGlmIChjID09PSAxMTYpIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IDMwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IGMgPT09IDExNSA/IDI5IDogNjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5zdGF0ZSA9IDY7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ3KSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgdGhpcy5zdGF0ZVRleHQoYyk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5UYWdOYW1lKGMpIHsKICAgICAgaWYgKGlzRW5kT2ZUYWdTZWN0aW9uKGMpKSB7CiAgICAgICAgdGhpcy5oYW5kbGVUYWdOYW1lKGMpOwogICAgICB9CiAgICB9CiAgICBzdGF0ZUluU0ZDUm9vdFRhZ05hbWUoYykgewogICAgICBpZiAoaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsKICAgICAgICBjb25zdCB0YWcgPSB0aGlzLmJ1ZmZlci5zbGljZSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgaWYgKHRhZyAhPT0gInRlbXBsYXRlIikgewogICAgICAgICAgdGhpcy5lbnRlclJDREFUQSh0b0NoYXJDb2RlcyhgPC9gICsgdGFnKSwgMCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGFuZGxlVGFnTmFtZShjKTsKICAgICAgfQogICAgfQogICAgaGFuZGxlVGFnTmFtZShjKSB7CiAgICAgIHRoaXMuY2JzLm9ub3BlbnRhZ25hbWUodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IC0xOwogICAgICB0aGlzLnN0YXRlID0gMTE7CiAgICAgIHRoaXMuc3RhdGVCZWZvcmVBdHRyTmFtZShjKTsKICAgIH0KICAgIHN0YXRlQmVmb3JlQ2xvc2luZ1RhZ05hbWUoYykgewogICAgICBpZiAoaXNXaGl0ZXNwYWNlKGMpKSA7IGVsc2UgaWYgKGMgPT09IDYyKSB7CiAgICAgICAgewogICAgICAgICAgdGhpcy5jYnMub25lcnIoMTQsIHRoaXMuaW5kZXgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0YXRlID0gMTsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSBpc1RhZ1N0YXJ0Q2hhcihjKSA/IDkgOiAyNzsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5DbG9zaW5nVGFnTmFtZShjKSB7CiAgICAgIGlmIChjID09PSA2MiB8fCBpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICB0aGlzLmNicy5vbmNsb3NldGFnKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IC0xOwogICAgICAgIHRoaXMuc3RhdGUgPSAxMDsKICAgICAgICB0aGlzLnN0YXRlQWZ0ZXJDbG9zaW5nVGFnTmFtZShjKTsKICAgICAgfQogICAgfQogICAgc3RhdGVBZnRlckNsb3NpbmdUYWdOYW1lKGMpIHsKICAgICAgaWYgKGMgPT09IDYyKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfQogICAgfQogICAgc3RhdGVCZWZvcmVBdHRyTmFtZShjKSB7CiAgICAgIGlmIChjID09PSA2MikgewogICAgICAgIHRoaXMuY2JzLm9ub3BlbnRhZ2VuZCh0aGlzLmluZGV4KTsKICAgICAgICBpZiAodGhpcy5pblJDREFUQSkgewogICAgICAgICAgdGhpcy5zdGF0ZSA9IDMyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnN0YXRlID0gMTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfSBlbHNlIGlmIChjID09PSA0NykgewogICAgICAgIHRoaXMuc3RhdGUgPSA3OwogICAgICAgIGlmICh0aGlzLnBlZWsoKSAhPT0gNjIpIHsKICAgICAgICAgIHRoaXMuY2JzLm9uZXJyKDIyLCB0aGlzLmluZGV4KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNjAgJiYgdGhpcy5wZWVrKCkgPT09IDQ3KSB7CiAgICAgICAgdGhpcy5jYnMub25vcGVudGFnZW5kKHRoaXMuaW5kZXgpOwogICAgICAgIHRoaXMuc3RhdGUgPSA1OwogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleDsKICAgICAgfSBlbHNlIGlmICghaXNXaGl0ZXNwYWNlKGMpKSB7CiAgICAgICAgaWYgKGMgPT09IDYxKSB7CiAgICAgICAgICB0aGlzLmNicy5vbmVycigKICAgICAgICAgICAgMTksCiAgICAgICAgICAgIHRoaXMuaW5kZXgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGFuZGxlQXR0clN0YXJ0KGMpOwogICAgICB9CiAgICB9CiAgICBoYW5kbGVBdHRyU3RhcnQoYykgewogICAgICBpZiAoYyA9PT0gMTE4ICYmIHRoaXMucGVlaygpID09PSA0NSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAxMzsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNDYgfHwgYyA9PT0gNTggfHwgYyA9PT0gNjQgfHwgYyA9PT0gMzUpIHsKICAgICAgICB0aGlzLmNicy5vbmRpcm5hbWUodGhpcy5pbmRleCwgdGhpcy5pbmRleCArIDEpOwogICAgICAgIHRoaXMuc3RhdGUgPSAxNDsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSAxMjsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5TZWxmQ2xvc2luZ1RhZyhjKSB7CiAgICAgIGlmIChjID09PSA2MikgewogICAgICAgIHRoaXMuY2JzLm9uc2VsZmNsb3Npbmd0YWcodGhpcy5pbmRleCk7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgICB0aGlzLmluUkNEQVRBID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoIWlzV2hpdGVzcGFjZShjKSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAxMTsKICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoYyk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5BdHRyTmFtZShjKSB7CiAgICAgIGlmIChjID09PSA2MSB8fCBpc0VuZE9mVGFnU2VjdGlvbihjKSkgewogICAgICAgIHRoaXMuY2JzLm9uYXR0cmlibmFtZSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsKICAgICAgfSBlbHNlIGlmIChjID09PSAzNCB8fCBjID09PSAzOSB8fCBjID09PSA2MCkgewogICAgICAgIHRoaXMuY2JzLm9uZXJyKAogICAgICAgICAgMTcsCiAgICAgICAgICB0aGlzLmluZGV4CiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgc3RhdGVJbkRpck5hbWUoYykgewogICAgICBpZiAoYyA9PT0gNjEgfHwgaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsKICAgICAgICB0aGlzLmNicy5vbmRpcm5hbWUodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgIHRoaXMuaGFuZGxlQXR0ck5hbWVFbmQoYyk7CiAgICAgIH0gZWxzZSBpZiAoYyA9PT0gNTgpIHsKICAgICAgICB0aGlzLmNicy5vbmRpcm5hbWUodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgIHRoaXMuc3RhdGUgPSAxNDsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ2KSB7CiAgICAgICAgdGhpcy5jYnMub25kaXJuYW1lKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLnN0YXRlID0gMTY7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfQogICAgfQogICAgc3RhdGVJbkRpckFyZyhjKSB7CiAgICAgIGlmIChjID09PSA2MSB8fCBpc0VuZE9mVGFnU2VjdGlvbihjKSkgewogICAgICAgIHRoaXMuY2JzLm9uZGlyYXJnKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLmhhbmRsZUF0dHJOYW1lRW5kKGMpOwogICAgICB9IGVsc2UgaWYgKGMgPT09IDkxKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE1OwogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ2KSB7CiAgICAgICAgdGhpcy5jYnMub25kaXJhcmcodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgIHRoaXMuc3RhdGUgPSAxNjsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9CiAgICB9CiAgICBzdGF0ZUluRHluYW1pY0RpckFyZyhjKSB7CiAgICAgIGlmIChjID09PSA5MykgewogICAgICAgIHRoaXMuc3RhdGUgPSAxNDsKICAgICAgfSBlbHNlIGlmIChjID09PSA2MSB8fCBpc0VuZE9mVGFnU2VjdGlvbihjKSkgewogICAgICAgIHRoaXMuY2JzLm9uZGlyYXJnKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4ICsgMSk7CiAgICAgICAgdGhpcy5oYW5kbGVBdHRyTmFtZUVuZChjKTsKICAgICAgICB7CiAgICAgICAgICB0aGlzLmNicy5vbmVycigKICAgICAgICAgICAgMjcsCiAgICAgICAgICAgIHRoaXMuaW5kZXgKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBzdGF0ZUluRGlyTW9kaWZpZXIoYykgewogICAgICBpZiAoYyA9PT0gNjEgfHwgaXNFbmRPZlRhZ1NlY3Rpb24oYykpIHsKICAgICAgICB0aGlzLmNicy5vbmRpcm1vZGlmaWVyKHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLmhhbmRsZUF0dHJOYW1lRW5kKGMpOwogICAgICB9IGVsc2UgaWYgKGMgPT09IDQ2KSB7CiAgICAgICAgdGhpcy5jYnMub25kaXJtb2RpZmllcih0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfQogICAgfQogICAgaGFuZGxlQXR0ck5hbWVFbmQoYykgewogICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIHRoaXMuc3RhdGUgPSAxNzsKICAgICAgdGhpcy5jYnMub25hdHRyaWJuYW1lZW5kKHRoaXMuaW5kZXgpOwogICAgICB0aGlzLnN0YXRlQWZ0ZXJBdHRyTmFtZShjKTsKICAgIH0KICAgIHN0YXRlQWZ0ZXJBdHRyTmFtZShjKSB7CiAgICAgIGlmIChjID09PSA2MSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAxODsKICAgICAgfSBlbHNlIGlmIChjID09PSA0NyB8fCBjID09PSA2MikgewogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZW5kKDAsIHRoaXMuc2VjdGlvblN0YXJ0KTsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IC0xOwogICAgICAgIHRoaXMuc3RhdGUgPSAxMTsKICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoYyk7CiAgICAgIH0gZWxzZSBpZiAoIWlzV2hpdGVzcGFjZShjKSkgewogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZW5kKDAsIHRoaXMuc2VjdGlvblN0YXJ0KTsKICAgICAgICB0aGlzLmhhbmRsZUF0dHJTdGFydChjKTsKICAgICAgfQogICAgfQogICAgc3RhdGVCZWZvcmVBdHRyVmFsdWUoYykgewogICAgICBpZiAoYyA9PT0gMzQpIHsKICAgICAgICB0aGlzLnN0YXRlID0gMTk7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfSBlbHNlIGlmIChjID09PSAzOSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAyMDsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9IGVsc2UgaWYgKCFpc1doaXRlc3BhY2UoYykpIHsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDIxOwogICAgICAgIHRoaXMuc3RhdGVJbkF0dHJWYWx1ZU5vUXVvdGVzKGMpOwogICAgICB9CiAgICB9CiAgICBoYW5kbGVJbkF0dHJWYWx1ZShjLCBxdW90ZSkgewogICAgICBpZiAoYyA9PT0gcXVvdGUgfHwgdGhpcy5mYXN0Rm9yd2FyZFRvKHF1b3RlKSkgewogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZGF0YSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSAtMTsKICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmVuZCgKICAgICAgICAgIHF1b3RlID09PSAzNCA/IDMgOiAyLAogICAgICAgICAgdGhpcy5pbmRleCArIDEKICAgICAgICApOwogICAgICAgIHRoaXMuc3RhdGUgPSAxMTsKICAgICAgfQogICAgfQogICAgc3RhdGVJbkF0dHJWYWx1ZURvdWJsZVF1b3RlcyhjKSB7CiAgICAgIHRoaXMuaGFuZGxlSW5BdHRyVmFsdWUoYywgMzQpOwogICAgfQogICAgc3RhdGVJbkF0dHJWYWx1ZVNpbmdsZVF1b3RlcyhjKSB7CiAgICAgIHRoaXMuaGFuZGxlSW5BdHRyVmFsdWUoYywgMzkpOwogICAgfQogICAgc3RhdGVJbkF0dHJWYWx1ZU5vUXVvdGVzKGMpIHsKICAgICAgaWYgKGlzV2hpdGVzcGFjZShjKSB8fCBjID09PSA2MikgewogICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZGF0YSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSAtMTsKICAgICAgICB0aGlzLmNicy5vbmF0dHJpYmVuZCgxLCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLnN0YXRlID0gMTE7CiAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZUF0dHJOYW1lKGMpOwogICAgICB9IGVsc2UgaWYgKGMgPT09IDM0IHx8IGMgPT09IDM5IHx8IGMgPT09IDYwIHx8IGMgPT09IDYxIHx8IGMgPT09IDk2KSB7CiAgICAgICAgdGhpcy5jYnMub25lcnIoCiAgICAgICAgICAxOCwKICAgICAgICAgIHRoaXMuaW5kZXgKICAgICAgICApOwogICAgICB9IGVsc2UgOwogICAgfQogICAgc3RhdGVCZWZvcmVEZWNsYXJhdGlvbihjKSB7CiAgICAgIGlmIChjID09PSA5MSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAyNjsKICAgICAgICB0aGlzLnNlcXVlbmNlSW5kZXggPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSBjID09PSA0NSA/IDI1IDogMjM7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5EZWNsYXJhdGlvbihjKSB7CiAgICAgIGlmIChjID09PSA2MiB8fCB0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IDE7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfQogICAgfQogICAgc3RhdGVJblByb2Nlc3NpbmdJbnN0cnVjdGlvbihjKSB7CiAgICAgIGlmIChjID09PSA2MiB8fCB0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSB7CiAgICAgICAgdGhpcy5jYnMub25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24odGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgIHRoaXMuc3RhdGUgPSAxOwogICAgICAgIHRoaXMuc2VjdGlvblN0YXJ0ID0gdGhpcy5pbmRleCArIDE7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlQmVmb3JlQ29tbWVudChjKSB7CiAgICAgIGlmIChjID09PSA0NSkgewogICAgICAgIHRoaXMuc3RhdGUgPSAyODsKICAgICAgICB0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9IFNlcXVlbmNlcy5Db21tZW50RW5kOwogICAgICAgIHRoaXMuc2VxdWVuY2VJbmRleCA9IDI7CiAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4ICsgMTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnN0YXRlID0gMjM7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlSW5TcGVjaWFsQ29tbWVudChjKSB7CiAgICAgIGlmIChjID09PSA2MiB8fCB0aGlzLmZhc3RGb3J3YXJkVG8oNjIpKSB7CiAgICAgICAgdGhpcy5jYnMub25jb21tZW50KHRoaXMuc2VjdGlvblN0YXJ0LCB0aGlzLmluZGV4KTsKICAgICAgICB0aGlzLnN0YXRlID0gMTsKICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXggKyAxOwogICAgICB9CiAgICB9CiAgICBzdGF0ZUJlZm9yZVNwZWNpYWxTKGMpIHsKICAgICAgaWYgKGMgPT09IFNlcXVlbmNlcy5TY3JpcHRFbmRbM10pIHsKICAgICAgICB0aGlzLnN0YXJ0U3BlY2lhbChTZXF1ZW5jZXMuU2NyaXB0RW5kLCA0KTsKICAgICAgfSBlbHNlIGlmIChjID09PSBTZXF1ZW5jZXMuU3R5bGVFbmRbM10pIHsKICAgICAgICB0aGlzLnN0YXJ0U3BlY2lhbChTZXF1ZW5jZXMuU3R5bGVFbmQsIDQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSA2OwogICAgICAgIHRoaXMuc3RhdGVJblRhZ05hbWUoYyk7CiAgICAgIH0KICAgIH0KICAgIHN0YXRlQmVmb3JlU3BlY2lhbFQoYykgewogICAgICBpZiAoYyA9PT0gU2VxdWVuY2VzLlRpdGxlRW5kWzNdKSB7CiAgICAgICAgdGhpcy5zdGFydFNwZWNpYWwoU2VxdWVuY2VzLlRpdGxlRW5kLCA0KTsKICAgICAgfSBlbHNlIGlmIChjID09PSBTZXF1ZW5jZXMuVGV4dGFyZWFFbmRbM10pIHsKICAgICAgICB0aGlzLnN0YXJ0U3BlY2lhbChTZXF1ZW5jZXMuVGV4dGFyZWFFbmQsIDQpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSA2OwogICAgICAgIHRoaXMuc3RhdGVJblRhZ05hbWUoYyk7CiAgICAgIH0KICAgIH0KICAgIHN0YXJ0RW50aXR5KCkgewogICAgfQogICAgc3RhdGVJbkVudGl0eSgpIHsKICAgIH0KICAgIC8qKgogICAgICogSXRlcmF0ZXMgdGhyb3VnaCB0aGUgYnVmZmVyLCBjYWxsaW5nIHRoZSBmdW5jdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjdXJyZW50IHN0YXRlLgogICAgICoKICAgICAqIFN0YXRlcyB0aGF0IGFyZSBtb3JlIGxpa2VseSB0byBiZSBoaXQgYXJlIGhpZ2hlciB1cCwgYXMgYSBwZXJmb3JtYW5jZSBpbXByb3ZlbWVudC4KICAgICAqLwogICAgcGFyc2UoaW5wdXQpIHsKICAgICAgdGhpcy5idWZmZXIgPSBpbnB1dDsKICAgICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLmJ1ZmZlci5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjID0gdGhpcy5idWZmZXIuY2hhckNvZGVBdCh0aGlzLmluZGV4KTsKICAgICAgICBpZiAoYyA9PT0gMTApIHsKICAgICAgICAgIHRoaXMubmV3bGluZXMucHVzaCh0aGlzLmluZGV4KTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoICh0aGlzLnN0YXRlKSB7CiAgICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZVRleHQoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAyOiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uT3BlbihjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUludGVycG9sYXRpb24oYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSA0OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbnRlcnBvbGF0aW9uQ2xvc2UoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAzMTogewogICAgICAgICAgICB0aGlzLnN0YXRlU3BlY2lhbFN0YXJ0U2VxdWVuY2UoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAzMjogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5SQ0RBVEEoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAyNjogewogICAgICAgICAgICB0aGlzLnN0YXRlQ0RBVEFTZXF1ZW5jZShjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDE5OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkF0dHJWYWx1ZURvdWJsZVF1b3RlcyhjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDEyOiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkF0dHJOYW1lKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMTM6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUluRGlyTmFtZShjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDE0OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkRpckFyZyhjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDE1OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkR5bmFtaWNEaXJBcmcoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAxNjogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5EaXJNb2RpZmllcihjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDI4OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkNvbW1lbnRMaWtlKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMjc6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUluU3BlY2lhbENvbW1lbnQoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAxMTogewogICAgICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0ck5hbWUoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSA2OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJblRhZ05hbWUoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAzNDogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5TRkNSb290VGFnTmFtZShjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDk6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUluQ2xvc2luZ1RhZ05hbWUoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSA1OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVUYWdOYW1lKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMTc6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUFmdGVyQXR0ck5hbWUoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAyMDogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5BdHRyVmFsdWVTaW5nbGVRdW90ZXMoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAxODogewogICAgICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQXR0clZhbHVlKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgODogewogICAgICAgICAgICB0aGlzLnN0YXRlQmVmb3JlQ2xvc2luZ1RhZ05hbWUoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAxMDogewogICAgICAgICAgICB0aGlzLnN0YXRlQWZ0ZXJDbG9zaW5nVGFnTmFtZShjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDI5OiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVTcGVjaWFsUyhjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDMwOiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVCZWZvcmVTcGVjaWFsVChjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDIxOiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkF0dHJWYWx1ZU5vUXVvdGVzKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgNzogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5TZWxmQ2xvc2luZ1RhZyhjKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIDIzOiB7CiAgICAgICAgICAgIHRoaXMuc3RhdGVJbkRlY2xhcmF0aW9uKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMjI6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZURlY2xhcmF0aW9uKGMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgMjU6IHsKICAgICAgICAgICAgdGhpcy5zdGF0ZUJlZm9yZUNvbW1lbnQoYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAyNDogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5Qcm9jZXNzaW5nSW5zdHJ1Y3Rpb24oYyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSAzMzogewogICAgICAgICAgICB0aGlzLnN0YXRlSW5FbnRpdHkoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgfQogICAgICB0aGlzLmNsZWFudXAoKTsKICAgICAgdGhpcy5maW5pc2goKTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGRhdGEgdGhhdCBoYXMgYWxyZWFkeSBiZWVuIGNvbnN1bWVkIGZyb20gdGhlIGJ1ZmZlci4KICAgICAqLwogICAgY2xlYW51cCgpIHsKICAgICAgaWYgKHRoaXMuc2VjdGlvblN0YXJ0ICE9PSB0aGlzLmluZGV4KSB7CiAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09IDEgfHwgdGhpcy5zdGF0ZSA9PT0gMzIgJiYgdGhpcy5zZXF1ZW5jZUluZGV4ID09PSAwKSB7CiAgICAgICAgICB0aGlzLmNicy5vbnRleHQodGhpcy5zZWN0aW9uU3RhcnQsIHRoaXMuaW5kZXgpOwogICAgICAgICAgdGhpcy5zZWN0aW9uU3RhcnQgPSB0aGlzLmluZGV4OwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZSA9PT0gMTkgfHwgdGhpcy5zdGF0ZSA9PT0gMjAgfHwgdGhpcy5zdGF0ZSA9PT0gMjEpIHsKICAgICAgICAgIHRoaXMuY2JzLm9uYXR0cmliZGF0YSh0aGlzLnNlY3Rpb25TdGFydCwgdGhpcy5pbmRleCk7CiAgICAgICAgICB0aGlzLnNlY3Rpb25TdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmaW5pc2goKSB7CiAgICAgIHRoaXMuaGFuZGxlVHJhaWxpbmdEYXRhKCk7CiAgICAgIHRoaXMuY2JzLm9uZW5kKCk7CiAgICB9CiAgICAvKiogSGFuZGxlIGFueSB0cmFpbGluZyBkYXRhLiAqLwogICAgaGFuZGxlVHJhaWxpbmdEYXRhKCkgewogICAgICBjb25zdCBlbmRJbmRleCA9IHRoaXMuYnVmZmVyLmxlbmd0aDsKICAgICAgaWYgKHRoaXMuc2VjdGlvblN0YXJ0ID49IGVuZEluZGV4KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0aGlzLnN0YXRlID09PSAyOCkgewogICAgICAgIGlmICh0aGlzLmN1cnJlbnRTZXF1ZW5jZSA9PT0gU2VxdWVuY2VzLkNkYXRhRW5kKSB7CiAgICAgICAgICB0aGlzLmNicy5vbmNkYXRhKHRoaXMuc2VjdGlvblN0YXJ0LCBlbmRJbmRleCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY2JzLm9uY29tbWVudCh0aGlzLnNlY3Rpb25TdGFydCwgZW5kSW5kZXgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLnN0YXRlID09PSA2IHx8IHRoaXMuc3RhdGUgPT09IDExIHx8IHRoaXMuc3RhdGUgPT09IDE4IHx8IHRoaXMuc3RhdGUgPT09IDE3IHx8IHRoaXMuc3RhdGUgPT09IDEyIHx8IHRoaXMuc3RhdGUgPT09IDEzIHx8IHRoaXMuc3RhdGUgPT09IDE0IHx8IHRoaXMuc3RhdGUgPT09IDE1IHx8IHRoaXMuc3RhdGUgPT09IDE2IHx8IHRoaXMuc3RhdGUgPT09IDIwIHx8IHRoaXMuc3RhdGUgPT09IDE5IHx8IHRoaXMuc3RhdGUgPT09IDIxIHx8IHRoaXMuc3RhdGUgPT09IDkpIDsgZWxzZSB7CiAgICAgICAgdGhpcy5jYnMub250ZXh0KHRoaXMuc2VjdGlvblN0YXJ0LCBlbmRJbmRleCk7CiAgICAgIH0KICAgIH0KICAgIGVtaXRDb2RlUG9pbnQoY3AsIGNvbnN1bWVkKSB7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBkZWZhdWx0T25FcnJvcihlcnJvcikgewogICAgdGhyb3cgZXJyb3I7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRPbldhcm4obXNnKSB7CiAgICBjb25zb2xlLndhcm4oYFtWdWUgd2Fybl0gJHttc2cubWVzc2FnZX1gKTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ29tcGlsZXJFcnJvcihjb2RlLCBsb2MsIG1lc3NhZ2VzLCBhZGRpdGlvbmFsTWVzc2FnZSkgewogICAgY29uc3QgbXNnID0gKG1lc3NhZ2VzIHx8IGVycm9yTWVzc2FnZXMpW2NvZGVdICsgKGFkZGl0aW9uYWxNZXNzYWdlIHx8IGBgKSA7CiAgICBjb25zdCBlcnJvciA9IG5ldyBTeW50YXhFcnJvcihTdHJpbmcobXNnKSk7CiAgICBlcnJvci5jb2RlID0gY29kZTsKICAgIGVycm9yLmxvYyA9IGxvYzsKICAgIHJldHVybiBlcnJvcjsKICB9CiAgY29uc3QgZXJyb3JNZXNzYWdlcyA9IHsKICAgIC8vIHBhcnNlIGVycm9ycwogICAgWzBdOiAiSWxsZWdhbCBjb21tZW50LiIsCiAgICBbMV06ICJDREFUQSBzZWN0aW9uIGlzIGFsbG93ZWQgb25seSBpbiBYTUwgY29udGV4dC4iLAogICAgWzJdOiAiRHVwbGljYXRlIGF0dHJpYnV0ZS4iLAogICAgWzNdOiAiRW5kIHRhZyBjYW5ub3QgaGF2ZSBhdHRyaWJ1dGVzLiIsCiAgICBbNF06ICJJbGxlZ2FsICcvJyBpbiB0YWdzLiIsCiAgICBbNV06ICJVbmV4cGVjdGVkIEVPRiBpbiB0YWcuIiwKICAgIFs2XTogIlVuZXhwZWN0ZWQgRU9GIGluIENEQVRBIHNlY3Rpb24uIiwKICAgIFs3XTogIlVuZXhwZWN0ZWQgRU9GIGluIGNvbW1lbnQuIiwKICAgIFs4XTogIlVuZXhwZWN0ZWQgRU9GIGluIHNjcmlwdC4iLAogICAgWzldOiAiVW5leHBlY3RlZCBFT0YgaW4gdGFnLiIsCiAgICBbMTBdOiAiSW5jb3JyZWN0bHkgY2xvc2VkIGNvbW1lbnQuIiwKICAgIFsxMV06ICJJbmNvcnJlY3RseSBvcGVuZWQgY29tbWVudC4iLAogICAgWzEyXTogIklsbGVnYWwgdGFnIG5hbWUuIFVzZSAnJmx0OycgdG8gcHJpbnQgJzwnLiIsCiAgICBbMTNdOiAiQXR0cmlidXRlIHZhbHVlIHdhcyBleHBlY3RlZC4iLAogICAgWzE0XTogIkVuZCB0YWcgbmFtZSB3YXMgZXhwZWN0ZWQuIiwKICAgIFsxNV06ICJXaGl0ZXNwYWNlIHdhcyBleHBlY3RlZC4iLAogICAgWzE2XTogIlVuZXhwZWN0ZWQgJzwhLS0nIGluIGNvbW1lbnQuIiwKICAgIFsxN106IGBBdHRyaWJ1dGUgbmFtZSBjYW5ub3QgY29udGFpbiBVKzAwMjIgKCIpLCBVKzAwMjcgKCcpLCBhbmQgVSswMDNDICg8KS5gLAogICAgWzE4XTogIlVucXVvdGVkIGF0dHJpYnV0ZSB2YWx1ZSBjYW5ub3QgY29udGFpbiBVKzAwMjIgKFwiKSwgVSswMDI3ICgnKSwgVSswMDNDICg8KSwgVSswMDNEICg9KSwgYW5kIFUrMDA2MCAoYCkuIiwKICAgIFsxOV06ICJBdHRyaWJ1dGUgbmFtZSBjYW5ub3Qgc3RhcnQgd2l0aCAnPScuIiwKICAgIFsyMV06ICInPD8nIGlzIGFsbG93ZWQgb25seSBpbiBYTUwgY29udGV4dC4iLAogICAgWzIwXTogYFVuZXhwZWN0ZWQgbnVsbCBjaGFyYWN0ZXIuYCwKICAgIFsyMl06ICJJbGxlZ2FsICcvJyBpbiB0YWdzLiIsCiAgICAvLyBWdWUtc3BlY2lmaWMgcGFyc2UgZXJyb3JzCiAgICBbMjNdOiAiSW52YWxpZCBlbmQgdGFnLiIsCiAgICBbMjRdOiAiRWxlbWVudCBpcyBtaXNzaW5nIGVuZCB0YWcuIiwKICAgIFsyNV06ICJJbnRlcnBvbGF0aW9uIGVuZCBzaWduIHdhcyBub3QgZm91bmQuIiwKICAgIFsyN106ICJFbmQgYnJhY2tldCBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgd2FzIG5vdCBmb3VuZC4gTm90ZSB0aGF0IGR5bmFtaWMgZGlyZWN0aXZlIGFyZ3VtZW50IGNhbm5vdCBjb250YWluIHNwYWNlcy4iLAogICAgWzI2XTogIkxlZ2FsIGRpcmVjdGl2ZSBuYW1lIHdhcyBleHBlY3RlZC4iLAogICAgLy8gdHJhbnNmb3JtIGVycm9ycwogICAgWzI4XTogYHYtaWYvdi1lbHNlLWlmIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgWzI5XTogYHYtaWYvZWxzZSBicmFuY2hlcyBtdXN0IHVzZSB1bmlxdWUga2V5cy5gLAogICAgWzMwXTogYHYtZWxzZS92LWVsc2UtaWYgaGFzIG5vIGFkamFjZW50IHYtaWYgb3Igdi1lbHNlLWlmLmAsCiAgICBbMzFdOiBgdi1mb3IgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsCiAgICBbMzJdOiBgdi1mb3IgaGFzIGludmFsaWQgZXhwcmVzc2lvbi5gLAogICAgWzMzXTogYDx0ZW1wbGF0ZSB2LWZvcj4ga2V5IHNob3VsZCBiZSBwbGFjZWQgb24gdGhlIDx0ZW1wbGF0ZT4gdGFnLmAsCiAgICBbMzRdOiBgdi1iaW5kIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgWzUyXTogYHYtYmluZCB3aXRoIHNhbWUtbmFtZSBzaG9ydGhhbmQgb25seSBhbGxvd3Mgc3RhdGljIGFyZ3VtZW50LmAsCiAgICBbMzVdOiBgdi1vbiBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgIFszNl06IGBVbmV4cGVjdGVkIGN1c3RvbSBkaXJlY3RpdmUgb24gPHNsb3Q+IG91dGxldC5gLAogICAgWzM3XTogYE1peGVkIHYtc2xvdCB1c2FnZSBvbiBib3RoIHRoZSBjb21wb25lbnQgYW5kIG5lc3RlZCA8dGVtcGxhdGU+LiBXaGVuIHRoZXJlIGFyZSBtdWx0aXBsZSBuYW1lZCBzbG90cywgYWxsIHNsb3RzIHNob3VsZCB1c2UgPHRlbXBsYXRlPiBzeW50YXggdG8gYXZvaWQgc2NvcGUgYW1iaWd1aXR5LmAsCiAgICBbMzhdOiBgRHVwbGljYXRlIHNsb3QgbmFtZXMgZm91bmQuIGAsCiAgICBbMzldOiBgRXh0cmFuZW91cyBjaGlsZHJlbiBmb3VuZCB3aGVuIGNvbXBvbmVudCBhbHJlYWR5IGhhcyBleHBsaWNpdGx5IG5hbWVkIGRlZmF1bHQgc2xvdC4gVGhlc2UgY2hpbGRyZW4gd2lsbCBiZSBpZ25vcmVkLmAsCiAgICBbNDBdOiBgdi1zbG90IGNhbiBvbmx5IGJlIHVzZWQgb24gY29tcG9uZW50cyBvciA8dGVtcGxhdGU+IHRhZ3MuYCwKICAgIFs0MV06IGB2LW1vZGVsIGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgWzQyXTogYHYtbW9kZWwgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIEphdmFTY3JpcHQgbWVtYmVyIGV4cHJlc3Npb24uYCwKICAgIFs0M106IGB2LW1vZGVsIGNhbm5vdCBiZSB1c2VkIG9uIHYtZm9yIG9yIHYtc2xvdCBzY29wZSB2YXJpYWJsZXMgYmVjYXVzZSB0aGV5IGFyZSBub3Qgd3JpdGFibGUuYCwKICAgIFs0NF06IGB2LW1vZGVsIGNhbm5vdCBiZSB1c2VkIG9uIGEgcHJvcCwgYmVjYXVzZSBsb2NhbCBwcm9wIGJpbmRpbmdzIGFyZSBub3Qgd3JpdGFibGUuClVzZSBhIHYtYmluZCBiaW5kaW5nIGNvbWJpbmVkIHdpdGggYSB2LW9uIGxpc3RlbmVyIHRoYXQgZW1pdHMgdXBkYXRlOnggZXZlbnQgaW5zdGVhZC5gLAogICAgWzQ1XTogYEVycm9yIHBhcnNpbmcgSmF2YVNjcmlwdCBleHByZXNzaW9uOiBgLAogICAgWzQ2XTogYDxLZWVwQWxpdmU+IGV4cGVjdHMgZXhhY3RseSBvbmUgY2hpbGQgY29tcG9uZW50LmAsCiAgICBbNTFdOiBgQHZub2RlLSogaG9va3MgaW4gdGVtcGxhdGVzIGFyZSBubyBsb25nZXIgc3VwcG9ydGVkLiBVc2UgdGhlIHZ1ZTogcHJlZml4IGluc3RlYWQuIEZvciBleGFtcGxlLCBAdm5vZGUtbW91bnRlZCBzaG91bGQgYmUgY2hhbmdlZCB0byBAdnVlOm1vdW50ZWQuIEB2bm9kZS0qIGhvb2tzIHN1cHBvcnQgaGFzIGJlZW4gcmVtb3ZlZCBpbiAzLjQuYCwKICAgIC8vIGdlbmVyaWMgZXJyb3JzCiAgICBbNDddOiBgInByZWZpeElkZW50aWZpZXJzIiBvcHRpb24gaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJ1aWxkIG9mIGNvbXBpbGVyLmAsCiAgICBbNDhdOiBgRVMgbW9kdWxlIG1vZGUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJ1aWxkIG9mIGNvbXBpbGVyLmAsCiAgICBbNDldOiBgImNhY2hlSGFuZGxlcnMiIG9wdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCB3aGVuIHRoZSAicHJlZml4SWRlbnRpZmllcnMiIG9wdGlvbiBpcyBlbmFibGVkLmAsCiAgICBbNTBdOiBgInNjb3BlSWQiIG9wdGlvbiBpcyBvbmx5IHN1cHBvcnRlZCBpbiBtb2R1bGUgbW9kZS5gLAogICAgLy8ganVzdCB0byBmdWxmaWxsIHR5cGVzCiAgICBbNTNdOiBgYAogIH07CgogIGNvbnN0IGlzU3RhdGljRXhwID0gKHApID0+IHAudHlwZSA9PT0gNCAmJiBwLmlzU3RhdGljOwogIGZ1bmN0aW9uIGlzQ29yZUNvbXBvbmVudCh0YWcpIHsKICAgIHN3aXRjaCAodGFnKSB7CiAgICAgIGNhc2UgIlRlbGVwb3J0IjoKICAgICAgY2FzZSAidGVsZXBvcnQiOgogICAgICAgIHJldHVybiBURUxFUE9SVDsKICAgICAgY2FzZSAiU3VzcGVuc2UiOgogICAgICBjYXNlICJzdXNwZW5zZSI6CiAgICAgICAgcmV0dXJuIFNVU1BFTlNFOwogICAgICBjYXNlICJLZWVwQWxpdmUiOgogICAgICBjYXNlICJrZWVwLWFsaXZlIjoKICAgICAgICByZXR1cm4gS0VFUF9BTElWRTsKICAgICAgY2FzZSAiQmFzZVRyYW5zaXRpb24iOgogICAgICBjYXNlICJiYXNlLXRyYW5zaXRpb24iOgogICAgICAgIHJldHVybiBCQVNFX1RSQU5TSVRJT047CiAgICB9CiAgfQogIGNvbnN0IG5vbklkZW50aWZpZXJSRSA9IC9eXGR8W15cJFx3XS87CiAgY29uc3QgaXNTaW1wbGVJZGVudGlmaWVyID0gKG5hbWUpID0+ICFub25JZGVudGlmaWVyUkUudGVzdChuYW1lKTsKICBjb25zdCB2YWxpZEZpcnN0SWRlbnRDaGFyUkUgPSAvW0EtWmEtel8kXHhBMC1cdUZGRkZdLzsKICBjb25zdCB2YWxpZElkZW50Q2hhclJFID0gL1tcLlw/XHckXHhBMC1cdUZGRkZdLzsKICBjb25zdCB3aGl0ZXNwYWNlUkUgPSAvXHMrWy5bXVxzKnxccypbLltdXHMrL2c7CiAgY29uc3QgaXNNZW1iZXJFeHByZXNzaW9uQnJvd3NlciA9IChwYXRoKSA9PiB7CiAgICBwYXRoID0gcGF0aC50cmltKCkucmVwbGFjZSh3aGl0ZXNwYWNlUkUsIChzKSA9PiBzLnRyaW0oKSk7CiAgICBsZXQgc3RhdGUgPSAwIC8qIGluTWVtYmVyRXhwICovOwogICAgbGV0IHN0YXRlU3RhY2sgPSBbXTsKICAgIGxldCBjdXJyZW50T3BlbkJyYWNrZXRDb3VudCA9IDA7CiAgICBsZXQgY3VycmVudE9wZW5QYXJlbnNDb3VudCA9IDA7CiAgICBsZXQgY3VycmVudFN0cmluZ1R5cGUgPSBudWxsOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoYXIgPSBwYXRoLmNoYXJBdChpKTsKICAgICAgc3dpdGNoIChzdGF0ZSkgewogICAgICAgIGNhc2UgMCAvKiBpbk1lbWJlckV4cCAqLzoKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgc3RhdGVTdGFjay5wdXNoKHN0YXRlKTsKICAgICAgICAgICAgc3RhdGUgPSAxIC8qIGluQnJhY2tldHMgKi87CiAgICAgICAgICAgIGN1cnJlbnRPcGVuQnJhY2tldENvdW50Kys7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIoIikgewogICAgICAgICAgICBzdGF0ZVN0YWNrLnB1c2goc3RhdGUpOwogICAgICAgICAgICBzdGF0ZSA9IDIgLyogaW5QYXJlbnMgKi87CiAgICAgICAgICAgIGN1cnJlbnRPcGVuUGFyZW5zQ291bnQrKzsKICAgICAgICAgIH0gZWxzZSBpZiAoIShpID09PSAwID8gdmFsaWRGaXJzdElkZW50Q2hhclJFIDogdmFsaWRJZGVudENoYXJSRSkudGVzdChjaGFyKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDEgLyogaW5CcmFja2V0cyAqLzoKICAgICAgICAgIGlmIChjaGFyID09PSBgJ2AgfHwgY2hhciA9PT0gYCJgIHx8IGNoYXIgPT09ICJgIikgewogICAgICAgICAgICBzdGF0ZVN0YWNrLnB1c2goc3RhdGUpOwogICAgICAgICAgICBzdGF0ZSA9IDMgLyogaW5TdHJpbmcgKi87CiAgICAgICAgICAgIGN1cnJlbnRTdHJpbmdUeXBlID0gY2hhcjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gYFtgKSB7CiAgICAgICAgICAgIGN1cnJlbnRPcGVuQnJhY2tldENvdW50Kys7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09IGBdYCkgewogICAgICAgICAgICBpZiAoIS0tY3VycmVudE9wZW5CcmFja2V0Q291bnQpIHsKICAgICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RhY2sucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMiAvKiBpblBhcmVucyAqLzoKICAgICAgICAgIGlmIChjaGFyID09PSBgJ2AgfHwgY2hhciA9PT0gYCJgIHx8IGNoYXIgPT09ICJgIikgewogICAgICAgICAgICBzdGF0ZVN0YWNrLnB1c2goc3RhdGUpOwogICAgICAgICAgICBzdGF0ZSA9IDMgLyogaW5TdHJpbmcgKi87CiAgICAgICAgICAgIGN1cnJlbnRTdHJpbmdUeXBlID0gY2hhcjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gYChgKSB7CiAgICAgICAgICAgIGN1cnJlbnRPcGVuUGFyZW5zQ291bnQrKzsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gYClgKSB7CiAgICAgICAgICAgIGlmIChpID09PSBwYXRoLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEtLWN1cnJlbnRPcGVuUGFyZW5zQ291bnQpIHsKICAgICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RhY2sucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMyAvKiBpblN0cmluZyAqLzoKICAgICAgICAgIGlmIChjaGFyID09PSBjdXJyZW50U3RyaW5nVHlwZSkgewogICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RhY2sucG9wKCk7CiAgICAgICAgICAgIGN1cnJlbnRTdHJpbmdUeXBlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gIWN1cnJlbnRPcGVuQnJhY2tldENvdW50ICYmICFjdXJyZW50T3BlblBhcmVuc0NvdW50OwogIH07CiAgY29uc3QgaXNNZW1iZXJFeHByZXNzaW9uID0gaXNNZW1iZXJFeHByZXNzaW9uQnJvd3NlciA7CiAgZnVuY3Rpb24gYXNzZXJ0KGNvbmRpdGlvbiwgbXNnKSB7CiAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnIHx8IGB1bmV4cGVjdGVkIGNvbXBpbGVyIGNvbmRpdGlvbmApOwogICAgfQogIH0KICBmdW5jdGlvbiBmaW5kRGlyKG5vZGUsIG5hbWUsIGFsbG93RW1wdHkgPSBmYWxzZSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHAgPSBub2RlLnByb3BzW2ldOwogICAgICBpZiAocC50eXBlID09PSA3ICYmIChhbGxvd0VtcHR5IHx8IHAuZXhwKSAmJiAoaXNTdHJpbmcobmFtZSkgPyBwLm5hbWUgPT09IG5hbWUgOiBuYW1lLnRlc3QocC5uYW1lKSkpIHsKICAgICAgICByZXR1cm4gcDsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBmaW5kUHJvcChub2RlLCBuYW1lLCBkeW5hbWljT25seSA9IGZhbHNlLCBhbGxvd0VtcHR5ID0gZmFsc2UpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5wcm9wcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsKICAgICAgaWYgKHAudHlwZSA9PT0gNikgewogICAgICAgIGlmIChkeW5hbWljT25seSkKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIGlmIChwLm5hbWUgPT09IG5hbWUgJiYgKHAudmFsdWUgfHwgYWxsb3dFbXB0eSkpIHsKICAgICAgICAgIHJldHVybiBwOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwLm5hbWUgPT09ICJiaW5kIiAmJiAocC5leHAgfHwgYWxsb3dFbXB0eSkgJiYgaXNTdGF0aWNBcmdPZihwLmFyZywgbmFtZSkpIHsKICAgICAgICByZXR1cm4gcDsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBpc1N0YXRpY0FyZ09mKGFyZywgbmFtZSkgewogICAgcmV0dXJuICEhKGFyZyAmJiBpc1N0YXRpY0V4cChhcmcpICYmIGFyZy5jb250ZW50ID09PSBuYW1lKTsKICB9CiAgZnVuY3Rpb24gaGFzRHluYW1pY0tleVZCaW5kKG5vZGUpIHsKICAgIHJldHVybiBub2RlLnByb3BzLnNvbWUoCiAgICAgIChwKSA9PiBwLnR5cGUgPT09IDcgJiYgcC5uYW1lID09PSAiYmluZCIgJiYgKCFwLmFyZyB8fCAvLyB2LWJpbmQ9Im9iaiIKICAgICAgcC5hcmcudHlwZSAhPT0gNCB8fCAvLyB2LWJpbmQ6W19jdHguZm9vXQogICAgICAhcC5hcmcuaXNTdGF0aWMpCiAgICAgIC8vIHYtYmluZDpbZm9vXQogICAgKTsKICB9CiAgZnVuY3Rpb24gaXNUZXh0JDEobm9kZSkgewogICAgcmV0dXJuIG5vZGUudHlwZSA9PT0gNSB8fCBub2RlLnR5cGUgPT09IDI7CiAgfQogIGZ1bmN0aW9uIGlzVlNsb3QocCkgewogICAgcmV0dXJuIHAudHlwZSA9PT0gNyAmJiBwLm5hbWUgPT09ICJzbG90IjsKICB9CiAgZnVuY3Rpb24gaXNUZW1wbGF0ZU5vZGUobm9kZSkgewogICAgcmV0dXJuIG5vZGUudHlwZSA9PT0gMSAmJiBub2RlLnRhZ1R5cGUgPT09IDM7CiAgfQogIGZ1bmN0aW9uIGlzU2xvdE91dGxldChub2RlKSB7CiAgICByZXR1cm4gbm9kZS50eXBlID09PSAxICYmIG5vZGUudGFnVHlwZSA9PT0gMjsKICB9CiAgY29uc3QgcHJvcHNIZWxwZXJTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbTk9STUFMSVpFX1BST1BTLCBHVUFSRF9SRUFDVElWRV9QUk9QU10pOwogIGZ1bmN0aW9uIGdldFVubm9ybWFsaXplZFByb3BzKHByb3BzLCBjYWxsUGF0aCA9IFtdKSB7CiAgICBpZiAocHJvcHMgJiYgIWlzU3RyaW5nKHByb3BzKSAmJiBwcm9wcy50eXBlID09PSAxNCkgewogICAgICBjb25zdCBjYWxsZWUgPSBwcm9wcy5jYWxsZWU7CiAgICAgIGlmICghaXNTdHJpbmcoY2FsbGVlKSAmJiBwcm9wc0hlbHBlclNldC5oYXMoY2FsbGVlKSkgewogICAgICAgIHJldHVybiBnZXRVbm5vcm1hbGl6ZWRQcm9wcygKICAgICAgICAgIHByb3BzLmFyZ3VtZW50c1swXSwKICAgICAgICAgIGNhbGxQYXRoLmNvbmNhdChwcm9wcykKICAgICAgICApOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gW3Byb3BzLCBjYWxsUGF0aF07CiAgfQogIGZ1bmN0aW9uIGluamVjdFByb3Aobm9kZSwgcHJvcCwgY29udGV4dCkgewogICAgbGV0IHByb3BzV2l0aEluamVjdGlvbjsKICAgIGxldCBwcm9wcyA9IG5vZGUudHlwZSA9PT0gMTMgPyBub2RlLnByb3BzIDogbm9kZS5hcmd1bWVudHNbMl07CiAgICBsZXQgY2FsbFBhdGggPSBbXTsKICAgIGxldCBwYXJlbnRDYWxsOwogICAgaWYgKHByb3BzICYmICFpc1N0cmluZyhwcm9wcykgJiYgcHJvcHMudHlwZSA9PT0gMTQpIHsKICAgICAgY29uc3QgcmV0ID0gZ2V0VW5ub3JtYWxpemVkUHJvcHMocHJvcHMpOwogICAgICBwcm9wcyA9IHJldFswXTsKICAgICAgY2FsbFBhdGggPSByZXRbMV07CiAgICAgIHBhcmVudENhbGwgPSBjYWxsUGF0aFtjYWxsUGF0aC5sZW5ndGggLSAxXTsKICAgIH0KICAgIGlmIChwcm9wcyA9PSBudWxsIHx8IGlzU3RyaW5nKHByb3BzKSkgewogICAgICBwcm9wc1dpdGhJbmplY3Rpb24gPSBjcmVhdGVPYmplY3RFeHByZXNzaW9uKFtwcm9wXSk7CiAgICB9IGVsc2UgaWYgKHByb3BzLnR5cGUgPT09IDE0KSB7CiAgICAgIGNvbnN0IGZpcnN0ID0gcHJvcHMuYXJndW1lbnRzWzBdOwogICAgICBpZiAoIWlzU3RyaW5nKGZpcnN0KSAmJiBmaXJzdC50eXBlID09PSAxNSkgewogICAgICAgIGlmICghaGFzUHJvcChwcm9wLCBmaXJzdCkpIHsKICAgICAgICAgIGZpcnN0LnByb3BlcnRpZXMudW5zaGlmdChwcm9wKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHByb3BzLmNhbGxlZSA9PT0gVE9fSEFORExFUlMpIHsKICAgICAgICAgIHByb3BzV2l0aEluamVjdGlvbiA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKE1FUkdFX1BST1BTKSwgWwogICAgICAgICAgICBjcmVhdGVPYmplY3RFeHByZXNzaW9uKFtwcm9wXSksCiAgICAgICAgICAgIHByb3BzCiAgICAgICAgICBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHJvcHMuYXJndW1lbnRzLnVuc2hpZnQoY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgIXByb3BzV2l0aEluamVjdGlvbiAmJiAocHJvcHNXaXRoSW5qZWN0aW9uID0gcHJvcHMpOwogICAgfSBlbHNlIGlmIChwcm9wcy50eXBlID09PSAxNSkgewogICAgICBpZiAoIWhhc1Byb3AocHJvcCwgcHJvcHMpKSB7CiAgICAgICAgcHJvcHMucHJvcGVydGllcy51bnNoaWZ0KHByb3ApOwogICAgICB9CiAgICAgIHByb3BzV2l0aEluamVjdGlvbiA9IHByb3BzOwogICAgfSBlbHNlIHsKICAgICAgcHJvcHNXaXRoSW5qZWN0aW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoTUVSR0VfUFJPUFMpLCBbCiAgICAgICAgY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihbcHJvcF0pLAogICAgICAgIHByb3BzCiAgICAgIF0pOwogICAgICBpZiAocGFyZW50Q2FsbCAmJiBwYXJlbnRDYWxsLmNhbGxlZSA9PT0gR1VBUkRfUkVBQ1RJVkVfUFJPUFMpIHsKICAgICAgICBwYXJlbnRDYWxsID0gY2FsbFBhdGhbY2FsbFBhdGgubGVuZ3RoIC0gMl07CiAgICAgIH0KICAgIH0KICAgIGlmIChub2RlLnR5cGUgPT09IDEzKSB7CiAgICAgIGlmIChwYXJlbnRDYWxsKSB7CiAgICAgICAgcGFyZW50Q2FsbC5hcmd1bWVudHNbMF0gPSBwcm9wc1dpdGhJbmplY3Rpb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZS5wcm9wcyA9IHByb3BzV2l0aEluamVjdGlvbjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHBhcmVudENhbGwpIHsKICAgICAgICBwYXJlbnRDYWxsLmFyZ3VtZW50c1swXSA9IHByb3BzV2l0aEluamVjdGlvbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlLmFyZ3VtZW50c1syXSA9IHByb3BzV2l0aEluamVjdGlvbjsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBoYXNQcm9wKHByb3AsIHByb3BzKSB7CiAgICBsZXQgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAocHJvcC5rZXkudHlwZSA9PT0gNCkgewogICAgICBjb25zdCBwcm9wS2V5TmFtZSA9IHByb3Aua2V5LmNvbnRlbnQ7CiAgICAgIHJlc3VsdCA9IHByb3BzLnByb3BlcnRpZXMuc29tZSgKICAgICAgICAocCkgPT4gcC5rZXkudHlwZSA9PT0gNCAmJiBwLmtleS5jb250ZW50ID09PSBwcm9wS2V5TmFtZQogICAgICApOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdG9WYWxpZEFzc2V0SWQobmFtZSwgdHlwZSkgewogICAgcmV0dXJuIGBfJHt0eXBlfV8ke25hbWUucmVwbGFjZSgvW15cd10vZywgKHNlYXJjaFZhbHVlLCByZXBsYWNlVmFsdWUpID0+IHsKICAgIHJldHVybiBzZWFyY2hWYWx1ZSA9PT0gIi0iID8gIl8iIDogbmFtZS5jaGFyQ29kZUF0KHJlcGxhY2VWYWx1ZSkudG9TdHJpbmcoKTsKICB9KX1gOwogIH0KICBmdW5jdGlvbiBnZXRNZW1vZWRWTm9kZUNhbGwobm9kZSkgewogICAgaWYgKG5vZGUudHlwZSA9PT0gMTQgJiYgbm9kZS5jYWxsZWUgPT09IFdJVEhfTUVNTykgewogICAgICByZXR1cm4gbm9kZS5hcmd1bWVudHNbMV0ucmV0dXJuczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBub2RlOwogICAgfQogIH0KICBjb25zdCBmb3JBbGlhc1JFID0gLyhbXHNcU10qPylccysoPzppbnxvZilccysoW1xzXFNdKikvOwoKICBjb25zdCBkZWZhdWx0UGFyc2VyT3B0aW9ucyA9IHsKICAgIHBhcnNlTW9kZTogImJhc2UiLAogICAgbnM6IDAsCiAgICBkZWxpbWl0ZXJzOiBbYHt7YCwgYH19YF0sCiAgICBnZXROYW1lc3BhY2U6ICgpID0+IDAsCiAgICBpc1ZvaWRUYWc6IE5PLAogICAgaXNQcmVUYWc6IE5PLAogICAgaXNDdXN0b21FbGVtZW50OiBOTywKICAgIG9uRXJyb3I6IGRlZmF1bHRPbkVycm9yLAogICAgb25XYXJuOiBkZWZhdWx0T25XYXJuLAogICAgY29tbWVudHM6IHRydWUsCiAgICBwcmVmaXhJZGVudGlmaWVyczogZmFsc2UKICB9OwogIGxldCBjdXJyZW50T3B0aW9ucyA9IGRlZmF1bHRQYXJzZXJPcHRpb25zOwogIGxldCBjdXJyZW50Um9vdCA9IG51bGw7CiAgbGV0IGN1cnJlbnRJbnB1dCA9ICIiOwogIGxldCBjdXJyZW50T3BlblRhZyA9IG51bGw7CiAgbGV0IGN1cnJlbnRQcm9wID0gbnVsbDsKICBsZXQgY3VycmVudEF0dHJWYWx1ZSA9ICIiOwogIGxldCBjdXJyZW50QXR0clN0YXJ0SW5kZXggPSAtMTsKICBsZXQgY3VycmVudEF0dHJFbmRJbmRleCA9IC0xOwogIGxldCBpblByZSA9IDA7CiAgbGV0IGluVlByZSA9IGZhbHNlOwogIGxldCBjdXJyZW50VlByZUJvdW5kYXJ5ID0gbnVsbDsKICBjb25zdCBzdGFjayA9IFtdOwogIGNvbnN0IHRva2VuaXplciA9IG5ldyBUb2tlbml6ZXIoc3RhY2ssIHsKICAgIG9uZXJyOiBlbWl0RXJyb3IsCiAgICBvbnRleHQoc3RhcnQsIGVuZCkgewogICAgICBvblRleHQoZ2V0U2xpY2Uoc3RhcnQsIGVuZCksIHN0YXJ0LCBlbmQpOwogICAgfSwKICAgIG9udGV4dGVudGl0eShjaGFyLCBzdGFydCwgZW5kKSB7CiAgICAgIG9uVGV4dChjaGFyLCBzdGFydCwgZW5kKTsKICAgIH0sCiAgICBvbmludGVycG9sYXRpb24oc3RhcnQsIGVuZCkgewogICAgICBpZiAoaW5WUHJlKSB7CiAgICAgICAgcmV0dXJuIG9uVGV4dChnZXRTbGljZShzdGFydCwgZW5kKSwgc3RhcnQsIGVuZCk7CiAgICAgIH0KICAgICAgbGV0IGlubmVyU3RhcnQgPSBzdGFydCArIHRva2VuaXplci5kZWxpbWl0ZXJPcGVuLmxlbmd0aDsKICAgICAgbGV0IGlubmVyRW5kID0gZW5kIC0gdG9rZW5pemVyLmRlbGltaXRlckNsb3NlLmxlbmd0aDsKICAgICAgd2hpbGUgKGlzV2hpdGVzcGFjZShjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpbm5lclN0YXJ0KSkpIHsKICAgICAgICBpbm5lclN0YXJ0Kys7CiAgICAgIH0KICAgICAgd2hpbGUgKGlzV2hpdGVzcGFjZShjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpbm5lckVuZCAtIDEpKSkgewogICAgICAgIGlubmVyRW5kLS07CiAgICAgIH0KICAgICAgbGV0IGV4cCA9IGdldFNsaWNlKGlubmVyU3RhcnQsIGlubmVyRW5kKTsKICAgICAgaWYgKGV4cC5pbmNsdWRlcygiJiIpKSB7CiAgICAgICAgewogICAgICAgICAgZXhwID0gY3VycmVudE9wdGlvbnMuZGVjb2RlRW50aXRpZXMoZXhwLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFkZE5vZGUoewogICAgICAgIHR5cGU6IDUsCiAgICAgICAgY29udGVudDogY3JlYXRlRXhwKGV4cCwgZmFsc2UsIGdldExvYyhpbm5lclN0YXJ0LCBpbm5lckVuZCkpLAogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0LCBlbmQpCiAgICAgIH0pOwogICAgfSwKICAgIG9ub3BlbnRhZ25hbWUoc3RhcnQsIGVuZCkgewogICAgICBjb25zdCBuYW1lID0gZ2V0U2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgIGN1cnJlbnRPcGVuVGFnID0gewogICAgICAgIHR5cGU6IDEsCiAgICAgICAgdGFnOiBuYW1lLAogICAgICAgIG5zOiBjdXJyZW50T3B0aW9ucy5nZXROYW1lc3BhY2UobmFtZSwgc3RhY2tbMF0sIGN1cnJlbnRPcHRpb25zLm5zKSwKICAgICAgICB0YWdUeXBlOiAwLAogICAgICAgIC8vIHdpbGwgYmUgcmVmaW5lZCBvbiB0YWcgY2xvc2UKICAgICAgICBwcm9wczogW10sCiAgICAgICAgY2hpbGRyZW46IFtdLAogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0IC0gMSwgZW5kKSwKICAgICAgICBjb2RlZ2VuTm9kZTogdm9pZCAwCiAgICAgIH07CiAgICB9LAogICAgb25vcGVudGFnZW5kKGVuZCkgewogICAgICBlbmRPcGVuVGFnKGVuZCk7CiAgICB9LAogICAgb25jbG9zZXRhZyhzdGFydCwgZW5kKSB7CiAgICAgIGNvbnN0IG5hbWUgPSBnZXRTbGljZShzdGFydCwgZW5kKTsKICAgICAgaWYgKCFjdXJyZW50T3B0aW9ucy5pc1ZvaWRUYWcobmFtZSkpIHsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YWNrLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBlID0gc3RhY2tbaV07CiAgICAgICAgICBpZiAoZS50YWcudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKGkgPiAwKSB7CiAgICAgICAgICAgICAgZW1pdEVycm9yKDI0LCBzdGFja1swXS5sb2Muc3RhcnQub2Zmc2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSBpOyBqKyspIHsKICAgICAgICAgICAgICBjb25zdCBlbCA9IHN0YWNrLnNoaWZ0KCk7CiAgICAgICAgICAgICAgb25DbG9zZVRhZyhlbCwgZW5kLCBqIDwgaSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIGVtaXRFcnJvcigyMywgYmFja1RyYWNrKHN0YXJ0LCA2MCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIG9uc2VsZmNsb3Npbmd0YWcoZW5kKSB7CiAgICAgIHZhciBfYTsKICAgICAgY29uc3QgbmFtZSA9IGN1cnJlbnRPcGVuVGFnLnRhZzsKICAgICAgY3VycmVudE9wZW5UYWcuaXNTZWxmQ2xvc2luZyA9IHRydWU7CiAgICAgIGVuZE9wZW5UYWcoZW5kKTsKICAgICAgaWYgKCgoX2EgPSBzdGFja1swXSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnRhZykgPT09IG5hbWUpIHsKICAgICAgICBvbkNsb3NlVGFnKHN0YWNrLnNoaWZ0KCksIGVuZCk7CiAgICAgIH0KICAgIH0sCiAgICBvbmF0dHJpYm5hbWUoc3RhcnQsIGVuZCkgewogICAgICBjdXJyZW50UHJvcCA9IHsKICAgICAgICB0eXBlOiA2LAogICAgICAgIG5hbWU6IGdldFNsaWNlKHN0YXJ0LCBlbmQpLAogICAgICAgIG5hbWVMb2M6IGdldExvYyhzdGFydCwgZW5kKSwKICAgICAgICB2YWx1ZTogdm9pZCAwLAogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0KQogICAgICB9OwogICAgfSwKICAgIG9uZGlybmFtZShzdGFydCwgZW5kKSB7CiAgICAgIGNvbnN0IHJhdyA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICBjb25zdCBuYW1lID0gcmF3ID09PSAiLiIgfHwgcmF3ID09PSAiOiIgPyAiYmluZCIgOiByYXcgPT09ICJAIiA/ICJvbiIgOiByYXcgPT09ICIjIiA/ICJzbG90IiA6IHJhdy5zbGljZSgyKTsKICAgICAgaWYgKCFpblZQcmUgJiYgbmFtZSA9PT0gIiIpIHsKICAgICAgICBlbWl0RXJyb3IoMjYsIHN0YXJ0KTsKICAgICAgfQogICAgICBpZiAoaW5WUHJlIHx8IG5hbWUgPT09ICIiKSB7CiAgICAgICAgY3VycmVudFByb3AgPSB7CiAgICAgICAgICB0eXBlOiA2LAogICAgICAgICAgbmFtZTogcmF3LAogICAgICAgICAgbmFtZUxvYzogZ2V0TG9jKHN0YXJ0LCBlbmQpLAogICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0KQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VycmVudFByb3AgPSB7CiAgICAgICAgICB0eXBlOiA3LAogICAgICAgICAgbmFtZSwKICAgICAgICAgIHJhd05hbWU6IHJhdywKICAgICAgICAgIGV4cDogdm9pZCAwLAogICAgICAgICAgYXJnOiB2b2lkIDAsCiAgICAgICAgICBtb2RpZmllcnM6IHJhdyA9PT0gIi4iID8gWyJwcm9wIl0gOiBbXSwKICAgICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0KQogICAgICAgIH07CiAgICAgICAgaWYgKG5hbWUgPT09ICJwcmUiKSB7CiAgICAgICAgICBpblZQcmUgPSB0b2tlbml6ZXIuaW5WUHJlID0gdHJ1ZTsKICAgICAgICAgIGN1cnJlbnRWUHJlQm91bmRhcnkgPSBjdXJyZW50T3BlblRhZzsKICAgICAgICAgIGNvbnN0IHByb3BzID0gY3VycmVudE9wZW5UYWcucHJvcHM7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChwcm9wc1tpXS50eXBlID09PSA3KSB7CiAgICAgICAgICAgICAgcHJvcHNbaV0gPSBkaXJUb0F0dHIocHJvcHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgb25kaXJhcmcoc3RhcnQsIGVuZCkgewogICAgICBpZiAoc3RhcnQgPT09IGVuZCkKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IGFyZyA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaW5WUHJlKSB7CiAgICAgICAgY3VycmVudFByb3AubmFtZSArPSBhcmc7CiAgICAgICAgc2V0TG9jRW5kKGN1cnJlbnRQcm9wLm5hbWVMb2MsIGVuZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaXNTdGF0aWMgPSBhcmdbMF0gIT09IGBbYDsKICAgICAgICBjdXJyZW50UHJvcC5hcmcgPSBjcmVhdGVFeHAoCiAgICAgICAgICBpc1N0YXRpYyA/IGFyZyA6IGFyZy5zbGljZSgxLCAtMSksCiAgICAgICAgICBpc1N0YXRpYywKICAgICAgICAgIGdldExvYyhzdGFydCwgZW5kKSwKICAgICAgICAgIGlzU3RhdGljID8gMyA6IDAKICAgICAgICApOwogICAgICB9CiAgICB9LAogICAgb25kaXJtb2RpZmllcihzdGFydCwgZW5kKSB7CiAgICAgIGNvbnN0IG1vZCA9IGdldFNsaWNlKHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaW5WUHJlKSB7CiAgICAgICAgY3VycmVudFByb3AubmFtZSArPSAiLiIgKyBtb2Q7CiAgICAgICAgc2V0TG9jRW5kKGN1cnJlbnRQcm9wLm5hbWVMb2MsIGVuZCk7CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFByb3AubmFtZSA9PT0gInNsb3QiKSB7CiAgICAgICAgY29uc3QgYXJnID0gY3VycmVudFByb3AuYXJnOwogICAgICAgIGlmIChhcmcpIHsKICAgICAgICAgIGFyZy5jb250ZW50ICs9ICIuIiArIG1vZDsKICAgICAgICAgIHNldExvY0VuZChhcmcubG9jLCBlbmQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJyZW50UHJvcC5tb2RpZmllcnMucHVzaChtb2QpOwogICAgICB9CiAgICB9LAogICAgb25hdHRyaWJkYXRhKHN0YXJ0LCBlbmQpIHsKICAgICAgY3VycmVudEF0dHJWYWx1ZSArPSBnZXRTbGljZShzdGFydCwgZW5kKTsKICAgICAgaWYgKGN1cnJlbnRBdHRyU3RhcnRJbmRleCA8IDApCiAgICAgICAgY3VycmVudEF0dHJTdGFydEluZGV4ID0gc3RhcnQ7CiAgICAgIGN1cnJlbnRBdHRyRW5kSW5kZXggPSBlbmQ7CiAgICB9LAogICAgb25hdHRyaWJlbnRpdHkoY2hhciwgc3RhcnQsIGVuZCkgewogICAgICBjdXJyZW50QXR0clZhbHVlICs9IGNoYXI7CiAgICAgIGlmIChjdXJyZW50QXR0clN0YXJ0SW5kZXggPCAwKQogICAgICAgIGN1cnJlbnRBdHRyU3RhcnRJbmRleCA9IHN0YXJ0OwogICAgICBjdXJyZW50QXR0ckVuZEluZGV4ID0gZW5kOwogICAgfSwKICAgIG9uYXR0cmlibmFtZWVuZChlbmQpIHsKICAgICAgY29uc3Qgc3RhcnQgPSBjdXJyZW50UHJvcC5sb2Muc3RhcnQub2Zmc2V0OwogICAgICBjb25zdCBuYW1lID0gZ2V0U2xpY2Uoc3RhcnQsIGVuZCk7CiAgICAgIGlmIChjdXJyZW50UHJvcC50eXBlID09PSA3KSB7CiAgICAgICAgY3VycmVudFByb3AucmF3TmFtZSA9IG5hbWU7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnRPcGVuVGFnLnByb3BzLnNvbWUoCiAgICAgICAgKHApID0+IChwLnR5cGUgPT09IDcgPyBwLnJhd05hbWUgOiBwLm5hbWUpID09PSBuYW1lCiAgICAgICkpIHsKICAgICAgICBlbWl0RXJyb3IoMiwgc3RhcnQpOwogICAgICB9CiAgICB9LAogICAgb25hdHRyaWJlbmQocXVvdGUsIGVuZCkgewogICAgICBpZiAoY3VycmVudE9wZW5UYWcgJiYgY3VycmVudFByb3ApIHsKICAgICAgICBzZXRMb2NFbmQoY3VycmVudFByb3AubG9jLCBlbmQpOwogICAgICAgIGlmIChxdW90ZSAhPT0gMCkgewogICAgICAgICAgaWYgKGN1cnJlbnRBdHRyVmFsdWUuaW5jbHVkZXMoIiYiKSkgewogICAgICAgICAgICBjdXJyZW50QXR0clZhbHVlID0gY3VycmVudE9wdGlvbnMuZGVjb2RlRW50aXRpZXMoCiAgICAgICAgICAgICAgY3VycmVudEF0dHJWYWx1ZSwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFByb3AudHlwZSA9PT0gNikgewogICAgICAgICAgICBpZiAoY3VycmVudFByb3AubmFtZSA9PT0gImNsYXNzIikgewogICAgICAgICAgICAgIGN1cnJlbnRBdHRyVmFsdWUgPSBjb25kZW5zZShjdXJyZW50QXR0clZhbHVlKS50cmltKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHF1b3RlID09PSAxICYmICFjdXJyZW50QXR0clZhbHVlKSB7CiAgICAgICAgICAgICAgZW1pdEVycm9yKDEzLCBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRQcm9wLnZhbHVlID0gewogICAgICAgICAgICAgIHR5cGU6IDIsCiAgICAgICAgICAgICAgY29udGVudDogY3VycmVudEF0dHJWYWx1ZSwKICAgICAgICAgICAgICBsb2M6IHF1b3RlID09PSAxID8gZ2V0TG9jKGN1cnJlbnRBdHRyU3RhcnRJbmRleCwgY3VycmVudEF0dHJFbmRJbmRleCkgOiBnZXRMb2MoY3VycmVudEF0dHJTdGFydEluZGV4IC0gMSwgY3VycmVudEF0dHJFbmRJbmRleCArIDEpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0b2tlbml6ZXIuaW5TRkNSb290ICYmIGN1cnJlbnRPcGVuVGFnLnRhZyA9PT0gInRlbXBsYXRlIiAmJiBjdXJyZW50UHJvcC5uYW1lID09PSAibGFuZyIgJiYgY3VycmVudEF0dHJWYWx1ZSAmJiBjdXJyZW50QXR0clZhbHVlICE9PSAiaHRtbCIpIHsKICAgICAgICAgICAgICB0b2tlbml6ZXIuZW50ZXJSQ0RBVEEodG9DaGFyQ29kZXMoYDwvdGVtcGxhdGVgKSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBleHBQYXJzZU1vZGUgPSAwIC8qIE5vcm1hbCAqLzsKICAgICAgICAgICAgY3VycmVudFByb3AuZXhwID0gY3JlYXRlRXhwKAogICAgICAgICAgICAgIGN1cnJlbnRBdHRyVmFsdWUsCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgZ2V0TG9jKGN1cnJlbnRBdHRyU3RhcnRJbmRleCwgY3VycmVudEF0dHJFbmRJbmRleCksCiAgICAgICAgICAgICAgMCwKICAgICAgICAgICAgICBleHBQYXJzZU1vZGUKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRQcm9wLm5hbWUgPT09ICJmb3IiKSB7CiAgICAgICAgICAgICAgY3VycmVudFByb3AuZm9yUGFyc2VSZXN1bHQgPSBwYXJzZUZvckV4cHJlc3Npb24oY3VycmVudFByb3AuZXhwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY3VycmVudFByb3AudHlwZSAhPT0gNyB8fCBjdXJyZW50UHJvcC5uYW1lICE9PSAicHJlIikgewogICAgICAgICAgY3VycmVudE9wZW5UYWcucHJvcHMucHVzaChjdXJyZW50UHJvcCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGN1cnJlbnRBdHRyVmFsdWUgPSAiIjsKICAgICAgY3VycmVudEF0dHJTdGFydEluZGV4ID0gY3VycmVudEF0dHJFbmRJbmRleCA9IC0xOwogICAgfSwKICAgIG9uY29tbWVudChzdGFydCwgZW5kKSB7CiAgICAgIGlmIChjdXJyZW50T3B0aW9ucy5jb21tZW50cykgewogICAgICAgIGFkZE5vZGUoewogICAgICAgICAgdHlwZTogMywKICAgICAgICAgIGNvbnRlbnQ6IGdldFNsaWNlKHN0YXJ0LCBlbmQpLAogICAgICAgICAgbG9jOiBnZXRMb2Moc3RhcnQgLSA0LCBlbmQgKyAzKQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgb25lbmQoKSB7CiAgICAgIGNvbnN0IGVuZCA9IGN1cnJlbnRJbnB1dC5sZW5ndGg7CiAgICAgIGlmICh0b2tlbml6ZXIuc3RhdGUgIT09IDEpIHsKICAgICAgICBzd2l0Y2ggKHRva2VuaXplci5zdGF0ZSkgewogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBlbWl0RXJyb3IoNSwgZW5kKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIGVtaXRFcnJvcigKICAgICAgICAgICAgICAyNSwKICAgICAgICAgICAgICB0b2tlbml6ZXIuc2VjdGlvblN0YXJ0CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyODoKICAgICAgICAgICAgaWYgKHRva2VuaXplci5jdXJyZW50U2VxdWVuY2UgPT09IFNlcXVlbmNlcy5DZGF0YUVuZCkgewogICAgICAgICAgICAgIGVtaXRFcnJvcig2LCBlbmQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVtaXRFcnJvcig3LCBlbmQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgY2FzZSA5OgogICAgICAgICAgY2FzZSAxMToKICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgIGNhc2UgMTU6CiAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgY2FzZSAxNzoKICAgICAgICAgIGNhc2UgMTg6CiAgICAgICAgICBjYXNlIDE5OgogICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgIGVtaXRFcnJvcig5LCBlbmQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHN0YWNrLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIG9uQ2xvc2VUYWcoc3RhY2tbaW5kZXhdLCBlbmQgLSAxKTsKICAgICAgICBlbWl0RXJyb3IoMjQsIHN0YWNrW2luZGV4XS5sb2Muc3RhcnQub2Zmc2V0KTsKICAgICAgfQogICAgfSwKICAgIG9uY2RhdGEoc3RhcnQsIGVuZCkgewogICAgICBpZiAoc3RhY2tbMF0ubnMgIT09IDApIHsKICAgICAgICBvblRleHQoZ2V0U2xpY2Uoc3RhcnQsIGVuZCksIHN0YXJ0LCBlbmQpOwogICAgICB9IGVsc2UgewogICAgICAgIGVtaXRFcnJvcigxLCBzdGFydCAtIDkpOwogICAgICB9CiAgICB9LAogICAgb25wcm9jZXNzaW5naW5zdHJ1Y3Rpb24oc3RhcnQpIHsKICAgICAgaWYgKChzdGFja1swXSA/IHN0YWNrWzBdLm5zIDogY3VycmVudE9wdGlvbnMubnMpID09PSAwKSB7CiAgICAgICAgZW1pdEVycm9yKAogICAgICAgICAgMjEsCiAgICAgICAgICBzdGFydCAtIDEKICAgICAgICApOwogICAgICB9CiAgICB9CiAgfSk7CiAgY29uc3QgZm9ySXRlcmF0b3JSRSA9IC8sKFteLFx9XF1dKikoPzosKFteLFx9XF1dKikpPyQvOwogIGNvbnN0IHN0cmlwUGFyZW5zUkUgPSAvXlwofFwpJC9nOwogIGZ1bmN0aW9uIHBhcnNlRm9yRXhwcmVzc2lvbihpbnB1dCkgewogICAgY29uc3QgbG9jID0gaW5wdXQubG9jOwogICAgY29uc3QgZXhwID0gaW5wdXQuY29udGVudDsKICAgIGNvbnN0IGluTWF0Y2ggPSBleHAubWF0Y2goZm9yQWxpYXNSRSk7CiAgICBpZiAoIWluTWF0Y2gpCiAgICAgIHJldHVybjsKICAgIGNvbnN0IFssIExIUywgUkhTXSA9IGluTWF0Y2g7CiAgICBjb25zdCBjcmVhdGVBbGlhc0V4cHJlc3Npb24gPSAoY29udGVudCwgb2Zmc2V0LCBhc1BhcmFtID0gZmFsc2UpID0+IHsKICAgICAgY29uc3Qgc3RhcnQgPSBsb2Muc3RhcnQub2Zmc2V0ICsgb2Zmc2V0OwogICAgICBjb25zdCBlbmQgPSBzdGFydCArIGNvbnRlbnQubGVuZ3RoOwogICAgICByZXR1cm4gY3JlYXRlRXhwKAogICAgICAgIGNvbnRlbnQsCiAgICAgICAgZmFsc2UsCiAgICAgICAgZ2V0TG9jKHN0YXJ0LCBlbmQpLAogICAgICAgIDAsCiAgICAgICAgYXNQYXJhbSA/IDEgLyogUGFyYW1zICovIDogMCAvKiBOb3JtYWwgKi8KICAgICAgKTsKICAgIH07CiAgICBjb25zdCByZXN1bHQgPSB7CiAgICAgIHNvdXJjZTogY3JlYXRlQWxpYXNFeHByZXNzaW9uKFJIUy50cmltKCksIGV4cC5pbmRleE9mKFJIUywgTEhTLmxlbmd0aCkpLAogICAgICB2YWx1ZTogdm9pZCAwLAogICAgICBrZXk6IHZvaWQgMCwKICAgICAgaW5kZXg6IHZvaWQgMCwKICAgICAgZmluYWxpemVkOiBmYWxzZQogICAgfTsKICAgIGxldCB2YWx1ZUNvbnRlbnQgPSBMSFMudHJpbSgpLnJlcGxhY2Uoc3RyaXBQYXJlbnNSRSwgIiIpLnRyaW0oKTsKICAgIGNvbnN0IHRyaW1tZWRPZmZzZXQgPSBMSFMuaW5kZXhPZih2YWx1ZUNvbnRlbnQpOwogICAgY29uc3QgaXRlcmF0b3JNYXRjaCA9IHZhbHVlQ29udGVudC5tYXRjaChmb3JJdGVyYXRvclJFKTsKICAgIGlmIChpdGVyYXRvck1hdGNoKSB7CiAgICAgIHZhbHVlQ29udGVudCA9IHZhbHVlQ29udGVudC5yZXBsYWNlKGZvckl0ZXJhdG9yUkUsICIiKS50cmltKCk7CiAgICAgIGNvbnN0IGtleUNvbnRlbnQgPSBpdGVyYXRvck1hdGNoWzFdLnRyaW0oKTsKICAgICAgbGV0IGtleU9mZnNldDsKICAgICAgaWYgKGtleUNvbnRlbnQpIHsKICAgICAgICBrZXlPZmZzZXQgPSBleHAuaW5kZXhPZihrZXlDb250ZW50LCB0cmltbWVkT2Zmc2V0ICsgdmFsdWVDb250ZW50Lmxlbmd0aCk7CiAgICAgICAgcmVzdWx0LmtleSA9IGNyZWF0ZUFsaWFzRXhwcmVzc2lvbihrZXlDb250ZW50LCBrZXlPZmZzZXQsIHRydWUpOwogICAgICB9CiAgICAgIGlmIChpdGVyYXRvck1hdGNoWzJdKSB7CiAgICAgICAgY29uc3QgaW5kZXhDb250ZW50ID0gaXRlcmF0b3JNYXRjaFsyXS50cmltKCk7CiAgICAgICAgaWYgKGluZGV4Q29udGVudCkgewogICAgICAgICAgcmVzdWx0LmluZGV4ID0gY3JlYXRlQWxpYXNFeHByZXNzaW9uKAogICAgICAgICAgICBpbmRleENvbnRlbnQsCiAgICAgICAgICAgIGV4cC5pbmRleE9mKAogICAgICAgICAgICAgIGluZGV4Q29udGVudCwKICAgICAgICAgICAgICByZXN1bHQua2V5ID8ga2V5T2Zmc2V0ICsga2V5Q29udGVudC5sZW5ndGggOiB0cmltbWVkT2Zmc2V0ICsgdmFsdWVDb250ZW50Lmxlbmd0aAogICAgICAgICAgICApLAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHZhbHVlQ29udGVudCkgewogICAgICByZXN1bHQudmFsdWUgPSBjcmVhdGVBbGlhc0V4cHJlc3Npb24odmFsdWVDb250ZW50LCB0cmltbWVkT2Zmc2V0LCB0cnVlKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uIGdldFNsaWNlKHN0YXJ0LCBlbmQpIHsKICAgIHJldHVybiBjdXJyZW50SW5wdXQuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgfQogIGZ1bmN0aW9uIGVuZE9wZW5UYWcoZW5kKSB7CiAgICBpZiAodG9rZW5pemVyLmluU0ZDUm9vdCkgewogICAgICBjdXJyZW50T3BlblRhZy5pbm5lckxvYyA9IGdldExvYyhlbmQgKyAxLCBlbmQgKyAxKTsKICAgIH0KICAgIGFkZE5vZGUoY3VycmVudE9wZW5UYWcpOwogICAgY29uc3QgeyB0YWcsIG5zIH0gPSBjdXJyZW50T3BlblRhZzsKICAgIGlmIChucyA9PT0gMCAmJiBjdXJyZW50T3B0aW9ucy5pc1ByZVRhZyh0YWcpKSB7CiAgICAgIGluUHJlKys7CiAgICB9CiAgICBpZiAoY3VycmVudE9wdGlvbnMuaXNWb2lkVGFnKHRhZykpIHsKICAgICAgb25DbG9zZVRhZyhjdXJyZW50T3BlblRhZywgZW5kKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YWNrLnVuc2hpZnQoY3VycmVudE9wZW5UYWcpOwogICAgICBpZiAobnMgPT09IDEgfHwgbnMgPT09IDIpIHsKICAgICAgICB0b2tlbml6ZXIuaW5YTUwgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBjdXJyZW50T3BlblRhZyA9IG51bGw7CiAgfQogIGZ1bmN0aW9uIG9uVGV4dChjb250ZW50LCBzdGFydCwgZW5kKSB7CiAgICB2YXIgX2E7CiAgICB7CiAgICAgIGNvbnN0IHRhZyA9IChfYSA9IHN0YWNrWzBdKSA9PSBudWxsID8gdm9pZCAwIDogX2EudGFnOwogICAgICBpZiAodGFnICE9PSAic2NyaXB0IiAmJiB0YWcgIT09ICJzdHlsZSIgJiYgY29udGVudC5pbmNsdWRlcygiJiIpKSB7CiAgICAgICAgY29udGVudCA9IGN1cnJlbnRPcHRpb25zLmRlY29kZUVudGl0aWVzKGNvbnRlbnQsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgY29uc3QgcGFyZW50ID0gc3RhY2tbMF0gfHwgY3VycmVudFJvb3Q7CiAgICBjb25zdCBsYXN0Tm9kZSA9IHBhcmVudC5jaGlsZHJlbltwYXJlbnQuY2hpbGRyZW4ubGVuZ3RoIC0gMV07CiAgICBpZiAoKGxhc3ROb2RlID09IG51bGwgPyB2b2lkIDAgOiBsYXN0Tm9kZS50eXBlKSA9PT0gMikgewogICAgICBsYXN0Tm9kZS5jb250ZW50ICs9IGNvbnRlbnQ7CiAgICAgIHNldExvY0VuZChsYXN0Tm9kZS5sb2MsIGVuZCk7CiAgICB9IGVsc2UgewogICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaCh7CiAgICAgICAgdHlwZTogMiwKICAgICAgICBjb250ZW50LAogICAgICAgIGxvYzogZ2V0TG9jKHN0YXJ0LCBlbmQpCiAgICAgIH0pOwogICAgfQogIH0KICBmdW5jdGlvbiBvbkNsb3NlVGFnKGVsLCBlbmQsIGlzSW1wbGllZCA9IGZhbHNlKSB7CiAgICBpZiAoaXNJbXBsaWVkKSB7CiAgICAgIHNldExvY0VuZChlbC5sb2MsIGJhY2tUcmFjayhlbmQsIDYwKSk7CiAgICB9IGVsc2UgewogICAgICBzZXRMb2NFbmQoZWwubG9jLCBlbmQgKyAxKTsKICAgIH0KICAgIGlmICh0b2tlbml6ZXIuaW5TRkNSb290KSB7CiAgICAgIGlmIChlbC5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICBlbC5pbm5lckxvYy5lbmQgPSBleHRlbmQoe30sIGVsLmNoaWxkcmVuW2VsLmNoaWxkcmVuLmxlbmd0aCAtIDFdLmxvYy5lbmQpOwogICAgICB9IGVsc2UgewogICAgICAgIGVsLmlubmVyTG9jLmVuZCA9IGV4dGVuZCh7fSwgZWwuaW5uZXJMb2Muc3RhcnQpOwogICAgICB9CiAgICAgIGVsLmlubmVyTG9jLnNvdXJjZSA9IGdldFNsaWNlKAogICAgICAgIGVsLmlubmVyTG9jLnN0YXJ0Lm9mZnNldCwKICAgICAgICBlbC5pbm5lckxvYy5lbmQub2Zmc2V0CiAgICAgICk7CiAgICB9CiAgICBjb25zdCB7IHRhZywgbnMgfSA9IGVsOwogICAgaWYgKCFpblZQcmUpIHsKICAgICAgaWYgKHRhZyA9PT0gInNsb3QiKSB7CiAgICAgICAgZWwudGFnVHlwZSA9IDI7CiAgICAgIH0gZWxzZSBpZiAoaXNGcmFnbWVudFRlbXBsYXRlKGVsKSkgewogICAgICAgIGVsLnRhZ1R5cGUgPSAzOwogICAgICB9IGVsc2UgaWYgKGlzQ29tcG9uZW50KGVsKSkgewogICAgICAgIGVsLnRhZ1R5cGUgPSAxOwogICAgICB9CiAgICB9CiAgICBpZiAoIXRva2VuaXplci5pblJDREFUQSkgewogICAgICBlbC5jaGlsZHJlbiA9IGNvbmRlbnNlV2hpdGVzcGFjZShlbC5jaGlsZHJlbiwgZWwudGFnKTsKICAgIH0KICAgIGlmIChucyA9PT0gMCAmJiBjdXJyZW50T3B0aW9ucy5pc1ByZVRhZyh0YWcpKSB7CiAgICAgIGluUHJlLS07CiAgICB9CiAgICBpZiAoY3VycmVudFZQcmVCb3VuZGFyeSA9PT0gZWwpIHsKICAgICAgaW5WUHJlID0gdG9rZW5pemVyLmluVlByZSA9IGZhbHNlOwogICAgICBjdXJyZW50VlByZUJvdW5kYXJ5ID0gbnVsbDsKICAgIH0KICAgIGlmICh0b2tlbml6ZXIuaW5YTUwgJiYgKHN0YWNrWzBdID8gc3RhY2tbMF0ubnMgOiBjdXJyZW50T3B0aW9ucy5ucykgPT09IDApIHsKICAgICAgdG9rZW5pemVyLmluWE1MID0gZmFsc2U7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGJhY2tUcmFjayhpbmRleCwgYykgewogICAgbGV0IGkgPSBpbmRleDsKICAgIHdoaWxlIChjdXJyZW50SW5wdXQuY2hhckNvZGVBdChpKSAhPT0gYyAmJiBpID49IDApCiAgICAgIGktLTsKICAgIHJldHVybiBpOwogIH0KICBjb25zdCBzcGVjaWFsVGVtcGxhdGVEaXIgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImlmIiwgImVsc2UiLCAiZWxzZS1pZiIsICJmb3IiLCAic2xvdCJdKTsKICBmdW5jdGlvbiBpc0ZyYWdtZW50VGVtcGxhdGUoeyB0YWcsIHByb3BzIH0pIHsKICAgIGlmICh0YWcgPT09ICJ0ZW1wbGF0ZSIpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChwcm9wc1tpXS50eXBlID09PSA3ICYmIHNwZWNpYWxUZW1wbGF0ZURpci5oYXMocHJvcHNbaV0ubmFtZSkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICBmdW5jdGlvbiBpc0NvbXBvbmVudCh7IHRhZywgcHJvcHMgfSkgewogICAgdmFyIF9hOwogICAgaWYgKGN1cnJlbnRPcHRpb25zLmlzQ3VzdG9tRWxlbWVudCh0YWcpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmICh0YWcgPT09ICJjb21wb25lbnQiIHx8IGlzVXBwZXJDYXNlKHRhZy5jaGFyQ29kZUF0KDApKSB8fCBpc0NvcmVDb21wb25lbnQodGFnKSB8fCAoKF9hID0gY3VycmVudE9wdGlvbnMuaXNCdWlsdEluQ29tcG9uZW50KSA9PSBudWxsID8gdm9pZCAwIDogX2EuY2FsbChjdXJyZW50T3B0aW9ucywgdGFnKSkgfHwgY3VycmVudE9wdGlvbnMuaXNOYXRpdmVUYWcgJiYgIWN1cnJlbnRPcHRpb25zLmlzTmF0aXZlVGFnKHRhZykpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHAgPSBwcm9wc1tpXTsKICAgICAgaWYgKHAudHlwZSA9PT0gNikgewogICAgICAgIGlmIChwLm5hbWUgPT09ICJpcyIgJiYgcC52YWx1ZSkgewogICAgICAgICAgaWYgKHAudmFsdWUuY29udGVudC5zdGFydHNXaXRoKCJ2dWU6IikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGlzVXBwZXJDYXNlKGMpIHsKICAgIHJldHVybiBjID4gNjQgJiYgYyA8IDkxOwogIH0KICBjb25zdCB3aW5kb3dzTmV3bGluZVJFID0gL1xyXG4vZzsKICBmdW5jdGlvbiBjb25kZW5zZVdoaXRlc3BhY2Uobm9kZXMsIHRhZykgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IHNob3VsZENvbmRlbnNlID0gY3VycmVudE9wdGlvbnMud2hpdGVzcGFjZSAhPT0gInByZXNlcnZlIjsKICAgIGxldCByZW1vdmVkV2hpdGVzcGFjZSA9IGZhbHNlOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBub2RlID0gbm9kZXNbaV07CiAgICAgIGlmIChub2RlLnR5cGUgPT09IDIpIHsKICAgICAgICBpZiAoIWluUHJlKSB7CiAgICAgICAgICBpZiAoaXNBbGxXaGl0ZXNwYWNlKG5vZGUuY29udGVudCkpIHsKICAgICAgICAgICAgY29uc3QgcHJldiA9IChfYSA9IG5vZGVzW2kgLSAxXSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLnR5cGU7CiAgICAgICAgICAgIGNvbnN0IG5leHQgPSAoX2IgPSBub2Rlc1tpICsgMV0pID09IG51bGwgPyB2b2lkIDAgOiBfYi50eXBlOwogICAgICAgICAgICBpZiAoIXByZXYgfHwgIW5leHQgfHwgc2hvdWxkQ29uZGVuc2UgJiYgKHByZXYgPT09IDMgJiYgKG5leHQgPT09IDMgfHwgbmV4dCA9PT0gMSkgfHwgcHJldiA9PT0gMSAmJiAobmV4dCA9PT0gMyB8fCBuZXh0ID09PSAxICYmIGhhc05ld2xpbmVDaGFyKG5vZGUuY29udGVudCkpKSkgewogICAgICAgICAgICAgIHJlbW92ZWRXaGl0ZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgICAgICBub2Rlc1tpXSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbm9kZS5jb250ZW50ID0gIiAiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZENvbmRlbnNlKSB7CiAgICAgICAgICAgIG5vZGUuY29udGVudCA9IGNvbmRlbnNlKG5vZGUuY29udGVudCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5vZGUuY29udGVudCA9IG5vZGUuY29udGVudC5yZXBsYWNlKHdpbmRvd3NOZXdsaW5lUkUsICJcbiIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGluUHJlICYmIHRhZyAmJiBjdXJyZW50T3B0aW9ucy5pc1ByZVRhZyh0YWcpKSB7CiAgICAgIGNvbnN0IGZpcnN0ID0gbm9kZXNbMF07CiAgICAgIGlmIChmaXJzdCAmJiBmaXJzdC50eXBlID09PSAyKSB7CiAgICAgICAgZmlyc3QuY29udGVudCA9IGZpcnN0LmNvbnRlbnQucmVwbGFjZSgvXlxyP1xuLywgIiIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVtb3ZlZFdoaXRlc3BhY2UgPyBub2Rlcy5maWx0ZXIoQm9vbGVhbikgOiBub2RlczsKICB9CiAgZnVuY3Rpb24gaXNBbGxXaGl0ZXNwYWNlKHN0cikgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFpc1doaXRlc3BhY2Uoc3RyLmNoYXJDb2RlQXQoaSkpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gaGFzTmV3bGluZUNoYXIoc3RyKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgICAgIGlmIChjID09PSAxMCB8fCBjID09PSAxMykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGNvbmRlbnNlKHN0cikgewogICAgbGV0IHJldCA9ICIiOwogICAgbGV0IHByZXZDaGFySXNXaGl0ZXNwYWNlID0gZmFsc2U7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgICBpZiAoaXNXaGl0ZXNwYWNlKHN0ci5jaGFyQ29kZUF0KGkpKSkgewogICAgICAgIGlmICghcHJldkNoYXJJc1doaXRlc3BhY2UpIHsKICAgICAgICAgIHJldCArPSAiICI7CiAgICAgICAgICBwcmV2Q2hhcklzV2hpdGVzcGFjZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldCArPSBzdHJbaV07CiAgICAgICAgcHJldkNoYXJJc1doaXRlc3BhY2UgPSBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldDsKICB9CiAgZnVuY3Rpb24gYWRkTm9kZShub2RlKSB7CiAgICAoc3RhY2tbMF0gfHwgY3VycmVudFJvb3QpLmNoaWxkcmVuLnB1c2gobm9kZSk7CiAgfQogIGZ1bmN0aW9uIGdldExvYyhzdGFydCwgZW5kKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogdG9rZW5pemVyLmdldFBvcyhzdGFydCksCiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgYWxsb3cgbGF0ZSBhdHRhY2htZW50CiAgICAgIGVuZDogZW5kID09IG51bGwgPyBlbmQgOiB0b2tlbml6ZXIuZ2V0UG9zKGVuZCksCiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgYWxsb3cgbGF0ZSBhdHRhY2htZW50CiAgICAgIHNvdXJjZTogZW5kID09IG51bGwgPyBlbmQgOiBnZXRTbGljZShzdGFydCwgZW5kKQogICAgfTsKICB9CiAgZnVuY3Rpb24gc2V0TG9jRW5kKGxvYywgZW5kKSB7CiAgICBsb2MuZW5kID0gdG9rZW5pemVyLmdldFBvcyhlbmQpOwogICAgbG9jLnNvdXJjZSA9IGdldFNsaWNlKGxvYy5zdGFydC5vZmZzZXQsIGVuZCk7CiAgfQogIGZ1bmN0aW9uIGRpclRvQXR0cihkaXIpIHsKICAgIGNvbnN0IGF0dHIgPSB7CiAgICAgIHR5cGU6IDYsCiAgICAgIG5hbWU6IGRpci5yYXdOYW1lLAogICAgICBuYW1lTG9jOiBnZXRMb2MoCiAgICAgICAgZGlyLmxvYy5zdGFydC5vZmZzZXQsCiAgICAgICAgZGlyLmxvYy5zdGFydC5vZmZzZXQgKyBkaXIucmF3TmFtZS5sZW5ndGgKICAgICAgKSwKICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgbG9jOiBkaXIubG9jCiAgICB9OwogICAgaWYgKGRpci5leHApIHsKICAgICAgY29uc3QgbG9jID0gZGlyLmV4cC5sb2M7CiAgICAgIGlmIChsb2MuZW5kLm9mZnNldCA8IGRpci5sb2MuZW5kLm9mZnNldCkgewogICAgICAgIGxvYy5zdGFydC5vZmZzZXQtLTsKICAgICAgICBsb2Muc3RhcnQuY29sdW1uLS07CiAgICAgICAgbG9jLmVuZC5vZmZzZXQrKzsKICAgICAgICBsb2MuZW5kLmNvbHVtbisrOwogICAgICB9CiAgICAgIGF0dHIudmFsdWUgPSB7CiAgICAgICAgdHlwZTogMiwKICAgICAgICBjb250ZW50OiBkaXIuZXhwLmNvbnRlbnQsCiAgICAgICAgbG9jCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gYXR0cjsKICB9CiAgZnVuY3Rpb24gY3JlYXRlRXhwKGNvbnRlbnQsIGlzU3RhdGljID0gZmFsc2UsIGxvYywgY29uc3RUeXBlID0gMCwgcGFyc2VNb2RlID0gMCAvKiBOb3JtYWwgKi8pIHsKICAgIGNvbnN0IGV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oY29udGVudCwgaXNTdGF0aWMsIGxvYywgY29uc3RUeXBlKTsKICAgIHJldHVybiBleHA7CiAgfQogIGZ1bmN0aW9uIGVtaXRFcnJvcihjb2RlLCBpbmRleCwgbWVzc2FnZSkgewogICAgY3VycmVudE9wdGlvbnMub25FcnJvcigKICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcihjb2RlLCBnZXRMb2MoaW5kZXgsIGluZGV4KSwgdm9pZCAwLCBtZXNzYWdlKQogICAgKTsKICB9CiAgZnVuY3Rpb24gcmVzZXQoKSB7CiAgICB0b2tlbml6ZXIucmVzZXQoKTsKICAgIGN1cnJlbnRPcGVuVGFnID0gbnVsbDsKICAgIGN1cnJlbnRQcm9wID0gbnVsbDsKICAgIGN1cnJlbnRBdHRyVmFsdWUgPSAiIjsKICAgIGN1cnJlbnRBdHRyU3RhcnRJbmRleCA9IC0xOwogICAgY3VycmVudEF0dHJFbmRJbmRleCA9IC0xOwogICAgc3RhY2subGVuZ3RoID0gMDsKICB9CiAgZnVuY3Rpb24gYmFzZVBhcnNlKGlucHV0LCBvcHRpb25zKSB7CiAgICByZXNldCgpOwogICAgY3VycmVudElucHV0ID0gaW5wdXQ7CiAgICBjdXJyZW50T3B0aW9ucyA9IGV4dGVuZCh7fSwgZGVmYXVsdFBhcnNlck9wdGlvbnMpOwogICAgaWYgKG9wdGlvbnMpIHsKICAgICAgbGV0IGtleTsKICAgICAgZm9yIChrZXkgaW4gb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zW2tleV0gIT0gbnVsbCkgewogICAgICAgICAgY3VycmVudE9wdGlvbnNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHsKICAgICAgaWYgKCFjdXJyZW50T3B0aW9ucy5kZWNvZGVFbnRpdGllcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgIGBbQHZ1ZS9jb21waWxlci1jb3JlXSBkZWNvZGVFbnRpdGllcyBvcHRpb24gaXMgcmVxdWlyZWQgaW4gYnJvd3NlciBidWlsZHMuYAogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHRva2VuaXplci5tb2RlID0gY3VycmVudE9wdGlvbnMucGFyc2VNb2RlID09PSAiaHRtbCIgPyAxIDogY3VycmVudE9wdGlvbnMucGFyc2VNb2RlID09PSAic2ZjIiA/IDIgOiAwOwogICAgdG9rZW5pemVyLmluWE1MID0gY3VycmVudE9wdGlvbnMubnMgPT09IDEgfHwgY3VycmVudE9wdGlvbnMubnMgPT09IDI7CiAgICBjb25zdCBkZWxpbWl0ZXJzID0gb3B0aW9ucyA9PSBudWxsID8gdm9pZCAwIDogb3B0aW9ucy5kZWxpbWl0ZXJzOwogICAgaWYgKGRlbGltaXRlcnMpIHsKICAgICAgdG9rZW5pemVyLmRlbGltaXRlck9wZW4gPSB0b0NoYXJDb2RlcyhkZWxpbWl0ZXJzWzBdKTsKICAgICAgdG9rZW5pemVyLmRlbGltaXRlckNsb3NlID0gdG9DaGFyQ29kZXMoZGVsaW1pdGVyc1sxXSk7CiAgICB9CiAgICBjb25zdCByb290ID0gY3VycmVudFJvb3QgPSBjcmVhdGVSb290KFtdLCBpbnB1dCk7CiAgICB0b2tlbml6ZXIucGFyc2UoY3VycmVudElucHV0KTsKICAgIHJvb3QubG9jID0gZ2V0TG9jKDAsIGlucHV0Lmxlbmd0aCk7CiAgICByb290LmNoaWxkcmVuID0gY29uZGVuc2VXaGl0ZXNwYWNlKHJvb3QuY2hpbGRyZW4pOwogICAgY3VycmVudFJvb3QgPSBudWxsOwogICAgcmV0dXJuIHJvb3Q7CiAgfQoKICBmdW5jdGlvbiBob2lzdFN0YXRpYyhyb290LCBjb250ZXh0KSB7CiAgICB3YWxrKAogICAgICByb290LAogICAgICBjb250ZXh0LAogICAgICAvLyBSb290IG5vZGUgaXMgdW5mb3J0dW5hdGVseSBub24taG9pc3RhYmxlIGR1ZSB0byBwb3RlbnRpYWwgcGFyZW50CiAgICAgIC8vIGZhbGx0aHJvdWdoIGF0dHJpYnV0ZXMuCiAgICAgIGlzU2luZ2xlRWxlbWVudFJvb3Qocm9vdCwgcm9vdC5jaGlsZHJlblswXSkKICAgICk7CiAgfQogIGZ1bmN0aW9uIGlzU2luZ2xlRWxlbWVudFJvb3Qocm9vdCwgY2hpbGQpIHsKICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IHJvb3Q7CiAgICByZXR1cm4gY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmIGNoaWxkLnR5cGUgPT09IDEgJiYgIWlzU2xvdE91dGxldChjaGlsZCk7CiAgfQogIGZ1bmN0aW9uIHdhbGsobm9kZSwgY29udGV4dCwgZG9Ob3RIb2lzdE5vZGUgPSBmYWxzZSkgewogICAgY29uc3QgeyBjaGlsZHJlbiB9ID0gbm9kZTsKICAgIGNvbnN0IG9yaWdpbmFsQ291bnQgPSBjaGlsZHJlbi5sZW5ndGg7CiAgICBsZXQgaG9pc3RlZENvdW50ID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgaWYgKGNoaWxkLnR5cGUgPT09IDEgJiYgY2hpbGQudGFnVHlwZSA9PT0gMCkgewogICAgICAgIGNvbnN0IGNvbnN0YW50VHlwZSA9IGRvTm90SG9pc3ROb2RlID8gMCA6IGdldENvbnN0YW50VHlwZShjaGlsZCwgY29udGV4dCk7CiAgICAgICAgaWYgKGNvbnN0YW50VHlwZSA+IDApIHsKICAgICAgICAgIGlmIChjb25zdGFudFR5cGUgPj0gMikgewogICAgICAgICAgICBjaGlsZC5jb2RlZ2VuTm9kZS5wYXRjaEZsYWcgPSAtMSArIChgIC8qIEhPSVNURUQgKi9gICk7CiAgICAgICAgICAgIGNoaWxkLmNvZGVnZW5Ob2RlID0gY29udGV4dC5ob2lzdChjaGlsZC5jb2RlZ2VuTm9kZSk7CiAgICAgICAgICAgIGhvaXN0ZWRDb3VudCsrOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBjaGlsZC5jb2RlZ2VuTm9kZTsKICAgICAgICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlID09PSAxMykgewogICAgICAgICAgICBjb25zdCBmbGFnID0gZ2V0UGF0Y2hGbGFnKGNvZGVnZW5Ob2RlKTsKICAgICAgICAgICAgaWYgKCghZmxhZyB8fCBmbGFnID09PSA1MTIgfHwgZmxhZyA9PT0gMSkgJiYgZ2V0R2VuZXJhdGVkUHJvcHNDb25zdGFudFR5cGUoY2hpbGQsIGNvbnRleHQpID49IDIpIHsKICAgICAgICAgICAgICBjb25zdCBwcm9wcyA9IGdldE5vZGVQcm9wcyhjaGlsZCk7CiAgICAgICAgICAgICAgaWYgKHByb3BzKSB7CiAgICAgICAgICAgICAgICBjb2RlZ2VuTm9kZS5wcm9wcyA9IGNvbnRleHQuaG9pc3QocHJvcHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29kZWdlbk5vZGUuZHluYW1pY1Byb3BzKSB7CiAgICAgICAgICAgICAgY29kZWdlbk5vZGUuZHluYW1pY1Byb3BzID0gY29udGV4dC5ob2lzdChjb2RlZ2VuTm9kZS5keW5hbWljUHJvcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChjaGlsZC50eXBlID09PSAxKSB7CiAgICAgICAgY29uc3QgaXNDb21wb25lbnQgPSBjaGlsZC50YWdUeXBlID09PSAxOwogICAgICAgIGlmIChpc0NvbXBvbmVudCkgewogICAgICAgICAgY29udGV4dC5zY29wZXMudlNsb3QrKzsKICAgICAgICB9CiAgICAgICAgd2FsayhjaGlsZCwgY29udGV4dCk7CiAgICAgICAgaWYgKGlzQ29tcG9uZW50KSB7CiAgICAgICAgICBjb250ZXh0LnNjb3Blcy52U2xvdC0tOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjaGlsZC50eXBlID09PSAxMSkgewogICAgICAgIHdhbGsoY2hpbGQsIGNvbnRleHQsIGNoaWxkLmNoaWxkcmVuLmxlbmd0aCA9PT0gMSk7CiAgICAgIH0gZWxzZSBpZiAoY2hpbGQudHlwZSA9PT0gOSkgewogICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBjaGlsZC5icmFuY2hlcy5sZW5ndGg7IGkyKyspIHsKICAgICAgICAgIHdhbGsoCiAgICAgICAgICAgIGNoaWxkLmJyYW5jaGVzW2kyXSwKICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgY2hpbGQuYnJhbmNoZXNbaTJdLmNoaWxkcmVuLmxlbmd0aCA9PT0gMQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChob2lzdGVkQ291bnQgJiYgY29udGV4dC50cmFuc2Zvcm1Ib2lzdCkgewogICAgICBjb250ZXh0LnRyYW5zZm9ybUhvaXN0KGNoaWxkcmVuLCBjb250ZXh0LCBub2RlKTsKICAgIH0KICAgIGlmIChob2lzdGVkQ291bnQgJiYgaG9pc3RlZENvdW50ID09PSBvcmlnaW5hbENvdW50ICYmIG5vZGUudHlwZSA9PT0gMSAmJiBub2RlLnRhZ1R5cGUgPT09IDAgJiYgbm9kZS5jb2RlZ2VuTm9kZSAmJiBub2RlLmNvZGVnZW5Ob2RlLnR5cGUgPT09IDEzICYmIGlzQXJyYXkobm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbikpIHsKICAgICAgY29uc3QgaG9pc3RlZCA9IGNvbnRleHQuaG9pc3QoCiAgICAgICAgY3JlYXRlQXJyYXlFeHByZXNzaW9uKG5vZGUuY29kZWdlbk5vZGUuY2hpbGRyZW4pCiAgICAgICk7CiAgICAgIGlmIChjb250ZXh0LmhtcikgewogICAgICAgIGhvaXN0ZWQuY29udGVudCA9IGBbLi4uJHtob2lzdGVkLmNvbnRlbnR9XWA7CiAgICAgIH0KICAgICAgbm9kZS5jb2RlZ2VuTm9kZS5jaGlsZHJlbiA9IGhvaXN0ZWQ7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldENvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7CiAgICBjb25zdCB7IGNvbnN0YW50Q2FjaGUgfSA9IGNvbnRleHQ7CiAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICBjYXNlIDE6CiAgICAgICAgaWYgKG5vZGUudGFnVHlwZSAhPT0gMCkgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNhY2hlZCA9IGNvbnN0YW50Q2FjaGUuZ2V0KG5vZGUpOwogICAgICAgIGlmIChjYWNoZWQgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIGNhY2hlZDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29kZWdlbk5vZGUgPSBub2RlLmNvZGVnZW5Ob2RlOwogICAgICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlICE9PSAxMykgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGlmIChjb2RlZ2VuTm9kZS5pc0Jsb2NrICYmIG5vZGUudGFnICE9PSAic3ZnIiAmJiBub2RlLnRhZyAhPT0gImZvcmVpZ25PYmplY3QiKSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZmxhZyA9IGdldFBhdGNoRmxhZyhjb2RlZ2VuTm9kZSk7CiAgICAgICAgaWYgKCFmbGFnKSB7CiAgICAgICAgICBsZXQgcmV0dXJuVHlwZTIgPSAzOwogICAgICAgICAgY29uc3QgZ2VuZXJhdGVkUHJvcHNUeXBlID0gZ2V0R2VuZXJhdGVkUHJvcHNDb25zdGFudFR5cGUobm9kZSwgY29udGV4dCk7CiAgICAgICAgICBpZiAoZ2VuZXJhdGVkUHJvcHNUeXBlID09PSAwKSB7CiAgICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIDApOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZW5lcmF0ZWRQcm9wc1R5cGUgPCByZXR1cm5UeXBlMikgewogICAgICAgICAgICByZXR1cm5UeXBlMiA9IGdlbmVyYXRlZFByb3BzVHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBjaGlsZFR5cGUgPSBnZXRDb25zdGFudFR5cGUobm9kZS5jaGlsZHJlbltpXSwgY29udGV4dCk7CiAgICAgICAgICAgIGlmIChjaGlsZFR5cGUgPT09IDApIHsKICAgICAgICAgICAgICBjb25zdGFudENhY2hlLnNldChub2RlLCAwKTsKICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hpbGRUeXBlIDwgcmV0dXJuVHlwZTIpIHsKICAgICAgICAgICAgICByZXR1cm5UeXBlMiA9IGNoaWxkVHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHVyblR5cGUyID4gMSkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUucHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjb25zdCBwID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICAgICAgICBpZiAocC50eXBlID09PSA3ICYmIHAubmFtZSA9PT0gImJpbmQiICYmIHAuZXhwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBleHBUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKHAuZXhwLCBjb250ZXh0KTsKICAgICAgICAgICAgICAgIGlmIChleHBUeXBlID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIDApOwogICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleHBUeXBlIDwgcmV0dXJuVHlwZTIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuVHlwZTIgPSBleHBUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvZGVnZW5Ob2RlLmlzQmxvY2spIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgcCA9IG5vZGUucHJvcHNbaV07CiAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PT0gNykgewogICAgICAgICAgICAgICAgY29uc3RhbnRDYWNoZS5zZXQobm9kZSwgMCk7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29udGV4dC5yZW1vdmVIZWxwZXIoT1BFTl9CTE9DSyk7CiAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlSGVscGVyKAogICAgICAgICAgICAgIGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgY29kZWdlbk5vZGUuaXNDb21wb25lbnQpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvZGVnZW5Ob2RlLmlzQmxvY2sgPSBmYWxzZTsKICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY29kZWdlbk5vZGUuaXNDb21wb25lbnQpKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0YW50Q2FjaGUuc2V0KG5vZGUsIHJldHVyblR5cGUyKTsKICAgICAgICAgIHJldHVybiByZXR1cm5UeXBlMjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc3RhbnRDYWNoZS5zZXQobm9kZSwgMCk7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgIGNhc2UgMjoKICAgICAgY2FzZSAzOgogICAgICAgIHJldHVybiAzOwogICAgICBjYXNlIDk6CiAgICAgIGNhc2UgMTE6CiAgICAgIGNhc2UgMTA6CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIGNhc2UgNToKICAgICAgY2FzZSAxMjoKICAgICAgICByZXR1cm4gZ2V0Q29uc3RhbnRUeXBlKG5vZGUuY29udGVudCwgY29udGV4dCk7CiAgICAgIGNhc2UgNDoKICAgICAgICByZXR1cm4gbm9kZS5jb25zdFR5cGU7CiAgICAgIGNhc2UgODoKICAgICAgICBsZXQgcmV0dXJuVHlwZSA9IDM7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgICBpZiAoaXNTdHJpbmcoY2hpbGQpIHx8IGlzU3ltYm9sKGNoaWxkKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNoaWxkVHlwZSA9IGdldENvbnN0YW50VHlwZShjaGlsZCwgY29udGV4dCk7CiAgICAgICAgICBpZiAoY2hpbGRUeXBlID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZFR5cGUgPCByZXR1cm5UeXBlKSB7CiAgICAgICAgICAgIHJldHVyblR5cGUgPSBjaGlsZFR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXR1cm5UeXBlOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAwOwogICAgfQogIH0KICBjb25zdCBhbGxvd0hvaXN0ZWRIZWxwZXJTZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbCiAgICBOT1JNQUxJWkVfQ0xBU1MsCiAgICBOT1JNQUxJWkVfU1RZTEUsCiAgICBOT1JNQUxJWkVfUFJPUFMsCiAgICBHVUFSRF9SRUFDVElWRV9QUk9QUwogIF0pOwogIGZ1bmN0aW9uIGdldENvbnN0YW50VHlwZU9mSGVscGVyQ2FsbCh2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHZhbHVlLnR5cGUgPT09IDE0ICYmICFpc1N0cmluZyh2YWx1ZS5jYWxsZWUpICYmIGFsbG93SG9pc3RlZEhlbHBlclNldC5oYXModmFsdWUuY2FsbGVlKSkgewogICAgICBjb25zdCBhcmcgPSB2YWx1ZS5hcmd1bWVudHNbMF07CiAgICAgIGlmIChhcmcudHlwZSA9PT0gNCkgewogICAgICAgIHJldHVybiBnZXRDb25zdGFudFR5cGUoYXJnLCBjb250ZXh0KTsKICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gMTQpIHsKICAgICAgICByZXR1cm4gZ2V0Q29uc3RhbnRUeXBlT2ZIZWxwZXJDYWxsKGFyZywgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAwOwogIH0KICBmdW5jdGlvbiBnZXRHZW5lcmF0ZWRQcm9wc0NvbnN0YW50VHlwZShub2RlLCBjb250ZXh0KSB7CiAgICBsZXQgcmV0dXJuVHlwZSA9IDM7CiAgICBjb25zdCBwcm9wcyA9IGdldE5vZGVQcm9wcyhub2RlKTsKICAgIGlmIChwcm9wcyAmJiBwcm9wcy50eXBlID09PSAxNSkgewogICAgICBjb25zdCB7IHByb3BlcnRpZXMgfSA9IHByb3BzOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByb3BlcnRpZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB7IGtleSwgdmFsdWUgfSA9IHByb3BlcnRpZXNbaV07CiAgICAgICAgY29uc3Qga2V5VHlwZSA9IGdldENvbnN0YW50VHlwZShrZXksIGNvbnRleHQpOwogICAgICAgIGlmIChrZXlUeXBlID09PSAwKSB7CiAgICAgICAgICByZXR1cm4ga2V5VHlwZTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleVR5cGUgPCByZXR1cm5UeXBlKSB7CiAgICAgICAgICByZXR1cm5UeXBlID0ga2V5VHlwZTsKICAgICAgICB9CiAgICAgICAgbGV0IHZhbHVlVHlwZTsKICAgICAgICBpZiAodmFsdWUudHlwZSA9PT0gNCkgewogICAgICAgICAgdmFsdWVUeXBlID0gZ2V0Q29uc3RhbnRUeXBlKHZhbHVlLCBjb250ZXh0KTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLnR5cGUgPT09IDE0KSB7CiAgICAgICAgICB2YWx1ZVR5cGUgPSBnZXRDb25zdGFudFR5cGVPZkhlbHBlckNhbGwodmFsdWUsIGNvbnRleHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWx1ZVR5cGUgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWVUeXBlID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWVUeXBlOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWVUeXBlIDwgcmV0dXJuVHlwZSkgewogICAgICAgICAgcmV0dXJuVHlwZSA9IHZhbHVlVHlwZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXR1cm5UeXBlOwogIH0KICBmdW5jdGlvbiBnZXROb2RlUHJvcHMobm9kZSkgewogICAgY29uc3QgY29kZWdlbk5vZGUgPSBub2RlLmNvZGVnZW5Ob2RlOwogICAgaWYgKGNvZGVnZW5Ob2RlLnR5cGUgPT09IDEzKSB7CiAgICAgIHJldHVybiBjb2RlZ2VuTm9kZS5wcm9wczsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0UGF0Y2hGbGFnKG5vZGUpIHsKICAgIGNvbnN0IGZsYWcgPSBub2RlLnBhdGNoRmxhZzsKICAgIHJldHVybiBmbGFnID8gcGFyc2VJbnQoZmxhZywgMTApIDogdm9pZCAwOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVHJhbnNmb3JtQ29udGV4dChyb290LCB7CiAgICBmaWxlbmFtZSA9ICIiLAogICAgcHJlZml4SWRlbnRpZmllcnMgPSBmYWxzZSwKICAgIGhvaXN0U3RhdGljOiBob2lzdFN0YXRpYzIgPSBmYWxzZSwKICAgIGhtciA9IGZhbHNlLAogICAgY2FjaGVIYW5kbGVycyA9IGZhbHNlLAogICAgbm9kZVRyYW5zZm9ybXMgPSBbXSwKICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXMgPSB7fSwKICAgIHRyYW5zZm9ybUhvaXN0ID0gbnVsbCwKICAgIGlzQnVpbHRJbkNvbXBvbmVudCA9IE5PT1AsCiAgICBpc0N1c3RvbUVsZW1lbnQgPSBOT09QLAogICAgZXhwcmVzc2lvblBsdWdpbnMgPSBbXSwKICAgIHNjb3BlSWQgPSBudWxsLAogICAgc2xvdHRlZCA9IHRydWUsCiAgICBzc3IgPSBmYWxzZSwKICAgIGluU1NSID0gZmFsc2UsCiAgICBzc3JDc3NWYXJzID0gYGAsCiAgICBiaW5kaW5nTWV0YWRhdGEgPSBFTVBUWV9PQkosCiAgICBpbmxpbmUgPSBmYWxzZSwKICAgIGlzVFMgPSBmYWxzZSwKICAgIG9uRXJyb3IgPSBkZWZhdWx0T25FcnJvciwKICAgIG9uV2FybiA9IGRlZmF1bHRPbldhcm4sCiAgICBjb21wYXRDb25maWcKICB9KSB7CiAgICBjb25zdCBuYW1lTWF0Y2ggPSBmaWxlbmFtZS5yZXBsYWNlKC9cPy4qJC8sICIiKS5tYXRjaCgvKFteL1xcXSspXC5cdyskLyk7CiAgICBjb25zdCBjb250ZXh0ID0gewogICAgICAvLyBvcHRpb25zCiAgICAgIGZpbGVuYW1lLAogICAgICBzZWxmTmFtZTogbmFtZU1hdGNoICYmIGNhcGl0YWxpemUoY2FtZWxpemUobmFtZU1hdGNoWzFdKSksCiAgICAgIHByZWZpeElkZW50aWZpZXJzLAogICAgICBob2lzdFN0YXRpYzogaG9pc3RTdGF0aWMyLAogICAgICBobXIsCiAgICAgIGNhY2hlSGFuZGxlcnMsCiAgICAgIG5vZGVUcmFuc2Zvcm1zLAogICAgICBkaXJlY3RpdmVUcmFuc2Zvcm1zLAogICAgICB0cmFuc2Zvcm1Ib2lzdCwKICAgICAgaXNCdWlsdEluQ29tcG9uZW50LAogICAgICBpc0N1c3RvbUVsZW1lbnQsCiAgICAgIGV4cHJlc3Npb25QbHVnaW5zLAogICAgICBzY29wZUlkLAogICAgICBzbG90dGVkLAogICAgICBzc3IsCiAgICAgIGluU1NSLAogICAgICBzc3JDc3NWYXJzLAogICAgICBiaW5kaW5nTWV0YWRhdGEsCiAgICAgIGlubGluZSwKICAgICAgaXNUUywKICAgICAgb25FcnJvciwKICAgICAgb25XYXJuLAogICAgICBjb21wYXRDb25maWcsCiAgICAgIC8vIHN0YXRlCiAgICAgIHJvb3QsCiAgICAgIGhlbHBlcnM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksCiAgICAgIGNvbXBvbmVudHM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICAgIGRpcmVjdGl2ZXM6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICAgIGhvaXN0czogW10sCiAgICAgIGltcG9ydHM6IFtdLAogICAgICBjb25zdGFudENhY2hlOiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSwKICAgICAgdGVtcHM6IDAsCiAgICAgIGNhY2hlZDogMCwKICAgICAgaWRlbnRpZmllcnM6IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpLAogICAgICBzY29wZXM6IHsKICAgICAgICB2Rm9yOiAwLAogICAgICAgIHZTbG90OiAwLAogICAgICAgIHZQcmU6IDAsCiAgICAgICAgdk9uY2U6IDAKICAgICAgfSwKICAgICAgcGFyZW50OiBudWxsLAogICAgICBjdXJyZW50Tm9kZTogcm9vdCwKICAgICAgY2hpbGRJbmRleDogMCwKICAgICAgaW5WT25jZTogZmFsc2UsCiAgICAgIC8vIG1ldGhvZHMKICAgICAgaGVscGVyKG5hbWUpIHsKICAgICAgICBjb25zdCBjb3VudCA9IGNvbnRleHQuaGVscGVycy5nZXQobmFtZSkgfHwgMDsKICAgICAgICBjb250ZXh0LmhlbHBlcnMuc2V0KG5hbWUsIGNvdW50ICsgMSk7CiAgICAgICAgcmV0dXJuIG5hbWU7CiAgICAgIH0sCiAgICAgIHJlbW92ZUhlbHBlcihuYW1lKSB7CiAgICAgICAgY29uc3QgY291bnQgPSBjb250ZXh0LmhlbHBlcnMuZ2V0KG5hbWUpOwogICAgICAgIGlmIChjb3VudCkgewogICAgICAgICAgY29uc3QgY3VycmVudENvdW50ID0gY291bnQgLSAxOwogICAgICAgICAgaWYgKCFjdXJyZW50Q291bnQpIHsKICAgICAgICAgICAgY29udGV4dC5oZWxwZXJzLmRlbGV0ZShuYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRleHQuaGVscGVycy5zZXQobmFtZSwgY3VycmVudENvdW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGhlbHBlclN0cmluZyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGBfJHtoZWxwZXJOYW1lTWFwW2NvbnRleHQuaGVscGVyKG5hbWUpXX1gOwogICAgICB9LAogICAgICByZXBsYWNlTm9kZShub2RlKSB7CiAgICAgICAgewogICAgICAgICAgaWYgKCFjb250ZXh0LmN1cnJlbnROb2RlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm9kZSBiZWluZyByZXBsYWNlZCBpcyBhbHJlYWR5IHJlbW92ZWQuYCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWNvbnRleHQucGFyZW50KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlcGxhY2Ugcm9vdCBub2RlLmApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb250ZXh0LnBhcmVudC5jaGlsZHJlbltjb250ZXh0LmNoaWxkSW5kZXhdID0gY29udGV4dC5jdXJyZW50Tm9kZSA9IG5vZGU7CiAgICAgIH0sCiAgICAgIHJlbW92ZU5vZGUobm9kZSkgewogICAgICAgIGlmICghY29udGV4dC5wYXJlbnQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHJlbW92ZSByb290IG5vZGUuYCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGxpc3QgPSBjb250ZXh0LnBhcmVudC5jaGlsZHJlbjsKICAgICAgICBjb25zdCByZW1vdmFsSW5kZXggPSBub2RlID8gbGlzdC5pbmRleE9mKG5vZGUpIDogY29udGV4dC5jdXJyZW50Tm9kZSA/IGNvbnRleHQuY2hpbGRJbmRleCA6IC0xOwogICAgICAgIGlmIChyZW1vdmFsSW5kZXggPCAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vZGUgYmVpbmcgcmVtb3ZlZCBpcyBub3QgYSBjaGlsZCBvZiBjdXJyZW50IHBhcmVudGApOwogICAgICAgIH0KICAgICAgICBpZiAoIW5vZGUgfHwgbm9kZSA9PT0gY29udGV4dC5jdXJyZW50Tm9kZSkgewogICAgICAgICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBjb250ZXh0Lm9uTm9kZVJlbW92ZWQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNvbnRleHQuY2hpbGRJbmRleCA+IHJlbW92YWxJbmRleCkgewogICAgICAgICAgICBjb250ZXh0LmNoaWxkSW5kZXgtLTsKICAgICAgICAgICAgY29udGV4dC5vbk5vZGVSZW1vdmVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnRleHQucGFyZW50LmNoaWxkcmVuLnNwbGljZShyZW1vdmFsSW5kZXgsIDEpOwogICAgICB9LAogICAgICBvbk5vZGVSZW1vdmVkOiBOT09QLAogICAgICBhZGRJZGVudGlmaWVycyhleHApIHsKICAgICAgfSwKICAgICAgcmVtb3ZlSWRlbnRpZmllcnMoZXhwKSB7CiAgICAgIH0sCiAgICAgIGhvaXN0KGV4cCkgewogICAgICAgIGlmIChpc1N0cmluZyhleHApKQogICAgICAgICAgZXhwID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihleHApOwogICAgICAgIGNvbnRleHQuaG9pc3RzLnB1c2goZXhwKTsKICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigKICAgICAgICAgIGBfaG9pc3RlZF8ke2NvbnRleHQuaG9pc3RzLmxlbmd0aH1gLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICBleHAubG9jLAogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgaWRlbnRpZmllci5ob2lzdGVkID0gZXhwOwogICAgICAgIHJldHVybiBpZGVudGlmaWVyOwogICAgICB9LAogICAgICBjYWNoZShleHAsIGlzVk5vZGUgPSBmYWxzZSkgewogICAgICAgIHJldHVybiBjcmVhdGVDYWNoZUV4cHJlc3Npb24oY29udGV4dC5jYWNoZWQrKywgZXhwLCBpc1ZOb2RlKTsKICAgICAgfQogICAgfTsKICAgIHJldHVybiBjb250ZXh0OwogIH0KICBmdW5jdGlvbiB0cmFuc2Zvcm0ocm9vdCwgb3B0aW9ucykgewogICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZVRyYW5zZm9ybUNvbnRleHQocm9vdCwgb3B0aW9ucyk7CiAgICB0cmF2ZXJzZU5vZGUocm9vdCwgY29udGV4dCk7CiAgICBpZiAob3B0aW9ucy5ob2lzdFN0YXRpYykgewogICAgICBob2lzdFN0YXRpYyhyb290LCBjb250ZXh0KTsKICAgIH0KICAgIGlmICghb3B0aW9ucy5zc3IpIHsKICAgICAgY3JlYXRlUm9vdENvZGVnZW4ocm9vdCwgY29udGV4dCk7CiAgICB9CiAgICByb290LmhlbHBlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbLi4uY29udGV4dC5oZWxwZXJzLmtleXMoKV0pOwogICAgcm9vdC5jb21wb25lbnRzID0gWy4uLmNvbnRleHQuY29tcG9uZW50c107CiAgICByb290LmRpcmVjdGl2ZXMgPSBbLi4uY29udGV4dC5kaXJlY3RpdmVzXTsKICAgIHJvb3QuaW1wb3J0cyA9IGNvbnRleHQuaW1wb3J0czsKICAgIHJvb3QuaG9pc3RzID0gY29udGV4dC5ob2lzdHM7CiAgICByb290LnRlbXBzID0gY29udGV4dC50ZW1wczsKICAgIHJvb3QuY2FjaGVkID0gY29udGV4dC5jYWNoZWQ7CiAgICByb290LnRyYW5zZm9ybWVkID0gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlUm9vdENvZGVnZW4ocm9vdCwgY29udGV4dCkgewogICAgY29uc3QgeyBoZWxwZXIgfSA9IGNvbnRleHQ7CiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSByb290OwogICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMSkgewogICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuWzBdOwogICAgICBpZiAoaXNTaW5nbGVFbGVtZW50Um9vdChyb290LCBjaGlsZCkgJiYgY2hpbGQuY29kZWdlbk5vZGUpIHsKICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IGNoaWxkLmNvZGVnZW5Ob2RlOwogICAgICAgIGlmIChjb2RlZ2VuTm9kZS50eXBlID09PSAxMykgewogICAgICAgICAgY29udmVydFRvQmxvY2soY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgICByb290LmNvZGVnZW5Ob2RlID0gY29kZWdlbk5vZGU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcm9vdC5jb2RlZ2VuTm9kZSA9IGNoaWxkOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgbGV0IHBhdGNoRmxhZyA9IDY0OwogICAgICBsZXQgcGF0Y2hGbGFnVGV4dCA9IFBhdGNoRmxhZ05hbWVzWzY0XTsKICAgICAgaWYgKGNoaWxkcmVuLmZpbHRlcigoYykgPT4gYy50eXBlICE9PSAzKS5sZW5ndGggPT09IDEpIHsKICAgICAgICBwYXRjaEZsYWcgfD0gMjA0ODsKICAgICAgICBwYXRjaEZsYWdUZXh0ICs9IGAsICR7UGF0Y2hGbGFnTmFtZXNbMjA0OF19YDsKICAgICAgfQogICAgICByb290LmNvZGVnZW5Ob2RlID0gY3JlYXRlVk5vZGVDYWxsKAogICAgICAgIGNvbnRleHQsCiAgICAgICAgaGVscGVyKEZSQUdNRU5UKSwKICAgICAgICB2b2lkIDAsCiAgICAgICAgcm9vdC5jaGlsZHJlbiwKICAgICAgICBwYXRjaEZsYWcgKyAoYCAvKiAke3BhdGNoRmxhZ1RleHR9ICovYCApLAogICAgICAgIHZvaWQgMCwKICAgICAgICB2b2lkIDAsCiAgICAgICAgdHJ1ZSwKICAgICAgICB2b2lkIDAsCiAgICAgICAgZmFsc2UKICAgICAgKTsKICAgIH0gZWxzZSA7CiAgfQogIGZ1bmN0aW9uIHRyYXZlcnNlQ2hpbGRyZW4ocGFyZW50LCBjb250ZXh0KSB7CiAgICBsZXQgaSA9IDA7CiAgICBjb25zdCBub2RlUmVtb3ZlZCA9ICgpID0+IHsKICAgICAgaS0tOwogICAgfTsKICAgIGZvciAoOyBpIDwgcGFyZW50LmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNoaWxkID0gcGFyZW50LmNoaWxkcmVuW2ldOwogICAgICBpZiAoaXNTdHJpbmcoY2hpbGQpKQogICAgICAgIGNvbnRpbnVlOwogICAgICBjb250ZXh0LnBhcmVudCA9IHBhcmVudDsKICAgICAgY29udGV4dC5jaGlsZEluZGV4ID0gaTsKICAgICAgY29udGV4dC5vbk5vZGVSZW1vdmVkID0gbm9kZVJlbW92ZWQ7CiAgICAgIHRyYXZlcnNlTm9kZShjaGlsZCwgY29udGV4dCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBjb250ZXh0KSB7CiAgICBjb250ZXh0LmN1cnJlbnROb2RlID0gbm9kZTsKICAgIGNvbnN0IHsgbm9kZVRyYW5zZm9ybXMgfSA9IGNvbnRleHQ7CiAgICBjb25zdCBleGl0Rm5zID0gW107CiAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbm9kZVRyYW5zZm9ybXMubGVuZ3RoOyBpMisrKSB7CiAgICAgIGNvbnN0IG9uRXhpdCA9IG5vZGVUcmFuc2Zvcm1zW2kyXShub2RlLCBjb250ZXh0KTsKICAgICAgaWYgKG9uRXhpdCkgewogICAgICAgIGlmIChpc0FycmF5KG9uRXhpdCkpIHsKICAgICAgICAgIGV4aXRGbnMucHVzaCguLi5vbkV4aXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleGl0Rm5zLnB1c2gob25FeGl0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFjb250ZXh0LmN1cnJlbnROb2RlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGUgPSBjb250ZXh0LmN1cnJlbnROb2RlOwogICAgICB9CiAgICB9CiAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICBjYXNlIDM6CiAgICAgICAgaWYgKCFjb250ZXh0LnNzcikgewogICAgICAgICAgY29udGV4dC5oZWxwZXIoQ1JFQVRFX0NPTU1FTlQpOwogICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgY2FzZSA1OgogICAgICAgIGlmICghY29udGV4dC5zc3IpIHsKICAgICAgICAgIGNvbnRleHQuaGVscGVyKFRPX0RJU1BMQVlfU1RSSU5HKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgOToKICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbm9kZS5icmFuY2hlcy5sZW5ndGg7IGkyKyspIHsKICAgICAgICAgIHRyYXZlcnNlTm9kZShub2RlLmJyYW5jaGVzW2kyXSwgY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDEwOgogICAgICBjYXNlIDExOgogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgMDoKICAgICAgICB0cmF2ZXJzZUNoaWxkcmVuKG5vZGUsIGNvbnRleHQpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgY29udGV4dC5jdXJyZW50Tm9kZSA9IG5vZGU7CiAgICBsZXQgaSA9IGV4aXRGbnMubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBleGl0Rm5zW2ldKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVN0cnVjdHVyYWxEaXJlY3RpdmVUcmFuc2Zvcm0obmFtZSwgZm4pIHsKICAgIGNvbnN0IG1hdGNoZXMgPSBpc1N0cmluZyhuYW1lKSA/IChuKSA9PiBuID09PSBuYW1lIDogKG4pID0+IG5hbWUudGVzdChuKTsKICAgIHJldHVybiAobm9kZSwgY29udGV4dCkgPT4gewogICAgICBpZiAobm9kZS50eXBlID09PSAxKSB7CiAgICAgICAgY29uc3QgeyBwcm9wcyB9ID0gbm9kZTsKICAgICAgICBpZiAobm9kZS50YWdUeXBlID09PSAzICYmIHByb3BzLnNvbWUoaXNWU2xvdCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXhpdEZucyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHByb3AgPSBwcm9wc1tpXTsKICAgICAgICAgIGlmIChwcm9wLnR5cGUgPT09IDcgJiYgbWF0Y2hlcyhwcm9wLm5hbWUpKSB7CiAgICAgICAgICAgIHByb3BzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgaS0tOwogICAgICAgICAgICBjb25zdCBvbkV4aXQgPSBmbihub2RlLCBwcm9wLCBjb250ZXh0KTsKICAgICAgICAgICAgaWYgKG9uRXhpdCkKICAgICAgICAgICAgICBleGl0Rm5zLnB1c2gob25FeGl0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV4aXRGbnM7CiAgICAgIH0KICAgIH07CiAgfQoKICBjb25zdCBQVVJFX0FOTk9UQVRJT04gPSBgLyojX19QVVJFX18qL2A7CiAgY29uc3QgYWxpYXNIZWxwZXIgPSAocykgPT4gYCR7aGVscGVyTmFtZU1hcFtzXX06IF8ke2hlbHBlck5hbWVNYXBbc119YDsKICBmdW5jdGlvbiBjcmVhdGVDb2RlZ2VuQ29udGV4dChhc3QsIHsKICAgIG1vZGUgPSAiZnVuY3Rpb24iLAogICAgcHJlZml4SWRlbnRpZmllcnMgPSBtb2RlID09PSAibW9kdWxlIiwKICAgIHNvdXJjZU1hcCA9IGZhbHNlLAogICAgZmlsZW5hbWUgPSBgdGVtcGxhdGUudnVlLmh0bWxgLAogICAgc2NvcGVJZCA9IG51bGwsCiAgICBvcHRpbWl6ZUltcG9ydHMgPSBmYWxzZSwKICAgIHJ1bnRpbWVHbG9iYWxOYW1lID0gYFZ1ZWAsCiAgICBydW50aW1lTW9kdWxlTmFtZSA9IGB2dWVgLAogICAgc3NyUnVudGltZU1vZHVsZU5hbWUgPSAidnVlL3NlcnZlci1yZW5kZXJlciIsCiAgICBzc3IgPSBmYWxzZSwKICAgIGlzVFMgPSBmYWxzZSwKICAgIGluU1NSID0gZmFsc2UKICB9KSB7CiAgICBjb25zdCBjb250ZXh0ID0gewogICAgICBtb2RlLAogICAgICBwcmVmaXhJZGVudGlmaWVycywKICAgICAgc291cmNlTWFwLAogICAgICBmaWxlbmFtZSwKICAgICAgc2NvcGVJZCwKICAgICAgb3B0aW1pemVJbXBvcnRzLAogICAgICBydW50aW1lR2xvYmFsTmFtZSwKICAgICAgcnVudGltZU1vZHVsZU5hbWUsCiAgICAgIHNzclJ1bnRpbWVNb2R1bGVOYW1lLAogICAgICBzc3IsCiAgICAgIGlzVFMsCiAgICAgIGluU1NSLAogICAgICBzb3VyY2U6IGFzdC5zb3VyY2UsCiAgICAgIGNvZGU6IGBgLAogICAgICBjb2x1bW46IDEsCiAgICAgIGxpbmU6IDEsCiAgICAgIG9mZnNldDogMCwKICAgICAgaW5kZW50TGV2ZWw6IDAsCiAgICAgIHB1cmU6IGZhbHNlLAogICAgICBtYXA6IHZvaWQgMCwKICAgICAgaGVscGVyKGtleSkgewogICAgICAgIHJldHVybiBgXyR7aGVscGVyTmFtZU1hcFtrZXldfWA7CiAgICAgIH0sCiAgICAgIHB1c2goY29kZSwgbmV3bGluZUluZGV4ID0gLTIgLyogTm9uZSAqLywgbm9kZSkgewogICAgICAgIGNvbnRleHQuY29kZSArPSBjb2RlOwogICAgICB9LAogICAgICBpbmRlbnQoKSB7CiAgICAgICAgbmV3bGluZSgrK2NvbnRleHQuaW5kZW50TGV2ZWwpOwogICAgICB9LAogICAgICBkZWluZGVudCh3aXRob3V0TmV3TGluZSA9IGZhbHNlKSB7CiAgICAgICAgaWYgKHdpdGhvdXROZXdMaW5lKSB7CiAgICAgICAgICAtLWNvbnRleHQuaW5kZW50TGV2ZWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld2xpbmUoLS1jb250ZXh0LmluZGVudExldmVsKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIG5ld2xpbmUoKSB7CiAgICAgICAgbmV3bGluZShjb250ZXh0LmluZGVudExldmVsKTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIG5ld2xpbmUobikgewogICAgICBjb250ZXh0LnB1c2goIlxuIiArIGAgIGAucmVwZWF0KG4pLCAwIC8qIFN0YXJ0ICovKTsKICAgIH0KICAgIHJldHVybiBjb250ZXh0OwogIH0KICBmdW5jdGlvbiBnZW5lcmF0ZShhc3QsIG9wdGlvbnMgPSB7fSkgewogICAgY29uc3QgY29udGV4dCA9IGNyZWF0ZUNvZGVnZW5Db250ZXh0KGFzdCwgb3B0aW9ucyk7CiAgICBpZiAob3B0aW9ucy5vbkNvbnRleHRDcmVhdGVkKQogICAgICBvcHRpb25zLm9uQ29udGV4dENyZWF0ZWQoY29udGV4dCk7CiAgICBjb25zdCB7CiAgICAgIG1vZGUsCiAgICAgIHB1c2gsCiAgICAgIHByZWZpeElkZW50aWZpZXJzLAogICAgICBpbmRlbnQsCiAgICAgIGRlaW5kZW50LAogICAgICBuZXdsaW5lLAogICAgICBzY29wZUlkLAogICAgICBzc3IKICAgIH0gPSBjb250ZXh0OwogICAgY29uc3QgaGVscGVycyA9IEFycmF5LmZyb20oYXN0LmhlbHBlcnMpOwogICAgY29uc3QgaGFzSGVscGVycyA9IGhlbHBlcnMubGVuZ3RoID4gMDsKICAgIGNvbnN0IHVzZVdpdGhCbG9jayA9ICFwcmVmaXhJZGVudGlmaWVycyAmJiBtb2RlICE9PSAibW9kdWxlIjsKICAgIGNvbnN0IHByZWFtYmxlQ29udGV4dCA9IGNvbnRleHQ7CiAgICB7CiAgICAgIGdlbkZ1bmN0aW9uUHJlYW1ibGUoYXN0LCBwcmVhbWJsZUNvbnRleHQpOwogICAgfQogICAgY29uc3QgZnVuY3Rpb25OYW1lID0gc3NyID8gYHNzclJlbmRlcmAgOiBgcmVuZGVyYDsKICAgIGNvbnN0IGFyZ3MgPSBzc3IgPyBbIl9jdHgiLCAiX3B1c2giLCAiX3BhcmVudCIsICJfYXR0cnMiXSA6IFsiX2N0eCIsICJfY2FjaGUiXTsKICAgIGNvbnN0IHNpZ25hdHVyZSA9IGFyZ3Muam9pbigiLCAiKTsKICAgIHsKICAgICAgcHVzaChgZnVuY3Rpb24gJHtmdW5jdGlvbk5hbWV9KCR7c2lnbmF0dXJlfSkge2ApOwogICAgfQogICAgaW5kZW50KCk7CiAgICBpZiAodXNlV2l0aEJsb2NrKSB7CiAgICAgIHB1c2goYHdpdGggKF9jdHgpIHtgKTsKICAgICAgaW5kZW50KCk7CiAgICAgIGlmIChoYXNIZWxwZXJzKSB7CiAgICAgICAgcHVzaCgKICAgICAgICAgIGBjb25zdCB7ICR7aGVscGVycy5tYXAoYWxpYXNIZWxwZXIpLmpvaW4oIiwgIil9IH0gPSBfVnVlCmAsCiAgICAgICAgICAtMSAvKiBFbmQgKi8KICAgICAgICApOwogICAgICAgIG5ld2xpbmUoKTsKICAgICAgfQogICAgfQogICAgaWYgKGFzdC5jb21wb25lbnRzLmxlbmd0aCkgewogICAgICBnZW5Bc3NldHMoYXN0LmNvbXBvbmVudHMsICJjb21wb25lbnQiLCBjb250ZXh0KTsKICAgICAgaWYgKGFzdC5kaXJlY3RpdmVzLmxlbmd0aCB8fCBhc3QudGVtcHMgPiAwKSB7CiAgICAgICAgbmV3bGluZSgpOwogICAgICB9CiAgICB9CiAgICBpZiAoYXN0LmRpcmVjdGl2ZXMubGVuZ3RoKSB7CiAgICAgIGdlbkFzc2V0cyhhc3QuZGlyZWN0aXZlcywgImRpcmVjdGl2ZSIsIGNvbnRleHQpOwogICAgICBpZiAoYXN0LnRlbXBzID4gMCkgewogICAgICAgIG5ld2xpbmUoKTsKICAgICAgfQogICAgfQogICAgaWYgKGFzdC50ZW1wcyA+IDApIHsKICAgICAgcHVzaChgbGV0IGApOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFzdC50ZW1wczsgaSsrKSB7CiAgICAgICAgcHVzaChgJHtpID4gMCA/IGAsIGAgOiBgYH1fdGVtcCR7aX1gKTsKICAgICAgfQogICAgfQogICAgaWYgKGFzdC5jb21wb25lbnRzLmxlbmd0aCB8fCBhc3QuZGlyZWN0aXZlcy5sZW5ndGggfHwgYXN0LnRlbXBzKSB7CiAgICAgIHB1c2goYApgLCAwIC8qIFN0YXJ0ICovKTsKICAgICAgbmV3bGluZSgpOwogICAgfQogICAgaWYgKCFzc3IpIHsKICAgICAgcHVzaChgcmV0dXJuIGApOwogICAgfQogICAgaWYgKGFzdC5jb2RlZ2VuTm9kZSkgewogICAgICBnZW5Ob2RlKGFzdC5jb2RlZ2VuTm9kZSwgY29udGV4dCk7CiAgICB9IGVsc2UgewogICAgICBwdXNoKGBudWxsYCk7CiAgICB9CiAgICBpZiAodXNlV2l0aEJsb2NrKSB7CiAgICAgIGRlaW5kZW50KCk7CiAgICAgIHB1c2goYH1gKTsKICAgIH0KICAgIGRlaW5kZW50KCk7CiAgICBwdXNoKGB9YCk7CiAgICByZXR1cm4gewogICAgICBhc3QsCiAgICAgIGNvZGU6IGNvbnRleHQuY29kZSwKICAgICAgcHJlYW1ibGU6IGBgLAogICAgICBtYXA6IGNvbnRleHQubWFwID8gY29udGV4dC5tYXAudG9KU09OKCkgOiB2b2lkIDAKICAgIH07CiAgfQogIGZ1bmN0aW9uIGdlbkZ1bmN0aW9uUHJlYW1ibGUoYXN0LCBjb250ZXh0KSB7CiAgICBjb25zdCB7CiAgICAgIHNzciwKICAgICAgcHJlZml4SWRlbnRpZmllcnMsCiAgICAgIHB1c2gsCiAgICAgIG5ld2xpbmUsCiAgICAgIHJ1bnRpbWVNb2R1bGVOYW1lLAogICAgICBydW50aW1lR2xvYmFsTmFtZSwKICAgICAgc3NyUnVudGltZU1vZHVsZU5hbWUKICAgIH0gPSBjb250ZXh0OwogICAgY29uc3QgVnVlQmluZGluZyA9IHJ1bnRpbWVHbG9iYWxOYW1lOwogICAgY29uc3QgaGVscGVycyA9IEFycmF5LmZyb20oYXN0LmhlbHBlcnMpOwogICAgaWYgKGhlbHBlcnMubGVuZ3RoID4gMCkgewogICAgICB7CiAgICAgICAgcHVzaChgY29uc3QgX1Z1ZSA9ICR7VnVlQmluZGluZ30KYCwgLTEgLyogRW5kICovKTsKICAgICAgICBpZiAoYXN0LmhvaXN0cy5sZW5ndGgpIHsKICAgICAgICAgIGNvbnN0IHN0YXRpY0hlbHBlcnMgPSBbCiAgICAgICAgICAgIENSRUFURV9WTk9ERSwKICAgICAgICAgICAgQ1JFQVRFX0VMRU1FTlRfVk5PREUsCiAgICAgICAgICAgIENSRUFURV9DT01NRU5ULAogICAgICAgICAgICBDUkVBVEVfVEVYVCwKICAgICAgICAgICAgQ1JFQVRFX1NUQVRJQwogICAgICAgICAgXS5maWx0ZXIoKGhlbHBlcikgPT4gaGVscGVycy5pbmNsdWRlcyhoZWxwZXIpKS5tYXAoYWxpYXNIZWxwZXIpLmpvaW4oIiwgIik7CiAgICAgICAgICBwdXNoKGBjb25zdCB7ICR7c3RhdGljSGVscGVyc30gfSA9IF9WdWUKYCwgLTEgLyogRW5kICovKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGdlbkhvaXN0cyhhc3QuaG9pc3RzLCBjb250ZXh0KTsKICAgIG5ld2xpbmUoKTsKICAgIHB1c2goYHJldHVybiBgKTsKICB9CiAgZnVuY3Rpb24gZ2VuQXNzZXRzKGFzc2V0cywgdHlwZSwgeyBoZWxwZXIsIHB1c2gsIG5ld2xpbmUsIGlzVFMgfSkgewogICAgY29uc3QgcmVzb2x2ZXIgPSBoZWxwZXIoCiAgICAgIHR5cGUgPT09ICJjb21wb25lbnQiID8gUkVTT0xWRV9DT01QT05FTlQgOiBSRVNPTFZFX0RJUkVDVElWRQogICAgKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXNzZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxldCBpZCA9IGFzc2V0c1tpXTsKICAgICAgY29uc3QgbWF5YmVTZWxmUmVmZXJlbmNlID0gaWQuZW5kc1dpdGgoIl9fc2VsZiIpOwogICAgICBpZiAobWF5YmVTZWxmUmVmZXJlbmNlKSB7CiAgICAgICAgaWQgPSBpZC5zbGljZSgwLCAtNik7CiAgICAgIH0KICAgICAgcHVzaCgKICAgICAgICBgY29uc3QgJHt0b1ZhbGlkQXNzZXRJZChpZCwgdHlwZSl9ID0gJHtyZXNvbHZlcn0oJHtKU09OLnN0cmluZ2lmeShpZCl9JHttYXliZVNlbGZSZWZlcmVuY2UgPyBgLCB0cnVlYCA6IGBgfSkke2lzVFMgPyBgIWAgOiBgYH1gCiAgICAgICk7CiAgICAgIGlmIChpIDwgYXNzZXRzLmxlbmd0aCAtIDEpIHsKICAgICAgICBuZXdsaW5lKCk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuSG9pc3RzKGhvaXN0cywgY29udGV4dCkgewogICAgaWYgKCFob2lzdHMubGVuZ3RoKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbnRleHQucHVyZSA9IHRydWU7CiAgICBjb25zdCB7IHB1c2gsIG5ld2xpbmUsIGhlbHBlciwgc2NvcGVJZCwgbW9kZSB9ID0gY29udGV4dDsKICAgIG5ld2xpbmUoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaG9pc3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGV4cCA9IGhvaXN0c1tpXTsKICAgICAgaWYgKGV4cCkgewogICAgICAgIHB1c2goCiAgICAgICAgICBgY29uc3QgX2hvaXN0ZWRfJHtpICsgMX0gPSAke2BgfWAKICAgICAgICApOwogICAgICAgIGdlbk5vZGUoZXhwLCBjb250ZXh0KTsKICAgICAgICBuZXdsaW5lKCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnRleHQucHVyZSA9IGZhbHNlOwogIH0KICBmdW5jdGlvbiBpc1RleHQobikgewogICAgcmV0dXJuIGlzU3RyaW5nKG4pIHx8IG4udHlwZSA9PT0gNCB8fCBuLnR5cGUgPT09IDIgfHwgbi50eXBlID09PSA1IHx8IG4udHlwZSA9PT0gODsKICB9CiAgZnVuY3Rpb24gZ2VuTm9kZUxpc3RBc0FycmF5KG5vZGVzLCBjb250ZXh0KSB7CiAgICBjb25zdCBtdWx0aWxpbmVzID0gbm9kZXMubGVuZ3RoID4gMyB8fCBub2Rlcy5zb21lKChuKSA9PiBpc0FycmF5KG4pIHx8ICFpc1RleHQobikpOwogICAgY29udGV4dC5wdXNoKGBbYCk7CiAgICBtdWx0aWxpbmVzICYmIGNvbnRleHQuaW5kZW50KCk7CiAgICBnZW5Ob2RlTGlzdChub2RlcywgY29udGV4dCwgbXVsdGlsaW5lcyk7CiAgICBtdWx0aWxpbmVzICYmIGNvbnRleHQuZGVpbmRlbnQoKTsKICAgIGNvbnRleHQucHVzaChgXWApOwogIH0KICBmdW5jdGlvbiBnZW5Ob2RlTGlzdChub2RlcywgY29udGV4dCwgbXVsdGlsaW5lcyA9IGZhbHNlLCBjb21tYSA9IHRydWUpIHsKICAgIGNvbnN0IHsgcHVzaCwgbmV3bGluZSB9ID0gY29udGV4dDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwogICAgICBpZiAoaXNTdHJpbmcobm9kZSkpIHsKICAgICAgICBwdXNoKG5vZGUsIC0zIC8qIFVua25vd24gKi8pOwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobm9kZSkpIHsKICAgICAgICBnZW5Ob2RlTGlzdEFzQXJyYXkobm9kZSwgY29udGV4dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZ2VuTm9kZShub2RlLCBjb250ZXh0KTsKICAgICAgfQogICAgICBpZiAoaSA8IG5vZGVzLmxlbmd0aCAtIDEpIHsKICAgICAgICBpZiAobXVsdGlsaW5lcykgewogICAgICAgICAgY29tbWEgJiYgcHVzaCgiLCIpOwogICAgICAgICAgbmV3bGluZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb21tYSAmJiBwdXNoKCIsICIpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBnZW5Ob2RlKG5vZGUsIGNvbnRleHQpIHsKICAgIGlmIChpc1N0cmluZyhub2RlKSkgewogICAgICBjb250ZXh0LnB1c2gobm9kZSwgLTMgLyogVW5rbm93biAqLyk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChpc1N5bWJvbChub2RlKSkgewogICAgICBjb250ZXh0LnB1c2goY29udGV4dC5oZWxwZXIobm9kZSkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICBjYXNlIDE6CiAgICAgIGNhc2UgOToKICAgICAgY2FzZSAxMToKICAgICAgICBhc3NlcnQoCiAgICAgICAgICBub2RlLmNvZGVnZW5Ob2RlICE9IG51bGwsCiAgICAgICAgICBgQ29kZWdlbiBub2RlIGlzIG1pc3NpbmcgZm9yIGVsZW1lbnQvaWYvZm9yIG5vZGUuIEFwcGx5IGFwcHJvcHJpYXRlIHRyYW5zZm9ybXMgZmlyc3QuYAogICAgICAgICk7CiAgICAgICAgZ2VuTm9kZShub2RlLmNvZGVnZW5Ob2RlLCBjb250ZXh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGdlblRleHQobm9kZSwgY29udGV4dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgNDoKICAgICAgICBnZW5FeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDU6CiAgICAgICAgZ2VuSW50ZXJwb2xhdGlvbihub2RlLCBjb250ZXh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxMjoKICAgICAgICBnZW5Ob2RlKG5vZGUuY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDg6CiAgICAgICAgZ2VuQ29tcG91bmRFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgZ2VuQ29tbWVudChub2RlLCBjb250ZXh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxMzoKICAgICAgICBnZW5WTm9kZUNhbGwobm9kZSwgY29udGV4dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTQ6CiAgICAgICAgZ2VuQ2FsbEV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTU6CiAgICAgICAgZ2VuT2JqZWN0RXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxNzoKICAgICAgICBnZW5BcnJheUV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTg6CiAgICAgICAgZ2VuRnVuY3Rpb25FeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE5OgogICAgICAgIGdlbkNvbmRpdGlvbmFsRXhwcmVzc2lvbihub2RlLCBjb250ZXh0KTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyMDoKICAgICAgICBnZW5DYWNoZUV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjE6CiAgICAgICAgZ2VuTm9kZUxpc3Qobm9kZS5ib2R5LCBjb250ZXh0LCB0cnVlLCBmYWxzZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjI6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjM6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjQ6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjU6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjY6CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMTA6CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgewogICAgICAgICAgYXNzZXJ0KGZhbHNlLCBgdW5oYW5kbGVkIGNvZGVnZW4gbm9kZSB0eXBlOiAke25vZGUudHlwZX1gKTsKICAgICAgICAgIGNvbnN0IGV4aGF1c3RpdmVDaGVjayA9IG5vZGU7CiAgICAgICAgICByZXR1cm4gZXhoYXVzdGl2ZUNoZWNrOwogICAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuVGV4dChub2RlLCBjb250ZXh0KSB7CiAgICBjb250ZXh0LnB1c2goSlNPTi5zdHJpbmdpZnkobm9kZS5jb250ZW50KSwgLTMgLyogVW5rbm93biAqLywgbm9kZSk7CiAgfQogIGZ1bmN0aW9uIGdlbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgY29uc3QgeyBjb250ZW50LCBpc1N0YXRpYyB9ID0gbm9kZTsKICAgIGNvbnRleHQucHVzaCgKICAgICAgaXNTdGF0aWMgPyBKU09OLnN0cmluZ2lmeShjb250ZW50KSA6IGNvbnRlbnQsCiAgICAgIC0zIC8qIFVua25vd24gKi8sCiAgICAgIG5vZGUKICAgICk7CiAgfQogIGZ1bmN0aW9uIGdlbkludGVycG9sYXRpb24obm9kZSwgY29udGV4dCkgewogICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIHB1cmUgfSA9IGNvbnRleHQ7CiAgICBpZiAocHVyZSkKICAgICAgcHVzaChQVVJFX0FOTk9UQVRJT04pOwogICAgcHVzaChgJHtoZWxwZXIoVE9fRElTUExBWV9TVFJJTkcpfShgKTsKICAgIGdlbk5vZGUobm9kZS5jb250ZW50LCBjb250ZXh0KTsKICAgIHB1c2goYClgKTsKICB9CiAgZnVuY3Rpb24gZ2VuQ29tcG91bmRFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgIGlmIChpc1N0cmluZyhjaGlsZCkpIHsKICAgICAgICBjb250ZXh0LnB1c2goY2hpbGQsIC0zIC8qIFVua25vd24gKi8pOwogICAgICB9IGVsc2UgewogICAgICAgIGdlbk5vZGUoY2hpbGQsIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbkV4cHJlc3Npb25Bc1Byb3BlcnR5S2V5KG5vZGUsIGNvbnRleHQpIHsKICAgIGNvbnN0IHsgcHVzaCB9ID0gY29udGV4dDsKICAgIGlmIChub2RlLnR5cGUgPT09IDgpIHsKICAgICAgcHVzaChgW2ApOwogICAgICBnZW5Db21wb3VuZEV4cHJlc3Npb24obm9kZSwgY29udGV4dCk7CiAgICAgIHB1c2goYF1gKTsKICAgIH0gZWxzZSBpZiAobm9kZS5pc1N0YXRpYykgewogICAgICBjb25zdCB0ZXh0ID0gaXNTaW1wbGVJZGVudGlmaWVyKG5vZGUuY29udGVudCkgPyBub2RlLmNvbnRlbnQgOiBKU09OLnN0cmluZ2lmeShub2RlLmNvbnRlbnQpOwogICAgICBwdXNoKHRleHQsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOwogICAgfSBlbHNlIHsKICAgICAgcHVzaChgWyR7bm9kZS5jb250ZW50fV1gLCAtMyAvKiBVbmtub3duICovLCBub2RlKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuQ29tbWVudChub2RlLCBjb250ZXh0KSB7CiAgICBjb25zdCB7IHB1c2gsIGhlbHBlciwgcHVyZSB9ID0gY29udGV4dDsKICAgIGlmIChwdXJlKSB7CiAgICAgIHB1c2goUFVSRV9BTk5PVEFUSU9OKTsKICAgIH0KICAgIHB1c2goCiAgICAgIGAke2hlbHBlcihDUkVBVEVfQ09NTUVOVCl9KCR7SlNPTi5zdHJpbmdpZnkobm9kZS5jb250ZW50KX0pYCwKICAgICAgLTMgLyogVW5rbm93biAqLywKICAgICAgbm9kZQogICAgKTsKICB9CiAgZnVuY3Rpb24gZ2VuVk5vZGVDYWxsKG5vZGUsIGNvbnRleHQpIHsKICAgIGNvbnN0IHsgcHVzaCwgaGVscGVyLCBwdXJlIH0gPSBjb250ZXh0OwogICAgY29uc3QgewogICAgICB0YWcsCiAgICAgIHByb3BzLAogICAgICBjaGlsZHJlbiwKICAgICAgcGF0Y2hGbGFnLAogICAgICBkeW5hbWljUHJvcHMsCiAgICAgIGRpcmVjdGl2ZXMsCiAgICAgIGlzQmxvY2ssCiAgICAgIGRpc2FibGVUcmFja2luZywKICAgICAgaXNDb21wb25lbnQKICAgIH0gPSBub2RlOwogICAgaWYgKGRpcmVjdGl2ZXMpIHsKICAgICAgcHVzaChoZWxwZXIoV0lUSF9ESVJFQ1RJVkVTKSArIGAoYCk7CiAgICB9CiAgICBpZiAoaXNCbG9jaykgewogICAgICBwdXNoKGAoJHtoZWxwZXIoT1BFTl9CTE9DSyl9KCR7ZGlzYWJsZVRyYWNraW5nID8gYHRydWVgIDogYGB9KSwgYCk7CiAgICB9CiAgICBpZiAocHVyZSkgewogICAgICBwdXNoKFBVUkVfQU5OT1RBVElPTik7CiAgICB9CiAgICBjb25zdCBjYWxsSGVscGVyID0gaXNCbG9jayA/IGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpIDogZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgaXNDb21wb25lbnQpOwogICAgcHVzaChoZWxwZXIoY2FsbEhlbHBlcikgKyBgKGAsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOwogICAgZ2VuTm9kZUxpc3QoCiAgICAgIGdlbk51bGxhYmxlQXJncyhbdGFnLCBwcm9wcywgY2hpbGRyZW4sIHBhdGNoRmxhZywgZHluYW1pY1Byb3BzXSksCiAgICAgIGNvbnRleHQKICAgICk7CiAgICBwdXNoKGApYCk7CiAgICBpZiAoaXNCbG9jaykgewogICAgICBwdXNoKGApYCk7CiAgICB9CiAgICBpZiAoZGlyZWN0aXZlcykgewogICAgICBwdXNoKGAsIGApOwogICAgICBnZW5Ob2RlKGRpcmVjdGl2ZXMsIGNvbnRleHQpOwogICAgICBwdXNoKGApYCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdlbk51bGxhYmxlQXJncyhhcmdzKSB7CiAgICBsZXQgaSA9IGFyZ3MubGVuZ3RoOwogICAgd2hpbGUgKGktLSkgewogICAgICBpZiAoYXJnc1tpXSAhPSBudWxsKQogICAgICAgIGJyZWFrOwogICAgfQogICAgcmV0dXJuIGFyZ3Muc2xpY2UoMCwgaSArIDEpLm1hcCgoYXJnKSA9PiBhcmcgfHwgYG51bGxgKTsKICB9CiAgZnVuY3Rpb24gZ2VuQ2FsbEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgY29uc3QgeyBwdXNoLCBoZWxwZXIsIHB1cmUgfSA9IGNvbnRleHQ7CiAgICBjb25zdCBjYWxsZWUgPSBpc1N0cmluZyhub2RlLmNhbGxlZSkgPyBub2RlLmNhbGxlZSA6IGhlbHBlcihub2RlLmNhbGxlZSk7CiAgICBpZiAocHVyZSkgewogICAgICBwdXNoKFBVUkVfQU5OT1RBVElPTik7CiAgICB9CiAgICBwdXNoKGNhbGxlZSArIGAoYCwgLTIgLyogTm9uZSAqLywgbm9kZSk7CiAgICBnZW5Ob2RlTGlzdChub2RlLmFyZ3VtZW50cywgY29udGV4dCk7CiAgICBwdXNoKGApYCk7CiAgfQogIGZ1bmN0aW9uIGdlbk9iamVjdEV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgY29uc3QgeyBwdXNoLCBpbmRlbnQsIGRlaW5kZW50LCBuZXdsaW5lIH0gPSBjb250ZXh0OwogICAgY29uc3QgeyBwcm9wZXJ0aWVzIH0gPSBub2RlOwogICAgaWYgKCFwcm9wZXJ0aWVzLmxlbmd0aCkgewogICAgICBwdXNoKGB7fWAsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOwogICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBtdWx0aWxpbmVzID0gcHJvcGVydGllcy5sZW5ndGggPiAxIHx8IHByb3BlcnRpZXMuc29tZSgocCkgPT4gcC52YWx1ZS50eXBlICE9PSA0KTsKICAgIHB1c2gobXVsdGlsaW5lcyA/IGB7YCA6IGB7IGApOwogICAgbXVsdGlsaW5lcyAmJiBpbmRlbnQoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCB7IGtleSwgdmFsdWUgfSA9IHByb3BlcnRpZXNbaV07CiAgICAgIGdlbkV4cHJlc3Npb25Bc1Byb3BlcnR5S2V5KGtleSwgY29udGV4dCk7CiAgICAgIHB1c2goYDogYCk7CiAgICAgIGdlbk5vZGUodmFsdWUsIGNvbnRleHQpOwogICAgICBpZiAoaSA8IHByb3BlcnRpZXMubGVuZ3RoIC0gMSkgewogICAgICAgIHB1c2goYCxgKTsKICAgICAgICBuZXdsaW5lKCk7CiAgICAgIH0KICAgIH0KICAgIG11bHRpbGluZXMgJiYgZGVpbmRlbnQoKTsKICAgIHB1c2gobXVsdGlsaW5lcyA/IGB9YCA6IGAgfWApOwogIH0KICBmdW5jdGlvbiBnZW5BcnJheUV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgZ2VuTm9kZUxpc3RBc0FycmF5KG5vZGUuZWxlbWVudHMsIGNvbnRleHQpOwogIH0KICBmdW5jdGlvbiBnZW5GdW5jdGlvbkV4cHJlc3Npb24obm9kZSwgY29udGV4dCkgewogICAgY29uc3QgeyBwdXNoLCBpbmRlbnQsIGRlaW5kZW50IH0gPSBjb250ZXh0OwogICAgY29uc3QgeyBwYXJhbXMsIHJldHVybnMsIGJvZHksIG5ld2xpbmUsIGlzU2xvdCB9ID0gbm9kZTsKICAgIGlmIChpc1Nsb3QpIHsKICAgICAgcHVzaChgXyR7aGVscGVyTmFtZU1hcFtXSVRIX0NUWF19KGApOwogICAgfQogICAgcHVzaChgKGAsIC0yIC8qIE5vbmUgKi8sIG5vZGUpOwogICAgaWYgKGlzQXJyYXkocGFyYW1zKSkgewogICAgICBnZW5Ob2RlTGlzdChwYXJhbXMsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChwYXJhbXMpIHsKICAgICAgZ2VuTm9kZShwYXJhbXMsIGNvbnRleHQpOwogICAgfQogICAgcHVzaChgKSA9PiBgKTsKICAgIGlmIChuZXdsaW5lIHx8IGJvZHkpIHsKICAgICAgcHVzaChge2ApOwogICAgICBpbmRlbnQoKTsKICAgIH0KICAgIGlmIChyZXR1cm5zKSB7CiAgICAgIGlmIChuZXdsaW5lKSB7CiAgICAgICAgcHVzaChgcmV0dXJuIGApOwogICAgICB9CiAgICAgIGlmIChpc0FycmF5KHJldHVybnMpKSB7CiAgICAgICAgZ2VuTm9kZUxpc3RBc0FycmF5KHJldHVybnMsIGNvbnRleHQpOwogICAgICB9IGVsc2UgewogICAgICAgIGdlbk5vZGUocmV0dXJucywgY29udGV4dCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYm9keSkgewogICAgICBnZW5Ob2RlKGJvZHksIGNvbnRleHQpOwogICAgfQogICAgaWYgKG5ld2xpbmUgfHwgYm9keSkgewogICAgICBkZWluZGVudCgpOwogICAgICBwdXNoKGB9YCk7CiAgICB9CiAgICBpZiAoaXNTbG90KSB7CiAgICAgIHB1c2goYClgKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2VuQ29uZGl0aW9uYWxFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsKICAgIGNvbnN0IHsgdGVzdCwgY29uc2VxdWVudCwgYWx0ZXJuYXRlLCBuZXdsaW5lOiBuZWVkTmV3bGluZSB9ID0gbm9kZTsKICAgIGNvbnN0IHsgcHVzaCwgaW5kZW50LCBkZWluZGVudCwgbmV3bGluZSB9ID0gY29udGV4dDsKICAgIGlmICh0ZXN0LnR5cGUgPT09IDQpIHsKICAgICAgY29uc3QgbmVlZHNQYXJlbnMgPSAhaXNTaW1wbGVJZGVudGlmaWVyKHRlc3QuY29udGVudCk7CiAgICAgIG5lZWRzUGFyZW5zICYmIHB1c2goYChgKTsKICAgICAgZ2VuRXhwcmVzc2lvbih0ZXN0LCBjb250ZXh0KTsKICAgICAgbmVlZHNQYXJlbnMgJiYgcHVzaChgKWApOwogICAgfSBlbHNlIHsKICAgICAgcHVzaChgKGApOwogICAgICBnZW5Ob2RlKHRlc3QsIGNvbnRleHQpOwogICAgICBwdXNoKGApYCk7CiAgICB9CiAgICBuZWVkTmV3bGluZSAmJiBpbmRlbnQoKTsKICAgIGNvbnRleHQuaW5kZW50TGV2ZWwrKzsKICAgIG5lZWROZXdsaW5lIHx8IHB1c2goYCBgKTsKICAgIHB1c2goYD8gYCk7CiAgICBnZW5Ob2RlKGNvbnNlcXVlbnQsIGNvbnRleHQpOwogICAgY29udGV4dC5pbmRlbnRMZXZlbC0tOwogICAgbmVlZE5ld2xpbmUgJiYgbmV3bGluZSgpOwogICAgbmVlZE5ld2xpbmUgfHwgcHVzaChgIGApOwogICAgcHVzaChgOiBgKTsKICAgIGNvbnN0IGlzTmVzdGVkID0gYWx0ZXJuYXRlLnR5cGUgPT09IDE5OwogICAgaWYgKCFpc05lc3RlZCkgewogICAgICBjb250ZXh0LmluZGVudExldmVsKys7CiAgICB9CiAgICBnZW5Ob2RlKGFsdGVybmF0ZSwgY29udGV4dCk7CiAgICBpZiAoIWlzTmVzdGVkKSB7CiAgICAgIGNvbnRleHQuaW5kZW50TGV2ZWwtLTsKICAgIH0KICAgIG5lZWROZXdsaW5lICYmIGRlaW5kZW50KAogICAgICB0cnVlCiAgICAgIC8qIHdpdGhvdXQgbmV3bGluZSAqLwogICAgKTsKICB9CiAgZnVuY3Rpb24gZ2VuQ2FjaGVFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQpIHsKICAgIGNvbnN0IHsgcHVzaCwgaGVscGVyLCBpbmRlbnQsIGRlaW5kZW50LCBuZXdsaW5lIH0gPSBjb250ZXh0OwogICAgcHVzaChgX2NhY2hlWyR7bm9kZS5pbmRleH1dIHx8IChgKTsKICAgIGlmIChub2RlLmlzVk5vZGUpIHsKICAgICAgaW5kZW50KCk7CiAgICAgIHB1c2goYCR7aGVscGVyKFNFVF9CTE9DS19UUkFDS0lORyl9KC0xKSxgKTsKICAgICAgbmV3bGluZSgpOwogICAgfQogICAgcHVzaChgX2NhY2hlWyR7bm9kZS5pbmRleH1dID0gYCk7CiAgICBnZW5Ob2RlKG5vZGUudmFsdWUsIGNvbnRleHQpOwogICAgaWYgKG5vZGUuaXNWTm9kZSkgewogICAgICBwdXNoKGAsYCk7CiAgICAgIG5ld2xpbmUoKTsKICAgICAgcHVzaChgJHtoZWxwZXIoU0VUX0JMT0NLX1RSQUNLSU5HKX0oMSksYCk7CiAgICAgIG5ld2xpbmUoKTsKICAgICAgcHVzaChgX2NhY2hlWyR7bm9kZS5pbmRleH1dYCk7CiAgICAgIGRlaW5kZW50KCk7CiAgICB9CiAgICBwdXNoKGApYCk7CiAgfQoKICBjb25zdCBwcm9oaWJpdGVkS2V5d29yZFJFID0gbmV3IFJlZ0V4cCgKICAgICJcXGIiICsgImFyZ3VtZW50cyxhd2FpdCxicmVhayxjYXNlLGNhdGNoLGNsYXNzLGNvbnN0LGNvbnRpbnVlLGRlYnVnZ2VyLGRlZmF1bHQsZGVsZXRlLGRvLGVsc2UsZXhwb3J0LGV4dGVuZHMsZmluYWxseSxmb3IsZnVuY3Rpb24saWYsaW1wb3J0LGxldCxuZXcscmV0dXJuLHN1cGVyLHN3aXRjaCx0aHJvdyx0cnksdmFyLHZvaWQsd2hpbGUsd2l0aCx5aWVsZCIuc3BsaXQoIiwiKS5qb2luKCJcXGJ8XFxiIikgKyAiXFxiIgogICk7CiAgY29uc3Qgc3RyaXBTdHJpbmdSRSA9IC8nKD86W14nXFxdfFxcLikqJ3wiKD86W14iXFxdfFxcLikqInxgKD86W15gXFxdfFxcLikqXCRce3xcfSg/OlteYFxcXXxcXC4pKmB8YCg/OlteYFxcXXxcXC4pKmAvZzsKICBmdW5jdGlvbiB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKG5vZGUsIGNvbnRleHQsIGFzUGFyYW1zID0gZmFsc2UsIGFzUmF3U3RhdGVtZW50cyA9IGZhbHNlKSB7CiAgICBjb25zdCBleHAgPSBub2RlLmNvbnRlbnQ7CiAgICBpZiAoIWV4cC50cmltKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdHJ5IHsKICAgICAgbmV3IEZ1bmN0aW9uKAogICAgICAgIGFzUmF3U3RhdGVtZW50cyA/IGAgJHtleHB9IGAgOiBgcmV0dXJuICR7YXNQYXJhbXMgPyBgKCR7ZXhwfSkgPT4ge31gIDogYCgke2V4cH0pYH1gCiAgICAgICk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxldCBtZXNzYWdlID0gZS5tZXNzYWdlOwogICAgICBjb25zdCBrZXl3b3JkTWF0Y2ggPSBleHAucmVwbGFjZShzdHJpcFN0cmluZ1JFLCAiIikubWF0Y2gocHJvaGliaXRlZEtleXdvcmRSRSk7CiAgICAgIGlmIChrZXl3b3JkTWF0Y2gpIHsKICAgICAgICBtZXNzYWdlID0gYGF2b2lkIHVzaW5nIEphdmFTY3JpcHQga2V5d29yZCBhcyBwcm9wZXJ0eSBuYW1lOiAiJHtrZXl3b3JkTWF0Y2hbMF19ImA7CiAgICAgIH0KICAgICAgY29udGV4dC5vbkVycm9yKAogICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoCiAgICAgICAgICA0NSwKICAgICAgICAgIG5vZGUubG9jLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgbWVzc2FnZQogICAgICAgICkKICAgICAgKTsKICAgIH0KICB9CgogIGNvbnN0IHRyYW5zZm9ybUV4cHJlc3Npb24gPSAobm9kZSwgY29udGV4dCkgPT4gewogICAgaWYgKG5vZGUudHlwZSA9PT0gNSkgewogICAgICBub2RlLmNvbnRlbnQgPSBwcm9jZXNzRXhwcmVzc2lvbigKICAgICAgICBub2RlLmNvbnRlbnQsCiAgICAgICAgY29udGV4dAogICAgICApOwogICAgfSBlbHNlIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLnByb3BzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgZGlyID0gbm9kZS5wcm9wc1tpXTsKICAgICAgICBpZiAoZGlyLnR5cGUgPT09IDcgJiYgZGlyLm5hbWUgIT09ICJmb3IiKSB7CiAgICAgICAgICBjb25zdCBleHAgPSBkaXIuZXhwOwogICAgICAgICAgY29uc3QgYXJnID0gZGlyLmFyZzsKICAgICAgICAgIGlmIChleHAgJiYgZXhwLnR5cGUgPT09IDQgJiYgIShkaXIubmFtZSA9PT0gIm9uIiAmJiBhcmcpKSB7CiAgICAgICAgICAgIGRpci5leHAgPSBwcm9jZXNzRXhwcmVzc2lvbigKICAgICAgICAgICAgICBleHAsCiAgICAgICAgICAgICAgY29udGV4dCwKICAgICAgICAgICAgICAvLyBzbG90IGFyZ3MgbXVzdCBiZSBwcm9jZXNzZWQgYXMgZnVuY3Rpb24gcGFyYW1zCiAgICAgICAgICAgICAgZGlyLm5hbWUgPT09ICJzbG90IgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFyZyAmJiBhcmcudHlwZSA9PT0gNCAmJiAhYXJnLmlzU3RhdGljKSB7CiAgICAgICAgICAgIGRpci5hcmcgPSBwcm9jZXNzRXhwcmVzc2lvbihhcmcsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgZnVuY3Rpb24gcHJvY2Vzc0V4cHJlc3Npb24obm9kZSwgY29udGV4dCwgYXNQYXJhbXMgPSBmYWxzZSwgYXNSYXdTdGF0ZW1lbnRzID0gZmFsc2UsIGxvY2FsVmFycyA9IE9iamVjdC5jcmVhdGUoY29udGV4dC5pZGVudGlmaWVycykpIHsKICAgIHsKICAgICAgewogICAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24obm9kZSwgY29udGV4dCwgYXNQYXJhbXMsIGFzUmF3U3RhdGVtZW50cyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5vZGU7CiAgICB9CiAgfQoKICBjb25zdCB0cmFuc2Zvcm1JZiA9IGNyZWF0ZVN0cnVjdHVyYWxEaXJlY3RpdmVUcmFuc2Zvcm0oCiAgICAvXihpZnxlbHNlfGVsc2UtaWYpJC8sCiAgICAobm9kZSwgZGlyLCBjb250ZXh0KSA9PiB7CiAgICAgIHJldHVybiBwcm9jZXNzSWYobm9kZSwgZGlyLCBjb250ZXh0LCAoaWZOb2RlLCBicmFuY2gsIGlzUm9vdCkgPT4gewogICAgICAgIGNvbnN0IHNpYmxpbmdzID0gY29udGV4dC5wYXJlbnQuY2hpbGRyZW47CiAgICAgICAgbGV0IGkgPSBzaWJsaW5ncy5pbmRleE9mKGlmTm9kZSk7CiAgICAgICAgbGV0IGtleSA9IDA7CiAgICAgICAgd2hpbGUgKGktLSA+PSAwKSB7CiAgICAgICAgICBjb25zdCBzaWJsaW5nID0gc2libGluZ3NbaV07CiAgICAgICAgICBpZiAoc2libGluZyAmJiBzaWJsaW5nLnR5cGUgPT09IDkpIHsKICAgICAgICAgICAga2V5ICs9IHNpYmxpbmcuYnJhbmNoZXMubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgaWYgKGlzUm9vdCkgewogICAgICAgICAgICBpZk5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVDb2RlZ2VuTm9kZUZvckJyYW5jaCgKICAgICAgICAgICAgICBicmFuY2gsCiAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgIGNvbnRleHQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHBhcmVudENvbmRpdGlvbiA9IGdldFBhcmVudENvbmRpdGlvbihpZk5vZGUuY29kZWdlbk5vZGUpOwogICAgICAgICAgICBwYXJlbnRDb25kaXRpb24uYWx0ZXJuYXRlID0gY3JlYXRlQ29kZWdlbk5vZGVGb3JCcmFuY2goCiAgICAgICAgICAgICAgYnJhbmNoLAogICAgICAgICAgICAgIGtleSArIGlmTm9kZS5icmFuY2hlcy5sZW5ndGggLSAxLAogICAgICAgICAgICAgIGNvbnRleHQKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KTsKICAgIH0KICApOwogIGZ1bmN0aW9uIHByb2Nlc3NJZihub2RlLCBkaXIsIGNvbnRleHQsIHByb2Nlc3NDb2RlZ2VuKSB7CiAgICBpZiAoZGlyLm5hbWUgIT09ICJlbHNlIiAmJiAoIWRpci5leHAgfHwgIWRpci5leHAuY29udGVudC50cmltKCkpKSB7CiAgICAgIGNvbnN0IGxvYyA9IGRpci5leHAgPyBkaXIuZXhwLmxvYyA6IG5vZGUubG9jOwogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigyOCwgZGlyLmxvYykKICAgICAgKTsKICAgICAgZGlyLmV4cCA9IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHRydWVgLCBmYWxzZSwgbG9jKTsKICAgIH0KICAgIGlmIChkaXIuZXhwKSB7CiAgICAgIHZhbGlkYXRlQnJvd3NlckV4cHJlc3Npb24oZGlyLmV4cCwgY29udGV4dCk7CiAgICB9CiAgICBpZiAoZGlyLm5hbWUgPT09ICJpZiIpIHsKICAgICAgY29uc3QgYnJhbmNoID0gY3JlYXRlSWZCcmFuY2gobm9kZSwgZGlyKTsKICAgICAgY29uc3QgaWZOb2RlID0gewogICAgICAgIHR5cGU6IDksCiAgICAgICAgbG9jOiBub2RlLmxvYywKICAgICAgICBicmFuY2hlczogW2JyYW5jaF0KICAgICAgfTsKICAgICAgY29udGV4dC5yZXBsYWNlTm9kZShpZk5vZGUpOwogICAgICBpZiAocHJvY2Vzc0NvZGVnZW4pIHsKICAgICAgICByZXR1cm4gcHJvY2Vzc0NvZGVnZW4oaWZOb2RlLCBicmFuY2gsIHRydWUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzaWJsaW5ncyA9IGNvbnRleHQucGFyZW50LmNoaWxkcmVuOwogICAgICBjb25zdCBjb21tZW50cyA9IFtdOwogICAgICBsZXQgaSA9IHNpYmxpbmdzLmluZGV4T2Yobm9kZSk7CiAgICAgIHdoaWxlIChpLS0gPj0gLTEpIHsKICAgICAgICBjb25zdCBzaWJsaW5nID0gc2libGluZ3NbaV07CiAgICAgICAgaWYgKHNpYmxpbmcgJiYgc2libGluZy50eXBlID09PSAzKSB7CiAgICAgICAgICBjb250ZXh0LnJlbW92ZU5vZGUoc2libGluZyk7CiAgICAgICAgICBjb21tZW50cy51bnNoaWZ0KHNpYmxpbmcpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChzaWJsaW5nICYmIHNpYmxpbmcudHlwZSA9PT0gMiAmJiAhc2libGluZy5jb250ZW50LnRyaW0oKS5sZW5ndGgpIHsKICAgICAgICAgIGNvbnRleHQucmVtb3ZlTm9kZShzaWJsaW5nKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc2libGluZyAmJiBzaWJsaW5nLnR5cGUgPT09IDkpIHsKICAgICAgICAgIGlmIChkaXIubmFtZSA9PT0gImVsc2UtaWYiICYmIHNpYmxpbmcuYnJhbmNoZXNbc2libGluZy5icmFuY2hlcy5sZW5ndGggLSAxXS5jb25kaXRpb24gPT09IHZvaWQgMCkgewogICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigzMCwgbm9kZS5sb2MpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0LnJlbW92ZU5vZGUoKTsKICAgICAgICAgIGNvbnN0IGJyYW5jaCA9IGNyZWF0ZUlmQnJhbmNoKG5vZGUsIGRpcik7CiAgICAgICAgICBpZiAoY29tbWVudHMubGVuZ3RoICYmIC8vICMzNjE5IGlnbm9yZSBjb21tZW50cyBpZiB0aGUgdi1pZiBpcyBkaXJlY3QgY2hpbGQgb2YgPHRyYW5zaXRpb24+CiAgICAgICAgICAhKGNvbnRleHQucGFyZW50ICYmIGNvbnRleHQucGFyZW50LnR5cGUgPT09IDEgJiYgKGNvbnRleHQucGFyZW50LnRhZyA9PT0gInRyYW5zaXRpb24iIHx8IGNvbnRleHQucGFyZW50LnRhZyA9PT0gIlRyYW5zaXRpb24iKSkpIHsKICAgICAgICAgICAgYnJhbmNoLmNoaWxkcmVuID0gWy4uLmNvbW1lbnRzLCAuLi5icmFuY2guY2hpbGRyZW5dOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb25zdCBrZXkgPSBicmFuY2gudXNlcktleTsKICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgIHNpYmxpbmcuYnJhbmNoZXMuZm9yRWFjaCgoeyB1c2VyS2V5IH0pID0+IHsKICAgICAgICAgICAgICAgIGlmIChpc1NhbWVLZXkodXNlcktleSwga2V5KSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigKICAgICAgICAgICAgICAgICAgICAgIDI5LAogICAgICAgICAgICAgICAgICAgICAgYnJhbmNoLnVzZXJLZXkubG9jCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzaWJsaW5nLmJyYW5jaGVzLnB1c2goYnJhbmNoKTsKICAgICAgICAgIGNvbnN0IG9uRXhpdCA9IHByb2Nlc3NDb2RlZ2VuICYmIHByb2Nlc3NDb2RlZ2VuKHNpYmxpbmcsIGJyYW5jaCwgZmFsc2UpOwogICAgICAgICAgdHJhdmVyc2VOb2RlKGJyYW5jaCwgY29udGV4dCk7CiAgICAgICAgICBpZiAob25FeGl0KQogICAgICAgICAgICBvbkV4aXQoKTsKICAgICAgICAgIGNvbnRleHQuY3VycmVudE5vZGUgPSBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzAsIG5vZGUubG9jKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gY3JlYXRlSWZCcmFuY2gobm9kZSwgZGlyKSB7CiAgICBjb25zdCBpc1RlbXBsYXRlSWYgPSBub2RlLnRhZ1R5cGUgPT09IDM7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAxMCwKICAgICAgbG9jOiBub2RlLmxvYywKICAgICAgY29uZGl0aW9uOiBkaXIubmFtZSA9PT0gImVsc2UiID8gdm9pZCAwIDogZGlyLmV4cCwKICAgICAgY2hpbGRyZW46IGlzVGVtcGxhdGVJZiAmJiAhZmluZERpcihub2RlLCAiZm9yIikgPyBub2RlLmNoaWxkcmVuIDogW25vZGVdLAogICAgICB1c2VyS2V5OiBmaW5kUHJvcChub2RlLCBga2V5YCksCiAgICAgIGlzVGVtcGxhdGVJZgogICAgfTsKICB9CiAgZnVuY3Rpb24gY3JlYXRlQ29kZWdlbk5vZGVGb3JCcmFuY2goYnJhbmNoLCBrZXlJbmRleCwgY29udGV4dCkgewogICAgaWYgKGJyYW5jaC5jb25kaXRpb24pIHsKICAgICAgcmV0dXJuIGNyZWF0ZUNvbmRpdGlvbmFsRXhwcmVzc2lvbigKICAgICAgICBicmFuY2guY29uZGl0aW9uLAogICAgICAgIGNyZWF0ZUNoaWxkcmVuQ29kZWdlbk5vZGUoYnJhbmNoLCBrZXlJbmRleCwgY29udGV4dCksCiAgICAgICAgLy8gbWFrZSBzdXJlIHRvIHBhc3MgaW4gYXNCbG9jazogdHJ1ZSBzbyB0aGF0IHRoZSBjb21tZW50IG5vZGUgY2FsbAogICAgICAgIC8vIGNsb3NlcyB0aGUgY3VycmVudCBibG9jay4KICAgICAgICBjcmVhdGVDYWxsRXhwcmVzc2lvbihjb250ZXh0LmhlbHBlcihDUkVBVEVfQ09NTUVOVCksIFsKICAgICAgICAgICcidi1pZiInICwKICAgICAgICAgICJ0cnVlIgogICAgICAgIF0pCiAgICAgICk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY3JlYXRlQ2hpbGRyZW5Db2RlZ2VuTm9kZShicmFuY2gsIGtleUluZGV4LCBjb250ZXh0KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gY3JlYXRlQ2hpbGRyZW5Db2RlZ2VuTm9kZShicmFuY2gsIGtleUluZGV4LCBjb250ZXh0KSB7CiAgICBjb25zdCB7IGhlbHBlciB9ID0gY29udGV4dDsKICAgIGNvbnN0IGtleVByb3BlcnR5ID0gY3JlYXRlT2JqZWN0UHJvcGVydHkoCiAgICAgIGBrZXlgLAogICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKAogICAgICAgIGAke2tleUluZGV4fWAsCiAgICAgICAgZmFsc2UsCiAgICAgICAgbG9jU3R1YiwKICAgICAgICAyCiAgICAgICkKICAgICk7CiAgICBjb25zdCB7IGNoaWxkcmVuIH0gPSBicmFuY2g7CiAgICBjb25zdCBmaXJzdENoaWxkID0gY2hpbGRyZW5bMF07CiAgICBjb25zdCBuZWVkRnJhZ21lbnRXcmFwcGVyID0gY2hpbGRyZW4ubGVuZ3RoICE9PSAxIHx8IGZpcnN0Q2hpbGQudHlwZSAhPT0gMTsKICAgIGlmIChuZWVkRnJhZ21lbnRXcmFwcGVyKSB7CiAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPT09IDEgJiYgZmlyc3RDaGlsZC50eXBlID09PSAxMSkgewogICAgICAgIGNvbnN0IHZub2RlQ2FsbCA9IGZpcnN0Q2hpbGQuY29kZWdlbk5vZGU7CiAgICAgICAgaW5qZWN0UHJvcCh2bm9kZUNhbGwsIGtleVByb3BlcnR5LCBjb250ZXh0KTsKICAgICAgICByZXR1cm4gdm5vZGVDYWxsOwogICAgICB9IGVsc2UgewogICAgICAgIGxldCBwYXRjaEZsYWcgPSA2NDsKICAgICAgICBsZXQgcGF0Y2hGbGFnVGV4dCA9IFBhdGNoRmxhZ05hbWVzWzY0XTsKICAgICAgICBpZiAoIWJyYW5jaC5pc1RlbXBsYXRlSWYgJiYgY2hpbGRyZW4uZmlsdGVyKChjKSA9PiBjLnR5cGUgIT09IDMpLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgcGF0Y2hGbGFnIHw9IDIwNDg7CiAgICAgICAgICBwYXRjaEZsYWdUZXh0ICs9IGAsICR7UGF0Y2hGbGFnTmFtZXNbMjA0OF19YDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNyZWF0ZVZOb2RlQ2FsbCgKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICBoZWxwZXIoRlJBR01FTlQpLAogICAgICAgICAgY3JlYXRlT2JqZWN0RXhwcmVzc2lvbihba2V5UHJvcGVydHldKSwKICAgICAgICAgIGNoaWxkcmVuLAogICAgICAgICAgcGF0Y2hGbGFnICsgKGAgLyogJHtwYXRjaEZsYWdUZXh0fSAqL2AgKSwKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIHRydWUsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgYnJhbmNoLmxvYwogICAgICAgICk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHJldCA9IGZpcnN0Q2hpbGQuY29kZWdlbk5vZGU7CiAgICAgIGNvbnN0IHZub2RlQ2FsbCA9IGdldE1lbW9lZFZOb2RlQ2FsbChyZXQpOwogICAgICBpZiAodm5vZGVDYWxsLnR5cGUgPT09IDEzKSB7CiAgICAgICAgY29udmVydFRvQmxvY2sodm5vZGVDYWxsLCBjb250ZXh0KTsKICAgICAgfQogICAgICBpbmplY3RQcm9wKHZub2RlQ2FsbCwga2V5UHJvcGVydHksIGNvbnRleHQpOwogICAgICByZXR1cm4gcmV0OwogICAgfQogIH0KICBmdW5jdGlvbiBpc1NhbWVLZXkoYSwgYikgewogICAgaWYgKCFhIHx8IGEudHlwZSAhPT0gYi50eXBlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChhLnR5cGUgPT09IDYpIHsKICAgICAgaWYgKGEudmFsdWUuY29udGVudCAhPT0gYi52YWx1ZS5jb250ZW50KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBleHAgPSBhLmV4cDsKICAgICAgY29uc3QgYnJhbmNoRXhwID0gYi5leHA7CiAgICAgIGlmIChleHAudHlwZSAhPT0gYnJhbmNoRXhwLnR5cGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKGV4cC50eXBlICE9PSA0IHx8IGV4cC5pc1N0YXRpYyAhPT0gYnJhbmNoRXhwLmlzU3RhdGljIHx8IGV4cC5jb250ZW50ICE9PSBicmFuY2hFeHAuY29udGVudCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uIGdldFBhcmVudENvbmRpdGlvbihub2RlKSB7CiAgICB3aGlsZSAodHJ1ZSkgewogICAgICBpZiAobm9kZS50eXBlID09PSAxOSkgewogICAgICAgIGlmIChub2RlLmFsdGVybmF0ZS50eXBlID09PSAxOSkgewogICAgICAgICAgbm9kZSA9IG5vZGUuYWx0ZXJuYXRlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobm9kZS50eXBlID09PSAyMCkgewogICAgICAgIG5vZGUgPSBub2RlLnZhbHVlOwogICAgICB9CiAgICB9CiAgfQoKICBjb25zdCB0cmFuc2Zvcm1Gb3IgPSBjcmVhdGVTdHJ1Y3R1cmFsRGlyZWN0aXZlVHJhbnNmb3JtKAogICAgImZvciIsCiAgICAobm9kZSwgZGlyLCBjb250ZXh0KSA9PiB7CiAgICAgIGNvbnN0IHsgaGVscGVyLCByZW1vdmVIZWxwZXIgfSA9IGNvbnRleHQ7CiAgICAgIHJldHVybiBwcm9jZXNzRm9yKG5vZGUsIGRpciwgY29udGV4dCwgKGZvck5vZGUpID0+IHsKICAgICAgICBjb25zdCByZW5kZXJFeHAgPSBjcmVhdGVDYWxsRXhwcmVzc2lvbihoZWxwZXIoUkVOREVSX0xJU1QpLCBbCiAgICAgICAgICBmb3JOb2RlLnNvdXJjZQogICAgICAgIF0pOwogICAgICAgIGNvbnN0IGlzVGVtcGxhdGUgPSBpc1RlbXBsYXRlTm9kZShub2RlKTsKICAgICAgICBjb25zdCBtZW1vID0gZmluZERpcihub2RlLCAibWVtbyIpOwogICAgICAgIGNvbnN0IGtleVByb3AgPSBmaW5kUHJvcChub2RlLCBga2V5YCk7CiAgICAgICAgY29uc3Qga2V5RXhwID0ga2V5UHJvcCAmJiAoa2V5UHJvcC50eXBlID09PSA2ID8gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihrZXlQcm9wLnZhbHVlLmNvbnRlbnQsIHRydWUpIDoga2V5UHJvcC5leHApOwogICAgICAgIGNvbnN0IGtleVByb3BlcnR5ID0ga2V5UHJvcCA/IGNyZWF0ZU9iamVjdFByb3BlcnR5KGBrZXlgLCBrZXlFeHApIDogbnVsbDsKICAgICAgICBjb25zdCBpc1N0YWJsZUZyYWdtZW50ID0gZm9yTm9kZS5zb3VyY2UudHlwZSA9PT0gNCAmJiBmb3JOb2RlLnNvdXJjZS5jb25zdFR5cGUgPiAwOwogICAgICAgIGNvbnN0IGZyYWdtZW50RmxhZyA9IGlzU3RhYmxlRnJhZ21lbnQgPyA2NCA6IGtleVByb3AgPyAxMjggOiAyNTY7CiAgICAgICAgZm9yTm9kZS5jb2RlZ2VuTm9kZSA9IGNyZWF0ZVZOb2RlQ2FsbCgKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICBoZWxwZXIoRlJBR01FTlQpLAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgcmVuZGVyRXhwLAogICAgICAgICAgZnJhZ21lbnRGbGFnICsgKGAgLyogJHtQYXRjaEZsYWdOYW1lc1tmcmFnbWVudEZsYWddfSAqL2AgKSwKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgIHRydWUsCiAgICAgICAgICAhaXNTdGFibGVGcmFnbWVudCwKICAgICAgICAgIGZhbHNlLAogICAgICAgICAgbm9kZS5sb2MKICAgICAgICApOwogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICBsZXQgY2hpbGRCbG9jazsKICAgICAgICAgIGNvbnN0IHsgY2hpbGRyZW4gfSA9IGZvck5vZGU7CiAgICAgICAgICBpZiAoaXNUZW1wbGF0ZSkgewogICAgICAgICAgICBub2RlLmNoaWxkcmVuLnNvbWUoKGMpID0+IHsKICAgICAgICAgICAgICBpZiAoYy50eXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBmaW5kUHJvcChjLCAia2V5Iik7CiAgICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKAogICAgICAgICAgICAgICAgICAgICAgMzMsCiAgICAgICAgICAgICAgICAgICAgICBrZXkubG9jCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgbmVlZEZyYWdtZW50V3JhcHBlciA9IGNoaWxkcmVuLmxlbmd0aCAhPT0gMSB8fCBjaGlsZHJlblswXS50eXBlICE9PSAxOwogICAgICAgICAgY29uc3Qgc2xvdE91dGxldCA9IGlzU2xvdE91dGxldChub2RlKSA/IG5vZGUgOiBpc1RlbXBsYXRlICYmIG5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmIGlzU2xvdE91dGxldChub2RlLmNoaWxkcmVuWzBdKSA/IG5vZGUuY2hpbGRyZW5bMF0gOiBudWxsOwogICAgICAgICAgaWYgKHNsb3RPdXRsZXQpIHsKICAgICAgICAgICAgY2hpbGRCbG9jayA9IHNsb3RPdXRsZXQuY29kZWdlbk5vZGU7CiAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlICYmIGtleVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgaW5qZWN0UHJvcChjaGlsZEJsb2NrLCBrZXlQcm9wZXJ0eSwgY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobmVlZEZyYWdtZW50V3JhcHBlcikgewogICAgICAgICAgICBjaGlsZEJsb2NrID0gY3JlYXRlVk5vZGVDYWxsKAogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgaGVscGVyKEZSQUdNRU5UKSwKICAgICAgICAgICAgICBrZXlQcm9wZXJ0eSA/IGNyZWF0ZU9iamVjdEV4cHJlc3Npb24oW2tleVByb3BlcnR5XSkgOiB2b2lkIDAsCiAgICAgICAgICAgICAgbm9kZS5jaGlsZHJlbiwKICAgICAgICAgICAgICA2NCArIChgIC8qICR7UGF0Y2hGbGFnTmFtZXNbNjRdfSAqL2AgKSwKICAgICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGlsZEJsb2NrID0gY2hpbGRyZW5bMF0uY29kZWdlbk5vZGU7CiAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlICYmIGtleVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgaW5qZWN0UHJvcChjaGlsZEJsb2NrLCBrZXlQcm9wZXJ0eSwgY29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkQmxvY2suaXNCbG9jayAhPT0gIWlzU3RhYmxlRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGRCbG9jay5pc0Jsb2NrKSB7CiAgICAgICAgICAgICAgICByZW1vdmVIZWxwZXIoT1BFTl9CTE9DSyk7CiAgICAgICAgICAgICAgICByZW1vdmVIZWxwZXIoCiAgICAgICAgICAgICAgICAgIGdldFZOb2RlQmxvY2tIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlbW92ZUhlbHBlcigKICAgICAgICAgICAgICAgICAgZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkQmxvY2suaXNCbG9jayA9ICFpc1N0YWJsZUZyYWdtZW50OwogICAgICAgICAgICBpZiAoY2hpbGRCbG9jay5pc0Jsb2NrKSB7CiAgICAgICAgICAgICAgaGVscGVyKE9QRU5fQkxPQ0spOwogICAgICAgICAgICAgIGhlbHBlcihnZXRWTm9kZUJsb2NrSGVscGVyKGNvbnRleHQuaW5TU1IsIGNoaWxkQmxvY2suaXNDb21wb25lbnQpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoZWxwZXIoZ2V0Vk5vZGVIZWxwZXIoY29udGV4dC5pblNTUiwgY2hpbGRCbG9jay5pc0NvbXBvbmVudCkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWVtbykgewogICAgICAgICAgICBjb25zdCBsb29wID0gY3JlYXRlRnVuY3Rpb25FeHByZXNzaW9uKAogICAgICAgICAgICAgIGNyZWF0ZUZvckxvb3BQYXJhbXMoZm9yTm9kZS5wYXJzZVJlc3VsdCwgWwogICAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgX2NhY2hlZGApCiAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgbG9vcC5ib2R5ID0gY3JlYXRlQmxvY2tTdGF0ZW1lbnQoWwogICAgICAgICAgICAgIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbYGNvbnN0IF9tZW1vID0gKGAsIG1lbW8uZXhwLCBgKWBdKSwKICAgICAgICAgICAgICBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWwogICAgICAgICAgICAgICAgYGlmIChfY2FjaGVkYCwKICAgICAgICAgICAgICAgIC4uLmtleUV4cCA/IFtgICYmIF9jYWNoZWQua2V5ID09PSBgLCBrZXlFeHBdIDogW10sCiAgICAgICAgICAgICAgICBgICYmICR7Y29udGV4dC5oZWxwZXJTdHJpbmcoCiAgICAgICAgICAgICAgICBJU19NRU1PX1NBTUUKICAgICAgICAgICAgICApfShfY2FjaGVkLCBfbWVtbykpIHJldHVybiBfY2FjaGVkYAogICAgICAgICAgICAgIF0pLAogICAgICAgICAgICAgIGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbYGNvbnN0IF9pdGVtID0gYCwgY2hpbGRCbG9ja10pLAogICAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYF9pdGVtLm1lbW8gPSBfbWVtb2ApLAogICAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHJldHVybiBfaXRlbWApCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICByZW5kZXJFeHAuYXJndW1lbnRzLnB1c2goCiAgICAgICAgICAgICAgbG9vcCwKICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBfY2FjaGVgKSwKICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKFN0cmluZyhjb250ZXh0LmNhY2hlZCsrKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlckV4cC5hcmd1bWVudHMucHVzaCgKICAgICAgICAgICAgICBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oCiAgICAgICAgICAgICAgICBjcmVhdGVGb3JMb29wUGFyYW1zKGZvck5vZGUucGFyc2VSZXN1bHQpLAogICAgICAgICAgICAgICAgY2hpbGRCbG9jaywKICAgICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9CiAgKTsKICBmdW5jdGlvbiBwcm9jZXNzRm9yKG5vZGUsIGRpciwgY29udGV4dCwgcHJvY2Vzc0NvZGVnZW4pIHsKICAgIGlmICghZGlyLmV4cCkgewogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigzMSwgZGlyLmxvYykKICAgICAgKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3QgcGFyc2VSZXN1bHQgPSBkaXIuZm9yUGFyc2VSZXN1bHQ7CiAgICBpZiAoIXBhcnNlUmVzdWx0KSB7CiAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDMyLCBkaXIubG9jKQogICAgICApOwogICAgICByZXR1cm47CiAgICB9CiAgICBmaW5hbGl6ZUZvclBhcnNlUmVzdWx0KHBhcnNlUmVzdWx0LCBjb250ZXh0KTsKICAgIGNvbnN0IHsgYWRkSWRlbnRpZmllcnMsIHJlbW92ZUlkZW50aWZpZXJzLCBzY29wZXMgfSA9IGNvbnRleHQ7CiAgICBjb25zdCB7IHNvdXJjZSwgdmFsdWUsIGtleSwgaW5kZXggfSA9IHBhcnNlUmVzdWx0OwogICAgY29uc3QgZm9yTm9kZSA9IHsKICAgICAgdHlwZTogMTEsCiAgICAgIGxvYzogZGlyLmxvYywKICAgICAgc291cmNlLAogICAgICB2YWx1ZUFsaWFzOiB2YWx1ZSwKICAgICAga2V5QWxpYXM6IGtleSwKICAgICAgb2JqZWN0SW5kZXhBbGlhczogaW5kZXgsCiAgICAgIHBhcnNlUmVzdWx0LAogICAgICBjaGlsZHJlbjogaXNUZW1wbGF0ZU5vZGUobm9kZSkgPyBub2RlLmNoaWxkcmVuIDogW25vZGVdCiAgICB9OwogICAgY29udGV4dC5yZXBsYWNlTm9kZShmb3JOb2RlKTsKICAgIHNjb3Blcy52Rm9yKys7CiAgICBjb25zdCBvbkV4aXQgPSBwcm9jZXNzQ29kZWdlbiAmJiBwcm9jZXNzQ29kZWdlbihmb3JOb2RlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHNjb3Blcy52Rm9yLS07CiAgICAgIGlmIChvbkV4aXQpCiAgICAgICAgb25FeGl0KCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBmaW5hbGl6ZUZvclBhcnNlUmVzdWx0KHJlc3VsdCwgY29udGV4dCkgewogICAgaWYgKHJlc3VsdC5maW5hbGl6ZWQpCiAgICAgIHJldHVybjsKICAgIHsKICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbihyZXN1bHQuc291cmNlLCBjb250ZXh0KTsKICAgICAgaWYgKHJlc3VsdC5rZXkpIHsKICAgICAgICB2YWxpZGF0ZUJyb3dzZXJFeHByZXNzaW9uKAogICAgICAgICAgcmVzdWx0LmtleSwKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0LmluZGV4KSB7CiAgICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbigKICAgICAgICAgIHJlc3VsdC5pbmRleCwKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0LnZhbHVlKSB7CiAgICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbigKICAgICAgICAgIHJlc3VsdC52YWx1ZSwKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICB0cnVlCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgcmVzdWx0LmZpbmFsaXplZCA9IHRydWU7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZUZvckxvb3BQYXJhbXMoeyB2YWx1ZSwga2V5LCBpbmRleCB9LCBtZW1vQXJncyA9IFtdKSB7CiAgICByZXR1cm4gY3JlYXRlUGFyYW1zTGlzdChbdmFsdWUsIGtleSwgaW5kZXgsIC4uLm1lbW9BcmdzXSk7CiAgfQogIGZ1bmN0aW9uIGNyZWF0ZVBhcmFtc0xpc3QoYXJncykgewogICAgbGV0IGkgPSBhcmdzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgaWYgKGFyZ3NbaV0pCiAgICAgICAgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gYXJncy5zbGljZSgwLCBpICsgMSkubWFwKChhcmcsIGkyKSA9PiBhcmcgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgX2AucmVwZWF0KGkyICsgMSksIGZhbHNlKSk7CiAgfQoKICBjb25zdCBkZWZhdWx0RmFsbGJhY2sgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB1bmRlZmluZWRgLCBmYWxzZSk7CiAgY29uc3QgdHJhY2tTbG90U2NvcGVzID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEgJiYgKG5vZGUudGFnVHlwZSA9PT0gMSB8fCBub2RlLnRhZ1R5cGUgPT09IDMpKSB7CiAgICAgIGNvbnN0IHZTbG90ID0gZmluZERpcihub2RlLCAic2xvdCIpOwogICAgICBpZiAodlNsb3QpIHsKICAgICAgICB2U2xvdC5leHA7CiAgICAgICAgY29udGV4dC5zY29wZXMudlNsb3QrKzsKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgY29udGV4dC5zY29wZXMudlNsb3QtLTsKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgfTsKICBjb25zdCBidWlsZENsaWVudFNsb3RGbiA9IChwcm9wcywgX3ZGb3JFeHAsIGNoaWxkcmVuLCBsb2MpID0+IGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbigKICAgIHByb3BzLAogICAgY2hpbGRyZW4sCiAgICBmYWxzZSwKICAgIHRydWUsCiAgICBjaGlsZHJlbi5sZW5ndGggPyBjaGlsZHJlblswXS5sb2MgOiBsb2MKICApOwogIGZ1bmN0aW9uIGJ1aWxkU2xvdHMobm9kZSwgY29udGV4dCwgYnVpbGRTbG90Rm4gPSBidWlsZENsaWVudFNsb3RGbikgewogICAgY29udGV4dC5oZWxwZXIoV0lUSF9DVFgpOwogICAgY29uc3QgeyBjaGlsZHJlbiwgbG9jIH0gPSBub2RlOwogICAgY29uc3Qgc2xvdHNQcm9wZXJ0aWVzID0gW107CiAgICBjb25zdCBkeW5hbWljU2xvdHMgPSBbXTsKICAgIGxldCBoYXNEeW5hbWljU2xvdHMgPSBjb250ZXh0LnNjb3Blcy52U2xvdCA+IDAgfHwgY29udGV4dC5zY29wZXMudkZvciA+IDA7CiAgICBjb25zdCBvbkNvbXBvbmVudFNsb3QgPSBmaW5kRGlyKG5vZGUsICJzbG90IiwgdHJ1ZSk7CiAgICBpZiAob25Db21wb25lbnRTbG90KSB7CiAgICAgIGNvbnN0IHsgYXJnLCBleHAgfSA9IG9uQ29tcG9uZW50U2xvdDsKICAgICAgaWYgKGFyZyAmJiAhaXNTdGF0aWNFeHAoYXJnKSkgewogICAgICAgIGhhc0R5bmFtaWNTbG90cyA9IHRydWU7CiAgICAgIH0KICAgICAgc2xvdHNQcm9wZXJ0aWVzLnB1c2goCiAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoCiAgICAgICAgICBhcmcgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigiZGVmYXVsdCIsIHRydWUpLAogICAgICAgICAgYnVpbGRTbG90Rm4oZXhwLCB2b2lkIDAsIGNoaWxkcmVuLCBsb2MpCiAgICAgICAgKQogICAgICApOwogICAgfQogICAgbGV0IGhhc1RlbXBsYXRlU2xvdHMgPSBmYWxzZTsKICAgIGxldCBoYXNOYW1lZERlZmF1bHRTbG90ID0gZmFsc2U7CiAgICBjb25zdCBpbXBsaWNpdERlZmF1bHRDaGlsZHJlbiA9IFtdOwogICAgY29uc3Qgc2VlblNsb3ROYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICBsZXQgY29uZGl0aW9uYWxCcmFuY2hJbmRleCA9IDA7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IHNsb3RFbGVtZW50ID0gY2hpbGRyZW5baV07CiAgICAgIGxldCBzbG90RGlyOwogICAgICBpZiAoIWlzVGVtcGxhdGVOb2RlKHNsb3RFbGVtZW50KSB8fCAhKHNsb3REaXIgPSBmaW5kRGlyKHNsb3RFbGVtZW50LCAic2xvdCIsIHRydWUpKSkgewogICAgICAgIGlmIChzbG90RWxlbWVudC50eXBlICE9PSAzKSB7CiAgICAgICAgICBpbXBsaWNpdERlZmF1bHRDaGlsZHJlbi5wdXNoKHNsb3RFbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKG9uQ29tcG9uZW50U2xvdCkgewogICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzcsIHNsb3REaXIubG9jKQogICAgICAgICk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgaGFzVGVtcGxhdGVTbG90cyA9IHRydWU7CiAgICAgIGNvbnN0IHsgY2hpbGRyZW46IHNsb3RDaGlsZHJlbiwgbG9jOiBzbG90TG9jIH0gPSBzbG90RWxlbWVudDsKICAgICAgY29uc3QgewogICAgICAgIGFyZzogc2xvdE5hbWUgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGBkZWZhdWx0YCwgdHJ1ZSksCiAgICAgICAgZXhwOiBzbG90UHJvcHMsCiAgICAgICAgbG9jOiBkaXJMb2MKICAgICAgfSA9IHNsb3REaXI7CiAgICAgIGxldCBzdGF0aWNTbG90TmFtZTsKICAgICAgaWYgKGlzU3RhdGljRXhwKHNsb3ROYW1lKSkgewogICAgICAgIHN0YXRpY1Nsb3ROYW1lID0gc2xvdE5hbWUgPyBzbG90TmFtZS5jb250ZW50IDogYGRlZmF1bHRgOwogICAgICB9IGVsc2UgewogICAgICAgIGhhc0R5bmFtaWNTbG90cyA9IHRydWU7CiAgICAgIH0KICAgICAgY29uc3QgdkZvciA9IGZpbmREaXIoc2xvdEVsZW1lbnQsICJmb3IiKTsKICAgICAgY29uc3Qgc2xvdEZ1bmN0aW9uID0gYnVpbGRTbG90Rm4oc2xvdFByb3BzLCB2Rm9yLCBzbG90Q2hpbGRyZW4sIHNsb3RMb2MpOwogICAgICBsZXQgdklmOwogICAgICBsZXQgdkVsc2U7CiAgICAgIGlmICh2SWYgPSBmaW5kRGlyKHNsb3RFbGVtZW50LCAiaWYiKSkgewogICAgICAgIGhhc0R5bmFtaWNTbG90cyA9IHRydWU7CiAgICAgICAgZHluYW1pY1Nsb3RzLnB1c2goCiAgICAgICAgICBjcmVhdGVDb25kaXRpb25hbEV4cHJlc3Npb24oCiAgICAgICAgICAgIHZJZi5leHAsCiAgICAgICAgICAgIGJ1aWxkRHluYW1pY1Nsb3Qoc2xvdE5hbWUsIHNsb3RGdW5jdGlvbiwgY29uZGl0aW9uYWxCcmFuY2hJbmRleCsrKSwKICAgICAgICAgICAgZGVmYXVsdEZhbGxiYWNrCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmICh2RWxzZSA9IGZpbmREaXIoCiAgICAgICAgc2xvdEVsZW1lbnQsCiAgICAgICAgL15lbHNlKC1pZik/JC8sCiAgICAgICAgdHJ1ZQogICAgICAgIC8qIGFsbG93RW1wdHkgKi8KICAgICAgKSkgewogICAgICAgIGxldCBqID0gaTsKICAgICAgICBsZXQgcHJldjsKICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICBwcmV2ID0gY2hpbGRyZW5bal07CiAgICAgICAgICBpZiAocHJldi50eXBlICE9PSAzKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocHJldiAmJiBpc1RlbXBsYXRlTm9kZShwcmV2KSAmJiBmaW5kRGlyKHByZXYsICJpZiIpKSB7CiAgICAgICAgICBjaGlsZHJlbi5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBpLS07CiAgICAgICAgICBsZXQgY29uZGl0aW9uYWwgPSBkeW5hbWljU2xvdHNbZHluYW1pY1Nsb3RzLmxlbmd0aCAtIDFdOwogICAgICAgICAgd2hpbGUgKGNvbmRpdGlvbmFsLmFsdGVybmF0ZS50eXBlID09PSAxOSkgewogICAgICAgICAgICBjb25kaXRpb25hbCA9IGNvbmRpdGlvbmFsLmFsdGVybmF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbmRpdGlvbmFsLmFsdGVybmF0ZSA9IHZFbHNlLmV4cCA/IGNyZWF0ZUNvbmRpdGlvbmFsRXhwcmVzc2lvbigKICAgICAgICAgICAgdkVsc2UuZXhwLAogICAgICAgICAgICBidWlsZER5bmFtaWNTbG90KAogICAgICAgICAgICAgIHNsb3ROYW1lLAogICAgICAgICAgICAgIHNsb3RGdW5jdGlvbiwKICAgICAgICAgICAgICBjb25kaXRpb25hbEJyYW5jaEluZGV4KysKICAgICAgICAgICAgKSwKICAgICAgICAgICAgZGVmYXVsdEZhbGxiYWNrCiAgICAgICAgICApIDogYnVpbGREeW5hbWljU2xvdChzbG90TmFtZSwgc2xvdEZ1bmN0aW9uLCBjb25kaXRpb25hbEJyYW5jaEluZGV4KyspOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoMzAsIHZFbHNlLmxvYykKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHZGb3IpIHsKICAgICAgICBoYXNEeW5hbWljU2xvdHMgPSB0cnVlOwogICAgICAgIGNvbnN0IHBhcnNlUmVzdWx0ID0gdkZvci5mb3JQYXJzZVJlc3VsdDsKICAgICAgICBpZiAocGFyc2VSZXN1bHQpIHsKICAgICAgICAgIGZpbmFsaXplRm9yUGFyc2VSZXN1bHQocGFyc2VSZXN1bHQsIGNvbnRleHQpOwogICAgICAgICAgZHluYW1pY1Nsb3RzLnB1c2goCiAgICAgICAgICAgIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFJFTkRFUl9MSVNUKSwgWwogICAgICAgICAgICAgIHBhcnNlUmVzdWx0LnNvdXJjZSwKICAgICAgICAgICAgICBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oCiAgICAgICAgICAgICAgICBjcmVhdGVGb3JMb29wUGFyYW1zKHBhcnNlUmVzdWx0KSwKICAgICAgICAgICAgICAgIGJ1aWxkRHluYW1pY1Nsb3Qoc2xvdE5hbWUsIHNsb3RGdW5jdGlvbiksCiAgICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICAgKQogICAgICAgICAgICBdKQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29udGV4dC5vbkVycm9yKAogICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKAogICAgICAgICAgICAgIDMyLAogICAgICAgICAgICAgIHZGb3IubG9jCiAgICAgICAgICAgICkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzdGF0aWNTbG90TmFtZSkgewogICAgICAgICAgaWYgKHNlZW5TbG90TmFtZXMuaGFzKHN0YXRpY1Nsb3ROYW1lKSkgewogICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigKICAgICAgICAgICAgICAgIDM4LAogICAgICAgICAgICAgICAgZGlyTG9jCiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHNlZW5TbG90TmFtZXMuYWRkKHN0YXRpY1Nsb3ROYW1lKTsKICAgICAgICAgIGlmIChzdGF0aWNTbG90TmFtZSA9PT0gImRlZmF1bHQiKSB7CiAgICAgICAgICAgIGhhc05hbWVkRGVmYXVsdFNsb3QgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChjcmVhdGVPYmplY3RQcm9wZXJ0eShzbG90TmFtZSwgc2xvdEZ1bmN0aW9uKSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghb25Db21wb25lbnRTbG90KSB7CiAgICAgIGNvbnN0IGJ1aWxkRGVmYXVsdFNsb3RQcm9wZXJ0eSA9IChwcm9wcywgY2hpbGRyZW4yKSA9PiB7CiAgICAgICAgY29uc3QgZm4gPSBidWlsZFNsb3RGbihwcm9wcywgdm9pZCAwLCBjaGlsZHJlbjIsIGxvYyk7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU9iamVjdFByb3BlcnR5KGBkZWZhdWx0YCwgZm4pOwogICAgICB9OwogICAgICBpZiAoIWhhc1RlbXBsYXRlU2xvdHMpIHsKICAgICAgICBzbG90c1Byb3BlcnRpZXMucHVzaChidWlsZERlZmF1bHRTbG90UHJvcGVydHkodm9pZCAwLCBjaGlsZHJlbikpOwogICAgICB9IGVsc2UgaWYgKGltcGxpY2l0RGVmYXVsdENoaWxkcmVuLmxlbmd0aCAmJiAvLyAjMzc2NgogICAgICAvLyB3aXRoIHdoaXRlc3BhY2U6ICdwcmVzZXJ2ZScsIHdoaXRlc3BhY2VzIGJldHdlZW4gc2xvdHMgd2lsbCBlbmQgdXAgaW4KICAgICAgLy8gaW1wbGljaXREZWZhdWx0Q2hpbGRyZW4uIElnbm9yZSBpZiBhbGwgaW1wbGljaXQgY2hpbGRyZW4gYXJlIHdoaXRlc3BhY2VzLgogICAgICBpbXBsaWNpdERlZmF1bHRDaGlsZHJlbi5zb21lKChub2RlMikgPT4gaXNOb25XaGl0ZXNwYWNlQ29udGVudChub2RlMikpKSB7CiAgICAgICAgaWYgKGhhc05hbWVkRGVmYXVsdFNsb3QpIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcigKICAgICAgICAgICAgICAzOSwKICAgICAgICAgICAgICBpbXBsaWNpdERlZmF1bHRDaGlsZHJlblswXS5sb2MKICAgICAgICAgICAgKQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2xvdHNQcm9wZXJ0aWVzLnB1c2goCiAgICAgICAgICAgIGJ1aWxkRGVmYXVsdFNsb3RQcm9wZXJ0eSh2b2lkIDAsIGltcGxpY2l0RGVmYXVsdENoaWxkcmVuKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHNsb3RGbGFnID0gaGFzRHluYW1pY1Nsb3RzID8gMiA6IGhhc0ZvcndhcmRlZFNsb3RzKG5vZGUuY2hpbGRyZW4pID8gMyA6IDE7CiAgICBsZXQgc2xvdHMgPSBjcmVhdGVPYmplY3RFeHByZXNzaW9uKAogICAgICBzbG90c1Byb3BlcnRpZXMuY29uY2F0KAogICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KAogICAgICAgICAgYF9gLAogICAgICAgICAgLy8gMiA9IGNvbXBpbGVkIGJ1dCBkeW5hbWljID0gY2FuIHNraXAgbm9ybWFsaXphdGlvbiwgYnV0IG11c3QgcnVuIGRpZmYKICAgICAgICAgIC8vIDEgPSBjb21waWxlZCBhbmQgc3RhdGljID0gY2FuIHNraXAgbm9ybWFsaXphdGlvbiBBTkQgZGlmZiBhcyBvcHRpbWl6ZWQKICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oCiAgICAgICAgICAgIHNsb3RGbGFnICsgKGAgLyogJHtzbG90RmxhZ3NUZXh0W3Nsb3RGbGFnXX0gKi9gICksCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApCiAgICAgICAgKQogICAgICApLAogICAgICBsb2MKICAgICk7CiAgICBpZiAoZHluYW1pY1Nsb3RzLmxlbmd0aCkgewogICAgICBzbG90cyA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKENSRUFURV9TTE9UUyksIFsKICAgICAgICBzbG90cywKICAgICAgICBjcmVhdGVBcnJheUV4cHJlc3Npb24oZHluYW1pY1Nsb3RzKQogICAgICBdKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHNsb3RzLAogICAgICBoYXNEeW5hbWljU2xvdHMKICAgIH07CiAgfQogIGZ1bmN0aW9uIGJ1aWxkRHluYW1pY1Nsb3QobmFtZSwgZm4sIGluZGV4KSB7CiAgICBjb25zdCBwcm9wcyA9IFsKICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoYG5hbWVgLCBuYW1lKSwKICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoYGZuYCwgZm4pCiAgICBdOwogICAgaWYgKGluZGV4ICE9IG51bGwpIHsKICAgICAgcHJvcHMucHVzaCgKICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShga2V5YCwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihTdHJpbmcoaW5kZXgpLCB0cnVlKSkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBjcmVhdGVPYmplY3RFeHByZXNzaW9uKHByb3BzKTsKICB9CiAgZnVuY3Rpb24gaGFzRm9yd2FyZGVkU2xvdHMoY2hpbGRyZW4pIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgc3dpdGNoIChjaGlsZC50eXBlKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgaWYgKGNoaWxkLnRhZ1R5cGUgPT09IDIgfHwgaGFzRm9yd2FyZGVkU2xvdHMoY2hpbGQuY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSA5OgogICAgICAgICAgaWYgKGhhc0ZvcndhcmRlZFNsb3RzKGNoaWxkLmJyYW5jaGVzKSkKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDEwOgogICAgICAgIGNhc2UgMTE6CiAgICAgICAgICBpZiAoaGFzRm9yd2FyZGVkU2xvdHMoY2hpbGQuY2hpbGRyZW4pKQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uIGlzTm9uV2hpdGVzcGFjZUNvbnRlbnQobm9kZSkgewogICAgaWYgKG5vZGUudHlwZSAhPT0gMiAmJiBub2RlLnR5cGUgIT09IDEyKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBub2RlLnR5cGUgPT09IDIgPyAhIW5vZGUuY29udGVudC50cmltKCkgOiBpc05vbldoaXRlc3BhY2VDb250ZW50KG5vZGUuY29udGVudCk7CiAgfQoKICBjb25zdCBkaXJlY3RpdmVJbXBvcnRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBjb25zdCB0cmFuc2Zvcm1FbGVtZW50ID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgIHJldHVybiBmdW5jdGlvbiBwb3N0VHJhbnNmb3JtRWxlbWVudCgpIHsKICAgICAgbm9kZSA9IGNvbnRleHQuY3VycmVudE5vZGU7CiAgICAgIGlmICghKG5vZGUudHlwZSA9PT0gMSAmJiAobm9kZS50YWdUeXBlID09PSAwIHx8IG5vZGUudGFnVHlwZSA9PT0gMSkpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnN0IHsgdGFnLCBwcm9wcyB9ID0gbm9kZTsKICAgICAgY29uc3QgaXNDb21wb25lbnQgPSBub2RlLnRhZ1R5cGUgPT09IDE7CiAgICAgIGxldCB2bm9kZVRhZyA9IGlzQ29tcG9uZW50ID8gcmVzb2x2ZUNvbXBvbmVudFR5cGUobm9kZSwgY29udGV4dCkgOiBgIiR7dGFnfSJgOwogICAgICBjb25zdCBpc0R5bmFtaWNDb21wb25lbnQgPSBpc09iamVjdCh2bm9kZVRhZykgJiYgdm5vZGVUYWcuY2FsbGVlID09PSBSRVNPTFZFX0RZTkFNSUNfQ09NUE9ORU5UOwogICAgICBsZXQgdm5vZGVQcm9wczsKICAgICAgbGV0IHZub2RlQ2hpbGRyZW47CiAgICAgIGxldCB2bm9kZVBhdGNoRmxhZzsKICAgICAgbGV0IHBhdGNoRmxhZyA9IDA7CiAgICAgIGxldCB2bm9kZUR5bmFtaWNQcm9wczsKICAgICAgbGV0IGR5bmFtaWNQcm9wTmFtZXM7CiAgICAgIGxldCB2bm9kZURpcmVjdGl2ZXM7CiAgICAgIGxldCBzaG91bGRVc2VCbG9jayA9ICgKICAgICAgICAvLyBkeW5hbWljIGNvbXBvbmVudCBtYXkgcmVzb2x2ZSB0byBwbGFpbiBlbGVtZW50cwogICAgICAgIGlzRHluYW1pY0NvbXBvbmVudCB8fCB2bm9kZVRhZyA9PT0gVEVMRVBPUlQgfHwgdm5vZGVUYWcgPT09IFNVU1BFTlNFIHx8ICFpc0NvbXBvbmVudCAmJiAvLyA8c3ZnPiBhbmQgPGZvcmVpZ25PYmplY3Q+IG11c3QgYmUgZm9yY2VkIGludG8gYmxvY2tzIHNvIHRoYXQgYmxvY2sKICAgICAgICAvLyB1cGRhdGVzIGluc2lkZSBnZXQgcHJvcGVyIGlzU1ZHIGZsYWcgYXQgcnVudGltZS4gKCM2MzksICM2NDMpCiAgICAgICAgLy8gVGhpcyBpcyB0ZWNobmljYWxseSB3ZWItc3BlY2lmaWMsIGJ1dCBzcGxpdHRpbmcgdGhlIGxvZ2ljIG91dCBvZiBjb3JlCiAgICAgICAgLy8gbGVhZHMgdG8gdG9vIG11Y2ggdW5uZWNlc3NhcnkgY29tcGxleGl0eS4KICAgICAgICAodGFnID09PSAic3ZnIiB8fCB0YWcgPT09ICJmb3JlaWduT2JqZWN0IikKICAgICAgKTsKICAgICAgaWYgKHByb3BzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBwcm9wc0J1aWxkUmVzdWx0ID0gYnVpbGRQcm9wcygKICAgICAgICAgIG5vZGUsCiAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgdm9pZCAwLAogICAgICAgICAgaXNDb21wb25lbnQsCiAgICAgICAgICBpc0R5bmFtaWNDb21wb25lbnQKICAgICAgICApOwogICAgICAgIHZub2RlUHJvcHMgPSBwcm9wc0J1aWxkUmVzdWx0LnByb3BzOwogICAgICAgIHBhdGNoRmxhZyA9IHByb3BzQnVpbGRSZXN1bHQucGF0Y2hGbGFnOwogICAgICAgIGR5bmFtaWNQcm9wTmFtZXMgPSBwcm9wc0J1aWxkUmVzdWx0LmR5bmFtaWNQcm9wTmFtZXM7CiAgICAgICAgY29uc3QgZGlyZWN0aXZlcyA9IHByb3BzQnVpbGRSZXN1bHQuZGlyZWN0aXZlczsKICAgICAgICB2bm9kZURpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzICYmIGRpcmVjdGl2ZXMubGVuZ3RoID8gY3JlYXRlQXJyYXlFeHByZXNzaW9uKAogICAgICAgICAgZGlyZWN0aXZlcy5tYXAoKGRpcikgPT4gYnVpbGREaXJlY3RpdmVBcmdzKGRpciwgY29udGV4dCkpCiAgICAgICAgKSA6IHZvaWQgMDsKICAgICAgICBpZiAocHJvcHNCdWlsZFJlc3VsdC5zaG91bGRVc2VCbG9jaykgewogICAgICAgICAgc2hvdWxkVXNlQmxvY2sgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7CiAgICAgICAgaWYgKHZub2RlVGFnID09PSBLRUVQX0FMSVZFKSB7CiAgICAgICAgICBzaG91bGRVc2VCbG9jayA9IHRydWU7CiAgICAgICAgICBwYXRjaEZsYWcgfD0gMTAyNDsKICAgICAgICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgY29udGV4dC5vbkVycm9yKAogICAgICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDYsIHsKICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLmNoaWxkcmVuWzBdLmxvYy5zdGFydCwKICAgICAgICAgICAgICAgIGVuZDogbm9kZS5jaGlsZHJlbltub2RlLmNoaWxkcmVuLmxlbmd0aCAtIDFdLmxvYy5lbmQsCiAgICAgICAgICAgICAgICBzb3VyY2U6ICIiCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3Qgc2hvdWxkQnVpbGRBc1Nsb3RzID0gaXNDb21wb25lbnQgJiYgLy8gVGVsZXBvcnQgaXMgbm90IGEgcmVhbCBjb21wb25lbnQgYW5kIGhhcyBkZWRpY2F0ZWQgcnVudGltZSBoYW5kbGluZwogICAgICAgIHZub2RlVGFnICE9PSBURUxFUE9SVCAmJiAvLyBleHBsYWluZWQgYWJvdmUuCiAgICAgICAgdm5vZGVUYWcgIT09IEtFRVBfQUxJVkU7CiAgICAgICAgaWYgKHNob3VsZEJ1aWxkQXNTbG90cykgewogICAgICAgICAgY29uc3QgeyBzbG90cywgaGFzRHluYW1pY1Nsb3RzIH0gPSBidWlsZFNsb3RzKG5vZGUsIGNvbnRleHQpOwogICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IHNsb3RzOwogICAgICAgICAgaWYgKGhhc0R5bmFtaWNTbG90cykgewogICAgICAgICAgICBwYXRjaEZsYWcgfD0gMTAyNDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKG5vZGUuY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmIHZub2RlVGFnICE9PSBURUxFUE9SVCkgewogICAgICAgICAgY29uc3QgY2hpbGQgPSBub2RlLmNoaWxkcmVuWzBdOwogICAgICAgICAgY29uc3QgdHlwZSA9IGNoaWxkLnR5cGU7CiAgICAgICAgICBjb25zdCBoYXNEeW5hbWljVGV4dENoaWxkID0gdHlwZSA9PT0gNSB8fCB0eXBlID09PSA4OwogICAgICAgICAgaWYgKGhhc0R5bmFtaWNUZXh0Q2hpbGQgJiYgZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KSA9PT0gMCkgewogICAgICAgICAgICBwYXRjaEZsYWcgfD0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNEeW5hbWljVGV4dENoaWxkIHx8IHR5cGUgPT09IDIpIHsKICAgICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IGNoaWxkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdm5vZGVDaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZub2RlQ2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocGF0Y2hGbGFnICE9PSAwKSB7CiAgICAgICAgewogICAgICAgICAgaWYgKHBhdGNoRmxhZyA8IDApIHsKICAgICAgICAgICAgdm5vZGVQYXRjaEZsYWcgPSBwYXRjaEZsYWcgKyBgIC8qICR7UGF0Y2hGbGFnTmFtZXNbcGF0Y2hGbGFnXX0gKi9gOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgZmxhZ05hbWVzID0gT2JqZWN0LmtleXMoUGF0Y2hGbGFnTmFtZXMpLm1hcChOdW1iZXIpLmZpbHRlcigobikgPT4gbiA+IDAgJiYgcGF0Y2hGbGFnICYgbikubWFwKChuKSA9PiBQYXRjaEZsYWdOYW1lc1tuXSkuam9pbihgLCBgKTsKICAgICAgICAgICAgdm5vZGVQYXRjaEZsYWcgPSBwYXRjaEZsYWcgKyBgIC8qICR7ZmxhZ05hbWVzfSAqL2A7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkeW5hbWljUHJvcE5hbWVzICYmIGR5bmFtaWNQcm9wTmFtZXMubGVuZ3RoKSB7CiAgICAgICAgICB2bm9kZUR5bmFtaWNQcm9wcyA9IHN0cmluZ2lmeUR5bmFtaWNQcm9wTmFtZXMoZHluYW1pY1Byb3BOYW1lcyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIG5vZGUuY29kZWdlbk5vZGUgPSBjcmVhdGVWTm9kZUNhbGwoCiAgICAgICAgY29udGV4dCwKICAgICAgICB2bm9kZVRhZywKICAgICAgICB2bm9kZVByb3BzLAogICAgICAgIHZub2RlQ2hpbGRyZW4sCiAgICAgICAgdm5vZGVQYXRjaEZsYWcsCiAgICAgICAgdm5vZGVEeW5hbWljUHJvcHMsCiAgICAgICAgdm5vZGVEaXJlY3RpdmVzLAogICAgICAgICEhc2hvdWxkVXNlQmxvY2ssCiAgICAgICAgZmFsc2UsCiAgICAgICAgaXNDb21wb25lbnQsCiAgICAgICAgbm9kZS5sb2MKICAgICAgKTsKICAgIH07CiAgfTsKICBmdW5jdGlvbiByZXNvbHZlQ29tcG9uZW50VHlwZShub2RlLCBjb250ZXh0LCBzc3IgPSBmYWxzZSkgewogICAgbGV0IHsgdGFnIH0gPSBub2RlOwogICAgY29uc3QgaXNFeHBsaWNpdER5bmFtaWMgPSBpc0NvbXBvbmVudFRhZyh0YWcpOwogICAgY29uc3QgaXNQcm9wID0gZmluZFByb3Aobm9kZSwgImlzIik7CiAgICBpZiAoaXNQcm9wKSB7CiAgICAgIGlmIChpc0V4cGxpY2l0RHluYW1pYyB8fCBmYWxzZSkgewogICAgICAgIGNvbnN0IGV4cCA9IGlzUHJvcC50eXBlID09PSA2ID8gaXNQcm9wLnZhbHVlICYmIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oaXNQcm9wLnZhbHVlLmNvbnRlbnQsIHRydWUpIDogaXNQcm9wLmV4cDsKICAgICAgICBpZiAoZXhwKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoUkVTT0xWRV9EWU5BTUlDX0NPTVBPTkVOVCksIFsKICAgICAgICAgICAgZXhwCiAgICAgICAgICBdKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNQcm9wLnR5cGUgPT09IDYgJiYgaXNQcm9wLnZhbHVlLmNvbnRlbnQuc3RhcnRzV2l0aCgidnVlOiIpKSB7CiAgICAgICAgdGFnID0gaXNQcm9wLnZhbHVlLmNvbnRlbnQuc2xpY2UoNCk7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJ1aWx0SW4gPSBpc0NvcmVDb21wb25lbnQodGFnKSB8fCBjb250ZXh0LmlzQnVpbHRJbkNvbXBvbmVudCh0YWcpOwogICAgaWYgKGJ1aWx0SW4pIHsKICAgICAgaWYgKCFzc3IpCiAgICAgICAgY29udGV4dC5oZWxwZXIoYnVpbHRJbik7CiAgICAgIHJldHVybiBidWlsdEluOwogICAgfQogICAgY29udGV4dC5oZWxwZXIoUkVTT0xWRV9DT01QT05FTlQpOwogICAgY29udGV4dC5jb21wb25lbnRzLmFkZCh0YWcpOwogICAgcmV0dXJuIHRvVmFsaWRBc3NldElkKHRhZywgYGNvbXBvbmVudGApOwogIH0KICBmdW5jdGlvbiBidWlsZFByb3BzKG5vZGUsIGNvbnRleHQsIHByb3BzID0gbm9kZS5wcm9wcywgaXNDb21wb25lbnQsIGlzRHluYW1pY0NvbXBvbmVudCwgc3NyID0gZmFsc2UpIHsKICAgIGNvbnN0IHsgdGFnLCBsb2M6IGVsZW1lbnRMb2MsIGNoaWxkcmVuIH0gPSBub2RlOwogICAgbGV0IHByb3BlcnRpZXMgPSBbXTsKICAgIGNvbnN0IG1lcmdlQXJncyA9IFtdOwogICAgY29uc3QgcnVudGltZURpcmVjdGl2ZXMgPSBbXTsKICAgIGNvbnN0IGhhc0NoaWxkcmVuID0gY2hpbGRyZW4ubGVuZ3RoID4gMDsKICAgIGxldCBzaG91bGRVc2VCbG9jayA9IGZhbHNlOwogICAgbGV0IHBhdGNoRmxhZyA9IDA7CiAgICBsZXQgaGFzUmVmID0gZmFsc2U7CiAgICBsZXQgaGFzQ2xhc3NCaW5kaW5nID0gZmFsc2U7CiAgICBsZXQgaGFzU3R5bGVCaW5kaW5nID0gZmFsc2U7CiAgICBsZXQgaGFzSHlkcmF0aW9uRXZlbnRCaW5kaW5nID0gZmFsc2U7CiAgICBsZXQgaGFzRHluYW1pY0tleXMgPSBmYWxzZTsKICAgIGxldCBoYXNWbm9kZUhvb2sgPSBmYWxzZTsKICAgIGNvbnN0IGR5bmFtaWNQcm9wTmFtZXMgPSBbXTsKICAgIGNvbnN0IHB1c2hNZXJnZUFyZyA9IChhcmcpID0+IHsKICAgICAgaWYgKHByb3BlcnRpZXMubGVuZ3RoKSB7CiAgICAgICAgbWVyZ2VBcmdzLnB1c2goCiAgICAgICAgICBjcmVhdGVPYmplY3RFeHByZXNzaW9uKGRlZHVwZVByb3BlcnRpZXMocHJvcGVydGllcyksIGVsZW1lbnRMb2MpCiAgICAgICAgKTsKICAgICAgICBwcm9wZXJ0aWVzID0gW107CiAgICAgIH0KICAgICAgaWYgKGFyZykKICAgICAgICBtZXJnZUFyZ3MucHVzaChhcmcpOwogICAgfTsKICAgIGNvbnN0IGFuYWx5emVQYXRjaEZsYWcgPSAoeyBrZXksIHZhbHVlIH0pID0+IHsKICAgICAgaWYgKGlzU3RhdGljRXhwKGtleSkpIHsKICAgICAgICBjb25zdCBuYW1lID0ga2V5LmNvbnRlbnQ7CiAgICAgICAgY29uc3QgaXNFdmVudEhhbmRsZXIgPSBpc09uKG5hbWUpOwogICAgICAgIGlmIChpc0V2ZW50SGFuZGxlciAmJiAoIWlzQ29tcG9uZW50IHx8IGlzRHluYW1pY0NvbXBvbmVudCkgJiYgLy8gb21pdCB0aGUgZmxhZyBmb3IgY2xpY2sgaGFuZGxlcnMgYmVjYXVzZSBoeWRyYXRpb24gZ2l2ZXMgY2xpY2sKICAgICAgICAvLyBkZWRpY2F0ZWQgZmFzdCBwYXRoLgogICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9uY2xpY2siICYmIC8vIG9taXQgdi1tb2RlbCBoYW5kbGVycwogICAgICAgIG5hbWUgIT09ICJvblVwZGF0ZTptb2RlbFZhbHVlIiAmJiAvLyBvbWl0IG9uVm5vZGVYWFggaG9va3MKICAgICAgICAhaXNSZXNlcnZlZFByb3AobmFtZSkpIHsKICAgICAgICAgIGhhc0h5ZHJhdGlvbkV2ZW50QmluZGluZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc0V2ZW50SGFuZGxlciAmJiBpc1Jlc2VydmVkUHJvcChuYW1lKSkgewogICAgICAgICAgaGFzVm5vZGVIb29rID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzRXZlbnRIYW5kbGVyICYmIHZhbHVlLnR5cGUgPT09IDE0KSB7CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmFyZ3VtZW50c1swXTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlLnR5cGUgPT09IDIwIHx8ICh2YWx1ZS50eXBlID09PSA0IHx8IHZhbHVlLnR5cGUgPT09IDgpICYmIGdldENvbnN0YW50VHlwZSh2YWx1ZSwgY29udGV4dCkgPiAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChuYW1lID09PSAicmVmIikgewogICAgICAgICAgaGFzUmVmID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICJjbGFzcyIpIHsKICAgICAgICAgIGhhc0NsYXNzQmluZGluZyA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSAic3R5bGUiKSB7CiAgICAgICAgICBoYXNTdHlsZUJpbmRpbmcgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAobmFtZSAhPT0gImtleSIgJiYgIWR5bmFtaWNQcm9wTmFtZXMuaW5jbHVkZXMobmFtZSkpIHsKICAgICAgICAgIGR5bmFtaWNQcm9wTmFtZXMucHVzaChuYW1lKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ29tcG9uZW50ICYmIChuYW1lID09PSAiY2xhc3MiIHx8IG5hbWUgPT09ICJzdHlsZSIpICYmICFkeW5hbWljUHJvcE5hbWVzLmluY2x1ZGVzKG5hbWUpKSB7CiAgICAgICAgICBkeW5hbWljUHJvcE5hbWVzLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGhhc0R5bmFtaWNLZXlzID0gdHJ1ZTsKICAgICAgfQogICAgfTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcHJvcCA9IHByb3BzW2ldOwogICAgICBpZiAocHJvcC50eXBlID09PSA2KSB7CiAgICAgICAgY29uc3QgeyBsb2MsIG5hbWUsIG5hbWVMb2MsIHZhbHVlIH0gPSBwcm9wOwogICAgICAgIGxldCBpc1N0YXRpYyA9IHRydWU7CiAgICAgICAgaWYgKG5hbWUgPT09ICJyZWYiKSB7CiAgICAgICAgICBoYXNSZWYgPSB0cnVlOwogICAgICAgICAgaWYgKGNvbnRleHQuc2NvcGVzLnZGb3IgPiAwKSB7CiAgICAgICAgICAgIHByb3BlcnRpZXMucHVzaCgKICAgICAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgKICAgICAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oInJlZl9mb3IiLCB0cnVlKSwKICAgICAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oInRydWUiKQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG5hbWUgPT09ICJpcyIgJiYgKGlzQ29tcG9uZW50VGFnKHRhZykgfHwgdmFsdWUgJiYgdmFsdWUuY29udGVudC5zdGFydHNXaXRoKCJ2dWU6IikgfHwgZmFsc2UpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgcHJvcGVydGllcy5wdXNoKAogICAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoCiAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24obmFtZSwgdHJ1ZSwgbmFtZUxvYyksCiAgICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oCiAgICAgICAgICAgICAgdmFsdWUgPyB2YWx1ZS5jb250ZW50IDogIiIsCiAgICAgICAgICAgICAgaXNTdGF0aWMsCiAgICAgICAgICAgICAgdmFsdWUgPyB2YWx1ZS5sb2MgOiBsb2MKICAgICAgICAgICAgKQogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgeyBuYW1lLCBhcmcsIGV4cCwgbG9jLCBtb2RpZmllcnMgfSA9IHByb3A7CiAgICAgICAgY29uc3QgaXNWQmluZCA9IG5hbWUgPT09ICJiaW5kIjsKICAgICAgICBjb25zdCBpc1ZPbiA9IG5hbWUgPT09ICJvbiI7CiAgICAgICAgaWYgKG5hbWUgPT09ICJzbG90IikgewogICAgICAgICAgaWYgKCFpc0NvbXBvbmVudCkgewogICAgICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICAgICAgY3JlYXRlQ29tcGlsZXJFcnJvcig0MCwgbG9jKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChuYW1lID09PSAib25jZSIgfHwgbmFtZSA9PT0gIm1lbW8iKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKG5hbWUgPT09ICJpcyIgfHwgaXNWQmluZCAmJiBpc1N0YXRpY0FyZ09mKGFyZywgImlzIikgJiYgKGlzQ29tcG9uZW50VGFnKHRhZykgfHwgZmFsc2UpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVk9uICYmIHNzcikgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICgKICAgICAgICAgIC8vICM5Mzg6IGVsZW1lbnRzIHdpdGggZHluYW1pYyBrZXlzIHNob3VsZCBiZSBmb3JjZWQgaW50byBibG9ja3MKICAgICAgICAgIGlzVkJpbmQgJiYgaXNTdGF0aWNBcmdPZihhcmcsICJrZXkiKSB8fCAvLyBpbmxpbmUgYmVmb3JlLXVwZGF0ZSBob29rcyBuZWVkIHRvIGZvcmNlIGJsb2NrIHNvIHRoYXQgaXQgaXMgaW52b2tlZAogICAgICAgICAgLy8gYmVmb3JlIGNoaWxkcmVuCiAgICAgICAgICBpc1ZPbiAmJiBoYXNDaGlsZHJlbiAmJiBpc1N0YXRpY0FyZ09mKGFyZywgInZ1ZTpiZWZvcmUtdXBkYXRlIikKICAgICAgICApIHsKICAgICAgICAgIHNob3VsZFVzZUJsb2NrID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVkJpbmQgJiYgaXNTdGF0aWNBcmdPZihhcmcsICJyZWYiKSAmJiBjb250ZXh0LnNjb3Blcy52Rm9yID4gMCkgewogICAgICAgICAgcHJvcGVydGllcy5wdXNoKAogICAgICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgKICAgICAgICAgICAgICBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKCJyZWZfZm9yIiwgdHJ1ZSksCiAgICAgICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigidHJ1ZSIpCiAgICAgICAgICAgICkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmICghYXJnICYmIChpc1ZCaW5kIHx8IGlzVk9uKSkgewogICAgICAgICAgaGFzRHluYW1pY0tleXMgPSB0cnVlOwogICAgICAgICAgaWYgKGV4cCkgewogICAgICAgICAgICBpZiAoaXNWQmluZCkgewogICAgICAgICAgICAgIHB1c2hNZXJnZUFyZygpOwogICAgICAgICAgICAgIG1lcmdlQXJncy5wdXNoKGV4cCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcHVzaE1lcmdlQXJnKHsKICAgICAgICAgICAgICAgIHR5cGU6IDE0LAogICAgICAgICAgICAgICAgbG9jLAogICAgICAgICAgICAgICAgY2FsbGVlOiBjb250ZXh0LmhlbHBlcihUT19IQU5ETEVSUyksCiAgICAgICAgICAgICAgICBhcmd1bWVudHM6IGlzQ29tcG9uZW50ID8gW2V4cF0gOiBbZXhwLCBgdHJ1ZWBdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKAogICAgICAgICAgICAgICAgaXNWQmluZCA/IDM0IDogMzUsCiAgICAgICAgICAgICAgICBsb2MKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzVkJpbmQgJiYgbW9kaWZpZXJzLmluY2x1ZGVzKCJwcm9wIikpIHsKICAgICAgICAgIHBhdGNoRmxhZyB8PSAzMjsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGlyZWN0aXZlVHJhbnNmb3JtID0gY29udGV4dC5kaXJlY3RpdmVUcmFuc2Zvcm1zW25hbWVdOwogICAgICAgIGlmIChkaXJlY3RpdmVUcmFuc2Zvcm0pIHsKICAgICAgICAgIGNvbnN0IHsgcHJvcHM6IHByb3BzMiwgbmVlZFJ1bnRpbWUgfSA9IGRpcmVjdGl2ZVRyYW5zZm9ybShwcm9wLCBub2RlLCBjb250ZXh0KTsKICAgICAgICAgICFzc3IgJiYgcHJvcHMyLmZvckVhY2goYW5hbHl6ZVBhdGNoRmxhZyk7CiAgICAgICAgICBpZiAoaXNWT24gJiYgYXJnICYmICFpc1N0YXRpY0V4cChhcmcpKSB7CiAgICAgICAgICAgIHB1c2hNZXJnZUFyZyhjcmVhdGVPYmplY3RFeHByZXNzaW9uKHByb3BzMiwgZWxlbWVudExvYykpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvcGVydGllcy5wdXNoKC4uLnByb3BzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmVlZFJ1bnRpbWUpIHsKICAgICAgICAgICAgcnVudGltZURpcmVjdGl2ZXMucHVzaChwcm9wKTsKICAgICAgICAgICAgaWYgKGlzU3ltYm9sKG5lZWRSdW50aW1lKSkgewogICAgICAgICAgICAgIGRpcmVjdGl2ZUltcG9ydE1hcC5zZXQocHJvcCwgbmVlZFJ1bnRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghaXNCdWlsdEluRGlyZWN0aXZlKG5hbWUpKSB7CiAgICAgICAgICBydW50aW1lRGlyZWN0aXZlcy5wdXNoKHByb3ApOwogICAgICAgICAgaWYgKGhhc0NoaWxkcmVuKSB7CiAgICAgICAgICAgIHNob3VsZFVzZUJsb2NrID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGxldCBwcm9wc0V4cHJlc3Npb24gPSB2b2lkIDA7CiAgICBpZiAobWVyZ2VBcmdzLmxlbmd0aCkgewogICAgICBwdXNoTWVyZ2VBcmcoKTsKICAgICAgaWYgKG1lcmdlQXJncy5sZW5ndGggPiAxKSB7CiAgICAgICAgcHJvcHNFeHByZXNzaW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oCiAgICAgICAgICBjb250ZXh0LmhlbHBlcihNRVJHRV9QUk9QUyksCiAgICAgICAgICBtZXJnZUFyZ3MsCiAgICAgICAgICBlbGVtZW50TG9jCiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwcm9wc0V4cHJlc3Npb24gPSBtZXJnZUFyZ3NbMF07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocHJvcGVydGllcy5sZW5ndGgpIHsKICAgICAgcHJvcHNFeHByZXNzaW9uID0gY3JlYXRlT2JqZWN0RXhwcmVzc2lvbigKICAgICAgICBkZWR1cGVQcm9wZXJ0aWVzKHByb3BlcnRpZXMpLAogICAgICAgIGVsZW1lbnRMb2MKICAgICAgKTsKICAgIH0KICAgIGlmIChoYXNEeW5hbWljS2V5cykgewogICAgICBwYXRjaEZsYWcgfD0gMTY7CiAgICB9IGVsc2UgewogICAgICBpZiAoaGFzQ2xhc3NCaW5kaW5nICYmICFpc0NvbXBvbmVudCkgewogICAgICAgIHBhdGNoRmxhZyB8PSAyOwogICAgICB9CiAgICAgIGlmIChoYXNTdHlsZUJpbmRpbmcgJiYgIWlzQ29tcG9uZW50KSB7CiAgICAgICAgcGF0Y2hGbGFnIHw9IDQ7CiAgICAgIH0KICAgICAgaWYgKGR5bmFtaWNQcm9wTmFtZXMubGVuZ3RoKSB7CiAgICAgICAgcGF0Y2hGbGFnIHw9IDg7CiAgICAgIH0KICAgICAgaWYgKGhhc0h5ZHJhdGlvbkV2ZW50QmluZGluZykgewogICAgICAgIHBhdGNoRmxhZyB8PSAzMjsKICAgICAgfQogICAgfQogICAgaWYgKCFzaG91bGRVc2VCbG9jayAmJiAocGF0Y2hGbGFnID09PSAwIHx8IHBhdGNoRmxhZyA9PT0gMzIpICYmIChoYXNSZWYgfHwgaGFzVm5vZGVIb29rIHx8IHJ1bnRpbWVEaXJlY3RpdmVzLmxlbmd0aCA+IDApKSB7CiAgICAgIHBhdGNoRmxhZyB8PSA1MTI7CiAgICB9CiAgICBpZiAoIWNvbnRleHQuaW5TU1IgJiYgcHJvcHNFeHByZXNzaW9uKSB7CiAgICAgIHN3aXRjaCAocHJvcHNFeHByZXNzaW9uLnR5cGUpIHsKICAgICAgICBjYXNlIDE1OgogICAgICAgICAgbGV0IGNsYXNzS2V5SW5kZXggPSAtMTsKICAgICAgICAgIGxldCBzdHlsZUtleUluZGV4ID0gLTE7CiAgICAgICAgICBsZXQgaGFzRHluYW1pY0tleSA9IGZhbHNlOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBrZXkgPSBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllc1tpXS5rZXk7CiAgICAgICAgICAgIGlmIChpc1N0YXRpY0V4cChrZXkpKSB7CiAgICAgICAgICAgICAgaWYgKGtleS5jb250ZW50ID09PSAiY2xhc3MiKSB7CiAgICAgICAgICAgICAgICBjbGFzc0tleUluZGV4ID0gaTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleS5jb250ZW50ID09PSAic3R5bGUiKSB7CiAgICAgICAgICAgICAgICBzdHlsZUtleUluZGV4ID0gaTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWtleS5pc0hhbmRsZXJLZXkpIHsKICAgICAgICAgICAgICBoYXNEeW5hbWljS2V5ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY29uc3QgY2xhc3NQcm9wID0gcHJvcHNFeHByZXNzaW9uLnByb3BlcnRpZXNbY2xhc3NLZXlJbmRleF07CiAgICAgICAgICBjb25zdCBzdHlsZVByb3AgPSBwcm9wc0V4cHJlc3Npb24ucHJvcGVydGllc1tzdHlsZUtleUluZGV4XTsKICAgICAgICAgIGlmICghaGFzRHluYW1pY0tleSkgewogICAgICAgICAgICBpZiAoY2xhc3NQcm9wICYmICFpc1N0YXRpY0V4cChjbGFzc1Byb3AudmFsdWUpKSB7CiAgICAgICAgICAgICAgY2xhc3NQcm9wLnZhbHVlID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oCiAgICAgICAgICAgICAgICBjb250ZXh0LmhlbHBlcihOT1JNQUxJWkVfQ0xBU1MpLAogICAgICAgICAgICAgICAgW2NsYXNzUHJvcC52YWx1ZV0KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdHlsZVByb3AgJiYgLy8gdGhlIHN0YXRpYyBzdHlsZSBpcyBjb21waWxlZCBpbnRvIGFuIG9iamVjdCwKICAgICAgICAgICAgLy8gc28gdXNlIGBoYXNTdHlsZUJpbmRpbmdgIHRvIGVuc3VyZSB0aGF0IGl0IGlzIGEgZHluYW1pYyBzdHlsZSBiaW5kaW5nCiAgICAgICAgICAgIChoYXNTdHlsZUJpbmRpbmcgfHwgc3R5bGVQcm9wLnZhbHVlLnR5cGUgPT09IDQgJiYgc3R5bGVQcm9wLnZhbHVlLmNvbnRlbnQudHJpbSgpWzBdID09PSBgW2AgfHwgLy8gdi1iaW5kOnN0eWxlIGFuZCBzdHlsZSBib3RoIGV4aXN0LAogICAgICAgICAgICAvLyB2LWJpbmQ6c3R5bGUgd2l0aCBzdGF0aWMgbGl0ZXJhbCBvYmplY3QKICAgICAgICAgICAgc3R5bGVQcm9wLnZhbHVlLnR5cGUgPT09IDE3KSkgewogICAgICAgICAgICAgIHN0eWxlUHJvcC52YWx1ZSA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKAogICAgICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoTk9STUFMSVpFX1NUWUxFKSwKICAgICAgICAgICAgICAgIFtzdHlsZVByb3AudmFsdWVdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvcHNFeHByZXNzaW9uID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oCiAgICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoTk9STUFMSVpFX1BST1BTKSwKICAgICAgICAgICAgICBbcHJvcHNFeHByZXNzaW9uXQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAxNDoKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBwcm9wc0V4cHJlc3Npb24gPSBjcmVhdGVDYWxsRXhwcmVzc2lvbigKICAgICAgICAgICAgY29udGV4dC5oZWxwZXIoTk9STUFMSVpFX1BST1BTKSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKEdVQVJEX1JFQUNUSVZFX1BST1BTKSwgWwogICAgICAgICAgICAgICAgcHJvcHNFeHByZXNzaW9uCiAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgXQogICAgICAgICAgKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBwcm9wczogcHJvcHNFeHByZXNzaW9uLAogICAgICBkaXJlY3RpdmVzOiBydW50aW1lRGlyZWN0aXZlcywKICAgICAgcGF0Y2hGbGFnLAogICAgICBkeW5hbWljUHJvcE5hbWVzLAogICAgICBzaG91bGRVc2VCbG9jawogICAgfTsKICB9CiAgZnVuY3Rpb24gZGVkdXBlUHJvcGVydGllcyhwcm9wZXJ0aWVzKSB7CiAgICBjb25zdCBrbm93blByb3BzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGRlZHVwZWQgPSBbXTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcHJvcGVydGllcy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBwcm9wID0gcHJvcGVydGllc1tpXTsKICAgICAgaWYgKHByb3Aua2V5LnR5cGUgPT09IDggfHwgIXByb3Aua2V5LmlzU3RhdGljKSB7CiAgICAgICAgZGVkdXBlZC5wdXNoKHByb3ApOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbnN0IG5hbWUgPSBwcm9wLmtleS5jb250ZW50OwogICAgICBjb25zdCBleGlzdGluZyA9IGtub3duUHJvcHMuZ2V0KG5hbWUpOwogICAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgICBpZiAobmFtZSA9PT0gInN0eWxlIiB8fCBuYW1lID09PSAiY2xhc3MiIHx8IGlzT24obmFtZSkpIHsKICAgICAgICAgIG1lcmdlQXNBcnJheShleGlzdGluZywgcHJvcCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGtub3duUHJvcHMuc2V0KG5hbWUsIHByb3ApOwogICAgICAgIGRlZHVwZWQucHVzaChwcm9wKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlZHVwZWQ7CiAgfQogIGZ1bmN0aW9uIG1lcmdlQXNBcnJheShleGlzdGluZywgaW5jb21pbmcpIHsKICAgIGlmIChleGlzdGluZy52YWx1ZS50eXBlID09PSAxNykgewogICAgICBleGlzdGluZy52YWx1ZS5lbGVtZW50cy5wdXNoKGluY29taW5nLnZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIGV4aXN0aW5nLnZhbHVlID0gY3JlYXRlQXJyYXlFeHByZXNzaW9uKAogICAgICAgIFtleGlzdGluZy52YWx1ZSwgaW5jb21pbmcudmFsdWVdLAogICAgICAgIGV4aXN0aW5nLmxvYwogICAgICApOwogICAgfQogIH0KICBmdW5jdGlvbiBidWlsZERpcmVjdGl2ZUFyZ3MoZGlyLCBjb250ZXh0KSB7CiAgICBjb25zdCBkaXJBcmdzID0gW107CiAgICBjb25zdCBydW50aW1lID0gZGlyZWN0aXZlSW1wb3J0TWFwLmdldChkaXIpOwogICAgaWYgKHJ1bnRpbWUpIHsKICAgICAgZGlyQXJncy5wdXNoKGNvbnRleHQuaGVscGVyU3RyaW5nKHJ1bnRpbWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIHsKICAgICAgICBjb250ZXh0LmhlbHBlcihSRVNPTFZFX0RJUkVDVElWRSk7CiAgICAgICAgY29udGV4dC5kaXJlY3RpdmVzLmFkZChkaXIubmFtZSk7CiAgICAgICAgZGlyQXJncy5wdXNoKHRvVmFsaWRBc3NldElkKGRpci5uYW1lLCBgZGlyZWN0aXZlYCkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7IGxvYyB9ID0gZGlyOwogICAgaWYgKGRpci5leHApCiAgICAgIGRpckFyZ3MucHVzaChkaXIuZXhwKTsKICAgIGlmIChkaXIuYXJnKSB7CiAgICAgIGlmICghZGlyLmV4cCkgewogICAgICAgIGRpckFyZ3MucHVzaChgdm9pZCAwYCk7CiAgICAgIH0KICAgICAgZGlyQXJncy5wdXNoKGRpci5hcmcpOwogICAgfQogICAgaWYgKE9iamVjdC5rZXlzKGRpci5tb2RpZmllcnMpLmxlbmd0aCkgewogICAgICBpZiAoIWRpci5hcmcpIHsKICAgICAgICBpZiAoIWRpci5leHApIHsKICAgICAgICAgIGRpckFyZ3MucHVzaChgdm9pZCAwYCk7CiAgICAgICAgfQogICAgICAgIGRpckFyZ3MucHVzaChgdm9pZCAwYCk7CiAgICAgIH0KICAgICAgY29uc3QgdHJ1ZUV4cHJlc3Npb24gPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGB0cnVlYCwgZmFsc2UsIGxvYyk7CiAgICAgIGRpckFyZ3MucHVzaCgKICAgICAgICBjcmVhdGVPYmplY3RFeHByZXNzaW9uKAogICAgICAgICAgZGlyLm1vZGlmaWVycy5tYXAoCiAgICAgICAgICAgIChtb2RpZmllcikgPT4gY3JlYXRlT2JqZWN0UHJvcGVydHkobW9kaWZpZXIsIHRydWVFeHByZXNzaW9uKQogICAgICAgICAgKSwKICAgICAgICAgIGxvYwogICAgICAgICkKICAgICAgKTsKICAgIH0KICAgIHJldHVybiBjcmVhdGVBcnJheUV4cHJlc3Npb24oZGlyQXJncywgZGlyLmxvYyk7CiAgfQogIGZ1bmN0aW9uIHN0cmluZ2lmeUR5bmFtaWNQcm9wTmFtZXMocHJvcHMpIHsKICAgIGxldCBwcm9wc05hbWVzU3RyaW5nID0gYFtgOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBwcm9wcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcHJvcHNOYW1lc1N0cmluZyArPSBKU09OLnN0cmluZ2lmeShwcm9wc1tpXSk7CiAgICAgIGlmIChpIDwgbCAtIDEpCiAgICAgICAgcHJvcHNOYW1lc1N0cmluZyArPSAiLCAiOwogICAgfQogICAgcmV0dXJuIHByb3BzTmFtZXNTdHJpbmcgKyBgXWA7CiAgfQogIGZ1bmN0aW9uIGlzQ29tcG9uZW50VGFnKHRhZykgewogICAgcmV0dXJuIHRhZyA9PT0gImNvbXBvbmVudCIgfHwgdGFnID09PSAiQ29tcG9uZW50IjsKICB9CgogIGNvbnN0IHRyYW5zZm9ybVNsb3RPdXRsZXQgPSAobm9kZSwgY29udGV4dCkgPT4gewogICAgaWYgKGlzU2xvdE91dGxldChub2RlKSkgewogICAgICBjb25zdCB7IGNoaWxkcmVuLCBsb2MgfSA9IG5vZGU7CiAgICAgIGNvbnN0IHsgc2xvdE5hbWUsIHNsb3RQcm9wcyB9ID0gcHJvY2Vzc1Nsb3RPdXRsZXQobm9kZSwgY29udGV4dCk7CiAgICAgIGNvbnN0IHNsb3RBcmdzID0gWwogICAgICAgIGNvbnRleHQucHJlZml4SWRlbnRpZmllcnMgPyBgX2N0eC4kc2xvdHNgIDogYCRzbG90c2AsCiAgICAgICAgc2xvdE5hbWUsCiAgICAgICAgInt9IiwKICAgICAgICAidW5kZWZpbmVkIiwKICAgICAgICAidHJ1ZSIKICAgICAgXTsKICAgICAgbGV0IGV4cGVjdGVkTGVuID0gMjsKICAgICAgaWYgKHNsb3RQcm9wcykgewogICAgICAgIHNsb3RBcmdzWzJdID0gc2xvdFByb3BzOwogICAgICAgIGV4cGVjdGVkTGVuID0gMzsKICAgICAgfQogICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgc2xvdEFyZ3NbM10gPSBjcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oW10sIGNoaWxkcmVuLCBmYWxzZSwgZmFsc2UsIGxvYyk7CiAgICAgICAgZXhwZWN0ZWRMZW4gPSA0OwogICAgICB9CiAgICAgIGlmIChjb250ZXh0LnNjb3BlSWQgJiYgIWNvbnRleHQuc2xvdHRlZCkgewogICAgICAgIGV4cGVjdGVkTGVuID0gNTsKICAgICAgfQogICAgICBzbG90QXJncy5zcGxpY2UoZXhwZWN0ZWRMZW4pOwogICAgICBub2RlLmNvZGVnZW5Ob2RlID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oCiAgICAgICAgY29udGV4dC5oZWxwZXIoUkVOREVSX1NMT1QpLAogICAgICAgIHNsb3RBcmdzLAogICAgICAgIGxvYwogICAgICApOwogICAgfQogIH07CiAgZnVuY3Rpb24gcHJvY2Vzc1Nsb3RPdXRsZXQobm9kZSwgY29udGV4dCkgewogICAgbGV0IHNsb3ROYW1lID0gYCJkZWZhdWx0ImA7CiAgICBsZXQgc2xvdFByb3BzID0gdm9pZCAwOwogICAgY29uc3Qgbm9uTmFtZVByb3BzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUucHJvcHMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcCA9IG5vZGUucHJvcHNbaV07CiAgICAgIGlmIChwLnR5cGUgPT09IDYpIHsKICAgICAgICBpZiAocC52YWx1ZSkgewogICAgICAgICAgaWYgKHAubmFtZSA9PT0gIm5hbWUiKSB7CiAgICAgICAgICAgIHNsb3ROYW1lID0gSlNPTi5zdHJpbmdpZnkocC52YWx1ZS5jb250ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHAubmFtZSA9IGNhbWVsaXplKHAubmFtZSk7CiAgICAgICAgICAgIG5vbk5hbWVQcm9wcy5wdXNoKHApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocC5uYW1lID09PSAiYmluZCIgJiYgaXNTdGF0aWNBcmdPZihwLmFyZywgIm5hbWUiKSkgewogICAgICAgICAgaWYgKHAuZXhwKSB7CiAgICAgICAgICAgIHNsb3ROYW1lID0gcC5leHA7CiAgICAgICAgICB9IGVsc2UgaWYgKHAuYXJnICYmIHAuYXJnLnR5cGUgPT09IDQpIHsKICAgICAgICAgICAgY29uc3QgbmFtZSA9IGNhbWVsaXplKHAuYXJnLmNvbnRlbnQpOwogICAgICAgICAgICBzbG90TmFtZSA9IHAuZXhwID0gY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihuYW1lLCBmYWxzZSwgcC5hcmcubG9jKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHAubmFtZSA9PT0gImJpbmQiICYmIHAuYXJnICYmIGlzU3RhdGljRXhwKHAuYXJnKSkgewogICAgICAgICAgICBwLmFyZy5jb250ZW50ID0gY2FtZWxpemUocC5hcmcuY29udGVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBub25OYW1lUHJvcHMucHVzaChwKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChub25OYW1lUHJvcHMubGVuZ3RoID4gMCkgewogICAgICBjb25zdCB7IHByb3BzLCBkaXJlY3RpdmVzIH0gPSBidWlsZFByb3BzKAogICAgICAgIG5vZGUsCiAgICAgICAgY29udGV4dCwKICAgICAgICBub25OYW1lUHJvcHMsCiAgICAgICAgZmFsc2UsCiAgICAgICAgZmFsc2UKICAgICAgKTsKICAgICAgc2xvdFByb3BzID0gcHJvcHM7CiAgICAgIGlmIChkaXJlY3RpdmVzLmxlbmd0aCkgewogICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoCiAgICAgICAgICAgIDM2LAogICAgICAgICAgICBkaXJlY3RpdmVzWzBdLmxvYwogICAgICAgICAgKQogICAgICAgICk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHNsb3ROYW1lLAogICAgICBzbG90UHJvcHMKICAgIH07CiAgfQoKICBjb25zdCBmbkV4cFJFID0gL15ccyooW1x3JF9dK3woYXN5bmNccyopP1woW14pXSo/XCkpXHMqKDpbXj1dKyk/PT58XlxzKihhc3luY1xzKyk/ZnVuY3Rpb24oPzpccytbXHckXSspP1xzKlwoLzsKICBjb25zdCB0cmFuc2Zvcm1PbiQxID0gKGRpciwgbm9kZSwgY29udGV4dCwgYXVnbWVudG9yKSA9PiB7CiAgICBjb25zdCB7IGxvYywgbW9kaWZpZXJzLCBhcmcgfSA9IGRpcjsKICAgIGlmICghZGlyLmV4cCAmJiAhbW9kaWZpZXJzLmxlbmd0aCkgewogICAgICBjb250ZXh0Lm9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcigzNSwgbG9jKSk7CiAgICB9CiAgICBsZXQgZXZlbnROYW1lOwogICAgaWYgKGFyZy50eXBlID09PSA0KSB7CiAgICAgIGlmIChhcmcuaXNTdGF0aWMpIHsKICAgICAgICBsZXQgcmF3TmFtZSA9IGFyZy5jb250ZW50OwogICAgICAgIGlmIChyYXdOYW1lLnN0YXJ0c1dpdGgoInZub2RlIikpIHsKICAgICAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDUxLCBhcmcubG9jKSk7CiAgICAgICAgfQogICAgICAgIGlmIChyYXdOYW1lLnN0YXJ0c1dpdGgoInZ1ZToiKSkgewogICAgICAgICAgcmF3TmFtZSA9IGB2bm9kZS0ke3Jhd05hbWUuc2xpY2UoNCl9YDsKICAgICAgICB9CiAgICAgICAgY29uc3QgZXZlbnRTdHJpbmcgPSBub2RlLnRhZ1R5cGUgIT09IDAgfHwgcmF3TmFtZS5zdGFydHNXaXRoKCJ2bm9kZSIpIHx8ICEvW0EtWl0vLnRlc3QocmF3TmFtZSkgPyAoCiAgICAgICAgICAvLyBmb3Igbm9uLWVsZW1lbnQgYW5kIHZub2RlIGxpZmVjeWNsZSBldmVudCBsaXN0ZW5lcnMsIGF1dG8gY29udmVydAogICAgICAgICAgLy8gaXQgdG8gY2FtZWxDYXNlLiBTZWUgaXNzdWUgIzIyNDkKICAgICAgICAgIHRvSGFuZGxlcktleShjYW1lbGl6ZShyYXdOYW1lKSkKICAgICAgICApIDogKAogICAgICAgICAgLy8gcHJlc2VydmUgY2FzZSBmb3IgcGxhaW4gZWxlbWVudCBsaXN0ZW5lcnMgdGhhdCBoYXZlIHVwcGVyY2FzZQogICAgICAgICAgLy8gbGV0dGVycywgYXMgdGhlc2UgbWF5IGJlIGN1c3RvbSBlbGVtZW50cycgY3VzdG9tIGV2ZW50cwogICAgICAgICAgYG9uOiR7cmF3TmFtZX1gCiAgICAgICAgKTsKICAgICAgICBldmVudE5hbWUgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGV2ZW50U3RyaW5nLCB0cnVlLCBhcmcubG9jKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBldmVudE5hbWUgPSBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWwogICAgICAgICAgYCR7Y29udGV4dC5oZWxwZXJTdHJpbmcoVE9fSEFORExFUl9LRVkpfShgLAogICAgICAgICAgYXJnLAogICAgICAgICAgYClgCiAgICAgICAgXSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGV2ZW50TmFtZSA9IGFyZzsKICAgICAgZXZlbnROYW1lLmNoaWxkcmVuLnVuc2hpZnQoYCR7Y29udGV4dC5oZWxwZXJTdHJpbmcoVE9fSEFORExFUl9LRVkpfShgKTsKICAgICAgZXZlbnROYW1lLmNoaWxkcmVuLnB1c2goYClgKTsKICAgIH0KICAgIGxldCBleHAgPSBkaXIuZXhwOwogICAgaWYgKGV4cCAmJiAhZXhwLmNvbnRlbnQudHJpbSgpKSB7CiAgICAgIGV4cCA9IHZvaWQgMDsKICAgIH0KICAgIGxldCBzaG91bGRDYWNoZSA9IGNvbnRleHQuY2FjaGVIYW5kbGVycyAmJiAhZXhwICYmICFjb250ZXh0LmluVk9uY2U7CiAgICBpZiAoZXhwKSB7CiAgICAgIGNvbnN0IGlzTWVtYmVyRXhwID0gaXNNZW1iZXJFeHByZXNzaW9uKGV4cC5jb250ZW50KTsKICAgICAgY29uc3QgaXNJbmxpbmVTdGF0ZW1lbnQgPSAhKGlzTWVtYmVyRXhwIHx8IGZuRXhwUkUudGVzdChleHAuY29udGVudCkpOwogICAgICBjb25zdCBoYXNNdWx0aXBsZVN0YXRlbWVudHMgPSBleHAuY29udGVudC5pbmNsdWRlcyhgO2ApOwogICAgICB7CiAgICAgICAgdmFsaWRhdGVCcm93c2VyRXhwcmVzc2lvbigKICAgICAgICAgIGV4cCwKICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICBmYWxzZSwKICAgICAgICAgIGhhc011bHRpcGxlU3RhdGVtZW50cwogICAgICAgICk7CiAgICAgIH0KICAgICAgaWYgKGlzSW5saW5lU3RhdGVtZW50IHx8IHNob3VsZENhY2hlICYmIGlzTWVtYmVyRXhwKSB7CiAgICAgICAgZXhwID0gY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsKICAgICAgICAgIGAke2lzSW5saW5lU3RhdGVtZW50ID8gYCRldmVudGAgOiBgJHtgYH0oLi4uYXJncylgfSA9PiAke2hhc011bHRpcGxlU3RhdGVtZW50cyA/IGB7YCA6IGAoYH1gLAogICAgICAgICAgZXhwLAogICAgICAgICAgaGFzTXVsdGlwbGVTdGF0ZW1lbnRzID8gYH1gIDogYClgCiAgICAgICAgXSk7CiAgICAgIH0KICAgIH0KICAgIGxldCByZXQgPSB7CiAgICAgIHByb3BzOiBbCiAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoCiAgICAgICAgICBldmVudE5hbWUsCiAgICAgICAgICBleHAgfHwgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgKCkgPT4ge31gLCBmYWxzZSwgbG9jKQogICAgICAgICkKICAgICAgXQogICAgfTsKICAgIGlmIChhdWdtZW50b3IpIHsKICAgICAgcmV0ID0gYXVnbWVudG9yKHJldCk7CiAgICB9CiAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgcmV0LnByb3BzWzBdLnZhbHVlID0gY29udGV4dC5jYWNoZShyZXQucHJvcHNbMF0udmFsdWUpOwogICAgfQogICAgcmV0LnByb3BzLmZvckVhY2goKHApID0+IHAua2V5LmlzSGFuZGxlcktleSA9IHRydWUpOwogICAgcmV0dXJuIHJldDsKICB9OwoKICBjb25zdCB0cmFuc2Zvcm1CaW5kID0gKGRpciwgX25vZGUsIGNvbnRleHQpID0+IHsKICAgIGNvbnN0IHsgbW9kaWZpZXJzLCBsb2MgfSA9IGRpcjsKICAgIGNvbnN0IGFyZyA9IGRpci5hcmc7CiAgICBsZXQgeyBleHAgfSA9IGRpcjsKICAgIGlmIChleHAgJiYgZXhwLnR5cGUgPT09IDQgJiYgIWV4cC5jb250ZW50LnRyaW0oKSkgewogICAgICB7CiAgICAgICAgZXhwID0gdm9pZCAwOwogICAgICB9CiAgICB9CiAgICBpZiAoIWV4cCkgewogICAgICBpZiAoYXJnLnR5cGUgIT09IDQgfHwgIWFyZy5pc1N0YXRpYykgewogICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgIGNyZWF0ZUNvbXBpbGVyRXJyb3IoCiAgICAgICAgICAgIDUyLAogICAgICAgICAgICBhcmcubG9jCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJvcHM6IFsKICAgICAgICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkoYXJnLCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKCIiLCB0cnVlLCBsb2MpKQogICAgICAgICAgXQogICAgICAgIH07CiAgICAgIH0KICAgICAgY29uc3QgcHJvcE5hbWUgPSBjYW1lbGl6ZShhcmcuY29udGVudCk7CiAgICAgIGV4cCA9IGRpci5leHAgPSBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKHByb3BOYW1lLCBmYWxzZSwgYXJnLmxvYyk7CiAgICB9CiAgICBpZiAoYXJnLnR5cGUgIT09IDQpIHsKICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYChgKTsKICAgICAgYXJnLmNoaWxkcmVuLnB1c2goYCkgfHwgIiJgKTsKICAgIH0gZWxzZSBpZiAoIWFyZy5pc1N0YXRpYykgewogICAgICBhcmcuY29udGVudCA9IGAke2FyZy5jb250ZW50fSB8fCAiImA7CiAgICB9CiAgICBpZiAobW9kaWZpZXJzLmluY2x1ZGVzKCJjYW1lbCIpKSB7CiAgICAgIGlmIChhcmcudHlwZSA9PT0gNCkgewogICAgICAgIGlmIChhcmcuaXNTdGF0aWMpIHsKICAgICAgICAgIGFyZy5jb250ZW50ID0gY2FtZWxpemUoYXJnLmNvbnRlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcmcuY29udGVudCA9IGAke2NvbnRleHQuaGVscGVyU3RyaW5nKENBTUVMSVpFKX0oJHthcmcuY29udGVudH0pYDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYCR7Y29udGV4dC5oZWxwZXJTdHJpbmcoQ0FNRUxJWkUpfShgKTsKICAgICAgICBhcmcuY2hpbGRyZW4ucHVzaChgKWApOwogICAgICB9CiAgICB9CiAgICBpZiAoIWNvbnRleHQuaW5TU1IpIHsKICAgICAgaWYgKG1vZGlmaWVycy5pbmNsdWRlcygicHJvcCIpKSB7CiAgICAgICAgaW5qZWN0UHJlZml4KGFyZywgIi4iKTsKICAgICAgfQogICAgICBpZiAobW9kaWZpZXJzLmluY2x1ZGVzKCJhdHRyIikpIHsKICAgICAgICBpbmplY3RQcmVmaXgoYXJnLCAiXiIpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBwcm9wczogW2NyZWF0ZU9iamVjdFByb3BlcnR5KGFyZywgZXhwKV0KICAgIH07CiAgfTsKICBjb25zdCBpbmplY3RQcmVmaXggPSAoYXJnLCBwcmVmaXgpID0+IHsKICAgIGlmIChhcmcudHlwZSA9PT0gNCkgewogICAgICBpZiAoYXJnLmlzU3RhdGljKSB7CiAgICAgICAgYXJnLmNvbnRlbnQgPSBwcmVmaXggKyBhcmcuY29udGVudDsKICAgICAgfSBlbHNlIHsKICAgICAgICBhcmcuY29udGVudCA9IGBcYCR7cHJlZml4fVwkeyR7YXJnLmNvbnRlbnR9fVxgYDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgYXJnLmNoaWxkcmVuLnVuc2hpZnQoYCcke3ByZWZpeH0nICsgKGApOwogICAgICBhcmcuY2hpbGRyZW4ucHVzaChgKWApOwogICAgfQogIH07CgogIGNvbnN0IHRyYW5zZm9ybVRleHQgPSAobm9kZSwgY29udGV4dCkgPT4gewogICAgaWYgKG5vZGUudHlwZSA9PT0gMCB8fCBub2RlLnR5cGUgPT09IDEgfHwgbm9kZS50eXBlID09PSAxMSB8fCBub2RlLnR5cGUgPT09IDEwKSB7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuOwogICAgICAgIGxldCBjdXJyZW50Q29udGFpbmVyID0gdm9pZCAwOwogICAgICAgIGxldCBoYXNUZXh0ID0gZmFsc2U7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICAgIGlmIChpc1RleHQkMShjaGlsZCkpIHsKICAgICAgICAgICAgaGFzVGV4dCA9IHRydWU7CiAgICAgICAgICAgIGZvciAobGV0IGogPSBpICsgMTsgaiA8IGNoaWxkcmVuLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgY29uc3QgbmV4dCA9IGNoaWxkcmVuW2pdOwogICAgICAgICAgICAgIGlmIChpc1RleHQkMShuZXh0KSkgewogICAgICAgICAgICAgICAgaWYgKCFjdXJyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRDb250YWluZXIgPSBjaGlsZHJlbltpXSA9IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbigKICAgICAgICAgICAgICAgICAgICBbY2hpbGRdLAogICAgICAgICAgICAgICAgICAgIGNoaWxkLmxvYwogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudENvbnRhaW5lci5jaGlsZHJlbi5wdXNoKGAgKyBgLCBuZXh0KTsKICAgICAgICAgICAgICAgIGNoaWxkcmVuLnNwbGljZShqLCAxKTsKICAgICAgICAgICAgICAgIGotLTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudENvbnRhaW5lciA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWhhc1RleHQgfHwgLy8gaWYgdGhpcyBpcyBhIHBsYWluIGVsZW1lbnQgd2l0aCBhIHNpbmdsZSB0ZXh0IGNoaWxkLCBsZWF2ZSBpdAogICAgICAgIC8vIGFzLWlzIHNpbmNlIHRoZSBydW50aW1lIGhhcyBkZWRpY2F0ZWQgZmFzdCBwYXRoIGZvciB0aGlzIGJ5IGRpcmVjdGx5CiAgICAgICAgLy8gc2V0dGluZyB0ZXh0Q29udGVudCBvZiB0aGUgZWxlbWVudC4KICAgICAgICAvLyBmb3IgY29tcG9uZW50IHJvb3QgaXQncyBhbHdheXMgbm9ybWFsaXplZCBhbnl3YXkuCiAgICAgICAgY2hpbGRyZW4ubGVuZ3RoID09PSAxICYmIChub2RlLnR5cGUgPT09IDAgfHwgbm9kZS50eXBlID09PSAxICYmIG5vZGUudGFnVHlwZSA9PT0gMCAmJiAvLyAjMzc1NgogICAgICAgIC8vIGN1c3RvbSBkaXJlY3RpdmVzIGNhbiBwb3RlbnRpYWxseSBhZGQgRE9NIGVsZW1lbnRzIGFyYml0cmFyaWx5LAogICAgICAgIC8vIHdlIG5lZWQgdG8gYXZvaWQgc2V0dGluZyB0ZXh0Q29udGVudCBvZiB0aGUgZWxlbWVudCBhdCBydW50aW1lCiAgICAgICAgLy8gdG8gYXZvaWQgYWNjaWRlbnRhbGx5IG92ZXJ3cml0aW5nIHRoZSBET00gZWxlbWVudHMgYWRkZWQKICAgICAgICAvLyBieSB0aGUgdXNlciB0aHJvdWdoIGN1c3RvbSBkaXJlY3RpdmVzLgogICAgICAgICFub2RlLnByb3BzLmZpbmQoCiAgICAgICAgICAocCkgPT4gcC50eXBlID09PSA3ICYmICFjb250ZXh0LmRpcmVjdGl2ZVRyYW5zZm9ybXNbcC5uYW1lXQogICAgICAgICkgJiYgLy8gaW4gY29tcGF0IG1vZGUsIDx0ZW1wbGF0ZT4gdGFncyB3aXRoIG5vIHNwZWNpYWwgZGlyZWN0aXZlcwogICAgICAgIC8vIHdpbGwgYmUgcmVuZGVyZWQgYXMgYSBmcmFnbWVudCBzbyBpdHMgY2hpbGRyZW4gbXVzdCBiZQogICAgICAgIC8vIGNvbnZlcnRlZCBpbnRvIHZub2Rlcy4KICAgICAgICB0cnVlKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgaWYgKGlzVGV4dCQxKGNoaWxkKSB8fCBjaGlsZC50eXBlID09PSA4KSB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxBcmdzID0gW107CiAgICAgICAgICAgIGlmIChjaGlsZC50eXBlICE9PSAyIHx8IGNoaWxkLmNvbnRlbnQgIT09ICIgIikgewogICAgICAgICAgICAgIGNhbGxBcmdzLnB1c2goY2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY29udGV4dC5zc3IgJiYgZ2V0Q29uc3RhbnRUeXBlKGNoaWxkLCBjb250ZXh0KSA9PT0gMCkgewogICAgICAgICAgICAgIGNhbGxBcmdzLnB1c2goCiAgICAgICAgICAgICAgICAxICsgKGAgLyogJHtQYXRjaEZsYWdOYW1lc1sxXX0gKi9gICkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkcmVuW2ldID0gewogICAgICAgICAgICAgIHR5cGU6IDEyLAogICAgICAgICAgICAgIGNvbnRlbnQ6IGNoaWxkLAogICAgICAgICAgICAgIGxvYzogY2hpbGQubG9jLAogICAgICAgICAgICAgIGNvZGVnZW5Ob2RlOiBjcmVhdGVDYWxsRXhwcmVzc2lvbigKICAgICAgICAgICAgICAgIGNvbnRleHQuaGVscGVyKENSRUFURV9URVhUKSwKICAgICAgICAgICAgICAgIGNhbGxBcmdzCiAgICAgICAgICAgICAgKQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9OwoKICBjb25zdCBzZWVuJDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICBjb25zdCB0cmFuc2Zvcm1PbmNlID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEgJiYgZmluZERpcihub2RlLCAib25jZSIsIHRydWUpKSB7CiAgICAgIGlmIChzZWVuJDEuaGFzKG5vZGUpIHx8IGNvbnRleHQuaW5WT25jZSB8fCBjb250ZXh0LmluU1NSKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNlZW4kMS5hZGQobm9kZSk7CiAgICAgIGNvbnRleHQuaW5WT25jZSA9IHRydWU7CiAgICAgIGNvbnRleHQuaGVscGVyKFNFVF9CTE9DS19UUkFDS0lORyk7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgY29udGV4dC5pblZPbmNlID0gZmFsc2U7CiAgICAgICAgY29uc3QgY3VyID0gY29udGV4dC5jdXJyZW50Tm9kZTsKICAgICAgICBpZiAoY3VyLmNvZGVnZW5Ob2RlKSB7CiAgICAgICAgICBjdXIuY29kZWdlbk5vZGUgPSBjb250ZXh0LmNhY2hlKAogICAgICAgICAgICBjdXIuY29kZWdlbk5vZGUsCiAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgLyogaXNWTm9kZSAqLwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwkMSA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGNvbnN0IHsgZXhwLCBhcmcgfSA9IGRpcjsKICAgIGlmICghZXhwKSB7CiAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDQxLCBkaXIubG9jKQogICAgICApOwogICAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMoKTsKICAgIH0KICAgIGNvbnN0IHJhd0V4cCA9IGV4cC5sb2Muc291cmNlOwogICAgY29uc3QgZXhwU3RyaW5nID0gZXhwLnR5cGUgPT09IDQgPyBleHAuY29udGVudCA6IHJhd0V4cDsKICAgIGNvbnN0IGJpbmRpbmdUeXBlID0gY29udGV4dC5iaW5kaW5nTWV0YWRhdGFbcmF3RXhwXTsKICAgIGlmIChiaW5kaW5nVHlwZSA9PT0gInByb3BzIiB8fCBiaW5kaW5nVHlwZSA9PT0gInByb3BzLWFsaWFzZWQiKSB7CiAgICAgIGNvbnRleHQub25FcnJvcihjcmVhdGVDb21waWxlckVycm9yKDQ0LCBleHAubG9jKSk7CiAgICAgIHJldHVybiBjcmVhdGVUcmFuc2Zvcm1Qcm9wcygpOwogICAgfQogICAgY29uc3QgbWF5YmVSZWYgPSBmYWxzZTsKICAgIGlmICghZXhwU3RyaW5nLnRyaW0oKSB8fCAhaXNNZW1iZXJFeHByZXNzaW9uKGV4cFN0cmluZykgJiYgIW1heWJlUmVmKSB7CiAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICBjcmVhdGVDb21waWxlckVycm9yKDQyLCBleHAubG9jKQogICAgICApOwogICAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMoKTsKICAgIH0KICAgIGNvbnN0IHByb3BOYW1lID0gYXJnID8gYXJnIDogY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigibW9kZWxWYWx1ZSIsIHRydWUpOwogICAgY29uc3QgZXZlbnROYW1lID0gYXJnID8gaXNTdGF0aWNFeHAoYXJnKSA/IGBvblVwZGF0ZToke2NhbWVsaXplKGFyZy5jb250ZW50KX1gIDogY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFsnIm9uVXBkYXRlOiIgKyAnLCBhcmddKSA6IGBvblVwZGF0ZTptb2RlbFZhbHVlYDsKICAgIGxldCBhc3NpZ25tZW50RXhwOwogICAgY29uc3QgZXZlbnRBcmcgPSBjb250ZXh0LmlzVFMgPyBgKCRldmVudDogYW55KWAgOiBgJGV2ZW50YDsKICAgIHsKICAgICAgYXNzaWdubWVudEV4cCA9IGNyZWF0ZUNvbXBvdW5kRXhwcmVzc2lvbihbCiAgICAgICAgYCR7ZXZlbnRBcmd9ID0+ICgoYCwKICAgICAgICBleHAsCiAgICAgICAgYCkgPSAkZXZlbnQpYAogICAgICBdKTsKICAgIH0KICAgIGNvbnN0IHByb3BzID0gWwogICAgICAvLyBtb2RlbFZhbHVlOiBmb28KICAgICAgY3JlYXRlT2JqZWN0UHJvcGVydHkocHJvcE5hbWUsIGRpci5leHApLAogICAgICAvLyAib25VcGRhdGU6bW9kZWxWYWx1ZSI6ICRldmVudCA9PiAoZm9vID0gJGV2ZW50KQogICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eShldmVudE5hbWUsIGFzc2lnbm1lbnRFeHApCiAgICBdOwogICAgaWYgKGRpci5tb2RpZmllcnMubGVuZ3RoICYmIG5vZGUudGFnVHlwZSA9PT0gMSkgewogICAgICBjb25zdCBtb2RpZmllcnMgPSBkaXIubW9kaWZpZXJzLm1hcCgobSkgPT4gKGlzU2ltcGxlSWRlbnRpZmllcihtKSA/IG0gOiBKU09OLnN0cmluZ2lmeShtKSkgKyBgOiB0cnVlYCkuam9pbihgLCBgKTsKICAgICAgY29uc3QgbW9kaWZpZXJzS2V5ID0gYXJnID8gaXNTdGF0aWNFeHAoYXJnKSA/IGAke2FyZy5jb250ZW50fU1vZGlmaWVyc2AgOiBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oW2FyZywgJyArICJNb2RpZmllcnMiJ10pIDogYG1vZGVsTW9kaWZpZXJzYDsKICAgICAgcHJvcHMucHVzaCgKICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgKICAgICAgICAgIG1vZGlmaWVyc0tleSwKICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oCiAgICAgICAgICAgIGB7ICR7bW9kaWZpZXJzfSB9YCwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIGRpci5sb2MsCiAgICAgICAgICAgIDIKICAgICAgICAgICkKICAgICAgICApCiAgICAgICk7CiAgICB9CiAgICByZXR1cm4gY3JlYXRlVHJhbnNmb3JtUHJvcHMocHJvcHMpOwogIH07CiAgZnVuY3Rpb24gY3JlYXRlVHJhbnNmb3JtUHJvcHMocHJvcHMgPSBbXSkgewogICAgcmV0dXJuIHsgcHJvcHMgfTsKICB9CgogIGNvbnN0IHNlZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICBjb25zdCB0cmFuc2Zvcm1NZW1vID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgY29uc3QgZGlyID0gZmluZERpcihub2RlLCAibWVtbyIpOwogICAgICBpZiAoIWRpciB8fCBzZWVuLmhhcyhub2RlKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZWVuLmFkZChub2RlKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICBjb25zdCBjb2RlZ2VuTm9kZSA9IG5vZGUuY29kZWdlbk5vZGUgfHwgY29udGV4dC5jdXJyZW50Tm9kZS5jb2RlZ2VuTm9kZTsKICAgICAgICBpZiAoY29kZWdlbk5vZGUgJiYgY29kZWdlbk5vZGUudHlwZSA9PT0gMTMpIHsKICAgICAgICAgIGlmIChub2RlLnRhZ1R5cGUgIT09IDEpIHsKICAgICAgICAgICAgY29udmVydFRvQmxvY2soY29kZWdlbk5vZGUsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5jb2RlZ2VuTm9kZSA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFdJVEhfTUVNTyksIFsKICAgICAgICAgICAgZGlyLmV4cCwKICAgICAgICAgICAgY3JlYXRlRnVuY3Rpb25FeHByZXNzaW9uKHZvaWQgMCwgY29kZWdlbk5vZGUpLAogICAgICAgICAgICBgX2NhY2hlYCwKICAgICAgICAgICAgU3RyaW5nKGNvbnRleHQuY2FjaGVkKyspCiAgICAgICAgICBdKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0QmFzZVRyYW5zZm9ybVByZXNldChwcmVmaXhJZGVudGlmaWVycykgewogICAgcmV0dXJuIFsKICAgICAgWwogICAgICAgIHRyYW5zZm9ybU9uY2UsCiAgICAgICAgdHJhbnNmb3JtSWYsCiAgICAgICAgdHJhbnNmb3JtTWVtbywKICAgICAgICB0cmFuc2Zvcm1Gb3IsCiAgICAgICAgLi4uW10sCiAgICAgICAgLi4uW3RyYW5zZm9ybUV4cHJlc3Npb25dICwKICAgICAgICB0cmFuc2Zvcm1TbG90T3V0bGV0LAogICAgICAgIHRyYW5zZm9ybUVsZW1lbnQsCiAgICAgICAgdHJhY2tTbG90U2NvcGVzLAogICAgICAgIHRyYW5zZm9ybVRleHQKICAgICAgXSwKICAgICAgewogICAgICAgIG9uOiB0cmFuc2Zvcm1PbiQxLAogICAgICAgIGJpbmQ6IHRyYW5zZm9ybUJpbmQsCiAgICAgICAgbW9kZWw6IHRyYW5zZm9ybU1vZGVsJDEKICAgICAgfQogICAgXTsKICB9CiAgZnVuY3Rpb24gYmFzZUNvbXBpbGUoc291cmNlLCBvcHRpb25zID0ge30pIHsKICAgIGNvbnN0IG9uRXJyb3IgPSBvcHRpb25zLm9uRXJyb3IgfHwgZGVmYXVsdE9uRXJyb3I7CiAgICBjb25zdCBpc01vZHVsZU1vZGUgPSBvcHRpb25zLm1vZGUgPT09ICJtb2R1bGUiOwogICAgewogICAgICBpZiAob3B0aW9ucy5wcmVmaXhJZGVudGlmaWVycyA9PT0gdHJ1ZSkgewogICAgICAgIG9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcig0NykpOwogICAgICB9IGVsc2UgaWYgKGlzTW9kdWxlTW9kZSkgewogICAgICAgIG9uRXJyb3IoY3JlYXRlQ29tcGlsZXJFcnJvcig0OCkpOwogICAgICB9CiAgICB9CiAgICBjb25zdCBwcmVmaXhJZGVudGlmaWVycyA9IGZhbHNlOwogICAgaWYgKG9wdGlvbnMuY2FjaGVIYW5kbGVycykgewogICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNDkpKTsKICAgIH0KICAgIGlmIChvcHRpb25zLnNjb3BlSWQgJiYgIWlzTW9kdWxlTW9kZSkgewogICAgICBvbkVycm9yKGNyZWF0ZUNvbXBpbGVyRXJyb3IoNTApKTsKICAgIH0KICAgIGNvbnN0IHJlc29sdmVkT3B0aW9ucyA9IGV4dGVuZCh7fSwgb3B0aW9ucywgewogICAgICBwcmVmaXhJZGVudGlmaWVycwogICAgfSk7CiAgICBjb25zdCBhc3QgPSBpc1N0cmluZyhzb3VyY2UpID8gYmFzZVBhcnNlKHNvdXJjZSwgcmVzb2x2ZWRPcHRpb25zKSA6IHNvdXJjZTsKICAgIGNvbnN0IFtub2RlVHJhbnNmb3JtcywgZGlyZWN0aXZlVHJhbnNmb3Jtc10gPSBnZXRCYXNlVHJhbnNmb3JtUHJlc2V0KCk7CiAgICB0cmFuc2Zvcm0oCiAgICAgIGFzdCwKICAgICAgZXh0ZW5kKHt9LCByZXNvbHZlZE9wdGlvbnMsIHsKICAgICAgICBub2RlVHJhbnNmb3JtczogWwogICAgICAgICAgLi4ubm9kZVRyYW5zZm9ybXMsCiAgICAgICAgICAuLi5vcHRpb25zLm5vZGVUcmFuc2Zvcm1zIHx8IFtdCiAgICAgICAgICAvLyB1c2VyIHRyYW5zZm9ybXMKICAgICAgICBdLAogICAgICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXM6IGV4dGVuZCgKICAgICAgICAgIHt9LAogICAgICAgICAgZGlyZWN0aXZlVHJhbnNmb3JtcywKICAgICAgICAgIG9wdGlvbnMuZGlyZWN0aXZlVHJhbnNmb3JtcyB8fCB7fQogICAgICAgICAgLy8gdXNlciB0cmFuc2Zvcm1zCiAgICAgICAgKQogICAgICB9KQogICAgKTsKICAgIHJldHVybiBnZW5lcmF0ZShhc3QsIHJlc29sdmVkT3B0aW9ucyk7CiAgfQoKICBjb25zdCBub29wRGlyZWN0aXZlVHJhbnNmb3JtID0gKCkgPT4gKHsgcHJvcHM6IFtdIH0pOwoKICBjb25zdCBWX01PREVMX1JBRElPID0gU3ltYm9sKGB2TW9kZWxSYWRpb2AgKTsKICBjb25zdCBWX01PREVMX0NIRUNLQk9YID0gU3ltYm9sKGB2TW9kZWxDaGVja2JveGAgKTsKICBjb25zdCBWX01PREVMX1RFWFQgPSBTeW1ib2woYHZNb2RlbFRleHRgICk7CiAgY29uc3QgVl9NT0RFTF9TRUxFQ1QgPSBTeW1ib2woYHZNb2RlbFNlbGVjdGAgKTsKICBjb25zdCBWX01PREVMX0RZTkFNSUMgPSBTeW1ib2woYHZNb2RlbER5bmFtaWNgICk7CiAgY29uc3QgVl9PTl9XSVRIX01PRElGSUVSUyA9IFN5bWJvbChgdk9uTW9kaWZpZXJzR3VhcmRgICk7CiAgY29uc3QgVl9PTl9XSVRIX0tFWVMgPSBTeW1ib2woYHZPbktleXNHdWFyZGAgKTsKICBjb25zdCBWX1NIT1cgPSBTeW1ib2woYHZTaG93YCApOwogIGNvbnN0IFRSQU5TSVRJT04gPSBTeW1ib2woYFRyYW5zaXRpb25gICk7CiAgY29uc3QgVFJBTlNJVElPTl9HUk9VUCA9IFN5bWJvbChgVHJhbnNpdGlvbkdyb3VwYCApOwogIHJlZ2lzdGVyUnVudGltZUhlbHBlcnMoewogICAgW1ZfTU9ERUxfUkFESU9dOiBgdk1vZGVsUmFkaW9gLAogICAgW1ZfTU9ERUxfQ0hFQ0tCT1hdOiBgdk1vZGVsQ2hlY2tib3hgLAogICAgW1ZfTU9ERUxfVEVYVF06IGB2TW9kZWxUZXh0YCwKICAgIFtWX01PREVMX1NFTEVDVF06IGB2TW9kZWxTZWxlY3RgLAogICAgW1ZfTU9ERUxfRFlOQU1JQ106IGB2TW9kZWxEeW5hbWljYCwKICAgIFtWX09OX1dJVEhfTU9ESUZJRVJTXTogYHdpdGhNb2RpZmllcnNgLAogICAgW1ZfT05fV0lUSF9LRVlTXTogYHdpdGhLZXlzYCwKICAgIFtWX1NIT1ddOiBgdlNob3dgLAogICAgW1RSQU5TSVRJT05dOiBgVHJhbnNpdGlvbmAsCiAgICBbVFJBTlNJVElPTl9HUk9VUF06IGBUcmFuc2l0aW9uR3JvdXBgCiAgfSk7CgogIGxldCBkZWNvZGVyOwogIGZ1bmN0aW9uIGRlY29kZUh0bWxCcm93c2VyKHJhdywgYXNBdHRyID0gZmFsc2UpIHsKICAgIGlmICghZGVjb2RlcikgewogICAgICBkZWNvZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICB9CiAgICBpZiAoYXNBdHRyKSB7CiAgICAgIGRlY29kZXIuaW5uZXJIVE1MID0gYDxkaXYgZm9vPSIke3Jhdy5yZXBsYWNlKC8iL2csICImcXVvdDsiKX0iPmA7CiAgICAgIHJldHVybiBkZWNvZGVyLmNoaWxkcmVuWzBdLmdldEF0dHJpYnV0ZSgiZm9vIik7CiAgICB9IGVsc2UgewogICAgICBkZWNvZGVyLmlubmVySFRNTCA9IHJhdzsKICAgICAgcmV0dXJuIGRlY29kZXIudGV4dENvbnRlbnQ7CiAgICB9CiAgfQoKICBjb25zdCBwYXJzZXJPcHRpb25zID0gewogICAgcGFyc2VNb2RlOiAiaHRtbCIsCiAgICBpc1ZvaWRUYWcsCiAgICBpc05hdGl2ZVRhZzogKHRhZykgPT4gaXNIVE1MVGFnKHRhZykgfHwgaXNTVkdUYWcodGFnKSB8fCBpc01hdGhNTFRhZyh0YWcpLAogICAgaXNQcmVUYWc6ICh0YWcpID0+IHRhZyA9PT0gInByZSIsCiAgICBkZWNvZGVFbnRpdGllczogZGVjb2RlSHRtbEJyb3dzZXIgLAogICAgaXNCdWlsdEluQ29tcG9uZW50OiAodGFnKSA9PiB7CiAgICAgIGlmICh0YWcgPT09ICJUcmFuc2l0aW9uIiB8fCB0YWcgPT09ICJ0cmFuc2l0aW9uIikgewogICAgICAgIHJldHVybiBUUkFOU0lUSU9OOwogICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gIlRyYW5zaXRpb25Hcm91cCIgfHwgdGFnID09PSAidHJhbnNpdGlvbi1ncm91cCIpIHsKICAgICAgICByZXR1cm4gVFJBTlNJVElPTl9HUk9VUDsKICAgICAgfQogICAgfSwKICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3BhcnNpbmcuaHRtbCN0cmVlLWNvbnN0cnVjdGlvbi1kaXNwYXRjaGVyCiAgICBnZXROYW1lc3BhY2UodGFnLCBwYXJlbnQsIHJvb3ROYW1lc3BhY2UpIHsKICAgICAgbGV0IG5zID0gcGFyZW50ID8gcGFyZW50Lm5zIDogcm9vdE5hbWVzcGFjZTsKICAgICAgaWYgKHBhcmVudCAmJiBucyA9PT0gMikgewogICAgICAgIGlmIChwYXJlbnQudGFnID09PSAiYW5ub3RhdGlvbi14bWwiKSB7CiAgICAgICAgICBpZiAodGFnID09PSAic3ZnIikgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJlbnQucHJvcHMuc29tZSgKICAgICAgICAgICAgKGEpID0+IGEudHlwZSA9PT0gNiAmJiBhLm5hbWUgPT09ICJlbmNvZGluZyIgJiYgYS52YWx1ZSAhPSBudWxsICYmIChhLnZhbHVlLmNvbnRlbnQgPT09ICJ0ZXh0L2h0bWwiIHx8IGEudmFsdWUuY29udGVudCA9PT0gImFwcGxpY2F0aW9uL3hodG1sK3htbCIpCiAgICAgICAgICApKSB7CiAgICAgICAgICAgIG5zID0gMDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKC9ebSg/Oltpb25zXXx0ZXh0KSQvLnRlc3QocGFyZW50LnRhZykgJiYgdGFnICE9PSAibWdseXBoIiAmJiB0YWcgIT09ICJtYWxpZ25tYXJrIikgewogICAgICAgICAgbnMgPSAwOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwYXJlbnQgJiYgbnMgPT09IDEpIHsKICAgICAgICBpZiAocGFyZW50LnRhZyA9PT0gImZvcmVpZ25PYmplY3QiIHx8IHBhcmVudC50YWcgPT09ICJkZXNjIiB8fCBwYXJlbnQudGFnID09PSAidGl0bGUiKSB7CiAgICAgICAgICBucyA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChucyA9PT0gMCkgewogICAgICAgIGlmICh0YWcgPT09ICJzdmciKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZyA9PT0gIm1hdGgiKSB7CiAgICAgICAgICByZXR1cm4gMjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5zOwogICAgfQogIH07CgogIGNvbnN0IHRyYW5zZm9ybVN0eWxlID0gKG5vZGUpID0+IHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEpIHsKICAgICAgbm9kZS5wcm9wcy5mb3JFYWNoKChwLCBpKSA9PiB7CiAgICAgICAgaWYgKHAudHlwZSA9PT0gNiAmJiBwLm5hbWUgPT09ICJzdHlsZSIgJiYgcC52YWx1ZSkgewogICAgICAgICAgbm9kZS5wcm9wc1tpXSA9IHsKICAgICAgICAgICAgdHlwZTogNywKICAgICAgICAgICAgbmFtZTogYGJpbmRgLAogICAgICAgICAgICBhcmc6IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHN0eWxlYCwgdHJ1ZSwgcC5sb2MpLAogICAgICAgICAgICBleHA6IHBhcnNlSW5saW5lQ1NTKHAudmFsdWUuY29udGVudCwgcC5sb2MpLAogICAgICAgICAgICBtb2RpZmllcnM6IFtdLAogICAgICAgICAgICBsb2M6IHAubG9jCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKICBjb25zdCBwYXJzZUlubGluZUNTUyA9IChjc3NUZXh0LCBsb2MpID0+IHsKICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBwYXJzZVN0cmluZ1N0eWxlKGNzc1RleHQpOwogICAgcmV0dXJuIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oCiAgICAgIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWQpLAogICAgICBmYWxzZSwKICAgICAgbG9jLAogICAgICAzCiAgICApOwogIH07CgogIGZ1bmN0aW9uIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoY29kZSwgbG9jKSB7CiAgICByZXR1cm4gY3JlYXRlQ29tcGlsZXJFcnJvcigKICAgICAgY29kZSwKICAgICAgbG9jLAogICAgICBET01FcnJvck1lc3NhZ2VzIAogICAgKTsKICB9CiAgY29uc3QgRE9NRXJyb3JNZXNzYWdlcyA9IHsKICAgIFs1M106IGB2LWh0bWwgaXMgbWlzc2luZyBleHByZXNzaW9uLmAsCiAgICBbNTRdOiBgdi1odG1sIHdpbGwgb3ZlcnJpZGUgZWxlbWVudCBjaGlsZHJlbi5gLAogICAgWzU1XTogYHYtdGV4dCBpcyBtaXNzaW5nIGV4cHJlc3Npb24uYCwKICAgIFs1Nl06IGB2LXRleHQgd2lsbCBvdmVycmlkZSBlbGVtZW50IGNoaWxkcmVuLmAsCiAgICBbNTddOiBgdi1tb2RlbCBjYW4gb25seSBiZSB1c2VkIG9uIDxpbnB1dD4sIDx0ZXh0YXJlYT4gYW5kIDxzZWxlY3Q+IGVsZW1lbnRzLmAsCiAgICBbNThdOiBgdi1tb2RlbCBhcmd1bWVudCBpcyBub3Qgc3VwcG9ydGVkIG9uIHBsYWluIGVsZW1lbnRzLmAsCiAgICBbNTldOiBgdi1tb2RlbCBjYW5ub3QgYmUgdXNlZCBvbiBmaWxlIGlucHV0cyBzaW5jZSB0aGV5IGFyZSByZWFkLW9ubHkuIFVzZSBhIHYtb246Y2hhbmdlIGxpc3RlbmVyIGluc3RlYWQuYCwKICAgIFs2MF06IGBVbm5lY2Vzc2FyeSB2YWx1ZSBiaW5kaW5nIHVzZWQgYWxvbmdzaWRlIHYtbW9kZWwuIEl0IHdpbGwgaW50ZXJmZXJlIHdpdGggdi1tb2RlbCdzIGJlaGF2aW9yLmAsCiAgICBbNjFdOiBgdi1zaG93IGlzIG1pc3NpbmcgZXhwcmVzc2lvbi5gLAogICAgWzYyXTogYDxUcmFuc2l0aW9uPiBleHBlY3RzIGV4YWN0bHkgb25lIGNoaWxkIGVsZW1lbnQgb3IgY29tcG9uZW50LmAsCiAgICBbNjNdOiBgVGFncyB3aXRoIHNpZGUgZWZmZWN0ICg8c2NyaXB0PiBhbmQgPHN0eWxlPikgYXJlIGlnbm9yZWQgaW4gY2xpZW50IGNvbXBvbmVudCB0ZW1wbGF0ZXMuYAogIH07CgogIGNvbnN0IHRyYW5zZm9ybVZIdG1sID0gKGRpciwgbm9kZSwgY29udGV4dCkgPT4gewogICAgY29uc3QgeyBleHAsIGxvYyB9ID0gZGlyOwogICAgaWYgKCFleHApIHsKICAgICAgY29udGV4dC5vbkVycm9yKAogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTMsIGxvYykKICAgICAgKTsKICAgIH0KICAgIGlmIChub2RlLmNoaWxkcmVuLmxlbmd0aCkgewogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcig1NCwgbG9jKQogICAgICApOwogICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICB9CiAgICByZXR1cm4gewogICAgICBwcm9wczogWwogICAgICAgIGNyZWF0ZU9iamVjdFByb3BlcnR5KAogICAgICAgICAgY3JlYXRlU2ltcGxlRXhwcmVzc2lvbihgaW5uZXJIVE1MYCwgdHJ1ZSwgbG9jKSwKICAgICAgICAgIGV4cCB8fCBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKCIiLCB0cnVlKQogICAgICAgICkKICAgICAgXQogICAgfTsKICB9OwoKICBjb25zdCB0cmFuc2Zvcm1WVGV4dCA9IChkaXIsIG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGNvbnN0IHsgZXhwLCBsb2MgfSA9IGRpcjsKICAgIGlmICghZXhwKSB7CiAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICBjcmVhdGVET01Db21waWxlckVycm9yKDU1LCBsb2MpCiAgICAgICk7CiAgICB9CiAgICBpZiAobm9kZS5jaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgY29udGV4dC5vbkVycm9yKAogICAgICAgIGNyZWF0ZURPTUNvbXBpbGVyRXJyb3IoNTYsIGxvYykKICAgICAgKTsKICAgICAgbm9kZS5jaGlsZHJlbi5sZW5ndGggPSAwOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcHJvcHM6IFsKICAgICAgICBjcmVhdGVPYmplY3RQcm9wZXJ0eSgKICAgICAgICAgIGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oYHRleHRDb250ZW50YCwgdHJ1ZSksCiAgICAgICAgICBleHAgPyBnZXRDb25zdGFudFR5cGUoZXhwLCBjb250ZXh0KSA+IDAgPyBleHAgOiBjcmVhdGVDYWxsRXhwcmVzc2lvbigKICAgICAgICAgICAgY29udGV4dC5oZWxwZXJTdHJpbmcoVE9fRElTUExBWV9TVFJJTkcpLAogICAgICAgICAgICBbZXhwXSwKICAgICAgICAgICAgbG9jCiAgICAgICAgICApIDogY3JlYXRlU2ltcGxlRXhwcmVzc2lvbigiIiwgdHJ1ZSkKICAgICAgICApCiAgICAgIF0KICAgIH07CiAgfTsKCiAgY29uc3QgdHJhbnNmb3JtTW9kZWwgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICBjb25zdCBiYXNlUmVzdWx0ID0gdHJhbnNmb3JtTW9kZWwkMShkaXIsIG5vZGUsIGNvbnRleHQpOwogICAgaWYgKCFiYXNlUmVzdWx0LnByb3BzLmxlbmd0aCB8fCBub2RlLnRhZ1R5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIGJhc2VSZXN1bHQ7CiAgICB9CiAgICBpZiAoZGlyLmFyZykgewogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcigKICAgICAgICAgIDU4LAogICAgICAgICAgZGlyLmFyZy5sb2MKICAgICAgICApCiAgICAgICk7CiAgICB9CiAgICBmdW5jdGlvbiBjaGVja0R1cGxpY2F0ZWRWYWx1ZSgpIHsKICAgICAgY29uc3QgdmFsdWUgPSBmaW5kRGlyKG5vZGUsICJiaW5kIik7CiAgICAgIGlmICh2YWx1ZSAmJiBpc1N0YXRpY0FyZ09mKHZhbHVlLmFyZywgInZhbHVlIikpIHsKICAgICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgICBjcmVhdGVET01Db21waWxlckVycm9yKAogICAgICAgICAgICA2MCwKICAgICAgICAgICAgdmFsdWUubG9jCiAgICAgICAgICApCiAgICAgICAgKTsKICAgICAgfQogICAgfQogICAgY29uc3QgeyB0YWcgfSA9IG5vZGU7CiAgICBjb25zdCBpc0N1c3RvbUVsZW1lbnQgPSBjb250ZXh0LmlzQ3VzdG9tRWxlbWVudCh0YWcpOwogICAgaWYgKHRhZyA9PT0gImlucHV0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSIgfHwgdGFnID09PSAic2VsZWN0IiB8fCBpc0N1c3RvbUVsZW1lbnQpIHsKICAgICAgbGV0IGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9URVhUOwogICAgICBsZXQgaXNJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICBpZiAodGFnID09PSAiaW5wdXQiIHx8IGlzQ3VzdG9tRWxlbWVudCkgewogICAgICAgIGNvbnN0IHR5cGUgPSBmaW5kUHJvcChub2RlLCBgdHlwZWApOwogICAgICAgIGlmICh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZS50eXBlID09PSA3KSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9EWU5BTUlDOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlLnZhbHVlKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS52YWx1ZS5jb250ZW50KSB7CiAgICAgICAgICAgICAgY2FzZSAicmFkaW8iOgogICAgICAgICAgICAgICAgZGlyZWN0aXZlVG9Vc2UgPSBWX01PREVMX1JBRElPOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiY2hlY2tib3giOgogICAgICAgICAgICAgICAgZGlyZWN0aXZlVG9Vc2UgPSBWX01PREVMX0NIRUNLQk9YOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICAgICAgICBpc0ludmFsaWRUeXBlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgICAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcigKICAgICAgICAgICAgICAgICAgICA1OSwKICAgICAgICAgICAgICAgICAgICBkaXIubG9jCiAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2hlY2tEdXBsaWNhdGVkVmFsdWUoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChoYXNEeW5hbWljS2V5VkJpbmQobm9kZSkpIHsKICAgICAgICAgIGRpcmVjdGl2ZVRvVXNlID0gVl9NT0RFTF9EWU5BTUlDOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0R1cGxpY2F0ZWRWYWx1ZSgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0YWcgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgZGlyZWN0aXZlVG9Vc2UgPSBWX01PREVMX1NFTEVDVDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjaGVja0R1cGxpY2F0ZWRWYWx1ZSgpOwogICAgICB9CiAgICAgIGlmICghaXNJbnZhbGlkVHlwZSkgewogICAgICAgIGJhc2VSZXN1bHQubmVlZFJ1bnRpbWUgPSBjb250ZXh0LmhlbHBlcihkaXJlY3RpdmVUb1VzZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICBjcmVhdGVET01Db21waWxlckVycm9yKAogICAgICAgICAgNTcsCiAgICAgICAgICBkaXIubG9jCiAgICAgICAgKQogICAgICApOwogICAgfQogICAgYmFzZVJlc3VsdC5wcm9wcyA9IGJhc2VSZXN1bHQucHJvcHMuZmlsdGVyKAogICAgICAocCkgPT4gIShwLmtleS50eXBlID09PSA0ICYmIHAua2V5LmNvbnRlbnQgPT09ICJtb2RlbFZhbHVlIikKICAgICk7CiAgICByZXR1cm4gYmFzZVJlc3VsdDsKICB9OwoKICBjb25zdCBpc0V2ZW50T3B0aW9uTW9kaWZpZXIgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcChgcGFzc2l2ZSxvbmNlLGNhcHR1cmVgKTsKICBjb25zdCBpc05vbktleU1vZGlmaWVyID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoCiAgICAvLyBldmVudCBwcm9wYWdhdGlvbiBtYW5hZ2VtZW50CiAgICBgc3RvcCxwcmV2ZW50LHNlbGYsY3RybCxzaGlmdCxhbHQsbWV0YSxleGFjdCxtaWRkbGVgCiAgKTsKICBjb25zdCBtYXliZUtleU1vZGlmaWVyID0gLyogQF9fUFVSRV9fICovIG1ha2VNYXAoImxlZnQscmlnaHQiKTsKICBjb25zdCBpc0tleWJvYXJkRXZlbnQgPSAvKiBAX19QVVJFX18gKi8gbWFrZU1hcCgKICAgIGBvbmtleXVwLG9ua2V5ZG93bixvbmtleXByZXNzYCwKICAgIHRydWUKICApOwogIGNvbnN0IHJlc29sdmVNb2RpZmllcnMgPSAoa2V5LCBtb2RpZmllcnMsIGNvbnRleHQsIGxvYykgPT4gewogICAgY29uc3Qga2V5TW9kaWZpZXJzID0gW107CiAgICBjb25zdCBub25LZXlNb2RpZmllcnMgPSBbXTsKICAgIGNvbnN0IGV2ZW50T3B0aW9uTW9kaWZpZXJzID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZGlmaWVycy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBtb2RpZmllciA9IG1vZGlmaWVyc1tpXTsKICAgICAgaWYgKGlzRXZlbnRPcHRpb25Nb2RpZmllcihtb2RpZmllcikpIHsKICAgICAgICBldmVudE9wdGlvbk1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobWF5YmVLZXlNb2RpZmllcihtb2RpZmllcikpIHsKICAgICAgICAgIGlmIChpc1N0YXRpY0V4cChrZXkpKSB7CiAgICAgICAgICAgIGlmIChpc0tleWJvYXJkRXZlbnQoa2V5LmNvbnRlbnQpKSB7CiAgICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vbktleU1vZGlmaWVycy5wdXNoKG1vZGlmaWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5TW9kaWZpZXJzLnB1c2gobW9kaWZpZXIpOwogICAgICAgICAgICBub25LZXlNb2RpZmllcnMucHVzaChtb2RpZmllcik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc05vbktleU1vZGlmaWVyKG1vZGlmaWVyKSkgewogICAgICAgICAgICBub25LZXlNb2RpZmllcnMucHVzaChtb2RpZmllcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXlNb2RpZmllcnMucHVzaChtb2RpZmllcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBrZXlNb2RpZmllcnMsCiAgICAgIG5vbktleU1vZGlmaWVycywKICAgICAgZXZlbnRPcHRpb25Nb2RpZmllcnMKICAgIH07CiAgfTsKICBjb25zdCB0cmFuc2Zvcm1DbGljayA9IChrZXksIGV2ZW50KSA9PiB7CiAgICBjb25zdCBpc1N0YXRpY0NsaWNrID0gaXNTdGF0aWNFeHAoa2V5KSAmJiBrZXkuY29udGVudC50b0xvd2VyQ2FzZSgpID09PSAib25jbGljayI7CiAgICByZXR1cm4gaXNTdGF0aWNDbGljayA/IGNyZWF0ZVNpbXBsZUV4cHJlc3Npb24oZXZlbnQsIHRydWUpIDoga2V5LnR5cGUgIT09IDQgPyBjcmVhdGVDb21wb3VuZEV4cHJlc3Npb24oWwogICAgICBgKGAsCiAgICAgIGtleSwKICAgICAgYCkgPT09ICJvbkNsaWNrIiA/ICIke2V2ZW50fSIgOiAoYCwKICAgICAga2V5LAogICAgICBgKWAKICAgIF0pIDoga2V5OwogIH07CiAgY29uc3QgdHJhbnNmb3JtT24gPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICByZXR1cm4gdHJhbnNmb3JtT24kMShkaXIsIG5vZGUsIGNvbnRleHQsIChiYXNlUmVzdWx0KSA9PiB7CiAgICAgIGNvbnN0IHsgbW9kaWZpZXJzIH0gPSBkaXI7CiAgICAgIGlmICghbW9kaWZpZXJzLmxlbmd0aCkKICAgICAgICByZXR1cm4gYmFzZVJlc3VsdDsKICAgICAgbGV0IHsga2V5LCB2YWx1ZTogaGFuZGxlckV4cCB9ID0gYmFzZVJlc3VsdC5wcm9wc1swXTsKICAgICAgY29uc3QgeyBrZXlNb2RpZmllcnMsIG5vbktleU1vZGlmaWVycywgZXZlbnRPcHRpb25Nb2RpZmllcnMgfSA9IHJlc29sdmVNb2RpZmllcnMoa2V5LCBtb2RpZmllcnMsIGNvbnRleHQsIGRpci5sb2MpOwogICAgICBpZiAobm9uS2V5TW9kaWZpZXJzLmluY2x1ZGVzKCJyaWdodCIpKSB7CiAgICAgICAga2V5ID0gdHJhbnNmb3JtQ2xpY2soa2V5LCBgb25Db250ZXh0bWVudWApOwogICAgICB9CiAgICAgIGlmIChub25LZXlNb2RpZmllcnMuaW5jbHVkZXMoIm1pZGRsZSIpKSB7CiAgICAgICAga2V5ID0gdHJhbnNmb3JtQ2xpY2soa2V5LCBgb25Nb3VzZXVwYCk7CiAgICAgIH0KICAgICAgaWYgKG5vbktleU1vZGlmaWVycy5sZW5ndGgpIHsKICAgICAgICBoYW5kbGVyRXhwID0gY3JlYXRlQ2FsbEV4cHJlc3Npb24oY29udGV4dC5oZWxwZXIoVl9PTl9XSVRIX01PRElGSUVSUyksIFsKICAgICAgICAgIGhhbmRsZXJFeHAsCiAgICAgICAgICBKU09OLnN0cmluZ2lmeShub25LZXlNb2RpZmllcnMpCiAgICAgICAgXSk7CiAgICAgIH0KICAgICAgaWYgKGtleU1vZGlmaWVycy5sZW5ndGggJiYgLy8gaWYgZXZlbnQgbmFtZSBpcyBkeW5hbWljLCBhbHdheXMgd3JhcCB3aXRoIGtleXMgZ3VhcmQKICAgICAgKCFpc1N0YXRpY0V4cChrZXkpIHx8IGlzS2V5Ym9hcmRFdmVudChrZXkuY29udGVudCkpKSB7CiAgICAgICAgaGFuZGxlckV4cCA9IGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNvbnRleHQuaGVscGVyKFZfT05fV0lUSF9LRVlTKSwgWwogICAgICAgICAgaGFuZGxlckV4cCwKICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGtleU1vZGlmaWVycykKICAgICAgICBdKTsKICAgICAgfQogICAgICBpZiAoZXZlbnRPcHRpb25Nb2RpZmllcnMubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgbW9kaWZpZXJQb3N0Zml4ID0gZXZlbnRPcHRpb25Nb2RpZmllcnMubWFwKGNhcGl0YWxpemUpLmpvaW4oIiIpOwogICAgICAgIGtleSA9IGlzU3RhdGljRXhwKGtleSkgPyBjcmVhdGVTaW1wbGVFeHByZXNzaW9uKGAke2tleS5jb250ZW50fSR7bW9kaWZpZXJQb3N0Zml4fWAsIHRydWUpIDogY3JlYXRlQ29tcG91bmRFeHByZXNzaW9uKFtgKGAsIGtleSwgYCkgKyAiJHttb2RpZmllclBvc3RmaXh9ImBdKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHByb3BzOiBbY3JlYXRlT2JqZWN0UHJvcGVydHkoa2V5LCBoYW5kbGVyRXhwKV0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbnN0IHRyYW5zZm9ybVNob3cgPSAoZGlyLCBub2RlLCBjb250ZXh0KSA9PiB7CiAgICBjb25zdCB7IGV4cCwgbG9jIH0gPSBkaXI7CiAgICBpZiAoIWV4cCkgewogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcig2MSwgbG9jKQogICAgICApOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcHJvcHM6IFtdLAogICAgICBuZWVkUnVudGltZTogY29udGV4dC5oZWxwZXIoVl9TSE9XKQogICAgfTsKICB9OwoKICBjb25zdCB0cmFuc2Zvcm1UcmFuc2l0aW9uID0gKG5vZGUsIGNvbnRleHQpID0+IHsKICAgIGlmIChub2RlLnR5cGUgPT09IDEgJiYgbm9kZS50YWdUeXBlID09PSAxKSB7CiAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGNvbnRleHQuaXNCdWlsdEluQ29tcG9uZW50KG5vZGUudGFnKTsKICAgICAgaWYgKGNvbXBvbmVudCA9PT0gVFJBTlNJVElPTikgewogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICBpZiAoIW5vZGUuY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYXNNdWx0aXBsZUNoaWxkcmVuKG5vZGUpKSB7CiAgICAgICAgICAgIGNvbnRleHQub25FcnJvcigKICAgICAgICAgICAgICBjcmVhdGVET01Db21waWxlckVycm9yKAogICAgICAgICAgICAgICAgNjIsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0OiBub2RlLmNoaWxkcmVuWzBdLmxvYy5zdGFydCwKICAgICAgICAgICAgICAgICAgZW5kOiBub2RlLmNoaWxkcmVuW25vZGUuY2hpbGRyZW4ubGVuZ3RoIC0gMV0ubG9jLmVuZCwKICAgICAgICAgICAgICAgICAgc291cmNlOiAiIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGNoaWxkID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgIGlmIChjaGlsZC50eXBlID09PSAxKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBjaGlsZC5wcm9wcykgewogICAgICAgICAgICAgIGlmIChwLnR5cGUgPT09IDcgJiYgcC5uYW1lID09PSAic2hvdyIpIHsKICAgICAgICAgICAgICAgIG5vZGUucHJvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgIHR5cGU6IDYsCiAgICAgICAgICAgICAgICAgIG5hbWU6ICJwZXJzaXN0ZWQiLAogICAgICAgICAgICAgICAgICBuYW1lTG9jOiBub2RlLmxvYywKICAgICAgICAgICAgICAgICAgdmFsdWU6IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgbG9jOiBub2RlLmxvYwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH07CiAgZnVuY3Rpb24gaGFzTXVsdGlwbGVDaGlsZHJlbihub2RlKSB7CiAgICBjb25zdCBjaGlsZHJlbiA9IG5vZGUuY2hpbGRyZW4gPSBub2RlLmNoaWxkcmVuLmZpbHRlcigKICAgICAgKGMpID0+IGMudHlwZSAhPT0gMyAmJiAhKGMudHlwZSA9PT0gMiAmJiAhYy5jb250ZW50LnRyaW0oKSkKICAgICk7CiAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuWzBdOwogICAgcmV0dXJuIGNoaWxkcmVuLmxlbmd0aCAhPT0gMSB8fCBjaGlsZC50eXBlID09PSAxMSB8fCBjaGlsZC50eXBlID09PSA5ICYmIGNoaWxkLmJyYW5jaGVzLnNvbWUoaGFzTXVsdGlwbGVDaGlsZHJlbik7CiAgfQoKICBjb25zdCBpZ25vcmVTaWRlRWZmZWN0VGFncyA9IChub2RlLCBjb250ZXh0KSA9PiB7CiAgICBpZiAobm9kZS50eXBlID09PSAxICYmIG5vZGUudGFnVHlwZSA9PT0gMCAmJiAobm9kZS50YWcgPT09ICJzY3JpcHQiIHx8IG5vZGUudGFnID09PSAic3R5bGUiKSkgewogICAgICBjb250ZXh0Lm9uRXJyb3IoCiAgICAgICAgY3JlYXRlRE9NQ29tcGlsZXJFcnJvcigKICAgICAgICAgIDYzLAogICAgICAgICAgbm9kZS5sb2MKICAgICAgICApCiAgICAgICk7CiAgICAgIGNvbnRleHQucmVtb3ZlTm9kZSgpOwogICAgfQogIH07CgogIGNvbnN0IERPTU5vZGVUcmFuc2Zvcm1zID0gWwogICAgdHJhbnNmb3JtU3R5bGUsCiAgICAuLi5bdHJhbnNmb3JtVHJhbnNpdGlvbl0gCiAgXTsKICBjb25zdCBET01EaXJlY3RpdmVUcmFuc2Zvcm1zID0gewogICAgY2xvYWs6IG5vb3BEaXJlY3RpdmVUcmFuc2Zvcm0sCiAgICBodG1sOiB0cmFuc2Zvcm1WSHRtbCwKICAgIHRleHQ6IHRyYW5zZm9ybVZUZXh0LAogICAgbW9kZWw6IHRyYW5zZm9ybU1vZGVsLAogICAgLy8gb3ZlcnJpZGUgY29tcGlsZXItY29yZQogICAgb246IHRyYW5zZm9ybU9uLAogICAgLy8gb3ZlcnJpZGUgY29tcGlsZXItY29yZQogICAgc2hvdzogdHJhbnNmb3JtU2hvdwogIH07CiAgZnVuY3Rpb24gY29tcGlsZShzcmMsIG9wdGlvbnMgPSB7fSkgewogICAgcmV0dXJuIGJhc2VDb21waWxlKAogICAgICBzcmMsCiAgICAgIGV4dGVuZCh7fSwgcGFyc2VyT3B0aW9ucywgb3B0aW9ucywgewogICAgICAgIG5vZGVUcmFuc2Zvcm1zOiBbCiAgICAgICAgICAvLyBpZ25vcmUgPHNjcmlwdD4gYW5kIDx0YWc+CiAgICAgICAgICAvLyB0aGlzIGlzIG5vdCBwdXQgaW5zaWRlIERPTU5vZGVUcmFuc2Zvcm1zIGJlY2F1c2UgdGhhdCBsaXN0IGlzIHVzZWQKICAgICAgICAgIC8vIGJ5IGNvbXBpbGVyLXNzciB0byBnZW5lcmF0ZSB2bm9kZSBmYWxsYmFjayBicmFuY2hlcwogICAgICAgICAgaWdub3JlU2lkZUVmZmVjdFRhZ3MsCiAgICAgICAgICAuLi5ET01Ob2RlVHJhbnNmb3JtcywKICAgICAgICAgIC4uLm9wdGlvbnMubm9kZVRyYW5zZm9ybXMgfHwgW10KICAgICAgICBdLAogICAgICAgIGRpcmVjdGl2ZVRyYW5zZm9ybXM6IGV4dGVuZCgKICAgICAgICAgIHt9LAogICAgICAgICAgRE9NRGlyZWN0aXZlVHJhbnNmb3JtcywKICAgICAgICAgIG9wdGlvbnMuZGlyZWN0aXZlVHJhbnNmb3JtcyB8fCB7fQogICAgICAgICksCiAgICAgICAgdHJhbnNmb3JtSG9pc3Q6IG51bGwgCiAgICAgIH0pCiAgICApOwogIH0KCiAgewogICAgaW5pdERldigpOwogIH0KICBjb25zdCBjb21waWxlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICBmdW5jdGlvbiBnZXRDYWNoZShvcHRpb25zKSB7CiAgICBsZXQgYyA9IGNvbXBpbGVDYWNoZS5nZXQob3B0aW9ucyAhPSBudWxsID8gb3B0aW9ucyA6IEVNUFRZX09CSik7CiAgICBpZiAoIWMpIHsKICAgICAgYyA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBjb21waWxlQ2FjaGUuc2V0KG9wdGlvbnMgIT0gbnVsbCA/IG9wdGlvbnMgOiBFTVBUWV9PQkosIGMpOwogICAgfQogICAgcmV0dXJuIGM7CiAgfQogIGZ1bmN0aW9uIGNvbXBpbGVUb0Z1bmN0aW9uKHRlbXBsYXRlLCBvcHRpb25zKSB7CiAgICBpZiAoIWlzU3RyaW5nKHRlbXBsYXRlKSkgewogICAgICBpZiAodGVtcGxhdGUubm9kZVR5cGUpIHsKICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlLmlubmVySFRNTDsKICAgICAgfSBlbHNlIHsKICAgICAgICB3YXJuKGBpbnZhbGlkIHRlbXBsYXRlIG9wdGlvbjogYCwgdGVtcGxhdGUpOwogICAgICAgIHJldHVybiBOT09QOwogICAgICB9CiAgICB9CiAgICBjb25zdCBrZXkgPSB0ZW1wbGF0ZTsKICAgIGNvbnN0IGNhY2hlID0gZ2V0Q2FjaGUob3B0aW9ucyk7CiAgICBjb25zdCBjYWNoZWQgPSBjYWNoZVtrZXldOwogICAgaWYgKGNhY2hlZCkgewogICAgICByZXR1cm4gY2FjaGVkOwogICAgfQogICAgaWYgKHRlbXBsYXRlWzBdID09PSAiIyIpIHsKICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRlbXBsYXRlKTsKICAgICAgaWYgKCFlbCkgewogICAgICAgIHdhcm4oYFRlbXBsYXRlIGVsZW1lbnQgbm90IGZvdW5kIG9yIGlzIGVtcHR5OiAke3RlbXBsYXRlfWApOwogICAgICB9CiAgICAgIHRlbXBsYXRlID0gZWwgPyBlbC5pbm5lckhUTUwgOiBgYDsKICAgIH0KICAgIGNvbnN0IG9wdHMgPSBleHRlbmQoCiAgICAgIHsKICAgICAgICBob2lzdFN0YXRpYzogdHJ1ZSwKICAgICAgICBvbkVycm9yOiBvbkVycm9yICwKICAgICAgICBvbldhcm46IChlKSA9PiBvbkVycm9yKGUsIHRydWUpIAogICAgICB9LAogICAgICBvcHRpb25zCiAgICApOwogICAgaWYgKCFvcHRzLmlzQ3VzdG9tRWxlbWVudCAmJiB0eXBlb2YgY3VzdG9tRWxlbWVudHMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIG9wdHMuaXNDdXN0b21FbGVtZW50ID0gKHRhZykgPT4gISFjdXN0b21FbGVtZW50cy5nZXQodGFnKTsKICAgIH0KICAgIGNvbnN0IHsgY29kZSB9ID0gY29tcGlsZSh0ZW1wbGF0ZSwgb3B0cyk7CiAgICBmdW5jdGlvbiBvbkVycm9yKGVyciwgYXNXYXJuaW5nID0gZmFsc2UpIHsKICAgICAgY29uc3QgbWVzc2FnZSA9IGFzV2FybmluZyA/IGVyci5tZXNzYWdlIDogYFRlbXBsYXRlIGNvbXBpbGF0aW9uIGVycm9yOiAke2Vyci5tZXNzYWdlfWA7CiAgICAgIGNvbnN0IGNvZGVGcmFtZSA9IGVyci5sb2MgJiYgZ2VuZXJhdGVDb2RlRnJhbWUoCiAgICAgICAgdGVtcGxhdGUsCiAgICAgICAgZXJyLmxvYy5zdGFydC5vZmZzZXQsCiAgICAgICAgZXJyLmxvYy5lbmQub2Zmc2V0CiAgICAgICk7CiAgICAgIHdhcm4oY29kZUZyYW1lID8gYCR7bWVzc2FnZX0KJHtjb2RlRnJhbWV9YCA6IG1lc3NhZ2UpOwogICAgfQogICAgY29uc3QgcmVuZGVyID0gbmV3IEZ1bmN0aW9uKGNvZGUpKCkgOwogICAgcmVuZGVyLl9yYyA9IHRydWU7CiAgICByZXR1cm4gY2FjaGVba2V5XSA9IHJlbmRlcjsKICB9CiAgcmVnaXN0ZXJSdW50aW1lQ29tcGlsZXIoY29tcGlsZVRvRnVuY3Rpb24pOwoKICBleHBvcnRzLkJhc2VUcmFuc2l0aW9uID0gQmFzZVRyYW5zaXRpb247CiAgZXhwb3J0cy5CYXNlVHJhbnNpdGlvblByb3BzVmFsaWRhdG9ycyA9IEJhc2VUcmFuc2l0aW9uUHJvcHNWYWxpZGF0b3JzOwogIGV4cG9ydHMuQ29tbWVudCA9IENvbW1lbnQ7CiAgZXhwb3J0cy5EZXByZWNhdGlvblR5cGVzID0gRGVwcmVjYXRpb25UeXBlczsKICBleHBvcnRzLkVmZmVjdFNjb3BlID0gRWZmZWN0U2NvcGU7CiAgZXhwb3J0cy5FcnJvckNvZGVzID0gRXJyb3JDb2RlczsKICBleHBvcnRzLkVycm9yVHlwZVN0cmluZ3MgPSBFcnJvclR5cGVTdHJpbmdzOwogIGV4cG9ydHMuRnJhZ21lbnQgPSBGcmFnbWVudDsKICBleHBvcnRzLktlZXBBbGl2ZSA9IEtlZXBBbGl2ZTsKICBleHBvcnRzLlJlYWN0aXZlRWZmZWN0ID0gUmVhY3RpdmVFZmZlY3Q7CiAgZXhwb3J0cy5TdGF0aWMgPSBTdGF0aWM7CiAgZXhwb3J0cy5TdXNwZW5zZSA9IFN1c3BlbnNlOwogIGV4cG9ydHMuVGVsZXBvcnQgPSBUZWxlcG9ydDsKICBleHBvcnRzLlRleHQgPSBUZXh0OwogIGV4cG9ydHMuVHJhY2tPcFR5cGVzID0gVHJhY2tPcFR5cGVzOwogIGV4cG9ydHMuVHJhbnNpdGlvbiA9IFRyYW5zaXRpb247CiAgZXhwb3J0cy5UcmFuc2l0aW9uR3JvdXAgPSBUcmFuc2l0aW9uR3JvdXA7CiAgZXhwb3J0cy5UcmlnZ2VyT3BUeXBlcyA9IFRyaWdnZXJPcFR5cGVzOwogIGV4cG9ydHMuVnVlRWxlbWVudCA9IFZ1ZUVsZW1lbnQ7CiAgZXhwb3J0cy5hc3NlcnROdW1iZXIgPSBhc3NlcnROdW1iZXI7CiAgZXhwb3J0cy5jYWxsV2l0aEFzeW5jRXJyb3JIYW5kbGluZyA9IGNhbGxXaXRoQXN5bmNFcnJvckhhbmRsaW5nOwogIGV4cG9ydHMuY2FsbFdpdGhFcnJvckhhbmRsaW5nID0gY2FsbFdpdGhFcnJvckhhbmRsaW5nOwogIGV4cG9ydHMuY2FtZWxpemUgPSBjYW1lbGl6ZTsKICBleHBvcnRzLmNhcGl0YWxpemUgPSBjYXBpdGFsaXplOwogIGV4cG9ydHMuY2xvbmVWTm9kZSA9IGNsb25lVk5vZGU7CiAgZXhwb3J0cy5jb21wYXRVdGlscyA9IGNvbXBhdFV0aWxzOwogIGV4cG9ydHMuY29tcGlsZSA9IGNvbXBpbGVUb0Z1bmN0aW9uOwogIGV4cG9ydHMuY29tcHV0ZWQgPSBjb21wdXRlZDsKICBleHBvcnRzLmNyZWF0ZUFwcCA9IGNyZWF0ZUFwcDsKICBleHBvcnRzLmNyZWF0ZUJsb2NrID0gY3JlYXRlQmxvY2s7CiAgZXhwb3J0cy5jcmVhdGVDb21tZW50Vk5vZGUgPSBjcmVhdGVDb21tZW50Vk5vZGU7CiAgZXhwb3J0cy5jcmVhdGVFbGVtZW50QmxvY2sgPSBjcmVhdGVFbGVtZW50QmxvY2s7CiAgZXhwb3J0cy5jcmVhdGVFbGVtZW50Vk5vZGUgPSBjcmVhdGVCYXNlVk5vZGU7CiAgZXhwb3J0cy5jcmVhdGVIeWRyYXRpb25SZW5kZXJlciA9IGNyZWF0ZUh5ZHJhdGlvblJlbmRlcmVyOwogIGV4cG9ydHMuY3JlYXRlUHJvcHNSZXN0UHJveHkgPSBjcmVhdGVQcm9wc1Jlc3RQcm94eTsKICBleHBvcnRzLmNyZWF0ZVJlbmRlcmVyID0gY3JlYXRlUmVuZGVyZXI7CiAgZXhwb3J0cy5jcmVhdGVTU1JBcHAgPSBjcmVhdGVTU1JBcHA7CiAgZXhwb3J0cy5jcmVhdGVTbG90cyA9IGNyZWF0ZVNsb3RzOwogIGV4cG9ydHMuY3JlYXRlU3RhdGljVk5vZGUgPSBjcmVhdGVTdGF0aWNWTm9kZTsKICBleHBvcnRzLmNyZWF0ZVRleHRWTm9kZSA9IGNyZWF0ZVRleHRWTm9kZTsKICBleHBvcnRzLmNyZWF0ZVZOb2RlID0gY3JlYXRlVk5vZGU7CiAgZXhwb3J0cy5jdXN0b21SZWYgPSBjdXN0b21SZWY7CiAgZXhwb3J0cy5kZWZpbmVBc3luY0NvbXBvbmVudCA9IGRlZmluZUFzeW5jQ29tcG9uZW50OwogIGV4cG9ydHMuZGVmaW5lQ29tcG9uZW50ID0gZGVmaW5lQ29tcG9uZW50OwogIGV4cG9ydHMuZGVmaW5lQ3VzdG9tRWxlbWVudCA9IGRlZmluZUN1c3RvbUVsZW1lbnQ7CiAgZXhwb3J0cy5kZWZpbmVFbWl0cyA9IGRlZmluZUVtaXRzOwogIGV4cG9ydHMuZGVmaW5lRXhwb3NlID0gZGVmaW5lRXhwb3NlOwogIGV4cG9ydHMuZGVmaW5lTW9kZWwgPSBkZWZpbmVNb2RlbDsKICBleHBvcnRzLmRlZmluZU9wdGlvbnMgPSBkZWZpbmVPcHRpb25zOwogIGV4cG9ydHMuZGVmaW5lUHJvcHMgPSBkZWZpbmVQcm9wczsKICBleHBvcnRzLmRlZmluZVNTUkN1c3RvbUVsZW1lbnQgPSBkZWZpbmVTU1JDdXN0b21FbGVtZW50OwogIGV4cG9ydHMuZGVmaW5lU2xvdHMgPSBkZWZpbmVTbG90czsKICBleHBvcnRzLmRldnRvb2xzID0gZGV2dG9vbHM7CiAgZXhwb3J0cy5lZmZlY3QgPSBlZmZlY3Q7CiAgZXhwb3J0cy5lZmZlY3RTY29wZSA9IGVmZmVjdFNjb3BlOwogIGV4cG9ydHMuZ2V0Q3VycmVudEluc3RhbmNlID0gZ2V0Q3VycmVudEluc3RhbmNlOwogIGV4cG9ydHMuZ2V0Q3VycmVudFNjb3BlID0gZ2V0Q3VycmVudFNjb3BlOwogIGV4cG9ydHMuZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuID0gZ2V0VHJhbnNpdGlvblJhd0NoaWxkcmVuOwogIGV4cG9ydHMuZ3VhcmRSZWFjdGl2ZVByb3BzID0gZ3VhcmRSZWFjdGl2ZVByb3BzOwogIGV4cG9ydHMuaCA9IGg7CiAgZXhwb3J0cy5oYW5kbGVFcnJvciA9IGhhbmRsZUVycm9yOwogIGV4cG9ydHMuaGFzSW5qZWN0aW9uQ29udGV4dCA9IGhhc0luamVjdGlvbkNvbnRleHQ7CiAgZXhwb3J0cy5oeWRyYXRlID0gaHlkcmF0ZTsKICBleHBvcnRzLmluaXRDdXN0b21Gb3JtYXR0ZXIgPSBpbml0Q3VzdG9tRm9ybWF0dGVyOwogIGV4cG9ydHMuaW5pdERpcmVjdGl2ZXNGb3JTU1IgPSBpbml0RGlyZWN0aXZlc0ZvclNTUjsKICBleHBvcnRzLmluamVjdCA9IGluamVjdDsKICBleHBvcnRzLmlzTWVtb1NhbWUgPSBpc01lbW9TYW1lOwogIGV4cG9ydHMuaXNQcm94eSA9IGlzUHJveHk7CiAgZXhwb3J0cy5pc1JlYWN0aXZlID0gaXNSZWFjdGl2ZTsKICBleHBvcnRzLmlzUmVhZG9ubHkgPSBpc1JlYWRvbmx5OwogIGV4cG9ydHMuaXNSZWYgPSBpc1JlZjsKICBleHBvcnRzLmlzUnVudGltZU9ubHkgPSBpc1J1bnRpbWVPbmx5OwogIGV4cG9ydHMuaXNTaGFsbG93ID0gaXNTaGFsbG93OwogIGV4cG9ydHMuaXNWTm9kZSA9IGlzVk5vZGU7CiAgZXhwb3J0cy5tYXJrUmF3ID0gbWFya1JhdzsKICBleHBvcnRzLm1lcmdlRGVmYXVsdHMgPSBtZXJnZURlZmF1bHRzOwogIGV4cG9ydHMubWVyZ2VNb2RlbHMgPSBtZXJnZU1vZGVsczsKICBleHBvcnRzLm1lcmdlUHJvcHMgPSBtZXJnZVByb3BzOwogIGV4cG9ydHMubmV4dFRpY2sgPSBuZXh0VGljazsKICBleHBvcnRzLm5vcm1hbGl6ZUNsYXNzID0gbm9ybWFsaXplQ2xhc3M7CiAgZXhwb3J0cy5ub3JtYWxpemVQcm9wcyA9IG5vcm1hbGl6ZVByb3BzOwogIGV4cG9ydHMubm9ybWFsaXplU3R5bGUgPSBub3JtYWxpemVTdHlsZTsKICBleHBvcnRzLm9uQWN0aXZhdGVkID0gb25BY3RpdmF0ZWQ7CiAgZXhwb3J0cy5vbkJlZm9yZU1vdW50ID0gb25CZWZvcmVNb3VudDsKICBleHBvcnRzLm9uQmVmb3JlVW5tb3VudCA9IG9uQmVmb3JlVW5tb3VudDsKICBleHBvcnRzLm9uQmVmb3JlVXBkYXRlID0gb25CZWZvcmVVcGRhdGU7CiAgZXhwb3J0cy5vbkRlYWN0aXZhdGVkID0gb25EZWFjdGl2YXRlZDsKICBleHBvcnRzLm9uRXJyb3JDYXB0dXJlZCA9IG9uRXJyb3JDYXB0dXJlZDsKICBleHBvcnRzLm9uTW91bnRlZCA9IG9uTW91bnRlZDsKICBleHBvcnRzLm9uUmVuZGVyVHJhY2tlZCA9IG9uUmVuZGVyVHJhY2tlZDsKICBleHBvcnRzLm9uUmVuZGVyVHJpZ2dlcmVkID0gb25SZW5kZXJUcmlnZ2VyZWQ7CiAgZXhwb3J0cy5vblNjb3BlRGlzcG9zZSA9IG9uU2NvcGVEaXNwb3NlOwogIGV4cG9ydHMub25TZXJ2ZXJQcmVmZXRjaCA9IG9uU2VydmVyUHJlZmV0Y2g7CiAgZXhwb3J0cy5vblVubW91bnRlZCA9IG9uVW5tb3VudGVkOwogIGV4cG9ydHMub25VcGRhdGVkID0gb25VcGRhdGVkOwogIGV4cG9ydHMub3BlbkJsb2NrID0gb3BlbkJsb2NrOwogIGV4cG9ydHMucG9wU2NvcGVJZCA9IHBvcFNjb3BlSWQ7CiAgZXhwb3J0cy5wcm92aWRlID0gcHJvdmlkZTsKICBleHBvcnRzLnByb3h5UmVmcyA9IHByb3h5UmVmczsKICBleHBvcnRzLnB1c2hTY29wZUlkID0gcHVzaFNjb3BlSWQ7CiAgZXhwb3J0cy5xdWV1ZVBvc3RGbHVzaENiID0gcXVldWVQb3N0Rmx1c2hDYjsKICBleHBvcnRzLnJlYWN0aXZlID0gcmVhY3RpdmU7CiAgZXhwb3J0cy5yZWFkb25seSA9IHJlYWRvbmx5OwogIGV4cG9ydHMucmVmID0gcmVmOwogIGV4cG9ydHMucmVnaXN0ZXJSdW50aW1lQ29tcGlsZXIgPSByZWdpc3RlclJ1bnRpbWVDb21waWxlcjsKICBleHBvcnRzLnJlbmRlciA9IHJlbmRlcjsKICBleHBvcnRzLnJlbmRlckxpc3QgPSByZW5kZXJMaXN0OwogIGV4cG9ydHMucmVuZGVyU2xvdCA9IHJlbmRlclNsb3Q7CiAgZXhwb3J0cy5yZXNvbHZlQ29tcG9uZW50ID0gcmVzb2x2ZUNvbXBvbmVudDsKICBleHBvcnRzLnJlc29sdmVEaXJlY3RpdmUgPSByZXNvbHZlRGlyZWN0aXZlOwogIGV4cG9ydHMucmVzb2x2ZUR5bmFtaWNDb21wb25lbnQgPSByZXNvbHZlRHluYW1pY0NvbXBvbmVudDsKICBleHBvcnRzLnJlc29sdmVGaWx0ZXIgPSByZXNvbHZlRmlsdGVyOwogIGV4cG9ydHMucmVzb2x2ZVRyYW5zaXRpb25Ib29rcyA9IHJlc29sdmVUcmFuc2l0aW9uSG9va3M7CiAgZXhwb3J0cy5zZXRCbG9ja1RyYWNraW5nID0gc2V0QmxvY2tUcmFja2luZzsKICBleHBvcnRzLnNldERldnRvb2xzSG9vayA9IHNldERldnRvb2xzSG9vazsKICBleHBvcnRzLnNldFRyYW5zaXRpb25Ib29rcyA9IHNldFRyYW5zaXRpb25Ib29rczsKICBleHBvcnRzLnNoYWxsb3dSZWFjdGl2ZSA9IHNoYWxsb3dSZWFjdGl2ZTsKICBleHBvcnRzLnNoYWxsb3dSZWFkb25seSA9IHNoYWxsb3dSZWFkb25seTsKICBleHBvcnRzLnNoYWxsb3dSZWYgPSBzaGFsbG93UmVmOwogIGV4cG9ydHMuc3NyQ29udGV4dEtleSA9IHNzckNvbnRleHRLZXk7CiAgZXhwb3J0cy5zc3JVdGlscyA9IHNzclV0aWxzOwogIGV4cG9ydHMuc3RvcCA9IHN0b3A7CiAgZXhwb3J0cy50b0Rpc3BsYXlTdHJpbmcgPSB0b0Rpc3BsYXlTdHJpbmc7CiAgZXhwb3J0cy50b0hhbmRsZXJLZXkgPSB0b0hhbmRsZXJLZXk7CiAgZXhwb3J0cy50b0hhbmRsZXJzID0gdG9IYW5kbGVyczsKICBleHBvcnRzLnRvUmF3ID0gdG9SYXc7CiAgZXhwb3J0cy50b1JlZiA9IHRvUmVmOwogIGV4cG9ydHMudG9SZWZzID0gdG9SZWZzOwogIGV4cG9ydHMudG9WYWx1ZSA9IHRvVmFsdWU7CiAgZXhwb3J0cy50cmFuc2Zvcm1WTm9kZUFyZ3MgPSB0cmFuc2Zvcm1WTm9kZUFyZ3M7CiAgZXhwb3J0cy50cmlnZ2VyUmVmID0gdHJpZ2dlclJlZjsKICBleHBvcnRzLnVucmVmID0gdW5yZWY7CiAgZXhwb3J0cy51c2VBdHRycyA9IHVzZUF0dHJzOwogIGV4cG9ydHMudXNlQ3NzTW9kdWxlID0gdXNlQ3NzTW9kdWxlOwogIGV4cG9ydHMudXNlQ3NzVmFycyA9IHVzZUNzc1ZhcnM7CiAgZXhwb3J0cy51c2VNb2RlbCA9IHVzZU1vZGVsOwogIGV4cG9ydHMudXNlU1NSQ29udGV4dCA9IHVzZVNTUkNvbnRleHQ7CiAgZXhwb3J0cy51c2VTbG90cyA9IHVzZVNsb3RzOwogIGV4cG9ydHMudXNlVHJhbnNpdGlvblN0YXRlID0gdXNlVHJhbnNpdGlvblN0YXRlOwogIGV4cG9ydHMudk1vZGVsQ2hlY2tib3ggPSB2TW9kZWxDaGVja2JveDsKICBleHBvcnRzLnZNb2RlbER5bmFtaWMgPSB2TW9kZWxEeW5hbWljOwogIGV4cG9ydHMudk1vZGVsUmFkaW8gPSB2TW9kZWxSYWRpbzsKICBleHBvcnRzLnZNb2RlbFNlbGVjdCA9IHZNb2RlbFNlbGVjdDsKICBleHBvcnRzLnZNb2RlbFRleHQgPSB2TW9kZWxUZXh0OwogIGV4cG9ydHMudlNob3cgPSB2U2hvdzsKICBleHBvcnRzLnZlcnNpb24gPSB2ZXJzaW9uOwogIGV4cG9ydHMud2FybiA9IHdhcm47CiAgZXhwb3J0cy53YXRjaCA9IHdhdGNoOwogIGV4cG9ydHMud2F0Y2hFZmZlY3QgPSB3YXRjaEVmZmVjdDsKICBleHBvcnRzLndhdGNoUG9zdEVmZmVjdCA9IHdhdGNoUG9zdEVmZmVjdDsKICBleHBvcnRzLndhdGNoU3luY0VmZmVjdCA9IHdhdGNoU3luY0VmZmVjdDsKICBleHBvcnRzLndpdGhBc3luY0NvbnRleHQgPSB3aXRoQXN5bmNDb250ZXh0OwogIGV4cG9ydHMud2l0aEN0eCA9IHdpdGhDdHg7CiAgZXhwb3J0cy53aXRoRGVmYXVsdHMgPSB3aXRoRGVmYXVsdHM7CiAgZXhwb3J0cy53aXRoRGlyZWN0aXZlcyA9IHdpdGhEaXJlY3RpdmVzOwogIGV4cG9ydHMud2l0aEtleXMgPSB3aXRoS2V5czsKICBleHBvcnRzLndpdGhNZW1vID0gd2l0aE1lbW87CiAgZXhwb3J0cy53aXRoTW9kaWZpZXJzID0gd2l0aE1vZGlmaWVyczsKICBleHBvcnRzLndpdGhTY29wZUlkID0gd2l0aFNjb3BlSWQ7CgogIHJldHVybiBleHBvcnRzOwoKfSkoe30pOwoKKGZ1bmN0aW9uKCkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgd2luZG93LlZ1ZSA9IFZ1ZTsKfSkoKTsK"},{"meta":{"name":"template_vue.js","url":"https://update.greasyfork.org/scripts/491414/1352613/template_vue.js","ts":1712333128632,"mimetype":"text/javascript"},"source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICB0ZW1wbGF0ZV92dWUKLy8gQG5hbWVzcGFjZSAgICBodHRwOi8vdGFtcGVybW9ua2V5Lm5ldC8KLy8gQHZlcnNpb24gICAgICAwLjAuMQovLyBAZGVzY3JpcHRpb24gIHZ1ZSB0ZW1wbGF0ZSwgZWFzeSB0byBjcmVhdGUgc2NyaXB0IGJ5IHZ1ZQovLyBAYXV0aG9yICAgICAgIHpob3dpbnkKLy8gQG1hdGNoICAgICAgICAqCi8vIEBpY29uICAgICAgICAgaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9zMi9mYXZpY29ucz9zej02NCZkb21haW49emhvd2lueS50b3AKLy8gQGdyYW50ICAgICAgICBub25lCi8vIEBsaWNlbnNlIE1JVAovLyBAcmVxdWlyZSBodHRwczovL3VwZGF0ZS5ncmVhc3lmb3JrLm9yZy9zY3JpcHRzLzQ5MTQwMS8xMzUyNDU1L3Z1ZS5qcwovLyA9PS9Vc2VyU2NyaXB0PT0KCmNvbnN0IGNvbnRhaW5lcklEID0gJ3RhbXBlcm1vbmtleV92dWVfYXBwJy50b1VwcGVyQ2FzZSgpOwpjb25zdCBjcmVhdGVEaXZDb250YWluZXIgPSAoKSA9PiB7CiAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGRpdi5pZCA9IGNvbnRhaW5lcklEOwogICAgZGl2LnN0eWxlLmNzc1RleHQgPSAncG9zaXRpb246IGZpeGVkO3RvcDogMTBweDtsZWZ0OjUwJTt6LWluZGV4OjEwMDA7dHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpOyc7CiAgICByZXR1cm4gZGl2Owp9Cgpjb25zdCBkZWZhdWx0VGVtcGxhdGUgPSBgPGRpdj57e21lc3NhZ2V9fTwvZGl2PmA7CmNvbnN0IGRlZmF1bHRTZXR1cCA9ICgpID0+ICh7bWVzc2FnZTogInRhbXBlcm1vbmtleSBhcHAgY29udGVudDsgdXNlIGB3aW5kb3cuX3Z1ZV90ZW1wbGF0ZSA9ICc8ZGl2Pi4uLi48L2Rpdj4nYCByZXBsYWNlIGl0LiJ9KTsKCmZ1bmN0aW9uIGRlYm91bmNlKGZ1bmMsIHRpbWVvdXQgPSAzMDApewogIGxldCB0aW1lcjsKICByZXR1cm4gKC4uLmFyZ3MpID0+IHsKICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4geyBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOyB9LCB0aW1lb3V0KTsKICB9Owp9CgooZnVuY3Rpb24oKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICBjb25zdCB7Y3JlYXRlQXBwLCBuZXh0VGlja30gPSB3aW5kb3cuVnVlOwoKICAgIGNvbnN0IGNudCA9IGNyZWF0ZURpdkNvbnRhaW5lcigpOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjbnQpOwoKICAgIGxldCBhcHA7CiAgICBjb25zdCBtb3VudEFwcCA9IGRlYm91bmNlKChvcHRpb25zKSA9PiB7CiAgICAgICAgYXBwID0gY3JlYXRlQXBwKG9wdGlvbnMpOwogICAgICAgIGFwcC5tb3VudChjbnQpOwogICAgICAgIHJldHVybiBhcHA7CiAgICB9LCAzMDApCiAgICBjb25zdCB1bm1vdW50QXBwID0gKCkgPT4gewogICAgICAgIGFwcD8udW5tb3VudD8uKCk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlciA9IHsKICAgICAgICBzZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgewogICAgICAgICAgICBpZiAoWyd0ZW1wbGF0ZScsICdzZXR1cCcsICdyZW5kZXInXS5pbmNsdWRlcyhwcm9wKSkgewogICAgICAgICAgICAgICAgdW5tb3VudEFwcCgpOwogICAgICAgICAgICAgICAgbmV4dFRpY2soKCkgPT4gbW91bnRBcHAoey4uLndpbmRvd1tjb250YWluZXJJRF0sIFtwcm9wXTogcmVjZWl2ZXJ9KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3Quc2V0KC4uLmFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgIH0KCiAgICB3aW5kb3dbY29udGFpbmVySURdID0gbmV3IFByb3h5KHsKICAgICAgICB0ZW1wbGF0ZTogZGVmYXVsdFRlbXBsYXRlLAogICAgICAgIHNldHVwOiBkZWZhdWx0U2V0dXAsCiAgICB9LCBoYW5kbGVyKQoKICAgIG1vdW50QXBwKHsuLi53aW5kb3dbY29udGFpbmVySURdfSkKCn0pKCk7"}]}]}